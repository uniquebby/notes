<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2021-04-04 日 15:46 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>&lrm;</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="BINBIN YANG" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org3a271bc">1. 收藏夹</a>
<ul>
<li><a href="#org46722ce">1.1. 网站</a>
<ul>
<li><a href="#orgbd6b426">1.1.1. 谷歌镜像</a></li>
<li><a href="#org4418efc">1.1.2. github主页</a></li>
<li><a href="#orge99a287">1.1.3. b站</a></li>
<li><a href="#org24b5284">1.1.4. 豆瓣</a></li>
<li><a href="#org0178737">1.1.5. 鸠摩搜书</a></li>
<li><a href="#org40c6cf9">1.1.6. c++ reference</a></li>
<li><a href="#org1f5f686">1.1.7. baidu</a></li>
<li><a href="#orgc296853">1.1.8. google-c++-styleguide</a></li>
</ul>
</li>
<li><a href="#orgbc43967">1.2. 博客</a>
<ul>
<li><a href="#orge3542bc">1.2.1. linux同步机制</a></li>
<li><a href="#org7b972e6">1.2.2. 网络</a></li>
<li><a href="#org90b320a">1.2.3. 分布式</a></li>
</ul>
</li>
<li><a href="#orgf476f10">1.3. tools</a>
<ul>
<li><a href="#org9dcd1d9">1.3.1. C++ 汇编代码查看</a></li>
<li><a href="#orga99900e">1.3.2. 在线画图</a></li>
<li><a href="#org78e0d23">1.3.3. 在线看源码的网站</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org6926f43">2. emacs/spacemacs</a>
<ul>
<li><a href="#orgfee95a1">2.1. 用法</a></li>
<li><a href="#orgd1aeec1">2.2. 配置</a>
<ul>
<li><a href="#orgf884762">2.2.1. 值得推荐的工具:</a></li>
<li><a href="#orga8a6ad1">2.2.2. c-c++ 补全配置:</a></li>
<li><a href="#orgb3747fe">2.2.3. 使得能在org中执行c，c++代码</a></li>
</ul>
</li>
<li><a href="#org265250f">2.3. Spacemacs Rocks第二季</a>
<ul>
<li><a href="#orge5eabd5">2.3.1. resource</a></li>
<li><a href="#orgdb1530e">2.3.2. 第一天：准备开始</a></li>
<li><a href="#org3991eb4">2.3.3. 第二天:高级自定义</a></li>
<li><a href="#orge225b63">2.3.4. 第十一天: Spacemacs 简介及安装</a></li>
<li><a href="#orgbcebe6d">2.3.5. 第十二天: 创建你的第一个 Spacemacs Layer</a></li>
<li><a href="#orgbc46598">2.3.6. agenda 使用</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org0f85498">3. reading</a>
<ul>
<li><a href="#orgf8e2be6">3.1. c++ primer(5th) pdf</a>
<ul>
<li><a href="#orgd1dbab8">3.1.1. 初始化问题</a></li>
<li><a href="#org7517d22">3.1.2. 左值引用与右值引用</a></li>
<li><a href="#orga49b6ba">3.1.3. extern</a></li>
<li><a href="#org188ed6f">3.1.4. 引用与指针</a></li>
<li><a href="#org9a09fc3">3.1.5. const注意点页</a></li>
<li><a href="#org01054a8">3.1.6. constexpr(58页）</a></li>
<li><a href="#org6605e2b">3.1.7. auto类型说明符(61页)</a></li>
<li><a href="#org75b594f">3.1.8. decltype类型说明符(62页）</a></li>
<li><a href="#orgaaa822d">3.1.9. 内置数组与vector的区别</a></li>
<li><a href="#org906b664">3.1.10. sizeof运算符(139页)</a></li>
<li><a href="#org98e62e1">3.1.11. 隐式类型转换 (141页）</a></li>
<li><a href="#org4170d48">3.1.12. 运算符优先级表(147页)</a></li>
<li><a href="#org2928552">3.1.13. 函数重载(208页)</a></li>
<li><a href="#orge6a4bb0">3.1.14. 值初始化(88页)和默认初始化</a></li>
<li><a href="#org675adb8">3.1.15. 类的静态成员</a></li>
<li><a href="#orgeae21e7">3.1.16. 智能指针</a></li>
<li><a href="#orgd7c7c6a">3.1.17. <span class="todo TODO">TODO</span> allocator</a></li>
<li><a href="#orged56874">3.1.18. 13章 拷贝控制</a></li>
<li><a href="#orgfad70c0">3.1.19. 14章 重载运算和类型转换</a></li>
<li><a href="#org247768e">3.1.20. 15章 面向对象程序设计</a></li>
<li><a href="#orgde06605">3.1.21. 16章 模版与泛型编程</a></li>
</ul>
</li>
<li><a href="#orge68d7ba">3.2. STL源码剖析 pdf</a>
<ul>
<li><a href="#org3528a0e">3.2.1. 3 迭代器与traits编程技法</a></li>
<li><a href="#org4abf022">3.2.2. 4 序列化容器</a></li>
<li><a href="#org758648d">3.2.3. 5 关联式容器</a></li>
<li><a href="#org9447e8a">3.2.4. 6 算法</a></li>
<li><a href="#org9889574">3.2.5. 7 仿函数</a></li>
</ul>
</li>
<li><a href="#orge5d06a8">3.3. Effective Modern C++</a>
<ul>
<li><a href="#orgde18ce1">3.3.1. 绪论</a></li>
<li><a href="#org614ea0f">3.3.2. 类型推导</a></li>
</ul>
</li>
<li><a href="#orgfa61ad3">3.4. 深度探索C++对象模型</a>
<ul>
<li><a href="#org167bc80">3.4.1. 第一章 关于对象</a></li>
<li><a href="#org38c552c">3.4.2. 第二章 构造函数语意学</a></li>
</ul>
</li>
<li><a href="#orge792114">3.5. tcp/ip详解卷一</a></li>
<li><a href="#org2f6d174">3.6. tcp/ip详解卷二</a></li>
<li><a href="#org5e53d58">3.7. apue pdf</a>
<ul>
<li><a href="#org1ee2ba9">3.7.1. 头文件配置</a></li>
<li><a href="#org8fff13a">3.7.2. charpter3</a></li>
<li><a href="#orgbe29bc5">3.7.3. charpter4</a></li>
<li><a href="#orgef9f699">3.7.4. charpter5 标准io库</a></li>
<li><a href="#orgd963fe8">3.7.5. chapter6 系统数据文件和信息</a></li>
<li><a href="#orgc24cc08">3.7.6. chapter7 进程环境</a></li>
<li><a href="#org52c6ef8">3.7.7. chapter8 进程控制</a></li>
<li><a href="#org2b01163">3.7.8. <span class="todo TODO">TODO</span> chapter9 进程关系 PASS</a></li>
<li><a href="#org74a4c8d">3.7.9. chapter10 信号</a></li>
<li><a href="#orgf10638d">3.7.10. <span class="todo TODO">TODO</span> chapter11 线程</a></li>
<li><a href="#org9a9d501">3.7.11. <span class="todo TODO">TODO</span> chapter12</a></li>
<li><a href="#org1e2e85e">3.7.12. 守护进程(daemon)</a></li>
</ul>
</li>
<li><a href="#orgcfc7450">3.8. tlpi</a>
<ul>
<li><a href="#org91c0418">3.8.1. 第四章</a></li>
<li><a href="#org1862853">3.8.2. 5</a></li>
<li><a href="#org29b0c6f">3.8.3. ipc</a></li>
</ul>
</li>
<li><a href="#orga97302d">3.9. <span class="todo TODO">TODO</span> 内核架构 pdf</a>
<ul>
<li><a href="#orge885e1f">3.9.1. 进程管理与调度</a></li>
<li><a href="#orge5920e7">3.9.2. 内存管理</a></li>
<li><a href="#orgb9765c6">3.9.3. 进程虚拟内存</a></li>
<li><a href="#orgc2fda60">3.9.4. <span class="todo TODO">TODO</span> 锁与进程间通信</a></li>
<li><a href="#org2e0cdb0">3.9.5. 设备驱动程序</a></li>
<li><a href="#orgad331a2">3.9.6. <span class="todo TODO">TODO</span> 模块</a></li>
<li><a href="#org6bf6c15">3.9.7. 虚拟文件系统</a></li>
<li><a href="#org21cb0b8">3.9.8. <span class="todo TODO">TODO</span> Ext文件系统族</a></li>
<li><a href="#org2e2aa1a">3.9.9. 无持久存储的文件系统</a></li>
<li><a href="#orgb5436f5">3.9.10. 内核活动</a></li>
</ul>
</li>
<li><a href="#org9e80248">3.10. unix&amp;Linux大学教程</a>
<ul>
<li><a href="#org048f78f">3.10.1. reference</a></li>
<li><a href="#orgddcfd4c">3.10.2. 命令语法 命令名称 选项 参数 <b>**</b> 选项 也称开关（switches）或标志（flags。 通常由一个连字符后跟一个字母或者两个连字符跟一个单词组成。 也可以把多个单字符组合在一起。 <b>**</b> 规则 1. 方括号中的项是可选的 2. 不在方括号中的项是必选项，必须作为命令的一部分 3. 黑体字必须原样输入 4. 非黑体字必须用适当的值代替 5. 后面接省略号的参数可以重复任意多次（包括0） 6. <b>如果一个单独选项和一个参数结合在一起，那么该选项和参数必须同时使用</b> #+begin<sub>src</sub> shell man  [-acdfFhkKtwW]  [&#x2013;path]  [-m system] [-p string] [-C config<sub>file</sub>] [-M pathlist] [-P pager] [-B browser] [-H htmlpager] [-S  section<sub>list</sub>] [section] name &#x2026; #+end<sub>src</sub> 7. 由｜字符分开的两个或多个选项，表示可以从这个列表中选择一个项 who [-<b>abdHilmpqrstTu</b> ] [file | arg1 arg2] <b>*</b> 环境变量与shell变量(bash) 在日常的交互式工作中，重要的是环境变量，而不是shell变量 - 显示默认环境变量： env/printenv - 显示shell变量 set - 创建变量 1. shell变量 创建shell变量语法为： NAME=value 如果希望使用一个包含空白符的值，则需要将值放在双引号中: #+begin<sub>src</sub> shell WEEDLY="a cool cat" #+end<sub>src</sub> 2. 环境变量 可以使用export命令将变量导出到环境中： #+begin<sub>src</sub> shell export NAME[=value]&#x2026; # HARLEY WEEDLY同时由shell变量变为"shell+环境"变量 export HARLEY WEEDLY # 同时设置了PAGER变量并导出到环境中 export PAGER=less #+end<sub>src</sub> 可以用unset（复位）删除变量： #+begin<sub>src</sub> shell unset NAME&#x2026; #+end<sub>src</sub> 可以使用下面命令修改命令行提示符： #+begin<sub>src</sub> shell export PS1="我的提示符" #+end<sub>src</sub></a></li>
<li><a href="#orgfa0fb49">3.10.3. 第13章 使用shell：命令和定制</a></li>
<li><a href="#orgeea8315">3.10.4. 第14章 初始化文件</a></li>
<li><a href="#org35a5315">3.10.5. 15章</a></li>
<li><a href="#org6428c3c">3.10.6. 16章 过滤器</a></li>
<li><a href="#org8c7960f">3.10.7. 17章</a></li>
<li><a href="#orgcea1af0">3.10.8. 18章 统计和格式化</a></li>
<li><a href="#org09646a4">3.10.9. 19章 选取，排序，组合及变换</a></li>
<li><a href="#orgcb9d5f1">3.10.10. 20章 正则表达式</a></li>
<li><a href="#org6318960">3.10.11. 23章 文件系统(569页)</a></li>
<li><a href="#orgfeb03b4">3.10.12. 24章 目录操作</a></li>
<li><a href="#orged07584">3.10.13. 25章 文件操作</a></li>
</ul>
</li>
<li><a href="#org2671f1e">3.11. Effective C++</a>
<ul>
<li><a href="#orgacc6fec">3.11.1. 让自己习惯c++</a></li>
<li><a href="#orgb2f4996">3.11.2. 构造/析构/赋值运算</a></li>
<li><a href="#org1eac455">3.11.3. 资源管理</a></li>
<li><a href="#orgbebc24d">3.11.4. 设计与声明</a></li>
<li><a href="#orgcc2ece3">3.11.5. 实现</a></li>
<li><a href="#org259dd7c">3.11.6. 继承与面向对象设计</a></li>
<li><a href="#org0aa65ca">3.11.7. 模版与泛型编程</a></li>
<li><a href="#org88891e1">3.11.8. 定制new和delete</a></li>
</ul>
</li>
<li><a href="#orgba88a2e">3.12. <span class="todo TODO">TODO</span> MYSQL必知必会 pdf</a>
<ul>
<li><a href="#org7e8f172">3.12.1. reference:</a></li>
<li><a href="#orgba0b749">3.12.2. 第一章 了解SQL</a></li>
<li><a href="#orgcc910ba">3.12.3. 第二章 MySQL简介</a></li>
<li><a href="#orgaef4f08">3.12.4. 第三章 使用MySQL</a></li>
<li><a href="#orgc81300e">3.12.5. 第四章 基本SELECT</a></li>
<li><a href="#org2e4149b">3.12.6. 第五章 排序检索数据 ORDER BY</a></li>
<li><a href="#org168abf4">3.12.7. 第六章 过滤数据 WHERE</a></li>
<li><a href="#org1f79874">3.12.8. 第七章 高级WHERE AND OR NOT IN</a></li>
<li><a href="#orgf170c3a">3.12.9. 第八章 用通配符进行过滤</a></li>
<li><a href="#org82daf00">3.12.10. 第九章 正则表达式</a></li>
<li><a href="#orgb5bc9ca">3.12.11. 第十章 计算字段</a></li>
<li><a href="#orgea044bb">3.12.12. 第十一章 数据处理函数</a></li>
<li><a href="#org74353e7">3.12.13. 第十二章 汇总数据(聚集函数)</a></li>
<li><a href="#org5b82188">3.12.14. 第十三章 分组数据 GROUP BY, HAVING</a></li>
<li><a href="#orgb92ad46">3.12.15. 第十四章 子查询</a></li>
<li><a href="#org31ca06b">3.12.16. 第十五章 联结表(join)</a></li>
<li><a href="#org4e56212">3.12.17. 第十六章 高级联结</a></li>
<li><a href="#orgccbc86c">3.12.18. 第十七章 组合查询 UNION</a></li>
<li><a href="#orgb55c13c">3.12.19. <span class="todo TODO">TODO</span> 第十八章 全文搜索</a></li>
<li><a href="#org5ae1622">3.12.20. 第十九章 插入数据 INSERT</a></li>
<li><a href="#org19b2d98">3.12.21. 使用数据处理函数</a></li>
<li><a href="#org0d562d3">3.12.22. 附录B 例子安装</a></li>
</ul>
</li>
<li><a href="#orga35ab6b">3.13. linux shell 脚本攻略 pdf</a>
<ul>
<li><a href="#org671255b">3.13.1. 第一章</a></li>
<li><a href="#orgd4996ac">3.13.2. 第三章</a></li>
</ul>
</li>
<li><a href="#org63ad01e">3.14. 设计模式 视频</a>
<ul>
<li><a href="#org96b686c">3.14.1. 8个设计原则</a></li>
<li><a href="#org28a92a5">3.14.2. 组件协作模式</a></li>
<li><a href="#orgec2e328">3.14.3. 单一职责模式</a></li>
</ul>
</li>
<li><a href="#orga3b9eb4">3.15. <span class="todo TODO">TODO</span> redis设计与实现</a>
<ul>
<li><a href="#org6a766b5">3.15.1. 第二章 简单动态字符串(SDS)</a></li>
</ul>
</li>
<li><a href="#orgad88828">3.16. 高性能mysql</a></li>
<li><a href="#org286b355">3.17. <span class="todo TODO">TODO</span> 掘金小册子</a></li>
<li><a href="#orgfc54bc9">3.18. <span class="todo TODO">TODO</span> 15445</a></li>
<li><a href="#org2f9f4c9">3.19. <span class="todo TODO">TODO</span> tcp/ip详解</a></li>
<li><a href="#orgce2fc4b">3.20. <span class="todo TODO">TODO</span> 图解http</a></li>
<li><a href="#orga792d81">3.21. <span class="todo TODO">TODO</span> unp</a></li>
<li><a href="#orge5931fc">3.22. <span class="todo TODO">TODO</span> 自我修养</a></li>
<li><a href="#orga104e99">3.23. b站chenshuo</a>
<ul>
<li><a href="#orgb99de14">3.23.1. 2 TCP简单实验（测速度）</a></li>
<li><a href="#org90e14c5">3.23.2. UDP vs TCP</a></li>
<li><a href="#org4efbb6a">3.23.3. 第三个例子 netcat</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org76ac5d5">4. tools</a>
<ul>
<li><a href="#orgfbbd626">4.1. cmake</a>
<ul>
<li><a href="#org84fbbb7">4.1.1. cmake入门实战 https://www.hahack.com/codes/cmake/</a></li>
</ul>
</li>
<li><a href="#org9cc7681">4.2. makefile</a>
<ul>
<li><a href="#org9b1ea51">4.2.1. https://wiki.ubuntu.org.cn/跟我一起写Makefile:MakeFile介绍</a></li>
<li><a href="#orgc455607">4.2.2. 自动化变量</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org485c4c7">5. mac软件安装</a>
<ul>
<li><a href="#orge4476e1">5.1. mysql</a></li>
</ul>
</li>
<li><a href="#orgc05ce99">6. todolist</a>
<ul>
<li><a href="#orge9b84d2">6.1. shell</a></li>
<li><a href="#org69981f4">6.2. 操作系统</a></li>
<li><a href="#org3218ea4">6.3. 博客</a></li>
<li><a href="#org91f0cc6">6.4. lc</a></li>
</ul>
</li>
<li><a href="#orgf09609f">7. leetcode</a>
<ul>
<li><a href="#org1463c4a">7.1. 图</a></li>
<li><a href="#orgb15b76e">7.2. 并查集</a>
<ul>
<li><a href="#orgfa98530">7.2.1. <span class="todo TODO">TODO</span> 1319</a></li>
<li><a href="#org17a02d6">7.2.2. 947</a></li>
</ul>
</li>
<li><a href="#org454023b">7.3. 单调栈</a></li>
<li><a href="#org3618c84">7.4. 差分数组</a></li>
<li><a href="#org52222ab">7.5. 排列组合</a></li>
<li><a href="#org1fa1c4d">7.6. 字典树</a></li>
<li><a href="#org8a42928">7.7. DFS</a>
<ul>
<li><a href="#org115d0ed">7.7.1. 1254 https://leetcode-cn.com/problems/number-of-closed-islands/</a></li>
</ul>
</li>
<li><a href="#orgf60d2c5">7.8. next</a></li>
<li><a href="#orgd28291a">7.9. 括号问题</a>
<ul>
<li><a href="#orge2513b4">7.9.1. 1249 https://leetcode-cn.com/problems/minimum-remove-to-make-valid-parentheses/</a></li>
</ul>
</li>
<li><a href="#org61427a2">7.10. 前缀和</a></li>
<li><a href="#org1488b32">7.11. 回溯</a></li>
<li><a href="#orgb032180">7.12. 取或不取的2<sup>n遍历问题</sup></a></li>
<li><a href="#orge6ab03c">7.13. 验证水平</a></li>
<li><a href="#orge956570">7.14. 曼哈顿距离</a></li>
<li><a href="#org524f107">7.15. 双指针</a></li>
<li><a href="#org52f4940">7.16. 分治</a></li>
<li><a href="#org0b11f55">7.17. 排序各种写法</a></li>
</ul>
</li>
<li><a href="#org4843df6">8. offer</a></li>
<li><a href="#org006fd93">9. 速查表</a>
<ul>
<li><a href="#orgf662670">9.1. languages</a>
<ul>
<li><a href="#org4b1e0e6">9.1.1. bash</a></li>
</ul>
</li>
<li><a href="#org730f0a7">9.2. tools</a>
<ul>
<li><a href="#org43df0cb">9.2.1. git</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org8ec78f3">10. 备份</a></li>
</ul>
</div>
</div>
<div id="outline-container-org3a271bc" class="outline-2">
<h2 id="org3a271bc"><span class="section-number-2">1</span> 收藏夹</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org46722ce" class="outline-3">
<h3 id="org46722ce"><span class="section-number-3">1.1</span> 网站</h3>
<div class="outline-text-3" id="text-1-1">
</div>
<div id="outline-container-orgbd6b426" class="outline-4">
<h4 id="orgbd6b426"><span class="section-number-4">1.1.1</span> <a href="https://g.dgclouds.net">谷歌镜像</a></h4>
<div class="outline-text-4" id="text-1-1-1">
<p>
<a href="https://www.uedbox.com/post/54776/">https://www.uedbox.com/post/54776/</a>
</p>
</div>
</div>
<div id="outline-container-org4418efc" class="outline-4">
<h4 id="org4418efc"><span class="section-number-4">1.1.2</span> <a href="https://github.com/uniquebby">github主页</a></h4>
</div>
<div id="outline-container-orge99a287" class="outline-4">
<h4 id="orge99a287"><span class="section-number-4">1.1.3</span> <a href="https://www.bilibili.com">b站</a></h4>
</div>
<div id="outline-container-org24b5284" class="outline-4">
<h4 id="org24b5284"><span class="section-number-4">1.1.4</span> <a href="https://search.douban.com/book/subject_search?search_text=shell&amp;cat=1001">豆瓣</a></h4>
</div>
<div id="outline-container-org0178737" class="outline-4">
<h4 id="org0178737"><span class="section-number-4">1.1.5</span> <a href="https://www.jiumodiary.com">鸠摩搜书</a></h4>
</div>
<div id="outline-container-org40c6cf9" class="outline-4">
<h4 id="org40c6cf9"><span class="section-number-4">1.1.6</span> <a href="http://www.cplusplus.com/reference/">c++ reference</a></h4>
</div>
<div id="outline-container-org1f5f686" class="outline-4">
<h4 id="org1f5f686"><span class="section-number-4">1.1.7</span> <a href="https://www.baidu.com">baidu</a></h4>
</div>
<div id="outline-container-orgc296853" class="outline-4">
<h4 id="orgc296853"><span class="section-number-4">1.1.8</span> google-c++-styleguide</h4>
<div class="outline-text-4" id="text-1-1-8">
<p>
<a href="https://zh-google-styleguide.readthedocs.io/en/latest/google-cpp-styleguide/">https://zh-google-styleguide.readthedocs.io/en/latest/google-cpp-styleguide/</a>
</p>
</div>
</div>
</div>
<div id="outline-container-orgbc43967" class="outline-3">
<h3 id="orgbc43967"><span class="section-number-3">1.2</span> 博客</h3>
<div class="outline-text-3" id="text-1-2">
</div>
<ol class="org-ol">
<li><a id="org025b275"></a>google test<br />
<div class="outline-text-5" id="text-1-2-0-1">
<p>
<a href="https://www.cnblogs.com/coderzh/archive/2009/04/11/1433744.html">https://www.cnblogs.com/coderzh/archive/2009/04/11/1433744.html</a>
unbuntu安装gtest库 <a href="https://www.srcmake.com/home/google-cpp-test-framework">https://www.srcmake.com/home/google-cpp-test-framework</a>
</p>
</div>
</li>
<li><a id="orgcb2af5a"></a>cmake<br />
<div class="outline-text-5" id="text-1-2-0-2">
<p>
<a href="https://cmake.org/cmake/help/latest/manual/cmake.1.html#generate-a-project-buildsystem">https://cmake.org/cmake/help/latest/manual/cmake.1.html#generate-a-project-buildsystem</a>
<a href="https://www.hahack.com/codes/cmake/">https://www.hahack.com/codes/cmake/</a>
<a href="http://changkun.de">http://changkun.de</a>
install <a href="https://blog.csdn.net/qq_38410730/article/details/102837401">https://blog.csdn.net/qq_38410730/article/details/102837401</a>
</p>
</div>
</li>
<li><a id="org0757c23"></a>强类型语言与弱类型语言，静态类型与动态语言<br />
<div class="outline-text-5" id="text-1-2-0-3">
<p>
<a href="https://www.zhihu.com/question/19918532">https://www.zhihu.com/question/19918532</a>
</p>

<div id="orgf642a7f" class="figure">
<p><img src="收藏夹/2020-11-28_17-40-03_screenshot.png" alt="2020-11-28_17-40-03_screenshot.png" />
</p>
</div>
</div>
</li>
<li><a id="orgd7ccbc5"></a>_<sub>attribute</sub>_<sub>((packed))</sub>详解<br />
<div class="outline-text-5" id="text-1-2-0-4">
<p>
<a href="http://blog.chinaunix.net/uid-25768133-id-3485479.html">http://blog.chinaunix.net/uid-25768133-id-3485479.html</a>  
</p>
</div>
</li>
<li><a id="org4cea044"></a>c++的NRV(named return value)优化问题<br />
<div class="outline-text-5" id="text-1-2-0-5">
<p>
<a href="https://blog.csdn.net/aiyun1242/article/details/101811414?utm_medium=distribute.pc_relevant_bbs_down.none-task--2~all~first_rank_v2~rank_v28-1.nonecase&amp;depth_1-utm_source=distribute.pc_relevant_bbs_down.none-task--2~all~first_rank_v2~rank_v28-1.nonecase">https://blog.csdn.net/aiyun1242/article/details/101811414?utm_medium=distribute.pc_relevant_bbs_down.none-task--2~all~first_rank_v2~rank_v28-1.nonecase&amp;depth_1-utm_source=distribute.pc_relevant_bbs_down.none-task--2~all~first_rank_v2~rank_v28-1.nonecase</a>
</p>
</div>
</li>
</ol>
<div id="outline-container-orge3542bc" class="outline-4">
<h4 id="orge3542bc"><span class="section-number-4">1.2.1</span> linux同步机制</h4>
<div class="outline-text-4" id="text-1-2-1">
</div>
<ol class="org-ol">
<li><a id="orgf0ba8c7"></a>自旋锁底层<br />
<div class="outline-text-5" id="text-1-2-1-1">
<p>
<a href="https://cloud.tencent.com/developer/article/1484022">https://cloud.tencent.com/developer/article/1484022</a>
</p>
</div>
</li>
<li><a id="org0fd0d4f"></a>futex<br />
<div class="outline-text-5" id="text-1-2-1-2">
<p>
<a href="https://www.xuebuyuan.com/952276.html">https://www.xuebuyuan.com/952276.html</a>
<a href="http://download.oracle.com/docs/cd/E19455-01/806-5257/6je9h032r/index.html">http://download.oracle.com/docs/cd/E19455-01/806-5257/6je9h032r/index.html</a>
</p>
</div>
</li>
<li><a id="orgb1ee7a0"></a>互斥锁怎么实现的<br />
<div class="outline-text-5" id="text-1-2-1-3">
<p>
<a href="https://www.zhihu.com/question/332113890/answer/762392859">https://www.zhihu.com/question/332113890/answer/762392859</a>
</p>
</div>
</li>
<li><a id="orgf3498de"></a>原子操作底层实现<br />
<div class="outline-text-5" id="text-1-2-1-4">
<p>
<a href="https://blog.csdn.net/u011244446/article/details/52574369">https://blog.csdn.net/u011244446/article/details/52574369</a>
<a href="https://zhuanlan.zhihu.com/p/33445834?utm_source=wechat_session">https://zhuanlan.zhihu.com/p/33445834?utm_source=wechat_session</a>
</p>
</div>
</li>
<li><a id="orgfdd67d9"></a>条件变量<br /></li>
<li><a id="org51ff8c1"></a>使用<br />
<div class="outline-text-5" id="text-1-2-1-6">
<p>
<a href="https://www.cnblogs.com/harlanc/p/8596211.html">https://www.cnblogs.com/harlanc/p/8596211.html</a>
</p>
</div>
</li>
<li><a id="org780020e"></a>底层原理<br />
<div class="outline-text-5" id="text-1-2-1-7">
<p>
<a href="https://www.cnblogs.com/c-slmax/p/5853784.html">https://www.cnblogs.com/c-slmax/p/5853784.html</a>
</p>
</div>
</li>
<li><a id="org2b4d32e"></a>_<sub>thread和pthread</sub><sub>key</sub><sub>t</sub><br />
<div class="outline-text-5" id="text-1-2-1-8">
<p>
<a href="https://www.jianshu.com/p/e01c1a2a46e7?ref=myread">https://www.jianshu.com/p/e01c1a2a46e7?ref=myread</a>
</p>
</div>
</li>
<li><a id="org45b27fa"></a>explicit<br />
<div class="outline-text-5" id="text-1-2-1-9">
<p>
<a href="https://blog.csdn.net/guoyunfei123/article/details/89003369">https://blog.csdn.net/guoyunfei123/article/details/89003369</a>
</p>
</div>
</li>
<li><a id="org6f3838f"></a>自定义swap<br />
<div class="outline-text-5" id="text-1-2-1-10">
<p>
<a href="https://www.cnblogs.com/cposture/p/4939971.html">https://www.cnblogs.com/cposture/p/4939971.html</a>
</p>
</div>
</li>
<li><a id="org460180e"></a>C++ 传参时传内置类型时用传值(pass by value)方式效率较高<br />
<div class="outline-text-5" id="text-1-2-1-11">
<p>
<a href="https://blog.csdn.net/zyq522376829/article/details/48160039">https://blog.csdn.net/zyq522376829/article/details/48160039</a>
</p>
</div>
</li>
<li><a id="orgaf73818"></a>C++异常机制底层<br />
<div class="outline-text-5" id="text-1-2-1-12">
<p>
<a href="https://www.cnblogs.com/sgawscd/p/13870406.html">https://www.cnblogs.com/sgawscd/p/13870406.html</a>
<a href="http://www.baiy.cn/doc/cpp/inside_exception.htm">http://www.baiy.cn/doc/cpp/inside_exception.htm</a>
</p>
</div>
</li>
<li><a id="org0db6225"></a>BST与堆的区别<br />
<div class="outline-text-5" id="text-1-2-1-13">
<p>
<a href="http://www.dovov.com/searchbst.html">http://www.dovov.com/searchbst.html</a>
</p>
</div>
</li>
</ol>
</div>
<div id="outline-container-org7b972e6" class="outline-4">
<h4 id="org7b972e6"><span class="section-number-4">1.2.2</span> 网络</h4>
<div class="outline-text-4" id="text-1-2-2">
</div>
<ol class="org-ol">
<li><a id="org05ab5f2"></a>如何正确关闭tcp连接<br />
<div class="outline-text-5" id="text-1-2-2-1">
<p>
<a href="https://www.zhihu.com/question/48871684">https://www.zhihu.com/question/48871684</a>
</p>
</div>
</li>
<li><a id="orgda8da01"></a><span class="todo TODO">TODO</span> TODO TODO TODO TODO TODO 网络底层知识总结 <a href="http://www.52im.net/thread-3247-1-1.html">http://www.52im.net/thread-3247-1-1.html</a><br /></li>
</ol>
</div>
<div id="outline-container-org90b320a" class="outline-4">
<h4 id="org90b320a"><span class="section-number-4">1.2.3</span> 分布式</h4>
<div class="outline-text-4" id="text-1-2-3">
</div>
<ol class="org-ol">
<li><a id="orge170298"></a>protobuf<br />
<div class="outline-text-5" id="text-1-2-3-1">
<p>
<a href="http://www.52im.net/thread-323-1-1.html">http://www.52im.net/thread-323-1-1.html</a>
</p>
</div>
</li>
</ol>
</div>
</div>
<div id="outline-container-orgf476f10" class="outline-3">
<h3 id="orgf476f10"><span class="section-number-3">1.3</span> tools</h3>
<div class="outline-text-3" id="text-1-3">
</div>
<div id="outline-container-org9dcd1d9" class="outline-4">
<h4 id="org9dcd1d9"><span class="section-number-4">1.3.1</span> C++ 汇编代码查看</h4>
<div class="outline-text-4" id="text-1-3-1">
<p>
<a href="https://blog.csdn.net/zhangpeterx/article/details/100120219">https://blog.csdn.net/zhangpeterx/article/details/100120219</a>
<a href="https://godbolt.org">https://godbolt.org</a>
</p>
</div>
</div>
<div id="outline-container-orga99900e" class="outline-4">
<h4 id="orga99900e"><span class="section-number-4">1.3.2</span> 在线画图</h4>
<div class="outline-text-4" id="text-1-3-2">
<p>
<a href="https://blog.csdn.net/shenhangyu1989/article/details/79017293">https://blog.csdn.net/shenhangyu1989/article/details/79017293</a>
<a href="https://app.diagrams.net/#Huniquebby%2Fmobileinternet%2Fmaster%2FUntitled%20Diagram.drawio">https://app.diagrams.net/#Huniquebby%2Fmobileinternet%2Fmaster%2FUntitled%20Diagram.drawio</a>
</p>
</div>
</div>
<div id="outline-container-org78e0d23" class="outline-4">
<h4 id="org78e0d23"><span class="section-number-4">1.3.3</span> 在线看源码的网站</h4>
<div class="outline-text-4" id="text-1-3-3">
<p>
<a href="http://lxr.free-electrons.com">http://lxr.free-electrons.com</a>  need fq
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-org6926f43" class="outline-2">
<h2 id="org6926f43"><span class="section-number-2">2</span> emacs/spacemacs</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-orgfee95a1" class="outline-3">
<h3 id="orgfee95a1"><span class="section-number-3">2.1</span> 用法</h3>
<div class="outline-text-3" id="text-2-1">
<ul class="org-ul">
<li>Emacs org-mode 基本用法大全/文件内链接 : <a href="https://www.jianshu.com/p/78ef59327e2d">https://www.jianshu.com/p/78ef59327e2d</a></li>
<li>在org中保存mac的截图
org-download-clipboard</li>
</ul>
</div>
</div>
<div id="outline-container-orgd1aeec1" class="outline-3">
<h3 id="orgd1aeec1"><span class="section-number-3">2.2</span> 配置</h3>
<div class="outline-text-3" id="text-2-2">
</div>
<div id="outline-container-orgf884762" class="outline-4">
<h4 id="orgf884762"><span class="section-number-4">2.2.1</span> 值得推荐的工具:</h4>
<div class="outline-text-4" id="text-2-2-1">
<p>
<a href="https://www.optbbs.com/thread-3240381-1-1.html">https://www.optbbs.com/thread-3240381-1-1.html</a>
</p>
</div>
</div>
<div id="outline-container-orga8a6ad1" class="outline-4">
<h4 id="orga8a6ad1"><span class="section-number-4">2.2.2</span> c-c++ 补全配置:</h4>
<div class="outline-text-4" id="text-2-2-2">
<p>
<a href="http://vlambda.com/wz_1qenXqu7tj.html">http://vlambda.com/wz_1qenXqu7tj.html</a>
</p>
</div>
<ol class="org-ol">
<li><a id="org34a1f1f"></a><span class="todo TODO">TODO</span> 1. 配置lsp<br />
<div class="outline-text-5" id="text-2-2-2-1">
<p>
lsp在master分支上没有，只在develop分支上有，具体怎么配置还不熟悉
</p>
<div class="org-src-container">
<pre class="src src-elisp">dotspacemacs-configuration-layers
'<span style="color: #707183;">(</span>...
  lsp
  ...<span style="color: #707183;">)</span>
</pre>
</div>
<ol class="org-ol">
<li>安装ccls</li>
</ol>
<p>
<a href="https://github.com/MaskRay/ccls/wiki/Build">https://github.com/MaskRay/ccls/wiki/Build</a>
</p>
<div class="org-src-container">
<pre class="src src-shell">brew update
brew install ccls
</pre>
</div>
</div>
</li>
</ol>
</div>
<div id="outline-container-orgb3747fe" class="outline-4">
<h4 id="orgb3747fe"><span class="section-number-4">2.2.3</span> 使得能在org中执行c，c++代码</h4>
<div class="outline-text-4" id="text-2-2-3">
<p>
<a href="https://emacs.stackexchange.com/questions/17673/no-org-babel-execute-function-for-c-and-no-org-babel-execute-function-for-c">https://emacs.stackexchange.com/questions/17673/no-org-babel-execute-function-for-c-and-no-org-babel-execute-function-for-c</a>
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #707183;">(</span>org-babel-do-load-languages
 'org-babel-load-languages '<span style="color: #7388D6;">(</span><span style="color: #909183;">(</span>C . t<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org265250f" class="outline-3">
<h3 id="org265250f"><span class="section-number-3">2.3</span> <a href="https://github.com/emacs-china/Spacemacs-rocks/tree/master/Season1#navigation-your-lisp-code-faster">Spacemacs Rocks第二季</a></h3>
<div class="outline-text-3" id="text-2-3">
</div>
<div id="outline-container-orge5eabd5" class="outline-4">
<h4 id="orge5eabd5"><span class="section-number-4">2.3.1</span> resource</h4>
<div class="outline-text-4" id="text-2-3-1">
<p>
<a href="http://book.emacs-china.org/#orgheadline1">Ebook: Master Emacs in 21 Days</a>
</p>
</div>
</div>
<div id="outline-container-orgdb1530e" class="outline-4">
<h4 id="orgdb1530e"><span class="section-number-4">2.3.2</span> <a href="http://book.emacs-china.org/#orgheadline2">第一天：准备开始</a></h4>
<div class="outline-text-4" id="text-2-3-2">
</div>
<ol class="org-ol">
<li><a id="org06b5960"></a>交换ctrl键和caps lock键<br />
<div class="outline-text-5" id="text-2-3-2-1">
<p>
<a href="https://www.emacswiki.org/emacs/MovingTheCtrlKey">https://www.emacswiki.org/emacs/MovingTheCtrlKey</a>
</p>
</div>
</li>
<li><a id="org126ed5d"></a>基本操作<br />
<div class="outline-text-5" id="text-2-3-2-2">
<p>
;; 移动     
C-f 为前移一个字符， f 代表 forward。
C-b 为后移一个字符， b 代表 backward。
C-p 为上移至前一行， p 代表 previous。
C-n 为上移至下一行， n 代表 next。
C-a 为移至行首， a 代表 ahead。
C-e 为移至行尾， e 代表 end。
</p>

<p>
;; 文件操作
C-x C-f 为打开目标文件， f 代表 find/file
C-x C-s 为保存当前缓冲区（Buffer）， s 代表 save
;; 帮助信息
C-h k 寻找快捷键的帮助信息
C-h v 寻找变量的帮助信息
C-h f 寻找函数的帮助信息
;; 创建链接
C-c C-l
执行代码
C-x C-e（执行时光标必须处于要执行函数/代码的末尾）
如下面的lisp代码：
(+ 2 2)[执行前光标必须位于这个位置]
;; mode
C-h m 显示当前buffer的所有major mode和minor mode
;; gtd
C-c C-t(odo) 当前标签变为TODO，再按一次变为DONE，再按一次取消
</p>
</div>
</li>
</ol>
</div>
<div id="outline-container-org3991eb4" class="outline-4">
<h4 id="org3991eb4"><span class="section-number-4">2.3.3</span> <a href="http://book.emacs-china.org/#orgheadline9">第二天:高级自定义</a></h4>
<div class="outline-text-4" id="text-2-3-3">
</div>
<ol class="org-ol">
<li><a id="org835a04c"></a>70:45分开始：org-mode Agenda的使用<br />
<div class="outline-text-5" id="text-2-3-3-1">
<p>
;; 设置默认 Org Agenda 文件目录
(setq org-agenda-files '("~/org"))
</p>

<p>
你只需将你的 *.org 文件放入上面所指定的文件夹中就可以开始使用 Agenda 模式了。
</p>

<p>
C-c C-s 选择想要开始的时间
C-c C-d 选择想要结束的时间
C-c a 可以打开 Agenda 模式菜单并选择不同的可视方式（ r ）(需要保存org文件才会更新agenda)
</p>
</div>
</li>
</ol>
</div>

<div id="outline-container-orge225b63" class="outline-4">
<h4 id="orge225b63"><span class="section-number-4">2.3.4</span> <a href="http://book.emacs-china.org/#orgheadline73">第十一天: Spacemacs 简介及安装</a></h4>
<div class="outline-text-4" id="text-2-3-4">
<p>
SPC s s 搜索
<i>SPC h SPC 弹出一个信息窗口, 可以从窗口中选择具体的 layer 或者其他信息进行查看.</i>
</p>
</div>
<ol class="org-ol">
<li><a id="org0faf882"></a>换monokai主题（46:00）<br />
<div class="outline-text-5" id="text-2-3-4-1">
<p>
主题预览：<a href="https://themegallery.robdor.com">https://themegallery.robdor.com</a>
出现的问题：<a href="https://emacs-china.org/t/spacemacs/885">https://emacs-china.org/t/spacemacs/885</a> ，
解决方法：在addition-packets中加上monokai-theme
</p>
<pre class="example">
dotspacemacs-additional-packages '(youdao-dictionary monokai-theme)
</pre>
</div>
</li>

<li><a id="orgfb253de"></a>插入结构块<br />
<div class="outline-text-5" id="text-2-3-4-2">
<ul class="org-ul">
<li>C-c C-, 插入包括代码块在内的各种块.</li>
<li>org-mode &lt;s tab 插入代码块不可用的问题 <a href="https://emacs-china.org/t/spacemacs-org-mode-s/8366/4">https://emacs-china.org/t/spacemacs-org-mode-s/8366/4</a></li>
<li>, ' 打开代码块缓冲编辑代码</li>
<li>C-c C-c 执行代码块(C/C++ 必须大写)</li>
</ul>
</div>
</li>
</ol>
</div>

<div id="outline-container-orgbcebe6d" class="outline-4">
<h4 id="orgbcebe6d"><span class="section-number-4">2.3.5</span> <a href="https://www.bilibili.com/video/BV1Dx411z7i3?p=12">第十二天: 创建你的第一个 Spacemacs Layer</a></h4>
<div class="outline-text-4" id="text-2-3-5">
</div>
<ol class="org-ol">
<li><a id="org96c512e"></a>更换状态栏样式(09:27)<br />
<div class="outline-text-5" id="text-2-3-5-1">
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">(setq powerline-default-separator 'alternate)</span>
<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">&#26356;&#25442;&#29366;&#24577;&#26639;&#26684;&#24335;</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">setq</span> powerline-default-separator 'bar<span style="color: #707183;">)</span>
</pre>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-orgbc46598" class="outline-4">
<h4 id="orgbc46598"><span class="section-number-4">2.3.6</span> agenda 使用</h4>
<div class="outline-text-4" id="text-2-3-6">
<ul class="org-ul">
<li>, a 打开agenda</li>
<li>, p 给当前任务开启一个番茄时间</li>
<li><a href="https://www.bilibili.com/video/BV1Z7411273s?p=6">https://www.bilibili.com/video/BV1Z7411273s?p=6</a></li>
</ul>
</div>
</div>
</div>
</div>

<div id="outline-container-org0f85498" class="outline-2">
<h2 id="org0f85498"><span class="section-number-2">3</span> reading</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-orgf8e2be6" class="outline-3">
<h3 id="orgf8e2be6"><span class="section-number-3">3.1</span> c++ primer(5th) <a href="file:///Users/binbinyang/Documents/C++  Primer中文版  第5版 [（美）李普曼，（美）拉乔伊，（美）默著][电子工业出版社][2013.08][838页].pdf">pdf</a></h3>
<div class="outline-text-3" id="text-3-1">
</div>
<div id="outline-container-orgd1dbab8" class="outline-4">
<h4 id="orgd1dbab8"><span class="section-number-4">3.1.1</span> 初始化问题</h4>
<div class="outline-text-4" id="text-3-1-1">
</div>
<ol class="org-ol">
<li><a id="orgba3e5f9"></a>类内初始化<br />
<div class="outline-text-5" id="text-3-1-1-1">
<p>
c++11标准规定，可以为数据成员提供类内初始值，这个初始值可以放在花括号(列表初始化)里，也可以
放在等于号右边，但是 <b>不能使用圆括号</b>
</p>
</div>
</li>
<li><a id="org6df1c79"></a>初始化要注意的地方<br />
<div class="outline-text-5" id="text-3-1-1-2">
<ol class="org-ol">
<li>使用拷贝初始化时，只能提供一个初始值</li>
<li>类内初始值只能由拷贝初始化或使用花括号初始化</li>
<li>如果以提供初始元素值列表的形式初始化，只能用花括号，不能使用圆括号</li>
<li><p>
如果初始化时使用了花括号形式但是不能用于列表初始化，那就只能考虑用这些值来匹配构造函数
也就是说花括号形式不等于列表初始化，如：
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #6434A3;">vector</span><span style="color: #707183;">&lt;</span><span style="color: #6434A3;">string</span><span style="color: #707183;">&gt;</span> <span style="color: #BA36A5;">v</span><span style="color: #707183;">{</span><span style="color: #D0372D;">10</span>, <span style="color: #008000;">"hi"</span><span style="color: #707183;">}</span>;    <span style="color: #8D8D84;">//</span><span style="color: #8D8D84; font-style: italic;">v&#26377;10&#20010;&#20540;&#20026;&#8220;hi&#8221;&#30340;&#20803;&#32032;</span>
</pre>
</div></li>
</ol>
</div>
</li>
</ol>
</div>
<div id="outline-container-org7517d22" class="outline-4">
<h4 id="org7517d22"><span class="section-number-4">3.1.2</span> 左值引用与右值引用</h4>
<div class="outline-text-4" id="text-3-1-2">
<ul class="org-ul">
<li>左值引用 46页
引用类型一般必须与其所引用对象的类型一致，但是有两个例外：
<ol class="org-ol">
<li><p>
允许用任意表达式初始化常量引用（非常量对象，字面值，一般表达式）
</p>

<div id="org4edba01" class="figure">
<p><img src="reading/2020-11-20_21-26-23_screenshot.png" alt="2020-11-20_21-26-23_screenshot.png" />
</p>
</div></li>
<li>TODO</li>
</ol></li>
<li>右值引用 471页</li>
</ul>
</div>
</div>
<div id="outline-container-orga49b6ba" class="outline-4">
<h4 id="orga49b6ba"><span class="section-number-4">3.1.3</span> extern</h4>
<div class="outline-text-4" id="text-3-1-3">
<p>
如果要在多个文件中使用同一个函数或变量，则定义只能出现在一个文件中：
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">声明</th>
<th scope="col" class="org-left">定义</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">变量</td>
<td class="org-left">extern int a;</td>
<td class="org-left">[extern] int a = 1;</td>
</tr>

<tr>
<td class="org-left">函数</td>
<td class="org-left">extern void foo();</td>
<td class="org-left">extern void foo() {}</td>
</tr>

<tr>
<td class="org-left">const 变量</td>
<td class="org-left">extern const int a；</td>
<td class="org-left">extern const int a = 1;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-org188ed6f" class="outline-4">
<h4 id="org188ed6f"><span class="section-number-4">3.1.4</span> 引用与指针</h4>
<div class="outline-text-4" id="text-3-1-4">
<p>
考虑代码：
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #0000FF;">class</span> <span style="color: #6434A3;">A</span> <span style="color: #707183;">{</span>
<span style="color: #0000FF;">public</span>:
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">aa</span>;
<span style="color: #707183;">}</span>;

<span style="color: #6434A3;">int</span> <span style="color: #006699;">main</span><span style="color: #707183;">()</span> <span style="color: #707183;">{</span>
  <span style="color: #0000FF;">auto</span> <span style="color: #BA36A5;">a</span> = <span style="color: #0000FF;">new</span> <span style="color: #6434A3;">A</span><span style="color: #7388D6;">()</span>;
  <span style="color: #0000FF;">auto</span> &amp;<span style="color: #BA36A5;">b</span> = *a;  
  <span style="color: #0000FF;">auto</span> *<span style="color: #BA36A5;">c</span> = a;
  <span style="color: #0000FF;">return</span> a-&gt;aa;
<span style="color: #707183;">}</span>
</pre>
</div>
<p>
汇编代码：
</p>
<div class="org-src-container">
<pre class="src src-asm"><span style="color: #006699;">main</span>:
        <span style="color: #0000FF;">pushq</span>   <span style="color: #BA36A5;">%rbp</span>
        <span style="color: #0000FF;">movq</span>    <span style="color: #BA36A5;">%rsp</span>, <span style="color: #BA36A5;">%rbp</span>
        <span style="color: #0000FF;">subq</span>    $32, <span style="color: #BA36A5;">%rsp</span>
        <span style="color: #0000FF;">movl</span>    $4, <span style="color: #BA36A5;">%edi</span>
        <span style="color: #0000FF;">call</span>    operator new<span style="color: #707183;">(</span>unsigned long<span style="color: #707183;">)</span>
        <span style="color: #0000FF;">movl</span>    $0, <span style="color: #707183;">(</span><span style="color: #BA36A5;">%rax</span><span style="color: #707183;">)</span>
        <span style="color: #0000FF;">movq</span>    <span style="color: #BA36A5;">%rax</span>, -8<span style="color: #707183;">(</span><span style="color: #BA36A5;">%rbp</span><span style="color: #707183;">)</span>
        <span style="color: #0000FF;">movq</span>    -8<span style="color: #707183;">(</span><span style="color: #BA36A5;">%rbp</span><span style="color: #707183;">)</span>, <span style="color: #BA36A5;">%rax</span>
        <span style="color: #0000FF;">movq</span>    <span style="color: #BA36A5;">%rax</span>, -16<span style="color: #707183;">(</span><span style="color: #BA36A5;">%rbp</span><span style="color: #707183;">)</span>
        <span style="color: #0000FF;">movq</span>    -8<span style="color: #707183;">(</span><span style="color: #BA36A5;">%rbp</span><span style="color: #707183;">)</span>, <span style="color: #BA36A5;">%rax</span>
        <span style="color: #0000FF;">movq</span>    <span style="color: #BA36A5;">%rax</span>, -24<span style="color: #707183;">(</span><span style="color: #BA36A5;">%rbp</span><span style="color: #707183;">)</span>
        <span style="color: #0000FF;">movq</span>    -8<span style="color: #707183;">(</span><span style="color: #BA36A5;">%rbp</span><span style="color: #707183;">)</span>, <span style="color: #BA36A5;">%rax</span>
        <span style="color: #0000FF;">movl</span>    <span style="color: #707183;">(</span><span style="color: #BA36A5;">%rax</span><span style="color: #707183;">)</span>, <span style="color: #BA36A5;">%eax</span>
        <span style="color: #0000FF;">leave</span>
        <span style="color: #0000FF;">ret</span>
</pre>
</div>
<p>
可以看到，引用b和指针c的汇编代码是一样的，所以引用和指针的底层实现并没有什么区别，
只是编译器对引用多了很多检查：
1.必须指定初始化值
2.初始化后无法改变
我的理解是这样可以更早暴露代码中的问题。
</p>
</div>
</div>
<div id="outline-container-org9a09fc3" class="outline-4">
<h4 id="org9a09fc3"><span class="section-number-4">3.1.5</span> const注意点页</h4>
</div>
<div id="outline-container-org01054a8" class="outline-4">
<h4 id="org01054a8"><span class="section-number-4">3.1.6</span> constexpr(58页）</h4>
<div class="outline-text-4" id="text-3-1-6">
<ul class="org-ul">
<li>常量表达式是指值不会改变并且在编译过程就能计算出结果的表达式</li>
<li>一个变量是不是常量表达式由他的类型和初始值共同决定</li>
<li>c++11标准允许将变量声明为constexpr类型以便编译器检查变量是否为一个常量表达式</li>
<li>只有字面值类型(算术类型，引用和指针, TODO)能声明为constexpr类型</li>
<li>一个constexpr指针的初始值必须是nullptr或0，或者是存储于固定地址的对象</li>
<li>constexpr只对指针有效，对指针所指对象无效
如：constexpr int *q = nullptr //q是指向整数的常量指针</li>
</ul>
</div>
</div>
<div id="outline-container-org6605e2b" class="outline-4">
<h4 id="org6605e2b"><span class="section-number-4">3.1.7</span> auto类型说明符(61页)</h4>
<div class="outline-text-4" id="text-3-1-7">
<ul class="org-ul">
<li><p>
使用引用其实是使用引用的对象，特别是当引用被用作初始值时，编译器以引用对象的类型作为auto的类型：
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">i</span> = <span style="color: #D0372D;">0</span>, &amp;<span style="color: #BA36A5;">r</span> = i;
<span style="color: #0000FF;">auto</span> <span style="color: #BA36A5;">a</span> = r; <span style="color: #8D8D84;">//</span><span style="color: #8D8D84; font-style: italic;">a&#30340;&#31867;&#22411;&#26159;int&#65292; &#32780;&#19981;&#26159;int &amp;</span>
</pre>
</div></li>
<li><p>
一般auto会忽略掉顶层const，保留下底层const
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #0000FF;">const</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">ci</span> = i, &amp;<span style="color: #BA36A5;">cr</span> = ci;
<span style="color: #0000FF;">auto</span> <span style="color: #BA36A5;">c</span> = cr;  <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">c&#26159;&#19968;&#20010;&#25972;&#25968;&#65288;&#19981;&#24102;&#39030;&#23618;const&#65289;</span>
<span style="color: #0000FF;">auto</span> <span style="color: #BA36A5;">e</span> = &amp;ci  <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">e&#26159;&#19968;&#20010;&#25351;&#21521;&#25972;&#25968;&#24120;&#37327;&#30340;&#25351;&#38024;(&#20445;&#30041;&#24213;&#23618;const)</span>
</pre>
</div></li>
<li><p>
如果希望推断出的auto类型是一个顶层const，需要明确指出
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #0000FF;">const</span> <span style="color: #0000FF;">auto</span> <span style="color: #BA36A5;">f</span> = ci;  <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">&#21644;c&#19981;&#21516;&#65292; f&#26159;const int</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org75b594f" class="outline-4">
<h4 id="org75b594f"><span class="section-number-4">3.1.8</span> decltype类型说明符(62页）</h4>
<div class="outline-text-4" id="text-3-1-8">
<ul class="org-ul">
<li>c++11标准引入了第二种类型说明符,他的作用使编译器分析表达式并是返回表达式的类型,
但不实际计算表达式的值, 需要指出的是，引用从来都作为其所指对象的同义词出现，只有
用在decltype处是一个 <b>例外</b></li>
<li>decltype与auto的区别
<ol class="org-ol">
<li>decltype保留顶层const和引用，auto则不保留</li>
<li>decltype与表达式形式密切相关， decltype((variable))的结果永远是引用，
而decltype(*p)也是引用类型</li>
</ol></li>
</ul>
</div>
</div>
<div id="outline-container-orgaaa822d" class="outline-4">
<h4 id="orgaaa822d"><span class="section-number-4">3.1.9</span> 内置数组与vector的区别</h4>
<div class="outline-text-4" id="text-3-1-9">
<ol class="org-ol">
<li><p>
内直数组不能拷贝和赋值
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">a</span><span style="color: #707183;">[]</span> = <span style="color: #707183;">{</span><span style="color: #D0372D;">0</span> , <span style="color: #D0372D;">1</span>, <span style="color: #D0372D;">2</span><span style="color: #707183;">}</span>;
<span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">a2</span><span style="color: #707183;">[]</span> = a;  <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">&#38169;&#35823;&#65306;&#19981;&#20801;&#35768;&#20351;&#29992;&#19968;&#20010;&#25968;&#32452;&#21021;&#22987;&#21270;&#21478;&#19968;&#20010;</span>
a2 = a;        <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">&#38169;&#35823;&#65306;&#19981;&#20801;&#35768;&#20351;&#29992;&#19968;&#20010;&#25968;&#32452;&#36171;&#20540;&#32473;&#21478;&#19968;&#20010;</span>
</pre>
</div></li>
<li><p>
内置的下标运算符所用的索引值不是无符号类型，而vector是
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">ia</span><span style="color: #707183;">[]</span> = <span style="color: #707183;">{</span><span style="color: #D0372D;">0</span>, <span style="color: #D0372D;">2</span>, <span style="color: #D0372D;">4</span> ,<span style="color: #D0372D;">6</span> , <span style="color: #D0372D;">8</span><span style="color: #707183;">}</span>;
<span style="color: #6434A3;">int</span> *<span style="color: #BA36A5;">p</span> = &amp;ia<span style="color: #707183;">[</span><span style="color: #D0372D;">2</span><span style="color: #707183;">]</span>;
<span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">k</span> = p<span style="color: #707183;">[</span>-<span style="color: #D0372D;">2</span><span style="color: #707183;">]</span>;   <span style="color: #8D8D84;">//</span><span style="color: #8D8D84; font-style: italic;">&#21487;&#20197;&#29992;&#36127;&#25968;&#20316;&#20026;&#19979;&#26631;</span>
</pre>
</div></li>
</ol>
<p>
等价于*(it++) , 输出当前值并将it向前移动一个元素
</p>
</div>
</div>
<div id="outline-container-org906b664" class="outline-4">
<h4 id="org906b664"><span class="section-number-4">3.1.10</span> sizeof运算符(139页)</h4>
<div class="outline-text-4" id="text-3-1-10">
<div class="org-src-container">
<pre class="src src-C++"><span style="color: #808080;">#include</span> <span style="color: #707183;">&lt;</span><span style="color: #008000;">vector</span><span style="color: #707183;">&gt;</span>
<span style="color: #808080;">#include</span> <span style="color: #707183;">&lt;</span><span style="color: #008000;">iostream</span><span style="color: #707183;">&gt;</span>
<span style="color: #0000FF;">using</span> <span style="color: #0000FF;">namespace</span> <span style="color: #D0372D;">std</span>;
<span style="color: #6434A3;">int</span> <span style="color: #006699;">main</span><span style="color: #707183;">()</span> <span style="color: #707183;">{</span>
  <span style="color: #6434A3;">vector</span><span style="color: #7388D6;">&lt;</span><span style="color: #6434A3;">int</span><span style="color: #7388D6;">&gt;</span> <span style="color: #BA36A5;">v</span><span style="color: #7388D6;">(</span><span style="color: #D0372D;">100</span>, <span style="color: #D0372D;">0</span><span style="color: #7388D6;">)</span>;
  cout &lt;&lt; <span style="color: #0000FF;">sizeof</span><span style="color: #7388D6;">(</span>v<span style="color: #7388D6;">)</span> &lt;&lt; endl;
  <span style="color: #0000FF;">return</span> <span style="color: #D0372D;">0</span>;
<span style="color: #707183;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org98e62e1" class="outline-4">
<h4 id="org98e62e1"><span class="section-number-4">3.1.11</span> 隐式类型转换 (141页）</h4>
<div class="outline-text-4" id="text-3-1-11">

<div id="orgb500ed0" class="figure">
<p><img src="reading/2020-11-21_11-00-05_screenshot.png" alt="2020-11-21_11-00-05_screenshot.png" />
</p>
</div>
</div>
</div>
<div id="outline-container-org4170d48" class="outline-4">
<h4 id="org4170d48"><span class="section-number-4">3.1.12</span> 运算符优先级表(147页)</h4>
</div>
<div id="outline-container-org2928552" class="outline-4">
<h4 id="org2928552"><span class="section-number-4">3.1.13</span> 函数重载(208页)</h4>
<div class="outline-text-4" id="text-3-1-13">
<p>
<b>同一作用域</b>  函数名相同但形参列表不同(类型或个数或顺序)
</p>
</div>
<ol class="org-ol">
<li><a id="orgcba9fe4"></a>几种视为相同的函数声明<br />
<div class="outline-text-5" id="text-3-1-13-1">
<ol class="org-ol">
<li></li>
</ol>
<p>
void A(int &amp;)
void A(int &amp;i)
</p>
<ol class="org-ol">
<li></li>
</ol>
<p>
typedef phone telno
int lookup(phone&amp;)
int lookup(telno&amp;)
3.顶层const
int lookup(phone)
int lookup(const phone)
</p>
</div>
</li>
</ol>
</div>

<div id="outline-container-orge6a4bb0" class="outline-4">
<h4 id="orge6a4bb0"><span class="section-number-4">3.1.14</span> 值初始化(88页)和默认初始化</h4>
<div class="outline-text-4" id="text-3-1-14">
<ul class="org-ul">
<li><a href="https://www.cnblogs.com/lustar/p/7450097.html">https://www.cnblogs.com/lustar/p/7450097.html</a></li>
<li>默认初始化和值初始化分别在哪些情况下发生：（262页）</li>
</ul>
</div>
</div>
<div id="outline-container-org675adb8" class="outline-4">
<h4 id="org675adb8"><span class="section-number-4">3.1.15</span> 类的静态成员</h4>
<div class="outline-text-4" id="text-3-1-15">
<ul class="org-ul">
<li>类的静态成员函数不能声明成const的，因为不带this指针</li>
<li>不能在类内部初始化静态成员，但可以初始化 <b>const static</b></li>
<li>静态数据成员可以是类本身，而飞静态数据成员则只能声明成它所属类的指针或引用</li>
</ul>
</div>
</div>
<div id="outline-container-orgeae21e7" class="outline-4">
<h4 id="orgeae21e7"><span class="section-number-4">3.1.16</span> 智能指针</h4>
<div class="outline-text-4" id="text-3-1-16">
</div>
<ol class="org-ol">
<li><a id="orgab525bd"></a>shared<sub>ptr初始化</sub><br />
<div class="outline-text-5" id="text-3-1-16-1">
<ul class="org-ul">
<li>如果不初始化一个智能指针，它就会被初始化为一个空指针</li>
<li>接受指针参数的智能指针的构造函数是explicit的,所以我们不能将一个内置指针隐式转换为一个智能指针</li>
</ul>
</div>
</li>
<li><a id="orge88901e"></a>注意点(陷阱)<br />
<div class="outline-text-5" id="text-3-1-16-2">
<ul class="org-ul">
<li>不要混合使用普通指针和智能指针</li>
<li>不要用get初始化另一个智能指针或为智能指针赋值</li>
<li>不使用相同的内置指针初始化（或reset）多个智能指针</li>
<li>不delete get（）返回的指针</li>
<li>当智能指针销毁后，get（）返回的该智能指针的普通指针就无效了</li>
<li>如果智能指针管理的资源不是new分配的内存，记住传递一个自定义的删除器</li>
</ul>
</div>
</li>
</ol>
</div>
<div id="outline-container-orgd7c7c6a" class="outline-4">
<h4 id="orgd7c7c6a"><span class="section-number-4">3.1.17</span> <span class="todo TODO">TODO</span> allocator</h4>
</div>
<div id="outline-container-orged56874" class="outline-4">
<h4 id="orged56874"><span class="section-number-4">3.1.18</span> 13章 拷贝控制</h4>
<div class="outline-text-4" id="text-3-1-18">
</div>
<ol class="org-ol">
<li><a id="org4755832"></a>拷贝构造函数<br />
<div class="outline-text-5" id="text-3-1-18-1">
<ul class="org-ul">
<li>和默认构造函数不同，即使我们定义了其他构造函数，编译器也会为我们合成一个拷贝构造函数</li>
<li>拷贝构造函数的第一个参数必须是一个引用类型，而且这个参数几乎总是const的</li>
<li>拷贝构造函数通常不应该是explicit的，因为它会被隐式使用</li>
<li>每个成员的类型决定了它如何拷贝，对类类型的成员会使用其拷贝构造函数，内置类型直接拷贝</li>
</ul>
</div>
</li>
<li><a id="org86936dc"></a>拷贝初始化和直接初始化<br />
<div class="outline-text-5" id="text-3-1-18-2">
<ul class="org-ul">
<li>拷贝初始化使用等号，直接初始化不使用等号</li>
<li>直接初始化实际上是要求编译器使用普通的函数匹配来选择与我们提供的参数最匹配的构造函数，
拷贝初始化要求编译器将=右侧的运算对象拷贝到正在创建的对象中，如果需要的话还要进行类型
转换</li>
</ul>
</div>
</li>
<li><a id="org436ce39"></a>拷贝构造函数和拷贝赋值运算符怎么区别<br />
<div class="outline-text-5" id="text-3-1-18-3">
<ul class="org-ul">
<li><p>
拷贝构造函数是在初始化时调用，而赋值运算符是在初始化后的赋值时调用
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">&#25335;&#36125;&#26500;&#36896;&#20989;&#25968;</span>
<span style="color: #6434A3;">string</span> <span style="color: #BA36A5;">s</span> = <span style="color: #008000;">"emacs"</span>;

<span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">&#25335;&#36125;&#36171;&#20540;&#36816;&#31639;&#31526;</span>
<span style="color: #6434A3;">string</span> <span style="color: #BA36A5;">s</span>;
s = <span style="color: #008000;">"emacs"</span>;
</pre>
</div></li>
</ul>
</div>
</li>
<li><a id="org74899b0"></a>析构函数<br />
<div class="outline-text-5" id="text-3-1-18-4">
<ul class="org-ul">
<li>认识到析构函数自身并不直接销毁成员是非常重要的，成员是在析构函数体之后隐含的析构阶段中
被销毁的</li>
</ul>
</div>
</li>
<li><a id="orgbe17f9f"></a>三五法则<br />
<ol class="org-ol">
<li><a id="orgab7f0c3"></a>需要析构函数的类也需要拷贝和赋值操作<br />
<div class="outline-text-6" id="text-3-1-18-5-1">
<p>
因为需要析构函数说明需要自定义资源管理，那么拷贝和赋值也都需要,比如析构函数销毁指针所指
资源，如果用合成的拷贝和赋值操作的话，会使两个对象的该指针指向同一地址，引发错误
</p>
</div>
</li>
<li><a id="org8208770"></a>需要拷贝操作的类也需要赋值操作，反之亦然<br />
<div class="outline-text-6" id="text-3-1-18-5-2">
<p>
作为例子，考虑一个类为每个对象分配一个唯一的序号，这个时候就需要自定义拷贝和赋值操作而
不能用合成的，拷贝和赋值实现的效果其实是相同的，所以一个需要自定义的话，另一个也需要,
但是上面这个例子其实不需要自定义析构函数，因为没有资源需要管理。
</p>
</div>
</li>
<li><a id="orgd4d09fc"></a>一般来说，如果一个类定义了任何一个拷贝操作，他就应该定义所有五个操作<br />
<div class="outline-text-6" id="text-3-1-18-5-3">
<p>
因为如果必须自定义拷贝构造函数，拷贝赋值运算符和析构函数，那么这个类通常会涉及资源的管理问题，
而拷贝成员必须拷贝这些资源。这会导致额外的开销，所以一般要定义移动构造函数和移动赋值运算符来
避免这种开销
</p>
</div>
</li>
</ol>
</li>
<li><a id="org0c55e40"></a>移动构造函数<br />
<div class="outline-text-5" id="text-3-1-18-6">
<ul class="org-ul">
<li>除了完成资源的移动，移动构造函数还必须保证源对象处于析构安全状态,也就是说析构它是无害的,
而且也必须是可以被析构的(还是存在的，可以进行操作)</li>
<li>由于移动操作通常不分配任何资源，所以通常不抛出任何异常</li>
<li>只有当一个类没有定义任何直接版本的拷贝控制成员，且类的每个非static数据成员都可以
移动时，编译器才会为它合成移动构造函数或移动赋值运算符</li>
<li>定义了一个移动构造函数或移动赋值运算符的类必须也定义自己的拷贝操作，否则，这些成员
默认地被定义为删除的</li>
</ul>
</div>
</li>
<li><a id="orgddf7fdd"></a><span class="todo TODO">TODO</span> 移动迭代器<br /></li>
<li><a id="org3949d2c"></a>右值引用和成员函数<br />
<div class="outline-text-5" id="text-3-1-18-8">
<p>
区分移动和拷贝的重载函数通常有一个版本接受一个const T&amp;， 而另一个版本接受一个T&amp;&amp;, 因为一般
来说，当我们希望移动数据时实参不能是const的，因为这样才能保证移动源可以被改变成析构安全的。
</p>
</div>
</li>
<li><a id="orgf49add5"></a><span class="todo TODO">TODO</span> 函数重载与const， &amp;， &amp;&amp;<br /></li>
</ol>
</div>
<div id="outline-container-orgfad70c0" class="outline-4">
<h4 id="orgfad70c0"><span class="section-number-4">3.1.19</span> 14章 重载运算和类型转换</h4>
<div class="outline-text-4" id="text-3-1-19">
</div>
<ol class="org-ol">
<li><a id="org659f5ae"></a>重载运算符<br />
<div class="outline-text-5" id="text-3-1-19-1">
<ul class="org-ul">
<li>重载运算符实质是具有特殊名字的函数，由关键字operator和要定义的运算符共同组成。一元运算符有一个
参数，二元运算符有两个参数：运算符左侧对象传递给第一个参数，右侧传给第二个。</li>
<li>除了operator()之外，其他重载运算符都不能有默认实参</li>
<li>一个运算符函数，要么是类的成员，要么至少含有一个类类型的参数(因为内置类型的运算符已经预定了)</li>
<li>当一个重载运算符是成员函数时，this绑定到左侧运算对象，所以显式参数比运算对象少一个</li>
<li>不能被重载的运算符(:: .* . ?:)</li>
<li>通常情况下不应该被重载的运算符(, &amp; &amp;&amp; ||), 因为重载本质是函数，无法保留求值顺序/短路求值属性</li>
</ul>
</div>
<ol class="org-ol">
<li><a id="orgde7eb15"></a>重载运算符是否定义为成员函数的准则：<br />
<div class="outline-text-6" id="text-3-1-19-1-1">

<div id="orge52bc32" class="figure">
<p><img src="reading/2020-11-06_11-06-01_screenshot.png" alt="2020-11-06_11-06-01_screenshot.png" />
</p>
</div>

<ul class="org-ul">
<li>输入运算符必须处理输入可能失败的情况，而输出符不需要(496页)</li>
<li>如果定义了算术运算符和相应的复合赋值运算符，通常应使用后者实现前者</li>
<li>赋值运算符必须是类的成员，复合赋值运算符通常情况下(难道不是必须吗？TODO，不是成员的话
不能访问类并对它赋值吧？）也是如此(500页)</li>
<li>下标运算符必须是成员函数，下标运算符通常需要两个版本：一个返回普通引用，一个返回const引用</li>
<li>递增递减运算符应该同时定义前置和后置版本，且通常被定义为类的成员,前置返回引用，后置返回值。
后置版本需要接受一个额外的不被使用的int形参来和前置区分</li>
<li>-&gt;运算符必须是类的成员，解引用运算符通常也是类的成员</li>
</ul>
</div>
</li>
</ol>
</li>
<li><a id="orgc3762d2"></a>函数调用运算符<br />
<div class="outline-text-5" id="text-3-1-19-2">
<ul class="org-ul">
<li>函数调用运算符必须是成员函数，一个类可以定义多个不同版本的调用运算符，它们应该在参数数量或
类型上有所区别</li>
<li>定义了调用运算符的类叫函数对象，这些对象的行为就像函数一样,函数对象常常作为泛型算法的实参</li>
</ul>
</div>
</li>
<li><a id="orga230c8c"></a><span class="todo TODO">TODO</span> lambda(508页)<br /></li>
<li><a id="org813880e"></a>可调用对象与function<br />
<div class="outline-text-5" id="text-3-1-19-4">
<p>
c++有几种可调用的对象：函数、函数指针、lambda表达式、bind创建的对象以及重载了函数调用运算符的
类。他们的调用形式可以是相同的，但是却有着不同的类型，所以在很多地方受到约束。比如下面的例子，
我们想定义一个简单的计算器：
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #6434A3;">int</span> <span style="color: #006699;">add</span><span style="color: #707183;">(</span><span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">i</span>, <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">j</span><span style="color: #707183;">)</span> <span style="color: #707183;">{</span><span style="color: #0000FF;">return</span> i+j;<span style="color: #707183;">}</span>
<span style="color: #0000FF;">auto</span> <span style="color: #BA36A5;">mod</span> = <span style="color: #707183;">[](</span><span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">i</span>, <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">j</span><span style="color: #707183;">)</span> <span style="color: #707183;">{</span><span style="color: #0000FF;">return</span> i%j;<span style="color: #707183;">}</span>

<span style="color: #6434A3;">map</span><span style="color: #707183;">&lt;</span><span style="color: #6434A3;">string</span>, <span style="color: #6434A3;">int</span><span style="color: #7388D6;">(</span>*<span style="color: #7388D6;">)(</span><span style="color: #6434A3;">int</span>,<span style="color: #6434A3;">int</span><span style="color: #7388D6;">)</span><span style="color: #707183;">&gt;</span> <span style="color: #BA36A5;">binops</span>;
<span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">&#27491;&#30830;</span>
binops.insert<span style="color: #707183;">(</span><span style="color: #7388D6;">{</span><span style="color: #008000;">"+"</span>, add<span style="color: #7388D6;">}</span><span style="color: #707183;">)</span>;
<span style="color: #8D8D84;">//</span><span style="color: #8D8D84; font-style: italic;">&#38169;&#35823;, mod&#19981;&#26159;&#20989;&#25968;&#25351;&#38024;</span>
binops.insert<span style="color: #707183;">(</span><span style="color: #7388D6;">{</span><span style="color: #008000;">"%"</span>, mod<span style="color: #7388D6;">}</span><span style="color: #707183;">)</span>;
</pre>
</div>
<p>
c++11新标准库function类型解决了这个问题:
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #6434A3;">map</span><span style="color: #707183;">&lt;</span><span style="color: #6434A3;">string</span>, <span style="color: #6434A3;">function</span><span style="color: #7388D6;">&lt;</span><span style="color: #6434A3;">int</span><span style="color: #909183;">(</span><span style="color: #6434A3;">int</span>,<span style="color: #6434A3;">int</span><span style="color: #909183;">)</span><span style="color: #7388D6;">&gt;</span><span style="color: #707183;">&gt;</span> <span style="color: #BA36A5;">binops</span>;

binops.insert<span style="color: #707183;">(</span><span style="color: #008000;">"+"</span>, add<span style="color: #707183;">)</span>;
binops.insert<span style="color: #707183;">(</span><span style="color: #008000;">"%"</span>, mod<span style="color: #707183;">)</span>;
</pre>
</div>
<p>
当然，如果add函数被重载的话，上面的方法就行不通了，但是可以用函数指针来解决
</p>
</div>
</li>
<li><a id="orgc524603"></a>重载，类型转换与运算符<br />
<ol class="org-ol">
<li><a id="org0163c00"></a>类型转换运算符<br />
<div class="outline-text-6" id="text-3-1-19-5-1">
<p>
转换构造函数和类型转换运算符共同定义了类类型转换，与标准类型转换相对，这种转换也叫用户
定义的类型转换。
类型转换函数的一般形式为：
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #0000FF;">operator</span> <span style="color: #6434A3;">type</span><span style="color: #707183;">()</span> <span style="color: #0000FF;">const</span>
</pre>
</div>
<p>
一个类型转换函数必须是类的成员函数；它不能声明返回类型，形参列表也必须为空。类型转换函数通常
应该是const的，因为它不应该改变待转换对象的内容。
为了防止隐式类型转换引发意想不到的结果，c++11标准引入了显示的类型转换运算符：
</p>
<div class="org-src-container">
<pre class="src src-c">explicit operator <span style="color: #6434A3;">int</span><span style="color: #707183;">()</span> <span style="color: #0000FF;">const</span> <span style="color: #707183;">{}</span>;
</pre>
</div>
<p>
和显示构造函数一样，编译器不会将一个显式的类型转换运算符用于隐式类型转换，除了下边这个例外：
</p>
<p>
<img src="reading/2020-11-07_10-58-13_screenshot.png" alt="2020-11-07_10-58-13_screenshot.png" />
      正因为这个例外，operator bool一般定义为explicit的
</p>
</div>
</li>
<li><a id="org60e4d80"></a><span class="todo TODO">TODO</span> 类型转换的二义性<br />
<div class="outline-text-6" id="text-3-1-19-5-2">
<p>
通常情况下，不要为类定义相同的类型转换，也不要在类中定义两个及两个以上转换源或转换目标是
算术类型的转换
</p>
</div>
</li>
<li><a id="org15d1392"></a><span class="todo TODO">TODO</span> 函数匹配与重载运算符<br /></li>
</ol>
</li>
</ol>
</div>
<div id="outline-container-org247768e" class="outline-4">
<h4 id="org247768e"><span class="section-number-4">3.1.20</span> 15章 面向对象程序设计</h4>
<div class="outline-text-4" id="text-3-1-20">
<ul class="org-ul">
<li>面向对象设计将类通过继承联系在一起构成一种层次关系，其中在层次关系根部的叫基类，其他类
则直接或间接从基类继承而来，这些继承的类称为派生类。</li>
<li>派生类通过类派生列表来指出它继承自哪些类，派生列表形式为：</li>
</ul>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #0000FF;">class</span> <span style="color: #6434A3;">A</span> : <span style="color: #0000FF;">public</span> <span style="color: #6434A3;">B</span>, <span style="color: #0000FF;">protected</span> <span style="color: #6434A3;">C</span>, <span style="color: #0000FF;">private</span> <span style="color: #6434A3;">D</span> <span style="color: #707183;">{</span>

<span style="color: #707183;">}</span>;
</pre>
</div>
<ul class="org-ul">
<li>基类如果希望派生类重新定义(覆盖)其成语函数，必须用virtual将该函数声明为虚函数，如果派生类
想要对这个函数重新定义自己的版本的话，派生类必须在其内部对该虚函数进行声明，否则，派生类将
直接继承该基类对该函数的定义(隐式保留虚函数属性)。</li>
<li>虚函数和普通函数的最大区别是：当我们使用指针或引用调用虚函数时，虚函数需要在运行时才能选择函数的
版本，这种行为也叫动态绑定。如果成语函数不是虚函数，或者调用虚函数时使用的不是指针或引用，那么
函数的类型绑定将在编译器完成。</li>
<li>所有虚函数都都必须有定义，不管我们会不会使用这个虚函数，这点也和普通函数不同，这是因为编译器
也不知道到底会使用哪个函数</li>
</ul>
</div>
<ol class="org-ol">
<li><a id="org98d508e"></a>类型转换与继承<br />
<div class="outline-text-5" id="text-3-1-20-1">
<ul class="org-ul">
<li>静态类型和动态类型
静态类型：声明时指定的类型，编译时确定
动态类型：内存中实际对象的类型，运行时才能确定
如果一个表达式不是引用也不是指针，那它的静态和动态类型永远一致
<b>引用或指针的静态类型与动态类型不同这一事实正是c++语言支持多态性的根本所在</b></li>
<li>智能指针类也支持派生类向基类的类型转换，这意味着我们可以将一个派生类对象的指针存储在一个基
类的智能指针内</li>
<li><p>
要理解在具有继承关系的类之间的类型转换，三点非常重要：
</p></li>
</ul>


<div id="org584ba52" class="figure">
<p><img src="reading/2020-11-07_14-41-13_screenshot.png" alt="2020-11-07_14-41-13_screenshot.png" />
</p>
</div>
</div>
</li>

<li><a id="org8a6fecc"></a>虚函数<br />
<div class="outline-text-5" id="text-3-1-20-2">
<ul class="org-ul">
<li>覆盖
<ol class="org-ol">
<li>一个派生类的函数要覆盖某个继承来的虚函数，那么它的形参类型必须与被它覆盖的基类函数
完全一致</li>
<li>c++11可以使用override关键字来说明派生类的虚函数，这使得程序员的意图更加清晰。因为
如果程序员本来想覆盖父类虚函数但是参数写错了，就会导致程序偏离意图。这时如果加上override
编译器就会报错。</li>
</ol></li>
<li>虚函数默认实参
如果虚函数使用了默认实参，则基类和派生类中定义的默认实参最好一致，因为如果
函数调用使用了默认实参，则实参由本次调用的静态类型决定,也就是说如果静态类型是基类的，
就算调用动态绑定到了继承类定义的函数，实参值还是基类的。</li>
<li><p>
可以使用作用域运算符来回避虚函数机制
派生类重新定义继承来的虚函数时，可能需要调用基类的虚函数版本，这就需要回避虚函数机制，不然
会导致派生类虚函数自己调用自己而无限循环：
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #6434A3;">double</span> <span style="color: #BA36A5;">undisconted</span> = baseP-&gt;<span style="color: #D0372D;">Quote</span>::net_price<span style="color: #707183;">(</span><span style="color: #D0372D;">42</span><span style="color: #707183;">)</span>;
</pre>
</div></li>
</ul>
</div>
</li>

<li><a id="org359937b"></a>抽象基类<br />
<div class="outline-text-5" id="text-3-1-20-3">
<ul class="org-ul">
<li>在函数体的位置写 <i>=0</i> 就可以将虚函数说明为纯虚函数，我们不能在类的内部为一个纯虚函数提供
结构体</li>
<li><p>
含有（或未经覆盖直接继承）纯虚函数的类是抽象基类。不能直接创建一个抽象基类的对象
如下面的例子：
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">Type your code here, or load an example.</span>
<span style="color: #808080;">#include</span> <span style="color: #707183;">&lt;</span><span style="color: #008000;">memory</span><span style="color: #707183;">&gt;</span>
<span style="color: #0000FF;">using</span> <span style="color: #0000FF;">namespace</span> <span style="color: #D0372D;">std</span>;
<span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">A</span><span style="color: #707183;">{</span>
  <span style="color: #8D8D84;">//</span><span style="color: #8D8D84; font-style: italic;">A(A &amp;fk) { a = fk.a;}</span>
  <span style="color: #0000FF;">virtual</span> <span style="color: #6434A3;">int</span> <span style="color: #006699;">foo</span><span style="color: #7388D6;">()</span> = <span style="color: #D0372D;">0</span>;
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">a</span>;   
<span style="color: #707183;">}</span>;
<span style="color: #6434A3;">int</span> <span style="color: #D0372D;">A</span>::<span style="color: #006699;">foo</span><span style="color: #707183;">()</span> <span style="color: #707183;">{</span><span style="color: #0000FF;">return</span> <span style="color: #D0372D;">0</span>;<span style="color: #707183;">}</span>

<span style="color: #0000FF;">class</span> <span style="color: #6434A3;">B</span> : <span style="color: #0000FF;">public</span> <span style="color: #6434A3;">A</span> <span style="color: #707183;">{</span>

<span style="color: #707183;">}</span>;
<span style="color: #6434A3;">int</span> <span style="color: #006699;">main</span><span style="color: #707183;">()</span> <span style="color: #707183;">{</span>
  <span style="color: #6434A3;">B</span>  <span style="color: #BA36A5;">aa</span>;
  <span style="color: #0000FF;">return</span> <span style="color: #D0372D;">0</span>;
<span style="color: #707183;">}</span>
</pre>
</div>
<p>
虽然A的foo已经在类外定义好了，但是倒数第三行的B aa这个代码还是报错：
error: cannot declare variable 'aa' to be of abstract type 'B'
</p></li>
</ul>
</div>
</li>
<li><a id="org9e68645"></a>访问控制<br />
<div class="outline-text-5" id="text-3-1-20-4">
<ul class="org-ul">
<li><p>
每个类都负责控制自己的成员的访问权限：
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">public</th>
<th scope="col" class="org-left">protected</th>
<th scope="col" class="org-left">private</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">用户</td>
<td class="org-left">☑️</td>
<td class="org-left">️</td>
<td class="org-left">️</td>
</tr>

<tr>
<td class="org-left">派生类</td>
<td class="org-left">☑️</td>
<td class="org-left">☑️</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">友元</td>
<td class="org-left">☑️</td>
<td class="org-left">☑️</td>
<td class="org-left">☑️</td>
</tr>
</tbody>
</table></li>
<li><p>
派生类通过派生访问说明符来控制它的成员访问权限，派生访问说明符对于派生类的成员（及友元）
能否访问其直接基类的成员没有任何影响，其目的只是控制该派生类的用户（包括派生类的派生类）
对该派生类的访问权限，其规则是：
</p>
<ol class="org-ol">
<li>如果继承是公有的，则派生类成员的访问权限直接继承基类的权限说明</li>
<li>如果是protected继承，则基类中的public成员都会被声明成protected</li>
<li>如果是private继承，则所有成员都变成private的</li>
</ol>
<p>
如：
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #808080;">#include</span> <span style="color: #707183;">&lt;</span><span style="color: #008000;">memory</span><span style="color: #707183;">&gt;</span>
<span style="color: #0000FF;">using</span> <span style="color: #0000FF;">namespace</span> <span style="color: #D0372D;">std</span>;
<span style="color: #0000FF;">class</span> <span style="color: #6434A3;">B</span> <span style="color: #707183;">{</span>
<span style="color: #0000FF;">private</span>:
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">pri_mem</span>;
<span style="color: #0000FF;">protected</span>:
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">prot_mem</span>;
<span style="color: #707183;">}</span>;

<span style="color: #0000FF;">class</span> <span style="color: #6434A3;">S</span> : <span style="color: #0000FF;">private</span> <span style="color: #6434A3;">B</span> <span style="color: #707183;">{</span>
  <span style="color: #0000FF;">friend</span> <span style="color: #6434A3;">void</span> <span style="color: #006699;">c</span><span style="color: #7388D6;">(</span><span style="color: #6434A3;">S</span>&amp;<span style="color: #7388D6;">)</span>;
  <span style="color: #0000FF;">friend</span> <span style="color: #6434A3;">void</span> <span style="color: #006699;">c</span><span style="color: #7388D6;">(</span><span style="color: #6434A3;">B</span>&amp;<span style="color: #7388D6;">)</span>;
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">j</span>;

  <span style="color: #6434A3;">int</span> <span style="color: #006699;">f1</span><span style="color: #7388D6;">()</span> <span style="color: #0000FF;">const</span> <span style="color: #7388D6;">{</span><span style="color: #0000FF;">return</span> prot_mem;<span style="color: #7388D6;">}</span> <span style="color: #8D8D84;">//</span><span style="color: #8D8D84; font-style: italic;">&#19981;&#25253;&#38169;</span>
<span style="color: #707183;">}</span>;

<span style="color: #0000FF;">class</span> <span style="color: #6434A3;">G</span> : <span style="color: #0000FF;">public</span> <span style="color: #6434A3;">S</span> <span style="color: #707183;">{</span>
  <span style="color: #6434A3;">int</span> <span style="color: #006699;">g</span><span style="color: #7388D6;">()</span> <span style="color: #7388D6;">{</span><span style="color: #0000FF;">return</span> prot_mem;<span style="color: #7388D6;">}</span>  <span style="color: #8D8D84;">//</span><span style="color: #8D8D84; font-style: italic;">&#25253;&#38169;</span>
  <span style="color: #6434A3;">int</span> <span style="color: #006699;">g1</span><span style="color: #7388D6;">()</span> <span style="color: #7388D6;">{</span><span style="color: #0000FF;">return</span> pri_mem;<span style="color: #7388D6;">}</span>  <span style="color: #8D8D84;">//</span><span style="color: #8D8D84; font-style: italic;">&#25253;&#38169;&#65292;</span>
<span style="color: #707183;">}</span>;

<span style="color: #6434A3;">void</span> <span style="color: #006699;">c</span><span style="color: #707183;">(</span><span style="color: #6434A3;">S</span> &amp;<span style="color: #BA36A5;">s</span><span style="color: #707183;">)</span> <span style="color: #707183;">{</span>
  s.j = s.prot_mem = <span style="color: #D0372D;">0</span>; <span style="color: #8D8D84;">//</span><span style="color: #8D8D84; font-style: italic;">&#19981;&#25253;&#38169;</span>
<span style="color: #707183;">}</span>

<span style="color: #6434A3;">int</span> <span style="color: #006699;">main</span><span style="color: #707183;">()</span> <span style="color: #707183;">{</span>

  <span style="color: #0000FF;">return</span> <span style="color: #D0372D;">0</span>;
<span style="color: #707183;">}</span>
</pre>
</div>
<p>
虽然S的派生访问符是private，但是c函数和f1函数能访问B的成员；而g和g1函数报错，
这个例子证明的上面的说法
</p></li>
<li>派生类向基类转换的可访问性
如果基类的公有成员是可访问的，则派生类向基类的类型转换也是可访问的</li>
<li>友元关系不能继承</li>
<li><p>
派生类可以为那些它可以访问的名字通过using声明来改变可访问性:
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #0000FF;">class</span> <span style="color: #6434A3;">Base</span> <span style="color: #707183;">{</span>
<span style="color: #0000FF;">public</span>:
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">pub</span>;
<span style="color: #0000FF;">protected</span>:
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">pro</span>;
<span style="color: #0000FF;">private</span>:
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">pri</span>;
<span style="color: #707183;">}</span>;

<span style="color: #0000FF;">class</span> <span style="color: #6434A3;">D</span> : <span style="color: #0000FF;">private</span> <span style="color: #6434A3;">Base</span> <span style="color: #707183;">{</span>
  <span style="color: #0000FF;">using</span> <span style="color: #D0372D;">Base</span>::<span style="color: #6434A3;">pub</span>;
  <span style="color: #0000FF;">using</span> <span style="color: #D0372D;">Base</span>::<span style="color: #6434A3;">pro</span>;
  <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">&#38169;&#65292;D&#19981;&#33021;&#35775;&#38382;pri&#65292;&#25152;&#20197;&#19981;&#33021;&#29992;using</span>
  <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">using Base::pri;</span>
<span style="color: #707183;">}</span>
</pre>
</div></li>
</ul>
</div>
</li>
<li><a id="org9203153"></a>继承中的类作用域<br />
<div class="outline-text-5" id="text-3-1-20-5">
<ul class="org-ul">
<li>派生类的作用域是嵌套在其基类的作用域之内的。</li>
<li>一个对象、引用或指针的静态类型决定了该对象的哪些成员是可见的，即使静态类型和动态类型
不一致，也就是说，如果一个对、引用、指针象的静态类型是基类的类型，那么它就不能访问
基类没有定义的成员，就是继承类定义了这个成员</li>
<li>派生类的成员将隐藏基类的成员，即使基类成员函数的参数列表和派生类不一样，因为名字查找优先于
类型检查，这也说明了为什么基类和派生类的虚函数必须有相同的形参列表，因为如果不这样，基类
的虚函数就会被 <b>隐藏</b> 而不是 <b>覆盖</b></li>
<li>TODO 隐藏、覆盖、重写
虚函数也可以被重写</li>
</ul>
</div>
</li>
<li><a id="orgeb44d9e"></a>TODO(深入对象模型重点理解) 构造函数与拷贝控制的继承<br /></li>
</ol>
</div>

<div id="outline-container-orgde06605" class="outline-4">
<h4 id="orgde06605"><span class="section-number-4">3.1.21</span> 16章 模版与泛型编程</h4>
<div class="outline-text-4" id="text-3-1-21">
<p>
泛型编程与面向对象编程一样，也能处理在编写程序时不知道类型的情况。
不同之处在于：OOP能处理类型在程序运行之前都是未知的情况；
而泛型编程中，在编译时就能获知类型了。 而模版是c++中泛型编程的基础。
</p>
</div>
<ol class="org-ol">
<li><a id="orgf1b2a5a"></a>函数模版<br />
<div class="outline-text-5" id="text-3-1-21-1">
<ul class="org-ul">
<li><p>
定义模版
模版定义以关键字template开始，后跟一个用 <b>&lt;&gt;</b> 包围起来的模版参数列表,
参数列表中的参数分为 <b>类型模版参数</b> 和 <b>非类型模版参数</b> ， <b>每个</b> 类型参数前必须使用关键字
class或typename, class和typename没有什么区别，只是c++早期只有class关键字，其实typename
更加直观：
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #8D8D84;">//</span><span style="color: #8D8D84; font-style: italic;">&#31867;&#22411;&#27169;&#29256;&#21442;&#25968;</span>
<span style="color: #0000FF;">template</span> <span style="color: #707183;">&lt;</span><span style="color: #0000FF;">typename</span> <span style="color: #6434A3;">T</span><span style="color: #707183;">&gt;</span>
<span style="color: #6434A3;">int</span> <span style="color: #006699;">compare</span><span style="color: #707183;">(</span><span style="color: #0000FF;">const</span> <span style="color: #6434A3;">T</span> &amp;<span style="color: #BA36A5;">v1</span>, <span style="color: #0000FF;">const</span> <span style="color: #6434A3;">T</span> &amp;<span style="color: #BA36A5;">v2</span><span style="color: #707183;">)</span>
<span style="color: #707183;">{</span>
  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>v1 &lt; v2<span style="color: #7388D6;">)</span> <span style="color: #0000FF;">return</span> -<span style="color: #D0372D;">1</span>;
  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>v2 &lt; v1<span style="color: #7388D6;">)</span> <span style="color: #0000FF;">return</span> <span style="color: #D0372D;">1</span>;
  <span style="color: #0000FF;">return</span> <span style="color: #D0372D;">0</span>;
<span style="color: #707183;">}</span>

<span style="color: #8D8D84;">//</span><span style="color: #8D8D84; font-style: italic;">&#38750;&#31867;&#22411;&#27169;&#29256;&#21442;&#25968;</span>
<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#38750;&#21442;&#25968;&#31867;&#22411;&#21487;&#20197;&#26159;&#19968;&#20010;&#25972;&#25968;&#65292;&#25110;&#32773;&#26159;&#19968;&#20010;&#25351;&#21521;&#23545;&#35937;&#25110;&#20989;&#25968;&#31867;&#22411;&#30340;&#25351;&#38024;&#25110;&#24341;&#29992;</span>
<span style="color: #8D8D84; font-style: italic;"> * &#32780;&#19988;&#65292;&#32465;&#23450;&#21040;&#25972;&#25968;&#30340;&#24517;&#39035;&#26159;&#24120;&#37327;&#34920;&#36798;&#24335;&#65292;&#32465;&#23450;&#21040;&#25351;&#38024;&#25110;&#24341;&#29992;&#31867;&#22411;&#30340;&#24517;&#39035;&#20855;&#26377;</span>
<span style="color: #8D8D84; font-style: italic;"> * &#38745;&#24577;&#29983;&#23384;&#26399;</span>
<span style="color: #8D8D84; font-style: italic;">*</span><span style="color: #8D8D84;">*/</span>
<span style="color: #0000FF;">template</span><span style="color: #707183;">&lt;</span><span style="color: #6434A3;">unsigned</span> <span style="color: #BA36A5;">N</span>, <span style="color: #6434A3;">unsigned</span> <span style="color: #BA36A5;">M</span><span style="color: #707183;">&gt;</span>
<span style="color: #6434A3;">int</span> <span style="color: #006699;">compare</span><span style="color: #707183;">(</span><span style="color: #0000FF;">const</span> <span style="color: #6434A3;">char</span> <span style="color: #7388D6;">(</span>&amp;<span style="color: #BA36A5;">p1</span><span style="color: #7388D6;">)[</span>N<span style="color: #7388D6;">]</span>, <span style="color: #0000FF;">const</span> <span style="color: #6434A3;">char</span> <span style="color: #7388D6;">(</span>&amp;<span style="color: #BA36A5;">p2</span><span style="color: #7388D6;">)[</span>M<span style="color: #7388D6;">]</span><span style="color: #707183;">)</span>
<span style="color: #707183;">{</span>
  <span style="color: #0000FF;">return</span> strcmp<span style="color: #7388D6;">(</span>p1, p2<span style="color: #7388D6;">)</span>;
<span style="color: #707183;">}</span>
</pre>
</div>

<p>
从上面代码可以说明编写泛型代码的两个重要原则：
</p>
<ol class="org-ol">
<li>模版中的函数参数是const的引用，这样保证函数可以用于不能拷贝的类型</li>
<li>函数体条件判断仅使用 <b>&lt;</b> 比较运算符</li>
</ol>
<p>
也就是说，模版程序应该尽可能减少对实参的要求
</p></li>

<li>实例化模版与头文件
编译器不会直接为模版定义生成代码，只有当我们调用一个函数模版时，编译器才用函数实参
来为我们推断模版实参并生成一个模版的实例代码，这个过程叫实例化。
通常，当我们调用一个函数时，编译器只需要掌握函数的声明；当我们使用一个类类型的对象时
，类定义必须是可用的，但成员函数的定义不必已经出现；这是因为编译器编译过程中，只需要
知道对象的名字就可以了(具体定义由连接器负责)，函数只要声明了就可以知道它的名字，而类
必须要有了定义才能知道它的成员的名字。
模版则不同，为了生成一个实例化的版本代码，编译器需要掌握函数模版或类模版成员函数的定义。
这些区别也导致了与头文件相关的一些不同：
<ol class="org-ol">
<li>我们将类定义和函数声明放在头文件中，而普通函数和类的成员函数的定义放在源文件中</li>
<li>与非模版代码不同，模版的头文件通常即包含声明也包含定义(因为编译器需要)</li>
</ol></li>
</ul>
</div>
</li>

<li><a id="orge9c9032"></a>类模版<br />
<div class="outline-text-5" id="text-3-1-21-2">
<ul class="org-ul">
<li>定义
类模版是用来指导编译器生成类的。一个类模版的每个实例都形成一个独立的类
与函数模版不同，编译器不能为类模版推断模版参数类型
定义在类模版内的成员函数被隐式声明为内联函数</li>
<li>实例化
一个实例化了的类模版，其成员只有在使用时才被实例化。
在一个类模版的作用域内，我们可以直接使用模版名而不必指定模版实参</li>
<li>TODO 模版与友元</li>
<li><p>
模版类作用域运算符
当编译器遇到类似T::mem这样的代码时，它不会知道meme是一个类型成员还是一个static数据成员
，直到实例化才会直到。比如编译器遇到如下形式的语句：
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #D0372D;">T</span>::<span style="color: #6434A3;">size_type</span> * <span style="color: #BA36A5;">p</span>;
</pre>
</div>
<p>
它需要知道我们是正在定义一个名为p的变量还是将一个名为size<sub>type的static数据成员与名</sub>
为p的变量相乘。默认情况下，c++假定通过作用域运算符访问的名字不是类型，所以如果我们希望
使用一个模版类型参数的类型成员，必须用typename关键字显示告诉编译器该名称是一个类型:
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #0000FF;">typename</span> <span style="color: #D0372D;">T</span>::<span style="color: #6434A3;">size_type</span> * <span style="color: #BA36A5;">p</span>;
</pre>
</div>
<p>
这样才表示我们正在定义一个名为p的T::size<sub>type</sub> * 类型的变量
</p></li>
</ul>
</div>
</li>

<li><a id="org34b0ba4"></a>成员模版<br />
<div class="outline-text-5" id="text-3-1-21-3">
<p>
一个类（无论是普通类还是类模版）可以包含本身是模版的成员函数。这种成员被称为成员模版。
<b>成员模版不能是虚函数</b> ,类模版和成员模版各自有各自独立的模版参数。
当我们在类模版外定义一个成员模版时,必须同时为类模版和成员模版提供模版参数列表。
类模版的参数列表在前，成员模版的参数列表在后。
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #0000FF;">template</span> <span style="color: #707183;">&lt;</span><span style="color: #0000FF;">typename</span> <span style="color: #6434A3;">T</span><span style="color: #707183;">&gt;</span>  <span style="color: #8D8D84;">//</span><span style="color: #8D8D84; font-style: italic;">&#31867;&#30340;&#31867;&#22411;&#21442;&#25968;</span>
<span style="color: #0000FF;">template</span> <span style="color: #707183;">&lt;</span><span style="color: #0000FF;">typename</span> <span style="color: #6434A3;">It</span><span style="color: #707183;">&gt;</span> <span style="color: #8D8D84;">//</span><span style="color: #8D8D84; font-style: italic;">&#26500;&#36896;&#20989;&#25968;&#30340;&#31867;&#22411;&#21442;&#25968;</span>
</pre>
</div>
</div>
</li>
<li><a id="org2dc6402"></a>控制实例化<br />
<div class="outline-text-5" id="text-3-1-21-4">
<p>
当两个或多个独立编译的源文件使用了相同的模版，并提供了相同的模版参数时，每个文件中就都会有该
模版的实例。在大系统中，这种额外开销可能非常严重。在c++11新标准中，我们可以通过显式实例化
来避免这种开销：
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #0000FF;">extern</span> <span style="color: #0000FF;">template</span> <span style="color: #6434A3;">declaration</span>;  <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">&#23454;&#20363;&#21270;&#22768;&#26126;</span>
<span style="color: #0000FF;">template</span> <span style="color: #6434A3;">declaration</span>;         <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">&#23454;&#20363;&#21270;&#23450;&#20041;</span>
</pre>
</div>
<p>
对于一个给定的实例化版本，可能有多个extern声明，但必须只有一个定义
</p>

<p>
一个类模版的实例化定义会实例化该模版的所有成员，包括内联的成员函数。因为当编译器遇到一个
实例化定义时，它不知道程序你用哪些成员函数。 所以，我们用来显式实例化一个类模版的类型，
必须能用于模版的所有成员
</p>
</div>
</li>
<li><a id="org863055f"></a>效率与灵活性<br />
<div class="outline-text-5" id="text-3-1-21-5">
<p>
通过编译时绑定删除器，unique<sub>ptr避免了间接调用删除器的运行时开销</sub>。通过在运行时绑定删除器，
shared<sub>ptr使用户重载删除器更方便</sub>，就是说模版可以在效率和灵活性之间做trade off。
</p>
</div>
</li>
<li><a id="orgd7772fd"></a>模版实参推断<br />
<div class="outline-text-5" id="text-3-1-21-6">
<p>
<b>有些特殊情况类型推导并不那么顺利：</b>
</p>
<ul class="org-ul">
<li>模版类型参数的类型转换
能应用于函数模版的类型转换只有两种：
<ol class="org-ol">
<li>const转换：将一个非const对象的引用或指针传递给一个const的引用形参</li>
<li><p>
(TODO:类型转换整理)数组或函数指针转换：
</p>

<div id="org14ec024" class="figure">
<p><img src="reading/2020-11-14_09-43-36_screenshot.png" alt="2020-11-14_09-43-36_screenshot.png" />
</p>
</div></li>
</ol></li>
<li><p>
使用相同模版参数类型
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">lng</span>;
compare<span style="color: #707183;">(</span>lng, <span style="color: #D0372D;">1024</span><span style="color: #707183;">)</span>;
</pre>
</div>
<p>
compare接受两个const T&amp;参数，所以上面的调用使错误的, 因为推断出来的long和int不是
同一类型，这种情况可以通过显示指定参数类型解决：
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">lng</span>;
compare<span style="color: #707183;">&lt;</span><span style="color: #6434A3;">long</span><span style="color: #707183;">&gt;(</span>lng, <span style="color: #D0372D;">1024</span><span style="color: #707183;">)</span>;
</pre>
</div>
<p>
上面的例子实例化为compare(long,long)
</p></li>
<li><p>
函数模版中可以有 用普通类型定义的参数
</p>

<div id="org038d8f6" class="figure">
<p><img src="reading/2020-11-14_09-52-56_screenshot.png" alt="2020-11-14_09-52-56_screenshot.png" />
</p>
</div></li>
<li><p>
显式实参
</p>

<div id="orgee7287b" class="figure">
<p><img src="reading/2020-11-14_10-07-55_screenshot.png" alt="2020-11-14_10-07-55_screenshot.png" />
</p>
</div>

<div id="org93d6269" class="figure">
<p><img src="reading/2020-11-14_10-08-14_screenshot.png" alt="2020-11-14_10-08-14_screenshot.png" />
</p>
</div></li>
<li><p>
尾置返回类型
当我们希望用户确定返回类型时：
</p>
<p>
<img src="reading/2020-11-14_10-21-00_screenshot.png" alt="2020-11-14_10-21-00_screenshot.png" />
由于编译器在遇到参数列表之前，beg是不存在的，所以我们必须使用尾置类型来定义此函数：
</p>

<div id="org0c372aa" class="figure">
<p><img src="reading/2020-11-14_10-23-17_screenshot.png" alt="2020-11-14_10-23-17_screenshot.png" /> 
</p>
</div></li>
<li><p>
用于进行类型转换的标准库模版类
</p>

<div id="org2a0bb96" class="figure">
<p><img src="reading/2020-11-14_10-26-27_screenshot.png" alt="2020-11-14_10-26-27_screenshot.png" />
</p>
</div></li>
<li>函数指针类型推导
当参数是一个函数模版实例的地址时，程序上下文必须满足：对每个模版参数都能唯一确定
其类型或值</li>
<li><p>
引用的推断
</p>
<ol class="org-ol">
<li>绑定到常量时引用的汇编层面
<ul class="org-ul">
<li><p>
const左值引用
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #6434A3;">int</span> <span style="color: #006699;">main</span><span style="color: #707183;">()</span> <span style="color: #707183;">{</span>
  <span style="color: #0000FF;">const</span> <span style="color: #6434A3;">int</span> &amp; <span style="color: #BA36A5;">a</span> = <span style="color: #D0372D;">10</span>;
  <span style="color: #0000FF;">return</span> <span style="color: #D0372D;">0</span>;
<span style="color: #707183;">}</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-asm">  <span style="color: #0000FF;">main</span>:
          <span style="color: #0000FF;">pushq</span>   <span style="color: #BA36A5;">%rbp</span>
          <span style="color: #0000FF;">movq</span>    <span style="color: #BA36A5;">%rsp</span>, <span style="color: #BA36A5;">%rbp</span>
          <span style="color: #0000FF;">movl</span>    $10, <span style="color: #BA36A5;">%eax</span>
          <span style="color: #0000FF;">movl</span>    <span style="color: #BA36A5;">%eax</span>, -12<span style="color: #707183;">(</span><span style="color: #BA36A5;">%rbp</span><span style="color: #707183;">)</span>
          <span style="color: #0000FF;">leaq</span>    -12<span style="color: #707183;">(</span><span style="color: #BA36A5;">%rbp</span><span style="color: #707183;">)</span>, <span style="color: #BA36A5;">%rax</span>
          <span style="color: #0000FF;">movq</span>    <span style="color: #BA36A5;">%rax</span>, -8<span style="color: #707183;">(</span><span style="color: #BA36A5;">%rbp</span><span style="color: #707183;">)</span>
          <span style="color: #0000FF;">movq</span>    -8<span style="color: #707183;">(</span><span style="color: #BA36A5;">%rbp</span><span style="color: #707183;">)</span>, <span style="color: #BA36A5;">%rax</span>
          <span style="color: #0000FF;">movl</span>    0, <span style="color: #BA36A5;">%eax</span>
          <span style="color: #0000FF;">popq</span>    <span style="color: #BA36A5;">%rbp</span>
          <span style="color: #0000FF;">ret</span>

<span style="color: #006699;">rbp</span>-----&gt; -----------

              <span style="color: #0000FF;">a</span>
<span style="color: #006699;">rbp-8</span>---&gt; -----------
              <span style="color: #0000FF;">10</span>
<span style="color: #006699;">rbp-12</span>--&gt; -----------
</pre>
</div></li>
<li><p>
右值引用
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #6434A3;">int</span> <span style="color: #006699;">main</span><span style="color: #707183;">()</span> <span style="color: #707183;">{</span>
  <span style="color: #6434A3;">int</span> &amp;&amp; <span style="color: #BA36A5;">a</span> = <span style="color: #D0372D;">10</span>;
  a = <span style="color: #D0372D;">11</span>;
  <span style="color: #0000FF;">return</span> <span style="color: #D0372D;">0</span>;
<span style="color: #707183;">}</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-asm"><span style="color: #006699;">main</span>:
        <span style="color: #0000FF;">pushq</span>   <span style="color: #BA36A5;">%rbp</span>
        <span style="color: #0000FF;">movq</span>    <span style="color: #BA36A5;">%rsp</span>, <span style="color: #BA36A5;">%rbp</span>
        <span style="color: #0000FF;">movl</span>    $10, <span style="color: #BA36A5;">%eax</span>
        <span style="color: #0000FF;">movl</span>    <span style="color: #BA36A5;">%eax</span>, -12<span style="color: #707183;">(</span><span style="color: #BA36A5;">%rbp</span><span style="color: #707183;">)</span>
        <span style="color: #0000FF;">leaq</span>    -12<span style="color: #707183;">(</span><span style="color: #BA36A5;">%rbp</span><span style="color: #707183;">)</span>, <span style="color: #BA36A5;">%rax</span>
        <span style="color: #0000FF;">movq</span>    <span style="color: #BA36A5;">%rax</span>, -8<span style="color: #707183;">(</span><span style="color: #BA36A5;">%rbp</span><span style="color: #707183;">)</span>
        <span style="color: #0000FF;">movq</span>    -8<span style="color: #707183;">(</span><span style="color: #BA36A5;">%rbp</span><span style="color: #707183;">)</span>, <span style="color: #BA36A5;">%rax</span>
        <span style="color: #0000FF;">movl</span>    $11, <span style="color: #707183;">(</span><span style="color: #BA36A5;">%rax</span><span style="color: #707183;">)</span>
        <span style="color: #0000FF;">movl</span>    $0, <span style="color: #BA36A5;">%eax</span>
        <span style="color: #0000FF;">popq</span>    <span style="color: #BA36A5;">%rbp</span>
        <span style="color: #0000FF;">ret</span>
</pre>
</div></li>
</ul></li>
</ol>
<p>
可以看到，绑定到常量时，无论左值引用和右值引用，编译出的代码都一样，编译器会把常量放到
引用所在定义域的一个位置。
TODO ： 为什么左值可以绑定到常量?
</p></li>
</ul>
</div>
</li>
<li><a id="orgfe40f87"></a>重载与模版<br />
<ol class="org-ol">
<li><a id="org67503b1"></a>函数匹配规则（209页）遇到模版时(615页)<br /></li>
</ol>
</li>
</ol>
</div>
</div>

<div id="outline-container-orge68d7ba" class="outline-3">
<h3 id="orge68d7ba"><span class="section-number-3">3.2</span> STL源码剖析 <a href="file:///Users/binbinyang/Documents/STL源码剖析.pdf">pdf</a></h3>
<div class="outline-text-3" id="text-3-2">
</div>
<div id="outline-container-org3528a0e" class="outline-4">
<h4 id="org3528a0e"><span class="section-number-4">3.2.1</span> 3 迭代器与traits编程技法</h4>
<div class="outline-text-4" id="text-3-2-1">
</div>
<ol class="org-ol">
<li><a id="org4e81fd0"></a>迭代器分类<br />
<div class="outline-text-5" id="text-3-2-1-1">

<div id="org2b345ca" class="figure">
<p><img src="reading/2020-11-28_17-55-49_screenshot.png" alt="2020-11-28_17-55-49_screenshot.png" />
</p>
</div>

<div id="org41488ad" class="figure">
<p><img src="reading/2020-11-28_17-57-29_screenshot.png" alt="2020-11-28_17-57-29_screenshot.png" />
</p>
</div>
</div>
</li>

<li><a id="org76d8ad6"></a>traits机制<br />
<div class="outline-text-5" id="text-3-2-1-2">
<p>
因为c++不是强类型语言，没有typeof之类的操作来获取类的类型，即使有个RTTI的
typeid也只能获得类型的别名，而不能用来声明变量。
针对上面的问题，SGI通过利用function template的参数类型推导来间接获取
泛型的类型。
</p>

<div id="orge7891fd" class="figure">
<p><img src="reading/2020-11-28_18-35-18_screenshot.png" alt="2020-11-28_18-35-18_screenshot.png" />
</p>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-org4abf022" class="outline-4">
<h4 id="org4abf022"><span class="section-number-4">3.2.2</span> 4 序列化容器</h4>
<div class="outline-text-4" id="text-3-2-2">
<p>
queue,stack,priority<sub>queue没有迭代器</sub>
</p>
</div>
</div>
<div id="outline-container-org758648d" class="outline-4">
<h4 id="org758648d"><span class="section-number-4">3.2.3</span> 5 关联式容器</h4>
<div class="outline-text-4" id="text-3-2-3">
</div>
<ol class="org-ol">
<li><a id="org030645e"></a>set<br />
<div class="outline-text-5" id="text-3-2-3-1">
<ol class="org-ol">
<li>不能通过set的迭代器改变set的元素，因为set元素的值关系到排序规则.
set&lt;T&gt;::iterator被定义为RB tree的const<sub>iterator</sub></li>
<li>操作之前的所有迭代器在操作完后依然有效(除了erase删除的)</li>
</ol>
</div>
</li>
<li><a id="org72359c8"></a>hashtable<br />
<div class="outline-text-5" id="text-3-2-3-2">
<ol class="org-ol">
<li>SGI的hashtable迭代器为forward<sub>iterator</sub><sub>tag迭代器</sub>，所以只能单向遍历
也没有逆向迭代器(rbegin()等)</li>
<li>hashtable重载因子为1,并且用链地址法来解决冲突</li>
</ol>
</div>
</li>
</ol>
</div>
<div id="outline-container-org9447e8a" class="outline-4">
<h4 id="org9447e8a"><span class="section-number-4">3.2.4</span> 6 算法</h4>
<div class="outline-text-4" id="text-3-2-4">
</div>
<ol class="org-ol">
<li><a id="org9e0129c"></a>numeric数值算法<br />
<div class="outline-text-5" id="text-3-2-4-1">
<div class="org-src-container">
<pre class="src src-C++"><span style="color: #808080;">#include</span> <span style="color: #707183;">&lt;</span><span style="color: #008000;">numeric</span><span style="color: #707183;">&gt;</span>
<span style="color: #808080;">#include</span> <span style="color: #707183;">&lt;</span><span style="color: #008000;">vector</span><span style="color: #707183;">&gt;</span>
<span style="color: #808080;">#include</span> <span style="color: #707183;">&lt;</span><span style="color: #008000;">functional</span><span style="color: #707183;">&gt;</span>
<span style="color: #808080;">#include</span> <span style="color: #707183;">&lt;</span><span style="color: #008000;">iostream</span><span style="color: #707183;">&gt;</span>
<span style="color: #808080;">#include</span> <span style="color: #707183;">&lt;</span><span style="color: #008000;">iterator</span><span style="color: #707183;">&gt;</span>
<span style="color: #0000FF;">using</span> <span style="color: #0000FF;">namespace</span> <span style="color: #D0372D;">std</span>;

<span style="color: #6434A3;">int</span> <span style="color: #006699;">main</span><span style="color: #707183;">()</span>
<span style="color: #707183;">{</span>
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">ia</span><span style="color: #7388D6;">[</span><span style="color: #D0372D;">5</span><span style="color: #7388D6;">]</span> = <span style="color: #7388D6;">{</span> <span style="color: #D0372D;">1</span>, <span style="color: #D0372D;">2</span>, <span style="color: #D0372D;">3</span>, <span style="color: #D0372D;">4</span>, <span style="color: #D0372D;">5</span><span style="color: #7388D6;">}</span>;
  <span style="color: #6434A3;">vector</span><span style="color: #7388D6;">&lt;</span><span style="color: #6434A3;">int</span><span style="color: #7388D6;">&gt;</span> <span style="color: #BA36A5;">iv</span><span style="color: #7388D6;">(</span>ia, ia+<span style="color: #D0372D;">5</span><span style="color: #7388D6;">)</span>;
  cout &lt;&lt; accumulate<span style="color: #7388D6;">(</span>iv.begin<span style="color: #909183;">()</span>, iv.end<span style="color: #909183;">()</span>, <span style="color: #D0372D;">0</span><span style="color: #7388D6;">)</span> &lt;&lt; endl;
  cout &lt;&lt; accumulate<span style="color: #7388D6;">(</span>iv.begin<span style="color: #909183;">()</span>, iv.end<span style="color: #909183;">()</span>, <span style="color: #D0372D;">0</span>, minus<span style="color: #909183;">&lt;</span><span style="color: #6434A3;">int</span><span style="color: #909183;">&gt;()</span><span style="color: #7388D6;">)</span> &lt;&lt; endl;

  <span style="color: #6434A3;">ostream_iterator</span><span style="color: #7388D6;">&lt;</span><span style="color: #6434A3;">int</span><span style="color: #7388D6;">&gt;</span> <span style="color: #BA36A5;">oit</span><span style="color: #7388D6;">(</span>cout, <span style="color: #008000;">" "</span><span style="color: #7388D6;">)</span>;

  partial_sum<span style="color: #7388D6;">(</span>iv.begin<span style="color: #909183;">()</span>, iv.end<span style="color: #909183;">()</span>, oit<span style="color: #7388D6;">)</span>;
  cout &lt;&lt; endl;
  partial_sum<span style="color: #7388D6;">(</span>iv.begin<span style="color: #909183;">()</span>, iv.end<span style="color: #909183;">()</span>, oit, minus<span style="color: #909183;">&lt;</span><span style="color: #6434A3;">int</span><span style="color: #909183;">&gt;()</span><span style="color: #7388D6;">)</span>;
  cout &lt;&lt; endl;

  adjacent_difference<span style="color: #7388D6;">(</span>iv.begin<span style="color: #909183;">()</span>, iv.end<span style="color: #909183;">()</span>, oit<span style="color: #7388D6;">)</span>;
  cout &lt;&lt; endl;
  adjacent_difference<span style="color: #7388D6;">(</span>iv.begin<span style="color: #909183;">()</span>, iv.end<span style="color: #909183;">()</span>, oit, plus<span style="color: #909183;">&lt;</span><span style="color: #6434A3;">int</span><span style="color: #909183;">&gt;()</span><span style="color: #7388D6;">)</span>;
  cout &lt;&lt; endl;

  <span style="color: #8D8D84;">//  </span><span style="color: #8D8D84; font-style: italic;">cout &lt;&lt; power(10, 3) &lt;&lt; endl;</span>
  <span style="color: #8D8D84;">//  </span><span style="color: #8D8D84; font-style: italic;">cout &lt;&lt; power(10, 3, plus&lt;int&gt;()) &lt;&lt; endl;</span>

<span style="color: #707183;">}</span>

</pre>
</div>
</div>
</li>

<li><a id="orgb624339"></a>基本算法<br />
<div class="outline-text-5" id="text-3-2-4-2">
<div class="org-src-container">
<pre class="src src-C++"><span style="color: #808080;">#include</span> <span style="color: #707183;">&lt;</span><span style="color: #008000;">algorithm</span><span style="color: #707183;">&gt;</span>
<span style="color: #808080;">#include</span> <span style="color: #707183;">&lt;</span><span style="color: #008000;">vector</span><span style="color: #707183;">&gt;</span>
<span style="color: #808080;">#include</span> <span style="color: #707183;">&lt;</span><span style="color: #008000;">functional</span><span style="color: #707183;">&gt;</span>
<span style="color: #808080;">#include</span> <span style="color: #707183;">&lt;</span><span style="color: #008000;">iostream</span><span style="color: #707183;">&gt;</span>
<span style="color: #808080;">#include</span> <span style="color: #707183;">&lt;</span><span style="color: #008000;">iterator</span><span style="color: #707183;">&gt;</span>
<span style="color: #808080;">#include</span> <span style="color: #707183;">&lt;</span><span style="color: #008000;">string</span><span style="color: #707183;">&gt;</span>
<span style="color: #0000FF;">using</span> <span style="color: #0000FF;">namespace</span> <span style="color: #D0372D;">std</span>;

<span style="color: #6434A3;">int</span> <span style="color: #006699;">main</span><span style="color: #707183;">()</span>
<span style="color: #707183;">{</span>
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">ia</span><span style="color: #7388D6;">[]</span> = <span style="color: #7388D6;">{</span> <span style="color: #D0372D;">1</span>, <span style="color: #D0372D;">2</span>, <span style="color: #D0372D;">3</span>, <span style="color: #D0372D;">4</span>, <span style="color: #D0372D;">5</span>, <span style="color: #D0372D;">6</span>, <span style="color: #D0372D;">7</span>, <span style="color: #D0372D;">8</span>, <span style="color: #D0372D;">9</span> <span style="color: #7388D6;">}</span>;
  <span style="color: #6434A3;">vector</span><span style="color: #7388D6;">&lt;</span><span style="color: #6434A3;">int</span><span style="color: #7388D6;">&gt;</span> <span style="color: #BA36A5;">iv1</span><span style="color: #7388D6;">(</span>ia, ia+<span style="color: #D0372D;">5</span><span style="color: #7388D6;">)</span>;
  iv1.push_back<span style="color: #7388D6;">(</span>-<span style="color: #D0372D;">1</span><span style="color: #7388D6;">)</span>;
  <span style="color: #6434A3;">vector</span><span style="color: #7388D6;">&lt;</span><span style="color: #6434A3;">int</span><span style="color: #7388D6;">&gt;</span> <span style="color: #BA36A5;">iv2</span><span style="color: #7388D6;">(</span>ia, ia+<span style="color: #D0372D;">9</span><span style="color: #7388D6;">)</span>;

  <span style="color: #6434A3;">ostream_iterator</span><span style="color: #7388D6;">&lt;</span><span style="color: #6434A3;">int</span><span style="color: #7388D6;">&gt;</span> <span style="color: #BA36A5;">oit</span><span style="color: #7388D6;">(</span>cout, <span style="color: #008000;">" "</span><span style="color: #7388D6;">)</span>;

  <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">&#21028;&#26029;&#20004;&#20010;&#21306;&#38388;&#30340;&#31532;&#19968;&#20010;&#21305;&#37197;&#28857;&#65292;&#36820;&#22238;&#19968;&#20010;&#30001;&#20004;&#20010;&#36845;&#20195;&#22120;&#32452;&#25104;&#30340;pair</span>
  <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">&#20854;&#20013;&#31532;&#19968;&#20010;&#36845;&#20195;&#22120;&#25351;&#21521;&#31532;&#19968;&#20010;&#21306;&#38388;&#30340;&#19981;&#21305;&#37197;&#28857;&#65292;</span>
  <span style="color: #8D8D84;">//    </span><span style="color: #8D8D84; font-style: italic;">&#31532;&#20108;&#20010;&#36845;&#20195;&#22120;&#25351;&#21521;&#31532;&#20108;&#20010;&#21306;&#38388;&#30340;&#19981;&#21305;&#37197;&#28857;</span>
  cout &lt;&lt; *<span style="color: #7388D6;">(</span>mismatch<span style="color: #909183;">(</span>iv1.begin<span style="color: #709870;">()</span>, iv1.end<span style="color: #709870;">()</span>, iv2.begin<span style="color: #709870;">()</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>.first &lt;&lt; endl;
  cout &lt;&lt; *<span style="color: #7388D6;">(</span>mismatch<span style="color: #909183;">(</span>iv1.begin<span style="color: #709870;">()</span>, iv1.end<span style="color: #709870;">()</span>, iv2.begin<span style="color: #709870;">()</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>.second &lt;&lt; endl;

  <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">equel</span>
  <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">&#22914;&#26524;&#20457;&#20010;&#24207;&#21015;&#22312;[first, last) &#21306;&#38388;&#20869;&#30456;&#31561;&#65292;equal&#36820;&#22238;true</span>
  cout &lt;&lt; equal<span style="color: #7388D6;">(</span>iv1.begin<span style="color: #909183;">()</span>, iv1.end<span style="color: #909183;">()</span>, iv2.begin<span style="color: #909183;">()</span><span style="color: #7388D6;">)</span> &lt;&lt; endl;
  cout &lt;&lt; equal<span style="color: #7388D6;">(</span>iv2.begin<span style="color: #909183;">()</span>, iv2.end<span style="color: #909183;">()</span>, iv1.begin<span style="color: #909183;">()</span><span style="color: #7388D6;">)</span> &lt;&lt; endl;
  cout &lt;&lt; equal<span style="color: #7388D6;">(</span>iv1.begin<span style="color: #909183;">()</span>, iv1.end<span style="color: #909183;">()</span>, &amp;ia<span style="color: #909183;">[</span><span style="color: #D0372D;">3</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span> &lt;&lt; endl;
  cout &lt;&lt; equal<span style="color: #7388D6;">(</span>iv1.begin<span style="color: #909183;">()</span>, iv1.end<span style="color: #909183;">()</span>, &amp;ia<span style="color: #909183;">[</span><span style="color: #D0372D;">3</span><span style="color: #909183;">]</span>, less<span style="color: #909183;">&lt;</span><span style="color: #6434A3;">int</span><span style="color: #909183;">&gt;()</span><span style="color: #7388D6;">)</span> &lt;&lt; endl;

  fill<span style="color: #7388D6;">(</span>iv1.begin<span style="color: #909183;">()</span>, iv1.end<span style="color: #909183;">()</span>, <span style="color: #D0372D;">9</span><span style="color: #7388D6;">)</span>;
  <span style="color: #0000FF;">for</span> <span style="color: #7388D6;">(</span><span style="color: #0000FF;">auto</span> <span style="color: #BA36A5;">e</span> : iv1<span style="color: #7388D6;">)</span> cout &lt;&lt; e &lt;&lt; <span style="color: #008000;">' '</span>;
  cout &lt;&lt; endl;

  fill_n<span style="color: #7388D6;">(</span>iv1.begin<span style="color: #909183;">()</span>, <span style="color: #D0372D;">3</span>, <span style="color: #D0372D;">7</span><span style="color: #7388D6;">)</span>;
  <span style="color: #0000FF;">for</span> <span style="color: #7388D6;">(</span><span style="color: #0000FF;">auto</span> <span style="color: #BA36A5;">e</span> : iv1<span style="color: #7388D6;">)</span> cout &lt;&lt; e &lt;&lt; <span style="color: #008000;">' '</span>;
  cout &lt;&lt; endl;

  <span style="color: #0000FF;">auto</span> <span style="color: #BA36A5;">it1</span> = iv1.begin<span style="color: #7388D6;">()</span>;
  <span style="color: #0000FF;">auto</span> <span style="color: #BA36A5;">it2</span> = it1;
  advance<span style="color: #7388D6;">(</span>it2, <span style="color: #D0372D;">3</span><span style="color: #7388D6;">)</span>;
  iter_swap<span style="color: #7388D6;">(</span>it1, it2<span style="color: #7388D6;">)</span>;
  <span style="color: #0000FF;">for</span> <span style="color: #7388D6;">(</span><span style="color: #0000FF;">auto</span> <span style="color: #BA36A5;">e</span> : iv1<span style="color: #7388D6;">)</span> cout &lt;&lt; e &lt;&lt; <span style="color: #008000;">' '</span>;
  cout &lt;&lt; endl;
  <span style="color: #0000FF;">for</span> <span style="color: #7388D6;">(</span><span style="color: #0000FF;">auto</span> <span style="color: #BA36A5;">e</span> : iv2<span style="color: #7388D6;">)</span> cout &lt;&lt; e &lt;&lt; <span style="color: #008000;">' '</span>;
  cout &lt;&lt; endl;

  swap<span style="color: #7388D6;">(</span>*iv1.begin<span style="color: #909183;">()</span>, *iv2.begin<span style="color: #909183;">()</span><span style="color: #7388D6;">)</span>;
  <span style="color: #0000FF;">for</span> <span style="color: #7388D6;">(</span><span style="color: #0000FF;">auto</span> <span style="color: #BA36A5;">e</span> : iv1<span style="color: #7388D6;">)</span> cout &lt;&lt; e &lt;&lt; <span style="color: #008000;">' '</span>;
  cout &lt;&lt; endl;
  <span style="color: #0000FF;">for</span> <span style="color: #7388D6;">(</span><span style="color: #0000FF;">auto</span> <span style="color: #BA36A5;">e</span> : iv2<span style="color: #7388D6;">)</span> cout &lt;&lt; e &lt;&lt; <span style="color: #008000;">' '</span>;
  cout &lt;&lt; endl;

  <span style="color: #6434A3;">string</span> <span style="color: #BA36A5;">s1</span><span style="color: #7388D6;">[]</span> = <span style="color: #7388D6;">{</span> <span style="color: #008000;">"abc"</span>, <span style="color: #008000;">"def"</span>, <span style="color: #008000;">"gh"</span><span style="color: #7388D6;">}</span>;
  <span style="color: #6434A3;">string</span> <span style="color: #BA36A5;">s2</span><span style="color: #7388D6;">[]</span> = <span style="color: #7388D6;">{</span> <span style="color: #008000;">"bc"</span>, <span style="color: #008000;">"adc"</span>, <span style="color: #008000;">"jungle"</span><span style="color: #7388D6;">}</span>;
  <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">&#20197;&#23383;&#20856;&#24207;&#23545;&#20004;&#20010;&#24207;&#21015;&#36827;&#34892;&#25490;&#24207;</span>
  cout &lt;&lt; lexicographical_compare<span style="color: #7388D6;">(</span>s1, s1+<span style="color: #D0372D;">2</span>, s2, s2+<span style="color: #D0372D;">2</span><span style="color: #7388D6;">)</span> &lt;&lt; endl;
  cout &lt;&lt; lexicographical_compare<span style="color: #7388D6;">(</span>s1, s1+<span style="color: #D0372D;">2</span>, s2, s2+<span style="color: #D0372D;">2</span>, greater<span style="color: #909183;">&lt;</span><span style="color: #6434A3;">string</span><span style="color: #909183;">&gt;()</span><span style="color: #7388D6;">)</span> &lt;&lt; endl;
<span style="color: #707183;">}</span>

</pre>
</div>
</div>
</li>
</ol>
</div>
<div id="outline-container-org9889574" class="outline-4">
<h4 id="org9889574"><span class="section-number-4">3.2.5</span> 7 仿函数</h4>
<div class="outline-text-4" id="text-3-2-5">
<p>
TODO 457页：两个问题还没搞清楚
</p>
</div>
</div>
</div>
<div id="outline-container-orge5d06a8" class="outline-3">
<h3 id="orge5d06a8"><span class="section-number-3">3.3</span> Effective Modern C++</h3>
<div class="outline-text-3" id="text-3-3">
</div>
<div id="outline-container-orgde18ce1" class="outline-4">
<h4 id="orgde18ce1"><span class="section-number-4">3.3.1</span> 绪论</h4>
<div class="outline-text-4" id="text-3-3-1">
</div>
<ol class="org-ol">
<li><a id="org2e35a39"></a>左值与右值<br />
<div class="outline-text-5" id="text-3-3-1-1">
<p>
检查能否取得表达式的地址。如果能取到，那么该表达式基本可以断定是左值；
如果不可以，则通常为右值。
</p>

<p>
根据上面的定义，表达式的型别与它是左值还是右值没有关系：
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #0000FF;">class</span> <span style="color: #6434A3;">A</span><span style="color: #707183;">{</span>
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">x</span> = <span style="color: #D0372D;">7</span>;
<span style="color: #707183;">}</span>;

<span style="color: #6434A3;">void</span> <span style="color: #006699;">foo</span><span style="color: #707183;">(</span><span style="color: #6434A3;">A</span> &amp;&amp;<span style="color: #BA36A5;">a</span><span style="color: #707183;">)</span> <span style="color: #707183;">{</span>
  <span style="color: #6434A3;">A</span> &amp;&amp;<span style="color: #BA36A5;">b</span> = A<span style="color: #7388D6;">()</span>; <span style="color: #8D8D84;">//</span><span style="color: #8D8D84; font-style: italic;">b&#26159;&#24038;&#20540;, &#24847;&#24605;&#26159;&#34429;&#28982;b&#24341;&#29992;&#30340;&#23545;&#35937;&#27809;&#26377;&#21517;&#23383;&#65292;</span>
  <span style="color: #8D8D84;">//</span><span style="color: #8D8D84; font-style: italic;">&#26159;&#20010;&#21491;&#20540;&#65292;&#20294;&#26159;b&#26159;&#26377;&#21517;&#23383;&#30340;&#65292;&#25152;&#20197;&#20182;&#26159;&#20010;</span>
  <span style="color: #8D8D84;">//</span><span style="color: #8D8D84; font-style: italic;">&#24038;&#20540;</span>
  <span style="color: #8D8D84;">//</span><span style="color: #8D8D84; font-style: italic;">&#21516;&#26679;&#30340;&#36947;&#29702;&#65292;a&#20063;&#26159;&#20010;&#24038;&#20540;</span>
  <span style="color: #6434A3;">A</span> <span style="color: #BA36A5;">c</span>;
  b = c;
  <span style="color: #8D8D84;">//</span><span style="color: #8D8D84; font-style: italic;">foo(b);</span>
<span style="color: #707183;">}</span>

</pre>
</div>
</div>
</li>
</ol>
</div>
<div id="outline-container-org614ea0f" class="outline-4">
<h4 id="org614ea0f"><span class="section-number-4">3.3.2</span> 类型推导</h4>
<div class="outline-text-4" id="text-3-3-2">
</div>
<ol class="org-ol">
<li><a id="org14819f4"></a>1 了解模版型别推导<br />
<div class="outline-text-5" id="text-3-3-2-1">
<p>
一个函数模版的声明和调用大致如下：
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #0000FF;">template</span><span style="color: #707183;">&lt;</span><span style="color: #0000FF;">typename</span> <span style="color: #6434A3;">T</span><span style="color: #707183;">&gt;</span>
<span style="color: #6434A3;">void</span> <span style="color: #006699;">f</span><span style="color: #707183;">(</span><span style="color: #6434A3;">ParamType</span> <span style="color: #BA36A5;">param</span><span style="color: #707183;">)</span>;

f<span style="color: #707183;">(</span>expr<span style="color: #707183;">)</span>;
</pre>
</div>
<p>
在编译期，编译器会通过expr推导两个型别：T和PrarmType。
这两个型别往往是不一样的，因为ParamType常常会包含一些修饰词，
如const或引用符。实际情况是，T的推导结果，不仅依赖于expr的
型别，还依赖于ParamType的形式。要分为三种不同情况来讨论：
</p>
</div>
<ol class="org-ol">
<li><a id="orgf87b98d"></a>1. ParamType是个指针或引用，但不是万能引用<br />
<div class="outline-text-6" id="text-3-3-2-1-1">
<p>
推导规则如下：
</p>
<ol class="org-ol">
<li>若expr具有引用型别，先将引用部分忽略</li>
<li>然后，对expr的型别和ParamType的型别执行模式匹配，来决定T的型别</li>
</ol>

<p>
例如，
</p>
<div class="org-src-container">
<pre class="src src-c++">&#25105;&#20204;&#30340;&#27169;&#24335;&#22914;&#19979;&#65306;
<span style="color: #0000FF;">template</span><span style="color: #707183;">&lt;</span><span style="color: #0000FF;">typename</span> <span style="color: #6434A3;">T</span><span style="color: #707183;">&gt;</span>
<span style="color: #6434A3;">void</span> f<span style="color: #707183;">(</span><span style="color: #6434A3;">T</span> &amp;<span style="color: #BA36A5;">param</span><span style="color: #707183;">)</span>;

<span style="color: #0000FF;">template</span><span style="color: #707183;">&lt;</span><span style="color: #0000FF;">typename</span> <span style="color: #6434A3;">T</span><span style="color: #707183;">&gt;</span>
<span style="color: #6434A3;">void</span> <span style="color: #006699;">f1</span><span style="color: #707183;">(</span><span style="color: #0000FF;">const</span> <span style="color: #6434A3;">T</span>&amp; <span style="color: #BA36A5;">param</span><span style="color: #707183;">)</span>;

<span style="color: #0000FF;">template</span><span style="color: #707183;">&lt;</span><span style="color: #0000FF;">typename</span> <span style="color: #6434A3;">T</span><span style="color: #707183;">&gt;</span>
<span style="color: #6434A3;">void</span> <span style="color: #006699;">f2</span><span style="color: #707183;">(</span><span style="color: #6434A3;">T</span> *<span style="color: #BA36A5;">param</span><span style="color: #707183;">)</span>;

&#21448;&#22768;&#26126;&#20102;&#19979;&#21015;&#21464;&#37327;&#65306;
<span style="color: #6434A3;">int</span> x = <span style="color: #D0372D;">27</span>;
<span style="color: #0000FF;">const</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">cx</span> = x;
<span style="color: #0000FF;">const</span> <span style="color: #6434A3;">int</span> &amp;<span style="color: #BA36A5;">rx</span> = x;
<span style="color: #0000FF;">const</span> <span style="color: #6434A3;">int</span> *<span style="color: #BA36A5;">px</span> = &amp;x;

&#37027;&#20040;&#19979;&#38754;&#30340;&#35843;&#29992;&#20013;&#65292;&#25512;&#23548;&#32467;&#26524;&#22914;&#19979;&#65306;
f<span style="color: #707183;">(</span>x<span style="color: #707183;">)</span>;      <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">T&#26159;int&#65292; param&#26159;int&amp;</span>
f<span style="color: #707183;">(</span>cx<span style="color: #707183;">)</span>;     <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">T&#26159;const int&#65292; param&#26159;const int&amp;</span>
f<span style="color: #707183;">(</span>rx<span style="color: #707183;">)</span>;     <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">T&#26159;const int&#65292; param&#26159;const int&amp;</span>

f1<span style="color: #707183;">(</span>x<span style="color: #707183;">)</span>;      <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">T&#26159;int&#65292; param&#26159;const int&amp;</span>
f1<span style="color: #707183;">(</span>cx<span style="color: #707183;">)</span>;     <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">T&#26159;int&#65292; param&#26159;const int&amp;</span>
f1<span style="color: #707183;">(</span>rx<span style="color: #707183;">)</span>;     <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">T&#26159;int&#65292; param&#26159;const int&amp;</span>

f2<span style="color: #707183;">(</span>&amp;x<span style="color: #707183;">)</span>;     <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">T&#26159;int&#65292; param&#26159;int*</span>
f2<span style="color: #707183;">(</span>px<span style="color: #707183;">)</span>;     <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">T&#26159;const int&#65292; param&#26159;const int*</span>
</pre>
</div>
</div>
</li>
<li><a id="org0c8efa6"></a>2. ParamType是个万能引用<br />
<div class="outline-text-6" id="text-3-3-2-1-2">
<p>
推导规则如下：
</p>
<ol class="org-ol">
<li>如果expr是个左值，T和ParamType都会被推导为左值引用。
这是T被推导为引用的唯一情形，而且尽管语法是右值引用的，
但结果却是左值引用。</li>
<li>如果expr是个右值，则应用“情况1”中的规则</li>
</ol>
<p>
例子：
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #0000FF;">template</span><span style="color: #707183;">&lt;</span><span style="color: #0000FF;">typename</span> <span style="color: #6434A3;">T</span><span style="color: #707183;">&gt;</span>
<span style="color: #6434A3;">void</span> <span style="color: #006699;">f</span><span style="color: #707183;">(</span><span style="color: #6434A3;">T</span> &amp;&amp;<span style="color: #BA36A5;">param</span><span style="color: #707183;">)</span>;      <span style="color: #8D8D84;">//</span><span style="color: #8D8D84; font-style: italic;">param&#29616;&#22312;&#26159;&#20010;&#19975;&#33021;&#24341;&#29992;</span>

<span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">x</span> = <span style="color: #D0372D;">27</span>;
<span style="color: #0000FF;">const</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">cx</span> = x;
<span style="color: #0000FF;">const</span> <span style="color: #6434A3;">int</span> &amp;<span style="color: #BA36A5;">rx</span> = x;

f<span style="color: #707183;">(</span>x<span style="color: #707183;">)</span>;                  <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">x&#26159;&#20010;&#24038;&#20540;&#65292;&#25152;&#20197;T&#20026;int&amp;&#65292;param&#20026;int&amp;</span>
f<span style="color: #707183;">(</span>cx<span style="color: #707183;">)</span>;                 <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">cx&#26159;&#20010;&#24038;&#20540;&#65292;&#25152;&#20197;T&#20026;const int&amp;&#65292;param&#20063;&#20026;const int&amp;</span>
f<span style="color: #707183;">(</span>rx<span style="color: #707183;">)</span>;                 <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">rx&#26159;&#20010;&#24038;&#20540;&#65292;&#25152;&#20197;T&#20026;const int&amp;&#65292;param&#20063;&#20026;const int&amp;</span>
f<span style="color: #707183;">(</span><span style="color: #D0372D;">27</span><span style="color: #707183;">)</span>;                 <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">27&#26159;&#20010;&#21491;&#20540;&#65292;&#25152;&#20197;T&#20026;int&#65292;param&#20026;int&amp;&amp;</span>
</pre>
</div>
</div>
</li>
<li><a id="org696a5f0"></a>3. ParamType既非指针也非引用<br />
<div class="outline-text-6" id="text-3-3-2-1-3">
<p>
这种情况下，param会是个全新的对象，而且是expr的副本，所以推导规则为：
</p>
<ol class="org-ol">
<li>如果expr具有引用型别，则忽略其引用部分</li>
<li>忽略expr的引用性之后，若expr是个const对象，也忽略它，这是因为
现在是值传递，不像情形1是个引用传递。所以expr是const，并不表
示param也要是一个const。他们是独立的。
如果expr是个volatile对象，也忽略它。</li>
</ol>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #0000FF;">template</span><span style="color: #707183;">&lt;</span><span style="color: #0000FF;">typename</span> <span style="color: #6434A3;">T</span><span style="color: #707183;">&gt;</span>
<span style="color: #6434A3;">void</span> <span style="color: #006699;">f</span><span style="color: #707183;">(</span><span style="color: #6434A3;">T</span> <span style="color: #BA36A5;">param</span><span style="color: #707183;">)</span>;

<span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">x</span> = <span style="color: #D0372D;">27</span>;
<span style="color: #0000FF;">const</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">cx</span> = x;
<span style="color: #0000FF;">const</span> <span style="color: #6434A3;">int</span> &amp;<span style="color: #BA36A5;">rx</span> = x;
<span style="color: #0000FF;">const</span> <span style="color: #6434A3;">char</span> *<span style="color: #0000FF;">const</span> <span style="color: #BA36A5;">ptr</span> = <span style="color: #008000;">"Fun with pointers"</span>;

f<span style="color: #707183;">(</span>x<span style="color: #707183;">)</span>;               <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">T&#21644;param&#30340;&#31867;&#22411;&#37117;&#26159;int</span>
f<span style="color: #707183;">(</span>cx<span style="color: #707183;">)</span>;              <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">T&#21644;param&#30340;&#22411;&#21035;&#20173;&#37117;&#26159;int</span>
f<span style="color: #707183;">(</span>rx<span style="color: #707183;">)</span>;              <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">&#21516;&#19978;</span>
f<span style="color: #707183;">(</span>ptr<span style="color: #707183;">)</span>;             <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">T&#21644;param&#20026;const char *&#65292;</span>
</pre>
</div>
<ol class="org-ol">
<li>有两个特殊情况需要考虑：数组或函数型别的实参会退化成对应的指针，
除非它们被用来初始化引用。
TODO : 例子p22</li>
</ol>
</div>
</li>
</ol>
</li>
<li><a id="org6577ce5"></a>2 理解auto型别推导<br />
<div class="outline-text-5" id="text-3-3-2-2">
<ol class="org-ol">
<li>一般情况下，auto型别推导和模版型别推导是一模一样的，但是
auto型别推导会假定用大括号括起来的初始化表达式代表一个
std::initializer<sub>list,但模板型别推导不会</sub>。
<b>当某变量采用auto来声明时，auto就扮演了T的角色，而变量的型别
修饰词扮演了ParamType的角色。</b></li>
<li>在参数返回值或lambda式的形参中使用auto，意思是使用模板型别推导
而不是auto。</li>
</ol>
</div>
</li>
<li><a id="org546a434"></a>3 理解decltype<br /></li>
<li><a id="org816be60"></a>14 TODO throw 的汇编层实现<br /></li>
</ol>
</div>
</div>
<div id="outline-container-orgfa61ad3" class="outline-3">
<h3 id="orgfa61ad3"><span class="section-number-3">3.4</span> 深度探索C++对象模型</h3>
<div class="outline-text-3" id="text-3-4">
</div>
<div id="outline-container-org167bc80" class="outline-4">
<h4 id="org167bc80"><span class="section-number-4">3.4.1</span> 第一章 关于对象</h4>
<div class="outline-text-4" id="text-3-4-1">
</div>
<ol class="org-ol">
<li><a id="org9d76f45"></a>C++相比C的布局及存取时间上的主要额外负担<br />
<div class="outline-text-5" id="text-3-4-1-1">
<p>
主要包括两个点：
</p>
<ol class="org-ol">
<li>virtual function机制</li>
<li>virtual class</li>
</ol>
<p>
此外还有一些
</p>
<ol class="org-ol">
<li>多重继承下的额外负担
发生在“一个derived class和其第二或后继的base class之间的转换”</li>
</ol>
</div>
</li>
<li><a id="orgb85a130"></a>C++对象模型<br />
<div class="outline-text-5" id="text-3-4-1-2">
<p>
Stroustrup当初设计的（目前仍然是主流）的C++对象模型可以看作是 <b>简单对象模型</b>
和 <b>表格驱动对象模型</b> 的结合:
在此模型中，Nonstatic data members被配置于每一个class object之内，
static data members，static及nonstatic function members则
被存放在个别的class object之外。
</p>

<p>
<b>virtual function</b> 则以两个步骤支持：
</p>
<ol class="org-ol">
<li>每一个class产生出一堆指向virtual functions的指针，放在表格之中。
这个表格被成为virtual table（ <b>vtbl</b> ）。</li>
<li>每一个class object被安插一个指针，指向相关的virtual table。通常
这个指针被称为 <b>vptr</b> 。vptr的设定和重置都由每个class的constructor、
destructor和copy assignment运算符自动完成。每一个class所关联
的type<sub>info</sub> object（用来支持runtime type identification，
RTTI）也经由virtual table被指出来，通常放在表格的第一个slot。</li>
</ol>

<p>
<b>virtual base class</b> 则由和virtual function异曲同工的 <b>btal*和*bptr</b> 支持。
</p>
</div>
</li>
<li><a id="orgf641052"></a>C++对象大小<br />
<div class="outline-text-5" id="text-3-4-1-3">
<ul class="org-ul">
<li>非静态数据成员的大小总和</li>
<li>加上内存对齐</li>
<li>加上为了支持virtual而产生的额外负担</li>
</ul>
</div>
</li>
</ol>
</div>
<div id="outline-container-org38c552c" class="outline-4">
<h4 id="org38c552c"><span class="section-number-4">3.4.2</span> 第二章 构造函数语意学</h4>
<div class="outline-text-4" id="text-3-4-2">
</div>
<ol class="org-ol">
<li><a id="org41733b2"></a>（编译器合成默认构造函数时机）nontrivail default construct<br />
<div class="outline-text-5" id="text-3-4-2-1">
<p>
简单理解就是：下面的情况都进入了part of c++的领域，而不再是part of c，所以需要
合成默认构造函数
</p>
<ol class="org-ol">
<li><p>
带有default construct的member class object
什么时候带有默认构造函数？答案是
当用户自定义了一个默认构造函数或编译器会为他合成一个的时候。例如下面代码：
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #0000FF;">class</span> <span style="color: #6434A3;">Foo</span> <span style="color: #707183;">{</span>
<span style="color: #0000FF;">public</span>:
  <span style="color: #006699;">Foo</span><span style="color: #7388D6;">()</span>;
<span style="color: #707183;">}</span>;
<span style="color: #0000FF;">class</span> <span style="color: #6434A3;">Bar</span> <span style="color: #707183;">{</span>
<span style="color: #0000FF;">public</span>:
  <span style="color: #6434A3;">Foo</span> <span style="color: #BA36A5;">foo</span>;
  <span style="color: #6434A3;">char</span> *<span style="color: #BA36A5;">str</span>;
<span style="color: #707183;">}</span>;

<span style="color: #6434A3;">void</span> <span style="color: #006699;">foo_bar</span><span style="color: #707183;">()</span> <span style="color: #707183;">{</span>
  <span style="color: #6434A3;">Bar</span> <span style="color: #BA36A5;">bar</span>;
<span style="color: #707183;">}</span>
</pre>
</div>
<p>
其汇编代码为：
</p>
<div class="org-src-container">
<pre class="src src-asm"><span style="color: #006699;">Bar</span>::Bar<span style="color: #707183;">()</span> <span style="color: #707183;">[</span>base object constructor<span style="color: #707183;">]</span>:
        <span style="color: #0000FF;">pushq</span>   <span style="color: #BA36A5;">%rbp</span>
        <span style="color: #0000FF;">movq</span>    <span style="color: #BA36A5;">%rsp</span>, <span style="color: #BA36A5;">%rbp</span>
        <span style="color: #0000FF;">subq</span>    $16, <span style="color: #BA36A5;">%rsp</span>
        <span style="color: #0000FF;">movq</span>    <span style="color: #BA36A5;">%rdi</span>, -8<span style="color: #707183;">(</span><span style="color: #BA36A5;">%rbp</span><span style="color: #707183;">)</span>
        <span style="color: #0000FF;">movq</span>    -8<span style="color: #707183;">(</span><span style="color: #BA36A5;">%rbp</span><span style="color: #707183;">)</span>, <span style="color: #BA36A5;">%rax</span>
        <span style="color: #0000FF;">movq</span>    <span style="color: #BA36A5;">%rax</span>, <span style="color: #BA36A5;">%rdi</span>
        <span style="color: #0000FF;">call</span>    Foo::Foo<span style="color: #707183;">()</span> <span style="color: #707183;">[</span>complete object constructor<span style="color: #707183;">]</span>
        <span style="color: #0000FF;">nop</span>
        <span style="color: #0000FF;">leave</span>
        <span style="color: #0000FF;">ret</span>
<span style="color: #006699;">foo_bar</span><span style="color: #707183;">()</span>:
        <span style="color: #0000FF;">pushq</span>   <span style="color: #BA36A5;">%rbp</span>
        <span style="color: #0000FF;">movq</span>    <span style="color: #BA36A5;">%rsp</span>, <span style="color: #BA36A5;">%rbp</span>
        <span style="color: #0000FF;">subq</span>    $16, <span style="color: #BA36A5;">%rsp</span>
        <span style="color: #0000FF;">leaq</span>    -16<span style="color: #707183;">(</span><span style="color: #BA36A5;">%rbp</span><span style="color: #707183;">)</span>, <span style="color: #BA36A5;">%rax</span>
        <span style="color: #0000FF;">movq</span>    <span style="color: #BA36A5;">%rax</span>, <span style="color: #BA36A5;">%rdi</span>
        <span style="color: #0000FF;">call</span>    Bar::Bar<span style="color: #707183;">()</span> <span style="color: #707183;">[</span>complete object constructor<span style="color: #707183;">]</span>
        <span style="color: #0000FF;">nop</span>
        <span style="color: #0000FF;">leave</span>
        <span style="color: #0000FF;">ret</span>
</pre>
</div>
<p>
上面的例子中，由于Foo定义了一个默认构造函数，所以编译器为Bar函数也
定义了一个默认构造函数.
如果Foo没有定义默认构造函数的话:
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #0000FF;">class</span> <span style="color: #6434A3;">Foo</span> <span style="color: #707183;">{</span>
<span style="color: #0000FF;">public</span>:
<span style="color: #707183;">}</span>;
<span style="color: #0000FF;">class</span> <span style="color: #6434A3;">Bar</span> <span style="color: #707183;">{</span>
<span style="color: #0000FF;">public</span>:
  <span style="color: #6434A3;">Foo</span> <span style="color: #BA36A5;">foo</span>;
  <span style="color: #6434A3;">char</span> *<span style="color: #BA36A5;">str</span>;
<span style="color: #707183;">}</span>;

<span style="color: #6434A3;">void</span> <span style="color: #006699;">foo_bar</span><span style="color: #707183;">()</span> <span style="color: #707183;">{</span>
  <span style="color: #6434A3;">Bar</span> <span style="color: #BA36A5;">bar</span>;

</pre>
</div>
<p>
那么编译器也就不会为Bar合成一个默认构造函数：
</p>
<div class="org-src-container">
<pre class="src src-asm"><span style="color: #006699;">foo_bar</span><span style="color: #707183;">()</span>:
        <span style="color: #0000FF;">pushq</span>   <span style="color: #BA36A5;">%rbp</span>
        <span style="color: #0000FF;">movq</span>    <span style="color: #BA36A5;">%rsp</span>, <span style="color: #BA36A5;">%rbp</span>
        <span style="color: #0000FF;">nop</span>
        <span style="color: #0000FF;">popq</span>    <span style="color: #BA36A5;">%rbp</span>
        <span style="color: #0000FF;">ret</span>
</pre>
</div>
<p>
当用户自定义了其他的construct就不会没有default constrcut,如下面
的代码会报错没有默认构造函数：
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #0000FF;">class</span> <span style="color: #6434A3;">Foo</span> <span style="color: #707183;">{</span>
<span style="color: #0000FF;">public</span>:
  <span style="color: #006699;">Foo</span><span style="color: #7388D6;">(</span><span style="color: #6434A3;">int</span><span style="color: #7388D6;">)</span>;
<span style="color: #707183;">}</span>;
<span style="color: #0000FF;">class</span> <span style="color: #6434A3;">Bar</span> <span style="color: #707183;">{</span>
<span style="color: #0000FF;">public</span>:
  <span style="color: #6434A3;">Foo</span> <span style="color: #BA36A5;">foo</span>;
  <span style="color: #6434A3;">char</span> *<span style="color: #BA36A5;">str</span>;
<span style="color: #707183;">}</span>;

<span style="color: #6434A3;">void</span> <span style="color: #006699;">foo_bar</span><span style="color: #707183;">()</span> <span style="color: #707183;">{</span>
  <span style="color: #6434A3;">Bar</span> <span style="color: #BA36A5;">bar</span>;

</pre>
</div></li>
<li>带有default constrcut的Base Class</li>
<li>带有一个virtual function的Class</li>
<li>带有一个virtual base class的Class</li>
</ol>

<p>
<b>如果用户自定义了默认构造函数，那么编译器会根据他的需要扩张这个构造函数</b>
</p>
</div>
</li>
<li><a id="org22ef8ed"></a>拷贝构造函数<br />
<ol class="org-ol">
<li><a id="orge6af0d3"></a>拷贝函数被调用的三种情况：<br />
<div class="outline-text-6" id="text-3-4-2-2-1">
<ol class="org-ol">
<li><p>
显示初始化
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #6434A3;">X</span> <span style="color: #BA36A5;">x</span>;
<span style="color: #6434A3;">X</span> <span style="color: #BA36A5;">xx</span> = x;
</pre>
</div></li>
<li><p>
函数参数传递
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #0000FF;">extern</span> <span style="color: #6434A3;">void</span> <span style="color: #006699;">foo</span><span style="color: #707183;">(</span><span style="color: #6434A3;">X</span> <span style="color: #BA36A5;">x</span><span style="color: #707183;">)</span>;

<span style="color: #6434A3;">void</span> <span style="color: #006699;">bar</span><span style="color: #707183;">()</span> <span style="color: #707183;">{</span>
  <span style="color: #6434A3;">X</span> <span style="color: #BA36A5;">xx</span>;
  foo<span style="color: #7388D6;">(</span>xx<span style="color: #7388D6;">)</span>;
<span style="color: #707183;">}</span>
</pre>
</div></li>
<li><p>
参数返回值
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #6434A3;">X</span> <span style="color: #006699;">foo_bar</span><span style="color: #707183;">()</span>
<span style="color: #707183;">{</span>
  <span style="color: #6434A3;">X</span> <span style="color: #BA36A5;">xx</span>;
  <span style="color: #0000FF;">return</span> xx;
<span style="color: #707183;">}</span>
</pre>
</div></li>
</ol>
</div>
</li>
<li><a id="orgc2f51f8"></a>defult memberwise initialization和bitwise copy<br />
<div class="outline-text-6" id="text-3-4-2-2-2">
<p>
当一个类对象a以相同class的另一个对象b作为初值初始化时，用的是
default memberwise initialisztion手法完成的：
把每一个基本内置类型和复合类型的data member，从b拷贝一份到a；
但是对于类成员对象，则会递归对这些类对象实施memberwise initialization.
</p>

<p>
所以memberwise initialization只会对类中的成员进行操作， <b>也就是说不会考虑
到vptr和vbptr</b>.
</p>

<p>
而bitwise是把一个类的内存对象的整个模型（包括vptr和vbptr）考虑进去了。
</p>

<p>
也就是说，一个类的memberwise initialization不一定是bitwise的,
特别是加入了多态性之后，肯定就不是了。
</p>

<p>
下面的理解有问题，看上面的
</p>

<p>
当一个类对象a以相同class的另一个对象b作为初值初始化时，用的是
default memberwise initialisztion手法完成的：
把每一个基本内置类型和复合类型的data member，从b拷贝一份到a；
但是对于类成员对象，则会递归对这些类对象实施memberwise initialization.
</p>

<p>
而bitwise copy就是可以理解为：当类中的所有成员的memberwise initialization
最终都表现为直接复制其基本内置类型和复合类型成员（也叫默认复制语意)。
以下面的例子来理解：
<b>首先看非bitwise copy：</b>
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #0000FF;">class</span> <span style="color: #6434A3;">str</span> <span style="color: #707183;">{</span>
<span style="color: #0000FF;">public</span>:
  <span style="color: #006699;">str</span><span style="color: #7388D6;">(</span><span style="color: #0000FF;">const</span> <span style="color: #6434A3;">str</span>&amp;<span style="color: #7388D6;">)</span>;
<span style="color: #0000FF;">private</span>:
<span style="color: #707183;">}</span>;

<span style="color: #0000FF;">class</span> <span style="color: #6434A3;">Word</span> <span style="color: #707183;">{</span>
<span style="color: #0000FF;">public</span>:
  <span style="color: #006699;">Word</span><span style="color: #7388D6;">(</span> <span style="color: #0000FF;">const</span> <span style="color: #6434A3;">str</span>&amp;<span style="color: #7388D6;">)</span>;
<span style="color: #0000FF;">private</span>:
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">cnt</span>;
  <span style="color: #6434A3;">str</span> <span style="color: #BA36A5;">a</span>;
<span style="color: #707183;">}</span>;

<span style="color: #6434A3;">void</span> <span style="color: #006699;">foo_bar</span><span style="color: #707183;">(</span><span style="color: #0000FF;">const</span> <span style="color: #6434A3;">Word</span> &amp;<span style="color: #BA36A5;">wd</span><span style="color: #707183;">)</span> <span style="color: #707183;">{</span>
  <span style="color: #6434A3;">Word</span> <span style="color: #BA36A5;">w</span> = wd;

</pre>
</div>
<p>
其汇编为：
</p>
<div class="org-src-container">
<pre class="src src-asm"><span style="color: #006699;">Word</span>::Word<span style="color: #707183;">(</span>Word const&amp;<span style="color: #707183;">)</span>:
        <span style="color: #0000FF;">pushq</span>   <span style="color: #BA36A5;">%rbp</span>
        <span style="color: #0000FF;">movq</span>    <span style="color: #BA36A5;">%rsp</span>, <span style="color: #BA36A5;">%rbp</span>
        <span style="color: #0000FF;">subq</span>    $16, <span style="color: #BA36A5;">%rsp</span>
        <span style="color: #0000FF;">movq</span>    <span style="color: #BA36A5;">%rdi</span>, -8<span style="color: #707183;">(</span><span style="color: #BA36A5;">%rbp</span><span style="color: #707183;">)</span>
        <span style="color: #0000FF;">movq</span>    <span style="color: #BA36A5;">%rsi</span>, -16<span style="color: #707183;">(</span><span style="color: #BA36A5;">%rbp</span><span style="color: #707183;">)</span>
        <span style="color: #0000FF;">movq</span>    -16<span style="color: #707183;">(</span><span style="color: #BA36A5;">%rbp</span><span style="color: #707183;">)</span>, <span style="color: #BA36A5;">%rax</span>
        <span style="color: #0000FF;">movl</span>    <span style="color: #707183;">(</span><span style="color: #BA36A5;">%rax</span><span style="color: #707183;">)</span>, <span style="color: #BA36A5;">%edx</span>
        <span style="color: #0000FF;">movq</span>    -8<span style="color: #707183;">(</span><span style="color: #BA36A5;">%rbp</span><span style="color: #707183;">)</span>, <span style="color: #BA36A5;">%rax</span>
        <span style="color: #0000FF;">movl</span>    <span style="color: #BA36A5;">%edx</span>, <span style="color: #707183;">(</span><span style="color: #BA36A5;">%rax</span><span style="color: #707183;">)</span>
        <span style="color: #0000FF;">movq</span>    -8<span style="color: #707183;">(</span><span style="color: #BA36A5;">%rbp</span><span style="color: #707183;">)</span>, <span style="color: #BA36A5;">%rax</span>
        <span style="color: #0000FF;">addq</span>    $4, <span style="color: #BA36A5;">%rax</span>
        <span style="color: #0000FF;">movq</span>    -16<span style="color: #707183;">(</span><span style="color: #BA36A5;">%rbp</span><span style="color: #707183;">)</span>, <span style="color: #BA36A5;">%rdx</span>
        <span style="color: #0000FF;">addq</span>    $4, <span style="color: #BA36A5;">%rdx</span>
        <span style="color: #0000FF;">movq</span>    <span style="color: #BA36A5;">%rdx</span>, <span style="color: #BA36A5;">%rsi</span>
        <span style="color: #0000FF;">movq</span>    <span style="color: #BA36A5;">%rax</span>, <span style="color: #BA36A5;">%rdi</span>
        <span style="color: #0000FF;">call</span>    str::str<span style="color: #707183;">(</span>str const&amp;<span style="color: #707183;">)</span>
        <span style="color: #0000FF;">nop</span>
        <span style="color: #0000FF;">leave</span>
        <span style="color: #0000FF;">ret</span>
<span style="color: #006699;">foo_bar</span><span style="color: #707183;">(</span>Word const&amp;<span style="color: #707183;">)</span>:
        <span style="color: #0000FF;">pushq</span>   <span style="color: #BA36A5;">%rbp</span>
        <span style="color: #0000FF;">movq</span>    <span style="color: #BA36A5;">%rsp</span>, <span style="color: #BA36A5;">%rbp</span>
        <span style="color: #0000FF;">subq</span>    $32, <span style="color: #BA36A5;">%rsp</span>
        <span style="color: #0000FF;">movq</span>    <span style="color: #BA36A5;">%rdi</span>, -24<span style="color: #707183;">(</span><span style="color: #BA36A5;">%rbp</span><span style="color: #707183;">)</span>
        <span style="color: #0000FF;">movq</span>    -24<span style="color: #707183;">(</span><span style="color: #BA36A5;">%rbp</span><span style="color: #707183;">)</span>, <span style="color: #BA36A5;">%rdx</span>
        <span style="color: #0000FF;">leaq</span>    -8<span style="color: #707183;">(</span><span style="color: #BA36A5;">%rbp</span><span style="color: #707183;">)</span>, <span style="color: #BA36A5;">%rax</span>
        <span style="color: #0000FF;">movq</span>    <span style="color: #BA36A5;">%rdx</span>, <span style="color: #BA36A5;">%rsi</span>
        <span style="color: #0000FF;">movq</span>    <span style="color: #BA36A5;">%rax</span>, <span style="color: #BA36A5;">%rdi</span>
        <span style="color: #0000FF;">call</span>    Word::Word<span style="color: #707183;">(</span>Word const&amp;<span style="color: #707183;">)</span>
        <span style="color: #0000FF;">nop</span>
        <span style="color: #0000FF;">leave</span>
        <span style="color: #0000FF;">ret</span>
</pre>
</div>
<p>
可以看到，str自定义了一个拷贝构造函数，所以str和含有str的Word都不再有默认
复制语意.所以编译器会为Word合成一个拷贝构造函数。
</p>

<p>
<b>而bitwise copy的话：</b>
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #0000FF;">class</span> <span style="color: #6434A3;">str</span> <span style="color: #707183;">{</span>
<span style="color: #0000FF;">public</span>:
  <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">str(const str&amp;);</span>
<span style="color: #0000FF;">private</span>:
<span style="color: #707183;">}</span>;

<span style="color: #0000FF;">class</span> <span style="color: #6434A3;">Word</span> <span style="color: #707183;">{</span>
<span style="color: #0000FF;">public</span>:
  <span style="color: #006699;">Word</span><span style="color: #7388D6;">(</span> <span style="color: #0000FF;">const</span> <span style="color: #6434A3;">str</span>&amp;<span style="color: #7388D6;">)</span>;
<span style="color: #0000FF;">private</span>:
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">cnt</span>;
  <span style="color: #6434A3;">str</span> <span style="color: #BA36A5;">a</span>;
<span style="color: #707183;">}</span>;

<span style="color: #6434A3;">void</span> <span style="color: #006699;">foo_bar</span><span style="color: #707183;">(</span><span style="color: #0000FF;">const</span> <span style="color: #6434A3;">Word</span> &amp;<span style="color: #BA36A5;">wd</span><span style="color: #707183;">)</span> <span style="color: #707183;">{</span>
  <span style="color: #6434A3;">Word</span> <span style="color: #BA36A5;">w</span> = wd;

</pre>
</div>
<p>
重点注意到被注释掉的代码，也就是说str并没有自定义的copy，所以可以说str
符合默认复制语意。 其汇编为：
</p>
<div class="org-src-container">
<pre class="src src-asm"><span style="color: #006699;">foo_bar</span><span style="color: #707183;">(</span>Word const&amp;<span style="color: #707183;">)</span>:
        <span style="color: #0000FF;">pushq</span>   <span style="color: #BA36A5;">%rbp</span>
        <span style="color: #0000FF;">movq</span>    <span style="color: #BA36A5;">%rsp</span>, <span style="color: #BA36A5;">%rbp</span>
        <span style="color: #0000FF;">movq</span>    <span style="color: #BA36A5;">%rdi</span>, -24<span style="color: #707183;">(</span><span style="color: #BA36A5;">%rbp</span><span style="color: #707183;">)</span>
        <span style="color: #0000FF;">movq</span>    -24<span style="color: #707183;">(</span><span style="color: #BA36A5;">%rbp</span><span style="color: #707183;">)</span>, <span style="color: #BA36A5;">%rax</span>
        <span style="color: #0000FF;">movq</span>    <span style="color: #707183;">(</span><span style="color: #BA36A5;">%rax</span><span style="color: #707183;">)</span>, <span style="color: #BA36A5;">%rax</span>
        <span style="color: #0000FF;">movq</span>    <span style="color: #BA36A5;">%rax</span>, -8<span style="color: #707183;">(</span><span style="color: #BA36A5;">%rbp</span><span style="color: #707183;">)</span>
        <span style="color: #0000FF;">nop</span>
        <span style="color: #0000FF;">popq</span>    <span style="color: #BA36A5;">%rbp</span>
        <span style="color: #0000FF;">ret</span>
</pre>
</div>
</div>
</li>

<li><a id="org47e6470"></a>不展现bitwise copy semantics的情况：<br />
<div class="outline-text-6" id="text-3-4-2-2-3">
<ol class="org-ol">
<li>当class内含有一个member object，而后者的class声明中有一个拷贝构造函数时
（不管是显式声明还是编译器合成）</li>
<li>当class继承自一个base class而后者存在一个拷贝构造函数时
（不管是显式声明还是编译器合成）</li>
<li>当class声明了一个或多个virtual functions时</li>
<li>当class派生自一个继承链，其中一个或多个为virtual base calss时</li>
</ol>
</div>
</li>
</ol>
</li>
<li><a id="org103ed04"></a>NRV优化<br />
<div class="outline-text-5" id="text-3-4-2-3">
<p>
即named return value优化：
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #6434A3;">X</span> <span style="color: #006699;">bar</span><span style="color: #707183;">(){</span>
  <span style="color: #6434A3;">X</span> <span style="color: #BA36A5;">xx</span>;
  &#22788;&#29702;xx
  <span style="color: #0000FF;">return</span> xx;
<span style="color: #707183;">}</span>

<span style="color: #6434A3;">void</span>
<span style="color: #006699;">bar</span><span style="color: #707183;">(</span><span style="color: #6434A3;">X</span> &amp;<span style="color: #BA36A5;">__result</span><span style="color: #707183;">)</span>
<span style="color: #707183;">{</span>
  __result.<span style="color: #D0372D;">X</span>::X<span style="color: #7388D6;">()</span>;
  &#30452;&#25509;&#22788;&#29702;__result
  <span style="color: #0000FF;">return</span> ;
<span style="color: #707183;">}</span>
</pre>
</div>
</div>
</li>
<li><a id="org4ff846c"></a><span class="todo TODO">TODO</span> 什么时候必须使用成员初始化列表(p.75)<br />
<div class="outline-text-5" id="text-3-4-2-4">
<p>
todo 为什么虚拟继承需要到执行期才能确定去哪？
感觉可以用虚函数做类比，因为其动态类型是执行期才
确定的，而虚拟继承和虚函数一样，其偏移或者地址是知道动态类型
才能确定的。
</p>
</div>
</li>
</ol>
</div>
</div>
<div id="outline-container-orge792114" class="outline-3">
<h3 id="orge792114"><span class="section-number-3">3.5</span> <a href="http://www.52im.net/topic-tcpipvol1.html">tcp/ip详解卷一</a></h3>
</div>
<div id="outline-container-org2f6d174" class="outline-3">
<h3 id="org2f6d174"><span class="section-number-3">3.6</span> <a href="file:///Users/binbinyang/Documents/TCP-IP详解卷2：实现.pdf">tcp/ip详解卷二</a></h3>
<div class="outline-text-3" id="text-3-6">
</div>
</div>
<div id="outline-container-org5e53d58" class="outline-3">
<h3 id="org5e53d58"><span class="section-number-3">3.7</span> apue <a href="file:///Users/binbinyang/Documents/中文版 第三版UNIX 环境高级编程 第3版.pdf">pdf</a></h3>
<div class="outline-text-3" id="text-3-7">
</div>
<div id="outline-container-org1ee2ba9" class="outline-4">
<h4 id="org1ee2ba9"><span class="section-number-4">3.7.1</span> 头文件配置</h4>
<div class="outline-text-4" id="text-3-7-1">
<p>
<a href="https://www.jianshu.com/p/dd734b0e8cb9">https://www.jianshu.com/p/dd734b0e8cb9</a>
</p>
</div>
</div>
<div id="outline-container-org8fff13a" class="outline-4">
<h4 id="org8fff13a"><span class="section-number-4">3.7.2</span> charpter3</h4>
<div class="outline-text-4" id="text-3-7-2">
</div>
<ol class="org-ol">
<li><a id="orgb77efca"></a>lseek<br />
<div class="outline-text-5" id="text-3-7-2-1">
<p>
在比较lseek的返回值时应该谨慎，不要测试是否小于0，而要测试是否等于-1
</p>
</div>
</li>
<li><a id="orgfa6373c"></a>内核用3种数据结构来表示打开的文件<br />
<div class="outline-text-5" id="text-3-7-2-2">
<ol class="org-ol">
<li>每个进程在进程表中都有一个记录项，记录项中包含一张打开文件描述符表，与每个文件描述符关联的是：
a. 文件描述符标志
b. 指向一个文件表项的指针</li>
<li>内核为所有打开文件维持一张全局文件表。每个文件表项包含：
a. 文件状态标志（读，写，添写，同步，非阻塞等）
b. 当前文件偏移量
c. 指向该文件v节点表项的指针</li>
<li>每个打开的文件（或设备）都有一个v节点结构，包含了：
a. 文件类型
b. 对此文件进行各种操作的函数的指针</li>
</ol>
</div>
</li>
<li><a id="orgc9ecb13"></a>dup和dup2的区别<br />
<div class="outline-text-5" id="text-3-7-2-3">
<ul class="org-ul">
<li>dup返回的文件描述符，一定是当前可用文件描述符中的最小值， dup2可以指定</li>
</ul>
</div>
</li>
<li><a id="orge8ff0bf"></a>fcntl<br />
<div class="outline-text-5" id="text-3-7-2-4">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #808080;">#include</span> <span style="color: #707183;">&lt;</span><span style="color: #008000;">fcntl.h</span><span style="color: #707183;">&gt;</span>
<span style="color: #6434A3;">int</span> <span style="color: #006699;">fcntl</span><span style="color: #707183;">(</span><span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">fd</span>, <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">cmd</span>, ...<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">int arg</span><span style="color: #8D8D84;"> */</span> <span style="color: #707183;">)</span>;
&#20986;&#38169;&#36820;&#22238;-<span style="color: #D0372D;">1</span>
</pre>
</div>
<p>
fcntl函数有5种功能
</p>
<ol class="org-ol">
<li>复制一个已有的描述符</li>
<li>获取/设置文件描述符标志</li>
<li>获取/设置文件状态标志</li>
<li>获取/设置异步io所有权</li>
<li>获取/设置记录锁</li>
</ol>
</div>
</li>
<li><a id="org7b15777"></a>/dev/fd的作用<br />
<div class="outline-text-5" id="text-3-7-2-5">
<p>
/dev/fd文件主要由shell使用，能用处理其他路径名同样的方式处理标准输入和输出
</p>
</div>
</li>
</ol>
</div>
<div id="outline-container-orgbe29bc5" class="outline-4">
<h4 id="orgbe29bc5"><span class="section-number-4">3.7.3</span> charpter4</h4>
</div>
<div id="outline-container-orgef9f699" class="outline-4">
<h4 id="orgef9f699"><span class="section-number-4">3.7.4</span> charpter5 标准io库</h4>
<div class="outline-text-4" id="text-3-7-4">
</div>
</div>

<div id="outline-container-orgd963fe8" class="outline-4">
<h4 id="orgd963fe8"><span class="section-number-4">3.7.5</span> chapter6 系统数据文件和信息</h4>
<div class="outline-text-4" id="text-3-7-5">
</div>
<ol class="org-ol">
<li><a id="orgaf67aaa"></a>unix系统中有大量与系统有关的数据文件，他们都有一套例程来访问这些系统数据文件<br />
<div class="outline-text-5" id="text-3-7-5-1">
<p>
如图：   
</p>

<div id="org4c0f979" class="figure">
<p><img src="reading/2020-11-06_15-55-43_screenshot.png" alt="2020-11-06_15-55-43_screenshot.png" />
</p>
</div>
</div>
</li>

<li><a id="org21832c4"></a>系统标示uname<br />
<div class="outline-text-5" id="text-3-7-5-2">
<p>
uname返回与主机和操作系统相关的信息
</p>
<div class="org-src-container">
<pre class="src src-c">TODO
</pre>
</div>
</div>
</li>
<li><a id="org113e9fc"></a>时间和日期例程<br />
<ol class="org-ol">
<li><a id="orgd7858d9"></a>有一套函数来获取时间，他们的关系如图：<br />
<div class="outline-text-6" id="text-3-7-5-3-1">

<div id="orgf2d7bc2" class="figure">
<p><img src="reading/2020-11-06_17-33-21_screenshot.png" alt="2020-11-06_17-33-21_screenshot.png" />
</p>
</div>


<p>
其中的设计的数据结构有：
</p>
<div class="org-src-container">
<pre class="src src-c">time_t <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">&#20174;1970&#24180;1&#26376;1&#26085;&#20197;&#26469;&#30340;&#31186;&#25968;</span>

<span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">timeval</span> <span style="color: #707183;">{</span>
  <span style="color: #6434A3;">time_t</span>       <span style="color: #BA36A5;">tv_sec</span>;   <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">seconds since Jan. 1, 1970</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">suseconds_t</span>  <span style="color: #BA36A5;">tv_usec</span>;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">and microseconds</span><span style="color: #8D8D84;"> */</span>
<span style="color: #707183;">}</span>;

<span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">timespec</span> <span style="color: #707183;">{</span>
  <span style="color: #6434A3;">time_t</span>  <span style="color: #BA36A5;">tv_sec</span>;     <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">seconds</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">long</span>    <span style="color: #BA36A5;">tv_nsec</span>;    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">and nanoseconds</span><span style="color: #8D8D84;"> */</span>
<span style="color: #707183;">}</span>;

<span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">tm</span> <span style="color: #707183;">{</span>
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">tm_sec</span>;     <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">seconds (0 - 60)</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">tm_min</span>;     <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">minutes (0 - 59)</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">tm_hour</span>;    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">hours (0 - 23)</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">tm_mday</span>;    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">day of month (1 - 31)</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">tm_mon</span>;     <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">month of year (0 - 11)</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">tm_year</span>;    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">year - 1900</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">tm_wday</span>;    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">day of week (Sunday = 0)</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">tm_yday</span>;    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">day of year (0 - 365)</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">tm_isdst</span>;   <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">is summer time in effect?</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">char</span> *<span style="color: #BA36A5;">tm_zone</span>;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">abbreviation of timezone name</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">tm_gmtoff</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">offset from UTC in seconds</span><span style="color: #8D8D84;"> */</span>
<span style="color: #707183;">}</span>
</pre>
</div>
<p>
一般获取时间的流程是：用相关函数获取前三个结构体后，通常要调用相关函数转换为
第四个结构struct tm, 最后还可以把tm格式化输出
</p>
</div>
</li>
</ol>
</li>
<li><a id="org71eb658"></a>进程环境<br /></li>
</ol>
</div>
<div id="outline-container-orgc24cc08" class="outline-4">
<h4 id="orgc24cc08"><span class="section-number-4">3.7.6</span> chapter7 进程环境</h4>
<div class="outline-text-4" id="text-3-7-6">
</div>
<ol class="org-ol">
<li><a id="org4e45b10"></a>进程启动<br />
<div class="outline-text-5" id="text-3-7-6-1">
<ul class="org-ul">
<li>启动例程
C程序总是从main函数开始执行，当内核执行C程序时(exec函数),在调用main函数前先调用一个
特殊的启动例程。该例程从内核取得命令行参数和环境变量值，为调用main函数做好准备。
连接器将该启动例程指定为C程序的起始地址。</li>
</ul>
</div>
</li>
<li><a id="org2fe8d81"></a>进程终止<br />
<div class="outline-text-5" id="text-3-7-6-2">
<ul class="org-ul">
<li><p>
有8种方法来使进程终止，其中五种为正常终止：
</p>
<ol class="org-ol">
<li>从main返回</li>
<li>调用exit</li>
<li>调用<sub>exit或</sub><sub>Exit</sub></li>
<li>最后一个线程从其启动例程返回</li>
<li>从最后一个线程调用pthread<sub>exit</sub></li>
</ol>
<p>
另外三种为异常终止:
</p>
<ol class="org-ol">
<li>调用abort</li>
<li>接到一个信号</li>
<li>最后一个线程对取消请求做出响应</li>
</ol></li>
<li><p>
exit与<sub>exit</sub>/<sub>Exit</sub>
</p>
<ol class="org-ol">
<li>exit总是执行一个标准I/O库的清理关闭操作：对所有打开流调用fclose函数。而<sub>exit和</sub><sub>Exit</sub>
则直接进入内核</li>
<li>exit和<sub>Exit是ISO</sub> C说明的，而exit是POSIX.1说明的,所以他们的头文件不一样</li>
</ol>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #808080;">#include</span> <span style="color: #707183;">&lt;</span><span style="color: #008000;">stdlib.h</span><span style="color: #707183;">&gt;</span>

<span style="color: #6434A3;">void</span>
<span style="color: #006699;">exit</span><span style="color: #707183;">(</span><span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">status</span><span style="color: #707183;">)</span>;

<span style="color: #6434A3;">void</span>
<span style="color: #006699;">_Exit</span><span style="color: #707183;">(</span><span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">status</span><span style="color: #707183;">)</span>;



<span style="color: #808080;">#include</span> <span style="color: #707183;">&lt;</span><span style="color: #008000;">unistd.h</span><span style="color: #707183;">&gt;</span>

<span style="color: #6434A3;">void</span>
<span style="color: #006699;">_exit</span><span style="color: #707183;">(</span><span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">status</span><span style="color: #707183;">)</span>;
</pre>
</div></li>
<li><p>
return与exit
main函数返回一个整型值与用该值调用exit是等价的。于是main函数中exit(0)等价于return(0)，
所以一般在main中使用return而不是exit。但是某些情况也需要exit:
</p>

<div id="org2377802" class="figure">
<p><img src="reading/2020-11-07_15-37-53_screenshot.png" alt="2020-11-07_15-37-53_screenshot.png" />
</p>
</div></li>
<li><p>
atexit
进程可以通过atexit函数来注册终止处理函数 main调用exit后，exit会自动调用调用进程
登记的终止处理函数:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6434A3;">NAME</span>
<span style="color: #006699;">atexit</span> -- <span style="color: #0000FF;">register</span> a function to be called on exit

SYNOPSIS
<span style="color: #808080;">#include</span> <span style="color: #707183;">&lt;</span><span style="color: #008000;">stdlib.h</span><span style="color: #707183;">&gt;</span>

<span style="color: #6434A3;">int</span>
atexit<span style="color: #707183;">(</span><span style="color: #6434A3;">void</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">function</span><span style="color: #7388D6;">)(</span><span style="color: #6434A3;">void</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>;

<span style="color: #6434A3;">int</span>
<span style="color: #006699;">atexit_b</span><span style="color: #707183;">(</span><span style="color: #6434A3;">void</span> <span style="color: #7388D6;">(</span>^function<span style="color: #7388D6;">)(</span><span style="color: #6434A3;">void</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>;
</pre>
</div>
<p>
有一个要注意的点是：atexit注册的顺序和exit调用的顺序相反,如：
</p>
<div class="org-src-container">
<pre class="src src-C++"><span style="color: #808080;">#include</span> <span style="color: #008000;">"apue.h"</span>

<span style="color: #0000FF;">static</span> <span style="color: #6434A3;">void</span> <span style="color: #006699;">my_exit1</span><span style="color: #707183;">(</span><span style="color: #6434A3;">void</span><span style="color: #707183;">)</span>;
<span style="color: #0000FF;">static</span> <span style="color: #6434A3;">void</span> <span style="color: #006699;">my_exit2</span><span style="color: #707183;">(</span><span style="color: #6434A3;">void</span><span style="color: #707183;">)</span>;

<span style="color: #6434A3;">int</span>
<span style="color: #006699;">main</span><span style="color: #707183;">()</span>
<span style="color: #707183;">{</span>
  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>atexit<span style="color: #909183;">(</span>my_exit1<span style="color: #909183;">)</span> != <span style="color: #D0372D;">0</span><span style="color: #7388D6;">)</span>
    err_sys<span style="color: #7388D6;">(</span><span style="color: #008000;">"can't register myexit1 "</span><span style="color: #7388D6;">)</span>;
  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>atexit<span style="color: #909183;">(</span>my_exit2<span style="color: #909183;">)</span> != <span style="color: #D0372D;">0</span><span style="color: #7388D6;">)</span>
    err_sys<span style="color: #7388D6;">(</span><span style="color: #008000;">"can't register myexit2 "</span><span style="color: #7388D6;">)</span>;
  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>atexit<span style="color: #909183;">(</span>my_exit2<span style="color: #909183;">)</span> != <span style="color: #D0372D;">0</span><span style="color: #7388D6;">)</span>
    err_sys<span style="color: #7388D6;">(</span><span style="color: #008000;">"can't register myexit2 "</span><span style="color: #7388D6;">)</span>;

  printf<span style="color: #7388D6;">(</span><span style="color: #008000;">"main is done\n"</span><span style="color: #7388D6;">)</span>;
  <span style="color: #0000FF;">return</span> <span style="color: #D0372D;">0</span>;
<span style="color: #707183;">}</span>

<span style="color: #0000FF;">static</span> <span style="color: #6434A3;">void</span> <span style="color: #006699;">my_exit1</span><span style="color: #707183;">()</span> 
<span style="color: #707183;">{</span>
  printf<span style="color: #7388D6;">(</span><span style="color: #008000;">"my_exit1\n"</span><span style="color: #7388D6;">)</span> ;
<span style="color: #707183;">}</span>

<span style="color: #0000FF;">static</span> <span style="color: #6434A3;">void</span> <span style="color: #006699;">my_exit2</span><span style="color: #707183;">()</span> 
<span style="color: #707183;">{</span>
  printf<span style="color: #7388D6;">(</span><span style="color: #008000;">"my_exit2\n"</span><span style="color: #7388D6;">)</span> ;
<span style="color: #707183;">}</span>

</pre>
</div></li>
<li><p>
一个C程序的启动和终止过程可以表示为下图：
</p>
<p>
<img src="reading/2020-11-07_16-15-54_screenshot.png" alt="2020-11-07_16-15-54_screenshot.png" />
 可以看到，exit会首先调用各种终止处理程序，然后关闭所有打开流。而且，所有的程序都是从
 exec开始的，也就是说，内核使得程序执行的唯一方法是调用一个exec函数。进程自愿终止的唯一
 方法是显示或隐式的(通过<sub>exit</sub>)调用<sub>exit或</sub><sub>Exit</sub>。当然，进程也可以非自愿地由一个信号
 使其终止
</p></li>
</ul>
</div>
</li>
<li><a id="org4735c62"></a>进程环境表<br />
<div class="outline-text-5" id="text-3-7-6-3">
<ul class="org-ul">
<li>每个程序都接收到一张环境表，全局变量environ指向了这张表：</li>
</ul>
<p>
<img src="reading/2020-11-07_18-01-40_screenshot.png" alt="2020-11-07_18-01-40_screenshot.png" />
 与环境表相关的函数有如下：
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #808080;">#include</span> <span style="color: #707183;">&lt;</span><span style="color: #008000;">stdlib.h</span><span style="color: #707183;">&gt;</span>

<span style="color: #6434A3;">char</span> *
<span style="color: #006699;">getenv</span><span style="color: #707183;">(</span><span style="color: #0000FF;">const</span> <span style="color: #6434A3;">char</span> *<span style="color: #BA36A5;">name</span><span style="color: #707183;">)</span>;

<span style="color: #6434A3;">int</span>
<span style="color: #006699;">setenv</span><span style="color: #707183;">(</span><span style="color: #0000FF;">const</span> <span style="color: #6434A3;">char</span> *<span style="color: #BA36A5;">name</span>, <span style="color: #0000FF;">const</span> <span style="color: #6434A3;">char</span> *<span style="color: #BA36A5;">value</span>, <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">overwrite</span><span style="color: #707183;">)</span>;

<span style="color: #6434A3;">int</span>
<span style="color: #006699;">putenv</span><span style="color: #707183;">(</span><span style="color: #6434A3;">char</span> *<span style="color: #BA36A5;">string</span><span style="color: #707183;">)</span>;

<span style="color: #6434A3;">int</span>
<span style="color: #006699;">unsetenv</span><span style="color: #707183;">(</span><span style="color: #0000FF;">const</span> <span style="color: #6434A3;">char</span> *<span style="color: #BA36A5;">name</span><span style="color: #707183;">)</span>;

</pre>
</div>

<div id="org2b0f347" class="figure">
<p><img src="reading/2020-11-07_19-06-37_screenshot.png" alt="2020-11-07_19-06-37_screenshot.png" />
</p>
</div>

<p>
这些函数的执行细节如下：
</p>

<div id="org4179e01" class="figure">
<p><img src="reading/2020-11-07_19-07-55_screenshot.png" alt="2020-11-07_19-07-55_screenshot.png" />
</p>
</div>


<div id="org9ac48c8" class="figure">
<p><img src="reading/2020-11-07_19-09-47_screenshot.png" alt="2020-11-07_19-09-47_screenshot.png" />
</p>
</div>
</div>
</li>

<li><a id="org3c8bb96"></a><span class="todo TODO">TODO</span> 内存布局<br />
<div class="outline-text-5" id="text-3-7-6-4">
<p>
典型的进程内存布局如图：
</p>

<div id="org4e3b87e" class="figure">
<p><img src="reading/2020-11-07_18-05-21_screenshot.png" alt="2020-11-07_18-05-21_screenshot.png" />
</p>
</div>

<p>
可以用size命令来查看：
</p>
</div>
</li>

<li><a id="org48fa229"></a><span class="todo TODO">TODO</span> 共享库<br /></li>
<li><a id="org96e1d24"></a>内存分配<br />
<div class="outline-text-5" id="text-3-7-6-6">
<p>
ISO C说明了3个用于存储空间动态分配的函数:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #808080;">#include</span> <span style="color: #707183;">&lt;</span><span style="color: #008000;">stdlib.h</span><span style="color: #707183;">&gt;</span>

<span style="color: #6434A3;">void</span> *
<span style="color: #006699;">calloc</span><span style="color: #707183;">(</span><span style="color: #6434A3;">size_t</span> <span style="color: #BA36A5;">count</span>, <span style="color: #6434A3;">size_t</span> <span style="color: #BA36A5;">size</span><span style="color: #707183;">)</span>;

<span style="color: #6434A3;">void</span>
<span style="color: #006699;">free</span><span style="color: #707183;">(</span><span style="color: #6434A3;">void</span> *<span style="color: #BA36A5;">ptr</span><span style="color: #707183;">)</span>;

<span style="color: #6434A3;">void</span> *
<span style="color: #006699;">malloc</span><span style="color: #707183;">(</span><span style="color: #6434A3;">size_t</span> <span style="color: #BA36A5;">size</span><span style="color: #707183;">)</span>;

<span style="color: #6434A3;">void</span> *
<span style="color: #006699;">realloc</span><span style="color: #707183;">(</span><span style="color: #6434A3;">void</span> *<span style="color: #BA36A5;">ptr</span>, <span style="color: #6434A3;">size_t</span> <span style="color: #BA36A5;">size</span><span style="color: #707183;">)</span>;

<span style="color: #6434A3;">void</span> *
<span style="color: #006699;">reallocf</span><span style="color: #707183;">(</span><span style="color: #6434A3;">void</span> *<span style="color: #BA36A5;">ptr</span>, <span style="color: #6434A3;">size_t</span> <span style="color: #BA36A5;">size</span><span style="color: #707183;">)</span>;

<span style="color: #6434A3;">void</span> *
<span style="color: #006699;">valloc</span><span style="color: #707183;">(</span><span style="color: #6434A3;">size_t</span> <span style="color: #BA36A5;">size</span><span style="color: #707183;">)</span>;

<span style="color: #6434A3;">void</span> *
<span style="color: #006699;">aligned_alloc</span><span style="color: #707183;">(</span><span style="color: #6434A3;">size_t</span> <span style="color: #BA36A5;">alignment</span>, <span style="color: #6434A3;">size_t</span> <span style="color: #BA36A5;">size</span><span style="color: #707183;">)</span>;
</pre>
</div>
<p>
还有很多替代品:
</p>

<div id="org228022c" class="figure">
<p><img src="reading/2020-11-07_18-25-23_screenshot.png" alt="2020-11-07_18-25-23_screenshot.png" />
</p>
</div>
</div>
</li>
<li><a id="orgcfb0922"></a><span class="todo TODO">TODO</span> setjmp和longjmp<br /></li>
<li><a id="org0e30c24"></a>资源限制相关函数<br />
<div class="outline-text-5" id="text-3-7-6-8">
<ul class="org-ul">
<li>每个进程都有一组资源限制,相关函数和数据结构有:</li>
</ul>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #808080;">#include</span> <span style="color: #707183;">&lt;</span><span style="color: #008000;">sys/resource.h</span><span style="color: #707183;">&gt;</span>

<span style="color: #6434A3;">int</span>
<span style="color: #006699;">getrlimit</span><span style="color: #707183;">(</span><span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">resource</span>, <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">rlimit</span> *<span style="color: #BA36A5;">rlp</span><span style="color: #707183;">)</span>;

<span style="color: #6434A3;">int</span>
<span style="color: #006699;">setrlimit</span><span style="color: #707183;">(</span><span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">resource</span>, <span style="color: #0000FF;">const</span> <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">rlimit</span> *<span style="color: #BA36A5;">rlp</span><span style="color: #707183;">)</span>;

<span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">rlimit</span> <span style="color: #707183;">{</span>
  <span style="color: #6434A3;">rlim_t</span>  <span style="color: #BA36A5;">rlim_cur</span>;       <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">current (soft) limit</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">rlim_t</span>  <span style="color: #BA36A5;">rlim_max</span>;       <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">hard limit</span><span style="color: #8D8D84;"> */</span>
<span style="color: #707183;">}</span>;
</pre>
</div>
<p>
其规则是：cur不能高于max;max不能小于cur;普通用户只用往少了调.
</p>
<ul class="org-ul">
<li>资源限制会继承到子进程</li>
</ul>
</div>
</li>
</ol>
</div>
<div id="outline-container-org52c6ef8" class="outline-4">
<h4 id="org52c6ef8"><span class="section-number-4">3.7.7</span> chapter8 进程控制</h4>
<div class="outline-text-4" id="text-3-7-7">
</div>
<ol class="org-ol">
<li><a id="org49f5ce7"></a>fork<br />
<div class="outline-text-5" id="text-3-7-7-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #808080;">#include</span> <span style="color: #008000;">"apue.h"</span>

<span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">globvar</span> = <span style="color: #D0372D;">6</span>;
<span style="color: #6434A3;">char</span> <span style="color: #BA36A5;">buf</span><span style="color: #707183;">[]</span> = <span style="color: #008000;">"a write to stdout\n"</span>;

<span style="color: #6434A3;">int</span>
<span style="color: #006699;">main</span><span style="color: #707183;">()</span>
<span style="color: #707183;">{</span>
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">var</span>;
  <span style="color: #6434A3;">pid_t</span> <span style="color: #BA36A5;">pid</span>;

  var = <span style="color: #D0372D;">88</span>;
  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>write<span style="color: #909183;">(</span>STDOUT_FILENO, buf, <span style="color: #0000FF;">sizeof</span><span style="color: #709870;">(</span>buf<span style="color: #709870;">)</span><span style="color: #909183;">)</span> != <span style="color: #0000FF;">sizeof</span><span style="color: #909183;">(</span>buf<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
    err_sys<span style="color: #7388D6;">(</span><span style="color: #008000;">"write error"</span><span style="color: #7388D6;">)</span>;
  printf<span style="color: #7388D6;">(</span><span style="color: #008000;">"before fork\n"</span><span style="color: #7388D6;">)</span>;

  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span><span style="color: #909183;">(</span>pid = fork<span style="color: #709870;">()</span><span style="color: #909183;">)</span> &lt; <span style="color: #D0372D;">0</span><span style="color: #7388D6;">)</span>
    err_sys<span style="color: #7388D6;">(</span><span style="color: #008000;">"fork error"</span><span style="color: #7388D6;">)</span>;
  <span style="color: #0000FF;">else</span> <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>pid == <span style="color: #D0372D;">0</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">{</span>
    buf<span style="color: #909183;">[</span><span style="color: #D0372D;">0</span><span style="color: #909183;">]</span> = <span style="color: #008000;">'b'</span>;
    globvar++;
    var++;
  <span style="color: #7388D6;">}</span> <span style="color: #0000FF;">else</span> <span style="color: #7388D6;">{</span>
    sleep<span style="color: #909183;">(</span><span style="color: #D0372D;">2</span><span style="color: #909183;">)</span>;
  <span style="color: #7388D6;">}</span>

  printf<span style="color: #7388D6;">(</span><span style="color: #008000;">"pid = %ld, globvar = %d, var = %d\n"</span>, <span style="color: #909183;">(</span><span style="color: #6434A3;">long</span><span style="color: #909183;">)</span>getpid<span style="color: #909183;">()</span>, globvar, var<span style="color: #7388D6;">)</span>;
  printf<span style="color: #7388D6;">(</span><span style="color: #008000;">"%s\n"</span>, buf<span style="color: #7388D6;">)</span>;
  sleep<span style="color: #7388D6;">(</span><span style="color: #D0372D;">2</span><span style="color: #7388D6;">)</span>;
  <span style="color: #0000FF;">return</span> <span style="color: #D0372D;">0</span>;
<span style="color: #707183;">}</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-shell">~/l/a/a/m/chapter8 &#10095;&#10095;&#10095; ./a.out                                          <span style="color: #D0372D;">14:43:18</span>
a write to stdout
before fork
pid = <span style="color: #D0372D;">68796,</span> globvar = <span style="color: #D0372D;">7,</span> var = <span style="color: #D0372D;">89</span>
pid = <span style="color: #D0372D;">68795,</span> globvar = <span style="color: #D0372D;">6,</span> var = <span style="color: #D0372D;">88</span>

~/l/a/a/m/chapter8 &#10095;&#10095;&#10095; ./a.out &gt; temp.out                               <span style="color: #D0372D;">14:43:24</span>
~/l/a/a/m/chapter8 &#10095;&#10095;&#10095; cat temp.out                                     <span style="color: #D0372D;">14:43:49</span>
a write to stdout
before fork
pid = <span style="color: #D0372D;">68799,</span> globvar = <span style="color: #D0372D;">7,</span> var = <span style="color: #D0372D;">89</span>
before fork
pid = <span style="color: #D0372D;">68798,</span> globvar = <span style="color: #D0372D;">6,</span> var = <span style="color: #D0372D;">88</span>

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">&#20457;&#20010;&#32467;&#26524;&#19981;&#21516;&#26159;&#22240;&#20026;&#37325;&#23450;&#21521;&#26631;&#20934;&#36755;&#20986;&#21518;&#21464;&#20026;&#20840;&#32531;&#20914;&#20102;&#65292;&#25152;&#20197;&#23376;&#36827;&#31243;</span>
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">&#35813;io&#32531;&#20914;&#20013;&#36824;&#26377;before fork</span>
</pre>
</div>
<ul class="org-ul">
<li><p>
fork中，父进程的很多属性由子进程继承：
</p>
<p>
<img src="reading/2020-11-08_15-07-06_screenshot.png" alt="2020-11-08_15-07-06_screenshot.png" />
 但也有很多区别：
</p>

<div id="orgffc1a8c" class="figure">
<p><img src="reading/2020-11-08_15-08-09_screenshot.png" alt="2020-11-08_15-08-09_screenshot.png" />
</p>
</div></li>
</ul>
</div>
</li>
<li><a id="org818dd47"></a>exit和终止状态<br />
<div class="outline-text-5" id="text-3-7-7-2">
<p>
chapter7说到终止进程的方法有8种，5种正常终止和3种异常终止。不管进程以8种中的哪种终止，
最后都会执行到内核中的同一段代码，这段代码为进程关闭所有的打开描述符，释放它使用的内存。
不仅如此，任何一种终止方法都实现了把终止进程的终止状态通知给父进程机制的机制。在正常终止
的情况下，main函数中return 语句返回的那个status叫退出状态，退出状态会传递给<sub>exit函数</sub>，
最后由<sub>exit函数返回</sub>。父进程可以使用wait或waitpid函数取得这个状态。posix.1还规定了一些
宏来查看终止状态：
</p>

<div id="org21c5b81" class="figure">
<p><img src="reading/2020-11-08_18-10-08_screenshot.png" alt="2020-11-08_18-10-08_screenshot.png" />
</p>
</div>
</div>
</li>

<li><a id="orgd62bbb5"></a>wait和waitpid<br />
<div class="outline-text-5" id="text-3-7-7-3">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #808080;">#include</span> <span style="color: #707183;">&lt;</span><span style="color: #008000;">sys/wait.h</span><span style="color: #707183;">&gt;</span>

<span style="color: #6434A3;">pid_t</span>
<span style="color: #006699;">wait</span><span style="color: #707183;">(</span><span style="color: #6434A3;">int</span> *<span style="color: #BA36A5;">stat_loc</span><span style="color: #707183;">)</span>;

<span style="color: #6434A3;">pid_t</span>
<span style="color: #006699;">wait3</span><span style="color: #707183;">(</span><span style="color: #6434A3;">int</span> *<span style="color: #BA36A5;">stat_loc</span>, <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">options</span>, <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">rusage</span> *<span style="color: #BA36A5;">rusage</span><span style="color: #707183;">)</span>;

<span style="color: #6434A3;">pid_t</span>
<span style="color: #006699;">wait4</span><span style="color: #707183;">(</span><span style="color: #6434A3;">pid_t</span> <span style="color: #BA36A5;">pid</span>, <span style="color: #6434A3;">int</span> *<span style="color: #BA36A5;">stat_loc</span>, <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">options</span>, <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">rusage</span> *<span style="color: #BA36A5;">rusage</span><span style="color: #707183;">)</span>;

<span style="color: #6434A3;">pid_t</span>
<span style="color: #006699;">waitpid</span><span style="color: #707183;">(</span><span style="color: #6434A3;">pid_t</span> <span style="color: #BA36A5;">pid</span>, <span style="color: #6434A3;">int</span> *<span style="color: #BA36A5;">stat_loc</span>, <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">options</span><span style="color: #707183;">)</span>;

&#25104;&#21151;&#36820;&#22238;&#36827;&#31243;ID,&#20986;&#38169;&#36820;&#22238;0&#25110;-<span style="color: #D0372D;">1</span>
</pre>
</div>
<p>
waitpid与wait的主要不同是：
</p>
<p>
<img src="reading/2020-11-08_18-08-02_screenshot.png" alt="2020-11-08_18-08-02_screenshot.png" />
     wait3和wait4比上面两个函数多了一个功能：允许内核返回由终止进程及其所有子进程使用的资源情况
</p>
</div>
</li>

<li><a id="org1d947a4"></a><span class="todo TODO">TODO</span> 孤儿进程和僵尸进程<br />
<div class="outline-text-5" id="text-3-7-7-4">
<p>
如果想fork一个子进程，但是又不想调用wait来等待它终止，那么可以调用两次fork来达到这种效果(193页)
</p>
</div>
</li>
<li><a id="org78f28f7"></a>exec函数<br />
<div class="outline-text-5" id="text-3-7-7-5">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #808080;">#include</span> <span style="color: #707183;">&lt;</span><span style="color: #008000;">unistd.h</span><span style="color: #707183;">&gt;</span>

<span style="color: #0000FF;">extern</span> <span style="color: #6434A3;">char</span> **<span style="color: #BA36A5;">environ</span>;

<span style="color: #6434A3;">int</span>
<span style="color: #006699;">execl</span><span style="color: #707183;">(</span><span style="color: #0000FF;">const</span> <span style="color: #6434A3;">char</span> *<span style="color: #BA36A5;">path</span>, <span style="color: #0000FF;">const</span> <span style="color: #6434A3;">char</span> *<span style="color: #BA36A5;">arg0</span>, ... <span style="color: #8D8D84;">/*</span><span style="color: #8D8D84; font-style: italic;">, (char *)0</span><span style="color: #8D8D84;"> */</span><span style="color: #707183;">)</span>;

<span style="color: #6434A3;">int</span>
<span style="color: #006699;">execle</span><span style="color: #707183;">(</span><span style="color: #0000FF;">const</span> <span style="color: #6434A3;">char</span> *<span style="color: #BA36A5;">path</span>, <span style="color: #0000FF;">const</span> <span style="color: #6434A3;">char</span> *<span style="color: #BA36A5;">arg0</span>, ...
       <span style="color: #8D8D84;">/*</span><span style="color: #8D8D84; font-style: italic;">, (char *)0, char *const envp[]</span><span style="color: #8D8D84;"> */</span><span style="color: #707183;">)</span>;

<span style="color: #6434A3;">int</span>
<span style="color: #006699;">execlp</span><span style="color: #707183;">(</span><span style="color: #0000FF;">const</span> <span style="color: #6434A3;">char</span> *<span style="color: #BA36A5;">file</span>, <span style="color: #0000FF;">const</span> <span style="color: #6434A3;">char</span> *<span style="color: #BA36A5;">arg0</span>, ... <span style="color: #8D8D84;">/*</span><span style="color: #8D8D84; font-style: italic;">, (char *)0</span><span style="color: #8D8D84;"> */</span><span style="color: #707183;">)</span>;

<span style="color: #6434A3;">int</span>
<span style="color: #006699;">execv</span><span style="color: #707183;">(</span><span style="color: #0000FF;">const</span> <span style="color: #6434A3;">char</span> *<span style="color: #BA36A5;">path</span>, <span style="color: #6434A3;">char</span> *<span style="color: #0000FF;">const</span> <span style="color: #BA36A5;">argv</span><span style="color: #7388D6;">[]</span><span style="color: #707183;">)</span>;

<span style="color: #6434A3;">int</span>
<span style="color: #006699;">execvp</span><span style="color: #707183;">(</span><span style="color: #0000FF;">const</span> <span style="color: #6434A3;">char</span> *<span style="color: #BA36A5;">file</span>, <span style="color: #6434A3;">char</span> *<span style="color: #0000FF;">const</span> <span style="color: #BA36A5;">argv</span><span style="color: #7388D6;">[]</span><span style="color: #707183;">)</span>;

<span style="color: #6434A3;">int</span>
<span style="color: #006699;">execvP</span><span style="color: #707183;">(</span><span style="color: #0000FF;">const</span> <span style="color: #6434A3;">char</span> *<span style="color: #BA36A5;">file</span>, <span style="color: #0000FF;">const</span> <span style="color: #6434A3;">char</span> *<span style="color: #BA36A5;">search_path</span>, <span style="color: #6434A3;">char</span> *<span style="color: #0000FF;">const</span> <span style="color: #BA36A5;">argv</span><span style="color: #7388D6;">[]</span><span style="color: #707183;">)</span>;
</pre>
</div>
<p>
各个函数之间的关系如下：
</p>

<div id="org1bbde73" class="figure">
<p><img src="reading/2020-11-08_19-42-53_screenshot.png" alt="2020-11-08_19-42-53_screenshot.png" />
</p>
</div>

<ul class="org-ul">
<li>注意事项：
<ol class="org-ol">
<li>file参数:
<ul class="org-ul">
<li>如果file包含/，就将其视为路径名</li>
<li>否则就按PATH环境变量指定的目录找名为file的可执行文件</li>
</ul></li>
<li>助记：
<ul class="org-ul">
<li>字母p(ath)表示取filename作为参数，并且用PATH环境变量寻找可执行文件。</li>
<li>字母l(ist)表示该函数取一个参数表，与互斥</li>
<li>字母(arg)v表示取一个argv[]矢量</li>
<li>字母e(nvp)表示该函数取envp[]数组，而不使用当前环境</li>
</ul></li>
</ol></li>

<li><p>
调用exec并不创建新进程，所以前后的进程ID并没有改变，只是用磁盘上的一个新程序替换了当前进程
的正文段，数据段，堆栈段。新进程从调用进程继承了下列属性：
</p>
<p>
<img src="reading/2020-11-08_18-59-31_screenshot.png" alt="2020-11-08_18-59-31_screenshot.png" />
对打开文件的处理与每个描述符的执行时关闭标志值有关。
</p></li>
</ul>
</div>
</li>
<li><a id="org3bd70f6"></a><span class="todo TODO">TODO</span> 更改用户ID和更改组ID<br /></li>
<li><a id="org1e4adeb"></a><span class="todo TODO">TODO</span> 解释器与system<br /></li>
<li><a id="org8fd22d3"></a><span class="todo TODO">TODO</span> 进程时间(程序8-31)<br /></li>
</ol>
</div>

<div id="outline-container-org2b01163" class="outline-4">
<h4 id="org2b01163"><span class="section-number-4">3.7.8</span> <span class="todo TODO">TODO</span> chapter9 进程关系 PASS</h4>
</div>
<div id="outline-container-org74a4c8d" class="outline-4">
<h4 id="org74a4c8d"><span class="section-number-4">3.7.9</span> chapter10 信号</h4>
<div class="outline-text-4" id="text-3-7-9">
<p>
ref:
</p>
<ol class="org-ol">
<li><a href="https://blog.csdn.net/gmq_syy/article/details/73800421">https://blog.csdn.net/gmq_syy/article/details/73800421</a></li>
</ol>
</div>
<ol class="org-ol">
<li><a id="orgd1d4467"></a>概念<br />
<div class="outline-text-5" id="text-3-7-9-1">
<ul class="org-ul">
<li>中断
操作系统中一个非常重要的概念就是中断，中断可以让程序执行异步操作。异步和同步相对，同步一般
意味着需要等待，所以异步可以带来很多好处。中断是指计算机在执行期间，系统内发生任何非寻常的
或非预期的急需处理事件，使得CPU暂时中断当前正在执行的程序而转去执行相应的事件处理程序，待
处理完毕后又返回原来被中断处继续执行或调度新的进程执行的过程。引起中断发生的事件被称为中断
源。中断源向CPU发出的请求中断处理信号称为中断请求，而CPU收到中断请求后转到相应的事件处理
程序称为中断响应。中断分为：
<ol class="org-ol">
<li>硬中断
通过硬件产生相应的中断请求，称为硬中断。</li>
<li>软中断</li>
</ol></li>
<li>软中断
软中断的概念主要来源于UNIX系统。软中断是对应于硬中断而言的。它是在通信进程之间通过模拟硬中断
而实现的一种通信方式。中断源发出软中断信号后，CPU或者接收进程在“适当的时机”进行中断处理或者
完成软中断信号所对应的功能。这里“适当的时机”，表示接收软中断信号的进程须等到该接收进程得到
处理器之后才能进行如果该接收进程是占据处理器的，那么，该接收进程在接收到软中断信号后将立即
转去执行该软中断信号所对应的功能。</li>
<li>信号
<ol class="org-ol">
<li>本质
信号是在软件层次上对中断机制的一种模拟，在原理上，一个进程收到一个信号与处理器收到一个
中断请求可以说是一样的。</li>
<li>来源
<ul class="org-ul">
<li>硬件来源
比如我们按下了键盘或者其它硬件故障</li>
<li>软件来源
最常用发送信号的系统函数是kill, raise, alarm和setitimer以及sigqueue函数，
软件来源还包括一些非法运算等操作。</li>
</ul></li>
<li>分类
<ul class="org-ul">
<li>按可靠性：可靠和不可靠</li>
<li>按实时性：实时和非实时</li>
</ul></li>
</ol></li>
</ul>
</div>
</li>
<li><a id="org856adf6"></a>信号产生条件<br />
<div class="outline-text-5" id="text-3-7-9-2">
<ol class="org-ol">
<li>按下某些终端键</li>
<li>硬件异常产生信号：除0、无效的内存引用</li>
<li>kill系统调用</li>
<li>kill命令行命令</li>
<li>当检测到某种软件条件已经发生</li>
</ol>
</div>
</li>
<li><a id="orga931561"></a>处理信号的三种方式<br />
<div class="outline-text-5" id="text-3-7-9-3">
<ol class="org-ol">
<li>忽略
有两种不能忽略SIGKILL SIGSTOP</li>
<li>捕捉信号
收到信号时，调用预先设定好的用户函数</li>
<li><p>
执行系统默认动作
</p>

<div id="orgbb57dff" class="figure">
<p><img src="reading/2020-11-09_20-20-58_screenshot.png" alt="2020-11-09_20-20-58_screenshot.png" />
</p>
</div></li>
</ol>
</div>
</li>
<li><a id="orgb627eee"></a>signal函数<br />
<div class="outline-text-5" id="text-3-7-9-4">
<p>
signal函数表示为sig信号设置信号处理函数
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #808080;">#include</span> <span style="color: #707183;">&lt;</span><span style="color: #008000;">signal.h</span><span style="color: #707183;">&gt;</span>

<span style="color: #6434A3;">void</span> <span style="color: #707183;">(</span>*<span style="color: #006699;">signal</span><span style="color: #7388D6;">(</span><span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">sig</span>, <span style="color: #6434A3;">void</span> <span style="color: #909183;">(</span>*<span style="color: #006699;">func</span><span style="color: #909183;">)(</span><span style="color: #6434A3;">int</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)(</span><span style="color: #6434A3;">int</span><span style="color: #707183;">)</span>;

or in the equivalent but easier to <span style="color: #6434A3;">read</span> <span style="color: #0000FF;">typedef</span><span style="color: #ff0000; font-weight: bold;">'</span>d version:

<span style="color: #0000FF;">typedef</span> <span style="color: #6434A3;">void</span> <span style="color: #707183;">(</span>*sig_t<span style="color: #707183;">)</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">int</span><span style="color: #707183;">)</span>;

<span style="color: #6434A3;">sig_t</span>
<span style="color: #006699;">signal</span><span style="color: #707183;">(</span><span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">sig</span>, <span style="color: #6434A3;">sig_t</span> <span style="color: #BA36A5;">func</span><span style="color: #707183;">)</span>;
</pre>
</div>
<p>
参数sig：信号名
func：新的信号调用函数, 可以是自定义的用户空间函数，
      也可以是SIG<sub>IGN</sub>(ignore),SIG<sub>DFL</sub>(default)
返回值：旧的信号处理函数,或SIG<sub>ERR表示出错</sub>
</p>
</div>
</li>
<li><a id="orgb9b2aeb"></a>fork和exec时信号的继承<br />
<div class="outline-text-5" id="text-3-7-9-5">
<ul class="org-ul">
<li>fork
当一个进程调用fork时，其子进程继承父进程的信号处理方式。因为子进程在开始时复制了父进程
的内存映像，所以信号捕捉函数的地址在子进程中是有意义的。</li>
<li>exec
当调用exec运行新程序时，除非 <b>调用</b> exec的进程忽略该信号，否则所有信号都被设置为它们
的默认动作</li>
</ul>
</div>
</li>

<li><a id="orgdd22922"></a>可靠信号与信号阻塞<br />
<div class="outline-text-5" id="text-3-7-9-6">
<p>
早期的unix中，信号是不可靠的,这里的不可靠指的是：
</p>
<ol class="org-ol">
<li>信号可能会丢失，因为没有保存(阻塞)信号的能力</li>
<li>进程每次接到信号对其进行处理时，随机该信号动作的动作重置为默认值</li>
</ol>

<p>
4.2BSD对信号进行了改动，提供了可靠的信号机制：
</p>
</div>
<ol class="org-ol">
<li><a id="org5335108"></a>可靠信号<br />
<div class="outline-text-6" id="text-3-7-9-6-1">
<ul class="org-ul">
<li>产生信号
当造成信号的事件发生时，为进程产生一个信号</li>
<li>递送信号
当内核在进程表中以某种形式设置标志表明产生信号时，称为递送了信号</li>
<li>阻塞信号的递送
进程可以设置信号为阻塞的，这种情况下，信号的递送被阻塞，</li>
<li>未决pending
产生信号开始，到递送信号完成之前；或者是信号被进程阻塞(而且进程对该信号的动作是系统默认
动作或捕捉该信号),则该进程为未决状态</li>
<li>多次递送信号
如果在进程解除对某个信号的阻塞之前，信号递送了多次，则称信号进行了排队。除非支持posix实时
扩展，否则大多数uinx并不对信号排队，而是只递送这种信号一次</li>
</ul>
</div>
</li>
</ol>
</li>
<li><a id="org860ca40"></a>被信号中断的系统调用<br />
<div class="outline-text-5" id="text-3-7-9-7">
<p>
早期unix系统的一个特性是：如果进程执行一个 <b>低速系统调用</b> 而阻塞期间捕捉到一个
信号，则该系统调用就被中断而不再继续执行。该系统调用返回出错并且errno设置为
EINTR。TODO: 非低速系统调用自动重启吗？
其中低速系统调用是指可能会使进程永远阻塞的一类系统调用，包括以下几类：
</p>
<p>
<img src="reading/2020-11-10_15-42-21_screenshot.png" alt="2020-11-10_15-42-21_screenshot.png" />
     为了帮助应用程序，使得其不必处理被中断的系统调用，4.2BSD开始引入的中断系统调用的自动重启,
     下面为几种实现所提供的与信号有关的函数与语义：
</p>

<div id="orgad3fa63" class="figure">
<p><img src="reading/2020-11-10_15-49-33_screenshot.png" alt="2020-11-10_15-49-33_screenshot.png" />
</p>
</div>
</div>
</li>

<li><a id="org00b6f75"></a><span class="todo TODO">TODO</span> 可重入函数<br /></li>
<li><a id="orga191f69"></a>kill和raise<br />
<div class="outline-text-5" id="text-3-7-9-9">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #808080;">#include</span> <span style="color: #707183;">&lt;</span><span style="color: #008000;">signal.h</span><span style="color: #707183;">&gt;</span>

<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#23558;&#20449;&#21495;&#21457;&#36865;&#32473;&#36827;&#31243;&#25110;&#36827;&#31243;&#32452;</span><span style="color: #8D8D84;"> */</span>
<span style="color: #6434A3;">int</span>
<span style="color: #006699;">kill</span><span style="color: #707183;">(</span><span style="color: #6434A3;">pid_t</span> <span style="color: #BA36A5;">pid</span>, <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">sig</span><span style="color: #707183;">)</span>;



<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#36827;&#31243;&#21521;&#33258;&#24049;&#21457;&#36865;&#20449;&#21495;</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#include</span> <span style="color: #707183;">&lt;</span><span style="color: #008000;">signal.h</span><span style="color: #707183;">&gt;</span>

<span style="color: #6434A3;">int</span>
<span style="color: #006699;">raise</span><span style="color: #707183;">(</span><span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">sig</span><span style="color: #707183;">)</span>;
</pre>
</div>
<p>
kill的pid参数有如下几种情况：
</p>
<ol class="org-ol">
<li>pid &gt; 0
将信号发送给进程id为pid的进程</li>
<li>pid == 0
发送给该进程所在进程组的所有进程,发送进程必须有权限</li>
<li>pid &lt; 0
发送给进程中ID为-pid的所有进程，调用进程必须有权限</li>
<li>pid == -1
发送给调用进程有权限发送信号的所有进程</li>
</ol>
<p>
注：上面所说的所有进程，不包括系统进程集(内核进程和init进程(pid为1))
</p>
</div>
</li>
<li><a id="org4658edd"></a>alarm和pause<br />
<div class="outline-text-5" id="text-3-7-9-10">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #808080;">#include</span> <span style="color: #707183;">&lt;</span><span style="color: #008000;">unistd.h</span><span style="color: #707183;">&gt;</span>

<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#35774;&#32622;&#19968;&#20010;&#23450;&#26102;&#22120;&#65292;&#24403;&#36229;&#26102;&#26102;&#20135;&#29983;&#19968;&#20010;SIGALRM&#20449;&#21495;</span><span style="color: #8D8D84;"> */</span>
<span style="color: #6434A3;">unsigned</span>
<span style="color: #006699;">alarm</span><span style="color: #707183;">(</span><span style="color: #6434A3;">unsigned</span> <span style="color: #BA36A5;">seconds</span><span style="color: #707183;">)</span>;


<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#20351;&#35843;&#29992;&#36827;&#31243;&#25346;&#36215;&#30452;&#21040;&#25429;&#25417;&#21040;&#19968;&#20010;&#20449;&#21495;</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#include</span> <span style="color: #707183;">&lt;</span><span style="color: #008000;">unistd.h</span><span style="color: #707183;">&gt;</span>

<span style="color: #6434A3;">int</span>
<span style="color: #006699;">pause</span><span style="color: #707183;">(</span><span style="color: #6434A3;">void</span><span style="color: #707183;">)</span>;
</pre>
</div>
</div>
</li>
<li><a id="orgdd27f1e"></a>信号集<br />
<div class="outline-text-5" id="text-3-7-9-11">
<p>
用来表示信号的数据结构为信号集(sigset), posix定义了下列五个处理信号集的函数:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #808080;">#include</span> <span style="color: #707183;">&lt;</span><span style="color: #008000;">signal.h</span><span style="color: #707183;">&gt;</span>

<span style="color: #6434A3;">int</span>
<span style="color: #006699;">sigaddset</span><span style="color: #707183;">(</span><span style="color: #6434A3;">sigset_t</span> *<span style="color: #BA36A5;">set</span>, <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">signo</span><span style="color: #707183;">)</span>;

<span style="color: #6434A3;">int</span>
<span style="color: #006699;">sigdelset</span><span style="color: #707183;">(</span><span style="color: #6434A3;">sigset_t</span> *<span style="color: #BA36A5;">set</span>, <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">signo</span><span style="color: #707183;">)</span>;

<span style="color: #6434A3;">int</span>
<span style="color: #006699;">sigemptyset</span><span style="color: #707183;">(</span><span style="color: #6434A3;">sigset_t</span> *<span style="color: #BA36A5;">set</span><span style="color: #707183;">)</span>;

<span style="color: #6434A3;">int</span>
<span style="color: #006699;">sigfillset</span><span style="color: #707183;">(</span><span style="color: #6434A3;">sigset_t</span> *<span style="color: #BA36A5;">set</span><span style="color: #707183;">)</span>;

<span style="color: #6434A3;">int</span>
<span style="color: #006699;">sigismember</span><span style="color: #707183;">(</span><span style="color: #0000FF;">const</span> <span style="color: #6434A3;">sigset_t</span> *<span style="color: #BA36A5;">set</span>, <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">signo</span><span style="color: #707183;">)</span>;
</pre>
</div>
</div>
</li>
<li><a id="org3f74508"></a>sigpending<br />
<div class="outline-text-5" id="text-3-7-9-12">
<p>
sigpending返回当前未决的信号
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #808080;">#include</span> <span style="color: #707183;">&lt;</span><span style="color: #008000;">signal.h</span><span style="color: #707183;">&gt;</span>

<span style="color: #6434A3;">int</span>
<span style="color: #006699;">sigpending</span><span style="color: #707183;">(</span><span style="color: #6434A3;">sigset_t</span> *<span style="color: #BA36A5;">set</span><span style="color: #707183;">)</span>;
</pre>
</div>
<p>
<a href="file:///Users/binbinyang/learning/apue/apue.3e/mycode/chapter10/10-15.c">10-15.c</a> 
</p>
</div>
</li>
<li><a id="orgec64e02"></a>sigaction函数<br />
<div class="outline-text-5" id="text-3-7-9-13">
<p>
sigaction函数的功能是检查或修改(或检查并修改)与指定信号相关联的处理动作。
</p>
<div class="org-src-container">
<pre class="src src-c">
<span style="color: #808080;">#include</span> <span style="color: #707183;">&lt;</span><span style="color: #008000;">signal.h</span><span style="color: #707183;">&gt;</span>

<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#22797;&#21046;&#33258;macos &#19979;&#30340;man&#65292;&#19982;&#20070;&#19978;&#26377;&#21306;&#21035;</span><span style="color: #8D8D84;"> */</span>
<span style="color: #0000FF;">struct</span>  <span style="color: #6434A3;">sigaction</span> <span style="color: #707183;">{</span>
  <span style="color: #0000FF;">union</span> <span style="color: #6434A3;">__sigaction_u</span> <span style="color: #BA36A5;">__sigaction_u</span>;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">signal handler</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#22914;&#26524;sa_handler&#21253;&#21547;&#33258;&#23450;&#20041;&#30340;&#25429;&#25417;&#20989;&#25968;&#65292;&#21017;sa_mask&#23383;&#27573;&#35828;&#26126;&#20102;&#19968;&#20010;&#20449;&#21495;&#38598;</span>
<span style="color: #8D8D84; font-style: italic;">   * &#22312;&#35843;&#29992;&#25429;&#25417;&#20989;&#25968;&#20043;&#21069;&#38459;&#22622;&#36825;&#20123;&#20449;&#21495;&#65292;&#35843;&#29992;&#23436;&#21518;&#20877;&#24674;&#22797;</span>
<span style="color: #8D8D84;">   */</span>
  <span style="color: #6434A3;">sigset_t</span> <span style="color: #BA36A5;">sa_mask</span>;               <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">signal mask to apply</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#23545;&#20449;&#21495;sig&#36827;&#34892;&#22788;&#29702;&#30340;&#21508;&#31181;&#36873;&#39033;,&#20855;&#20307;&#35265;&#20195;&#30721;&#19979;&#30340;&#22270;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">int</span>     <span style="color: #BA36A5;">sa_flags</span>;               <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">see signal options below</span><span style="color: #8D8D84;"> */</span>
<span style="color: #707183;">}</span>;

<span style="color: #0000FF;">union</span> <span style="color: #6434A3;">__sigaction_u</span> <span style="color: #707183;">{</span>
  <span style="color: #6434A3;">void</span>    <span style="color: #7388D6;">(</span>*<span style="color: #006699;">__sa_handler</span><span style="color: #7388D6;">)(</span><span style="color: #6434A3;">int</span><span style="color: #7388D6;">)</span>;
  <span style="color: #6434A3;">void</span>    <span style="color: #7388D6;">(</span>*<span style="color: #006699;">__sa_sigaction</span><span style="color: #7388D6;">)(</span><span style="color: #6434A3;">int</span>, <span style="color: #6434A3;">siginfo_t</span> *,
                            <span style="color: #6434A3;">void</span> *<span style="color: #7388D6;">)</span>;
<span style="color: #707183;">}</span>;

<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">sa_handler</span>      __sigaction_u.__sa_handler
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">sa_sigaction</span>    __sigaction_u.__sa_sigaction

<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#35201;&#20462;&#25913;&#30340;&#21160;&#20316;&#23384;&#22312;act&#65292;&#19978;&#19968;&#20010;&#21160;&#20316;&#36820;&#22238;&#21040;oact</span><span style="color: #8D8D84;"> */</span>
<span style="color: #6434A3;">int</span>
<span style="color: #006699;">sigaction</span><span style="color: #707183;">(</span><span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">sig</span>, <span style="color: #0000FF;">const</span> <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">sigaction</span> *<span style="color: #0000FF;">restrict</span> <span style="color: #BA36A5;">act</span>,
          <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">sigaction</span> *<span style="color: #0000FF;">restrict</span> <span style="color: #BA36A5;">oact</span><span style="color: #707183;">)</span>;
</pre>
</div>

<div id="orgfb53154" class="figure">
<p><img src="reading/2020-11-11_14-34-39_screenshot.png" alt="2020-11-11_14-34-39_screenshot.png" />
</p>
</div>
</div>
</li>

<li><a id="org8c192ed"></a><span class="todo TODO">TODO</span> sigsetjmp和siglongjmp<br /></li>
<li><a id="org1dd21da"></a>sigsuspend<br />
<div class="outline-text-5" id="text-3-7-9-15">
<p>
当我们希望保护代码临界区不被某些信号中断，可以用sigsuspend函数
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #808080;">#include</span> <span style="color: #707183;">&lt;</span><span style="color: #008000;">signal.h</span><span style="color: #707183;">&gt;</span>

<span style="color: #6434A3;">int</span>
<span style="color: #006699;">sigsuspend</span><span style="color: #707183;">(</span><span style="color: #0000FF;">const</span> <span style="color: #6434A3;">sigset_t</span> *<span style="color: #BA36A5;">sigmask</span><span style="color: #707183;">)</span>;
</pre>
</div>
<p>
它的作用是在执行完临界区代码后原子地恢复信号屏蔽字，然后使得进程休眠。
这样就可以防止sigprocmask函数恢复屏蔽字和调用pause接受进程之间的空档
</p>
</div>
</li>
<li><a id="orga7f2668"></a><span class="todo TODO">TODO</span> abort<br />
<div class="outline-text-5" id="text-3-7-9-16">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #808080;">#include</span> <span style="color: #707183;">&lt;</span><span style="color: #008000;">stdlib.h</span><span style="color: #707183;">&gt;</span>

<span style="color: #6434A3;">void</span>
<span style="color: #006699;">abort</span><span style="color: #707183;">(</span><span style="color: #6434A3;">void</span><span style="color: #707183;">)</span>;
</pre>
</div>
</div>
</li>
<li><a id="org8fb87e2"></a><span class="todo TODO">TODO</span> system<br /></li>
<li><a id="org1399c65"></a><span class="todo TODO">TODO</span> sleep<br />
<div class="outline-text-5" id="text-3-7-9-18">
<p>
sleep函数是通过alarm和信号实现的
</p>
</div>
</li>
<li><a id="org40d0c04"></a>sigqueue<br />
<div class="outline-text-5" id="text-3-7-9-19">
<p>
可以对信号实现排队
</p>
</div>
</li>
<li><a id="orga35f139"></a>小结<br />
<div class="outline-text-5" id="text-3-7-9-20">
<p>
信号用于大多数复制的应用程序中，理解进行信号处理的原因和方式对于高级unix编程
<b>极其重要</b> 
</p>
</div>
</li>
</ol>
</div>
<div id="outline-container-orgf10638d" class="outline-4">
<h4 id="orgf10638d"><span class="section-number-4">3.7.10</span> <span class="todo TODO">TODO</span> chapter11 线程</h4>
<div class="outline-text-4" id="text-3-7-10">
</div>
<ol class="org-ol">
<li><a id="org844255a"></a>线程的优点<br />
<div class="outline-text-5" id="text-3-7-10-1">
<p>
典型的unix进程在某一时刻只能做一件事情。有了线程后，程序设计就可以把程序设计成
在某一时刻能够做不止一件事，每个线程处理各自独立的任务。这中方法有很多好处：
</p>
<ol class="org-ol">
<li>可以简化处理异步事件的代码。</li>
<li>多个线程可以自动地访问相同的存储地址空间和文件描述符,不像进程那么复杂</li>
<li>有些问题可以分解从而提高整个程序的吞吐量</li>
<li>可以改善交互程序的响应时间</li>
</ol>
<p>
<b>单cpu也能得到多线程编程模型的好处</b>
</p>
</div>
</li>
<li><a id="orgf20279e"></a>创建线程<br />
<div class="outline-text-5" id="text-3-7-10-2">
<p>
每个线程都有一个线程ID pthread<sub>t</sub>，线程创建相关函数有：
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #808080;">#include</span> <span style="color: #707183;">&lt;</span><span style="color: #008000;">pthread.h</span><span style="color: #707183;">&gt;</span>

<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#21019;&#24314;&#26032;&#32447;&#31243;</span><span style="color: #8D8D84;"> */</span>
<span style="color: #6434A3;">int</span>
<span style="color: #006699;">pthread_create</span><span style="color: #707183;">(</span><span style="color: #6434A3;">pthread_t</span> *<span style="color: #BA36A5;">thread</span>,       <span style="color: #8D8D84;">//</span><span style="color: #8D8D84; font-style: italic;">&#20445;&#23384;&#26032;&#32447;&#31243;&#30340;id</span>
               <span style="color: #0000FF;">const</span> <span style="color: #6434A3;">pthread_attr_t</span> *<span style="color: #BA36A5;">attr</span>,  <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">&#23450;&#21046;&#21508;&#31181;&#19981;&#21516;&#30340;&#32447;&#31243;&#23646;&#24615;</span>
               <span style="color: #6434A3;">void</span> *<span style="color: #7388D6;">(</span>*<span style="color: #006699;">start_routine</span><span style="color: #7388D6;">)(</span><span style="color: #6434A3;">void</span> *<span style="color: #7388D6;">)</span>, <span style="color: #8D8D84;">//</span><span style="color: #8D8D84; font-style: italic;">&#26032;&#32447;&#31243;&#20174;start_rtn&#20989;&#25968;&#24320;&#22987;&#36816;&#34892;</span>
               <span style="color: #6434A3;">void</span> *<span style="color: #BA36A5;">arg</span><span style="color: #707183;">)</span>; <span style="color: #8D8D84;">//</span><span style="color: #8D8D84; font-style: italic;">start_rtn&#21442;&#25968;</span>

<span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">&#21028;&#26029;&#32447;&#31243;id&#26159;&#21542;&#30456;&#31561;, &#19981;&#33021;&#30452;&#25509;==&#65292;&#22240;&#20026;pthread_t&#21487;&#33021;&#26159;&#32467;&#26500;&#20307;(&#20855;&#20307;&#23454;&#29616;)</span>
<span style="color: #6434A3;">int</span> <span style="color: #006699;">pthread_equal</span><span style="color: #707183;">(</span><span style="color: #6434A3;">pthread_t</span> <span style="color: #BA36A5;">tid1</span>, <span style="color: #6434A3;">pthread_t</span> <span style="color: #BA36A5;">tid2</span><span style="color: #707183;">)</span>;

<span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">&#33719;&#24471;&#33258;&#36523;&#30340;&#32447;&#31243;ID</span>
<span style="color: #6434A3;">pthread_t</span>
<span style="color: #006699;">pthread_self</span><span style="color: #707183;">(</span><span style="color: #6434A3;">void</span><span style="color: #707183;">)</span>;
</pre>
</div>
<p>
新创建的线程可以访问进程的地址空间，并且继承调用线程的浮点环境和信号屏蔽字，但线程的
挂起信号集被清除
</p>
</div>
</li>
<li><a id="org65b0a61"></a>终止线程<br />
<div class="outline-text-5" id="text-3-7-10-3">
<p>
下列方式会终止整个进程：
</p>
<ol class="org-ol">
<li>进程中任意线程调用了exit、<sub>exit或</sub><sub>Exit</sub></li>
<li>线程收到信号，并且动作是终止进程</li>
</ol>

<p>
下列三个方法能在不终止整个进程的情况下停止单个线程：
</p>
<ol class="org-ol">
<li><p>
线程可以简单地从启动例程返回(return)，返回值是线程的退出码
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #808080;">#include</span> <span style="color: #707183;">&lt;</span><span style="color: #008000;">pthread.h</span><span style="color: #707183;">&gt;</span>

<span style="color: #6434A3;">void</span>
<span style="color: #006699;">pthread_exit</span><span style="color: #707183;">(</span><span style="color: #6434A3;">void</span> *<span style="color: #BA36A5;">value_ptr</span><span style="color: #707183;">)</span>;
</pre>
</div>
<p>
进程的其他线程通过pthread<sub>join等待线程结束并访问value</sub><sub>ptr</sub>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #808080;">#include</span> <span style="color: #707183;">&lt;</span><span style="color: #008000;">pthread.h</span><span style="color: #707183;">&gt;</span>

<span style="color: #6434A3;">int</span>
<span style="color: #006699;">pthread_join</span><span style="color: #707183;">(</span><span style="color: #6434A3;">pthread_t</span> <span style="color: #BA36A5;">thread</span>, <span style="color: #6434A3;">void</span> **<span style="color: #BA36A5;">value_ptr</span><span style="color: #707183;">)</span>;
</pre>
</div></li>
<li><p>
线程可以被同一进程的其他线程取消：
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #808080;">#include</span> <span style="color: #707183;">&lt;</span><span style="color: #008000;">pthread.h</span><span style="color: #707183;">&gt;</span>

<span style="color: #6434A3;">int</span>
<span style="color: #006699;">pthread_cancel</span><span style="color: #707183;">(</span><span style="color: #6434A3;">pthread_t</span> <span style="color: #BA36A5;">thread</span><span style="color: #707183;">)</span>;
</pre>
</div></li>

<li>线程调用pthread<sub>exit</sub></li>
</ol>
</div>
</li>

<li><a id="orge000d05"></a>分离线程<br />
<div class="outline-text-5" id="text-3-7-10-4">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #808080;">#include</span> <span style="color: #707183;">&lt;</span><span style="color: #008000;">pthread.h</span><span style="color: #707183;">&gt;</span>

<span style="color: #6434A3;">int</span>
<span style="color: #006699;">pthread_detach</span><span style="color: #707183;">(</span><span style="color: #6434A3;">pthread_t</span> <span style="color: #BA36A5;">thread</span><span style="color: #707183;">)</span>;
</pre>
</div>
<p>
默认情况下，线程的终止状态会保存知道对线程调用pthread<sub>join</sub>, 调用pthread<sub>detach后</sub>，
线程会被分离，线程的底层存储资源可以在线程终止时立即回收。分离后不能再对该线程调用
pthread<sub>join</sub>.
</p>
</div>
</li>
<li><a id="orga8aaf88"></a><span class="todo TODO">TODO</span> 线程清理处理程序<br /></li>
<li><a id="org3ca3f12"></a>线程同步<br />
<ol class="org-ol">
<li><a id="org8dbca33"></a>自旋锁<br />
<div class="outline-text-6" id="text-3-7-10-6-1">
<ul class="org-ul">
<li>概念
自旋锁是通过在获取锁前一直处于忙等状态的一种锁。</li>
<li>适用情况
<ol class="org-ol">
<li>自旋锁适用于锁被持有的时间短，而且线程并不希望在重新调度上化太多成本</li>
<li>自旋锁用在非抢占式内核中是很有用的：除了提供互斥机制，他们还会阻塞中断</li>
<li>自旋锁在用户层并不一定非常有用，因为获取自旋锁的线程可能会被取消调度而
进入休眠状态，那么阻塞在锁上的其他线程自旋的时间就可能会比预期的更长</li>
</ol></li>
<li>实现
一般可以通过使用 <b>测试并设置</b> 指令实现</li>
</ul>
</div>
</li>

<li><a id="orgc059898"></a>互斥量<br />
<div class="outline-text-6" id="text-3-7-10-6-2">
<p>
互斥量保证同一时间只有一个线程访问数据。如果释放互斥量时有一个以上的线程阻塞，那么所有
该锁上的阻塞线程都会变成可运行状态，第一个变为运行的线程可以对互斥量加锁
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #808080;">#include</span> <span style="color: #707183;">&lt;</span><span style="color: #008000;">pthread.h</span><span style="color: #707183;">&gt;</span>

<span style="color: #6434A3;">int</span>
<span style="color: #006699;">pthread_mutex_init</span><span style="color: #707183;">(</span><span style="color: #6434A3;">pthread_mutex_t</span> *<span style="color: #BA36A5;">mutex</span>,
                   <span style="color: #0000FF;">const</span> <span style="color: #6434A3;">pthread_mutexattr_t</span> *<span style="color: #BA36A5;">attr</span><span style="color: #707183;">)</span>;

<span style="color: #6434A3;">int</span>
<span style="color: #006699;">pthread_mutex_destroy</span><span style="color: #707183;">(</span><span style="color: #6434A3;">pthread_mutex_t</span> *<span style="color: #BA36A5;">mutex</span><span style="color: #707183;">)</span>;

<span style="color: #6434A3;">int</span>
<span style="color: #006699;">pthread_mutex_lock</span><span style="color: #707183;">(</span><span style="color: #6434A3;">pthread_mutex_t</span> *<span style="color: #BA36A5;">mutex</span><span style="color: #707183;">)</span>;

<span style="color: #6434A3;">int</span>
<span style="color: #006699;">pthread_mutex_trylock</span><span style="color: #707183;">(</span><span style="color: #6434A3;">pthread_mutex_t</span> *<span style="color: #BA36A5;">mutex</span><span style="color: #707183;">)</span>;

<span style="color: #6434A3;">int</span>
<span style="color: #006699;">pthread_mutex_unlock</span><span style="color: #707183;">(</span><span style="color: #6434A3;">pthread_mutex_t</span> *<span style="color: #BA36A5;">mutex</span><span style="color: #707183;">)</span>;
</pre>
</div>
</div>
</li>
<li><a id="orgde4eb5d"></a>读写锁<br /></li>
<li><a id="org52e4678"></a>条件变量<br /></li>
<li><a id="org509e088"></a>屏障<br /></li>
</ol>
</li>
<li><a id="org4c54476"></a><span class="todo TODO">TODO</span> 线程控制<br /></li>
</ol>
</div>
<div id="outline-container-org9a9d501" class="outline-4">
<h4 id="org9a9d501"><span class="section-number-4">3.7.11</span> <span class="todo TODO">TODO</span> chapter12</h4>
</div>
<div id="outline-container-org1e2e85e" class="outline-4">
<h4 id="org1e2e85e"><span class="section-number-4">3.7.12</span> 守护进程(daemon)</h4>
<div class="outline-text-4" id="text-3-7-12">
<p>
守护进程是生存期长的一种进程。他们常常在系统引导装入时启动，仅在系统关闭时才终止。
</p>
</div>
<ol class="org-ol">
<li><a id="org71f5ddd"></a>编程规则(创建过程)<br />
<div class="outline-text-5" id="text-3-7-12-1">
<ol class="org-ol">
<li>调用umask将文件模式创建屏蔽字设置为一个固定值（通常是0）。
因为继承来的屏蔽字可能被设置为拒绝某些权限</li>
<li>调用fork，然后使父进程exit。
理由：
<ul class="org-ul">
<li>当守护进程由一条简单的shell命令启动，父进程exit会让shell认为这条命令已经
执行完毕。</li>
<li>fork保证子进程不是一个进程组的组长（继承了父进程的进程组ID，但是获得了新的进程ID）,
为第三步做准备</li>
</ul></li>
<li>调用setsid创建一个新的会话。
作用：
<ul class="org-ul">
<li>成为新会话的首进程</li>
<li>成为一个新进程组的组长进程</li>
<li>没有控制终端</li>
</ul></li>
<li>将当前工作目录改为根目录
因为父进程的当前工作目录可能在一个挂载的文件系统中，如果不改变，那么这个文件系统在
守护进程运行过程中都不能被卸载</li>
<li>关闭不再需要的文件描述符。
和父进程脱离联系</li>
<li>将0，1，2文件描述符重定向到/dev/null</li>
</ol>
</div>
</li>
<li><a id="org39bde13"></a>出错(日志)记录<br />
<div class="outline-text-5" id="text-3-7-12-2">
<p>
守护进程存在的一个问题是如何处理出错信息,首先守护进程肯定不能把日志直接输出控制台，然后，
我们也不希望每个守护进程一个日志文件，这样太难管理。为此，大多数守护进程都使用syslog设施：
</p>
<p>
<img src="reading/2020-11-14_15-15-52_screenshot.png" alt="2020-11-14_15-15-52_screenshot.png" />
     可以看到，有三种途径产生日志消息：
</p>

<div id="org5487af2" class="figure">
<p><img src="reading/2020-11-14_15-24-57_screenshot.png" alt="2020-11-14_15-24-57_screenshot.png" />
</p>
</div>
</div>
</li>

<li><a id="orgdf400ad"></a>单例守护进程<br />
<div class="outline-text-5" id="text-3-7-12-3">
<p>
使用文件和记录锁
</p>
</div>
</li>
<li><a id="orgfc94272"></a>守护进程惯例<br />
<div class="outline-text-5" id="text-3-7-12-4">

<div id="org56b2c20" class="figure">
<p><img src="reading/2020-11-14_15-53-21_screenshot.png" alt="2020-11-14_15-53-21_screenshot.png" />
</p>
</div>
</div>
</li>
</ol>
</div>
</div>

<div id="outline-container-orgcfc7450" class="outline-3">
<h3 id="orgcfc7450"><span class="section-number-3">3.8</span> tlpi</h3>
<div class="outline-text-3" id="text-3-8">
</div>
<div id="outline-container-org91c0418" class="outline-4">
<h4 id="org91c0418"><span class="section-number-4">3.8.1</span> 第四章</h4>
<div class="outline-text-4" id="text-3-8-1">
<p>
一旦应用程序需要访问文件系统或设备的专有功能时，可以选择瑞士军刀般的 ioctl()系统 调用(4.8 节)，该调用为通用 I/O 模型之外的专有特性提供了访问接口。
</p>
</div>
</div>
<div id="outline-container-org1862853" class="outline-4">
<h4 id="org1862853"><span class="section-number-4">3.8.2</span> 5</h4>
<div class="outline-text-4" id="text-3-8-2">
<p>
所有系统调用都是以原子操作方式执行的。
</p>
</div>
</div>
<div id="outline-container-org29b0c6f" class="outline-4">
<h4 id="org29b0c6f"><span class="section-number-4">3.8.3</span> ipc</h4>
<div class="outline-text-4" id="text-3-8-3">
<p>
信号(signal)，用来表示事件的发生。
管道(亦即 shell 用户所熟悉的“|”操作符)和 FIFO，用于在进程间传递数据。
套接字，供同一台主机或是联网的不同主机上所运行的进程之间传递数据。
文件锁定，为防止其他进程读取或更新文件内容，允许某进程对文件的部分区域加以锁定。
消息队列，用于在进程间交换消息(数据包)。
信号量(semaphore)，用来同步进程动作。
共享内存，允许两个及两个以上进程共享一块内存。当某进程改变了共享内存的内容时，其他所有进程会立即了解到这一变化。
</p>
</div>
</div>
</div>
<div id="outline-container-orga97302d" class="outline-3">
<h3 id="orga97302d"><span class="section-number-3">3.9</span> <span class="todo TODO">TODO</span> 内核架构 <a href="file:///Users/binbinyang/Documents/深入Linux内核架构(英文版).pdf">pdf</a></h3>
<div class="outline-text-3" id="text-3-9">
</div>
<div id="outline-container-orge885e1f" class="outline-4">
<h4 id="orge885e1f"><span class="section-number-4">3.9.1</span> 进程管理与调度</h4>
<div class="outline-text-4" id="text-3-9-1">
</div>
<ol class="org-ol">
<li><a id="orga3ba6a7"></a>task<sub>struct</sub><br />
<div class="outline-text-5" id="text-3-9-1-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">task_struct</span> <span style="color: #707183;">{</span>
   - TASK_RUNNING&#65306; &#21487;&#36816;&#34892;&#29366;&#24577;&#12290;&#35813;&#29366;&#24577;&#30830;&#20445;&#36827;&#31243;&#21487;&#20197;&#31435;&#21363;&#36816;&#34892;&#65292;&#32780;&#26080;&#38656;&#31561;&#24453;&#22806;&#37096;&#26465;&#20214;
   - TASK_INTERRRUPTIBLE&#65306;&#38024;&#23545;&#31561;&#24453;&#26576;&#20107;&#20214;&#25110;&#20854;&#20182;&#36164;&#28304;&#30340;&#30561;&#30496;&#36827;&#31243;&#35774;&#32622;&#30340;&#12290;&#22312;&#20869;&#26680;&#21457;&#36865;&#20449;&#21495;&#32473;
     &#36827;&#31243;&#34920;&#26126;&#20107;&#20214;&#24050;&#32463;&#21457;&#29983;&#26102;&#65292;&#36827;&#31243;&#29366;&#24577;&#21464;&#20026;TASK_RUNNING&#12290;
   - TASK_UNINTERRRUPTIBLE&#65306;&#22240;&#20869;&#26680;&#25351;&#31034;&#32780;&#20572;&#29992;&#30340;&#36827;&#31243;&#65292;&#19981;&#33021;&#30001;&#22806;&#37096;&#20449;&#21495;&#21796;&#37266;&#65292;&#21482;&#33021;&#30001;&#20869;&#26680;&#20146;&#33258;&#21796;&#37266;
   - TASK_STOPPED &#65306;&#29305;&#24847;&#20572;&#27490;&#36816;&#34892;&#65292;&#22914;&#35843;&#35797;
   - TASK_TRACED&#65306;&#21306;&#20998;&#20572;&#27490;&#30340;&#36827;&#31243;&#20013;&#34987;&#35843;&#35797;&#30340;&#36827;&#31243;&#21644;&#24120;&#35268;&#30340;&#36827;&#31243;
   - EXIT_ZOMEIE &#20725;&#23608;&#36827;&#31243;
   - EXIT_DEAD wait&#31995;&#32479;&#35843;&#29992;&#24050;&#32463;&#21457;&#20986;&#65292;&#22312;&#36827;&#31243;&#23436;&#20840;&#20174;&#31995;&#32479;&#20013;&#31227;&#38500;&#20043;&#21069;&#30340;&#29366;&#24577;&#65292;&#21482;&#22312;&#22810;&#20010;&#36827;&#31243;&#23545;&#21516;&#19968;&#36827;&#31243;
     &#21457;&#20986;wait&#35843;&#29992;&#26102;&#25165;&#26377;&#24847;&#20041;
  <span style="color: #0000FF;">volatile</span> <span style="color: #6434A3;">long</span> state;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">-1 unrunnable, 0 runnable, &gt;0 stopped</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">void</span> *<span style="color: #BA36A5;">stack</span>;
  <span style="color: #6434A3;">atomic_t</span> <span style="color: #BA36A5;">usage</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">flags</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">per process flags, defined below</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">ptrace</span>;

  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">lock_depth</span>;   <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">BKL lock depth</span><span style="color: #8D8D84;"> */</span>

<span style="color: #808080;">#ifdef</span> CONFIG_SMP
<span style="color: #808080;">#ifdef</span> __ARCH_WANT_UNLOCKED_CTXSW
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">oncpu</span>;
<span style="color: #808080;">#endif</span>
<span style="color: #808080;">#endif</span>

  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">prio</span>, <span style="color: #BA36A5;">static_prio</span>, <span style="color: #BA36A5;">normal_prio</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span> <span style="color: #BA36A5;">run_list</span>;
  <span style="color: #0000FF;">const</span> <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">sched_class</span> *<span style="color: #BA36A5;">sched_class</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">sched_entity</span> <span style="color: #BA36A5;">se</span>;

<span style="color: #808080;">#ifdef</span> CONFIG_PREEMPT_NOTIFIERS
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">list of struct preempt_notifier:</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">hlist_head</span> <span style="color: #BA36A5;">preempt_notifiers</span>;
<span style="color: #808080;">#endif</span>

  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">short</span> <span style="color: #BA36A5;">ioprio</span>;
  <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">   * fpu_counter contains the number of consecutive context switches</span>
<span style="color: #8D8D84; font-style: italic;">   * that the FPU is used. If this is over a threshold, the lazy fpu</span>
<span style="color: #8D8D84; font-style: italic;">   * saving becomes unlazy to save the trap. This is an unsigned char</span>
<span style="color: #8D8D84; font-style: italic;">   * so that after 256 times the counter wraps and the behavior turns</span>
<span style="color: #8D8D84; font-style: italic;">   * lazy again; this to deal with bursty apps that only use FPU for</span>
<span style="color: #8D8D84; font-style: italic;">   * a short time</span>
<span style="color: #8D8D84;">   */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">char</span> <span style="color: #BA36A5;">fpu_counter</span>;
  <span style="color: #6434A3;">s8</span> <span style="color: #BA36A5;">oomkilladj</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">OOM kill score adjustment (bit shift).</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#ifdef</span> CONFIG_BLK_DEV_IO_TRACE
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">btrace_seq</span>;
<span style="color: #808080;">#endif</span>

  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">policy</span>;
  <span style="color: #6434A3;">cpumask_t</span> <span style="color: #BA36A5;">cpus_allowed</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">time_slice</span>;

<span style="color: #808080;">#if</span> <span style="color: #808080;">defined</span><span style="color: #7388D6;">(</span>CONFIG_SCHEDSTATS<span style="color: #7388D6;">)</span> || <span style="color: #808080;">defined</span><span style="color: #7388D6;">(</span>CONFIG_TASK_DELAY_ACCT<span style="color: #7388D6;">)</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">sched_info</span> <span style="color: #BA36A5;">sched_info</span>;
<span style="color: #808080;">#endif</span>

  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span> <span style="color: #BA36A5;">tasks</span>;
  <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">   * ptrace_list/ptrace_children forms the list of my children</span>
<span style="color: #8D8D84; font-style: italic;">   * that were stolen by a ptracer.</span>
<span style="color: #8D8D84;">   */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span> <span style="color: #BA36A5;">ptrace_children</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span> <span style="color: #BA36A5;">ptrace_list</span>;

  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">mm_struct</span> *<span style="color: #BA36A5;">mm</span>, *<span style="color: #BA36A5;">active_mm</span>;

<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">task state</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">linux_binfmt</span> *<span style="color: #BA36A5;">binfmt</span>;
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">exit_state</span>;
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">exit_code</span>, <span style="color: #BA36A5;">exit_signal</span>;
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">pdeath_signal</span>;  <span style="color: #8D8D84;">/*  </span><span style="color: #8D8D84; font-style: italic;">The signal sent when the parent dies</span><span style="color: #8D8D84;">  */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">???</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">personality</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #BA36A5;">did_exec</span>:<span style="color: #D0372D;">1</span>;
  <span style="color: #6434A3;">pid_t</span> <span style="color: #BA36A5;">pid</span>;
  <span style="color: #6434A3;">pid_t</span> <span style="color: #BA36A5;">tgid</span>;

<span style="color: #808080;">#ifdef</span> CONFIG_CC_STACKPROTECTOR
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Canary value for the -fstack-protector gcc feature</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">stack_canary</span>;
<span style="color: #808080;">#endif</span>
  <span style="color: #8D8D84;">/* </span>
<span style="color: #8D8D84; font-style: italic;">   * pointers to (original) parent process, youngest child, younger sibling,</span>
<span style="color: #8D8D84; font-style: italic;">   * older sibling, respectively.  (p-&gt;father can be replaced with </span>
<span style="color: #8D8D84; font-style: italic;">   * p-&gt;parent-&gt;pid)</span>
<span style="color: #8D8D84;">   */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">task_struct</span> *<span style="color: #BA36A5;">real_parent</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">real parent process (when being debugged)</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">task_struct</span> *<span style="color: #BA36A5;">parent</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">parent process</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">   * children/sibling forms the list of my children plus the</span>
<span style="color: #8D8D84; font-style: italic;">   * tasks I'm ptracing.</span>
<span style="color: #8D8D84;">   */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span> <span style="color: #BA36A5;">children</span>;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">list of my children</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span> <span style="color: #BA36A5;">sibling</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">linkage in my parent's children list</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">task_struct</span> *<span style="color: #BA36A5;">group_leader</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">threadgroup leader</span><span style="color: #8D8D84;"> */</span>

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">PID/PID hash table linkage.</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">pid_link</span> <span style="color: #BA36A5;">pids</span><span style="color: #7388D6;">[</span>PIDTYPE_MAX<span style="color: #7388D6;">]</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span> <span style="color: #BA36A5;">thread_group</span>;

  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">completion</span> *<span style="color: #BA36A5;">vfork_done</span>;    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">for vfork()</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">__user</span> *set_child_tid;    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">CLONE_CHILD_SETTID</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">__user</span> *clear_child_tid;    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">CLONE_CHILD_CLEARTID</span><span style="color: #8D8D84;"> */</span>

  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">rt_priority</span>;
  <span style="color: #6434A3;">cputime_t</span> <span style="color: #BA36A5;">utime</span>, <span style="color: #BA36A5;">stime</span>, <span style="color: #BA36A5;">utimescaled</span>, <span style="color: #BA36A5;">stimescaled</span>;
  <span style="color: #6434A3;">cputime_t</span> <span style="color: #BA36A5;">gtime</span>;
  <span style="color: #6434A3;">cputime_t</span> <span style="color: #BA36A5;">prev_utime</span>, <span style="color: #BA36A5;">prev_stime</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">nvcsw</span>, <span style="color: #BA36A5;">nivcsw</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">context switch counts</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">timespec</span> <span style="color: #BA36A5;">start_time</span>;     <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">monotonic time</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">timespec</span> <span style="color: #BA36A5;">real_start_time</span>;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">boot based time</span><span style="color: #8D8D84;"> */</span>
<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">mm fault and swap info: this can arguably be seen as either mm-specific or thread-specific</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">min_flt</span>, <span style="color: #BA36A5;">maj_flt</span>;

    <span style="color: #6434A3;">cputime_t</span> <span style="color: #BA36A5;">it_prof_expires</span>, <span style="color: #BA36A5;">it_virt_expires</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">it_sched_expires</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span> <span style="color: #BA36A5;">cpu_timers</span><span style="color: #7388D6;">[</span><span style="color: #D0372D;">3</span><span style="color: #7388D6;">]</span>;

<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">process credentials</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">uid_t</span> <span style="color: #BA36A5;">uid</span>,<span style="color: #BA36A5;">euid</span>,<span style="color: #BA36A5;">suid</span>,<span style="color: #BA36A5;">fsuid</span>;
  <span style="color: #6434A3;">gid_t</span> <span style="color: #BA36A5;">gid</span>,<span style="color: #BA36A5;">egid</span>,<span style="color: #BA36A5;">sgid</span>,<span style="color: #BA36A5;">fsgid</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">group_info</span> *<span style="color: #BA36A5;">group_info</span>;
  <span style="color: #6434A3;">kernel_cap_t</span>   <span style="color: #BA36A5;">cap_effective</span>, <span style="color: #BA36A5;">cap_inheritable</span>, <span style="color: #BA36A5;">cap_permitted</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #BA36A5;">keep_capabilities</span>:<span style="color: #D0372D;">1</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">user_struct</span> *<span style="color: #BA36A5;">user</span>;
<span style="color: #808080;">#ifdef</span> CONFIG_KEYS
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">key</span> *<span style="color: #BA36A5;">request_key_auth</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">assumed request_key authority</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">key</span> *<span style="color: #BA36A5;">thread_keyring</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">keyring private to this thread</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">char</span> <span style="color: #BA36A5;">jit_keyring</span>;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">default keyring to attach requested keys to</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#endif</span>
  <span style="color: #6434A3;">char</span> <span style="color: #BA36A5;">comm</span><span style="color: #7388D6;">[</span>TASK_COMM_LEN<span style="color: #7388D6;">]</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">executable name excluding path</span>
<span style="color: #8D8D84; font-style: italic;">             - access with [gs]et_task_comm (which lock</span>
<span style="color: #8D8D84; font-style: italic;">               it with task_lock())</span>
<span style="color: #8D8D84; font-style: italic;">             - initialized normally by flush_old_exec</span><span style="color: #8D8D84;"> */</span>
<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">file system info</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">link_count</span>, <span style="color: #BA36A5;">total_link_count</span>;
<span style="color: #808080;">#ifdef</span> CONFIG_SYSVIPC
<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">ipc stuff</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">sysv_sem</span> <span style="color: #BA36A5;">sysvsem</span>;
<span style="color: #808080;">#endif</span>
<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">CPU-specific state of this task</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">thread_struct</span> <span style="color: #BA36A5;">thread</span>;
<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">filesystem information</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">fs_struct</span> *<span style="color: #BA36A5;">fs</span>;
<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">open file information</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">files_struct</span> *<span style="color: #BA36A5;">files</span>;
<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">namespaces</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">nsproxy</span> *<span style="color: #BA36A5;">nsproxy</span>;
<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">signal handlers</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">signal_struct</span> *<span style="color: #BA36A5;">signal</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">sighand_struct</span> *<span style="color: #BA36A5;">sighand</span>;

  <span style="color: #6434A3;">sigset_t</span> <span style="color: #BA36A5;">blocked</span>, <span style="color: #BA36A5;">real_blocked</span>;
  <span style="color: #6434A3;">sigset_t</span> <span style="color: #BA36A5;">saved_sigmask</span>;   <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">To be restored with TIF_RESTORE_SIGMASK</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">sigpending</span> <span style="color: #BA36A5;">pending</span>;

  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">sas_ss_sp</span>;
  <span style="color: #6434A3;">size_t</span> <span style="color: #BA36A5;">sas_ss_size</span>;
  <span style="color: #6434A3;">int</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">notifier</span><span style="color: #7388D6;">)(</span><span style="color: #6434A3;">void</span> *<span style="color: #BA36A5;">priv</span><span style="color: #7388D6;">)</span>;
  <span style="color: #6434A3;">void</span> *<span style="color: #BA36A5;">notifier_data</span>;
  <span style="color: #6434A3;">sigset_t</span> *<span style="color: #BA36A5;">notifier_mask</span>;
<span style="color: #808080;">#ifdef</span> CONFIG_SECURITY
  <span style="color: #6434A3;">void</span> *<span style="color: #BA36A5;">security</span>;
<span style="color: #808080;">#endif</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">audit_context</span> *<span style="color: #BA36A5;">audit_context</span>;
  <span style="color: #6434A3;">seccomp_t</span> <span style="color: #BA36A5;">seccomp</span>;

<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Thread group tracking</span><span style="color: #8D8D84;"> */</span>
    <span style="color: #6434A3;">u32</span> <span style="color: #BA36A5;">parent_exec_id</span>;
    <span style="color: #6434A3;">u32</span> <span style="color: #BA36A5;">self_exec_id</span>;
<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Protection of (de-)allocation: mm, files, fs, tty, keyrings</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">spinlock_t</span> <span style="color: #BA36A5;">alloc_lock</span>;

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Protection of the PI data structures:</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">spinlock_t</span> <span style="color: #BA36A5;">pi_lock</span>;

<span style="color: #808080;">#ifdef</span> CONFIG_RT_MUTEXES
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">PI waiters blocked on a rt_mutex held by this task</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">plist_head</span> <span style="color: #BA36A5;">pi_waiters</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Deadlock detection and priority inheritance handling</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">rt_mutex_waiter</span> *<span style="color: #BA36A5;">pi_blocked_on</span>;
<span style="color: #808080;">#endif</span>

<span style="color: #808080;">#ifdef</span> CONFIG_DEBUG_MUTEXES
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">mutex deadlock detection</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">mutex_waiter</span> *<span style="color: #BA36A5;">blocked_on</span>;
<span style="color: #808080;">#endif</span>
<span style="color: #808080;">#ifdef</span> CONFIG_TRACE_IRQFLAGS
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">irq_events</span>;
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">hardirqs_enabled</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">hardirq_enable_ip</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">hardirq_enable_event</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">hardirq_disable_ip</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">hardirq_disable_event</span>;
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">softirqs_enabled</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">softirq_disable_ip</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">softirq_disable_event</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">softirq_enable_ip</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">softirq_enable_event</span>;
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">hardirq_context</span>;
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">softirq_context</span>;
<span style="color: #808080;">#endif</span>
<span style="color: #808080;">#ifdef</span> CONFIG_LOCKDEP
<span style="color: #808080;"># define</span> <span style="color: #BA36A5;">MAX_LOCK_DEPTH</span> <span style="color: #D0372D;">30UL</span>
  <span style="color: #6434A3;">u64</span> <span style="color: #BA36A5;">curr_chain_key</span>;
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">lockdep_depth</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">held_lock</span> <span style="color: #BA36A5;">held_locks</span><span style="color: #7388D6;">[</span>MAX_LOCK_DEPTH<span style="color: #7388D6;">]</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">lockdep_recursion</span>;
<span style="color: #808080;">#endif</span>

<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">journalling filesystem info</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">void</span> *<span style="color: #BA36A5;">journal_info</span>;

<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">stacked block device info</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">bio</span> *<span style="color: #BA36A5;">bio_list</span>, **<span style="color: #BA36A5;">bio_tail</span>;

<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">VM state</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">reclaim_state</span> *<span style="color: #BA36A5;">reclaim_state</span>;

  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">backing_dev_info</span> *<span style="color: #BA36A5;">backing_dev_info</span>;

  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">io_context</span> *<span style="color: #BA36A5;">io_context</span>;

  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">ptrace_message</span>;
  <span style="color: #6434A3;">siginfo_t</span> *<span style="color: #BA36A5;">last_siginfo</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">For ptrace use.</span><span style="color: #8D8D84;">  */</span>
<span style="color: #808080;">#ifdef</span> CONFIG_TASK_XACCT
<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">i/o counters(bytes read/written, #syscalls</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">u64</span> <span style="color: #BA36A5;">rchar</span>, <span style="color: #BA36A5;">wchar</span>, <span style="color: #BA36A5;">syscr</span>, <span style="color: #BA36A5;">syscw</span>;
<span style="color: #808080;">#endif</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">task_io_accounting</span> <span style="color: #BA36A5;">ioac</span>;
<span style="color: #808080;">#if</span> <span style="color: #808080;">defined</span><span style="color: #7388D6;">(</span>CONFIG_TASK_XACCT<span style="color: #7388D6;">)</span>
  <span style="color: #6434A3;">u64</span> <span style="color: #BA36A5;">acct_rss_mem1</span>;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">accumulated rss usage</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">u64</span> <span style="color: #BA36A5;">acct_vm_mem1</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">accumulated virtual memory usage</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">cputime_t</span> <span style="color: #BA36A5;">acct_stimexpd</span>;<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">stime since last update</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#endif</span>
<span style="color: #808080;">#ifdef</span> CONFIG_NUMA
    <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">mempolicy</span> *<span style="color: #BA36A5;">mempolicy</span>;
  <span style="color: #6434A3;">short</span> <span style="color: #BA36A5;">il_next</span>;
<span style="color: #808080;">#endif</span>
<span style="color: #808080;">#ifdef</span> CONFIG_CPUSETS
  <span style="color: #6434A3;">nodemask_t</span> <span style="color: #BA36A5;">mems_allowed</span>;
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">cpuset_mems_generation</span>;
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">cpuset_mem_spread_rotor</span>;
<span style="color: #808080;">#endif</span>
<span style="color: #808080;">#ifdef</span> CONFIG_CGROUPS
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Control Group info protected by css_set_lock</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">css_set</span> *<span style="color: #BA36A5;">cgroups</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">cg_list protected by css_set_lock and tsk-&gt;alloc_lock</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span> <span style="color: #BA36A5;">cg_list</span>;
<span style="color: #808080;">#endif</span>
<span style="color: #808080;">#ifdef</span> CONFIG_FUTEX
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">robust_list_head</span> <span style="color: #6434A3;">__user</span> *<span style="color: #BA36A5;">robust_list</span>;
<span style="color: #808080;">#ifdef</span> CONFIG_COMPAT
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">compat_robust_list_head</span> <span style="color: #6434A3;">__user</span> *<span style="color: #BA36A5;">compat_robust_list</span>;
<span style="color: #808080;">#endif</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span> <span style="color: #BA36A5;">pi_state_list</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">futex_pi_state</span> *<span style="color: #BA36A5;">pi_state_cache</span>;
<span style="color: #808080;">#endif</span>
  <span style="color: #6434A3;">atomic_t</span> <span style="color: #BA36A5;">fs_excl</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">holding fs exclusive resources</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">rcu_head</span> <span style="color: #BA36A5;">rcu</span>;

  <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">   * cache last used pipe for splice</span>
<span style="color: #8D8D84;">   */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">pipe_inode_info</span> *<span style="color: #BA36A5;">splice_pipe</span>;
<span style="color: #808080;">#ifdef</span>  CONFIG_TASK_DELAY_ACCT
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">task_delay_info</span> *<span style="color: #BA36A5;">delays</span>;
<span style="color: #808080;">#endif</span>
<span style="color: #808080;">#ifdef</span> CONFIG_FAULT_INJECTION
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">make_it_fail</span>;
<span style="color: #808080;">#endif</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">prop_local_single</span> <span style="color: #BA36A5;">dirties</span>;
<span style="color: #707183;">}</span>
</pre>
</div>
</div>
</li>
<li><a id="orgb2ca68f"></a>命名空间<br />
<ol class="org-ol">
<li><a id="org6432682"></a>概念<br />
<div class="outline-text-6" id="text-3-9-1-2-1">
<p>
传统上，在linux以及其他衍生的unix变体中，很多资源是全局管理的。比如内核必须管理一个全局pid
列表来唯一标识一个进程。这种数据管理方式在有些情况下会有一些限制。如果提供云计算服务的供应商
打算向用户提供linux计算机的root权限，这种管理方式一般需要使用kvm或vmware提供的虚拟化环境，
但是这些方法的资源分配做的不是非常好。 而命名空间提供了一种不同的解决方案，所需的资源较少，它
只使用一个内核在一台物理机上运作，前面那种全局管理的资源都使用命名空间抽象隔离起来。
本质上，命名空间建立了系统的不同视图:
</p>
</div>
<ol class="org-ol">
<li><a id="org2e0e8eb"></a><br />
<div class="outline-text-7" id="text-3-9-1-2-1-1">

<div id="org1375a5a" class="figure">
<p><img src="reading/2020-11-04_21-28-51_screenshot.png" alt="2020-11-04_21-28-51_screenshot.png" />
</p>
</div>

<p>
如上图所示，系统上有3个命名空间，一个父命名空间和两个子命名空间，每个空间都有各自的1，2，3号
进程，而子命名空间在父命名空间也有其进程的映射，如左边的字命名空间的1号映射为父进程空间中的4号
</p>
</div>
</li>
</ol>
</li>
<li><a id="orgd999c60"></a>创建<br />
<div class="outline-text-6" id="text-3-9-1-2-2">
<p>
有两种方法可以创建新的命名空间
</p>
<ol class="org-ol">
<li>fork或clone</li>
<li>unshare系统调用</li>
</ol>
</div>
</li>
<li><a id="org3aa71b2"></a>实现<br />
<div class="outline-text-6" id="text-3-9-1-2-3">
<p>
命名空间的实现需要两个部分：
</p>
<ol class="org-ol">
<li>每个子系统的命名空间结构</li>
<li>将给定进程关联到所属各个命名空间的机制</li>
</ol>
</div>
<ol class="org-ol">
<li><a id="orgd9889a0"></a><br />
<div class="outline-text-7" id="text-3-9-1-2-3-1">

<div id="org93ff411" class="figure">
<p><img src="reading/2020-11-04_21-57-00_screenshot.png" alt="2020-11-04_21-57-00_screenshot.png" />
</p>
</div>
</div>
</li>
</ol>
</li>
</ol>
</li>

<li><a id="orgc34d187"></a>进程ID<br />
<div class="outline-text-5" id="text-3-9-1-3">
</div>
<ol class="org-ol">
<li><a id="org2e935e8"></a>进程ID类型<br />
<div class="outline-text-6" id="text-3-9-1-3-1">
<ul class="org-ul">
<li>PID</li>
<li>线程组ID（TGID）</li>
<li>进程组ID（GID）
简化了向一个组所有成员发送信号</li>
<li>会话ID（SID）</li>
</ul>
</div>
</li>
<li><a id="org5b7f9a9"></a>支持命名空间的PID<br />
<div class="outline-text-6" id="text-3-9-1-3-2">
<ul class="org-ul">
<li>全局ID
内核本身和初始命名空间中的唯一ID号，每个ID都有一个唯一的全局ID</li>
<li>局部ID
某个特定命名空间的ID，不同的命名空间可能不唯一</li>
</ul>
</div>
</li>
<li><a id="org59919ba"></a>相关数据结构（图）<br />
<div class="outline-text-6" id="text-3-9-1-3-3">

<div id="org216c5ba" class="figure">
<p><img src="reading/2020-11-05_21-18-08_screenshot.png" alt="2020-11-05_21-18-08_screenshot.png" />
</p>
</div>


<div id="org1f94b51" class="figure">
<p><img src="reading/2020-11-05_21-24-54_screenshot.png" alt="2020-11-05_21-24-54_screenshot.png" />
</p>
</div>

<p>
本质上，这两张图就为了完成两件事情：
</p>
<ol class="org-ol">
<li>给出局部数字ID和对应的命名空间，找到对应的task<sub>struct</sub>
这是通过pid<sub>hash出发来完成的</sub>:
pid<sub>hash</sub>-&gt;struct upid-&gt;(container<sub>of机制</sub>)struct pid-&gt;task<sub>struct</sub></li>
<li>给出task<sub>struct和命名空间</sub>，找upid
task<sub>struct</sub>-&gt;struct pid-&gt;numbers[ns.level]-&gt;upid</li>
</ol>
</div>
</li>
<li><a id="org312b3c7"></a>创建一个pid的过程<br />
<div class="outline-text-6" id="text-3-9-1-3-4">
<p>
从建立进程的命名空间开始，一直到初始的全局命名空间，内核会为此间的每个命名空间分别创建一个
局部PID（struct upid), 并把upid全映射到pid<sub>hash中</sub>
</p>
</div>
</li>
</ol>
</li>
<li><a id="orgf858623"></a>进程管理相关系统调用<br />
<div class="outline-text-5" id="text-3-9-1-4">
</div>
<ol class="org-ol">
<li><a id="org7378cd8"></a>进程复制<br />
<ol class="org-ol">
<li><a id="org784f083"></a>进程复制主要的系统调用是fork和clone，vfork在fork使用了COW后速度不再有优势<br />
<div class="outline-text-7" id="text-3-9-1-4-1-1">
<ul class="org-ul">
<li><p>
COW(copy-on-write)
该技术利用了下述事实：进程通常只使用了内存页的一小部分。在调用fork时，一般来说内核需要
对父进程的每个内存页都为子进程创建一个副本。这有样有两个缺点：
</p>
<ol class="org-ol">
<li>使用了大量的内存</li>
<li>复制操作耗费了很长的时间</li>
</ol>
<p>
COW机制使得内核可以尽可能延迟内存页的复制，更重要的是，在很多情况下根本不需要复制，这
节省了大量的内存和时间
</p></li>

<li><p>
fork, 创建子进程, 该子进程是父进程的完整副本
</p>
<div class="org-src-container">
<pre class="src src-c">asmlinkage <span style="color: #6434A3;">int</span> <span style="color: #006699;">sys_fork</span><span style="color: #707183;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">pt_regs</span> <span style="color: #BA36A5;">regs</span><span style="color: #707183;">)</span>
<span style="color: #707183;">{</span>
  <span style="color: #0000FF;">return</span> do_fork<span style="color: #7388D6;">(</span>SIGCHLD, regs.esp, &amp;regs, <span style="color: #D0372D;">0</span>, <span style="color: #D0372D;">NULL</span>, <span style="color: #D0372D;">NULL</span><span style="color: #7388D6;">)</span>;
<span style="color: #707183;">}</span>
</pre>
</div></li>
<li><p>
clone 产生线程，可以对父子进程的共享、复制进行精确控制
</p>
<div class="org-src-container">
<pre class="src src-c">asmlinkage <span style="color: #6434A3;">int</span> <span style="color: #006699;">sys_clone</span><span style="color: #707183;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">pt_regs</span> <span style="color: #BA36A5;">regs</span><span style="color: #707183;">)</span>
<span style="color: #707183;">{</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">clone_flags</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">newsp</span>;
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">__user</span> *parent_tidptr, *<span style="color: #BA36A5;">child_tidptr</span>;

  clone_flags = regs.ebx;
  newsp = regs.ecx;
  parent_tidptr = <span style="color: #7388D6;">(</span><span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">__user</span> *<span style="color: #7388D6;">)</span>regs.edx;
  child_tidptr = <span style="color: #7388D6;">(</span><span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">__user</span> *<span style="color: #7388D6;">)</span>regs.edi;
  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>!newsp<span style="color: #7388D6;">)</span>
    newsp = regs.esp;
  <span style="color: #0000FF;">return</span> do_fork<span style="color: #7388D6;">(</span>clone_flags, newsp, &amp;regs, <span style="color: #D0372D;">0</span>, parent_tidptr, child_tidptr<span style="color: #7388D6;">)</span>;
<span style="color: #707183;">}</span>
</pre>
</div></li>
<li>从上面代码中看到，clone和fork的区别主要在于：
<ol class="org-ol">
<li>clone的标志不再是硬编码的,而是通过各种寄存器把参数传递到系统调用，</li>
<li>clone不再复制父进程的栈地址，而是可以指定新的栈地址。在创建线程时可能需要这样做，</li>
</ol></li>
</ul>
</div>
</li>
<li><a id="org50cf5e9"></a>do<sub>fork</sub><br />
<div class="outline-text-7" id="text-3-9-1-4-1-2">
<ul class="org-ul">
<li>fork和clone处理完准备工作后都调用了do<sub>fork函数</sub>:</li>
</ul>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;"> *  Ok, this is the main fork-routine.</span>
<span style="color: #8D8D84; font-style: italic;"> *</span>
<span style="color: #8D8D84; font-style: italic;"> * It copies the process, and if successful kick-starts</span>
<span style="color: #8D8D84; font-style: italic;"> * it and waits for it to finish using the VM if required.</span>
<span style="color: #8D8D84;"> */</span>
<span style="color: #6434A3;">long</span> <span style="color: #006699;">do_fork</span><span style="color: #707183;">(</span>
             <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">&#25511;&#21046;&#22797;&#21046;&#36807;&#31243;&#20013;&#30340;&#19968;&#20123;&#23646;&#24615;&#65292;&#26368;&#20302;&#23383;&#33410;&#25351;&#23450;&#20102;&#22312;&#23376;&#36827;&#31243;&#32456;&#27490;&#26102;</span>
             <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">&#21457;&#32473;&#29238;&#36827;&#31243;&#30340;&#20449;&#21495;</span>
             <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">clone_flags</span>,
             <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">&#29992;&#25143;&#29366;&#24577;&#19979;&#26632;&#30340;&#36215;&#22987;&#22320;&#22336;,&#24517;&#39035;&#20445;&#35777;&#29238;&#23376;&#36827;&#31243;&#26632;&#22320;&#22336;&#19968;&#26679;</span>
             <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">stack_start</span>,
             <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">&#35843;&#29992;&#21442;&#25968;</span>
             <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">pt_regs</span> *<span style="color: #BA36A5;">regs</span>,
             <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">&#29992;&#25143;&#29366;&#24577;&#19979;&#26632;&#30340;&#22823;&#23567;&#65292;&#36890;&#24120;&#20026;0</span>
             <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">stack_size</span>,
             <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">__user</span> *parent_tidptr,
             <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">__user</span> *child_tidptr<span style="color: #707183;">)</span>
</pre>
</div>
</div>
<ol class="org-ol">
<li><a id="org7522046"></a>实现<br />
<div class="outline-text-8" id="text-3-9-1-4-1-2-1">
<p>
do<sub>fork流程图如下</sub>:
</p>
</div>

<ol class="org-ol">
<li><a id="org9460ee6"></a>do<sub>fork流程图</sub><br />
<div class="outline-text-9" id="text-3-9-1-4-1-2-1-1">
<p>
<img src="reading/2020-11-06_19-51-04_screenshot.png" alt="2020-11-06_19-51-04_screenshot.png" />
          其中，主要工作由copy<sub>process完成</sub>，copy<sub>process执行生成新进程的实际工作,同时根据指定的</sub>
          标志重用父进程的数据，copy<sub>process的主要流程图如下</sub>：
</p>
</div>
<ol class="org-ol">
<li><a id="orgae43242"></a>copy<sub>process流程图</sub><br />
<div class="outline-text-10" id="text-3-9-1-4-1-2-1-1-1">

<div id="org8aa7e92" class="figure">
<p><img src="reading/2020-11-06_19-57-34_screenshot.png" alt="2020-11-06_19-57-34_screenshot.png" />
</p>
</div>

<ul class="org-ul">
<li>首先检查标志，特别是捕获一些没有意义的标志组合，比如CLONE<sub>NEWNS和CLONE</sub><sub>FS就不</sub>
能组合在一起；而有些标志是必须结合在一起用的，比如CLONE<sub>THREAD和CLONE</sub><sub>SIGHAND</sub>、
CLONE<sub>VM</sub>，因为创建线程必须激活信号共享,而且创建线程时也必须与父进程共享地址空间。</li>
<li><p>
在检查完标志集后，调用dup<sub>task</sub><sub>struct来建立父进程task</sub><sub>struct的副本</sub>。父子进程
的task<sub>struct实例只有一个成员不同</sub>：子进程分配了新的内核栈，即task<sub>struct</sub>-&gt;stack:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #0000FF;">union</span> <span style="color: #6434A3;">thread_union</span> <span style="color: #707183;">{</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">thread_info</span> <span style="color: #BA36A5;">thread_info</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">stack</span><span style="color: #7388D6;">[</span>THREAD_SIZE/<span style="color: #0000FF;">sizeof</span><span style="color: #909183;">(</span><span style="color: #6434A3;">long</span><span style="color: #909183;">)</span><span style="color: #7388D6;">]</span>;
<span style="color: #707183;">}</span>;
</pre>
</div>
<p>
内核栈大小默认为8K，也可配置成4K，thread<sub>info保存了特定与体系结构的汇编代码需要</sub>
访问的那部分进程数据：
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">thread_info</span> <span style="color: #707183;">{</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">task_struct</span>  *<span style="color: #BA36A5;">task</span>;    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">main task structure</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">exec_domain</span>  *<span style="color: #BA36A5;">exec_domain</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">execution domain</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">   * &#25105;&#20204;&#21482;&#20851;&#27880;&#20854;&#20013;&#20004;&#20010;&#65292;&#22240;&#20026;&#20854;&#20182;&#37117;&#26159;&#30828;&#20214;&#30456;&#20851;&#30340;&#65306;</span>
<span style="color: #8D8D84; font-style: italic;">   * 1. &#22914;&#26524;&#36827;&#31243;&#26377;&#24453;&#20915;&#20449;&#21495;&#21017;&#32622;&#20301;TIF_SIGPENDING</span>
<span style="color: #8D8D84; font-style: italic;">   * 2. TIF_NEED_RESCHED&#34920;&#31034;&#35813;&#36827;&#31243;&#24212;&#35813;&#25110;&#24819;&#35201;&#35843;&#24230;&#22120;&#36873;&#25321;&#21478;&#19968;&#20010;&#36827;&#31243;&#26367;&#25442;&#26412;&#36827;&#31243;&#25191;&#34892;</span>
<span style="color: #8D8D84;">   */</span>
  <span style="color: #6434A3;">__u32</span>     <span style="color: #BA36A5;">flags</span>;    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">low level flags</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#32447;&#31243;&#21516;&#27493;&#26631;&#24535;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">__u32</span>     <span style="color: #BA36A5;">status</span>;   <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">thread synchronous flags</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#24403;&#21069;cpu&#65292;&#32763;&#35793;&#30340;&#26377;&#38382;&#39064;&#65311;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">__u32</span>     <span style="color: #BA36A5;">cpu</span>;    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">current CPU</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#23454;&#29616;&#20869;&#26680;&#25250;&#21344;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">int</span>       <span style="color: #BA36A5;">preempt_count</span>;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">0 =&gt; preemptable, &lt;0 =&gt; BUG</span><span style="color: #8D8D84;"> */</span>

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#36827;&#31243;&#21487;&#20197;&#20351;&#29992;&#30340;&#34394;&#25311;&#22320;&#22336;&#19978;&#38480;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">mm_segment_t</span>    <span style="color: #BA36A5;">addr_limit</span>; 
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#29992;&#20110;&#23454;&#29616;&#20449;&#21495;&#26426;&#21046;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">restart_block</span>    <span style="color: #BA36A5;">restart_block</span>;
<span style="color: #707183;">}</span>;
</pre>
</div>
<p>
thread<sub>info布局图</sub>
</p></li>
</ul>

<div id="orga800783" class="figure">
<p><img src="reading/2020-11-06_20-44-21_screenshot.png" alt="2020-11-06_20-44-21_screenshot.png" />
</p>
</div>
<ul class="org-ul">
<li>构建完task<sub>struct后</sub>，内核会检查当前用户(task<sub>struct</sub>-&gt;user)已经创建的进程数
是否超出了限制，若超出，则放弃创建进程</li>
<li>确定可以创建进程后，初始化一些子进程task<sub>struct的一些数据</sub></li>
<li>接下来会调用sched<sub>fork</sub>。本质上，该函数会初始化一些统计字段，
并均衡下调度器负载，并把子进程设置为TASK<sub>RUNNING</sub>(TODO:why?）</li>
<li>再下来就是根据标志来复制或者共享父进程的资源:
❑ copy<sub>semundo</sub> uses the System V semaphores of the parent process
  if COPY<sub>SYSVSEM</sub> is set (see Chapter 5).
❑ copy<sub>files</sub> uses the file descriptors of the parent process if
  CLONE<sub>FILES</sub> is set. Otherwise, a new files structure is generated
  (see Chapter 8) that contains the same information as the parent
  process. This information can be modified independently of the original structure.
❑ copy<sub>fs</sub> uses the filesystem context (task<sub>struct</sub>-&gt;fs) of the
  parent process if CLONE<sub>FS</sub> is set. This is an fs<sub>struct</sub> type
  structure that holds, for example, the root directory and the
  current working directory of the process (see Chapter 8 for detailed information).
❑ copy<sub>sighand</sub> uses the signal handlers of the parent process
   (task<sub>struct</sub>-&gt;sighand) if CLONE<sub>SIGHAND</sub> or CLONE<sub>THREAD</sub> is set.
  Chapter 5 discusses the struct sighand<sub>struct</sub> structure used in more detail.
❑ copy<sub>signal</sub> uses the non-handler-specific part of signal handling
  (task<sub>struct</sub>-&gt;signal, see Chapter 5) together with the parent process if CLONE<sub>THREAD</sub> is set.
❑ copy<sub>mm</sub> causes the parent process and child process to share the
  same address space if COPY<sub>MM</sub> is set. In this case, both processes
  use the same instance of mm<sub>struct</sub> (see Chapter 4) to which task<sub>struct</sub>-&gt;mm points.
  If copy<sub>mm</sub> is not set, it does not mean that the entire address
  space of the parent process is copied. The kernel does, in fact,
  create a copy of the page tables but does not copy the actual contents
  of the pages. This is done using the COW mechanism only if one of
  the two processes writes to one of the pages.
❑ copy<sub>namespaces</sub> has special call semantics. It is used
  to set up namespaces for the child process. Recall that several
  CLONE<sub>NEWxyz</sub> flags control which namespaces are shared with the
  parent. However, the semantics are opposite to all other flags:
  If CLONE<sub>NEWxyz</sub> is not specified, then the specific namespace is
  shared with the parent. Otherwise, a new namespace is generated.
  copy<sub>namespace</sub> is a dispatcher that executes a copy routine for 
  each possible namespace. The individual copy routines, however,
  are not too interesting because they essentially copy data or
  make already existing instances shared by means of reference
  counter management, so I will not discuss their implementation in detail.
❑ copy<sub>thread</sub> is — in contrast to all other copy operations discussed
  here — an architecture- specific function that copies the
  thread-specific data of a process.</li>
<li>最后，填好子进程与父进程不同的各个成员,包括task<sub>struct包含的各个链表元素</sub>
cpu<sub>timers,待决信号列表pending</sub></li>
</ul>
<p>
copy<sub>process执行完毕后</sub>，do<sub>fork还必须执行一些收尾工作,如前面的do</sub><sub>fork流程图</sub>：
</p>
<ul class="org-ul">
<li>TODO:</li>
</ul>
</div>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
<li><a id="org4316e00"></a>内核线程<br />
<div class="outline-text-6" id="text-3-9-1-4-2">
<p>
内核线程是直接由内核本身启动的进程。它们并行于内核的执行，通常称为守护进程。
</p>
</div>
<ol class="org-ol">
<li><a id="org7a107f4"></a>分类<br />
<div class="outline-text-7" id="text-3-9-1-4-2-1">
<p>
内核线程基本可以分为两类
</p>
<ol class="org-ol">
<li>启动后自动按特定周期间隔运行，检测特定资源的使用情况，超出或低于时采取行动</li>
<li>只有内核请求时才执行</li>
</ol>
</div>
</li>
<li><a id="orgdb7d6d9"></a>主要任务<br />
<div class="outline-text-7" id="text-3-9-1-4-2-2">
<p>
内核线程主要用于执行以下任务：
</p>
<ul class="org-ul">
<li>周期性地将修改的内存页与页来源块设备同步</li>
<li>将很少使用的内存页写入交换区</li>
<li>管理延时动作</li>
<li>实现文件系统的事务日志</li>
</ul>
</div>
</li>
<li><a id="org9d6e0d4"></a>创建<br />
<div class="outline-text-7" id="text-3-9-1-4-2-3">
<ul class="org-ul">
<li>创建内核线程的传统方法是kernel<sub>thread函数</sub></li>
</ul>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6434A3;">long</span> <span style="color: #006699;">kernel_thread</span><span style="color: #707183;">(</span><span style="color: #6434A3;">int</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">fn</span><span style="color: #7388D6;">)(</span><span style="color: #6434A3;">void</span> *<span style="color: #7388D6;">)</span>, <span style="color: #6434A3;">void</span> *<span style="color: #BA36A5;">arg</span>, <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">flags</span><span style="color: #707183;">)</span>
<span style="color: #707183;">{</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">pt_regs</span> <span style="color: #BA36A5;">regs</span>;

  memset<span style="color: #7388D6;">(</span>&amp;regs, <span style="color: #D0372D;">0</span>, <span style="color: #0000FF;">sizeof</span><span style="color: #909183;">(</span>regs<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>;

  regs.regs<span style="color: #7388D6;">[</span><span style="color: #D0372D;">4</span><span style="color: #7388D6;">]</span> = <span style="color: #7388D6;">(</span><span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span><span style="color: #7388D6;">)</span> arg;
  regs.regs<span style="color: #7388D6;">[</span><span style="color: #D0372D;">5</span><span style="color: #7388D6;">]</span> = <span style="color: #7388D6;">(</span><span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span><span style="color: #7388D6;">)</span> fn;
  regs.cp0_epc = <span style="color: #7388D6;">(</span><span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span><span style="color: #7388D6;">)</span> kernel_thread_helper;
  regs.cp0_status = read_c0_status<span style="color: #7388D6;">()</span>;
<span style="color: #808080;">#if</span> <span style="color: #808080;">defined</span><span style="color: #7388D6;">(</span>CONFIG_CPU_R3000<span style="color: #7388D6;">)</span> || <span style="color: #808080;">defined</span><span style="color: #7388D6;">(</span>CONFIG_CPU_TX39XX<span style="color: #7388D6;">)</span>
  regs.cp0_status = <span style="color: #7388D6;">(</span>regs.cp0_status &amp; ~<span style="color: #909183;">(</span>ST0_KUP | ST0_IEP | ST0_IEC<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span> |
    <span style="color: #7388D6;">(</span><span style="color: #909183;">(</span>regs.cp0_status &amp; <span style="color: #709870;">(</span>ST0_KUC | ST0_IEC<span style="color: #709870;">)</span><span style="color: #909183;">)</span> &lt;&lt; <span style="color: #D0372D;">2</span><span style="color: #7388D6;">)</span>;
<span style="color: #808080;">#else</span>
  regs.cp0_status |= ST0_EXL;
<span style="color: #808080;">#endif</span>

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Ok, create the new process..</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">return</span> do_fork<span style="color: #7388D6;">(</span>flags | CLONE_VM | CLONE_UNTRACED, <span style="color: #D0372D;">0</span>, &amp;regs, <span style="color: #D0372D;">0</span>, <span style="color: #D0372D;">NULL</span>, <span style="color: #D0372D;">NULL</span><span style="color: #7388D6;">)</span>;

</pre>
</div>
<p>
其中，fn函数负责帮助内核调用daemonize以转换为守护进程。步骤如下：
</p>
<ol class="org-ol">
<li>该函数从内核线程释放其父进程（用户进程）的所有资源（内存上下文，文件描述符），因为
不然的话这些资源会锁定到线程结束（通常时运行到关机）。而线程又不需要这些资源</li>
<li>daemonize阻塞信号的接受</li>
<li>将init作为守护线程的父进程</li>
</ol>
<ul class="org-ul">
<li><p>
更现代的方法是辅助函数kthread<sub>create,kthread</sub><sub>run和kthread</sub><sub>create</sub><sub>cpu</sub>(可指定cpu)
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">task_struct</span> *<span style="color: #006699;">kthread_create</span><span style="color: #707183;">(</span><span style="color: #6434A3;">int</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">threadfn</span><span style="color: #7388D6;">)(</span><span style="color: #6434A3;">void</span> *<span style="color: #BA36A5;">data</span><span style="color: #7388D6;">)</span>,
                                   <span style="color: #6434A3;">void</span> *<span style="color: #BA36A5;">data</span>,
                                   <span style="color: #0000FF;">const</span> <span style="color: #6434A3;">char</span> <span style="color: #BA36A5;">namefmt</span><span style="color: #7388D6;">[]</span>,
                                   ...<span style="color: #707183;">)</span>
<span style="color: #707183;">{</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">kthread_create_info</span> <span style="color: #BA36A5;">create</span>;

  create.threadfn = threadfn;
  create.data = data;
  init_completion<span style="color: #7388D6;">(</span>&amp;create.started<span style="color: #7388D6;">)</span>;
  init_completion<span style="color: #7388D6;">(</span>&amp;create.done<span style="color: #7388D6;">)</span>;

  spin_lock<span style="color: #7388D6;">(</span>&amp;kthread_create_lock<span style="color: #7388D6;">)</span>;
  list_add_tail<span style="color: #7388D6;">(</span>&amp;create.list, &amp;kthread_create_list<span style="color: #7388D6;">)</span>;
  wake_up_process<span style="color: #7388D6;">(</span>kthreadd_task<span style="color: #7388D6;">)</span>;
  spin_unlock<span style="color: #7388D6;">(</span>&amp;kthread_create_lock<span style="color: #7388D6;">)</span>;

  wait_for_completion<span style="color: #7388D6;">(</span>&amp;create.done<span style="color: #7388D6;">)</span>;

  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>!IS_ERR<span style="color: #909183;">(</span>create.result<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">{</span>
    <span style="color: #6434A3;">va_list</span> <span style="color: #BA36A5;">args</span>;
    va_start<span style="color: #909183;">(</span>args, namefmt<span style="color: #909183;">)</span>;
    vsnprintf<span style="color: #909183;">(</span>create.result-&gt;comm, <span style="color: #0000FF;">sizeof</span><span style="color: #709870;">(</span>create.result-&gt;comm<span style="color: #709870;">)</span>,
              namefmt, args<span style="color: #909183;">)</span>;
    va_end<span style="color: #909183;">(</span>args<span style="color: #909183;">)</span>;
  <span style="color: #7388D6;">}</span>
  <span style="color: #0000FF;">return</span> create.result;
<span style="color: #707183;">}</span>
</pre>
</div></li>
</ul>
</div>
</li>
</ol>
</li>

<li><a id="org8c55e58"></a>启动新程序<br />
<div class="outline-text-6" id="text-3-9-1-4-3">
<ul class="org-ul">
<li>execve</li>
</ul>
<p>
linux提供execve系统调用来通过新代码替换现存程序启动新程序，该系统调用的
入口是sys<sub>execve函数</sub>，该函数很快将工作委托给do<sub>execve例程</sub>。
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6434A3;">int</span> <span style="color: #006699;">do_execve</span><span style="color: #707183;">(</span><span style="color: #6434A3;">char</span> * <span style="color: #BA36A5;">filename</span>,
              <span style="color: #6434A3;">char</span> <span style="color: #BA36A5;">__user</span> *__user *argv,
              <span style="color: #6434A3;">char</span> <span style="color: #BA36A5;">__user</span> *__user *envp,
              <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">pt_regs</span> * <span style="color: #BA36A5;">regs</span><span style="color: #707183;">)</span>
</pre>
</div>
<p>
其代码流程图如下：
</p>

<div id="org4b65d07" class="figure">
<p><img src="reading/2020-11-07_20-20-55_screenshot.png" alt="2020-11-07_20-20-55_screenshot.png" />
</p>
</div>
<ol class="org-ol">
<li>首先，内核找到要执行文件的inode并生成一个文件描述符来打开此文件;</li>
<li>接下来bprm<sub>init处理一些管理任务</sub>，包括：
<ul class="org-ul">
<li>mm<sub>alloc生成新的mm</sub><sub>struct地址空间</sub></li>
<li>init<sub>new</sub><sub>context初始化mm</sub><sub>struct</sub></li>
<li>_<sub>bprm</sub><sub>mm</sub><sub>init建立初始的栈</sub></li>
</ul></li>
<li>然后，prepare<sub>binprm用于提供一些linux</sub><sub>binprm结构中父进程相关的值</sub>(特别是有效UID和GID)。
其中，linux<sub>binprm结构保存的是新进程的各个参数</sub></li>
<li>接下来就是复制环境和参数数组的内容</li>
<li><p>
最后，search<sub>binary</sub><sub>handler在do</sub><sub>execve结束时根据所要执行的文件查找适当的二进制格式</sub>,
如果找到合适的格式，则相应的二进制处理程序负责将新程序的数据加载到旧的地址空间中(TODO
那mm<sub>struct有什么用</sub>),二进制格式用下面的结构体描述：
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;"> * This structure defines the functions that are used to load the binary formats that</span>
<span style="color: #8D8D84; font-style: italic;"> * linux accepts.</span>
<span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">linux_binfmt</span> <span style="color: #707183;">{</span>
    <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span> <span style="color: #BA36A5;">lh</span>;
    <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">module</span> *<span style="color: #BA36A5;">module</span>;
    <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">&#21152;&#36733;&#26222;&#36890;&#31243;&#24207;</span>
    <span style="color: #6434A3;">int</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">load_binary</span><span style="color: #7388D6;">)(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">linux_binprm</span> *, <span style="color: #0000FF;">struct</span>  <span style="color: #6434A3;">pt_regs</span> * <span style="color: #BA36A5;">regs</span><span style="color: #7388D6;">)</span>;
    <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">&#21152;&#36733;&#20849;&#20139;&#24211;&#65292;&#21363;&#21160;&#24577;&#24211;</span>
    <span style="color: #6434A3;">int</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">load_shlib</span><span style="color: #7388D6;">)(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">file</span> *<span style="color: #7388D6;">)</span>;
    <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">&#36755;&#20986;&#20869;&#23384;&#36716;&#20648;</span>
    <span style="color: #6434A3;">int</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">core_dump</span><span style="color: #7388D6;">)(</span><span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">signr</span>, <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">pt_regs</span> *<span style="color: #BA36A5;">regs</span>, <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">file</span> *<span style="color: #BA36A5;">file</span>, <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">limit</span><span style="color: #7388D6;">)</span>;
    <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">min_coredump</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">minimal dump size</span><span style="color: #8D8D84;"> */</span>
    <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">hasvdso</span>;
  <span style="color: #707183;">}</span>;
</pre>
</div></li>
</ol>
</div>
</li>

<li><a id="orgb2f64e3"></a><span class="todo TODO">TODO</span> 退出程序<br /></li>
</ol>
</li>

<li><a id="org0ebeb49"></a>调度器<br />
<ol class="org-ol">
<li><a id="org7e9ecc6"></a>概览<br />
<div class="outline-text-6" id="text-3-9-1-5-1">
<ul class="org-ul">
<li>调度器主要完成两件事
<ol class="org-ol">
<li>调度策略</li>
<li>切换上下文</li>
</ol></li>

<li><p>
就绪队列
调度器每次调度时，会挑选具有最高等待时间的进程，把CPU提供给该进程。调度器记录了每个进程已经
等待的时长并用红黑树从大到小排序，由于可运行进程是排队的，该结构称之为就绪队列：
</p></li>
</ul>

<div id="orga5a9514" class="figure">
<p><img src="reading/2020-11-08_22-13-35_screenshot.png" alt="2020-11-08_22-13-35_screenshot.png" />
</p>
</div>
<ul class="org-ul">
<li>虚拟时钟
就绪队列中还有个虚拟时钟的概念，它表示的是就绪队列中的每个进程*平均*推进(分配到)的时间的度量</li>
</ul>
</div>
</li>
<li><a id="org8653cd8"></a>数据结构<br />
<div class="outline-text-6" id="text-3-9-1-5-2">
<ul class="org-ul">
<li><p>
调度器系统概观
调度器使用一系列数据结构来完成器调度任务，他的各组件关系如下：
</p></li>
</ul>
<p>
<img src="reading/2020-11-08_22-31-56_screenshot.png" alt="2020-11-08_22-31-56_screenshot.png" />
        可以看到，图中主要由两个调度器组成：
</p>
<ol class="org-ol">
<li>主调度器
主要用于进程打算睡眠或出于其他原因放弃CPU</li>
<li>周期性调度器
以固定的频率周期性运行，检测是否有必要进行进程切换</li>
</ol>
<ul class="org-ul">
<li>调度器类
调度器通过查询调度器类来选择进程运行，调度器类用于判断接下来运行哪个进程，而且不同的类
具有不同的调度策略，每个进程都属于一个调度器类</li>
<li><p>
task<sub>struct中有关成员</sub>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">task_struct</span> <span style="color: #707183;">{</span>
...
<span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;"> * static_prio: &#38745;&#24577;&#20248;&#20808;&#32423;&#36827;&#31243;&#21551;&#21160;&#26102;&#20998;&#37197;&#65292;&#36827;&#31243;&#36816;&#34892;&#26399;&#38388;&#20445;&#25345;&#24658;&#23450;&#65292;&#38500;&#38750;&#29992;nice/sched_setscheduler</span>
<span style="color: #8D8D84; font-style: italic;"> * &#31995;&#32479;&#35843;&#29992;&#20462;&#25913;</span>
<span style="color: #8D8D84; font-style: italic;"> * normal_prio: &#26222;&#36890;&#20248;&#20808;&#32423;&#12290;&#22522;&#20110;&#36827;&#31243;&#30340;&#38745;&#24577;&#20248;&#20808;&#32423;&#21644;&#35843;&#24230;&#31574;&#30053;&#35745;&#31639;&#32780;&#26469;&#65292;&#25152;&#20197;&#21363;&#20351;&#23454;&#26102;&#36827;&#31243;&#21644;&#26222;&#36890;&#36827;&#31243;</span>
<span style="color: #8D8D84; font-style: italic;"> * &#30340;&#38745;&#24577;&#20248;&#20808;&#32423;&#19968;&#26679;&#65292;&#20182;&#20204;&#30340;&#26222;&#36890;&#20248;&#20808;&#32423;&#39029;&#19981;&#21516;</span>
<span style="color: #8D8D84; font-style: italic;"> * prio: &#21160;&#24577;&#20248;&#20808;&#32423;&#12290;&#35843;&#24230;&#22120;&#30452;&#25509;&#29992;&#30340;&#20248;&#20808;&#32423;&#65292;&#30001;&#20110;&#26576;&#20123;&#24773;&#20917;&#20869;&#26680;&#38656;&#35201;&#26242;&#26102;&#25552;&#39640;&#36827;&#31243;&#30340;&#20248;&#20808;&#32423;&#65292;&#22240;&#27492;&#38656;&#35201;&#36825;</span>
<span style="color: #8D8D84; font-style: italic;"> * &#31532;&#19977;&#20010;&#25104;&#21592;&#26469;&#34920;&#31034;</span>
<span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">int</span> prio, static_prio, normal_prio;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#23454;&#26102;&#36827;&#31243;&#30340;&#20248;&#20808;&#32423;, 0-99, &#20540;&#36234;&#22823;&#20248;&#20808;&#32423;&#36234;&#39640;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">rt_priority</span>; 
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span> <span style="color: #BA36A5;">run_list</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#25152;&#23646;&#35843;&#24230;&#22120;&#31867;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">const</span> <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">sched_class</span> *<span style="color: #BA36A5;">sched_class</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#35843;&#24230;&#23454;&#20307;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">sched_entity</span> <span style="color: #BA36A5;">se</span>; 
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#35843;&#24230;&#31574;&#30053;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">policy</span>;
  <span style="color: #6434A3;">cpumask_t</span> <span style="color: #BA36A5;">cpus_allowed</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">time_slice</span>;
...
<span style="color: #707183;">}</span>
</pre>
</div>
<ol class="org-ol">
<li><p>
优先级
</p>
<ul class="org-ul">
<li>用户空间
进程在用户空间表示为-20到+19（包含），值越低，优先级越高</li>
<li><p>
内核表示
内核使用0到139来表示内部优先级，nice值映射到范围100到139，0到99专用于实时进程,
也是值越低优先级越高:
</p>
<p>
<img src="reading/2020-11-08_23-44-58_screenshot.png" alt="2020-11-08_23-44-58_screenshot.png" />
三个优先级中，静态优先级由用户设置好，其他两个则由内核计算得来,计算的时机是
</p>
<ol class="org-ol">
<li>新建进程用wake<sub>up</sub><sub>new</sub><sub>task唤醒时</sub></li>
<li>调用nice系统调用改变静态优先级时</li>
</ol>
<p>
计算过程如下表：
</p></li>
</ul>

<div id="org5dac4db" class="figure">
<p><img src="reading/2020-11-09_00-04-11_screenshot.png" alt="2020-11-09_00-04-11_screenshot.png" />
</p>
</div></li>
<li>调度策略
linux支持5种调度策略，
<ul class="org-ul">
<li>映射到完全公平调度器类：SCHED<sub>NORMAL</sub>􏲹SCHED<sub>BATCH</sub>􏰓SCHED<sub>IDLE</sub></li>
<li>映射到实时调度器类：SCHED<sub>RR</sub>􏰓SCHED<sub>FIFO</sub></li>
</ul></li>
<li><p>
调度器类
调度的实际工作主要由具体的调度器类来执行，调度器类可以提供以下操作：
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">sched_class</span> <span style="color: #707183;">{</span>
  <span style="color: #0000FF;">const</span> <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">sched_class</span> *<span style="color: #BA36A5;">next</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#21521;&#23601;&#32490;&#38431;&#21015;&#28155;&#21152;&#19968;&#20010;&#36827;&#31243;&#65292;&#24403;&#36827;&#31243;&#20174;&#30561;&#30496;&#29366;&#24577;&#21464;&#20026;&#21487;&#25191;&#34892;&#29366;&#24577;&#26102;&#21457;&#29983;&#35813;&#25805;&#20316;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">void</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">enqueue_task</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">rq</span> *<span style="color: #BA36A5;">rq</span>, <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">task_struct</span> *<span style="color: #BA36A5;">p</span>, <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">wakeup</span><span style="color: #7388D6;">)</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">enqueue_task&#30340;&#36870;&#21521;&#25805;&#20316;&#65292;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">void</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">dequeue_task</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">rq</span> *<span style="color: #BA36A5;">rq</span>, <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">task_struct</span> *<span style="color: #BA36A5;">p</span>, <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">sleep</span><span style="color: #7388D6;">)</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#36827;&#31243;&#35843;&#29992;sched_yield&#20027;&#21160;&#25918;&#24323;&#22788;&#29702;&#22120;&#26102;&#65292;&#20869;&#26680;&#20250;&#35843;&#29992;&#27492;&#20989;&#25968;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">void</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">yield_task</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">rq</span> *<span style="color: #BA36A5;">rq</span><span style="color: #7388D6;">)</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#29992;&#26032;&#21796;&#37266;&#30340;&#36827;&#31243;&#26469;&#25250;&#21344;&#24403;&#21069;&#36827;&#31243;&#65292;&#22914;wake_up_new_task&#21796;&#37266;&#26032;&#36827;&#31243;&#26102;&#20250;&#35843;&#29992;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">void</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">check_preempt_curr</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">rq</span> *<span style="color: #BA36A5;">rq</span>, <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">task_struct</span> *<span style="color: #BA36A5;">p</span><span style="color: #7388D6;">)</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#36873;&#25321;&#19979;&#19968;&#20010;&#35201;&#36816;&#34892;&#30340;&#36827;&#31243;&#65292;&#38656;&#35201;&#25191;&#34892;&#19978;&#19979;&#25991;&#20999;&#25442;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">task_struct</span> * <span style="color: #7388D6;">(</span>*<span style="color: #006699;">pick_next_task</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">rq</span> *<span style="color: #BA36A5;">rq</span><span style="color: #7388D6;">)</span>;
  <span style="color: #6434A3;">void</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">put_prev_task</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">rq</span> *<span style="color: #BA36A5;">rq</span>, <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">task_struct</span> *<span style="color: #BA36A5;">p</span><span style="color: #7388D6;">)</span>;
  <span style="color: #6434A3;">void</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">set_curr_task</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">rq</span> *<span style="color: #BA36A5;">rq</span><span style="color: #7388D6;">)</span>;
  <span style="color: #6434A3;">void</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">task_tick</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">rq</span> *<span style="color: #BA36A5;">rq</span>, <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">task_struct</span> *<span style="color: #BA36A5;">p</span><span style="color: #7388D6;">)</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#24314;&#31435;fork&#19982;&#35843;&#24230;&#22120;&#30452;&#25509;&#30340;&#20851;&#32852;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">void</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">task_new</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">rq</span> *<span style="color: #BA36A5;">rq</span>, <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">task_struct</span> *<span style="color: #BA36A5;">p</span><span style="color: #7388D6;">)</span>;
<span style="color: #707183;">}</span>;
</pre>
</div></li>
</ol></li>
<li><p>
就绪队列
内核为每个CPU维护一个就绪队列runqueues，这是调度器最重要的数据结构,每个进程都出现在某一个队列中。
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #0000FF;">static</span> <span style="color: #006699;">DEFINE_PER_CPU_SHARED_ALIGNED</span><span style="color: #707183;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">rq</span>, runqueues<span style="color: #707183;">)</span>;
</pre>
</div>
<p>
这个就绪队列并不直接管理进程，而是把特定于调度器类的子就绪队列嵌入它的结构体中：
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;"> * This is the main, per-CPU runqueue data structure.</span>
<span style="color: #8D8D84; font-style: italic;"> *</span>
<span style="color: #8D8D84; font-style: italic;"> * Locking rule: those places that want to lock multiple runqueues</span>
<span style="color: #8D8D84; font-style: italic;"> * (such as the load balancing or the thread migration code), lock</span>
<span style="color: #8D8D84; font-style: italic;"> * acquire operations must be ordered by ascending &amp;runqueue.</span>
<span style="color: #8D8D84;"> */</span>
<span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">rq</span> <span style="color: #707183;">{</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">runqueue lock:</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">spinlock_t</span> <span style="color: #BA36A5;">lock</span>;

  <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">   * nr_running and cpu_load should be in the same cacheline because</span>
<span style="color: #8D8D84; font-style: italic;">   * remote CPUs use both these fields when doing load calculation.</span>
<span style="color: #8D8D84; font-style: italic;">   * &#38431;&#21015;&#19978;&#21487;&#36816;&#34892;&#30340;&#36827;&#31243;&#25968;&#30446;</span>
<span style="color: #8D8D84;">   */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">nr_running</span>;
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">CPU_LOAD_IDX_MAX</span> <span style="color: #D0372D;">5</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#35813;&#38431;&#21015;&#30340;cpu&#20043;&#21069;&#30340;&#36127;&#33655;&#29366;&#24577;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">cpu_load</span><span style="color: #7388D6;">[</span>CPU_LOAD_IDX_MAX<span style="color: #7388D6;">]</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">load_weight</span> <span style="color: #BA36A5;">load</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">cfs_rq</span> <span style="color: #BA36A5;">cfs</span>;
<span style="color: #808080;">#ifdef</span> CONFIG_FAIR_GROUP_SCHED
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">list of leaf cfs_rq on this cpu:</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span> <span style="color: #BA36A5;">leaf_cfs_rq_list</span>;
<span style="color: #808080;">#endif</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">rt_rq</span> <span style="color: #BA36A5;">rt</span>;

  <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">   * This is part of a global counter where only the total sum</span>
<span style="color: #8D8D84; font-style: italic;">   * over all CPUs matters. A task can increase this counter on</span>
<span style="color: #8D8D84; font-style: italic;">   * one CPU and if it got migrated afterwards it may decrease</span>
<span style="color: #8D8D84; font-style: italic;">   * it on another CPU. Always updated under the runqueue lock:</span>
<span style="color: #8D8D84;">   */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">nr_uninterruptible</span>;

  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">task_struct</span> *<span style="color: #BA36A5;">curr</span>, *<span style="color: #BA36A5;">idle</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#35813;&#23601;&#32490;&#38431;&#21015;&#33258;&#36523;&#30340;&#26102;&#38047;,&#27599;&#27425;&#35843;&#29992;&#21608;&#26399;&#24615;&#35843;&#24230;&#22120;&#37117;&#20250;&#26356;&#26032;clock</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">u64</span> <span style="color: #BA36A5;">clock</span>, <span style="color: #BA36A5;">prev_clock_raw</span>;
...
<span style="color: #707183;">}</span>
</pre>
</div></li>
<li><p>
调度实体
之前一直说的是调度器调度的是进程，其实这是一种简化的说法，其实每个进程的task<sub>struct中</sub>
都嵌入了一个sched<sub>entity结构</sub>, 所以调度器调度的不是进程，而是这个被称为调度实体的更一般
化的概念,其定义如下：
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">sched_entity</span> <span style="color: #707183;">{</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">load_weight</span> <span style="color: #BA36A5;">load</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#29992;&#20110;&#36127;&#36733;&#22343;&#34913;</span><span style="color: #8D8D84;">*/</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">rb_node</span> <span style="color: #BA36A5;">run_node</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">on_rq</span>;
  <span style="color: #6434A3;">u64</span> <span style="color: #BA36A5;">exec_start</span>;
  <span style="color: #6434A3;">u64</span> <span style="color: #BA36A5;">sum_exec_runtime</span>;
  <span style="color: #6434A3;">u64</span> <span style="color: #BA36A5;">vruntime</span>;
  <span style="color: #6434A3;">u64</span> <span style="color: #BA36A5;">prev_sum_exec_runtime</span>;
...
<span style="color: #707183;">}</span>
</pre>
</div></li>
<li><p>
负荷权重
进程的重要性不是直接由优先级(nice)指定的，而是要由优先级和进程调度策略计算得来的
task<sub>struct</sub>-&gt;se.load的负荷权重。具体计算概念是：进程没降低一个nice值，就多获得10%的CPU
时间，美升高一个nice值就放弃10%的CPU时间。具体对应关系为:
</p>

<div id="org0f31141" class="figure">
<p><img src="reading/2020-11-09_09-34-21_screenshot.png" alt="2020-11-09_09-34-21_screenshot.png" />
</p>
</div></li>
</ul>
</div>
</li>
<li><a id="orgfb3e583"></a>两个调度器的调度过程<br />
<div class="outline-text-6" id="text-3-9-1-5-3">
<ul class="org-ul">
<li><p>
周期性调度器
周期性调度器在scheduler<sub>tick中实现</sub>。如果系统正在活动中，内核会按照频率HZ自动调用该函数
它主要完成两个任务：
</p>
<ol class="org-ol">
<li>管理内核中与整个系统和各个进程的调度相关的统计量</li>
</ol>
<p>
<a id="org1514b1c"></a>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6434A3;">void</span> <span style="color: #006699;">scheduler_tick</span><span style="color: #707183;">(</span><span style="color: #6434A3;">void</span><span style="color: #707183;">)</span>
<span style="color: #707183;">{</span>
  <span style="color: #D0372D;">1</span>. &#31649;&#29702;&#20869;&#26680;&#20013;&#19982;&#25972;&#20010;&#31995;&#32479;&#21644;&#21508;&#20010;&#36827;&#31243;&#30340;&#35843;&#24230;&#30456;&#20851;&#30340;&#32479;&#35745;&#37327;
  <span style="color: #6434A3;">int</span> cpu = smp_processor_id<span style="color: #7388D6;">()</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">rq</span> *<span style="color: #BA36A5;">rq</span> = cpu_rq<span style="color: #7388D6;">(</span>cpu<span style="color: #7388D6;">)</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">task_struct</span> *<span style="color: #BA36A5;">curr</span> = rq-&gt;curr;

...
    <span style="color: #8D8D84;">/*</span><span style="color: #8D8D84; font-style: italic;">&#26356;&#26032;&#24403;&#21069;cpu strut rq&#30340;&#26102;&#38047;&#26102;&#38388;&#25139;</span><span style="color: #8D8D84;">*/</span>
  __update_rq_clock<span style="color: #7388D6;">(</span>rq<span style="color: #7388D6;">)</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#26356;&#26032;cpu load[]&#25968;&#32452;</span><span style="color: #8D8D84;"> */</span>
    update_cpu_load<span style="color: #7388D6;">(</span>rq<span style="color: #7388D6;">)</span>;


 <span style="color: #D0372D;">2</span>. &#28608;&#27963;&#36127;&#36131;&#24403;&#21069;&#36827;&#31243;&#30340;&#35843;&#24230;&#22120;&#31867;&#30340;&#21608;&#26399;&#24615;&#35843;&#24230;&#26041;&#27861;scheduler_tick
<span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;"> * task_tick&#22312;&#24403;&#21069;&#36827;&#31243;&#38656;&#35201;&#34987;&#37325;&#26032;&#35843;&#24230;&#26102;&#65292;&#35774;&#32622;&#35813;&#36827;&#31243;&#30340;</span>
<span style="color: #8D8D84; font-style: italic;"> * TIF_NEED_RESCHED&#26631;&#24535;,&#20869;&#26680;&#20250;&#22312;&#36820;&#22238;&#29992;&#25143;&#24577;&#21069;&#26816;&#26597;&#35813;</span>
<span style="color: #8D8D84; font-style: italic;"> * &#26631;&#24535;&#65292;&#22914;&#26524;&#35813;&#26631;&#24535;&#32622;&#20301;&#20102;&#65292;&#35843;&#29992;&#20027;&#35843;&#24230;&#22120;&#30340;schedule()&#20989;&#25968;</span>
<span style="color: #8D8D84;"> */</span>
 <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>curr != rq-&gt;idle<span style="color: #7388D6;">)</span>
   curr-&gt;sched_class-&gt;task_tick<span style="color: #7388D6;">(</span>rq, curr<span style="color: #7388D6;">)</span>;
<span style="color: #707183;">}</span>
</pre>
</div></li>
<li><p>
主调度器
内核中有许多地方会调用主调度器函数schedule()：
</p>
<ol class="org-ol">
<li>从系统调用返回用户态前<a href="#org1514b1c">链接</a></li>
<li>进程主动放弃cpu使用权</li>
</ol>
<p>
他的主要流程为：
</p>
<div class="org-src-container">
<pre class="src src-c">asmlinkage <span style="color: #6434A3;">void</span> <span style="color: #006699;">__sched</span> schedule<span style="color: #707183;">(</span><span style="color: #6434A3;">void</span><span style="color: #707183;">)</span>
<span style="color: #707183;">{</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">task_struct</span> *<span style="color: #BA36A5;">prev</span>, *<span style="color: #BA36A5;">next</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">rq</span> *<span style="color: #BA36A5;">rq</span>;
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">cpu</span>;
 <span style="color: #D0372D;">need_resched</span>:
  cpu = smp_processor_id<span style="color: #7388D6;">()</span>;
  rq = cpu_rq<span style="color: #7388D6;">(</span>cpu<span style="color: #7388D6;">)</span>;
  prev = rq-&gt;curr;
...
 __update_rq_clock<span style="color: #7388D6;">(</span>rq<span style="color: #7388D6;">)</span>;
 clear_tsk_need_resched<span style="color: #7388D6;">(</span>prev<span style="color: #7388D6;">)</span>;
...
 TODO  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">TASK_INTERRUPTIBLE &#30340;&#36827;&#31243;&#20026;&#20160;&#20040;&#33021;&#26159;cur&#36827;&#31243;</span><span style="color: #8D8D84;"> */</span>
 <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>prev-&gt;state &amp;&amp; !<span style="color: #909183;">(</span>preempt_count<span style="color: #709870;">()</span> &amp; PREEMPT_ACTIVE<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">{</span>
   <span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span>unlikely<span style="color: #709870;">(</span><span style="color: #907373;">(</span>prev-&gt;state &amp; TASK_INTERRUPTIBLE<span style="color: #907373;">)</span> &amp;&amp;
     unlikely<span style="color: #907373;">(</span>signal_pending<span style="color: #6276BA;">(</span>prev<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span> <span style="color: #909183;">{</span>
     prev-&gt;state = TASK_RUNNING;
   <span style="color: #909183;">}</span> <span style="color: #0000FF;">else</span> <span style="color: #909183;">{</span>
     deactivate_task<span style="color: #709870;">(</span>rq, prev, <span style="color: #D0372D;">1</span><span style="color: #709870;">)</span>;
   <span style="color: #909183;">}</span>
   switch_count = &amp;prev-&gt;nvcsw;
 <span style="color: #7388D6;">}</span>

...
  prev-&gt;sched_class-&gt;put_prev_task<span style="color: #7388D6;">(</span>rq, prev<span style="color: #7388D6;">)</span>;
  next = pick_next_task<span style="color: #7388D6;">(</span>rq, prev<span style="color: #7388D6;">)</span>;
...
    <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>likely<span style="color: #909183;">(</span>prev != next<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">{</span>
      rq-&gt;nr_switches++;
      rq-&gt;curr = next;
      ++*switch_count;

      context_switch<span style="color: #909183;">(</span>rq, prev, next<span style="color: #909183;">)</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">unlocks the rq</span><span style="color: #8D8D84;"> */</span>
    <span style="color: #7388D6;">}</span>
<span style="color: #707183;">}</span>
</pre>
</div>
<p>
当需要切换进程时，调用context<sub>switch</sub>():
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;"> * context_switch - switch to the new MM and the new</span>
<span style="color: #8D8D84; font-style: italic;"> * thread's register state.</span>
<span style="color: #8D8D84;"> */</span>
<span style="color: #0000FF;">static</span> <span style="color: #0000FF;">inline</span> <span style="color: #6434A3;">void</span>
<span style="color: #006699;">context_switch</span><span style="color: #707183;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">rq</span> *<span style="color: #BA36A5;">rq</span>, <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">task_struct</span> *<span style="color: #BA36A5;">prev</span>,
         <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">task_struct</span> *<span style="color: #BA36A5;">next</span><span style="color: #707183;">)</span>
<span style="color: #707183;">{</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">mm_struct</span> *<span style="color: #BA36A5;">mm</span>, *<span style="color: #BA36A5;">oldmm</span>;

  <span style="color: #006699;">prepare_task_switch</span><span style="color: #7388D6;">(</span><span style="color: #6434A3;">rq</span>, prev, next<span style="color: #7388D6;">)</span>;
  mm = next-&gt;mm;
  oldmm = prev-&gt;active_mm;
  <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">   * For paravirt, this is coupled with an exit in switch_to to</span>
<span style="color: #8D8D84; font-style: italic;">   * combine the page table reload and the switch backend into</span>
<span style="color: #8D8D84; font-style: italic;">   * one hypercall.</span>
<span style="color: #8D8D84;">   */</span>
  <span style="color: #006699;">arch_enter_lazy_cpu_mode</span><span style="color: #7388D6;">()</span>;

  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>unlikely<span style="color: #909183;">(</span>!mm<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">{</span>
    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#20869;&#26680;&#32447;&#31243;&#27809;&#26377;&#29992;&#25143;&#31354;&#38388;&#20869;&#23384;&#19978;&#19979;&#25991;&#65292;&#20250;&#20511;&#29992;prev&#30340;&#22320;&#22336;&#31354;&#38388;&#65292;</span><span style="color: #8D8D84;"> */</span>
    next-&gt;active_mm = oldmm;
    atomic_inc<span style="color: #909183;">(</span>&amp;oldmm-&gt;mm_count<span style="color: #909183;">)</span>;
    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#24816;&#24615; TLB</span><span style="color: #8D8D84;"> */</span>
    enter_lazy_tlb<span style="color: #909183;">(</span>oldmm, next<span style="color: #909183;">)</span>;
  <span style="color: #7388D6;">}</span> <span style="color: #0000FF;">else</span>
    <span style="color: #D0372D;">1</span>.<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#26356;&#25442;&#20869;&#23384;&#31649;&#29702;&#19978;&#19979;&#25991;</span><span style="color: #8D8D84;"> */</span>
    switch_mm<span style="color: #7388D6;">(</span>oldmm, mm, next<span style="color: #7388D6;">)</span>;

  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>unlikely<span style="color: #909183;">(</span>!prev-&gt;mm<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">{</span>
    prev-&gt;active_mm = <span style="color: #D0372D;">NULL</span>;
    rq-&gt;prev_mm = oldmm;
  <span style="color: #7388D6;">}</span>
  <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">   * Since the runqueue lock will be released by the next</span>
<span style="color: #8D8D84; font-style: italic;">   * task (which is an invalid locking op but in the case</span>
<span style="color: #8D8D84; font-style: italic;">   * of the scheduler it's an obvious special-case), so we</span>
<span style="color: #8D8D84; font-style: italic;">   * do an early lockdep release here:</span>
<span style="color: #8D8D84;">   */</span>
<span style="color: #808080;">#if</span><span style="color: #808080;">n</span><span style="color: #808080;">def</span> __ARCH_WANT_UNLOCKED_CTXSW
  spin_release<span style="color: #7388D6;">(</span>&amp;rq-&gt;lock.dep_map, <span style="color: #D0372D;">1</span>, _THIS_IP_<span style="color: #7388D6;">)</span>;
<span style="color: #808080;">#endif</span>

  <span style="color: #D0372D;">2</span>.<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#20999;&#25442;&#22788;&#29702;&#22120;&#23492;&#23384;&#22120;&#20869;&#23481;&#21644;&#20869;&#26680;&#26632;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Here we just switch the register state and the stack.</span><span style="color: #8D8D84;"> */</span>
  switch_to<span style="color: #7388D6;">(</span>prev, next, prev<span style="color: #7388D6;">)</span>;

  <span style="color: #006699;">barrier</span><span style="color: #7388D6;">()</span>;
  <span style="color: #D0372D;">3</span>.<span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">   * this_rq must be evaluated again because prev may have moved</span>
<span style="color: #8D8D84; font-style: italic;">   * CPUs since it called schedule(), thus the 'rq' on its stack</span>
<span style="color: #8D8D84; font-style: italic;">   * frame will be invalid.</span>
<span style="color: #8D8D84;">   */</span>
  finish_task_switch<span style="color: #7388D6;">(</span>this_rq<span style="color: #909183;">()</span>, prev<span style="color: #7388D6;">)</span>;
<span style="color: #707183;">}</span>
</pre>
</div>
<p>
其中，switch<sub>to比较复杂</sub>，如下图：
</p>
<p>
<img src="reading/2020-11-09_14-14-47_screenshot.png" alt="2020-11-09_14-14-47_screenshot.png" />
如图中右上角所示，在每个switch<sub>to调用之前</sub>，next和prev指针位于 <b>当前进程的内核栈</b> 上，
prev指向当前运行的进程，而next指向将要运行的下一个进程，如图中第一个A所示，但是，经过
几次切换然后控制权再返回至switch<sub>to之后</sub>，也就是第二个A的状态，如果不做特殊处理，
那么prev和next应该和第一个图一样，next=B，prev=A，而实际上上一个运行的进程是图中的
C。所以，switch<sub>to做了特殊处理</sub>，使得prev=C，而不是A，如图右上角所示。
</p></li>
</ul>
</div>
</li>
<li><a id="orgf3db1c3"></a>完全公平调度CFS<br />
<div class="outline-text-6" id="text-3-9-1-5-4">
<ul class="org-ul">
<li><p>
数据结构
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">cfs_rq</span> <span style="color: #707183;">{</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#24403;&#21069;&#38431;&#21015;&#25152;&#26377;&#36827;&#31243;&#30340;&#36127;&#33655;&#20540;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">load_weight</span> <span style="color: #BA36A5;">load</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#21487;&#36816;&#34892;&#36827;&#31243;&#25968;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">nr_running</span>;

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#38431;&#21015;&#19978;&#25152;&#26377;&#36827;&#31243;&#30340;&#26368;&#23567;&#34394;&#25311;&#36816;&#34892;&#26102;&#38388;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">u64</span> <span style="color: #BA36A5;">min_vruntime</span>;

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#25353;&#26102;&#38388;&#25490;&#24207;&#36827;&#31243;&#30340;&#32418;&#40657;&#26641;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">rb_root</span> <span style="color: #BA36A5;">tasks_timeline</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">rb_node</span> *<span style="color: #BA36A5;">rb_leftmost</span>;

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#24403;&#21069;&#25191;&#34892;&#36827;&#31243;&#30340;&#21487;&#35843;&#24230;&#23454;&#20307;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">sched_entity</span> *<span style="color: #BA36A5;">curr</span>
<span style="color: #707183;">}</span>
</pre>
</div></li>

<li>调度算法
<ol class="org-ol">
<li><p>
虚拟时钟(时间)
CFS并没有直接保存虚拟时钟，而是每次调度器运行时都计算一次，相关函数为update<sub>curr</sub>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #0000FF;">static</span> <span style="color: #6434A3;">void</span> <span style="color: #006699;">update_curr</span><span style="color: #707183;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">cfs_rq</span> *<span style="color: #BA36A5;">cfs_rq</span><span style="color: #707183;">)</span>
<span style="color: #707183;">{</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#24403;&#21069;&#36816;&#34892;&#36827;&#31243;</span><span style="color: #8D8D84;">*/</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">sched_entity</span> *<span style="color: #BA36A5;">curr</span> = cfs_rq-&gt;curr;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#24403;&#21069;cpu&#31561;&#24453;&#38431;&#21015;&#20013;&#33719;&#21462;&#24403;&#21069;&#23454;&#38469;&#26102;&#38047;,&#27599;&#27425;&#35843;&#24230;&#37117;&#20250;&#26356;&#26032;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">u64</span> <span style="color: #BA36A5;">now</span> = rq_of<span style="color: #7388D6;">(</span>cfs_rq<span style="color: #7388D6;">)</span>-&gt;clock;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">delta_exec</span>;

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#26080;&#20107;&#21487;&#20570;&#65292;&#36864;&#20986;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>unlikely<span style="color: #909183;">(</span>!curr<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
    <span style="color: #0000FF;">return</span>;

  <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">   * Get the amount of time the current task was running</span>
<span style="color: #8D8D84; font-style: italic;">   * since the last time we changed load (this cannot</span>
<span style="color: #8D8D84; font-style: italic;">   * overflow on 32 bits):</span>
<span style="color: #8D8D84;">   */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">exec_start&#20026;&#36827;&#31243;&#36825;&#36718;&#35843;&#24230;&#36816;&#34892;&#30340;&#24320;&#22987;&#26102;&#38388;</span><span style="color: #8D8D84;"> */</span>
  delta_exec = <span style="color: #7388D6;">(</span><span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span><span style="color: #7388D6;">)(</span>now - curr-&gt;exec_start<span style="color: #7388D6;">)</span>;

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#26356;&#26032;&#24403;&#21069;&#36827;&#31243;&#22312;CPU&#19978;&#25191;&#34892;&#33457;&#36153;&#30340;&#29289;&#29702;&#26102;&#38388;&#21644;&#34394;&#25311;&#26102;&#38388;</span><span style="color: #8D8D84;"> */</span>
  __update_curr<span style="color: #7388D6;">(</span>cfs_rq, curr, delta_exec<span style="color: #7388D6;">)</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#26356;&#26032;&#36827;&#31243;&#36816;&#34892;&#24320;&#22987;&#26102;&#38388;</span><span style="color: #8D8D84;"> */</span>
  curr-&gt;exec_start = now;

  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>entity_is_task<span style="color: #909183;">(</span>curr<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">{</span>
    <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">task_struct</span> *<span style="color: #BA36A5;">curtask</span> = task_of<span style="color: #909183;">(</span>curr<span style="color: #909183;">)</span>;

    cpuacct_charge<span style="color: #909183;">(</span>curtask, delta_exec<span style="color: #909183;">)</span>;
  <span style="color: #7388D6;">}</span>
<span style="color: #707183;">}</span>

<span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;"> * Update the current task's runtime statistics. Skip current tasks that</span>
<span style="color: #8D8D84; font-style: italic;"> * are not in our scheduling class.</span>
<span style="color: #8D8D84;"> */</span>
<span style="color: #0000FF;">static</span> <span style="color: #0000FF;">inline</span> <span style="color: #6434A3;">void</span>
<span style="color: #006699;">__update_curr</span><span style="color: #707183;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">cfs_rq</span> *<span style="color: #BA36A5;">cfs_rq</span>, <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">sched_entity</span> *<span style="color: #BA36A5;">curr</span>,
        <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">delta_exec</span><span style="color: #707183;">)</span>
<span style="color: #707183;">{</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">delta_exec_weighted</span>;
  <span style="color: #6434A3;">u64</span> <span style="color: #BA36A5;">vruntime</span>;

  schedstat_set<span style="color: #7388D6;">(</span>curr-&gt;exec_max, max<span style="color: #909183;">(</span><span style="color: #709870;">(</span><span style="color: #6434A3;">u64</span><span style="color: #709870;">)</span>delta_exec, curr-&gt;exec_max<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>;

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#36827;&#31243;&#29289;&#29702;&#26102;&#38047;</span><span style="color: #8D8D84;"> */</span>
  curr-&gt;sum_exec_runtime += delta_exec;
  schedstat_add<span style="color: #7388D6;">(</span>cfs_rq, exec_clock, delta_exec<span style="color: #7388D6;">)</span>;
  delta_exec_weighted = delta_exec;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#20844;&#24335;&#65306; delta_exec_weighted = delta_exec * NICE_0_LOAD / curr-&gt;load.weight</span><span style="color: #8D8D84;">*/</span>
  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>unlikely<span style="color: #909183;">(</span>curr-&gt;load.weight != NICE_0_LOAD<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">{</span>
    delta_exec_weighted = calc_delta_fair<span style="color: #909183;">(</span>delta_exec_weighted,
              &amp;curr-&gt;load<span style="color: #909183;">)</span>;
  <span style="color: #7388D6;">}</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#34394;&#25311;&#26102;&#38047;</span><span style="color: #8D8D84;">*/</span>
  curr-&gt;vruntime += delta_exec_weighted;

  <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">   * maintain cfs_rq-&gt;min_vruntime to be a monotonic increasing</span>
<span style="color: #8D8D84; font-style: italic;">   * value tracking the leftmost vruntime in the tree.</span>
<span style="color: #8D8D84;">   */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#22914;&#26524;&#31561;&#24453;&#26641;&#19978;&#26368;&#24038;&#36793;&#26377;&#36827;&#31243;&#22312;&#31561;&#24453;&#65292;&#21462;&#24403;&#21069;&#36827;&#31243;&#19982;&#36825;&#20010;&#26368;&#24038;&#31561;&#24453;&#36827;&#31243;&#30340;&#34394;&#25311;&#26102;&#38388;&#30340;&#26368;&#23567;&#20540;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>first_fair<span style="color: #909183;">(</span>cfs_rq<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">{</span>
    vruntime = min_vruntime<span style="color: #909183;">(</span>curr-&gt;vruntime,
        __pick_next_entity<span style="color: #709870;">(</span>cfs_rq<span style="color: #709870;">)</span>-&gt;vruntime<span style="color: #909183;">)</span>;
  <span style="color: #7388D6;">}</span> <span style="color: #0000FF;">else</span>
    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#26641;&#19978;&#27809;&#26377;&#36827;&#31243;&#31561;&#24453;&#30340;&#35805;&#65292;&#26368;&#23567;&#20540;&#23601;&#30452;&#25509;&#31561;&#20110;&#24403;&#21069;&#36827;&#31243;&#30340;&#34394;&#25311;&#26102;&#38388;</span><span style="color: #8D8D84;"> */</span>
    vruntime = curr-&gt;vruntime;

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#27599;&#20010;&#38431;&#21015;&#30340;min_vruntime&#21482;&#26377;&#34987;&#25152;&#26377;&#36827;&#31243;&#36229;&#20986;&#26102;&#25165;&#26356;&#26032;,&#30830;&#20445;min_vruntime&#21333;&#35843;&#22686;&#21152;</span><span style="color: #8D8D84;"> */</span>
  cfs_rq-&gt;min_vruntime =
    max_vruntime<span style="color: #7388D6;">(</span>cfs_rq-&gt;min_vruntime, vruntime<span style="color: #7388D6;">)</span>;
<span style="color: #707183;">}</span>
</pre>
</div>
<p>
代码流程图为：
</p>

<div id="orge10cd17" class="figure">
<p><img src="reading/2020-11-10_09-40-30_screenshot.png" alt="2020-11-10_09-40-30_screenshot.png" />
</p>
</div>

<ul class="org-ul">
<li><p>
关键思想
虚拟时间在完全公平调度器中的关键点是，红黑树的排序过程按照下面的键来排序：
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #0000FF;">static</span> <span style="color: #0000FF;">inline</span> <span style="color: #6434A3;">s64</span> <span style="color: #006699;">entity_key</span><span style="color: #707183;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">cfs_rq</span> *<span style="color: #BA36A5;">cfs_rq</span>, <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">sched_entity</span> *<span style="color: #BA36A5;">se</span><span style="color: #707183;">)</span>
<span style="color: #707183;">{</span>
  <span style="color: #0000FF;">return</span> se-&gt;vruntime - cfs_rq-&gt;min_vruntime;
<span style="color: #707183;">}</span>
</pre>
</div>

<p>
键值越小，排序位置就越靠左，因此会被更快地调度，所以进程在树上的移动规则为：
</p>
<ol class="org-ol">
<li>进程运行时，它的vruntime一定会增加，所以在树中会向右移动
而且优先级值越小（重要性越高）的进程vruntime增加越慢，因此向右移动的速度也越慢
被调度的机会就要大于次要进程，也就是能分配更多的时间</li>
<li>如果进程进入睡眠，那么它就会从就绪队列中脱离出来，其vruntime保持不变。因为每个队列的
min<sub>vruntime会单调增加为等待队列中进程虚拟时间的最小值</sub>，当进程再次醒来进入等待队列
的时候，导致进程虚拟时间vruntime小于等待队列min<sub>vruntime</sub>，那么它在红黑树中的位置
会更靠左，因为其键值变得更小了。由此也可以看出，进程的vruntime是有可能小于队列的
min<sub>vruntime的</sub>.</li>
</ol></li>
</ul></li>
<li><p>
延迟跟踪        
几个重要的时间控制参数变量：
</p>

<ul class="org-ul">
<li>进程每次调度的保证最小运行时间 sysctl<sub>sched</sub><sub>min</sub><sub>granularity</sub>
/proc/sys/kernel/sched<sub>min</sub><sub>granularity</sub><sub>ns间接控制,默认为4毫秒</sub>.</li>
<li>延迟数 sched<sub>nr</sub><sub>latency</sub>
控制一个周期中处理的最大活动进程数目，如果超出这个限制，那么延迟周期也成比例的线性扩展,
可以通过sysctl<sub>sched</sub><sub>min</sub><sub>granularity间接控制</sub>，</li>
<li><p>
sysctl<sub>sched</sub><sub>latency</sub> ：
保证每个可运行进程都至少运行一次的时间间隔，可以通过/proc/sys/kernel/sched<sub>latency</sub><sub>ns</sub>
控制默认为20毫秒。每次前两个之一改变，都会从新计算:
</p>

<p>
_<sub>sched</sub><sub>peroid确定延迟周期的长度</sub>，通常来说就是sys<sub>sched</sub><sub>latency,但如果延迟数超了的话</sub>，
改值就会线性扩展：sysctl<sub>sched</sub><sub>latency</sub> * nr<sub>running</sub> / sched<sub>nr</sub><sub>latency</sub>。 一个延迟周期
会根据进程的 <b>相对</b> 权重在进程间分配:
物理时间：
</p>
<p>
<img src="reading/2020-11-11_19-11-39_screenshot.png" alt="2020-11-11_19-11-39_screenshot.png" />
虚拟时间：
</p></li>
</ul>

<div id="orgf0bdc8f" class="figure">
<p><img src="reading/2020-11-11_20-56-12_screenshot.png" alt="2020-11-11_20-56-12_screenshot.png" />
</p>
</div>

<p>
可以看到，每个进程在一个延迟周期中分配到的虚拟时间是一样的.
</p></li>
<li><p>
加入队列
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #0000FF;">static</span> <span style="color: #6434A3;">void</span>
<span style="color: #006699;">place_entity</span><span style="color: #707183;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">cfs_rq</span> *<span style="color: #BA36A5;">cfs_rq</span>, <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">sched_entity</span> *<span style="color: #BA36A5;">se</span>, <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">initial</span><span style="color: #707183;">)</span>
<span style="color: #707183;">{</span>
  <span style="color: #6434A3;">u64</span> <span style="color: #BA36A5;">vruntime</span>;

  vruntime = cfs_rq-&gt;min_vruntime;

  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>sched_feat<span style="color: #909183;">(</span>TREE_AVG<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">{</span>
    <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">sched_entity</span> *<span style="color: #BA36A5;">last</span> = __pick_last_entity<span style="color: #909183;">(</span>cfs_rq<span style="color: #909183;">)</span>;
    <span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span>last<span style="color: #909183;">)</span> <span style="color: #909183;">{</span>
      vruntime += last-&gt;vruntime;
      vruntime &gt;&gt;= <span style="color: #D0372D;">1</span>;
    <span style="color: #909183;">}</span>
  <span style="color: #7388D6;">}</span> <span style="color: #0000FF;">else</span> <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>sched_feat<span style="color: #909183;">(</span>APPROX_AVG<span style="color: #909183;">)</span> &amp;&amp; cfs_rq-&gt;nr_running<span style="color: #7388D6;">)</span>
    vruntime += sched_vslice<span style="color: #7388D6;">(</span>cfs_rq<span style="color: #7388D6;">)</span>/<span style="color: #D0372D;">2</span>;

  <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">   * The 'current' period is already promised to the current tasks,</span>
<span style="color: #8D8D84; font-style: italic;">   * however the extra weight of the new task will slow them down a</span>
<span style="color: #8D8D84; font-style: italic;">   * little, place the new task so that it fits in the slot that</span>
<span style="color: #8D8D84; font-style: italic;">   * stays open at the end.</span>
<span style="color: #8D8D84;">   */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">initial&#34920;&#31034;se&#26159;&#26032;&#36827;&#31243;,&#22914;&#26524;se&#26159;&#26032;&#36827;&#31243;&#65292;se_vruntime&#21152;&#19968;&#20010;&#26102;&#38388;&#27573;&#65292;&#34920;&#31034;</span>
<span style="color: #8D8D84; font-style: italic;">  &#20174;&#19979;&#19968;&#20010;&#26102;&#38388;&#21608;&#26399;&#25165;&#24320;&#22987;&#35843;&#24230;&#36825;&#20010;&#26032;&#36827;&#31243;</span><span style="color: #8D8D84;">*/</span>
  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>initial &amp;&amp; sched_feat<span style="color: #909183;">(</span>START_DEBIT<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
    vruntime += sched_vslice_add<span style="color: #7388D6;">(</span>cfs_rq, se<span style="color: #7388D6;">)</span>;

  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>!initial<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">{</span>
    <span style="color: #8D8D84;">/*</span><span style="color: #8D8D84; font-style: italic;">&#22914;&#26524;se&#19981;&#26159;&#26032;&#36827;&#31243;&#65292;&#37027;&#20040;&#20026;&#20102;&#34917;&#20607;&#23427;&#30340;&#30561;&#30496;&#65292;&#32473;&#20182;&#30340;vruntime-20ms&#65292;&#20351;&#24471;&#23427;&#33021;&#26356;&#24555;(&#39532;&#19978;&#65311;)&#34987;&#35843;&#24230;</span><span style="color: #8D8D84;">*/</span>
    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">sleeps upto a single latency don't count.</span><span style="color: #8D8D84;"> */</span>
    <span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span>sched_feat<span style="color: #709870;">(</span>NEW_FAIR_SLEEPERS<span style="color: #709870;">)</span> &amp;&amp; entity_is_task<span style="color: #709870;">(</span>se<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
      vruntime -= sysctl_sched_latency;

    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">ensure we never gain time by being placed backwards.</span><span style="color: #8D8D84;"> */</span>
    vruntime = max_vruntime<span style="color: #909183;">(</span>se-&gt;vruntime, vruntime<span style="color: #909183;">)</span>;
  <span style="color: #7388D6;">}</span>

  se-&gt;vruntime = vruntime;
<span style="color: #707183;">}</span>
</pre>
</div></li>
<li><p>
选择下一个进程
</p>
<div class="org-src-container">
<pre class="src src-c">
<span style="color: #0000FF;">static</span> <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">task_struct</span> *<span style="color: #006699;">pick_next_task_fair</span><span style="color: #707183;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">rq</span> *<span style="color: #BA36A5;">rq</span><span style="color: #707183;">)</span>
<span style="color: #707183;">{</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">cfs_rq</span> *<span style="color: #BA36A5;">cfs_rq</span> = &amp;rq-&gt;cfs;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">sched_entity</span> *<span style="color: #BA36A5;">se</span>;

  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>unlikely<span style="color: #909183;">(</span>!cfs_rq-&gt;nr_running<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
    <span style="color: #0000FF;">return</span> <span style="color: #D0372D;">NULL</span>;

  <span style="color: #0000FF;">do</span> <span style="color: #7388D6;">{</span>
    se = pick_next_entity<span style="color: #909183;">(</span>cfs_rq<span style="color: #909183;">)</span>;
    cfs_rq = group_cfs_rq<span style="color: #909183;">(</span>se<span style="color: #909183;">)</span>;
  <span style="color: #7388D6;">}</span> <span style="color: #0000FF;">while</span> <span style="color: #7388D6;">(</span>cfs_rq<span style="color: #7388D6;">)</span>;

  <span style="color: #0000FF;">return</span> task_of<span style="color: #7388D6;">(</span>se<span style="color: #7388D6;">)</span>;
<span style="color: #707183;">}</span>

<span style="color: #0000FF;">static</span> <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">sched_entity</span> *<span style="color: #006699;">pick_next_entity</span><span style="color: #707183;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">cfs_rq</span> *<span style="color: #BA36A5;">cfs_rq</span><span style="color: #707183;">)</span>
<span style="color: #707183;">{</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">sched_entity</span> *<span style="color: #BA36A5;">se</span> = <span style="color: #D0372D;">NULL</span>;

  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>first_fair<span style="color: #909183;">(</span>cfs_rq<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">{</span>
    se = __pick_next_entity<span style="color: #909183;">(</span>cfs_rq<span style="color: #909183;">)</span>;
    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#23558;&#24403;&#21069;&#25191;&#34892;&#36827;&#31243;&#36864;&#38431;,&#24182;&#26816;&#26597;&#26159;&#19981;&#26159;&#36229;&#36807;&#35813;&#26102;&#38388;&#21608;&#26399;&#21487;&#20197;&#36816;&#34892;&#30340;&#26102;&#38388;</span><span style="color: #8D8D84;"> */</span>
    set_next_entity<span style="color: #909183;">(</span>cfs_rq, se<span style="color: #909183;">)</span>;
  <span style="color: #7388D6;">}</span>

  <span style="color: #0000FF;">return</span> se;
<span style="color: #707183;">}</span>
</pre>
</div></li>
<li>处理周期调度调度器</li>
<li>唤醒抢占</li>
<li>实时调度器类</li>
<li>TODO 主调度器和周期调度器的整个流程</li>
</ol></li>
</ul>
</div>
</li>
</ol>
</li>
</ol>
</div>
<div id="outline-container-orge5920e7" class="outline-4">
<h4 id="orge5920e7"><span class="section-number-4">3.9.2</span> 内存管理</h4>
<div class="outline-text-4" id="text-3-9-2">
</div>
<ol class="org-ol">
<li><a id="org4c5f549"></a>概述<br />
<div class="outline-text-5" id="text-3-9-2-1">
<p>
内存管理是内核中最复杂同时也是最重要的一部分，涵盖了许多领域：
</p>
<ol class="org-ol">
<li>内存中物理内存的管理</li>
<li>分配大块内存的伙伴系统</li>
<li>分配较小块内存的slab、slub和slob分配器</li>
<li>分配非连续内存块的vmalloc机制</li>
<li>进程的地址空间</li>
</ol>

<p>
按管理内存方法的不同，可以将计算机分为两类：
</p>
<ol class="org-ol">
<li>UMA计算机（一致内存访问 uniform memory access),内存以连续的方式组织起来，
特点是每个处理器访问每个内存区
都是同样快</li>
<li>NUMA计算机。每个CPU都有本地内存，可支持快速的访问。每个CPU也可以访问其他CPU的本地内存，
但是速度会慢一些</li>
</ol>

<div id="orgbdb383c" class="figure">
<p><img src="reading/2020-11-12_18-37-39_screenshot.png" alt="2020-11-12_18-37-39_screenshot.png" />
</p>
</div>

<p>
两种计算机都可以有不同的内存布局：
</p>
<p>
<img src="reading/2020-11-12_18-39-18_screenshot.png" alt="2020-11-12_18-39-18_screenshot.png" />
    简单描述就是：UMA内存模型除了可以是一个NUMA的内存模型（一般内存有比较大的洞时配置）以外，还可以
    配置为平坦内存模型
</p>

<p>
我们主要集中于理解UMA的平坦内存模型，因为一般的计算机都是这种模型
</p>

<ul class="org-ul">
<li>分配阶
内存区中页的数分配目的度量，阶0为2<sup>0</sup> = 1, 阶1的分配包括2<sup>1</sup> = 2&#x2026;</li>
</ul>
</div>
</li>

<li><a id="org2b3401e"></a>内存组织<br />
<ol class="org-ol">
<li><a id="org2a1a905"></a>概述<br />
<div class="outline-text-6" id="text-3-9-2-2-1">
<ul class="org-ul">
<li>NUMA
linux把内存分为有层次的几个概念。
<ol class="org-ol">
<li>首先，内存被分为多个节点，每个节点关联到一个处理器，在,内核中表示为pg<sub>data</sub><sub>t</sub></li>
<li>节点又被分为多个内存域</li>
<li>内存域关联了一个struct page数组，用来组织该内存域中的物理内存页(页帧)</li>
</ol></li>
</ul>

<div id="orgb024ed0" class="figure">
<p><img src="reading/2020-11-12_19-11-35_screenshot.png" alt="2020-11-12_19-11-35_screenshot.png" />
</p>
</div>
<ul class="org-ul">
<li>UMA
UMA可以看作是只有一个节点的NUMA(不是平坦内存模型时应该看作多个节点)</li>
</ul>
</div>
</li>
<li><a id="org0067ecf"></a>数据结构<br />
<div class="outline-text-6" id="text-3-9-2-2-2">
<ol class="org-ol">
<li><p>
节点
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #0000FF;">typedef</span> <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">pglist_data</span> <span style="color: #707183;">{</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#33410;&#28857;&#20013;&#21508;&#20010;&#20869;&#23384;&#22495;&#30340;&#25968;&#25454;&#32467;&#26500;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">zone</span> <span style="color: #BA36A5;">node_zones</span><span style="color: #7388D6;">[</span>MAX_NR_ZONES<span style="color: #7388D6;">]</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#22791;&#29992;&#33410;&#28857;&#21450;&#20854;&#20869;&#23384;&#22495;&#30340;&#21015;&#34920;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">zonelist</span> <span style="color: #BA36A5;">node_zonelists</span><span style="color: #7388D6;">[</span>MAX_ZONELISTS<span style="color: #7388D6;">]</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#33410;&#28857;&#20869;&#23384;&#22495;&#25968;&#30446;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">nr_zones</span>;
<span style="color: #808080;">#ifdef</span> CONFIG_FLAT_NODE_MEM_MAP
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">page&#23454;&#20363;&#25968;&#32452;&#30340;&#25351;&#38024;&#65292;&#29992;&#20110;&#25551;&#36848;&#25152;&#26377;&#29289;&#29702;&#20869;&#23384;&#39029;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">page</span> *<span style="color: #BA36A5;">node_mem_map</span>;
<span style="color: #808080;">#endif</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#33258;&#20030;&#20998;&#37197;&#22120;&#30340;&#23454;&#20363;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">bootmem_data</span> *<span style="color: #BA36A5;">bdata</span>;
<span style="color: #808080;">#ifdef</span> CONFIG_MEMORY_HOTPLUG
  <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">   * Must be held any time you expect node_start_pfn, node_present_pages</span>
<span style="color: #8D8D84; font-style: italic;">   * or node_spanned_pages stay constant.  Holding this will also</span>
<span style="color: #8D8D84; font-style: italic;">   * guarantee that any pfn_valid() stays that way.</span>
<span style="color: #8D8D84; font-style: italic;">   *</span>
<span style="color: #8D8D84; font-style: italic;">   * Nests above zone-&gt;lock and zone-&gt;size_seqlock.</span>
<span style="color: #8D8D84;">   */</span>
  <span style="color: #6434A3;">spinlock_t</span> <span style="color: #BA36A5;">node_size_lock</span>;
<span style="color: #808080;">#endif</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#31532;&#19968;&#20010;&#39029;&#24103;&#30340;&#36923;&#36753;&#32534;&#21495;&#65292;&#20840;&#23616;&#21807;&#19968;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">node_start_pfn</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">node_present_pages</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">total number of physical pages</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">node_spanned_pages</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">total size of physical page</span>
<span style="color: #8D8D84; font-style: italic;">                                       range, including holes</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#33410;&#28857;&#20840;&#23616;ID</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">node_id</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#20132;&#25442;&#23432;&#25252;&#36827;&#31243;&#30340;&#31561;&#24453;&#38431;&#21015;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">wait_queue_head_t</span> <span style="color: #BA36A5;">kswapd_wait</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#36127;&#36131;&#35813;&#33410;&#28857;&#30340;&#20132;&#20114;&#23432;&#25252;&#36827;&#31243;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">task_struct</span> *<span style="color: #BA36A5;">kswapd</span>;
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">kswapd_max_order</span>;
<span style="color: #707183;">}</span> <span style="color: #6434A3;">pg_data_t</span>;
</pre>
</div></li>
<li><p>
内存域
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">zone</span> <span style="color: #707183;">{</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Fields commonly accessed by the page allocator</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span>   <span style="color: #BA36A5;">pages_min</span>, <span style="color: #BA36A5;">pages_low</span>, <span style="color: #BA36A5;">pages_high</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#27700;&#21360;,&#29992;&#20110;&#39029;&#25442;&#20986;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">   * We don't know if the memory that we're going to allocate will be freeable</span>
<span style="color: #8D8D84; font-style: italic;">   * or/and it will be released eventually, so to avoid totally wasting several</span>
<span style="color: #8D8D84; font-style: italic;">   * GB of ram we must reserve some of the lower zone memory (otherwise we risk</span>
<span style="color: #8D8D84; font-style: italic;">   * to run OOM on the lower zones despite there's tons of freeable ram</span>
<span style="color: #8D8D84; font-style: italic;">   * on the higher zones). This array is recalculated at runtime if the</span>
<span style="color: #8D8D84; font-style: italic;">   * sysctl_lowmem_reserve_ratio sysctl changes.</span>
<span style="color: #8D8D84;">   */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span>   <span style="color: #BA36A5;">lowmem_reserve</span><span style="color: #7388D6;">[</span>MAX_NR_ZONES<span style="color: #7388D6;">]</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#29992;&#20110;&#26080;&#35770;&#22914;&#20309;&#37117;&#19981;&#33021;&#22833;&#36133;&#30340;&#20851;&#38190;&#20869;&#23384;&#20998;&#37197;</span><span style="color: #8D8D84;"> */</span>

<span style="color: #808080;">#ifdef</span> CONFIG_NUMA
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">node</span>;
  <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">   * zone reclaim becomes active if more unmapped pages exist.</span>
<span style="color: #8D8D84;">   */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span>   <span style="color: #BA36A5;">min_unmapped_pages</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span>   <span style="color: #BA36A5;">min_slab_pages</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">per_cpu_pageset</span>  *<span style="color: #BA36A5;">pageset</span><span style="color: #7388D6;">[</span>NR_CPUS<span style="color: #7388D6;">]</span>;
<span style="color: #808080;">#else</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">per_cpu_pageset</span>  <span style="color: #BA36A5;">pageset</span><span style="color: #7388D6;">[</span>NR_CPUS<span style="color: #7388D6;">]</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#27599;&#20010;CPU&#30340;&#20919;&#28909;&#39029;&#24103;&#21015;&#34920;</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#endif</span>
  <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">   * free areas of different sizes</span>
<span style="color: #8D8D84;">   */</span>
  <span style="color: #6434A3;">spinlock_t</span>    <span style="color: #BA36A5;">lock</span>;
<span style="color: #808080;">#ifdef</span> CONFIG_MEMORY_HOTPLUG
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">see spanned/present_pages for more description</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">seqlock_t</span>   <span style="color: #BA36A5;">span_seqlock</span>;
<span style="color: #808080;">#endif</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">free_area</span>  <span style="color: #BA36A5;">free_area</span><span style="color: #7388D6;">[</span>MAX_ORDER<span style="color: #7388D6;">]</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#29992;&#20110;&#23454;&#29616;&#20249;&#20276;&#31995;&#32479;</span><span style="color: #8D8D84;"> */</span>

<span style="color: #808080;">#if</span><span style="color: #808080;">n</span><span style="color: #808080;">def</span> CONFIG_SPARSEMEM
  <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">   * Flags for a pageblock_nr_pages block. See pageblock-flags.h.</span>
<span style="color: #8D8D84; font-style: italic;">   * In SPARSEMEM, this map is stored in struct mem_section</span>
<span style="color: #8D8D84;">   */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span>   *<span style="color: #BA36A5;">pageblock_flags</span>;
<span style="color: #808080;">#endif</span> <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">CONFIG_SPARSEMEM</span><span style="color: #8D8D84;"> */</span>


  <span style="color: #006699;">ZONE_PADDING</span><span style="color: #7388D6;">(</span>_pad1_<span style="color: #7388D6;">)</span>

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Fields commonly accessed by the page reclaim scanner</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">spinlock_t</span>    <span style="color: #BA36A5;">lru_lock</span>; 
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span>  <span style="color: #BA36A5;">active_list</span>;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#27963;&#21160;&#39029;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span>  <span style="color: #BA36A5;">inactive_list</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#19981;&#27963;&#21160;&#39029;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span>   <span style="color: #BA36A5;">nr_scan_active</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span>   <span style="color: #BA36A5;">nr_scan_inactive</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span>   <span style="color: #BA36A5;">pages_scanned</span>;     <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">since last reclaim</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span>   <span style="color: #BA36A5;">flags</span>;       <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">zone flags, see below</span><span style="color: #8D8D84;"> */</span>

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Zone statistics</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">atomic_long_t</span>   <span style="color: #BA36A5;">vm_stat</span><span style="color: #7388D6;">[</span>NR_VM_ZONE_STAT_ITEMS<span style="color: #7388D6;">]</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#32479;&#35745;&#20449;&#24687;</span><span style="color: #8D8D84;"> */</span>

  <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">   * prev_priority holds the scanning priority for this zone.  It is</span>
<span style="color: #8D8D84; font-style: italic;">   * defined as the scanning priority at which we achieved our reclaim</span>
<span style="color: #8D8D84; font-style: italic;">   * target at the previous try_to_free_pages() or balance_pgdat()</span>
<span style="color: #8D8D84; font-style: italic;">   * invokation.</span>
<span style="color: #8D8D84; font-style: italic;">   *</span>
<span style="color: #8D8D84; font-style: italic;">   * We use prev_priority as a measure of how much stress page reclaim is</span>
<span style="color: #8D8D84; font-style: italic;">   * under - it drives the swappiness decision: whether to unmap mapped</span>
<span style="color: #8D8D84; font-style: italic;">   * pages.</span>
<span style="color: #8D8D84; font-style: italic;">   *</span>
<span style="color: #8D8D84; font-style: italic;">   * Access to both this field is quite racy even on uniprocessor.  But</span>
<span style="color: #8D8D84; font-style: italic;">   * it is expected to average out OK.</span>
<span style="color: #8D8D84;">   */</span>
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">prev_priority</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#25195;&#25551;&#20248;&#20808;&#32423;</span><span style="color: #8D8D84;"> */</span>


  <span style="color: #006699;">ZONE_PADDING</span><span style="color: #7388D6;">(</span>_pad2_<span style="color: #7388D6;">)</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Rarely used or read-mostly fields</span><span style="color: #8D8D84;"> */</span>

  <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">   * wait_table   -- the array holding the hash table</span>
<span style="color: #8D8D84; font-style: italic;">   * wait_table_hash_nr_entries -- the size of the hash table array</span>
<span style="color: #8D8D84; font-style: italic;">   * wait_table_bits  -- wait_table_size == (1 &lt;&lt; wait_table_bits)</span>
<span style="color: #8D8D84; font-style: italic;">   *</span>
<span style="color: #8D8D84; font-style: italic;">   * The purpose of all these is to keep track of the people</span>
<span style="color: #8D8D84; font-style: italic;">   * waiting for a page to become available and make them</span>
<span style="color: #8D8D84; font-style: italic;">   * runnable again when possible. The trouble is that this</span>
<span style="color: #8D8D84; font-style: italic;">   * consumes a lot of space, especially when so few things</span>
<span style="color: #8D8D84; font-style: italic;">   * wait on pages at a given time. So instead of using</span>
<span style="color: #8D8D84; font-style: italic;">   * per-page waitqueues, we use a waitqueue hash table.</span>
<span style="color: #8D8D84; font-style: italic;">   *</span>
<span style="color: #8D8D84; font-style: italic;">   * The bucket discipline is to sleep on the same queue when</span>
<span style="color: #8D8D84; font-style: italic;">   * colliding and wake all in that wait queue when removing.</span>
<span style="color: #8D8D84; font-style: italic;">   * When something wakes, it must check to be sure its page is</span>
<span style="color: #8D8D84; font-style: italic;">   * truly available, a la thundering herd. The cost of a</span>
<span style="color: #8D8D84; font-style: italic;">   * collision is great, but given the expected load of the</span>
<span style="color: #8D8D84; font-style: italic;">   * table, they should be so rare as to be outweighed by the</span>
<span style="color: #8D8D84; font-style: italic;">   * benefits from the saved space.</span>
<span style="color: #8D8D84; font-style: italic;">   *</span>
<span style="color: #8D8D84; font-style: italic;">   * __wait_on_page_locked() and unlock_page() in mm/filemap.c, are the</span>
<span style="color: #8D8D84; font-style: italic;">   * primary users of these fields, and in mm/page_alloc.c</span>
<span style="color: #8D8D84; font-style: italic;">   * free_area_init_core() performs the initialization of them.</span>
<span style="color: #8D8D84;">   */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#23454;&#29616;&#19968;&#20010;&#31561;&#24453;&#38431;&#21015;&#65292;&#20379;&#31561;&#24453;&#26576;&#19968;&#39029;&#21464;&#20026;&#21487;&#29992;&#30340;&#36827;&#31243;&#20351;&#29992;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">wait_queue_head_t</span> * <span style="color: #BA36A5;">wait_table</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span>   <span style="color: #BA36A5;">wait_table_hash_nr_entries</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span>   <span style="color: #BA36A5;">wait_table_bits</span>;

  <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">   * Discontig memory support fields.</span>
<span style="color: #8D8D84;">   */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">pglist_data</span>  *<span style="color: #BA36A5;">zone_pgdat</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#20869;&#23384;&#22495;&#25152;&#22312;&#33410;&#28857;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">zone_start_pfn == zone_start_paddr &gt;&gt; PAGE_SHIFT</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span>   <span style="color: #BA36A5;">zone_start_pfn</span>;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#20869;&#23384;&#22495;&#20013;&#31532;&#19968;&#20010;&#39029;&#24103;&#30340;&#32034;&#24341;</span><span style="color: #8D8D84;"> */</span>

  <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">   * zone_start_pfn, spanned_pages and present_pages are all</span>
<span style="color: #8D8D84; font-style: italic;">   * protected by span_seqlock.  It is a seqlock because it has</span>
<span style="color: #8D8D84; font-style: italic;">   * to be read outside of zone-&gt;lock, and it is done in the main</span>
<span style="color: #8D8D84; font-style: italic;">   * allocator path.  But, it is written quite infrequently.</span>
<span style="color: #8D8D84; font-style: italic;">   *</span>
<span style="color: #8D8D84; font-style: italic;">   * The lock is declared along with zone-&gt;lock because it is</span>
<span style="color: #8D8D84; font-style: italic;">   * frequently read in proximity to zone-&gt;lock.  It's good to</span>
<span style="color: #8D8D84; font-style: italic;">   * give them a chance of being in the same cacheline.</span>
<span style="color: #8D8D84;">   */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span>   <span style="color: #BA36A5;">spanned_pages</span>;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">total size, including holes</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span>   <span style="color: #BA36A5;">present_pages</span>;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">amount of memory (excluding holes)</span><span style="color: #8D8D84;"> */</span>

  <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">   * rarely used fields:</span>
<span style="color: #8D8D84;">   */</span>
  <span style="color: #0000FF;">const</span> <span style="color: #6434A3;">char</span>    *<span style="color: #BA36A5;">name</span>;
<span style="color: #707183;">}</span> <span style="color: #BA36A5;">____cacheline_internodealigned_in_smp</span>;
</pre>
</div>
<p>
该结构被访问的非常频繁，而且可能同时被多个处理器访问，所以结构体中有两个自旋锁。
为了确保每个自旋锁都在自己的缓存行中，该结构由ZONE<sub>PADDING分隔为几个部分</sub>,
</p></li>
<li>TODO 水印的计算</li>
<li><p>
冷热页
内核说的页是热的，意味着页已经加载到CPU高速缓存。其数据结构如下：
</p>
<div class="org-src-container">
<pre class="src src-c">
<span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">zone</span> <span style="color: #707183;">{</span>
...
<span style="color: #0000FF;">struct</span> per_cpu_pageset pageset<span style="color: #7388D6;">[</span>NR_CPUS<span style="color: #7388D6;">]</span>;
...
<span style="color: #707183;">}</span>;


<span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">per_cpu_pageset</span> <span style="color: #707183;">{</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">per_cpu_pages</span> <span style="color: #BA36A5;">pcp</span><span style="color: #7388D6;">[</span><span style="color: #D0372D;">2</span><span style="color: #7388D6;">]</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">0&#23545;&#20110;&#28909;&#39029;&#65292;1&#23545;&#24212;&#20919;&#39029;</span><span style="color: #8D8D84;"> */</span>
<span style="color: #707183;">}</span> <span style="color: #BA36A5;">____cacheline_aligned_in_smp</span>;



<span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">per_cpu_pages</span> <span style="color: #707183;">{</span>
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">count</span>;    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">number of pages in the list</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">high</span>;   <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">high watermark, emptying needed</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">batch</span>;    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">chunk size for buddy add/remove</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span> <span style="color: #BA36A5;">list</span>;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">the list of pages</span><span style="color: #8D8D84;"> */</span>
<span style="color: #707183;">}</span>
</pre>
</div>

<div id="orgc4ae338" class="figure">
<p><img src="reading/2020-11-12_20-21-59_screenshot.png" alt="2020-11-12_20-21-59_screenshot.png" />
</p>
</div></li>
<li><p>
页帧
页帧代表系统内存的最小单位，对于内存中的每个页都会创建struct page的一个实例。所以
该结构应该尽可能小以节约内存
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">page</span> <span style="color: #707183;">{</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">flags</span>;    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Atomic flags, some possibly</span>
<span style="color: #8D8D84; font-style: italic;">           * updated asynchronously</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">atomic_t</span> <span style="color: #BA36A5;">_count</span>;    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Usage count, see below.</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">union</span> <span style="color: #7388D6;">{</span>
    <span style="color: #6434A3;">atomic_t</span> <span style="color: #BA36A5;">_mapcount</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Count of ptes mapped in mms,</span>
<span style="color: #8D8D84; font-style: italic;">           * to show when page is mapped</span>
<span style="color: #8D8D84; font-style: italic;">           * &amp; limit reverse map searches.</span>
<span style="color: #8D8D84;">           */</span>
    <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">inuse</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">SLUB: Nr of objects</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #7388D6;">}</span>;
  <span style="color: #0000FF;">union</span> <span style="color: #7388D6;">{</span>
      <span style="color: #0000FF;">struct</span> <span style="color: #909183;">{</span>
    <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">private</span>;    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Mapping-private opaque data:</span>
<span style="color: #8D8D84; font-style: italic;">             * usually used for buffer_heads</span>
<span style="color: #8D8D84; font-style: italic;">             * if PagePrivate set; used for</span>
<span style="color: #8D8D84; font-style: italic;">             * swp_entry_t if PageSwapCache;</span>
<span style="color: #8D8D84; font-style: italic;">             * indicates order in the buddy</span>
<span style="color: #8D8D84; font-style: italic;">             * system if PG_buddy is set.</span>
<span style="color: #8D8D84;">             */</span>
    <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">address_space</span> *<span style="color: #BA36A5;">mapping</span>;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">If low bit clear, points to</span>
<span style="color: #8D8D84; font-style: italic;">             * inode address_space, or NULL.</span>
<span style="color: #8D8D84; font-style: italic;">             * If page mapped as anonymous</span>
<span style="color: #8D8D84; font-style: italic;">             * memory, low bit is set, and</span>
<span style="color: #8D8D84; font-style: italic;">             * it points to anon_vma object:</span>
<span style="color: #8D8D84; font-style: italic;">             * see PAGE_MAPPING_ANON below.</span>
<span style="color: #8D8D84;">             */</span>
      <span style="color: #909183;">}</span>;
<span style="color: #808080;">#if</span> NR_CPUS &gt;= CONFIG_SPLIT_PTLOCK_CPUS
      <span style="color: #6434A3;">spinlock_t</span> <span style="color: #BA36A5;">ptl</span>;
<span style="color: #808080;">#endif</span>
      <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">kmem_cache</span> *<span style="color: #BA36A5;">slab</span>;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">SLUB: Pointer to slab</span><span style="color: #8D8D84;"> */</span>
      <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">page</span> *<span style="color: #BA36A5;">first_page</span>;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Compound tail pages</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #7388D6;">}</span>;
  <span style="color: #0000FF;">union</span> <span style="color: #7388D6;">{</span>
    <span style="color: #6434A3;">pgoff_t</span> <span style="color: #BA36A5;">index</span>;    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Our offset within mapping.</span><span style="color: #8D8D84;"> */</span>
    <span style="color: #6434A3;">void</span> *<span style="color: #BA36A5;">freelist</span>;   <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">SLUB: freelist req. slab lock</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #7388D6;">}</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span> <span style="color: #BA36A5;">lru</span>;   <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Pageout list, eg. active_list</span>
<span style="color: #8D8D84; font-style: italic;">           * protected by zone-&gt;lru_lock !</span>
<span style="color: #8D8D84;">           */</span>
  <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">   * On machines where all RAM is mapped into kernel address space,</span>
<span style="color: #8D8D84; font-style: italic;">   * we can simply calculate the virtual address. On machines with</span>
<span style="color: #8D8D84; font-style: italic;">   * highmem some memory is mapped into kernel virtual memory</span>
<span style="color: #8D8D84; font-style: italic;">   * dynamically, so we need a place to store that address.</span>
<span style="color: #8D8D84; font-style: italic;">   * Note that this field could be 16 bits on x86 ... ;)</span>
<span style="color: #8D8D84; font-style: italic;">   *</span>
<span style="color: #8D8D84; font-style: italic;">   * Architectures with slow multiplication can define</span>
<span style="color: #8D8D84; font-style: italic;">   * WANT_PAGE_VIRTUAL in asm/page.h</span>
<span style="color: #8D8D84;">   */</span>
<span style="color: #808080;">#if</span> <span style="color: #808080;">defined</span><span style="color: #7388D6;">(</span>WANT_PAGE_VIRTUAL<span style="color: #7388D6;">)</span>
  <span style="color: #6434A3;">void</span> *<span style="color: #BA36A5;">virtual</span>;      <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Kernel virtual address (NULL if</span>
<span style="color: #8D8D84; font-style: italic;">             not kmapped, ie. highmem)</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#endif</span> <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">WANT_PAGE_VIRTUAL</span><span style="color: #8D8D84;"> */</span>
<span style="color: #707183;">}</span>;
</pre>
</div></li>
</ol>
</div>
</li>
</ol>
</li>
<li><a id="org910e7da"></a><span class="todo TODO">TODO</span> 页表<br /></li>
<li><a id="orgc3438cc"></a>初始化内存管理<br />
<div class="outline-text-5" id="text-3-9-2-4">
<p>
linux内存的初始化过程，首先会执行一些特定于处理器的操作，这些操作主要用于确定系统中内存的总数量，
及其在各个节点和内存域之间的分配情况。之后是关键的pg<sub>data</sub><sub>t数据结构的初始化</sub>
</p>
</div>
<ol class="org-ol">
<li><a id="orgaae35e8"></a>建立数据结构<br />
<div class="outline-text-6" id="text-3-9-2-4-1">
<p>
对于数据结构的初始化从全局启动例程start<sub>kernel开始的</sub>，它在加载内核并激活各个子系统之后执行。
其代码流程如下：
</p>

<div id="orgeb3ab8d" class="figure">
<p><img src="reading/2020-11-13_17-48-56_screenshot.png" alt="2020-11-13_17-48-56_screenshot.png" />
</p>
</div>
<ul class="org-ul">
<li>setup<sub>arch</sub>：负责初始化自举分配器</li>
<li>set<sub>per</sub><sub>cpu</sub><sub>areas</sub>: 初始化静态per-cpu变量</li>
<li><p>
build<sub>all</sub><sub>zonelists</sub>: 建立节点和内存域的数据结构
主要是建立节点的备用列表，用于在节点本身没有空闲空间时按先后顺序在备用列表中分配:
</p>
<p>
<img src="reading/2020-11-13_18-20-30_screenshot.png" alt="2020-11-13_18-20-30_screenshot.png" />
其中，
</p></li>
</ul>

<div id="org74351ba" class="figure">
<p><img src="reading/2020-11-13_18-22-03_screenshot.png" alt="2020-11-13_18-22-03_screenshot.png" />
</p>
</div>
<ul class="org-ul">
<li>mem<sub>init</sub>：停用bootmem分配器并迁移到实际的内存管理函数</li>
<li>kmem<sub>cache</sub><sub>init</sub>:初始化内核内部用于小块内存区的分配器</li>
<li>set<sub>per</sub><sub>cpu</sub><sub>pageset</sub>:</li>
</ul>
</div>
<ol class="org-ol">
<li><a id="orgf35d7ba"></a><a id="orgeecaf46"></a><br />
<div class="outline-text-7" id="text-3-9-2-4-1-1">
<ol class="org-ol">
<li><p>
内核的内存布局
我们只考虑默认情况，即内核被装载到物理内存中的一个固定位置。当然这也是可以配置的。
内核占据的内存大概分为几个段：
</p>
<p>
<img src="reading/2020-11-13_18-43-14_screenshot.png" alt="2020-11-13_18-43-14_screenshot.png" />
下面是linux在I-32下的布局：
</p>
<p>
<img src="reading/2020-11-13_18-44-09_screenshot.png" alt="2020-11-13_18-44-09_screenshot.png" />
这里内核从第一兆字节开始, AMD64下则会从第二兆字节开始
</p></li>
<li><p>
<a id="orgf9c75b1"></a>
在内核已经载入内存在内存管理方面后会执行一些特定于系统的步骤：
</p>

<div id="org5846af4" class="figure">
<p><img src="reading/2020-11-13_18-47-39_screenshot.png" alt="2020-11-13_18-47-39_screenshot.png" />
</p>
</div>
<ul class="org-ul">
<li>machine<sub>specific</sub><sub>memory</sub><sub>setup</sub>:
创建一个包括系统占用内存区和空闲内存区的的列表，会用到BIOS提供的信息</li>
<li>parse<sub>early</sub><sub>param</sub>:
分析命令行，用于手工划分内存区（因为BIOS提供的值可能不正确）</li>
<li>setup<sub>memory</sub>:
<ol class="org-ol">
<li>确定每个结点可用的物理内存数目</li>
<li>初始化bootmem分配器</li>
<li>分配各种内存区</li>
</ol></li>
<li><p>
paging<sub>init</sub>:
初始化内核页表并启动内存分页。
</p>

<p>
值的注意的是，低端内存中的所有页帧都直接映射到PAGE<sub>OFFSET之上的虚拟内存区</sub>。
这使得内核无需通过页表就可以直接寻址相当一部分内存
</p></li>
<li><p>
zone<sub>sizes</sub><sub>init</sub>：
初始化系统中所有结点的pgdat<sub>t实例</sub>
</p>

<p>
AMD64下有所改变，但做的事都差不多，主要的区别就是AMD64的init<sub>memory</sub><sub>mapping函数</sub>
可以把所有物理内存直接映射到内核虚拟内存区,而不仅限于低端内存:
</p></li>
</ul>

<div id="org3215da8" class="figure">
<p><img src="reading/2020-11-13_19-16-10_screenshot.png" alt="2020-11-13_19-16-10_screenshot.png" />
</p>
</div></li>
<li><p>
分页机制初始化(64位)
paging<sub>init负责建立只能用于内核的也表,用户空间无法访问</sub>
我们主要关注AMD64的虚拟内存和分页：
</p>
<ul class="org-ul">
<li><p>
虚拟地址到物理地址空间的映射方式：
</p>
<p>
<img src="reading/2020-11-13_20-22-45_screenshot.png" alt="2020-11-13_20-22-45_screenshot.png" />
因为现在AMD64处理器物理地址限制在48位，所以linux的虚拟地址映射分了非规范区，这个区域
是不会访问到的,只有上半部(内核空间)和下半部(用户空间)能访问。 如下图：
</p></li>
</ul>

<div id="orgac18175" class="figure">
<p><img src="reading/2020-11-13_20-25-22_screenshot.png" alt="2020-11-13_20-25-22_screenshot.png" />
</p>
</div></li>
<li><p>
bootmem分配器
bootmem分配器用于在启动阶段早期分配内存,因为只在初始化时使用，不难想到，它的需求集中
在简单性方面，而不是性能和通用性，所以该分配器使用一个位图来管理页，一个位表示一个物理页。
分配算法采用最先适配算法(first-best)。
</p>
<ul class="org-ul">
<li>数据结构：</li>
</ul>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #0000FF;">typedef</span> <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">bootmem_data</span> <span style="color: #707183;">{</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#31995;&#32479;&#20013;&#31532;&#19968;&#39029;&#30340;&#32534;&#21495;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">node_boot_start</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">ZONE_NORMAL&#30340;&#32467;&#26463;&#39029;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">node_low_pfn</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#20301;&#22270;&#25351;&#38024;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">void</span> *<span style="color: #BA36A5;">node_bootmem_map</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">last_offset</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">last_pos</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">last_success</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Previous allocation point.  To speed</span>
<span style="color: #8D8D84; font-style: italic;">                               * up searching</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span> <span style="color: #BA36A5;">list</span>;
<span style="color: #707183;">}</span> <span style="color: #6434A3;">bootmem_data_t</span>;
</pre>
</div>
<p>
所有的分配器(UMA系统只有一个)都保存在一个全局bdata<sub>list中</sub>
</p>

<ul class="org-ul">
<li>初始化(AMD64)
<ol class="org-ol">
<li>bootmem<sub>bootmap</sub><sub>bitmap利用BIOS在e820映射的信息计算bootmem位图所需页的数目</sub>。</li>
<li>init<sub>bootmem将该信息填充到bootmem数据结构中</sub>。</li>
</ol></li>
<li>API(TODO)</li>
</ul></li>
<li>释放初始化数据
许多内核代码快和数据表只在系统初始化阶段需要，所以内核提供了两个属性(<sub>init和</sub><sub>initcall</sub>)
用于标记初始化函数和数据。它们被编译器安排在一个特别的段中(.init.data, .init.text)，
在启动过程刚好结束时会调用free<sub>initmem函数来释放这些区域</sub>，并将其返回伙伴系统。紧接其后
init作为系统中第一个进程启动.</li>
</ol>
</div>
</li>
</ol>
</li>
</ol>
</li>
<li><a id="org1854fcb"></a>物理内存的管理(伙伴系统)<br />
<div class="outline-text-5" id="text-3-9-2-5">
<p>
内核初始完成后，内存管理交给伙伴系统。它结合了分配器的两个关键特征:速度和效率
</p>
</div>
<ol class="org-ol">
<li><a id="orgd44e0b4"></a>数据结构<br />
<div class="outline-text-6" id="text-3-9-2-5-1">
<p>
管理伙伴系统的数据存在于内存域结构体中:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">zone</span><span style="color: #707183;">{</span>
  ...
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#19981;&#21516;&#38454;&#30340;&#20869;&#23384;&#21306;&#22495;, MAX_ORDER&#19968;&#33324;&#20026;11</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> free_area free_area<span style="color: #7388D6;">[</span>MAX_ORDER<span style="color: #7388D6;">]</span>;
  ...
<span style="color: #707183;">}</span>;

<span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">free_area</span> <span style="color: #707183;">{</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span> <span style="color: #BA36A5;">free_list</span><span style="color: #7388D6;">[</span>MIGRATE_TYPES<span style="color: #7388D6;">]</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#31354;&#38386;&#20869;&#23384;&#22359;&#30340;&#25968;&#30446;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">nr_free</span>;
<span style="color: #707183;">}</span>;
</pre>
</div>
<p>
可以图示如下：
</p>
<p>
<img src="reading/2020-11-13_21-51-32_screenshot.png" alt="2020-11-13_21-51-32_screenshot.png" />
      可以看到，伙伴系统相当简介，所以管理工作也非常少，这也是它的一个主要优点.
</p>

<p>
就像前面说的，内存域有备用列表，所以伙伴系统也通过备用列表连接起来了：
</p>

<div id="org0681c7e" class="figure">
<p><img src="reading/2020-11-13_21-55-49_screenshot.png" alt="2020-11-13_21-55-49_screenshot.png" />
</p>
</div>
</div>
</li>

<li><a id="orgf47ab38"></a>避免碎片<br />
<div class="outline-text-6" id="text-3-9-2-5-2">
<p>
在系统长期运行后，物理内存会产生很多的碎片:
</p>
<p>
<img src="reading/2020-11-13_22-16-14_screenshot.png" alt="2020-11-13_22-16-14_screenshot.png" />
     如上图，左边是有碎片的情况，内核才会涉及内存碎片(用户态在分配巨型页的情况下也会涉及),
     内核会有内存碎片问题的原因：
</p>
<ol class="org-ol">
<li>有些底层指令（如lcr3）需要用到物理地址，所以直接映射不需要经过页表就能直接算出物理地址，</li>
<li>确实需要连续的物理内存</li>
</ol>

<p>
所以内核加入了两种机制来尽量防止碎片：
</p>
<ol class="org-ol">
<li><p>
将内存域内部的空闲内存按能不能移动分类
具体来说，内核将已分配的页分为下面3种不同类型：
</p>
<ul class="org-ul">
<li>不可移动页</li>
<li>可回收页
不能移动，但可以删除来重新装其他内容。映射自文件的数据属于这种类型。
kswapd守护进程会周期性释放此类内存</li>
<li>可移动页
可以随意移动的页。 属于用户空间的应用程序的页属于该类别</li>
</ul>

<p>
正如我们看到的，在伙伴系统中:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">free_area</span> <span style="color: #707183;">{</span>
    <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span> <span style="color: #BA36A5;">free_list</span><span style="color: #7388D6;">[</span>MIGRATE_TYPES<span style="color: #7388D6;">]</span>;
    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#31354;&#38386;&#20869;&#23384;&#22359;&#30340;&#25968;&#30446;</span><span style="color: #8D8D84;"> */</span>
    <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">nr_free</span>;
  <span style="color: #707183;">}</span>;
</pre>
</div>
<p>
空闲列表分为了MIGRSTE<sub>TYPES的列表</sub>，MIGRATE<sub>TYPES也就是上面说的页的分类类型数</sub>
与内存域之间的备用列表一样，这些不同类型内存间也有备用列表：
</p>
<p>
<img src="reading/2020-11-14_19-47-15_screenshot.png" alt="2020-11-14_19-47-15_screenshot.png" /> 
当然，如果各迁移类型链表中如果没有一块较大的连续内存的话，这种分类没有任何好处，因此在可用
内存太少时内核会关闭该特性。
</p>

<p>
分类后的一个问题是：既然分类了，那分配内存时必须指定要分配哪种类型的内存。这是通过分配掩码
来指定的。如果停用了分类特性，那所有页都是不可移动的。
</p>

<p>
值得注意的是，内核并未在一开始划分内存为可移动性不同的区。
</p></li>

<li>TODO : 虚拟内存域 ZONE<sub>MOVABLE</sub>
好像与第一种有点冲突？可以同时激活吗？</li>
</ol>
</div>
</li>


<li><a id="orgcca8b59"></a>初始化内存域和结点数据结构<br />
<div class="outline-text-6" id="text-3-9-2-5-3">
<p>
我们已经知道，<a href="#orgeecaf46">体系结构特定</a> 的<a href="#orgf9c75b1">初始化步骤前四步</a>已经在启动过程中建立以下信息：
</p>
<ul class="org-ul">
<li>各个内存域的页帧边界,max<sub>zone</sub><sub>pfn</sub></li>
<li>各个结点页帧的分配情况,early<sub>node</sub><sub>map</sub></li>
</ul>
<p>
现在需要做最后一步来完成内存域和结点数据结构的初始化:
该步骤由free<sub>area</sub><sub>init</sub><sub>nodes完成</sub>：
</p>

<div id="orgc986a85" class="figure">
<p><img src="reading/2020-11-14_21-25-12_screenshot.png" alt="2020-11-14_21-25-12_screenshot.png" />
</p>
</div>
<ul class="org-ul">
<li>calculate<sub>node</sub><sub>totalpages</sub>：计算结点中页的总数</li>
<li><b>alloc<sub>node</sub><sub>mem</sub><sub>map负责初始化每个物理页对应的struct</sub> page实例</b></li>
<li>free<sub>area</sub><sub>init</sub><sub>core</sub>:初始化zone结构各个表头，并将所有成员初始化为0,所以这里也会把zone中
的nr<sub>free设置为0</sub>。直到停用bootmem分配器，伙伴系统生效，才会设置正确的值</li>
</ul>
</div>
</li>
<li><a id="org2b1b999"></a>分配器API<br />
<ol class="org-ol">
<li><a id="org68c13cf"></a>API<br />
<div class="outline-text-7" id="text-3-9-2-5-4-1">
<p>
分配最终都归于alloc<sub>pages</sub><sub>node函数</sub>：
</p>

<div id="orgb515ae8" class="figure">
<p><img src="reading/2020-11-15_09-49-09_screenshot.png" alt="2020-11-15_09-49-09_screenshot.png" />
</p>
</div>

<p>
释放最终都归于_<sub>free</sub><sub>pages函数</sub>：
</p>

<div id="org07eb8a9" class="figure">
<p><img src="reading/2020-11-15_09-51-43_screenshot.png" alt="2020-11-15_09-51-43_screenshot.png" />
</p>
</div>
</div>
</li>
<li><a id="orgc194196"></a>分配掩码<br />
<div class="outline-text-7" id="text-3-9-2-5-4-2">
<p>
上面的所以函数都强制使用了分配掩码mask参数:
</p>
<p>
<img src="reading/2020-11-15_09-53-58_screenshot.png" alt="2020-11-15_09-53-58_screenshot.png" />
         他们的定义为：
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;"> * GFP bitmasks..</span>
<span style="color: #8D8D84; font-style: italic;"> *</span>
<span style="color: #8D8D84; font-style: italic;"> * Zone modifiers (see linux/mmzone.h - low three bits)</span>
<span style="color: #8D8D84; font-style: italic;"> *</span>
<span style="color: #8D8D84; font-style: italic;"> * Do not put any conditional on these. If necessary modify the definitions</span>
<span style="color: #8D8D84; font-style: italic;"> * without the underscores and use the consistently. The definitions here may</span>
<span style="color: #8D8D84; font-style: italic;"> * be used in bit comparisons.</span>
<span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">__GFP_DMA</span> <span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>__force <span style="color: #6434A3;">gfp_t</span><span style="color: #7388D6;">)</span><span style="color: #D0372D;">0x01u</span><span style="color: #707183;">)</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">__GFP_HIGHMEM</span> <span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>__force <span style="color: #6434A3;">gfp_t</span><span style="color: #7388D6;">)</span><span style="color: #D0372D;">0x02u</span><span style="color: #707183;">)</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">__GFP_DMA32</span> <span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>__force <span style="color: #6434A3;">gfp_t</span><span style="color: #7388D6;">)</span><span style="color: #D0372D;">0x04u</span><span style="color: #707183;">)</span>

<span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;"> * Action modifiers - doesn't change the zoning</span>
<span style="color: #8D8D84; font-style: italic;"> *</span>
<span style="color: #8D8D84; font-style: italic;"> * __GFP_REPEAT: Try hard to allocate the memory, but the allocation attempt</span>
<span style="color: #8D8D84; font-style: italic;"> * _might_ fail.  This depends upon the particular VM implementation.</span>
<span style="color: #8D8D84; font-style: italic;"> *</span>
<span style="color: #8D8D84; font-style: italic;"> * __GFP_NOFAIL: The VM implementation _must_ retry infinitely: the caller</span>
<span style="color: #8D8D84; font-style: italic;"> * cannot handle allocation failures.</span>
<span style="color: #8D8D84; font-style: italic;"> *</span>
<span style="color: #8D8D84; font-style: italic;"> * __GFP_NORETRY: The VM implementation must not retry indefinitely.</span>
<span style="color: #8D8D84; font-style: italic;"> *</span>
<span style="color: #8D8D84; font-style: italic;"> * __GFP_MOVABLE: Flag that this page will be movable by the page migration</span>
<span style="color: #8D8D84; font-style: italic;"> * mechanism or reclaimed</span>
<span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">__GFP_WAIT</span>  <span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>__force <span style="color: #6434A3;">gfp_t</span><span style="color: #7388D6;">)</span><span style="color: #D0372D;">0x10u</span><span style="color: #707183;">)</span>  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Can wait and reschedule?</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">__GFP_HIGH</span>  <span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>__force <span style="color: #6434A3;">gfp_t</span><span style="color: #7388D6;">)</span><span style="color: #D0372D;">0x20u</span><span style="color: #707183;">)</span>  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Should access emergency pools?</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">__GFP_IO</span>  <span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>__force <span style="color: #6434A3;">gfp_t</span><span style="color: #7388D6;">)</span><span style="color: #D0372D;">0x40u</span><span style="color: #707183;">)</span>  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Can start physical IO?</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">__GFP_FS</span>  <span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>__force <span style="color: #6434A3;">gfp_t</span><span style="color: #7388D6;">)</span><span style="color: #D0372D;">0x80u</span><span style="color: #707183;">)</span>  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Can call down to low-level FS?</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">__GFP_COLD</span>  <span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>__force <span style="color: #6434A3;">gfp_t</span><span style="color: #7388D6;">)</span><span style="color: #D0372D;">0x100u</span><span style="color: #707183;">)</span> <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Cache-cold page required</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">__GFP_NOWARN</span>  <span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>__force <span style="color: #6434A3;">gfp_t</span><span style="color: #7388D6;">)</span><span style="color: #D0372D;">0x200u</span><span style="color: #707183;">)</span> <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Suppress page allocation failure warning</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">__GFP_REPEAT</span>  <span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>__force <span style="color: #6434A3;">gfp_t</span><span style="color: #7388D6;">)</span><span style="color: #D0372D;">0x400u</span><span style="color: #707183;">)</span> <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Retry the allocation.  Might fail</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">__GFP_NOFAIL</span>  <span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>__force <span style="color: #6434A3;">gfp_t</span><span style="color: #7388D6;">)</span><span style="color: #D0372D;">0x800u</span><span style="color: #707183;">)</span> <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Retry for ever.  Cannot fail</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">__GFP_NORETRY</span> <span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>__force <span style="color: #6434A3;">gfp_t</span><span style="color: #7388D6;">)</span><span style="color: #D0372D;">0x1000u</span><span style="color: #707183;">)</span><span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Do not retry.  Might fail</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">__GFP_COMP</span>  <span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>__force <span style="color: #6434A3;">gfp_t</span><span style="color: #7388D6;">)</span><span style="color: #D0372D;">0x4000u</span><span style="color: #707183;">)</span><span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Add compound page metadata</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">__GFP_ZERO</span>  <span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>__force <span style="color: #6434A3;">gfp_t</span><span style="color: #7388D6;">)</span><span style="color: #D0372D;">0x8000u</span><span style="color: #707183;">)</span><span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Return zeroed page on success</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">__GFP_NOMEMALLOC</span> <span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>__force <span style="color: #6434A3;">gfp_t</span><span style="color: #7388D6;">)</span><span style="color: #D0372D;">0x10000u</span><span style="color: #707183;">)</span> <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Don't use emergency reserves</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">__GFP_HARDWALL</span>   <span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>__force <span style="color: #6434A3;">gfp_t</span><span style="color: #7388D6;">)</span><span style="color: #D0372D;">0x20000u</span><span style="color: #707183;">)</span> <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Enforce hardwall cpuset memory allocs</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">__GFP_THISNODE</span>  <span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>__force <span style="color: #6434A3;">gfp_t</span><span style="color: #7388D6;">)</span><span style="color: #D0372D;">0x40000u</span><span style="color: #707183;">)</span><span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">No fallback, no policies</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">__GFP_RECLAIMABLE</span> <span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>__force <span style="color: #6434A3;">gfp_t</span><span style="color: #7388D6;">)</span><span style="color: #D0372D;">0x80000u</span><span style="color: #707183;">)</span> <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Page is reclaimable</span><span style="color: #8D8D84;"> */</span>
<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#19981;&#20250;&#24433;&#21709;&#20869;&#26680;&#30340;&#20915;&#31574;&#65292;&#38500;&#38750;&#23427;&#19982;__GFP_HIGHMEM&#21516;&#26102;&#25351;&#23450;&#12290;&#36825;&#20013;&#24773;&#20917;&#19979;&#65292;&#20250;&#20351;&#29992;&#29305;&#27530;&#30340;&#34394;&#25311;</span>
<span style="color: #8D8D84; font-style: italic;">*  &#20869;&#23384;&#22495;ZONE_MOVABLE&#28385;&#36275;&#20869;&#23384;&#20998;&#37197;&#35201;&#27714;</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">__GFP_MOVABLE</span> <span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>__force <span style="color: #6434A3;">gfp_t</span><span style="color: #7388D6;">)</span><span style="color: #D0372D;">0x100000u</span><span style="color: #707183;">)</span>  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Page is movable</span><span style="color: #8D8D84;"> */</span>

<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">__GFP_BITS_SHIFT</span> <span style="color: #D0372D;">21</span> <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Room for 21 __GFP_FOO bits</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">__GFP_BITS_MASK</span> <span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>__force <span style="color: #6434A3;">gfp_t</span><span style="color: #7388D6;">)(</span><span style="color: #909183;">(</span><span style="color: #D0372D;">1</span> &lt;&lt; __GFP_BITS_SHIFT<span style="color: #909183;">)</span> - <span style="color: #D0372D;">1</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">This equals 0, but use constants in case they ever change</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">GFP_NOWAIT</span>  <span style="color: #707183;">(</span>GFP_ATOMIC &amp; ~__GFP_HIGH<span style="color: #707183;">)</span>
<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">GFP_ATOMIC means both !wait (__GFP_WAIT not set) and use emergency pool</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">GFP_ATOMIC</span>  <span style="color: #707183;">(</span>__GFP_HIGH<span style="color: #707183;">)</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">GFP_NOIO</span>  <span style="color: #707183;">(</span>__GFP_WAIT<span style="color: #707183;">)</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">GFP_NOFS</span>  <span style="color: #707183;">(</span>__GFP_WAIT | __GFP_IO<span style="color: #707183;">)</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">GFP_KERNEL</span>  <span style="color: #707183;">(</span>__GFP_WAIT | __GFP_IO | __GFP_FS<span style="color: #707183;">)</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">GFP_TEMPORARY</span> <span style="color: #707183;">(</span>__GFP_WAIT | __GFP_IO | __GFP_FS | \
       __GFP_RECLAIMABLE<span style="color: #707183;">)</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">GFP_USER</span>  <span style="color: #707183;">(</span>__GFP_WAIT | __GFP_IO | __GFP_FS | __GFP_HARDWALL<span style="color: #707183;">)</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">GFP_HIGHUSER</span>  <span style="color: #707183;">(</span>__GFP_WAIT | __GFP_IO | __GFP_FS | __GFP_HARDWALL | \
       __GFP_HIGHMEM<span style="color: #707183;">)</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">GFP_HIGHUSER_MOVABLE</span>  <span style="color: #707183;">(</span>__GFP_WAIT | __GFP_IO | __GFP_FS | \
         __GFP_HARDWALL | __GFP_HIGHMEM | \
         __GFP_MOVABLE<span style="color: #707183;">)</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">GFP_NOFS_PAGECACHE</span>  <span style="color: #707183;">(</span>__GFP_WAIT | __GFP_IO | __GFP_MOVABLE<span style="color: #707183;">)</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">GFP_USER_PAGECACHE</span>  <span style="color: #707183;">(</span>__GFP_WAIT | __GFP_IO | __GFP_FS | \
         __GFP_HARDWALL | __GFP_MOVABLE<span style="color: #707183;">)</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">GFP_HIGHUSER_PAGECACHE</span>  <span style="color: #707183;">(</span>__GFP_WAIT | __GFP_IO | __GFP_FS | \
         __GFP_HARDWALL | __GFP_HIGHMEM | \
         __GFP_MOVABLE<span style="color: #707183;">)</span>

<span style="color: #808080;">#ifdef</span> CONFIG_NUMA
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">GFP_THISNODE</span>  <span style="color: #707183;">(</span>__GFP_THISNODE | __GFP_NOWARN | __GFP_NORETRY<span style="color: #707183;">)</span>
<span style="color: #808080;">#else</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">GFP_THISNODE</span>  <span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>__force <span style="color: #6434A3;">gfp_t</span><span style="color: #7388D6;">)</span><span style="color: #D0372D;">0</span><span style="color: #707183;">)</span>
<span style="color: #808080;">#endif</span>

<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">This mask makes up all the page movable related flags</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">GFP_MOVABLE_MASK</span> <span style="color: #707183;">(</span>__GFP_RECLAIMABLE|__GFP_MOVABLE<span style="color: #707183;">)</span>

<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Control page allocator reclaim behavior</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">GFP_RECLAIM_MASK</span> <span style="color: #707183;">(</span>__GFP_WAIT|__GFP_HIGH|__GFP_IO|__GFP_FS|\
      __GFP_NOWARN|__GFP_REPEAT|__GFP_NOFAIL|\
      __GFP_NORETRY|__GFP_NOMEMALLOC<span style="color: #707183;">)</span>

<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Control allocation constraints</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">GFP_CONSTRAINT_MASK</span> <span style="color: #707183;">(</span>__GFP_HARDWALL|__GFP_THISNODE<span style="color: #707183;">)</span>

<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Do not use these with a slab allocator</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">GFP_SLAB_BUG_MASK</span> <span style="color: #707183;">(</span>__GFP_DMA32|__GFP_HIGHMEM|~__GFP_BITS_MASK<span style="color: #707183;">)</span>

<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Flag - indicates that the buffer will be suitable for DMA.  Ignored on some</span>
<span style="color: #8D8D84; font-style: italic;">   platforms, used as appropriate on others</span><span style="color: #8D8D84;"> */</span>

<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">GFP_DMA</span>   __GFP_DMA

<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">4GB DMA on some platforms</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">GFP_DMA32</span> __GFP_DMA32
</pre>
</div>
</div>
</li>
<li><a id="org8b0439b"></a>伙伴系统入口 alloc<sub>pages</sub><sub>node和</sub>_<sub>alloc</sub><sub>pages</sub><br />
<div class="outline-text-7" id="text-3-9-2-5-4-3">
<p>
所有的API函数都追溯到alloc<sub>pages</sub><sub>node</sub>，它相当于伙伴系统的总入口.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #0000FF;">static</span> <span style="color: #0000FF;">inline</span> <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">page</span> *<span style="color: #006699;">alloc_pages_node</span><span style="color: #707183;">(</span><span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">nid</span>, <span style="color: #6434A3;">gfp_t</span> <span style="color: #BA36A5;">gfp_mask</span>,
                                            <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">order</span><span style="color: #707183;">)</span>
<span style="color: #707183;">{</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#36991;&#20813;&#20998;&#37197;&#36807;&#22823;&#30340;&#20869;&#23384;&#22359;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>unlikely<span style="color: #909183;">(</span>order &gt;= MAX_ORDER<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
    <span style="color: #0000FF;">return</span> <span style="color: #D0372D;">NULL</span>;

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Unknown node is current node</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>nid &lt; <span style="color: #D0372D;">0</span><span style="color: #7388D6;">)</span>
    nid = numa_node_id<span style="color: #7388D6;">()</span>;

  <span style="color: #0000FF;">return</span> __alloc_pages<span style="color: #7388D6;">(</span>gfp_mask, order,
                       NODE_DATA<span style="color: #909183;">(</span>nid<span style="color: #909183;">)</span>-&gt;node_zonelists + gfp_zone<span style="color: #909183;">(</span>gfp_mask<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>;
<span style="color: #707183;">}</span>


<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#36873;&#25321;&#20869;&#23384;&#22495;</span><span style="color: #8D8D84;"> */</span>
<span style="color: #0000FF;">static</span> <span style="color: #0000FF;">inline</span> <span style="color: #0000FF;">enum</span> <span style="color: #6434A3;">zone_type</span> <span style="color: #006699;">gfp_zone</span><span style="color: #707183;">(</span><span style="color: #6434A3;">gfp_t</span> <span style="color: #BA36A5;">flags</span><span style="color: #707183;">)</span>
<span style="color: #707183;">{</span>
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">base</span> = <span style="color: #D0372D;">0</span>;

<span style="color: #808080;">#ifdef</span> CONFIG_NUMA
  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>flags &amp; __GFP_THISNODE<span style="color: #7388D6;">)</span>
    base = MAX_NR_ZONES;
<span style="color: #808080;">#endif</span>

<span style="color: #808080;">#ifdef</span> CONFIG_ZONE_DMA
  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>flags &amp; __GFP_DMA<span style="color: #7388D6;">)</span>
    <span style="color: #0000FF;">return</span> base + ZONE_DMA;
<span style="color: #808080;">#endif</span>
<span style="color: #808080;">#ifdef</span> CONFIG_ZONE_DMA32
  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>flags &amp; __GFP_DMA32<span style="color: #7388D6;">)</span>
    <span style="color: #0000FF;">return</span> base + ZONE_DMA32;
<span style="color: #808080;">#endif</span>
  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span><span style="color: #909183;">(</span>flags &amp; <span style="color: #709870;">(</span>__GFP_HIGHMEM | __GFP_MOVABLE<span style="color: #709870;">)</span><span style="color: #909183;">)</span> ==
      <span style="color: #909183;">(</span>__GFP_HIGHMEM | __GFP_MOVABLE<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
    <span style="color: #0000FF;">return</span> base + ZONE_MOVABLE;
<span style="color: #808080;">#ifdef</span> CONFIG_HIGHMEM
  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>flags &amp; __GFP_HIGHMEM<span style="color: #7388D6;">)</span>
    <span style="color: #0000FF;">return</span> base + ZONE_HIGHMEM;
<span style="color: #808080;">#endif</span>
  <span style="color: #0000FF;">return</span> base + ZONE_NORMAL;
<span style="color: #707183;">}</span>



</pre>
</div>
<p>
可以看到，该函数在执行避免分配分配过大内存块的检查后，马上把委托给_<sub>alloc</sub><sub>pages函数</sub>。
从它前面的两个 <b>__</b> 就不难猜到，这个函数才是完成整个分配任务最核心的后台函数：
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #808080;">#define</span> <span style="color: #BA36A5;">ALLOC_NO_WATERMARKS</span> <span style="color: #D0372D;">0x01</span> <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">don't check watermarks at all</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">ALLOC_WMARK_MIN</span>   <span style="color: #D0372D;">0x02</span> <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">use pages_min watermark</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">ALLOC_WMARK_LOW</span>   <span style="color: #D0372D;">0x04</span> <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">use pages_low watermark</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">ALLOC_WMARK_HIGH</span>  <span style="color: #D0372D;">0x08</span> <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">use pages_high watermark</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">ALLOC_HARDER</span>    <span style="color: #D0372D;">0x10</span> <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">try to alloc harder</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">ALLOC_HIGH</span>    <span style="color: #D0372D;">0x20</span> <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">__GFP_HIGH set</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">ALLOC_CPUSET</span>    <span style="color: #D0372D;">0x40</span> <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">check for correct cpuset</span><span style="color: #8D8D84;"> */</span>

<span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;"> * This is the 'heart' of the zoned buddy allocator.</span>
<span style="color: #8D8D84;"> */</span>
<span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">page</span> * <span style="color: #006699;">fastcall</span>
__alloc_pages<span style="color: #707183;">(</span><span style="color: #6434A3;">gfp_t</span> <span style="color: #BA36A5;">gfp_mask</span>, <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">order</span>,
    <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">zonelist</span> *<span style="color: #BA36A5;">zonelist</span><span style="color: #707183;">)</span>
<span style="color: #707183;">{</span>
  <span style="color: #0000FF;">const</span> <span style="color: #6434A3;">gfp_t</span> <span style="color: #BA36A5;">wait</span> = gfp_mask &amp; __GFP_WAIT;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">zone</span> **<span style="color: #BA36A5;">z</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">page</span> *<span style="color: #BA36A5;">page</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">reclaim_state</span> <span style="color: #BA36A5;">reclaim_state</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">task_struct</span> *<span style="color: #BA36A5;">p</span> = current;
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">do_retry</span>;
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">alloc_flags</span>;
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">did_some_progress</span>;

  might_sleep_if<span style="color: #7388D6;">(</span>wait<span style="color: #7388D6;">)</span>;

  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>should_fail_alloc_page<span style="color: #909183;">(</span>gfp_mask, order<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
    <span style="color: #0000FF;">return</span> <span style="color: #D0372D;">NULL</span>;

<span style="color: #D0372D;">restart</span>:
  z = zonelist-&gt;zones;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">the list of zones suitable for gfp_mask</span><span style="color: #8D8D84;"> */</span>

  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>unlikely<span style="color: #909183;">(</span>*z == <span style="color: #D0372D;">NULL</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">{</span>
    <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">     * Happens if we have an empty zonelist as a result of</span>
<span style="color: #8D8D84; font-style: italic;">     * GFP_THISNODE being used on a memoryless node</span>
<span style="color: #8D8D84;">     */</span>
    <span style="color: #0000FF;">return</span> <span style="color: #D0372D;">NULL</span>;
  <span style="color: #7388D6;">}</span>

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">1.&#26368;&#31616;&#21333;&#30340;&#24773;&#24418;&#65292;&#31354;&#38386;&#20869;&#23384;&#36275;&#22815;</span><span style="color: #8D8D84;"> */</span>
  page = get_page_from_freelist<span style="color: #7388D6;">(</span>gfp_mask|__GFP_HARDWALL, order,
        zonelist, ALLOC_WMARK_LOW|ALLOC_CPUSET<span style="color: #7388D6;">)</span>;
  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>page<span style="color: #7388D6;">)</span>
    <span style="color: #0000FF;">goto</span> <span style="color: #D0372D;">got_pg</span>;

  <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">   * GFP_THISNODE (meaning __GFP_THISNODE, __GFP_NORETRY and</span>
<span style="color: #8D8D84; font-style: italic;">   * __GFP_NOWARN set) should not cause reclaim since the subsystem</span>
<span style="color: #8D8D84; font-style: italic;">   * (f.e. slab) using GFP_THISNODE may choose to trigger reclaim</span>
<span style="color: #8D8D84; font-style: italic;">   * using a larger set of nodes after it has established that the</span>
<span style="color: #8D8D84; font-style: italic;">   * allowed per node queues are empty and that nodes are</span>
<span style="color: #8D8D84; font-style: italic;">   * over allocated.</span>
<span style="color: #8D8D84;">   */</span>
  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>NUMA_BUILD &amp;&amp; <span style="color: #909183;">(</span>gfp_mask &amp; GFP_THISNODE<span style="color: #909183;">)</span> == GFP_THISNODE<span style="color: #7388D6;">)</span>
    <span style="color: #0000FF;">goto</span> <span style="color: #D0372D;">nopage</span>;

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">2.&#31532;&#19968;&#27425;&#27809;&#26377;&#21462;&#24471;&#20869;&#23384;&#65292;&#35828;&#26126;&#20869;&#23384;&#19981;&#22826;&#22815;&#20102;&#65292;&#20869;&#26680;&#20877;&#27425;&#36941;&#21382;&#22791;&#29992;&#21015;&#34920;&#20013;&#30340;&#25152;&#26377;</span>
<span style="color: #8D8D84; font-style: italic;">  *    &#20869;&#23384;&#22495;&#65292;&#27599;&#27425;&#37117;&#35843;&#29992;wakeup_kswapd&#26469;&#21796;&#37266;&#25442;&#20986;&#39029;&#23432;&#25252;&#36827;&#31243;</span><span style="color: #8D8D84;">*/</span>
  <span style="color: #0000FF;">for</span> <span style="color: #7388D6;">(</span>z = zonelist-&gt;zones; *z; z++<span style="color: #7388D6;">)</span>
    wakeup_kswapd<span style="color: #7388D6;">(</span>*z, order<span style="color: #7388D6;">)</span>;

  <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">   * OK, we're below the kswapd watermark and have kicked background</span>
<span style="color: #8D8D84; font-style: italic;">   * reclaim. Now things get more complex, so set up alloc_flags according</span>
<span style="color: #8D8D84; font-style: italic;">   * to how we want to proceed.</span>
<span style="color: #8D8D84; font-style: italic;">   *</span>
<span style="color: #8D8D84; font-style: italic;">   * The caller may dip into page reserves a bit more if the caller</span>
<span style="color: #8D8D84; font-style: italic;">   * cannot run direct reclaim, or if the caller has realtime scheduling</span>
<span style="color: #8D8D84; font-style: italic;">   * policy or is asking for __GFP_HIGH memory.  GFP_ATOMIC requests will</span>
<span style="color: #8D8D84; font-style: italic;">   * set both ALLOC_HARDER (!wait) and ALLOC_HIGH (__GFP_HIGH).</span>
<span style="color: #8D8D84;">   */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#24182;&#19988;&#20250;&#35843;&#25972;&#20998;&#37197;&#26631;&#24535;&#65292;&#20351;&#30340;&#20998;&#37197;&#26356;&#23481;&#26131;&#25104;&#21151;&#65292;&#23558;&#27700;&#21360;&#38477;&#20302;&#21040;&#26368;&#23567;&#20540;</span><span style="color: #8D8D84;"> */</span>
  alloc_flags = ALLOC_WMARK_MIN;
  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span><span style="color: #909183;">(</span>unlikely<span style="color: #709870;">(</span>rt_task<span style="color: #907373;">(</span>p<span style="color: #907373;">)</span><span style="color: #709870;">)</span> &amp;&amp; !in_interrupt<span style="color: #709870;">()</span><span style="color: #909183;">)</span> || !wait<span style="color: #7388D6;">)</span>
    alloc_flags |= ALLOC_HARDER;
  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>gfp_mask &amp; __GFP_HIGH<span style="color: #7388D6;">)</span>
    alloc_flags |= ALLOC_HIGH;
  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>wait<span style="color: #7388D6;">)</span>
    alloc_flags |= ALLOC_CPUSET;

  <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">   * Go through the zonelist again. Let __GFP_HIGH and allocations</span>
<span style="color: #8D8D84; font-style: italic;">   * coming from realtime tasks go deeper into reserves.</span>
<span style="color: #8D8D84; font-style: italic;">   *</span>
<span style="color: #8D8D84; font-style: italic;">   * This is the last chance, in general, before the goto nopage.</span>
<span style="color: #8D8D84; font-style: italic;">   * Ignore cpuset if GFP_ATOMIC (!wait) rather than fail alloc.</span>
<span style="color: #8D8D84; font-style: italic;">   * See also cpuset_zone_allowed() comment in kernel/cpuset.c.</span>
<span style="color: #8D8D84;">   */</span>
  page = get_page_from_freelist<span style="color: #7388D6;">(</span>gfp_mask, order, zonelist, alloc_flags<span style="color: #7388D6;">)</span>;
  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>page<span style="color: #7388D6;">)</span>
    <span style="color: #0000FF;">goto</span> <span style="color: #D0372D;">got_pg</span>;

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">This allocation should allow future memory freeing.</span><span style="color: #8D8D84;"> */</span>

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">3.&#22914;&#26524;&#20877;&#27425;&#22833;&#36133;&#65292;&#20869;&#26680;&#20250;&#37319;&#21462;&#26356;&#24378;&#26377;&#21147;&#30340;&#25514;&#26045;,&#36825;&#27425;&#23436;&#20840;&#24573;&#30053;&#27700;&#21360;</span><span style="color: #8D8D84;"> */</span>
<span style="color: #D0372D;">rebalance</span>:
  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span><span style="color: #909183;">(</span><span style="color: #709870;">(</span>p-&gt;flags &amp; PF_MEMALLOC<span style="color: #709870;">)</span> || unlikely<span style="color: #709870;">(</span>test_thread_flag<span style="color: #907373;">(</span>TIF_MEMDIE<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
      &amp;&amp; !in_interrupt<span style="color: #909183;">()</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">{</span>
    <span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span>!<span style="color: #709870;">(</span>gfp_mask &amp; __GFP_NOMEMALLOC<span style="color: #709870;">)</span><span style="color: #909183;">)</span> <span style="color: #909183;">{</span>
<span style="color: #D0372D;">nofail_alloc</span>:
      <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">go through the zonelist yet again, ignoring mins</span><span style="color: #8D8D84;"> */</span>
      page = get_page_from_freelist<span style="color: #709870;">(</span>gfp_mask, order,
        zonelist, ALLOC_NO_WATERMARKS<span style="color: #709870;">)</span>;
      <span style="color: #0000FF;">if</span> <span style="color: #709870;">(</span>page<span style="color: #709870;">)</span>
        <span style="color: #0000FF;">goto</span> <span style="color: #D0372D;">got_pg</span>;
      <span style="color: #0000FF;">if</span> <span style="color: #709870;">(</span>gfp_mask &amp; __GFP_NOFAIL<span style="color: #709870;">)</span> <span style="color: #709870;">{</span>
        congestion_wait<span style="color: #907373;">(</span>WRITE, HZ/<span style="color: #D0372D;">50</span><span style="color: #907373;">)</span>;
        <span style="color: #0000FF;">goto</span> <span style="color: #D0372D;">nofail_alloc</span>;
      <span style="color: #709870;">}</span>
    <span style="color: #909183;">}</span>
    <span style="color: #0000FF;">goto</span> <span style="color: #D0372D;">nopage</span>;
  <span style="color: #7388D6;">}</span>

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Atomic allocations - we can't balance anything</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>!wait<span style="color: #7388D6;">)</span>
    <span style="color: #0000FF;">goto</span> <span style="color: #D0372D;">nopage</span>;

  cond_resched<span style="color: #7388D6;">()</span>;

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">We now go into synchronous reclaim</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">4.&#21516;&#27493;&#22238;&#25910;&#29366;&#24577;,&#21644;&#25442;&#20986;&#23432;&#25252;&#36827;&#31243;&#30340;&#21306;&#21035;&#65311;</span><span style="color: #8D8D84;"> */</span>
  cpuset_memory_pressure_bump<span style="color: #7388D6;">()</span>;
  p-&gt;flags |= PF_MEMALLOC;
  reclaim_state.reclaimed_slab = <span style="color: #D0372D;">0</span>;
  p-&gt;reclaim_state = &amp;reclaim_state;

  did_some_progress = try_to_free_pages<span style="color: #7388D6;">(</span>zonelist-&gt;zones, order, gfp_mask<span style="color: #7388D6;">)</span>;

  p-&gt;reclaim_state = <span style="color: #D0372D;">NULL</span>;
  p-&gt;flags &amp;= ~PF_MEMALLOC;

  cond_resched<span style="color: #7388D6;">()</span>;

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#22914;&#26524;&#20998;&#37197;&#22810;&#39029;&#65292;&#32531;&#23384;&#20013;&#30340;&#39029;&#20063;&#20250;&#34987;&#25343;&#22238;&#20249;&#20276;&#31995;&#32479;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>order != <span style="color: #D0372D;">0</span><span style="color: #7388D6;">)</span>
    drain_all_local_pages<span style="color: #7388D6;">()</span>;

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#22914;&#26524;try_to_free_pages&#37322;&#25918;&#20102;&#19968;&#20123;&#39029;&#65292;&#20877;&#27425;&#23581;&#35797;&#33719;&#21462;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>likely<span style="color: #909183;">(</span>did_some_progress<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">{</span>
    page = get_page_from_freelist<span style="color: #909183;">(</span>gfp_mask, order,
            zonelist, alloc_flags<span style="color: #909183;">)</span>;
    <span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span>page<span style="color: #909183;">)</span>
      <span style="color: #0000FF;">goto</span> <span style="color: #D0372D;">got_pg</span>;
  <span style="color: #7388D6;">}</span> <span style="color: #0000FF;">else</span> <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span><span style="color: #909183;">(</span>gfp_mask &amp; __GFP_FS<span style="color: #909183;">)</span> &amp;&amp; !<span style="color: #909183;">(</span>gfp_mask &amp; __GFP_NORETRY<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">{</span>
    <span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span>!try_set_zone_oom<span style="color: #709870;">(</span>zonelist<span style="color: #709870;">)</span><span style="color: #909183;">)</span> <span style="color: #909183;">{</span>
      schedule_timeout_uninterruptible<span style="color: #709870;">(</span><span style="color: #D0372D;">1</span><span style="color: #709870;">)</span>;
      <span style="color: #0000FF;">goto</span> <span style="color: #D0372D;">restart</span>;
    <span style="color: #909183;">}</span>

    <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">     * Go through the zonelist yet one more time, keep</span>
<span style="color: #8D8D84; font-style: italic;">     * very high watermark here, this is only to catch</span>
<span style="color: #8D8D84; font-style: italic;">     * a parallel oom killing, we must fail if we're still</span>
<span style="color: #8D8D84; font-style: italic;">     * under heavy pressure.</span>
<span style="color: #8D8D84;">     */</span>
    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">5.out_of_memory&#65292;&#36873;&#25321;&#19968;&#20010;&#20869;&#26680;&#35748;&#20026;&#29359;&#26377;&#20998;&#37197;&#36807;&#22810;&#20869;&#23384;&#8220;&#32618;&#34892;&#8221;&#30340;&#36827;&#31243;&#65292;&#24182;&#26432;&#25481;&#35813;&#36827;&#31243;</span><span style="color: #8D8D84;"> */</span>
    page = get_page_from_freelist<span style="color: #909183;">(</span>gfp_mask|__GFP_HARDWALL, order,
        zonelist, ALLOC_WMARK_HIGH|ALLOC_CPUSET<span style="color: #909183;">)</span>;
    <span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span>page<span style="color: #909183;">)</span> <span style="color: #909183;">{</span>
      clear_zonelist_oom<span style="color: #709870;">(</span>zonelist<span style="color: #709870;">)</span>;
      <span style="color: #0000FF;">goto</span> <span style="color: #D0372D;">got_pg</span>;
    <span style="color: #909183;">}</span>

    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">The OOM killer will not help higher order allocs so fail</span><span style="color: #8D8D84;"> */</span>
    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#22914;&#26524;&#35201;&#20998;&#37197;&#22823;&#39029;&#65292;&#37027;&#20040;&#20869;&#26680;&#20250;&#36873;&#25321;&#25918;&#36807;&#36873;&#25321;&#30340;&#8220;&#32618;&#34892;&#8221;&#36827;&#31243;</span><span style="color: #8D8D84;"> */</span>
    <span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span>order &gt; PAGE_ALLOC_COSTLY_ORDER<span style="color: #909183;">)</span> <span style="color: #909183;">{</span>
      clear_zonelist_oom<span style="color: #709870;">(</span>zonelist<span style="color: #709870;">)</span>;
      <span style="color: #0000FF;">goto</span> <span style="color: #D0372D;">nopage</span>;
    <span style="color: #909183;">}</span>

    out_of_memory<span style="color: #909183;">(</span>zonelist, gfp_mask, order<span style="color: #909183;">)</span>;
    clear_zonelist_oom<span style="color: #909183;">(</span>zonelist<span style="color: #909183;">)</span>;
    <span style="color: #0000FF;">goto</span> <span style="color: #D0372D;">restart</span>;
  <span style="color: #7388D6;">}</span>

  <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">   * Don't let big-order allocations loop unless the caller explicitly</span>
<span style="color: #8D8D84; font-style: italic;">   * requests that.  Wait for some write requests to complete then retry.</span>
<span style="color: #8D8D84; font-style: italic;">   *</span>
<span style="color: #8D8D84; font-style: italic;">   * In this implementation, __GFP_REPEAT means __GFP_NOFAIL for order</span>
<span style="color: #8D8D84; font-style: italic;">   * &lt;= 3, but that may not be true in other implementations.</span>
<span style="color: #8D8D84;">   */</span>
  do_retry = <span style="color: #D0372D;">0</span>;
  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>!<span style="color: #909183;">(</span>gfp_mask &amp; __GFP_NORETRY<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">{</span>
    <span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span>order &lt;= PAGE_ALLOC_COSTLY_ORDER<span style="color: #709870;">)</span> ||
            <span style="color: #709870;">(</span>gfp_mask &amp; __GFP_REPEAT<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
      do_retry = <span style="color: #D0372D;">1</span>;
    <span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span>gfp_mask &amp; __GFP_NOFAIL<span style="color: #909183;">)</span>
      do_retry = <span style="color: #D0372D;">1</span>;
  <span style="color: #7388D6;">}</span>
  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>do_retry<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">{</span>
    congestion_wait<span style="color: #909183;">(</span>WRITE, HZ/<span style="color: #D0372D;">50</span><span style="color: #909183;">)</span>;
    <span style="color: #0000FF;">goto</span> <span style="color: #D0372D;">rebalance</span>;
  <span style="color: #7388D6;">}</span>

<span style="color: #D0372D;">nopage</span>:
  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>!<span style="color: #909183;">(</span>gfp_mask &amp; __GFP_NOWARN<span style="color: #909183;">)</span> &amp;&amp; printk_ratelimit<span style="color: #909183;">()</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">{</span>
    printk<span style="color: #909183;">(</span>KERN_WARNING <span style="color: #008000;">"%s: page allocation failure."</span>
      <span style="color: #008000;">" order:%d, mode:0x%x\n"</span>,
      p-&gt;comm, order, gfp_mask<span style="color: #909183;">)</span>;
    dump_stack<span style="color: #909183;">()</span>;
    show_mem<span style="color: #909183;">()</span>;
  <span style="color: #7388D6;">}</span>
<span style="color: #D0372D;">got_pg</span>:
  <span style="color: #0000FF;">return</span> page;
<span style="color: #707183;">}</span>






<span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;"> * get_page_from_freelist goes through the zonelist trying to allocate</span>
<span style="color: #8D8D84; font-style: italic;"> * a page.</span>
<span style="color: #8D8D84;"> */</span>
<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#37325;&#35201;&#30340;&#36741;&#21161;&#20989;&#25968;&#65292;&#36890;&#36807;&#26631;&#24535;&#38598;&#21644;&#20998;&#37197;&#38454;&#26469;&#21028;&#26029;&#26159;&#21542;&#33021;&#36827;&#34892;&#20998;&#37197;</span><span style="color: #8D8D84;"> */</span>
<span style="color: #0000FF;">static</span> <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">page</span> *
<span style="color: #006699;">get_page_from_freelist</span><span style="color: #707183;">(</span><span style="color: #6434A3;">gfp_t</span> <span style="color: #BA36A5;">gfp_mask</span>, <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">order</span>,
    <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">zonelist</span> *<span style="color: #BA36A5;">zonelist</span>, <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">alloc_flags</span><span style="color: #707183;">)</span>
<span style="color: #707183;">{</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">zone</span> **<span style="color: #BA36A5;">z</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">page</span> *<span style="color: #BA36A5;">page</span> = <span style="color: #D0372D;">NULL</span>;
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">classzone_idx</span> = zone_idx<span style="color: #7388D6;">(</span>zonelist-&gt;zones<span style="color: #909183;">[</span><span style="color: #D0372D;">0</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">zone</span> *<span style="color: #BA36A5;">zone</span>;
  <span style="color: #6434A3;">nodemask_t</span> *<span style="color: #BA36A5;">allowednodes</span> = <span style="color: #D0372D;">NULL</span>;<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">zonelist_cache approximation</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">zlc_active</span> = <span style="color: #D0372D;">0</span>;   <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">set if using zonelist_cache</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">did_zlc_setup</span> = <span style="color: #D0372D;">0</span>;    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">just call zlc_setup() one time</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">enum</span> <span style="color: #6434A3;">zone_type</span> <span style="color: #BA36A5;">highest_zoneidx</span> = -<span style="color: #D0372D;">1</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Gets set for policy zonelists</span><span style="color: #8D8D84;"> */</span>

<span style="color: #D0372D;">zonelist_scan</span>:
  <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">   * Scan zonelist, looking for a zone with enough free.</span>
<span style="color: #8D8D84; font-style: italic;">   * See also cpuset_zone_allowed() comment in kernel/cpuset.c.</span>
<span style="color: #8D8D84;">   */</span>
  z = zonelist-&gt;zones;

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#36941;&#21382;&#22791;&#29992;&#21015;&#34920;&#30340;&#25152;&#26377;&#20869;&#23384;&#22495;&#65292;&#29992;&#26368;&#31616;&#21333;&#30340;&#26041;&#24335;&#26597;&#25214;&#19968;&#20010;&#36866;&#24403;&#30340;&#31354;&#38386;&#20869;&#23384;&#22359;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">do</span> <span style="color: #7388D6;">{</span>
    <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">     * In NUMA, this could be a policy zonelist which contains</span>
<span style="color: #8D8D84; font-style: italic;">     * zones that may not be allowed by the current gfp_mask.</span>
<span style="color: #8D8D84; font-style: italic;">     * Check the zone is allowed by the current flags</span>
<span style="color: #8D8D84;">     */</span>
    <span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span>unlikely<span style="color: #709870;">(</span>alloc_should_filter_zonelist<span style="color: #907373;">(</span>zonelist<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span> <span style="color: #909183;">{</span>
      <span style="color: #0000FF;">if</span> <span style="color: #709870;">(</span>highest_zoneidx == -<span style="color: #D0372D;">1</span><span style="color: #709870;">)</span>
        highest_zoneidx = gfp_zone<span style="color: #709870;">(</span>gfp_mask<span style="color: #709870;">)</span>;
      <span style="color: #0000FF;">if</span> <span style="color: #709870;">(</span>zone_idx<span style="color: #907373;">(</span>*z<span style="color: #907373;">)</span> &gt; highest_zoneidx<span style="color: #709870;">)</span>
        <span style="color: #0000FF;">continue</span>;
    <span style="color: #909183;">}</span>

    <span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span>NUMA_BUILD &amp;&amp; zlc_active &amp;&amp;
      !zlc_zone_worth_trying<span style="color: #709870;">(</span>zonelist, z, allowednodes<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
        <span style="color: #0000FF;">continue</span>;
    zone = *z;
    <span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span><span style="color: #709870;">(</span>alloc_flags &amp; ALLOC_CPUSET<span style="color: #709870;">)</span> &amp;&amp;
        <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#36741;&#21161;&#20989;&#25968;&#65292;&#29992;&#20110;&#26816;&#26597;&#32473;&#23450;&#20869;&#23384;&#22495;&#26159;&#21542;&#23646;&#20110;&#35813;&#36827;&#31243;&#20801;&#35768;&#20801;&#35768;&#30340;cpu</span><span style="color: #8D8D84;"> */</span>
      !cpuset_zone_allowed_softwall<span style="color: #709870;">(</span>zone, gfp_mask<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
        <span style="color: #0000FF;">goto</span> <span style="color: #D0372D;">try_next_zone</span>;

    <span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span>!<span style="color: #709870;">(</span>alloc_flags &amp; ALLOC_NO_WATERMARKS<span style="color: #709870;">)</span><span style="color: #909183;">)</span> <span style="color: #909183;">{</span>
      <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">mark</span>;
      <span style="color: #0000FF;">if</span> <span style="color: #709870;">(</span>alloc_flags &amp; ALLOC_WMARK_MIN<span style="color: #709870;">)</span>
        mark = zone-&gt;pages_min;
      <span style="color: #0000FF;">else</span> <span style="color: #0000FF;">if</span> <span style="color: #709870;">(</span>alloc_flags &amp; ALLOC_WMARK_LOW<span style="color: #709870;">)</span>
        mark = zone-&gt;pages_low;
      <span style="color: #0000FF;">else</span>
        mark = zone-&gt;pages_high;
      <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#37325;&#35201;&#30340;&#36741;&#21161;&#20989;&#25968;&#65292;&#26816;&#26597;&#25152;&#36941;&#21382;&#21040;&#30340;&#20869;&#23384;&#22495;&#26159;&#21542;&#26377;&#36275;&#22815;&#30340;&#31354;&#38386;&#39029;&#65292;&#24182;&#35797;&#22270;</span>
<span style="color: #8D8D84; font-style: italic;">      *  &#20998;&#37197;&#19968;&#20010;&#36830;&#32493;&#30340;&#20869;&#23384;&#22359;</span><span style="color: #8D8D84;">*/</span>
      <span style="color: #0000FF;">if</span> <span style="color: #709870;">(</span>!zone_watermark_ok<span style="color: #907373;">(</span>zone, order, mark,
            classzone_idx, alloc_flags<span style="color: #907373;">)</span><span style="color: #709870;">)</span> <span style="color: #709870;">{</span>
        <span style="color: #0000FF;">if</span> <span style="color: #907373;">(</span>!zone_reclaim_mode ||
            !zone_reclaim<span style="color: #6276BA;">(</span>zone, gfp_mask, order<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
          <span style="color: #0000FF;">goto</span> <span style="color: #D0372D;">this_zone_full</span>;
      <span style="color: #709870;">}</span>
    <span style="color: #909183;">}</span>

    <span style="color: #8D8D84;">/**** </span><span style="color: #8D8D84; font-style: italic;">&#37325;&#35201;&#30340;&#26680;&#24515;&#20989;&#25968;&#65292;&#20249;&#20276;&#31995;&#32479;&#30340;&#26680;&#24515;</span><span style="color: #8D8D84;"> */</span>
    page = buffered_rmqueue<span style="color: #909183;">(</span>zonelist, zone, order, gfp_mask<span style="color: #909183;">)</span>;
    <span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span>page<span style="color: #909183;">)</span>
      <span style="color: #0000FF;">break</span>;
<span style="color: #D0372D;">this_zone_full</span>:
    <span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span>NUMA_BUILD<span style="color: #909183;">)</span>
      zlc_mark_zone_full<span style="color: #909183;">(</span>zonelist, z<span style="color: #909183;">)</span>;
<span style="color: #D0372D;">try_next_zone</span>:
    <span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span>NUMA_BUILD &amp;&amp; !did_zlc_setup<span style="color: #909183;">)</span> <span style="color: #909183;">{</span>
      <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">we do zlc_setup after the first zone is tried</span><span style="color: #8D8D84;"> */</span>
      allowednodes = zlc_setup<span style="color: #709870;">(</span>zonelist, alloc_flags<span style="color: #709870;">)</span>;
      zlc_active = <span style="color: #D0372D;">1</span>;
      did_zlc_setup = <span style="color: #D0372D;">1</span>;
    <span style="color: #909183;">}</span>
  <span style="color: #7388D6;">}</span> <span style="color: #0000FF;">while</span> <span style="color: #7388D6;">(</span>*<span style="color: #909183;">(</span>++z<span style="color: #909183;">)</span> != <span style="color: #D0372D;">NULL</span><span style="color: #7388D6;">)</span>;

  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>unlikely<span style="color: #909183;">(</span>NUMA_BUILD &amp;&amp; page == <span style="color: #D0372D;">NULL</span> &amp;&amp; zlc_active<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">{</span>
    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Disable zlc cache for second zonelist scan</span><span style="color: #8D8D84;"> */</span>
    zlc_active = <span style="color: #D0372D;">0</span>;
    <span style="color: #0000FF;">goto</span> <span style="color: #D0372D;">zonelist_scan</span>;
  <span style="color: #7388D6;">}</span>
  <span style="color: #0000FF;">return</span> page;
<span style="color: #707183;">}</span>
</pre>
</div>
</div>
</li>
<li><a id="org9a10bff"></a>伙伴系统核心 buffered<sub>rmqueue</sub><br />
<div class="outline-text-7" id="text-3-9-2-5-4-4">
<p>
到目前为止，我们只知道，如果判断出内存域中有足够的空闲页就会委托给buffered<sub>rmqueue</sub>，但是
足够的空闲页是包括所有的阶的总量，所以不一定能保证分配成功。
</p>

<p>
buffered<sub>rmqueue的任务主要有两个</sub>：
</p>
<ol class="org-ol">
<li>检查这些页是否是连续的</li>
<li>从free<sub>lists移除这些页</sub>，这可能需要分解并重排内存区</li>
</ol>

<p>
其主要流程图为：
</p>

<div id="orgb26d2e5" class="figure">
<p><img src="reading/2020-11-15_17-02-34_screenshot.png" alt="2020-11-15_17-02-34_screenshot.png" />
</p>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;"> * Really, prep_compound_page() should be called from __rmqueue_bulk().  But</span>
<span style="color: #8D8D84; font-style: italic;"> * we cheat by calling it from here, in the order &gt; 0 path.  Saves a branch</span>
<span style="color: #8D8D84; font-style: italic;"> * or two.</span>
<span style="color: #8D8D84;"> */</span>
<span style="color: #0000FF;">static</span> <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">page</span> *<span style="color: #006699;">buffered_rmqueue</span><span style="color: #707183;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">zonelist</span> *<span style="color: #BA36A5;">zonelist</span>,
      <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">zone</span> *<span style="color: #BA36A5;">zone</span>, <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">order</span>, <span style="color: #6434A3;">gfp_t</span> <span style="color: #BA36A5;">gfp_flags</span><span style="color: #707183;">)</span>
<span style="color: #707183;">{</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">flags</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">page</span> *<span style="color: #BA36A5;">page</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#35774;&#32622;&#20102;COLD&#26631;&#24535;&#65292;&#37027;&#20040;&#24517;&#39035;&#20174;per-CPU&#32531;&#23384;&#20013;&#21462;&#24471;&#20919;&#39029;,</span>
<span style="color: #8D8D84; font-style: italic;">  *  &#19987;&#38376;&#35774;&#32622;&#20919;&#39029;&#30340;&#30446;&#30340;&#26159;&#65306;&#26377;&#20123;&#39029;&#34987;&#35775;&#38382;&#30340;&#27425;&#25968;&#24456;&#23569;&#65292;&#25152;&#20197;&#25226;&#20182;</span>
<span style="color: #8D8D84; font-style: italic;">  *  &#25918;&#21040;catch&#20013;&#22826;&#28010;&#36153;&#20102;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#20004;&#27425;&#21462;&#21453;&#30830;&#20445;cold&#20026;0&#25110;1</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">cold</span> = !!<span style="color: #7388D6;">(</span>gfp_flags &amp; __GFP_COLD<span style="color: #7388D6;">)</span>;
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">cpu</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#26681;&#25454;&#26631;&#24535;&#30830;&#23450;&#36801;&#31227;&#21015;&#34920;, (&#37325;&#35201;)&#39029;&#30340;&#36801;&#31227;&#31867;&#22411;&#23384;&#20648;&#22312;struct page&#30340;private&#25104;&#21592;&#20013;</span><span style="color: #8D8D84;">*/</span>
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">migratetype</span> = allocflags_to_migratetype<span style="color: #7388D6;">(</span>gfp_flags<span style="color: #7388D6;">)</span>;

<span style="color: #D0372D;">again</span>:
  cpu  = get_cpu<span style="color: #7388D6;">()</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#22914;&#26524;&#21482;&#35831;&#27714;&#19968;&#39029;&#65292;&#20869;&#26680;&#20250;&#20511;&#21161;per-CPU&#32531;&#23384;&#21152;&#36895;&#35831;&#27714;&#30340;&#22788;&#29702;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>likely<span style="color: #909183;">(</span>order == <span style="color: #D0372D;">0</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">{</span>
    <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">per_cpu_pages</span> *<span style="color: #BA36A5;">pcp</span>;

    pcp = &amp;zone_pcp<span style="color: #909183;">(</span>zone, cpu<span style="color: #909183;">)</span>-&gt;pcp<span style="color: #909183;">[</span>cold<span style="color: #909183;">]</span>;
    local_irq_save<span style="color: #909183;">(</span>flags<span style="color: #909183;">)</span>;
    <span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span>!pcp-&gt;count<span style="color: #909183;">)</span> <span style="color: #909183;">{</span>
      <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#37325;&#26032;&#29992;&#20249;&#20276;&#31995;&#32479;&#20013;&#30340;&#39029;&#22635;&#20805;&#32531;&#23384;</span><span style="color: #8D8D84;"> */</span>
      pcp-&gt;count = rmqueue_bulk<span style="color: #709870;">(</span>zone, <span style="color: #D0372D;">0</span>,
          pcp-&gt;batch, &amp;pcp-&gt;list, migratetype<span style="color: #709870;">)</span>;
      <span style="color: #0000FF;">if</span> <span style="color: #709870;">(</span>unlikely<span style="color: #907373;">(</span>!pcp-&gt;count<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
        <span style="color: #0000FF;">goto</span> <span style="color: #D0372D;">failed</span>;
    <span style="color: #909183;">}</span>

    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Find a page of the appropriate migrate type</span><span style="color: #8D8D84;"> */</span>
    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#26816;&#26597;&#26159;&#21542;&#26377;&#25351;&#23450;&#36801;&#31227;&#31867;&#22411;&#30340;&#39029;&#21487;&#29992;&#65292;&#22914;&#26524;&#21069;&#19968;&#27425;&#29992;&#20854;&#20182;&#36801;&#31227;&#31867;&#22411;&#30340;&#39029;&#22635;&#20805;&#20102;&#32531;&#23384;&#65292;</span>
<span style="color: #8D8D84; font-style: italic;">    *  &#21487;&#33021;&#25214;&#19981;&#21040;&#65292;</span><span style="color: #8D8D84;">*/</span>
    list_for_each_entry<span style="color: #909183;">(</span>page, &amp;pcp-&gt;list, lru<span style="color: #909183;">)</span>
      <span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span>page_private<span style="color: #709870;">(</span>page<span style="color: #709870;">)</span> == migratetype<span style="color: #909183;">)</span>
        <span style="color: #0000FF;">break</span>;

    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Allocate more to the pcp list if necessary</span><span style="color: #8D8D84;"> */</span>
    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#25214;&#19981;&#21040;&#30340;&#35805;&#23601;&#35201;&#21521;&#32531;&#23384;&#20013;&#28155;&#21152;&#19968;&#20123;&#31526;&#21512;&#24403;&#21069;&#36801;&#31227;&#31867;&#22411;&#35201;&#27714;&#30340;&#39029;</span><span style="color: #8D8D84;"> */</span>
    <span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span>unlikely<span style="color: #709870;">(</span>&amp;page-&gt;lru == &amp;pcp-&gt;list<span style="color: #709870;">)</span><span style="color: #909183;">)</span> <span style="color: #909183;">{</span>
      pcp-&gt;count += rmqueue_bulk<span style="color: #709870;">(</span>zone, <span style="color: #D0372D;">0</span>,
          pcp-&gt;batch, &amp;pcp-&gt;list, migratetype<span style="color: #709870;">)</span>;
      page = list_entry<span style="color: #709870;">(</span>pcp-&gt;list.next, <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">page</span>, lru<span style="color: #709870;">)</span>;
    <span style="color: #909183;">}</span>

    list_del<span style="color: #909183;">(</span>&amp;page-&gt;lru<span style="color: #909183;">)</span>;
    pcp-&gt;count--;

    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#38656;&#35201;&#20998;&#37197;&#22810;&#39029;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #7388D6;">}</span> <span style="color: #0000FF;">else</span> <span style="color: #7388D6;">{</span>
    spin_lock_irqsave<span style="color: #909183;">(</span>&amp;zone-&gt;lock, flags<span style="color: #909183;">)</span>;
    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">(&#20249;&#20276;&#31995;&#32479;&#26680;&#24515;&#20989;&#25968;)&#20174;&#20249;&#20276;&#31995;&#32479;&#33719;&#24471;&#20869;&#23384;&#22359;&#65292;&#22914;&#26377;&#24517;&#35201;&#20250;&#33258;&#21160;&#20998;&#35299;&#22823;&#22359;&#20869;&#23384;</span><span style="color: #8D8D84;"> */</span>
    page = __rmqueue<span style="color: #909183;">(</span>zone, order, migratetype<span style="color: #909183;">)</span>;
    spin_unlock<span style="color: #909183;">(</span>&amp;zone-&gt;lock<span style="color: #909183;">)</span>;
    <span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span>!page<span style="color: #909183;">)</span>
      <span style="color: #0000FF;">goto</span> <span style="color: #D0372D;">failed</span>;
  <span style="color: #7388D6;">}</span>

  __count_zone_vm_events<span style="color: #7388D6;">(</span>PGALLOC, zone, <span style="color: #D0372D;">1</span> &lt;&lt; order<span style="color: #7388D6;">)</span>;
  zone_statistics<span style="color: #7388D6;">(</span>zonelist, zone<span style="color: #7388D6;">)</span>;
  local_irq_restore<span style="color: #7388D6;">(</span>flags<span style="color: #7388D6;">)</span>;
  put_cpu<span style="color: #7388D6;">()</span>;

  VM_BUG_ON<span style="color: #7388D6;">(</span>bad_range<span style="color: #909183;">(</span>zone, page<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#23545;&#39029;&#36827;&#34892;&#24517;&#35201;&#30340;&#26816;&#26597;&#65292;&#24182;&#23558;&#31532;&#19968;&#39029;&#30340;&#24341;&#29992;&#35745;&#25968;&#32622;&#20026;&#21021;&#22987;&#20540;1</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>prep_new_page<span style="color: #909183;">(</span>page, order, gfp_flags<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
    <span style="color: #0000FF;">goto</span> <span style="color: #D0372D;">again</span>;
  <span style="color: #0000FF;">return</span> page;

<span style="color: #D0372D;">failed</span>:
  local_irq_restore<span style="color: #7388D6;">(</span>flags<span style="color: #7388D6;">)</span>;
  put_cpu<span style="color: #7388D6;">()</span>;
  <span style="color: #0000FF;">return</span> <span style="color: #D0372D;">NULL</span>;
<span style="color: #707183;">}</span>

<span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;"> * Do the hard work of removing an element from the buddy allocator.</span>
<span style="color: #8D8D84; font-style: italic;"> * Call me with the zone-&gt;lock already held.</span>
<span style="color: #8D8D84;"> */</span>
<span style="color: #0000FF;">static</span> <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">page</span> *<span style="color: #006699;">__rmqueue</span><span style="color: #707183;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">zone</span> *<span style="color: #BA36A5;">zone</span>, <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">order</span>,
                              <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">migratetype</span><span style="color: #707183;">)</span>
<span style="color: #707183;">{</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">page</span> *<span style="color: #BA36A5;">page</span>;

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#26681;&#25454;&#20256;&#36882;&#36827;&#26469;&#30340;&#20998;&#37197;&#38454;&#65292;&#29992;&#20110;&#33719;&#21462;&#39029;&#30340;&#20869;&#23384;&#22495;&#65292;&#36801;&#31227;&#31867;&#22411;&#65292;</span>
<span style="color: #8D8D84; font-style: italic;">   &#25195;&#25551;&#39029;&#30340;&#21015;&#34920;&#65292;&#30693;&#36947;&#25214;&#21040;&#36866;&#24403;&#30340;&#36830;&#32493;&#20869;&#23384;&#22359;</span><span style="color: #8D8D84;">*/</span>
  page = __rmqueue_smallest<span style="color: #7388D6;">(</span>zone, order, migratetype<span style="color: #7388D6;">)</span>;

  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>unlikely<span style="color: #909183;">(</span>!page<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#22914;&#26524;&#25351;&#23450;&#30340;&#36801;&#31227;&#21015;&#34920;&#19981;&#33021;&#28385;&#36275;&#20998;&#37197;&#35831;&#27714;&#65292;&#21017;&#35843;&#29992;__rmqueue_fallback&#23581;&#35797;</span>
<span style="color: #8D8D84; font-style: italic;">    *  &#20854;&#20182;&#36801;&#31227;&#21015;&#34920;&#65292;&#20316;&#20026;&#24212;&#24613;&#25514;&#26045;</span><span style="color: #8D8D84;">*/</span>
    page = __rmqueue_fallback<span style="color: #7388D6;">(</span>zone, order, migratetype<span style="color: #7388D6;">)</span>;

  <span style="color: #0000FF;">return</span> page;
<span style="color: #707183;">}</span>

<span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;"> * Go through the free lists for the given migratetype and remove</span>
<span style="color: #8D8D84; font-style: italic;"> * the smallest available page from the freelists</span>
<span style="color: #8D8D84;"> */</span>
<span style="color: #0000FF;">static</span> <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">page</span> *<span style="color: #006699;">__rmqueue_smallest</span><span style="color: #707183;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">zone</span> *<span style="color: #BA36A5;">zone</span>, <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">order</span>,
                                       <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">migratetype</span><span style="color: #707183;">)</span>
<span style="color: #707183;">{</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">current_order</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">free_area</span> * <span style="color: #BA36A5;">area</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">page</span> *<span style="color: #BA36A5;">page</span>;

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Find a page of the appropriate size in the preferred list</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#36941;&#21382;&#27599;&#20010;&#22823;&#20110;&#31561;&#20110;&#24403;&#21069;&#20998;&#37197;&#38454;&#30340;&#27491;&#30830;&#36801;&#31227;&#21015;&#34920;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">for</span> <span style="color: #7388D6;">(</span>current_order = order; current_order &lt; MAX_ORDER; ++current_order<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">{</span>
    area = &amp;<span style="color: #909183;">(</span>zone-&gt;free_area<span style="color: #709870;">[</span>current_order<span style="color: #709870;">]</span><span style="color: #909183;">)</span>;
    <span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span>list_empty<span style="color: #709870;">(</span>&amp;area-&gt;free_list<span style="color: #907373;">[</span>migratetype<span style="color: #907373;">]</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
      <span style="color: #0000FF;">continue</span>;

    page = list_entry<span style="color: #909183;">(</span>area-&gt;free_list<span style="color: #709870;">[</span>migratetype<span style="color: #709870;">]</span>.next,
                      <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">page</span>, lru<span style="color: #909183;">)</span>;
    list_del<span style="color: #909183;">(</span>&amp;page-&gt;lru<span style="color: #909183;">)</span>;
    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#20174;&#39029;&#20013;&#21024;&#38500;PG_buddy&#26631;&#24535;&#20301;,&#24182;&#23558;struct page&#30340;private&#25104;&#21592;&#35774;&#32622;&#20026;0(&#23384;&#30340;&#19981;&#26159;&#36801;&#31227;&#31867;&#22411;&#21527;?)</span><span style="color: #8D8D84;"> */</span>
    rmv_page_order<span style="color: #909183;">(</span>page<span style="color: #909183;">)</span>;
    area-&gt;nr_free--;
    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#26356;&#26032;&#24403;&#21069;&#20869;&#23384;&#22495;&#30340;&#32479;&#35745;&#37327;</span><span style="color: #8D8D84;"> */</span>
    __mod_zone_page_state<span style="color: #909183;">(</span>zone, NR_FREE_PAGES, - <span style="color: #709870;">(</span><span style="color: #D0372D;">1UL</span> &lt;&lt; order<span style="color: #709870;">)</span><span style="color: #909183;">)</span>;
    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#22914;&#26524;&#21462;&#21040;&#30340;&#20869;&#23384;&#22359;&#30340;&#39029;&#25968;&#22823;&#20110;&#35831;&#27714;&#30340;&#25968;&#65292; &#25286;&#20998;&#35813;&#20869;&#23384;&#22359;</span><span style="color: #8D8D84;"> */</span>
    expand<span style="color: #909183;">(</span>zone, page, order, current_order, area, migratetype<span style="color: #909183;">)</span>;
    <span style="color: #0000FF;">return</span> page;
  <span style="color: #7388D6;">}</span>

  <span style="color: #0000FF;">return</span> <span style="color: #D0372D;">NULL</span>;
<span style="color: #707183;">}</span>

<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Remove an element from the buddy allocator from the fallback list</span><span style="color: #8D8D84;"> */</span>
<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#22791;&#29992;&#27425;&#24207;&#20013;&#20998;&#37197;</span><span style="color: #8D8D84;"> */</span>
<span style="color: #0000FF;">static</span> <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">page</span> *<span style="color: #006699;">__rmqueue_fallback</span><span style="color: #707183;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">zone</span> *<span style="color: #BA36A5;">zone</span>, <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">order</span>,
            <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">start_migratetype</span><span style="color: #707183;">)</span>
<span style="color: #707183;">{</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">free_area</span> * <span style="color: #BA36A5;">area</span>;
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">current_order</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">page</span> *<span style="color: #BA36A5;">page</span>;
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">migratetype</span>, <span style="color: #BA36A5;">i</span>;

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Find the largest possible block of pages in the other list</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#36941;&#21382;&#22791;&#29992;&#21015;&#34920;&#30340;&#19981;&#21516;&#36801;&#31227;&#31867;&#22411;&#65292;&#65288;&#37325;&#35201;&#65289;&#25353;&#38454;&#20174;&#22823;&#21040;&#23567;&#36941;&#21382;&#65292;&#22240;&#20026;</span>
<span style="color: #8D8D84; font-style: italic;">     &#36825;&#26679;&#33021;&#23613;&#21487;&#33021;&#24471;&#21040;&#22823;&#22359;&#30340;&#20869;&#23384;&#65292;&#20174;&#32780;&#20943;&#23569;&#21521;&#20854;&#20182;&#31867;&#22411;&#24341;&#20837;&#30862;&#29255;</span><span style="color: #8D8D84;">*/</span>
  <span style="color: #0000FF;">for</span> <span style="color: #7388D6;">(</span>current_order = MAX_ORDER-<span style="color: #D0372D;">1</span>; current_order &gt;= order;
            --current_order<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">{</span>
    <span style="color: #0000FF;">for</span> <span style="color: #909183;">(</span>i = <span style="color: #D0372D;">0</span>; i &lt; MIGRATE_TYPES - <span style="color: #D0372D;">1</span>; i++<span style="color: #909183;">)</span> <span style="color: #909183;">{</span>
      migratetype = fallbacks<span style="color: #709870;">[</span>start_migratetype<span style="color: #709870;">][</span>i<span style="color: #709870;">]</span>;

      <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">MIGRATE_RESERVE handled later if necessary</span><span style="color: #8D8D84;"> */</span>
      <span style="color: #0000FF;">if</span> <span style="color: #709870;">(</span>migratetype == MIGRATE_RESERVE<span style="color: #709870;">)</span>
        <span style="color: #0000FF;">continue</span>;

      area = &amp;<span style="color: #709870;">(</span>zone-&gt;free_area<span style="color: #907373;">[</span>current_order<span style="color: #907373;">]</span><span style="color: #709870;">)</span>;
      <span style="color: #0000FF;">if</span> <span style="color: #709870;">(</span>list_empty<span style="color: #907373;">(</span>&amp;area-&gt;free_list<span style="color: #6276BA;">[</span>migratetype<span style="color: #6276BA;">]</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
        <span style="color: #0000FF;">continue</span>;

      page = list_entry<span style="color: #709870;">(</span>area-&gt;free_list<span style="color: #907373;">[</span>migratetype<span style="color: #907373;">]</span>.next,
          <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">page</span>, lru<span style="color: #709870;">)</span>;
      area-&gt;nr_free--;

      <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">       * If breaking a large block of pages, move all free</span>
<span style="color: #8D8D84; font-style: italic;">       * pages to the preferred allocation list. If falling</span>
<span style="color: #8D8D84; font-style: italic;">       * back for a reclaimable kernel allocation, be more</span>
<span style="color: #8D8D84; font-style: italic;">       * agressive about taking ownership of free pages</span>
<span style="color: #8D8D84;">       */</span>
      <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#36825;&#26679;&#20570;&#26159;&#22240;&#20026;&#22914;&#26524;&#21097;&#20313;&#37096;&#20998;&#20063;&#26159;&#19968;&#20010;&#27604;&#36739;&#22823;&#30340;&#20869;&#23384;&#22359;&#65292;&#37027;&#20040;&#23558;&#25972;&#20010;&#20869;&#23384;&#22359;</span>
<span style="color: #8D8D84; font-style: italic;">      *  &#37117;&#36716;&#31227;&#21040;&#24403;&#21069;&#20998;&#37197;&#31867;&#22411;&#23545;&#24212;&#30340;&#36801;&#31227;&#21015;&#34920;&#26159;&#26377;&#24847;&#20041;&#30340;,&#36825;&#26679;&#21487;&#20197;&#20943;&#23569;&#30862;&#29255;</span><span style="color: #8D8D84;">*/</span>
      <span style="color: #0000FF;">if</span> <span style="color: #709870;">(</span>unlikely<span style="color: #907373;">(</span>current_order &gt;= <span style="color: #6276BA;">(</span>pageblock_order &gt;&gt; <span style="color: #D0372D;">1</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span> ||
          start_migratetype == MIGRATE_RECLAIMABLE<span style="color: #709870;">)</span> <span style="color: #709870;">{</span>
        <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">pages</span>;
        pages = move_freepages_block<span style="color: #907373;">(</span>zone, page,
                start_migratetype<span style="color: #907373;">)</span>;

        <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Claim the whole block if over half of it is free</span><span style="color: #8D8D84;"> */</span>
        <span style="color: #0000FF;">if</span> <span style="color: #907373;">(</span>pages &gt;= <span style="color: #6276BA;">(</span><span style="color: #D0372D;">1</span> &lt;&lt; <span style="color: #858580;">(</span>pageblock_order-<span style="color: #D0372D;">1</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
          set_pageblock_migratetype<span style="color: #907373;">(</span>page,
                start_migratetype<span style="color: #907373;">)</span>;

        migratetype = start_migratetype;
      <span style="color: #709870;">}</span>

      <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Remove the page from the freelists</span><span style="color: #8D8D84;"> */</span>
      list_del<span style="color: #709870;">(</span>&amp;page-&gt;lru<span style="color: #709870;">)</span>;
      rmv_page_order<span style="color: #709870;">(</span>page<span style="color: #709870;">)</span>;
      __mod_zone_page_state<span style="color: #709870;">(</span>zone, NR_FREE_PAGES,
              -<span style="color: #907373;">(</span><span style="color: #D0372D;">1UL</span> &lt;&lt; order<span style="color: #907373;">)</span><span style="color: #709870;">)</span>;

      <span style="color: #0000FF;">if</span> <span style="color: #709870;">(</span>current_order == pageblock_order<span style="color: #709870;">)</span>
        set_pageblock_migratetype<span style="color: #709870;">(</span>page,
              start_migratetype<span style="color: #709870;">)</span>;

      expand<span style="color: #709870;">(</span>zone, page, order, current_order, area, migratetype<span style="color: #709870;">)</span>;
      <span style="color: #0000FF;">return</span> page;
    <span style="color: #909183;">}</span>
  <span style="color: #7388D6;">}</span>

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Use MIGRATE_RESERVE rather than fail an allocation</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#22914;&#26524;&#25152;&#20197;&#22791;&#29992;&#21015;&#34920;&#20063;&#37117;&#20998;&#37197;&#22833;&#36133;&#65292;&#23581;&#35797;&#20174;&#20445;&#30041;&#31867;&#22411;&#20013;&#20998;&#37197;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">return</span> __rmqueue_smallest<span style="color: #7388D6;">(</span>zone, order, MIGRATE_RESERVE<span style="color: #7388D6;">)</span>;
<span style="color: #707183;">}</span>
<span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;"> * This array describes the order lists are fallen back to when</span>
<span style="color: #8D8D84; font-style: italic;"> * the free lists for the desirable migrate type are depleted</span>
<span style="color: #8D8D84;"> */</span>
<span style="color: #0000FF;">static</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">fallbacks</span><span style="color: #707183;">[</span>MIGRATE_TYPES<span style="color: #707183;">][</span>MIGRATE_TYPES-<span style="color: #D0372D;">1</span><span style="color: #707183;">]</span> = <span style="color: #707183;">{</span>
  <span style="color: #7388D6;">[</span>MIGRATE_UNMOVABLE<span style="color: #7388D6;">]</span>   = <span style="color: #7388D6;">{</span> MIGRATE_RECLAIMABLE, MIGRATE_MOVABLE,   MIGRATE_RESERVE <span style="color: #7388D6;">}</span>,
  <span style="color: #7388D6;">[</span>MIGRATE_RECLAIMABLE<span style="color: #7388D6;">]</span> = <span style="color: #7388D6;">{</span> MIGRATE_UNMOVABLE,   MIGRATE_MOVABLE,   MIGRATE_RESERVE <span style="color: #7388D6;">}</span>,
  <span style="color: #7388D6;">[</span>MIGRATE_MOVABLE<span style="color: #7388D6;">]</span>     = <span style="color: #7388D6;">{</span> MIGRATE_RECLAIMABLE, MIGRATE_UNMOVABLE, MIGRATE_RESERVE <span style="color: #7388D6;">}</span>,
  <span style="color: #7388D6;">[</span>MIGRATE_RESERVE<span style="color: #7388D6;">]</span>     = <span style="color: #7388D6;">{</span> MIGRATE_RESERVE,     MIGRATE_RESERVE,   MIGRATE_RESERVE <span style="color: #7388D6;">}</span>, <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Never used</span><span style="color: #8D8D84;"> */</span>
<span style="color: #707183;">}</span>;





<span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;"> * This page is about to be returned from the page allocator</span>
<span style="color: #8D8D84;"> */</span>
<span style="color: #0000FF;">static</span> <span style="color: #6434A3;">int</span> <span style="color: #006699;">prep_new_page</span><span style="color: #707183;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">page</span> *<span style="color: #BA36A5;">page</span>, <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">order</span>, <span style="color: #6434A3;">gfp_t</span> <span style="color: #BA36A5;">gfp_flags</span><span style="color: #707183;">)</span>
<span style="color: #707183;">{</span>
  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>unlikely<span style="color: #909183;">(</span>page_mapcount<span style="color: #709870;">(</span>page<span style="color: #709870;">)</span> |
    <span style="color: #709870;">(</span>page-&gt;mapping != <span style="color: #D0372D;">NULL</span><span style="color: #709870;">)</span>  |
    <span style="color: #709870;">(</span>page_count<span style="color: #907373;">(</span>page<span style="color: #907373;">)</span> != <span style="color: #D0372D;">0</span><span style="color: #709870;">)</span>  |
    <span style="color: #709870;">(</span>page-&gt;flags &amp; <span style="color: #907373;">(</span>
      <span style="color: #D0372D;">1</span> &lt;&lt; PG_lru |
      <span style="color: #D0372D;">1</span> &lt;&lt; PG_private |
      <span style="color: #D0372D;">1</span> &lt;&lt; PG_locked  |
      <span style="color: #D0372D;">1</span> &lt;&lt; PG_active  |
      <span style="color: #D0372D;">1</span> &lt;&lt; PG_dirty |
      <span style="color: #D0372D;">1</span> &lt;&lt; PG_slab    |
      <span style="color: #D0372D;">1</span> &lt;&lt; PG_swapcache |
      <span style="color: #D0372D;">1</span> &lt;&lt; PG_writeback |
      <span style="color: #D0372D;">1</span> &lt;&lt; PG_reserved |
      <span style="color: #D0372D;">1</span> &lt;&lt; PG_buddy <span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
    bad_page<span style="color: #7388D6;">(</span>page<span style="color: #7388D6;">)</span>;

  <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">   * For now, we report if PG_reserved was found set, but do not</span>
<span style="color: #8D8D84; font-style: italic;">   * clear it, and do not allocate the page: as a safety net.</span>
<span style="color: #8D8D84;">   */</span>
  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>PageReserved<span style="color: #909183;">(</span>page<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
    <span style="color: #0000FF;">return</span> <span style="color: #D0372D;">1</span>;

  page-&gt;flags &amp;= ~<span style="color: #7388D6;">(</span><span style="color: #D0372D;">1</span> &lt;&lt; PG_uptodate | <span style="color: #D0372D;">1</span> &lt;&lt; PG_error | <span style="color: #D0372D;">1</span> &lt;&lt; PG_readahead |
      <span style="color: #D0372D;">1</span> &lt;&lt; PG_referenced | <span style="color: #D0372D;">1</span> &lt;&lt; PG_arch_1 |
      <span style="color: #D0372D;">1</span> &lt;&lt; PG_owner_priv_1 | <span style="color: #D0372D;">1</span> &lt;&lt; PG_mappedtodisk<span style="color: #7388D6;">)</span>;
  set_page_private<span style="color: #7388D6;">(</span>page, <span style="color: #D0372D;">0</span><span style="color: #7388D6;">)</span>;
  set_page_refcounted<span style="color: #7388D6;">(</span>page<span style="color: #7388D6;">)</span>;

  arch_alloc_page<span style="color: #7388D6;">(</span>page, order<span style="color: #7388D6;">)</span>;
  kernel_map_pages<span style="color: #7388D6;">(</span>page, <span style="color: #D0372D;">1</span> &lt;&lt; order, <span style="color: #D0372D;">1</span><span style="color: #7388D6;">)</span>;

  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>gfp_flags &amp; __GFP_ZERO<span style="color: #7388D6;">)</span>
    prep_zero_page<span style="color: #7388D6;">(</span>page, order, gfp_flags<span style="color: #7388D6;">)</span>;

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#23558;&#35831;&#27714;&#30340;&#22810;&#39029;&#32452;&#25104;&#22797;&#21512;&#39029;&#65292;&#35814;&#35265;&#19979;&#25991;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>order &amp;&amp; <span style="color: #909183;">(</span>gfp_flags &amp; __GFP_COMP<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
    prep_compound_page<span style="color: #7388D6;">(</span>page, order<span style="color: #7388D6;">)</span>;

  <span style="color: #0000FF;">return</span> <span style="color: #D0372D;">0</span>;
<span style="color: #707183;">}</span>
</pre>
</div>
<p>
复合页：
</p>

<div id="orgdf2e972" class="figure">
<p><img src="reading/2020-11-15_17-01-52_screenshot.png" alt="2020-11-15_17-01-52_screenshot.png" />
</p>
</div>
</div>
</li>

<li><a id="org9b74f1f"></a>释放页 _<sub>free</sub><sub>pages</sub><br />
<div class="outline-text-7" id="text-3-9-2-5-4-5">
<p>
_<sub>free</sub><sub>pages是释放内存的基础函数,其代码流程如下</sub>：
</p>

<div id="org6286677" class="figure">
<p><img src="reading/2020-11-15_17-25-41_screenshot.png" alt="2020-11-15_17-25-41_screenshot.png" />  
</p>
</div>
<div class="org-src-container">
<pre class="src src-c">fastcall <span style="color: #6434A3;">void</span> <span style="color: #006699;">__free_pages</span><span style="color: #707183;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">page</span> *<span style="color: #BA36A5;">page</span>, <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">order</span><span style="color: #707183;">)</span>
<span style="color: #707183;">{</span>
  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>put_page_testzero<span style="color: #909183;">(</span>page<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">{</span>
    <span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span>order == <span style="color: #D0372D;">0</span><span style="color: #909183;">)</span>    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#22914;&#26524;&#20998;&#37197;&#21333;&#39029;</span><span style="color: #8D8D84;"> */</span>
      free_hot_page<span style="color: #909183;">(</span>page<span style="color: #909183;">)</span>;
    <span style="color: #0000FF;">else</span>               <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#20998;&#37197;&#22810;&#39029;</span><span style="color: #8D8D84;"> */</span>
      __free_pages_ok<span style="color: #909183;">(</span>page, order<span style="color: #909183;">)</span>;
  <span style="color: #7388D6;">}</span>
<span style="color: #707183;">}</span>

<span style="color: #0000FF;">static</span> <span style="color: #6434A3;">void</span> <span style="color: #006699;">fastcall</span> free_hot_cold_page<span style="color: #707183;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">page</span> *<span style="color: #BA36A5;">page</span>, <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">cold</span><span style="color: #707183;">)</span>
<span style="color: #707183;">{</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">zone</span> *<span style="color: #BA36A5;">zone</span> = page_zone<span style="color: #7388D6;">(</span>page<span style="color: #7388D6;">)</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">per_cpu_pages</span> *<span style="color: #BA36A5;">pcp</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">flags</span>;

  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>PageAnon<span style="color: #909183;">(</span>page<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
    page-&gt;mapping = <span style="color: #D0372D;">NULL</span>;
  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>free_pages_check<span style="color: #909183;">(</span>page<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
    <span style="color: #0000FF;">return</span>;

  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>!PageHighMem<span style="color: #909183;">(</span>page<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
    debug_check_no_locks_freed<span style="color: #7388D6;">(</span>page_address<span style="color: #909183;">(</span>page<span style="color: #909183;">)</span>, PAGE_SIZE<span style="color: #7388D6;">)</span>;
  arch_free_page<span style="color: #7388D6;">(</span>page, <span style="color: #D0372D;">0</span><span style="color: #7388D6;">)</span>;
  kernel_map_pages<span style="color: #7388D6;">(</span>page, <span style="color: #D0372D;">1</span>, <span style="color: #D0372D;">0</span><span style="color: #7388D6;">)</span>;

  pcp = &amp;zone_pcp<span style="color: #7388D6;">(</span>zone, get_cpu<span style="color: #909183;">()</span><span style="color: #7388D6;">)</span>-&gt;pcp<span style="color: #7388D6;">[</span>cold<span style="color: #7388D6;">]</span>;
  local_irq_save<span style="color: #7388D6;">(</span>flags<span style="color: #7388D6;">)</span>;
  __count_vm_event<span style="color: #7388D6;">(</span>PGFREE<span style="color: #7388D6;">)</span>;
  list_add<span style="color: #7388D6;">(</span>&amp;page-&gt;lru, &amp;pcp-&gt;list<span style="color: #7388D6;">)</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#23558;private&#35774;&#32622;&#20026;&#36801;&#31227;&#31867;&#22411;</span><span style="color: #8D8D84;"> */</span>
  set_page_private<span style="color: #7388D6;">(</span>page, get_pageblock_migratetype<span style="color: #909183;">(</span>page<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>;
  pcp-&gt;count++;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#25042;&#24816;&#21512;&#24182;,&#33021;&#20943;&#23569;&#21512;&#24182;&#27425;&#25968;&#32780;&#33410;&#32422;&#26102;&#38388;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>pcp-&gt;count &gt;= pcp-&gt;high<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">{</span>  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#22914;&#26524;&#32531;&#23384;&#20013;&#30340;&#39029;&#36229;&#20986;&#33539;&#22260;&#65292;&#23558;batch&#20010;&#20869;&#23384;&#39029;&#36824;&#32473;&#20249;&#20276;&#31995;&#32479;</span><span style="color: #8D8D84;"> */</span>
    free_pages_bulk<span style="color: #909183;">(</span>zone, pcp-&gt;batch, &amp;pcp-&gt;list, <span style="color: #D0372D;">0</span><span style="color: #909183;">)</span>;
    pcp-&gt;count -= pcp-&gt;batch;
  <span style="color: #7388D6;">}</span>
  local_irq_restore<span style="color: #7388D6;">(</span>flags<span style="color: #7388D6;">)</span>;
  put_cpu<span style="color: #7388D6;">()</span>;
<span style="color: #707183;">}</span>

<span style="color: #0000FF;">static</span> <span style="color: #6434A3;">void</span> <span style="color: #006699;">__free_pages_ok</span><span style="color: #707183;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">page</span> *<span style="color: #BA36A5;">page</span>, <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">order</span><span style="color: #707183;">)</span>
<span style="color: #707183;">{</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">flags</span>;
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">i</span>;
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">reserved</span> = <span style="color: #D0372D;">0</span>;

  <span style="color: #0000FF;">for</span> <span style="color: #7388D6;">(</span>i = <span style="color: #D0372D;">0</span> ; i &lt; <span style="color: #909183;">(</span><span style="color: #D0372D;">1</span> &lt;&lt; order<span style="color: #909183;">)</span> ; ++i<span style="color: #7388D6;">)</span>
    reserved += free_pages_check<span style="color: #7388D6;">(</span>page + i<span style="color: #7388D6;">)</span>;
  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>reserved<span style="color: #7388D6;">)</span>
    <span style="color: #0000FF;">return</span>;

  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>!PageHighMem<span style="color: #909183;">(</span>page<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
    debug_check_no_locks_freed<span style="color: #7388D6;">(</span>page_address<span style="color: #909183;">(</span>page<span style="color: #909183;">)</span>,PAGE_SIZE&lt;&lt;order<span style="color: #7388D6;">)</span>;
  arch_free_page<span style="color: #7388D6;">(</span>page, order<span style="color: #7388D6;">)</span>;
  kernel_map_pages<span style="color: #7388D6;">(</span>page, <span style="color: #D0372D;">1</span> &lt;&lt; order, <span style="color: #D0372D;">0</span><span style="color: #7388D6;">)</span>;

  local_irq_save<span style="color: #7388D6;">(</span>flags<span style="color: #7388D6;">)</span>;
  __count_vm_events<span style="color: #7388D6;">(</span>PGFREE, <span style="color: #D0372D;">1</span> &lt;&lt; order<span style="color: #7388D6;">)</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#30456;&#20851;&#20869;&#23384;&#21306;&#34987;&#28155;&#21152;&#21040;&#20249;&#20276;&#31995;&#32479;&#20013;&#36866;&#24403;&#30340;free_area&#21015;&#34920;&#20013;,&#24182;&#36882;&#24402;&#21512;&#24182;,&#20855;&#20307;</span>
<span style="color: #8D8D84; font-style: italic;">  *   &#20363;&#23376;&#30475;&#19979;&#22270;</span><span style="color: #8D8D84;">*/</span>
  free_one_page<span style="color: #7388D6;">(</span>page_zone<span style="color: #909183;">(</span>page<span style="color: #909183;">)</span>, page, order<span style="color: #7388D6;">)</span>;
  local_irq_restore<span style="color: #7388D6;">(</span>flags<span style="color: #7388D6;">)</span>;
<span style="color: #707183;">}</span>
</pre>
</div>

<div id="org65dac33" class="figure">
<p><img src="reading/2020-11-15_18-36-03_screenshot.png" alt="2020-11-15_18-36-03_screenshot.png" />
</p>
</div>

<div id="org57f2482" class="figure">
<p><img src="reading/2020-11-15_18-36-59_screenshot.png" alt="2020-11-15_18-36-59_screenshot.png" />
</p>
</div>
</div>
</li>

<li><a id="orgeac8606"></a>内核不连续页的分配vmalloc<br />
<div class="outline-text-7" id="text-3-9-2-5-4-6">
<p>
我们知道，物理上连续的映射对内核是最好的：
</p>
<ol class="org-ol">
<li>有些求地址操作可以直接线性求出，不需要经过页表计算，也不需要复杂的数据结构</li>
<li>减少TLB占用</li>
<li>catch命中率更高，所以速度更快</li>
</ol>

<p>
但是这并不总是能成功，特别是开机很久之后，因为这时内存可能已经比较碎片化了。
所以内核也需要使用像用户态一样的技术：通过处理器的分页机制，分配物理上不连续但虚拟空间
连续的内存。当然这会降低速度并占用TLB.
</p>

<p>
内核分配了其虚拟空间的一部分用于建立这种连续映射(32和64位都有)。并提供vmalloc接口函数
来为内核建立连续映射。
</p>

<p>
vmalloc最著名的实例是内核对模块的实现。还有设备和声音驱动中。vmalloc内存页总是优先使用
高端内存。 其实现对应的数据结构是：
</p>
<div class="org-src-container">
<pre class="src src-c">
<span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">vm_struct</span> <span style="color: #707183;">{</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">keep next,addr,size together to speedup lookups</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">vm_struct</span>  *<span style="color: #BA36A5;">next</span>;
  <span style="color: #6434A3;">void</span>      *<span style="color: #BA36A5;">addr</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span>   <span style="color: #BA36A5;">size</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span>   <span style="color: #BA36A5;">flags</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">page</span>   **<span style="color: #BA36A5;">pages</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span>    <span style="color: #BA36A5;">nr_pages</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span>   <span style="color: #BA36A5;">phys_addr</span>;
<span style="color: #707183;">}</span>;
</pre>
</div>
<p>
书中给除了该结构的一个实例：
</p>

<div id="orgcbfcc60" class="figure">
<p><img src="reading/2020-11-15_19-14-27_screenshot.png" alt="2020-11-15_19-14-27_screenshot.png" />
</p>
</div>

<ul class="org-ul">
<li><p>
vmalloc分配流程：
</p>
<ol class="org-ol">
<li>get<sub>vm</sub><sub>area在vmalloc地址空间中找到适当的区域</sub></li>
<li>从伙伴系统中分配各个物理页，重点是注意他是一页一页分配的，而不是一次分配一大块，
确保在物理内存有严重碎片的情况下，vmalloc依然可以工作。</li>
</ol>
<p>
3， map<sub>vm</sub><sub>area将这些页连续地映射到vmalloc区域中,并正确设置相关的页表项</sub>
</p>

<div id="org9d7dfc2" class="figure">
<p><img src="reading/2020-11-15_19-24-47_screenshot.png" alt="2020-11-15_19-24-47_screenshot.png" />
</p>
</div></li>
<li><p>
内核虚拟映射内存的释放：
</p>

<div id="org15c11ec" class="figure">
<p><img src="reading/2020-11-15_19-26-47_screenshot.png" alt="2020-11-15_19-26-47_screenshot.png" />
</p>
</div></li>
</ul>
</div>
</li>

<li><a id="org9a13ff8"></a>内核其他映射类型<br />
<div class="outline-text-7" id="text-3-9-2-5-4-7">
<p>
尽管vmalloc可以用于从高端内存域向内核映射页帧，但是内核还提供了其他函数用于将ZONE<sub>HIGHMEM</sub>
页帧显式映射到内核地址空间中：
</p>
<ol class="org-ol">
<li>持久映射kmap</li>
<li>固定映射kmap<sub>atomic</sub></li>
</ol>
<p>
因为现在用的基本是64位机器，已经没有了ZONE<sub>HIGMEM</sub>，所以这里不详细了解这些映射了，因为
64下这些操作就是一些很简单的宏：
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #0000FF;">static</span> <span style="color: #0000FF;">inline</span> <span style="color: #6434A3;">void</span> *<span style="color: #006699;">kmap</span><span style="color: #707183;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">page</span> *<span style="color: #BA36A5;">page</span><span style="color: #707183;">)</span>
<span style="color: #707183;">{</span>
  might_sleep<span style="color: #7388D6;">()</span>;
  <span style="color: #0000FF;">return</span> page_address<span style="color: #7388D6;">(</span>page<span style="color: #7388D6;">)</span>;
<span style="color: #707183;">}</span>

<span style="color: #808080;">#define</span> <span style="color: #006699;">kunmap</span><span style="color: #707183;">(</span><span style="color: #BA36A5;">page</span><span style="color: #707183;">)</span> <span style="color: #0000FF;">do</span> <span style="color: #707183;">{</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">void</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span>page<span style="color: #7388D6;">)</span>; <span style="color: #707183;">}</span> <span style="color: #0000FF;">while</span> <span style="color: #707183;">(</span><span style="color: #D0372D;">0</span><span style="color: #707183;">)</span>

<span style="color: #808080;">#include</span> <span style="color: #707183;">&lt;</span><span style="color: #008000;">asm/kmap_types.h</span><span style="color: #707183;">&gt;</span>

<span style="color: #0000FF;">static</span> <span style="color: #0000FF;">inline</span> <span style="color: #6434A3;">void</span> *<span style="color: #006699;">kmap_atomic</span><span style="color: #707183;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">page</span> *<span style="color: #BA36A5;">page</span>, <span style="color: #0000FF;">enum</span> <span style="color: #6434A3;">km_type</span> <span style="color: #BA36A5;">idx</span><span style="color: #707183;">)</span>
<span style="color: #707183;">{</span>
  pagefault_disable<span style="color: #7388D6;">()</span>;
  <span style="color: #0000FF;">return</span> page_address<span style="color: #7388D6;">(</span>page<span style="color: #7388D6;">)</span>;
<span style="color: #707183;">}</span>
<span style="color: #808080;">#define</span> <span style="color: #006699;">kmap_atomic_prot</span><span style="color: #707183;">(</span><span style="color: #BA36A5;">page</span>, <span style="color: #BA36A5;">idx</span>, <span style="color: #BA36A5;">prot</span><span style="color: #707183;">)</span> kmap_atomic<span style="color: #707183;">(</span>page, idx<span style="color: #707183;">)</span>

<span style="color: #808080;">#define</span> <span style="color: #006699;">kunmap_atomic</span><span style="color: #707183;">(</span><span style="color: #BA36A5;">addr</span>, <span style="color: #BA36A5;">idx</span><span style="color: #707183;">)</span>  <span style="color: #0000FF;">do</span> <span style="color: #707183;">{</span> pagefault_enable<span style="color: #7388D6;">()</span>; <span style="color: #707183;">}</span> <span style="color: #0000FF;">while</span> <span style="color: #707183;">(</span><span style="color: #D0372D;">0</span><span style="color: #707183;">)</span>
<span style="color: #808080;">#define</span> <span style="color: #006699;">kmap_atomic_pfn</span><span style="color: #707183;">(</span><span style="color: #BA36A5;">pfn</span>, <span style="color: #BA36A5;">idx</span><span style="color: #707183;">)</span> kmap_atomic<span style="color: #707183;">(</span>pfn_to_page<span style="color: #7388D6;">(</span>pfn<span style="color: #7388D6;">)</span>, <span style="color: #7388D6;">(</span>idx<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #808080;">#define</span> <span style="color: #006699;">kmap_atomic_to_page</span><span style="color: #707183;">(</span><span style="color: #BA36A5;">ptr</span><span style="color: #707183;">)</span>  virt_to_page<span style="color: #707183;">(</span>ptr<span style="color: #707183;">)</span>

<span style="color: #808080;">#define</span> <span style="color: #006699;">kmap_flush_unused</span><span style="color: #707183;">()</span> <span style="color: #0000FF;">do</span> <span style="color: #707183;">{}</span> <span style="color: #0000FF;">while</span><span style="color: #707183;">(</span><span style="color: #D0372D;">0</span><span style="color: #707183;">)</span>
<span style="color: #808080;">#endif</span>
</pre>
</div>
</div>
</li>
</ol>
</li>
</ol>
</li>

<li><a id="org9c626dc"></a>slab分配器<br />
<div class="outline-text-5" id="text-3-9-2-6">
<p>
伙伴系统只支持页级别的内存分配，这个单位太大了，我们需要一个可以以字节为单位的分配器。
它的实现应该尽可能紧凑，以便不要对处理器的高速缓存和TLB带来显著的影响。linux实现了
一个这样的分配器slab。它不仅可以用来分配小内存，而且也用做一个缓存。
</p>
</div>

<ol class="org-ol">
<li><a id="orgdbf5859"></a>slab相对直接使用伙伴系统的优势：<br />
<div class="outline-text-6" id="text-3-9-2-6-1">
<ol class="org-ol">
<li>由于内核不必使用伙伴系统算法，分配内存处理时间会变短</li>
<li>slab作为缓存将释放的内存保存在它的内部列表中，并不马上还给伙伴系统，所以再次使用
该内存块时，它依然在cpu高速缓存中的概率较高</li>
<li>有助于防止不受欢迎的缓存“污染”。因为调用伙伴系统的操作对系统的数据和指令的高速
缓存有相当的影响。</li>
<li>实现缓存的均匀利用。伙伴系统取的内存，其地址总是在2的幂次的整数倍附近。这种地址
分布使得某些缓存行过度使用，而其他的则几乎为空。多处理器下还可能因为不同内存地址
在不同的总线上传输，使得有些总线拥塞，而其他几乎没有使用。 slab通过slab着色能够
实现均匀地利用cpu缓存。</li>
</ol>
<p>
slab着色： <a href="http://www.360doc.com/content/12/0828/15/7982302_232808690.shtml">http://www.360doc.com/content/12/0828/15/7982302_232808690.shtml</a> 
</p>
</div>
</li>
<li><a id="orgf8189ef"></a>slob和slub<br />
<div class="outline-text-6" id="text-3-9-2-6-2">
<p>
这两个函数用于特定的硬件，实现的功能和slab差不多，slob用于小型的嵌入式系统，slub
用于大型系统上
</p>
</div>
</li>
<li><a id="org3f2fe30"></a>三个函数提供的标准接口<br />
<div class="outline-text-6" id="text-3-9-2-6-3">
<p>
不管slab，slob还是slub，都实现了一组特定的函数，用于内存分配和缓存。它们与分配器
的关系如图：
</p>

<div id="org505a350" class="figure">
<p><img src="reading/2020-11-15_21-49-32_screenshot.png" alt="2020-11-15_21-49-32_screenshot.png" />
</p>
</div>
</div>
</li>
<li><a id="orge71b999"></a>slab数据结构<br />
<div class="outline-text-6" id="text-3-9-2-6-4">
<p>
slab主要由struct kmem<sub>cache结构来表示,其中</sub>，每个kmem<sub>cache只缓存一种对象</sub>。
多个对象会合并成一个组，覆盖一个或多个连续页帧。这种组称作slab；每个kmem<sub>cache</sub>
由多个slab组成。其概览图如下：
</p>

<div id="org4bd761a" class="figure">
<p><img src="reading/2020-11-16_10-15-31_screenshot.png" alt="2020-11-16_10-15-31_screenshot.png" />
</p>
</div>

<p>
struct kmem<sub>cache主要成员有</sub>:
</p>
<div class="org-src-container">
<pre class="src src-c">
<span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">kmem_cache</span> <span style="color: #707183;">{</span>
<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">1) per-cpu data, touched during every alloc/free</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">array_cache</span> *<span style="color: #BA36A5;">array</span><span style="color: #7388D6;">[</span>NR_CPUS<span style="color: #7388D6;">]</span>;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#27599;&#27425;&#20998;&#37197;/&#37322;&#25918;&#26399;&#38388;&#37117;&#20250;&#35775;&#38382;, &#20854;&#20855;&#20307;&#32467;&#26500;&#22312;&#19979;&#38754;&#20195;&#30721;&#32473;&#20986;</span><span style="color: #8D8D84;"> */</span>
<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">2) Cache tunables. Protected by cache_chain_mutex</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#21487;&#35843;&#25972;&#30340;&#32531;&#23384;&#21442;&#25968;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">batchcount</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">per-CPU&#21015;&#34920;&#20026;&#31354;&#26102;&#65292;&#20174;&#32531;&#23384;&#30340;slab&#20013;&#33719;&#21462;&#23545;&#35937;&#30340;&#25968;&#30446;,</span>
<span style="color: #8D8D84; font-style: italic;">                            &#36824;&#34920;&#31034; &#22312;&#32531;&#23384;&#22686;&#38271;&#26102;&#20998;&#37197;&#30340;&#23545;&#35937;&#25968;&#30446;</span><span style="color: #8D8D84;">*/</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">limit</span>;      <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#25351;&#23450;per-CPU&#21015;&#34920;&#20013;&#20445;&#23384;&#30340;&#23545;&#35937;&#30340;&#26368;&#22823;&#25968;&#30446;, &#22914;&#26524;&#36229;&#20986;&#35813;&#20540;&#65292;</span>
<span style="color: #8D8D84; font-style: italic;">                            &#20869;&#26680;&#20250;&#23558;batchcount&#20010;&#23545;&#35937;&#36820;&#22238;&#32473;slab</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">shared</span>;

  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">buffer_size</span>;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#32531;&#23384;&#20013;&#31649;&#29702;&#30340;&#23545;&#35937;&#30340;&#38271;&#24230;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">u32</span> <span style="color: #BA36A5;">reciprocal_buffer_size</span>;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#29992;&#26469;&#21152;&#24555;&#38500;&#27861;&#30340;&#35745;&#31639;</span><span style="color: #8D8D84;"> */</span>
<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">3) touched by every alloc &amp; free from the backend</span><span style="color: #8D8D84;"> */</span>

  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">flags</span>;   <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">constant flags</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#34920;&#31034;&#26368;&#22810;&#21487;&#26377;&#22810;&#23569;&#23545;&#35937;&#33021;&#25918;&#20837;slab</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">num</span>;   <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;"># of objs per slab</span><span style="color: #8D8D84;"> */</span>

<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">4) cache_grow/shrink</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">order of pgs per slab (2^n)</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">gfporder</span>;   <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#34920;&#31034;&#27599;&#20010;slab&#21253;&#21547;2^gfproder&#39029;</span><span style="color: #8D8D84;"> */</span>

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">force GFP flags, e.g. GFP_DMA</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">gfp_t</span> <span style="color: #BA36A5;">gfpflags</span>;

  <span style="color: #6434A3;">size_t</span> <span style="color: #BA36A5;">colour</span>;      <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">cache colouring range</span><span style="color: #8D8D84;"> */</span> <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#30528;&#33394;&#30456;&#20851;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">colour_off</span>;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">colour offset</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">kmem_cache</span> *<span style="color: #BA36A5;">slabp_cache</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">slab_size</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">dflags</span>;    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">dynamic flags</span><span style="color: #8D8D84;"> */</span>

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">constructor func</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">void</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">ctor</span><span style="color: #7388D6;">)(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">kmem_cache</span> *, <span style="color: #6434A3;">void</span> *<span style="color: #7388D6;">)</span>;

<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">5) cache creation/removal</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">const</span> <span style="color: #6434A3;">char</span> *<span style="color: #BA36A5;">name</span>;    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">/proc/slabinfo&#20013;&#30340;&#21517;&#31216;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span> <span style="color: #BA36A5;">next</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#23558;&#25152;&#26377;&#23454;&#20363;&#20445;&#23384;&#22312;&#20840;&#23616;&#38142;&#34920;cache_chain&#19978;</span><span style="color: #8D8D84;"> */</span>

<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">6) statistics</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#if</span> STATS
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">num_active</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">num_allocations</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">high_mark</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">grown</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">reaped</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">errors</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">max_freeable</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">node_allocs</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">node_frees</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">node_overflow</span>;
  <span style="color: #6434A3;">atomic_t</span> <span style="color: #BA36A5;">allochit</span>;
  <span style="color: #6434A3;">atomic_t</span> <span style="color: #BA36A5;">allocmiss</span>;
  <span style="color: #6434A3;">atomic_t</span> <span style="color: #BA36A5;">freehit</span>;
  <span style="color: #6434A3;">atomic_t</span> <span style="color: #BA36A5;">freemiss</span>;
<span style="color: #808080;">#endif</span>
<span style="color: #808080;">#if</span> DEBUG
  <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">   * If debugging is enabled, then the allocator can add additional</span>
<span style="color: #8D8D84; font-style: italic;">   * fields and/or padding to every object. buffer_size contains the total</span>
<span style="color: #8D8D84; font-style: italic;">   * object size including these internal fields, the following two</span>
<span style="color: #8D8D84; font-style: italic;">   * variables contain the offset to the user object and its size.</span>
<span style="color: #8D8D84;">   */</span>
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">obj_offset</span>;
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">obj_size</span>;
<span style="color: #808080;">#endif</span>
  <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">   * We put nodelists[] at the end of kmem_cache, because we want to size</span>
<span style="color: #8D8D84; font-style: italic;">   * this array to nr_node_ids slots instead of MAX_NUMNODES</span>
<span style="color: #8D8D84; font-style: italic;">   * (see kmem_cache_init())</span>
<span style="color: #8D8D84; font-style: italic;">   * We still use [MAX_NUMNODES] and not [1] or [0] because cache_cache</span>
<span style="color: #8D8D84; font-style: italic;">   * is statically defined, so we reserve the max number of nodes.</span>
<span style="color: #8D8D84;">   */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">kmem_list3</span> *<span style="color: #BA36A5;">nodelists</span><span style="color: #7388D6;">[</span>MAX_NUMNODES<span style="color: #7388D6;">]</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#27599;&#20010;&#25968;&#32452;&#39033;&#23545;&#24212;&#20110;&#31995;&#32479;&#20013;&#19968;&#20010;&#21487;&#33021;&#30340;</span>
<span style="color: #8D8D84; font-style: italic;">                                               &#20869;&#23384;&#32467;&#28857;&#65292;&#20855;&#20307;&#32467;&#26500;&#22312;&#19979;&#38754;&#35752;&#35770;</span><span style="color: #8D8D84;">*/</span>
  <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">   * Do not add fields after nodelists[]</span>
<span style="color: #8D8D84;">   */</span>
<span style="color: #707183;">}</span>;


<span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;"> * struct array_cache</span>
<span style="color: #8D8D84; font-style: italic;"> *</span>
<span style="color: #8D8D84; font-style: italic;"> * Purpose:</span>
<span style="color: #8D8D84; font-style: italic;"> * - LIFO ordering, to hand out cache-warm objects from _alloc</span>
<span style="color: #8D8D84; font-style: italic;"> * - reduce the number of linked list operations</span>
<span style="color: #8D8D84; font-style: italic;"> * - reduce spinlock operations</span>
<span style="color: #8D8D84; font-style: italic;"> *</span>
<span style="color: #8D8D84; font-style: italic;"> * The limit is stored in the per-cpu structure to reduce the data cache</span>
<span style="color: #8D8D84; font-style: italic;"> * footprint.</span>
<span style="color: #8D8D84; font-style: italic;"> *</span>
<span style="color: #8D8D84;"> */</span>
<span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">array_cache</span> <span style="color: #707183;">{</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">avail</span>;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#24403;&#21069;&#21487;&#29992;&#23545;&#35937;&#30340;&#25968;&#30446;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">limit</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">batchcount</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">touched</span>;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#22312;&#20174;&#32531;&#23384;&#31227;&#38500;&#19968;&#20010;&#23545;&#35937;&#26102;&#65292;&#23558;touched&#32622;&#20026;1&#65307;&#32531;&#23384;&#25910;&#32553;&#26102;&#65292;&#32622;&#20026;0</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">spinlock_t</span> <span style="color: #BA36A5;">lock</span>;
  <span style="color: #6434A3;">void</span> *<span style="color: #BA36A5;">entry</span><span style="color: #7388D6;">[]</span>;  <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">                   * Must have this definition in here for the proper</span>
<span style="color: #8D8D84; font-style: italic;">                   * alignment of array_cache. Also simplifies accessing</span>
<span style="color: #8D8D84; font-style: italic;">                   * the entries.</span>
<span style="color: #8D8D84;">                   */</span>
<span style="color: #707183;">}</span>;

<span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;"> * The slab lists for all objects.</span>
<span style="color: #8D8D84;"> */</span>
<span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">kmem_list3</span> <span style="color: #707183;">{</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#37096;&#20998;&#31354;&#38386;&#65292;&#20840;&#28385;&#65292;&#20840;&#31354;&#38386;slab&#38142;&#34920;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span> <span style="color: #BA36A5;">slabs_partial</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">partial list first, better asm code</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span> <span style="color: #BA36A5;">slabs_full</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span> <span style="color: #BA36A5;">slabs_free</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">free_objects</span>;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">slabs_partial&#21644;slabs_free&#30340;&#25152;&#26377;slab&#20013;&#31354;&#38386;&#23545;&#35937;&#30340;&#24635;&#25968;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">free_limit</span>;     <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#31354;&#38386;&#23545;&#35937;&#30340;&#26368;&#22823;&#25968;&#30446;&#38480;&#21046;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">colour_next</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Per-node cache coloring</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">spinlock_t</span> <span style="color: #BA36A5;">list_lock</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">array_cache</span> *<span style="color: #BA36A5;">shared</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">shared per node</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">array_cache</span> **<span style="color: #BA36A5;">alien</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">on other nodes</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">next_reap</span>;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">updated without locking</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#34920;&#31034;&#32531;&#23384;&#26159;&#21542;&#26159;&#27963;&#21160;&#30340;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">free_touched</span>;   <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">updated without locking</span><span style="color: #8D8D84;"> */</span>
<span style="color: #707183;">}</span>;
</pre>
</div>

<div id="orgc71c3ff" class="figure">
<p><img src="reading/2020-11-16_11-22-18_screenshot.png" alt="2020-11-16_11-22-18_screenshot.png" />
</p>
</div>

<p>
可以看到，该结构不是直接从slab中取对象的，而是针对每个cpu有一个per-CPU指针，指向slab
中的未使用对象。这样做是为了更好地利用CPU高速缓存。它在分配和释放对象时，采用后进先出的
原理(LIFO)。其背后的原理是，刚释放的对象很可能仍然处于CPU高速缓存中。更进一步，slab
对象分配体系按分配成本和操作对CPU高速缓存及TLB的负面影响从低到高可以排序为三层：
</p>
<ol class="org-ol">
<li>仍然处于CPU高速缓存中的per-CPU对象</li>
<li>现存slab中未使用的对象</li>
<li>刚使用伙伴系统分配的新slab中未使用的对象</li>
</ol>

<p>
一个slab组的精细结构：
</p>
<p>
<img src="reading/2020-11-16_13-46-02_screenshot.png" alt="2020-11-16_13-46-02_screenshot.png" />
其中，它的头部管理数据中有一个数组，每个数组项对于一个对象，用来记录下一个空闲对象的索引，
所以只有在对象没有分配时，相应的数组项才有意义。如下图：
</p>

<div id="orgd653aa6" class="figure">
<p><img src="reading/2020-11-16_13-49-39_screenshot.png" alt="2020-11-16_13-49-39_screenshot.png" />
</p>
</div>

<p>
最后，内核有时候需要从对象自身识别对象所在的slab，内核利用如下机制来完成该任务：
</p>
<ol class="org-ol">
<li>根据对象的物理内存地址，可以找到相关的页，因此可以在全局mem<sub>map数组中找到对应的page</sub>
实例</li>
<li>slab缓存中的页面而言，page结构中的链表是没有用到的，所以可以复用它来完成该任务：
page-&gt;lru.next 指向页驻留的缓存的管理结构
page-&gt;lru.prev 指向保存该页的slab的管理结构</li>
</ol>
</div>
</li>
<li><a id="org27575a4"></a>API<br />
<ol class="org-ol">
<li><a id="org14c2884"></a><span class="todo TODO">TODO</span> 初始化（自举）<br /></li>
<li><a id="org887eb90"></a>创建缓存 kmem<sub>cache</sub><sub>create</sub><br />
<div class="outline-text-7" id="text-3-9-2-6-5-2">

<div id="org071d086" class="figure">
<p><img src="reading/2020-11-16_18-46-06_screenshot.png" alt="2020-11-16_18-46-06_screenshot.png" />
</p>
</div>
</div>
</li>
<li><a id="orgf14795c"></a>分配对象<br />
<div class="outline-text-7" id="text-3-9-2-6-5-3">
<p>
<img src="reading/2020-11-16_18-47-50_screenshot.png" alt="2020-11-16_18-47-50_screenshot.png" />
其中，cache<sub>grow代表缓存的增长</sub>：
</p>

<div id="org48b3b01" class="figure">
<p><img src="reading/2020-11-16_18-52-21_screenshot.png" alt="2020-11-16_18-52-21_screenshot.png" />
</p>
</div>
</div>
</li>


<li><a id="org71a8703"></a>释放对象<br />
<div class="outline-text-7" id="text-3-9-2-6-5-4">

<div id="orgb62e22f" class="figure">
<p><img src="reading/2020-11-16_18-53-15_screenshot.png" alt="2020-11-16_18-53-15_screenshot.png" />
</p>
</div>
</div>
</li>

<li><a id="org5d2aaa1"></a>销毁缓存 kmem<sub>cache</sub><sub>destroy</sub><br /></li>
<li><a id="org781a853"></a>通用缓存<br />
<div class="outline-text-7" id="text-3-9-2-6-5-6">
<p>
如果不涉及对象缓存，则必须调用kmalloc和kfree函数,这两个函数相当于用户空间C
标准库malloc和free函数的内核等价物
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#27599;&#27425;&#35843;&#29992;kmalloc&#26102;&#65292;&#20869;&#26680;&#25214;&#21040;&#26368;&#36866;&#21512;&#30340;&#32531;&#23384;&#65292;&#24182;&#20174;&#20013;&#20998;&#37197;&#19968;&#20010;&#23545;&#35937;&#26469;&#28385;&#36275;&#35201;&#27714;</span>
<span style="color: #8D8D84; font-style: italic;">   &#26368;&#21512;&#36866;&#30340;&#24847;&#24605;&#26159;&#65306;&#22914;&#26524;&#27809;&#26377;&#21018;&#21018;&#36866;&#21512;&#22823;&#23567;&#30340;&#32531;&#23384;&#65292;&#21017;&#20998;&#37197;&#31245;&#22823;&#30340;</span><span style="color: #8D8D84;">*/</span>
<span style="color: #6434A3;">void</span> *<span style="color: #006699;">kmalloc</span><span style="color: #707183;">(</span>size, flags<span style="color: #707183;">)</span>;

<span style="color: #6434A3;">void</span> <span style="color: #006699;">kfree</span><span style="color: #707183;">(</span>*ptr<span style="color: #707183;">)</span>;
</pre>
</div>

<p>
kmalloc的基础是一个数组，数组项是cache<sub>sizes结构</sub>，其中是一些分别用于不同内存长度的slab缓存，
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Size description struct for general caches.</span><span style="color: #8D8D84;"> */</span>
<span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">cache_sizes</span> <span style="color: #707183;">{</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#35813;&#25968;&#32452;&#39033;&#36127;&#36131;&#30340;&#20869;&#23384;&#21306;&#30340;&#38271;&#24230;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">size_t</span>      <span style="color: #BA36A5;">cs_size</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">kmem_cache</span> *<span style="color: #BA36A5;">cs_cachep</span>;
<span style="color: #808080;">#ifdef</span> CONFIG_ZONE_DMA
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">kmem_cache</span> *<span style="color: #BA36A5;">cs_dmacachep</span>;
<span style="color: #808080;">#endif</span>
<span style="color: #707183;">}</span>;
</pre>
</div>
</div>
</li>
</ol>
</li>

<li><a id="orgfa4926e"></a><span class="todo TODO">TODO</span> 处理器高速缓存和TLB控制<br /></li>
</ol>
</li>
</ol>
</div>
<div id="outline-container-orgb9765c6" class="outline-4">
<h4 id="orgb9765c6"><span class="section-number-4">3.9.3</span> 进程虚拟内存</h4>
<div class="outline-text-4" id="text-3-9-3">
<p>
每个进程都有虚拟地址空间，它起始于地址0，延伸到TASK<sub>SIZE</sub> - 1，其上是内核地址空间。
用户程序只能访问整个地址空间的下半部分，不能访问内核部分。 <b>如果没有预先达成“协议”</b>,
用户进程也不可能操作另一个进程的地址空间，因为后者的地址空间对前者不可见。
</p>

<p>
虚拟地址空间由许多不同长度的段组成，用于不同的目的，必须分别处理。例如text段是代码段，应该
是只读的；而映射到地址空间的文件内容不能执行其内容，但是可以修改。
</p>
</div>
<ol class="org-ol">
<li><a id="org6adbe29"></a>进程地址空间布局<br />
<div class="outline-text-5" id="text-3-9-3-1">
<p>
虚拟地址空间包含了若干区域，每个体系结构可能不一样，但是一定会有下面这些段：
</p>
<ul class="org-ul">
<li>text段. 当前运行代码的二进制代码。</li>
<li>程序使用的动态库代码</li>
<li>存储全局变量和动态数据的堆</li>
<li>保存局部变量和实现函数/过程调用的栈</li>
<li>环境变量和命令行参数</li>
<li>将文件内容映射到虚拟地址空间的内存映射</li>
</ul>
<p>
<img src="reading/2020-11-16_23-01-21_screenshot.png" alt="2020-11-16_23-01-21_screenshot.png" />
其中，randomized<sub>variable用于使栈的地址偏移一个随机值</sub>，用于防止缓冲区溢出攻击,用户可以通过
/proc/sys/kernel/randomize<sub>va</sub><sub>space停用这个特性</sub>
</p>

<p>
值得一体的是，32位体系结构中可能会有另外一种体系结构：
</p>
<p>
<img src="reading/2020-11-16_23-13-42_screenshot.png" alt="2020-11-16_23-13-42_screenshot.png" />
这种布局的主要好处是mmap是往下涨的，这样可以增多堆空间的大小（mmap的起始地址上，经典布局
堆只有1G空间）；但是这样也有一个缺点就是栈的大小是固定的。
</p>
</div>
</li>

<li><a id="orgb6d91d9"></a>数据结构表示(struct mm<sub>struct</sub>)<br />
<div class="outline-text-5" id="text-3-9-3-2">
<p>
每个进程的task<sub>struct中都有一个mm</sub><sub>struct成员</sub>，它保存了进程的内存管理信息：
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">mm_struct</span> <span style="color: #707183;">{</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#34394;&#25311;&#20869;&#23384;&#21306;&#22495;&#21015;&#34920;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">vm_area_struct</span> * <span style="color: #BA36A5;">mmap</span>;   <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">list of VMAs</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">rb_root</span> <span style="color: #BA36A5;">mm_rb</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#19978;&#19968;&#27425;find_vma&#30340;&#32467;&#26524;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">vm_area_struct</span> * <span style="color: #BA36A5;">mmap_cache</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">last find_vma result</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">get_unmapped_area</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">file</span> *<span style="color: #BA36A5;">filp</span>,
        <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">addr</span>, <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">len</span>,
        <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">pgoff</span>, <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">flags</span><span style="color: #7388D6;">)</span>;
  <span style="color: #6434A3;">void</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">unmap_area</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">mm_struct</span> *<span style="color: #BA36A5;">mm</span>, <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">addr</span><span style="color: #7388D6;">)</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#20869;&#23384;&#26144;&#23556;&#30340;&#36215;&#22987;&#22320;&#22336;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">mmap_base</span>;    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">base of mmap area</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#22320;&#22336;&#31354;&#38388;&#38271;&#24230;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">task_size</span>;    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">size of task vm space</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">cached_hole_size</span>;   <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">if non-zero, the largest hole below free_area_cache</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">free_area_cache</span>;    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">first hole of size cached_hole_size or larger</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">pgd_t</span> * <span style="color: #BA36A5;">pgd</span>;
  <span style="color: #6434A3;">atomic_t</span> <span style="color: #BA36A5;">mm_users</span>;      <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">How many users with user space?</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">atomic_t</span> <span style="color: #BA36A5;">mm_count</span>;      <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">How many references to "struct mm_struct" (users count as 1)</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">map_count</span>;        <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">number of VMAs</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">rw_semaphore</span> <span style="color: #BA36A5;">mmap_sem</span>;
  <span style="color: #6434A3;">spinlock_t</span> <span style="color: #BA36A5;">page_table_lock</span>;   <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Protects page tables and some counters</span><span style="color: #8D8D84;"> */</span>

  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span> <span style="color: #BA36A5;">mmlist</span>;    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">List of maybe swapped mm's.  These are globally strung</span>
<span style="color: #8D8D84; font-style: italic;">             * together off init_mm.mmlist, and are protected</span>
<span style="color: #8D8D84; font-style: italic;">             * by mmlist_lock</span>
<span style="color: #8D8D84;">             */</span>

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Special counters, in some configurations protected by the</span>
<span style="color: #8D8D84; font-style: italic;">   * page_table_lock, in other configurations by being atomic.</span>
<span style="color: #8D8D84;">   */</span>
  <span style="color: #6434A3;">mm_counter_t</span> <span style="color: #BA36A5;">_file_rss</span>;
  <span style="color: #6434A3;">mm_counter_t</span> <span style="color: #BA36A5;">_anon_rss</span>;

  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">hiwater_rss</span>;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">High-watermark of RSS usage</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">hiwater_vm</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">High-water virtual memory usage</span><span style="color: #8D8D84;"> */</span>

  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">total_vm</span>, <span style="color: #BA36A5;">locked_vm</span>, <span style="color: #BA36A5;">shared_vm</span>, <span style="color: #BA36A5;">exec_vm</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">stack_vm</span>, <span style="color: #BA36A5;">reserved_vm</span>, <span style="color: #BA36A5;">def_flags</span>, <span style="color: #BA36A5;">nr_ptes</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#21487;&#25191;&#34892;&#20195;&#30721;&#21644;&#24050;&#21021;&#22987;&#21270;&#25968;&#25454;&#27573;, AMD64&#30340;start_code&#20026;0x400000</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">start_code</span>, <span style="color: #BA36A5;">end_code</span>, <span style="color: #BA36A5;">start_data</span>, <span style="color: #BA36A5;">end_data</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#22534; &#21644; &#26632;</span><span style="color: #8D8D84;">*/</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">start_brk</span>, <span style="color: #BA36A5;">brk</span>, <span style="color: #BA36A5;">start_stack</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">arg_start</span>, <span style="color: #BA36A5;">arg_end</span>, <span style="color: #BA36A5;">env_start</span>, <span style="color: #BA36A5;">env_end</span>;

  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">saved_auxv</span><span style="color: #7388D6;">[</span>AT_VECTOR_SIZE<span style="color: #7388D6;">]</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">for /proc/PID/auxv</span><span style="color: #8D8D84;"> */</span>

  <span style="color: #6434A3;">cpumask_t</span> <span style="color: #BA36A5;">cpu_vm_mask</span>;

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Architecture-specific MM context</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">mm_context_t</span> <span style="color: #BA36A5;">context</span>;

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Swap token stuff</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">   * Last value of global fault stamp as seen by this process.</span>
<span style="color: #8D8D84; font-style: italic;">   * In other words, this value gives an indication of how long</span>
<span style="color: #8D8D84; font-style: italic;">   * it has been since this task got the token.</span>
<span style="color: #8D8D84; font-style: italic;">   * Look at mm/thrash.c</span>
<span style="color: #8D8D84;">   */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">faultstamp</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">token_priority</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">last_interval</span>;

  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">flags</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Must use atomic bitops to access the bits</span><span style="color: #8D8D84;"> */</span>

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">coredumping support</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">core_waiters</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">completion</span> *<span style="color: #BA36A5;">core_startup_done</span>, <span style="color: #BA36A5;">core_done</span>;

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">aio bits</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">rwlock_t</span>    <span style="color: #BA36A5;">ioctx_list_lock</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">kioctx</span>   *<span style="color: #BA36A5;">ioctx_list</span>;
<span style="color: #707183;">}</span>;
</pre>
</div>
</div>
</li>
<li><a id="org6d72b50"></a>虚拟地址空间建立过程(load<sub>elf</sub><sub>binary</sub>)<br />
<div class="outline-text-5" id="text-3-9-3-3">
<p>
exec系统调用使用load<sub>elf</sub><sub>binary来装载一个ELF二进制文件</sub>:
</p>

<div id="orgfabb2b1" class="figure">
<p><img src="reading/2020-11-16_23-05-48_screenshot.png" alt="2020-11-16_23-05-48_screenshot.png" />
</p>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #6434A3;">void</span> <span style="color: #006699;">arch_pick_mmap_layout</span><span style="color: #707183;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">mm_struct</span> *<span style="color: #BA36A5;">mm</span><span style="color: #707183;">)</span>
<span style="color: #707183;">{</span>
<span style="color: #808080;">#ifdef</span> CONFIG_IA32_EMULATION
  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>current_thread_info<span style="color: #909183;">()</span>-&gt;flags &amp; _TIF_IA32<span style="color: #7388D6;">)</span>
    <span style="color: #0000FF;">return</span> ia32_pick_mmap_layout<span style="color: #7388D6;">(</span>mm<span style="color: #7388D6;">)</span>;
<span style="color: #808080;">#endif</span>
  mm-&gt;mmap_base = TASK_UNMAPPED_BASE;
  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>current-&gt;flags &amp; PF_RANDOMIZE<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">{</span>
    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Add 28bit randomness which is about 40bits of address space</span>
<span style="color: #8D8D84; font-style: italic;">       because mmap base has to be page aligned.</span>
<span style="color: #8D8D84; font-style: italic;">       or ~1/128 of the total user VM</span>
<span style="color: #8D8D84; font-style: italic;">       (total user address space is 47bits)</span><span style="color: #8D8D84;"> */</span>
    <span style="color: #6434A3;">unsigned</span> <span style="color: #BA36A5;">rnd</span> = get_random_int<span style="color: #909183;">()</span> &amp; <span style="color: #D0372D;">0xfffffff</span>;
    mm-&gt;mmap_base += <span style="color: #909183;">(</span><span style="color: #709870;">(</span><span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span><span style="color: #709870;">)</span>rnd<span style="color: #909183;">)</span> &lt;&lt; PAGE_SHIFT;
  <span style="color: #7388D6;">}</span>
  mm-&gt;get_unmapped_area = arch_get_unmapped_area;
  mm-&gt;unmap_area = arch_unmap_area;
<span style="color: #707183;">}</span>
</pre>
</div>
</div>
</li>
<li><a id="orgbc821c1"></a>内存映射的原理<br />
<div class="outline-text-5" id="text-3-9-3-4">
<p>
由于虚拟地址空间比物理内存大得多，所以只有最常用的那部分内容才和物理页帧关联。
由于局部性原理，这样做是没有问题的。
</p>

<p>
内核必须提供数据结构来建立虚拟地址空间的区域和相关数据所在位置之间的关联。比如在映射文本文件时，
映射的虚拟内存区必须关联到文件系统在硬盘上存储文件内容的区域。
</p>
<p>
<img src="reading/2020-11-16_23-27-41_screenshot.png" alt="2020-11-16_23-27-41_screenshot.png" />
特别需要提到的是，上图只是简化的图示。因为文件数据在硬盘上的存储通常不是连续的，而是分布到
若干的小区域（块）。所以内核利用address<sub>space数据结构来提供一组方法从后备存储器</sub>(如文件系统)
读取数据。也就是说，address<sub>space形成了一个中间层</sub>，将映射的数据表示为连续的线性区域提供给
内存管理子系统。
</p>

<p>
下图展示了这种机制在缺页异常时的处理过程：
</p>
<p>
<img src="reading/2020-11-16_23-41-23_screenshot.png" alt="2020-11-16_23-41-23_screenshot.png" />
需要理解的是，图中只有少部分虚拟地址空间与物理页关联了，这也证实了上面的说法。
</p>
</div>

<ol class="org-ol">
<li><a id="org421e85b"></a>struct vm<sub>area</sub><sub>struct</sub><br />
<div class="outline-text-6" id="text-3-9-3-4-1">
<p>
每个虚拟内存区域都通过一个vm<sub>area</sub><sub>struct实例来描述</sub>:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;"> * This struct defines a memory VMM memory area. There is one of these</span>
<span style="color: #8D8D84; font-style: italic;"> * per VM-area/task.  A VM area is any part of the process virtual memory</span>
<span style="color: #8D8D84; font-style: italic;"> * space that has a special rule for the page-fault handlers (ie a shared</span>
<span style="color: #8D8D84; font-style: italic;"> * library, the executable area etc).</span>
<span style="color: #8D8D84;"> */</span>
<span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">vm_area_struct</span> <span style="color: #707183;">{</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">mm_struct</span> * <span style="color: #BA36A5;">vm_mm</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">The address space we belong to.</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">vm_start</span>;   <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Our start address within vm_mm.</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">vm_end</span>;   <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">The first byte after our end address</span>
<span style="color: #8D8D84; font-style: italic;">             within vm_mm.</span><span style="color: #8D8D84;"> */</span>

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">linked list of VM areas per task, sorted by address</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">vm_area_struct</span> *<span style="color: #BA36A5;">vm_next</span>;

  <span style="color: #6434A3;">pgprot_t</span> <span style="color: #BA36A5;">vm_page_prot</span>;    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Access permissions of this VMA.</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#19979;&#38754;&#21333;&#29420;&#21015;&#20986;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">vm_flags</span>;   <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Flags, listed below.</span><span style="color: #8D8D84;"> */</span>

  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">rb_node</span> <span style="color: #BA36A5;">vm_rb</span>;

  <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">   * For areas with an address space and backing store,</span>
<span style="color: #8D8D84; font-style: italic;">   * linkage into the address_space-&gt;i_mmap prio tree, or</span>
<span style="color: #8D8D84; font-style: italic;">   * linkage to the list of like vmas hanging off its node, or</span>
<span style="color: #8D8D84; font-style: italic;">   * linkage of vma in the address_space-&gt;i_mmap_nonlinear list.</span>
<span style="color: #8D8D84;">   */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#35814;&#35265;&#19979;&#25991;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">union</span> <span style="color: #7388D6;">{</span>
    <span style="color: #0000FF;">struct</span> <span style="color: #909183;">{</span>
      <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span> <span style="color: #BA36A5;">list</span>;
      <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#19982;prio_tree_node&#32467;&#26500;&#30340;&#26368;&#21518;&#19968;&#20010;&#25104;&#21592;&#26159;&#30456;&#21516;&#30340;,vm_set&#24182;&#19981;&#20351;&#29992;parent,</span>
<span style="color: #8D8D84; font-style: italic;">         &#20869;&#26680;&#21487;&#20197;&#29992;parent != NULL &#26816;&#26597;vm_area_struct&#26159;&#21542;&#24050;&#32463;&#22312; &#26641;&#20013;</span><span style="color: #8D8D84;">*/</span>
      <span style="color: #6434A3;">void</span> *<span style="color: #BA36A5;">parent</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">aligns with prio_tree_node parent</span><span style="color: #8D8D84;"> */</span>
      <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">vm_area_struct</span> *<span style="color: #BA36A5;">head</span>;
    <span style="color: #909183;">}</span> <span style="color: #BA36A5;">vm_set</span>;

    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#20248;&#20808;&#26641;</span><span style="color: #8D8D84;"> */</span>
    <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">raw_prio_tree_node</span> <span style="color: #BA36A5;">prio_tree_node</span>;
  <span style="color: #7388D6;">}</span> <span style="color: #BA36A5;">shared</span>;

  <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">   * A file's MAP_PRIVATE vma can be in both i_mmap tree and anon_vma</span>
<span style="color: #8D8D84; font-style: italic;">   * list, after a COW of one of the file pages.  A MAP_SHARED vma</span>
<span style="color: #8D8D84; font-style: italic;">   * can only be in the i_mmap tree.  An anonymous MAP_PRIVATE, stack</span>
<span style="color: #8D8D84; font-style: italic;">   * or brk vma (with NULL file) can only be in an anon_vma list.</span>
<span style="color: #8D8D84;">   */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#31649;&#29702;&#21311;&#21517;&#26144;&#23556;&#30340;&#20849;&#20139;&#39029;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span> <span style="color: #BA36A5;">anon_vma_node</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Serialized by anon_vma-&gt;lock</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">anon_vma</span> *<span style="color: #BA36A5;">anon_vma</span>;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Serialized by page_table_lock</span><span style="color: #8D8D84;"> */</span>

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Function pointers to deal with this struct.</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#25805;&#20316;&#38598;&#21512;&#65292;&#19979;&#38754;&#20195;&#30721;&#21333;&#29420;&#21015;&#20986;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">vm_operations_struct</span> * <span style="color: #BA36A5;">vm_ops</span>;

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Information about our backing store:</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#25991;&#20214;&#26144;&#23556;&#30340;&#20559;&#31227;&#37327;&#65292;&#29992;&#20110;&#21482;&#26144;&#23556;&#20102;&#25991;&#20214;&#37096;&#20998;&#20869;&#23481;&#26102;,&#22914;&#26524;&#26144;&#23556;&#20102;&#25972;&#20010;&#25991;&#20214;&#65292;&#21017;&#25913;&#20540;&#20026;0,</span>
<span style="color: #8D8D84; font-style: italic;">     &#20559;&#31227;&#37327;&#30340;&#21333;&#20301;&#26159;&#39029;&#32780;&#19981;&#26159;&#23383;&#33410;&#65292;&#22240;&#20026;&#20869;&#26680;&#21482;&#25903;&#25345;&#20197;&#25972;&#39029;&#20026;&#21333;&#20301;&#30340;&#26144;&#23556;</span><span style="color: #8D8D84;">*/</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">vm_pgoff</span>;   <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Offset (within vm_file) in PAGE_SIZE</span>
<span style="color: #8D8D84; font-style: italic;">             units, *not* PAGE_CACHE_SIZE</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#34987;&#26144;&#23556;&#30340;&#25991;&#20214;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">file</span> * <span style="color: #BA36A5;">vm_file</span>;    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">File we map to (can be NULL).</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#23569;&#25968;&#22768;&#38899;&#21644;&#35270;&#39057;&#39537;&#21160;&#20351;&#29992;&#20102;&#35813;&#36873;&#39033;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">void</span> * <span style="color: #BA36A5;">vm_private_data</span>;   <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">was vm_pte (shared mem)</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">vm_truncate_count</span>;<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">truncate_count or restart_addr</span><span style="color: #8D8D84;"> */</span>

<span style="color: #808080;">#if</span><span style="color: #808080;">n</span><span style="color: #808080;">def</span> CONFIG_MMU
  <span style="color: #6434A3;">atomic_t</span> <span style="color: #BA36A5;">vm_usage</span>;    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">refcount (VMAs shared if !MMU)</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#endif</span>
<span style="color: #808080;">#ifdef</span> CONFIG_NUMA
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">mempolicy</span> *<span style="color: #BA36A5;">vm_policy</span>;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">NUMA policy for the VMA</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#endif</span>
<span style="color: #707183;">}</span>;

<span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;"> * vm_flags..</span>
<span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">VM_READ</span>   <span style="color: #D0372D;">0x00000001</span>  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">currently active flags</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">VM_WRITE</span>  <span style="color: #D0372D;">0x00000002</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">VM_EXEC</span>   <span style="color: #D0372D;">0x00000004</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">VM_SHARED</span> <span style="color: #D0372D;">0x00000008</span>

<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">mprotect() hardcodes VM_MAYREAD &gt;&gt; 4 == VM_READ, and so for r/w/x bits.</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">VM_MAYREAD</span>  <span style="color: #D0372D;">0x00000010</span>  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">limits for mprotect() etc</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">VM_MAYWRITE</span> <span style="color: #D0372D;">0x00000020</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">VM_MAYEXEC</span>  <span style="color: #D0372D;">0x00000040</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">VM_MAYSHARE</span> <span style="color: #D0372D;">0x00000080</span>

<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">VM_GROWSDOWN</span>  <span style="color: #D0372D;">0x00000100</span>  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">general info on the segment</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">VM_GROWSUP</span>  <span style="color: #D0372D;">0x00000200</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">VM_PFNMAP</span> <span style="color: #D0372D;">0x00000400</span>  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Page-ranges managed without "struct page", just pure PFN</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">VM_DENYWRITE</span>  <span style="color: #D0372D;">0x00000800</span>  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">ETXTBSY on write attempts..</span><span style="color: #8D8D84;"> */</span>

<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">VM_EXECUTABLE</span> <span style="color: #D0372D;">0x00001000</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">VM_LOCKED</span> <span style="color: #D0372D;">0x00002000</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">VM_IO</span>           <span style="color: #D0372D;">0x00004000</span>  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Memory mapped I/O or similar</span><span style="color: #8D8D84;"> */</span>

          <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Used by sys_madvise()</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">VM_SEQ_READ</span> <span style="color: #D0372D;">0x00008000</span>  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">App will access data sequentially</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">VM_RAND_READ</span>  <span style="color: #D0372D;">0x00010000</span>  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">App will not benefit from clustered reads</span><span style="color: #8D8D84;"> */</span>

<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">VM_DONTCOPY</span> <span style="color: #D0372D;">0x00020000</span>      <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Do not copy this vma on fork</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">VM_DONTEXPAND</span> <span style="color: #D0372D;">0x00040000</span>  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Cannot expand with mremap()</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">VM_RESERVED</span> <span style="color: #D0372D;">0x00080000</span>  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Count as reserved_vm like IO</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">VM_ACCOUNT</span>  <span style="color: #D0372D;">0x00100000</span>  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Is a VM accounted object</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">VM_HUGETLB</span>  <span style="color: #D0372D;">0x00400000</span>  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Huge TLB Page VM</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">VM_NONLINEAR</span>  <span style="color: #D0372D;">0x00800000</span>  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Is non-linear (remap_file_pages)</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">VM_MAPPED_COPY</span>  <span style="color: #D0372D;">0x01000000</span>  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">T if mapped copy of data (nommu mmap)</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">VM_INSERTPAGE</span> <span style="color: #D0372D;">0x02000000</span>  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">The vma has had "vm_insert_page()" done on it</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">VM_ALWAYSDUMP</span> <span style="color: #D0372D;">0x04000000</span>  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Always include in core dumps</span><span style="color: #8D8D84;"> */</span>

<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">VM_CAN_NONLINEAR</span> <span style="color: #D0372D;">0x08000000</span> <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Has -&gt;fault &amp; does nonlinear pages</span><span style="color: #8D8D84;"> */</span>

<span style="color: #808080;">#if</span><span style="color: #808080;">n</span><span style="color: #808080;">def</span> VM_STACK_DEFAULT_FLAGS    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">arch can override this</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">VM_STACK_DEFAULT_FLAGS</span> VM_DATA_DEFAULT_FLAGS
<span style="color: #808080;">#endif</span>

<span style="color: #808080;">#ifdef</span> CONFIG_STACK_GROWSUP
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">VM_STACK_FLAGS</span>  <span style="color: #707183;">(</span>VM_GROWSUP | VM_STACK_DEFAULT_FLAGS | VM_ACCOUNT<span style="color: #707183;">)</span>
<span style="color: #808080;">#else</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">VM_STACK_FLAGS</span>  <span style="color: #707183;">(</span>VM_GROWSDOWN | VM_STACK_DEFAULT_FLAGS | VM_ACCOUNT<span style="color: #707183;">)</span>
<span style="color: #808080;">#endif</span>

<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">VM_READHINTMASK</span>     <span style="color: #707183;">(</span>VM_SEQ_READ | VM_RAND_READ<span style="color: #707183;">)</span>
<span style="color: #808080;">#define</span> <span style="color: #006699;">VM_ClearReadHint</span><span style="color: #707183;">(</span><span style="color: #BA36A5;">v</span><span style="color: #707183;">)</span>   <span style="color: #707183;">(</span>v<span style="color: #707183;">)</span>-&gt;vm_flags &amp;= ~VM_READHINTMASK
<span style="color: #808080;">#define</span> <span style="color: #006699;">VM_NormalReadHint</span><span style="color: #707183;">(</span><span style="color: #BA36A5;">v</span><span style="color: #707183;">)</span>    <span style="color: #707183;">(</span>!<span style="color: #7388D6;">(</span><span style="color: #909183;">(</span>v<span style="color: #909183;">)</span>-&gt;vm_flags &amp; VM_READHINTMASK<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #808080;">#define</span> <span style="color: #006699;">VM_SequentialReadHint</span><span style="color: #707183;">(</span><span style="color: #BA36A5;">v</span><span style="color: #707183;">)</span>  <span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>v<span style="color: #7388D6;">)</span>-&gt;vm_flags &amp; VM_SEQ_READ<span style="color: #707183;">)</span>
<span style="color: #808080;">#define</span> <span style="color: #006699;">VM_RandomReadHint</span><span style="color: #707183;">(</span><span style="color: #BA36A5;">v</span><span style="color: #707183;">)</span>    <span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>v<span style="color: #7388D6;">)</span>-&gt;vm_flags &amp; VM_RAND_READ<span style="color: #707183;">)</span>


<span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;"> * These are the virtual MM functions - opening of an area, closing and</span>
<span style="color: #8D8D84; font-style: italic;"> * unmapping it (needed to keep files on disk up-to-date etc), pointer</span>
<span style="color: #8D8D84; font-style: italic;"> * to the functions called when a no-page or a wp-page exception occurs. </span>
<span style="color: #8D8D84;"> */</span>
<span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">vm_operations_struct</span> <span style="color: #707183;">{</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#21019;&#24314;&#21644;&#21024;&#38500;&#21306;&#22495;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">void</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">open</span><span style="color: #7388D6;">)(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">vm_area_struct</span> * <span style="color: #BA36A5;">area</span><span style="color: #7388D6;">)</span>;
  <span style="color: #6434A3;">void</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">close</span><span style="color: #7388D6;">)(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">vm_area_struct</span> * <span style="color: #BA36A5;">area</span><span style="color: #7388D6;">)</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#32570;&#39029;&#22788;&#29702;&#20989;&#25968;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">int</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">fault</span><span style="color: #7388D6;">)(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">vm_area_struct</span> *<span style="color: #BA36A5;">vma</span>, <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">vm_fault</span> *<span style="color: #BA36A5;">vmf</span><span style="color: #7388D6;">)</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#32769;&#30340;&#32570;&#39029;&#22788;&#29702;&#20989;&#25968;&#65292;&#26032;&#20195;&#30721;&#19981;&#24212;&#35813;&#29992;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">page</span> *<span style="color: #7388D6;">(</span>*<span style="color: #006699;">nopage</span><span style="color: #7388D6;">)(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">vm_area_struct</span> *<span style="color: #BA36A5;">area</span>,
      <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">address</span>, <span style="color: #6434A3;">int</span> *<span style="color: #BA36A5;">type</span><span style="color: #7388D6;">)</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">nopfn</span><span style="color: #7388D6;">)(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">vm_area_struct</span> *<span style="color: #BA36A5;">area</span>,
      <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">address</span><span style="color: #7388D6;">)</span>;

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">notification that a previously read-only page is about to become</span>
<span style="color: #8D8D84; font-style: italic;">   * writable, if an error is returned it will cause a SIGBUS</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">int</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">page_mkwrite</span><span style="color: #7388D6;">)(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">vm_area_struct</span> *<span style="color: #BA36A5;">vma</span>, <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">page</span> *<span style="color: #BA36A5;">page</span><span style="color: #7388D6;">)</span>;
<span style="color: #808080;">#ifdef</span> CONFIG_NUMA
  <span style="color: #6434A3;">int</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">set_policy</span><span style="color: #7388D6;">)(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">vm_area_struct</span> *<span style="color: #BA36A5;">vma</span>, <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">mempolicy</span> *<span style="color: #BA36A5;">new</span><span style="color: #7388D6;">)</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">mempolicy</span> *<span style="color: #7388D6;">(</span>*<span style="color: #006699;">get_policy</span><span style="color: #7388D6;">)(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">vm_area_struct</span> *<span style="color: #BA36A5;">vma</span>,
          <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">addr</span><span style="color: #7388D6;">)</span>;
  <span style="color: #6434A3;">int</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">migrate</span><span style="color: #7388D6;">)(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">vm_area_struct</span> *<span style="color: #BA36A5;">vma</span>, <span style="color: #0000FF;">const</span> <span style="color: #6434A3;">nodemask_t</span> *<span style="color: #BA36A5;">from</span>,
    <span style="color: #0000FF;">const</span> <span style="color: #6434A3;">nodemask_t</span> *<span style="color: #BA36A5;">to</span>, <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">flags</span><span style="color: #7388D6;">)</span>;
<span style="color: #808080;">#endif</span>
<span style="color: #707183;">}</span>;
</pre>
</div>

<p>
进程的各个区域按两种方法排序：
</p>
<ol class="org-ol">
<li>在一个单链表上（mm<sub>struct</sub>-&gt;mmap)</li>
<li>在红黑树中，根结点位于mm<sub>rb</sub></li>
</ol>

<div id="org76e7683" class="figure">
<p><img src="reading/2020-11-17_09-47-16_screenshot.png" alt="2020-11-17_09-47-16_screenshot.png" />
</p>
</div>
</div>
<ol class="org-ol">
<li><a id="orgb5f09d8"></a>对区域的操作<br />
<div class="outline-text-7" id="text-3-9-3-4-1-1">
<p>
内核提供了各种函数来操作进程的虚拟内存区域：
</p>

<div id="org520ac88" class="figure">
<p><img src="reading/2020-11-17_14-56-29_screenshot.png" alt="2020-11-17_14-56-29_screenshot.png" />
</p>
</div>

<div id="org2b41489" class="figure">
<p><img src="reading/2020-11-17_14-57-01_screenshot.png" alt="2020-11-17_14-57-01_screenshot.png" />
</p>
</div>
</div>
</li>
</ol>
</li>

<li><a id="org0f872d3"></a>地址空间(address<sub>apace</sub>)<br />
<div class="outline-text-6" id="text-3-9-3-4-2">
<p>
文件的内存映射可以认为是两个不同的地址空间之间的映射，一个是用户进程的虚拟地址空间，
另一个是文件系统所在的地址空间。
</p>

<p>
在内核创建一个映射时，必须建立两个地址空间之间的关联，以支持二者以读写请求的形式通信。
所以内核通过address<sub>space结构来充当这两者通信的桥梁</sub>。事实上，每个文件映射都有一个
相关的address<sub>space实例</sub>。而且每个实例都有一组相关的操作：
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">address_space</span> <span style="color: #707183;">{</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">inode</span>    *<span style="color: #BA36A5;">host</span>;    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">owner: inode, block_device</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">radix_tree_root</span>  <span style="color: #BA36A5;">page_tree</span>;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">radix tree of all pages</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">rwlock_t</span>    <span style="color: #BA36A5;">tree_lock</span>;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">and rwlock protecting it</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span>    <span style="color: #BA36A5;">i_mmap_writable</span>;<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">count VM_SHARED mappings</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">prio_tree_root</span> <span style="color: #BA36A5;">i_mmap</span>;   <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">tree of private and shared mappings</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span>  <span style="color: #BA36A5;">i_mmap_nonlinear</span>;<span style="color: #8D8D84;">/*</span><span style="color: #8D8D84; font-style: italic;">list VM_NONLINEAR mappings</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">spinlock_t</span>    <span style="color: #BA36A5;">i_mmap_lock</span>;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">protect tree, count, list</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span>    <span style="color: #BA36A5;">truncate_count</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Cover race condition with truncate</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span>   <span style="color: #BA36A5;">nrpages</span>;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">number of total pages</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">pgoff_t</span>     <span style="color: #BA36A5;">writeback_index</span>;<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">writeback starts here</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">const</span> <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">address_space_operations</span> *<span style="color: #BA36A5;">a_ops</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">methods</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span>   <span style="color: #BA36A5;">flags</span>;    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">error bits/gfp mask</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">backing_dev_info</span> *<span style="color: #BA36A5;">backing_dev_info</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">device readahead, etc</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">spinlock_t</span>    <span style="color: #BA36A5;">private_lock</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">for use by the address_space</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span>  <span style="color: #BA36A5;">private_list</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">ditto</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">address_space</span>  *<span style="color: #BA36A5;">assoc_mapping</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">ditto</span><span style="color: #8D8D84;"> */</span>
<span style="color: #707183;">}</span> <span style="color: #0000FF;">__attribute__</span><span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>aligned<span style="color: #909183;">(</span><span style="color: #0000FF;">sizeof</span><span style="color: #709870;">(</span><span style="color: #6434A3;">long</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>;

<span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">address_space_operations</span> <span style="color: #707183;">{</span>
  <span style="color: #6434A3;">int</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">writepage</span><span style="color: #7388D6;">)(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">page</span> *<span style="color: #BA36A5;">page</span>, <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">writeback_control</span> *<span style="color: #BA36A5;">wbc</span><span style="color: #7388D6;">)</span>;
  <span style="color: #6434A3;">int</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">readpage</span><span style="color: #7388D6;">)(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">file</span> *, <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">page</span> *<span style="color: #7388D6;">)</span>;
  <span style="color: #6434A3;">void</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">sync_page</span><span style="color: #7388D6;">)(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">page</span> *<span style="color: #7388D6;">)</span>;

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Write back some dirty pages from this mapping.</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">int</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">writepages</span><span style="color: #7388D6;">)(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">address_space</span> *, <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">writeback_control</span> *<span style="color: #7388D6;">)</span>;

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Set a page dirty.  Return true if this dirtied it</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">int</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">set_page_dirty</span><span style="color: #7388D6;">)(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">page</span> *<span style="color: #BA36A5;">page</span><span style="color: #7388D6;">)</span>;

  <span style="color: #6434A3;">int</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">readpages</span><span style="color: #7388D6;">)(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">file</span> *<span style="color: #BA36A5;">filp</span>, <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">address_space</span> *<span style="color: #BA36A5;">mapping</span>,
      <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span> *<span style="color: #BA36A5;">pages</span>, <span style="color: #6434A3;">unsigned</span> <span style="color: #BA36A5;">nr_pages</span><span style="color: #7388D6;">)</span>;

  <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">   * ext3 requires that a successful prepare_write() call be followed</span>
<span style="color: #8D8D84; font-style: italic;">   * by a commit_write() call - they must be balanced</span>
<span style="color: #8D8D84;">   */</span>
  <span style="color: #6434A3;">int</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">prepare_write</span><span style="color: #7388D6;">)(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">file</span> *, <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">page</span> *, <span style="color: #6434A3;">unsigned</span>, <span style="color: #6434A3;">unsigned</span><span style="color: #7388D6;">)</span>;
  <span style="color: #6434A3;">int</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">commit_write</span><span style="color: #7388D6;">)(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">file</span> *, <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">page</span> *, <span style="color: #6434A3;">unsigned</span>, <span style="color: #6434A3;">unsigned</span><span style="color: #7388D6;">)</span>;

  <span style="color: #6434A3;">int</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">write_begin</span><span style="color: #7388D6;">)(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">file</span> *, <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">address_space</span> *<span style="color: #BA36A5;">mapping</span>,
        <span style="color: #6434A3;">loff_t</span> <span style="color: #BA36A5;">pos</span>, <span style="color: #6434A3;">unsigned</span> <span style="color: #BA36A5;">len</span>, <span style="color: #6434A3;">unsigned</span> <span style="color: #BA36A5;">flags</span>,
        <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">page</span> **<span style="color: #BA36A5;">pagep</span>, <span style="color: #6434A3;">void</span> **<span style="color: #BA36A5;">fsdata</span><span style="color: #7388D6;">)</span>;
  <span style="color: #6434A3;">int</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">write_end</span><span style="color: #7388D6;">)(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">file</span> *, <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">address_space</span> *<span style="color: #BA36A5;">mapping</span>,
        <span style="color: #6434A3;">loff_t</span> <span style="color: #BA36A5;">pos</span>, <span style="color: #6434A3;">unsigned</span> <span style="color: #BA36A5;">len</span>, <span style="color: #6434A3;">unsigned</span> <span style="color: #BA36A5;">copied</span>,
        <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">page</span> *<span style="color: #BA36A5;">page</span>, <span style="color: #6434A3;">void</span> *<span style="color: #BA36A5;">fsdata</span><span style="color: #7388D6;">)</span>;

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Unfortunately this kludge is needed for FIBMAP. Don't use it</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">sector_t</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">bmap</span><span style="color: #7388D6;">)(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">address_space</span> *, <span style="color: #6434A3;">sector_t</span><span style="color: #7388D6;">)</span>;
  <span style="color: #6434A3;">void</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">invalidatepage</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">page</span> *, <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span><span style="color: #7388D6;">)</span>;
  <span style="color: #6434A3;">int</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">releasepage</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">page</span> *, <span style="color: #6434A3;">gfp_t</span><span style="color: #7388D6;">)</span>;
  <span style="color: #6434A3;">ssize_t</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">direct_IO</span><span style="color: #7388D6;">)(</span><span style="color: #6434A3;">int</span>, <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">kiocb</span> *, <span style="color: #0000FF;">const</span> <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">iovec</span> *<span style="color: #BA36A5;">iov</span>,
      <span style="color: #6434A3;">loff_t</span> <span style="color: #BA36A5;">offset</span>, <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">nr_segs</span><span style="color: #7388D6;">)</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">page</span>* <span style="color: #7388D6;">(</span>*<span style="color: #006699;">get_xip_page</span><span style="color: #7388D6;">)(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">address_space</span> *, <span style="color: #6434A3;">sector_t</span>,
      <span style="color: #6434A3;">int</span><span style="color: #7388D6;">)</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">migrate the contents of a page to the specified target</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">int</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">migratepage</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">address_space</span> *,
      <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">page</span> *, <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">page</span> *<span style="color: #7388D6;">)</span>;
  <span style="color: #6434A3;">int</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">launder_page</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">page</span> *<span style="color: #7388D6;">)</span>;
<span style="color: #707183;">}</span>;
</pre>
</div>
</div>
</li>
<li><a id="org767d9ba"></a>优先查找树<br />
<div class="outline-text-6" id="text-3-9-3-4-3">
<p>
优先查找树用于建立文件中的一个区域与该区域映射到的所有虚拟地址空间之间的关联。
每个文件(和块设备，因为块设备也可以通过设备文件进行内存映射)都表示为一个struct file,
该结构包括一个指向地址空间对象struct address<sub>space的指针</sub>, 该结构是优先查找树的基础:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">file</span><span style="color: #707183;">{</span>
  ...
  <span style="color: #0000FF;">struct</span> address_space *f_mapping;
  ...
<span style="color: #707183;">}</span>

<span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">address_space</span> <span style="color: #707183;">{</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">inode</span>    *<span style="color: #BA36A5;">host</span>;    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">owner: inode, block_device</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">radix_tree_root</span>  <span style="color: #BA36A5;">page_tree</span>;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">radix tree of all pages</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">rwlock_t</span>    <span style="color: #BA36A5;">tree_lock</span>;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">and rwlock protecting it</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span>    <span style="color: #BA36A5;">i_mmap_writable</span>;<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">count VM_SHARED mappings</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">prio_tree_root</span> <span style="color: #BA36A5;">i_mmap</span>;   <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">tree of private and shared mappings</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span>  <span style="color: #BA36A5;">i_mmap_nonlinear</span>;<span style="color: #8D8D84;">/*</span><span style="color: #8D8D84; font-style: italic;">list VM_NONLINEAR mappings</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">spinlock_t</span>    <span style="color: #BA36A5;">i_mmap_lock</span>;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">protect tree, count, list</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span>    <span style="color: #BA36A5;">truncate_count</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Cover race condition with truncate</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span>   <span style="color: #BA36A5;">nrpages</span>;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">number of total pages</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">pgoff_t</span>     <span style="color: #BA36A5;">writeback_index</span>;<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">writeback starts here</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">const</span> <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">address_space_operations</span> *<span style="color: #BA36A5;">a_ops</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">methods</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span>   <span style="color: #BA36A5;">flags</span>;    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">error bits/gfp mask</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">backing_dev_info</span> *<span style="color: #BA36A5;">backing_dev_info</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">device readahead, etc</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">spinlock_t</span>    <span style="color: #BA36A5;">private_lock</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">for use by the address_space</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span>  <span style="color: #BA36A5;">private_list</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">ditto</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">address_space</span>  *<span style="color: #BA36A5;">assoc_mapping</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">ditto</span><span style="color: #8D8D84;"> */</span>
<span style="color: #707183;">}</span> <span style="color: #0000FF;">__attribute__</span><span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>aligned<span style="color: #909183;">(</span><span style="color: #0000FF;">sizeof</span><span style="color: #709870;">(</span><span style="color: #6434A3;">long</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>;
</pre>
</div>
<p>
struct file是open系统调用打开的文件的抽象，而在文件系统中，文件被表示为struct inode：
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">inode</span> <span style="color: #707183;">{</span>
  ...
  <span style="color: #0000FF;">struct</span> address_apace *i_mapping;
  ...
<span style="color: #707183;">}</span>
</pre>
</div>
<p>
在打开文件时，内核通过address<sub>space将file</sub>-&gt;f<sub>mapping设置到inode</sub>-&gt;i<sub>mapping把每个进程</sub>
的文件抽象与文件系统的文件表示联系起来:
</p>

<div id="orge7af811" class="figure">
<p><img src="reading/2020-11-17_10-57-31_screenshot.png" alt="2020-11-17_10-57-31_screenshot.png" />
</p>
</div>

<p>
优先查找树是通过vm<sub>area</sub><sub>struct中的shared联合体实现的</sub>：
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #0000FF;">union</span> <span style="color: #707183;">{</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #7388D6;">{</span>
    <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span> <span style="color: #BA36A5;">list</span>;
    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#19982;prio_tree_node&#32467;&#26500;&#30340;&#26368;&#21518;&#19968;&#20010;&#25104;&#21592;&#26159;&#30456;&#21516;&#30340;,vm_set&#24182;&#19981;&#20351;&#29992;parent,</span>
<span style="color: #8D8D84; font-style: italic;">       &#20869;&#26680;&#21487;&#20197;&#29992;parent != NULL &#26816;&#26597;vm_area_struct&#26159;&#21542;&#24050;&#32463;&#22312; &#26641;&#20013;</span><span style="color: #8D8D84;">*/</span>
    <span style="color: #6434A3;">void</span> *<span style="color: #BA36A5;">parent</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">aligns with prio_tree_node parent</span><span style="color: #8D8D84;"> */</span>
    <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">vm_area_struct</span> *<span style="color: #BA36A5;">head</span>;
  <span style="color: #7388D6;">}</span> <span style="color: #BA36A5;">vm_set</span>;

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#20248;&#20808;&#26641;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">raw_prio_tree_node</span> <span style="color: #BA36A5;">prio_tree_node</span>;
<span style="color: #707183;">}</span> <span style="color: #BA36A5;">shared</span>;

</pre>
</div>
<p>
这种结构即能够处理重合的区间：
</p>
<p>
<img src="reading/2020-11-17_14-20-33_screenshot.png" alt="2020-11-17_14-20-33_screenshot.png" />
还能处理相同的文件区间：
</p>
<p>
<img src="reading/2020-11-17_14-41-03_screenshot.png" alt="2020-11-17_14-41-03_screenshot.png" />
上图表示的是许多进程映射到 <b>相同区间</b> 的情况下，这些进程的相关区间的vm<sub>area</sub><sub>struct</sub>
通过vm<sub>set中的链表联系在一起</sub>。其中，union shared可以同时用它的两个成员prio<sub>tree</sub><sub>node</sub>
和vm<sub>set</sub>. 也就是说，一个prio<sub>tree</sub><sub>node代表的区间可能有多个vm</sub><sub>set组成一个链表</sub> 
</p>
</div>
</li>

<li><a id="org8116dfc"></a>内存映射相关系统调用<br />
<div class="outline-text-6" id="text-3-9-3-4-4">
<ul class="org-ul">
<li><p>
mmap
如我们熟悉的，C标准库提供了mmap函数建立映射，内核也提供了两个系统调用mmap和mmap2：
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #808080;">#include</span> <span style="color: #707183;">&lt;</span><span style="color: #008000;">sys/mman.h</span><span style="color: #707183;">&gt;</span>

<span style="color: #6434A3;">void</span> *
<span style="color: #006699;">mmap</span><span style="color: #707183;">(</span><span style="color: #6434A3;">void</span> *<span style="color: #BA36A5;">addr</span>, <span style="color: #6434A3;">size_t</span> <span style="color: #BA36A5;">len</span>, <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">prot</span>, <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">flags</span>, <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">fd</span>, <span style="color: #6434A3;">off_t</span> <span style="color: #BA36A5;">offset</span><span style="color: #707183;">)</span>;
</pre>
</div>
<p>
上面是标准库mmap的接口，两个系统调用的接口也差不多。
这些调用都会在用户虚拟地址空间中的addr位置建立长度为len的映射，prot指定了其访问权限，
相关文件由文件描述符fd来标识, offset表示文件的开始位置。
mmap最终会委托给do<sub>mmap</sub><sub>pgoff函数其调用流程为</sub>:
</p>

<div id="org9ac10f7" class="figure">
<p><img src="reading/2020-11-17_15-58-34_screenshot.png" alt="2020-11-17_15-58-34_screenshot.png" />
</p>
</div></li>
<li><p>
munmap
从虚拟地址空间删除现存映射，必须使用munmap系统调用，sys<sub>munmap是系统调用的入口</sub>，
它会将工作委托给do<sub>munmap函数</sub>:
</p>

<div id="org692c44c" class="figure">
<p><img src="reading/2020-11-17_16-01-30_screenshot.png" alt="2020-11-17_16-01-30_screenshot.png" />
</p>
</div></li>
<li><p>
非线性映射
如果需要将文件的不同部分以不同的顺序映射到虚拟内存的连续区域中，通常必须使用几个映射，
这种代价是非常高的(需要多个vm<sub>area</sub><sub>struct</sub>),非线性映射解决了这个问题：
</p>
<div class="org-src-container">
<pre class="src src-c">asmlinkage <span style="color: #6434A3;">long</span> <span style="color: #006699;">sys_remap_file_pages</span><span style="color: #707183;">(</span><span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">start</span>, <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">size</span>,
                                     <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">prot</span>, <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">pgoff</span>, <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">flags</span><span style="color: #707183;">)</span>
<span style="color: #707183;">{</span>
</pre>
</div>
<p>
该系统调用通过操作进程的页表来实现重排映射中的页，使的内存与文件中的顺序不再等价。
其代码流程为：
</p>

<div id="org89ef0ac" class="figure">
<p><img src="reading/2020-11-17_16-07-22_screenshot.png" alt="2020-11-17_16-07-22_screenshot.png" />
</p>
</div></li>
<li>反向映射
内核利用之前讨论的数据结构，可以建立虚拟地址和物理地址之间的联系（通过页表）；
也可以建立进程的内存区域与其虚拟内存页地址之间的关联(通过vm<sub>area</sub><sub>struct中的vm</sub><sub>start</sub>);
仍然缺失的一个联系是：一个物理页与所有使用该页的进程的对应页表项之间的联系，这种联系也
叫反向映射,该机制主要通过struct page结构体中的两个成员来实现：
对于匿名页来说，主要通过page-&gt;mapping指向vm<sub>area</sub><sub>struct的anno</sub><sub>vma来完成</sub>
对于文件映射的页来说，通过page-&gt;<sub>mapcount就可以完成</sub>，因为struct address<sub>space</sub>
中的immap保存了映射该页的所有vm<sub>area</sub><sub>struct</sub>。</li>
</ul>
</div>
</li>

<li><a id="orgc2e4c60"></a>堆的管理<br />
<div class="outline-text-6" id="text-3-9-3-4-5">
<p>
堆是进程中用于动态分配变量和数据的内存区域，前面提到的mm<sub>struct结构</sub>，包含了堆在虚拟地址
空间中的起始和当前结束地址(start<sub>brk和brk</sub>)molloc和内核之间的经典接口是brk系统调用，负责
扩展/收缩堆。的malloc的实现都使用brk和匿名映射的组合。该方法提供了更好的性能，而且在分配
较大的内存区时具有某些优点。
</p>

<p>
brk系统调用：
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #808080;">#include</span> <span style="color: #707183;">&lt;</span><span style="color: #008000;">unistd.h</span><span style="color: #707183;">&gt;</span>

<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">addr&#34920;&#31034;&#22534;&#22312;&#22320;&#22336;&#31354;&#38388;&#20013;&#26032;&#30340;&#32467;&#26463;&#22320;&#22336;</span><span style="color: #8D8D84;"> */</span>
<span style="color: #6434A3;">void</span> *
<span style="color: #006699;">brk</span><span style="color: #707183;">(</span><span style="color: #0000FF;">const</span> <span style="color: #6434A3;">void</span> *<span style="color: #BA36A5;">addr</span><span style="color: #707183;">)</span>;
</pre>
</div>
<p>
brk系统调用并不是内核独立的概念，而是基于匿名映射实现的，以减少内部的开销。brk系统调用
实现的入口是sys<sub>brk函数</sub>：
</p>

<div id="orga5f673f" class="figure">
<p><img src="reading/2020-11-17_17-48-14_screenshot.png" alt="2020-11-17_17-48-14_screenshot.png" />
</p>
</div>
</div>
</li>
</ol>
</li>

<li><a id="orgf93893d"></a><span class="todo TODO">TODO</span> 缺页异常处理<br />
<div class="outline-text-5" id="text-3-9-3-5">
<p>
处理器在产生缺页异常时会自动把错误地址存在cr2寄存器中，可以用readcr2来获取
</p>

<p>
处理代码流程的粗略概观：
</p>
<p>
<img src="reading/2020-11-17_18-29-08_screenshot.png" alt="2020-11-17_18-29-08_screenshot.png" />
其代码主要为do<sub>page</sub><sub>fault</sub>:
</p>
<p>
<img src="reading/2020-11-17_18-30-28_screenshot.png" alt="2020-11-17_18-30-28_screenshot.png" />
其中handle<sub>mm</sub><sub>fault会把任务委托给handle</sub><sub>pte</sub><sub>fault函数</sub>，后者分析缺页异常的原因:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6434A3;">int</span> <span style="color: #006699;">handle_mm_fault</span><span style="color: #707183;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">mm_struct</span> *<span style="color: #BA36A5;">mm</span>, <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">vm_area_struct</span> *<span style="color: #BA36A5;">vma</span>,
                    <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">address</span>, <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">write_access</span><span style="color: #707183;">)</span>
<span style="color: #707183;">{</span>
  <span style="color: #6434A3;">pgd_t</span> *<span style="color: #BA36A5;">pgd</span>;
  <span style="color: #6434A3;">pud_t</span> *<span style="color: #BA36A5;">pud</span>;
  <span style="color: #6434A3;">pmd_t</span> *<span style="color: #BA36A5;">pmd</span>;
  <span style="color: #6434A3;">pte_t</span> *<span style="color: #BA36A5;">pte</span>;

  __set_current_state<span style="color: #7388D6;">(</span>TASK_RUNNING<span style="color: #7388D6;">)</span>;

  count_vm_event<span style="color: #7388D6;">(</span>PGFAULT<span style="color: #7388D6;">)</span>;

  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>unlikely<span style="color: #909183;">(</span>is_vm_hugetlb_page<span style="color: #709870;">(</span>vma<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
    <span style="color: #0000FF;">return</span> hugetlb_fault<span style="color: #7388D6;">(</span>mm, vma, address, write_access<span style="color: #7388D6;">)</span>;

  pgd = pgd_offset<span style="color: #7388D6;">(</span>mm, address<span style="color: #7388D6;">)</span>;
  pud = pud_alloc<span style="color: #7388D6;">(</span>mm, pgd, address<span style="color: #7388D6;">)</span>;
  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>!pud<span style="color: #7388D6;">)</span>
    <span style="color: #0000FF;">return</span> VM_FAULT_OOM;
  pmd = pmd_alloc<span style="color: #7388D6;">(</span>mm, pud, address<span style="color: #7388D6;">)</span>;
  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>!pmd<span style="color: #7388D6;">)</span>
    <span style="color: #0000FF;">return</span> VM_FAULT_OOM;
  pte = pte_alloc_map<span style="color: #7388D6;">(</span>mm, pmd, address<span style="color: #7388D6;">)</span>;
  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>!pte<span style="color: #7388D6;">)</span>
    <span style="color: #0000FF;">return</span> VM_FAULT_OOM;

  <span style="color: #0000FF;">return</span> handle_pte_fault<span style="color: #7388D6;">(</span>mm, vma, address, pte, pmd, write_access<span style="color: #7388D6;">)</span>;
<span style="color: #707183;">}</span>

<span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;"> * These routines also need to handle stuff like marking pages dirty</span>
<span style="color: #8D8D84; font-style: italic;"> * and/or accessed for architectures that don't do it in hardware (most</span>
<span style="color: #8D8D84; font-style: italic;"> * RISC architectures).  The early dirtying is also good on the i386.</span>
<span style="color: #8D8D84; font-style: italic;"> *</span>
<span style="color: #8D8D84; font-style: italic;"> * There is also a hook called "update_mmu_cache()" that architectures</span>
<span style="color: #8D8D84; font-style: italic;"> * with external mmu caches can use to update those (ie the Sparc or</span>
<span style="color: #8D8D84; font-style: italic;"> * PowerPC hashed page tables that act as extended TLBs).</span>
<span style="color: #8D8D84; font-style: italic;"> *</span>
<span style="color: #8D8D84; font-style: italic;"> * We enter with non-exclusive mmap_sem (to exclude vma changes,</span>
<span style="color: #8D8D84; font-style: italic;"> * but allow concurrent faults), and pte mapped but not yet locked.</span>
<span style="color: #8D8D84; font-style: italic;"> * We return with mmap_sem still held, but pte unmapped and unlocked.</span>
<span style="color: #8D8D84;"> */</span>
<span style="color: #0000FF;">static</span> <span style="color: #0000FF;">inline</span> <span style="color: #6434A3;">int</span> <span style="color: #006699;">handle_pte_fault</span><span style="color: #707183;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">mm_struct</span> *<span style="color: #BA36A5;">mm</span>,
    <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">vm_area_struct</span> *<span style="color: #BA36A5;">vma</span>, <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">address</span>,
    <span style="color: #6434A3;">pte_t</span> *<span style="color: #BA36A5;">pte</span>, <span style="color: #6434A3;">pmd_t</span> *<span style="color: #BA36A5;">pmd</span>, <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">write_access</span><span style="color: #707183;">)</span>
<span style="color: #707183;">{</span>
  <span style="color: #6434A3;">pte_t</span> <span style="color: #BA36A5;">entry</span>;
  <span style="color: #6434A3;">spinlock_t</span> *<span style="color: #BA36A5;">ptl</span>;

  entry = *pte;
  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>!pte_present<span style="color: #909183;">(</span>entry<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">{</span>
    <span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span>pte_none<span style="color: #709870;">(</span>entry<span style="color: #709870;">)</span><span style="color: #909183;">)</span> <span style="color: #909183;">{</span>
      <span style="color: #0000FF;">if</span> <span style="color: #709870;">(</span>vma-&gt;vm_ops<span style="color: #709870;">)</span> <span style="color: #709870;">{</span>
        <span style="color: #0000FF;">if</span> <span style="color: #907373;">(</span>vma-&gt;vm_ops-&gt;fault || vma-&gt;vm_ops-&gt;nopage<span style="color: #907373;">)</span>
          <span style="color: #0000FF;">return</span> do_linear_fault<span style="color: #907373;">(</span>mm, vma, address,
            pte, pmd, write_access, entry<span style="color: #907373;">)</span>;
        <span style="color: #0000FF;">if</span> <span style="color: #907373;">(</span>unlikely<span style="color: #6276BA;">(</span>vma-&gt;vm_ops-&gt;nopfn<span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
          <span style="color: #0000FF;">return</span> do_no_pfn<span style="color: #907373;">(</span>mm, vma, address, pte,
               pmd, write_access<span style="color: #907373;">)</span>;
      <span style="color: #709870;">}</span>
      <span style="color: #0000FF;">return</span> do_anonymous_page<span style="color: #709870;">(</span>mm, vma, address,
             pte, pmd, write_access<span style="color: #709870;">)</span>;
    <span style="color: #909183;">}</span>
    <span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span>pte_file<span style="color: #709870;">(</span>entry<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
      <span style="color: #0000FF;">return</span> do_nonlinear_fault<span style="color: #909183;">(</span>mm, vma, address,
          pte, pmd, write_access, entry<span style="color: #909183;">)</span>;
    <span style="color: #0000FF;">return</span> do_swap_page<span style="color: #909183;">(</span>mm, vma, address,
          pte, pmd, write_access, entry<span style="color: #909183;">)</span>;
  <span style="color: #7388D6;">}</span>

  ptl = pte_lockptr<span style="color: #7388D6;">(</span>mm, pmd<span style="color: #7388D6;">)</span>;
  spin_lock<span style="color: #7388D6;">(</span>ptl<span style="color: #7388D6;">)</span>;
  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>unlikely<span style="color: #909183;">(</span>!pte_same<span style="color: #709870;">(</span>*pte, entry<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
    <span style="color: #0000FF;">goto</span> <span style="color: #D0372D;">unlock</span>;
  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>write_access<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">{</span>
    <span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span>!pte_write<span style="color: #709870;">(</span>entry<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
      <span style="color: #0000FF;">return</span> do_wp_page<span style="color: #909183;">(</span>mm, vma, address,
          pte, pmd, ptl, entry<span style="color: #909183;">)</span>;
    entry = pte_mkdirty<span style="color: #909183;">(</span>entry<span style="color: #909183;">)</span>;
  <span style="color: #7388D6;">}</span>
  entry = pte_mkyoung<span style="color: #7388D6;">(</span>entry<span style="color: #7388D6;">)</span>;
  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>ptep_set_access_flags<span style="color: #909183;">(</span>vma, address, pte, entry, write_access<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">{</span>
    update_mmu_cache<span style="color: #909183;">(</span>vma, address, entry<span style="color: #909183;">)</span>;
  <span style="color: #7388D6;">}</span> <span style="color: #0000FF;">else</span> <span style="color: #7388D6;">{</span>
    <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">     * This is needed only for protection faults but the arch code</span>
<span style="color: #8D8D84; font-style: italic;">     * is not yet telling us if this is a protection fault or not.</span>
<span style="color: #8D8D84; font-style: italic;">     * This still avoids useless tlb flushes for .text page faults</span>
<span style="color: #8D8D84; font-style: italic;">     * with threads.</span>
<span style="color: #8D8D84;">     */</span>
    <span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span>write_access<span style="color: #909183;">)</span>
      flush_tlb_page<span style="color: #909183;">(</span>vma, address<span style="color: #909183;">)</span>;
  <span style="color: #7388D6;">}</span>
<span style="color: #D0372D;">unlock</span>:
  pte_unmap_unlock<span style="color: #7388D6;">(</span>pte, ptl<span style="color: #7388D6;">)</span>;
  <span style="color: #0000FF;">return</span> <span style="color: #D0372D;">0</span>;
<span style="color: #707183;">}</span>
</pre>
</div>
<p>
如果页不存在物理内存中，即上面代码中!pte<sub>present</sub>(entry)，则分下面三种情况分别处理：
</p>
<p>
<img src="reading/2020-11-17_18-37-16_screenshot.png" alt="2020-11-17_18-37-16_screenshot.png" />
其中每种情况的具体实现待TODO
</p>
</div>
</li>
</ol>
</div>

<div id="outline-container-orgc2fda60" class="outline-4">
<h4 id="orgc2fda60"><span class="section-number-4">3.9.4</span> <span class="todo TODO">TODO</span> 锁与进程间通信</h4>
<div class="outline-text-4" id="text-3-9-4">
<p>
TODO 同步与通信
通常，各个进程必须尽可能保持独立，避免彼此干扰。但有时候，应用程序必须彼此通信：
</p>
<ol class="org-ol">
<li>一个进程生成的数据传输到另一个进程时</li>
<li>数据由多个进程共享时</li>
<li>进程必须彼此等待时</li>
<li>需要协调资源的使用时</li>

<li>竞态条件
如果多个进程共享一个资源，很容易彼此干扰。几个进程在访问资源时彼此干扰的情况通常称为 <b>竞态条件</b></li>
<li>锁
用户空间程序和内核都需要保护资源。为阻止CPU彼此干扰，需要通过锁保护内核的某些范围。
确保每次只能有一个CPU访问被保护的范围。</li>
</ol>

<p>
内核提供了四种锁选项：
</p>
<ul class="org-ul">
<li>原子操作
最简单的锁操作</li>
<li>自旋锁
最常用的锁</li>
<li>信号量
经典实现，互斥量是信号量的特例</li>
<li>读写锁</li>
</ul>
</div>

<ol class="org-ol">
<li><a id="orgc262d17"></a>信号量<br />
<div class="outline-text-5" id="text-3-9-4-1">
<p>
为什么把信号量放在最前面，因为这是第一个提出的同步原语，比互斥量要早。
在用户层可以正常工作,但是其开销对于内核来说还是太大了，所以内核提供了许多不同的锁和同步机制。
</p>
</div>
</li>
<li><a id="org4f2d8ef"></a>原子操作<br />
<div class="outline-text-5" id="text-3-9-4-2">
<p>
从汇编的角度来说，加一操作通常分为3步：
</p>
<ol class="org-ol">
<li>将值从内存读入寄存器</li>
<li>将寄存器中的值+1</li>
<li>将寄存器数据回写到内存</li>
</ol>
<p>
原子操作由CPU的特殊指令来完成，如x86系统上这个指令为lock
</p>
</div>
</li>
<li><a id="orgdadc0a8"></a>自旋锁<br />
<div class="outline-text-5" id="text-3-9-4-3">
<p>
spin<sub>lock和spin</sub><sub>unlock</sub>
通常在启用了内核抢占的单处理器内核中，spin<sub>lock基本上等价于preempt</sub><sub>disable,而spin</sub><sub>unlock</sub>
则等价于preempt<sub>enable</sub>
</p>
</div>
</li>
<li><a id="orgcadca49"></a>RCU(read-copy-update)机制<br /></li>
<li><a id="org9b13ba9"></a>内存和优化屏障<br /></li>
<li><a id="orgfb9cf20"></a>读写锁<br /></li>
<li><a id="org2daa0c6"></a>大内核锁<br /></li>
<li><a id="orgcd59ea3"></a>互斥量<br /></li>
</ol>
</div>

<div id="outline-container-org2e0cdb0" class="outline-4">
<h4 id="org2e0cdb0"><span class="section-number-4">3.9.5</span> 设备驱动程序</h4>
<div class="outline-text-4" id="text-3-9-5">
<p>
应用程序与外设的通信是层次化的：
</p>

<div id="org80dc4f3" class="figure">
<p><img src="reading/2020-11-17_20-47-23_screenshot.png" alt="2020-11-17_20-47-23_screenshot.png" />
</p>
</div>

<p>
外设并不直接连接到cpu，而是通过总线连接起来,无论采用什么体系结构的处理器，系统都不会只有一种总线，
而是一些总线的组合：
</p>

<div id="org0a0ead8" class="figure">
<p><img src="reading/2020-11-17_20-52-17_screenshot.png" alt="2020-11-17_20-52-17_screenshot.png" />
</p>
</div>
</div>

<ol class="org-ol">
<li><a id="orgd3e1537"></a>与外设交互的方式<br />
<div class="outline-text-5" id="text-3-9-5-1">
<ol class="org-ol">
<li>I/O端口
处理器管理了一个独立的虚拟地址空间，可用于管理所有I/O地址。</li>
<li>I/O内存映射</li>
<li>通过总线控制设备
并非所有的设备都是直接通过I/O语句寻址，也有通过总线系统访问的。</li>
</ol>
</div>
</li>
<li><a id="org14ac6e1"></a>中断和轮询<br />
<div class="outline-text-5" id="text-3-9-5-2">
<p>
判断设备数据是否可用的两种方法
</p>
</div>
</li>
<li><a id="org82937de"></a>访问设备<br />
<div class="outline-text-5" id="text-3-9-5-3">
<p>
<b>设备特殊文件（设备文件）</b> 用于访问扩展设备。这些文件与硬盘或其他存储介质没有任何关系，而是
建立了与 某个 <b>设备驱动程序</b> 的连接,以支持与扩展设备的通信。
</p>
</div>

<ol class="org-ol">
<li><a id="org6d72c7f"></a>设备文件标识（主从设备号）<br />
<div class="outline-text-6" id="text-3-9-5-3-1">
<p>
设备主要通过主从设备号来标识，而不是设备文件名。
这识因为内核采用主从设备号来标识匹配的驱动程序,主设备号用于寻址驱动程序自身,
而且一个驱动程序可以分配多个主设备号。
采用主从两个号码主要有以下原因：
</p>
<ol class="org-ol">
<li>系统可能包含几个同类型的设备，他们由同一个设备驱动程序管理。</li>
<li>通过从设备号可以将同类设备合并起来，便于管理</li>
</ol>
<p>
如下面的例子：
</p>

<div id="org55987bb" class="figure">
<p><img src="reading/2020-11-18_09-23-27_screenshot.png" alt="2020-11-18_09-23-27_screenshot.png" />
</p>
</div>

<p>
两个硬盘sda和sdb所在的第一个SATA控制权的主设备号是8.而驱动程序管理的这两个硬盘则通过
不同的设备号来指定。sda对于0，sdb对应16.而0与16之间的其它数字，主要用于识别各个
分区。如下面的sda：
</p>

<div id="org25ee12c" class="figure">
<p><img src="reading/2020-11-18_09-20-28_screenshot.png" alt="2020-11-18_09-20-28_screenshot.png" />
</p>
</div>
</div>
</li>

<li><a id="orgdb1ff8b"></a>设备文件的创建<br />
<div class="outline-text-6" id="text-3-9-5-3-2">
<p>
可用设备结点有20000多项，但一般系统只需要包含其中少量设备，因此，linux将/dev内容的管理
工作切换到 <b>udevd守护进程</b>, 允许从用户层动态创建设备文件。其基本思想如下：
</p>
<p>
<img src="reading/2020-11-18_09-31-52_screenshot.png" alt="2020-11-18_09-31-52_screenshot.png" />
每当内核检测到一个设备时，都会创建一个 <b>内核对象kobject</b>, 该对象借助于 <b>sysfs文件系统</b>
导出到用户层。
</p>
</div>
</li>
<li><a id="orgd74d25d"></a>设备寻址（进行设备配置）<br />
<div class="outline-text-6" id="text-3-9-5-3-3">
<p>
/dev放在tmpfs文件系统中，他是RAM磁盘文件系统ramfs的一种变体。所以设备文件结点不是持久的。
可以使用输入输出控制接口ioctl来寻址设备文件。它是用来配置和修改特定设备属性的通用接口。
</p>
</div>
</li>
<li><a id="org9d18788"></a>设备的数据结构表示<br />
<div class="outline-text-6" id="text-3-9-5-3-4">
<p>
每个字符设备都表示为一个struct cdev，块设备表示为一个struct bdev,有两个全局数组
bdev<sub>map</sub>(用于块设备),cdev<sub>map</sub>(用于字符设备)来实现散列表，使用的散列键是主设备号。
两个数组都是kobj<sub>map的实例</sub>：
</p>

<div id="orga983491" class="figure">
<p><img src="reading/2020-11-18_10-33-44_screenshot.png" alt="2020-11-18_10-33-44_screenshot.png" />
</p>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">cdev</span> <span style="color: #707183;">{</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">kobject</span> <span style="color: #BA36A5;">kobj</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">module</span> *<span style="color: #BA36A5;">owner</span>;
  <span style="color: #0000FF;">const</span> <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">file_operations</span> *<span style="color: #BA36A5;">ops</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span> <span style="color: #BA36A5;">list</span>;
  <span style="color: #6434A3;">dev_t</span> <span style="color: #BA36A5;">dev</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">count</span>;
<span style="color: #707183;">}</span>;




<span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">bdev_inode</span> <span style="color: #707183;">{</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">block_device</span> <span style="color: #BA36A5;">bdev</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">inode</span> <span style="color: #BA36A5;">vfs_inode</span>;
<span style="color: #707183;">}</span>;

<span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">block_device</span> <span style="color: #707183;">{</span>
  <span style="color: #6434A3;">dev_t</span>     <span style="color: #BA36A5;">bd_dev</span>;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">not a kdev_t - it's a search key</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">inode</span> *    <span style="color: #BA36A5;">bd_inode</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">will die</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">int</span>     <span style="color: #BA36A5;">bd_openers</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">mutex</span>    <span style="color: #BA36A5;">bd_mutex</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">open/close mutex</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">semaphore</span>  <span style="color: #BA36A5;">bd_mount_sem</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span>  <span style="color: #BA36A5;">bd_inodes</span>;
  <span style="color: #6434A3;">void</span> *      <span style="color: #BA36A5;">bd_holder</span>;
  <span style="color: #6434A3;">int</span>     <span style="color: #BA36A5;">bd_holders</span>;
<span style="color: #808080;">#ifdef</span> CONFIG_SYSFS
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span>  <span style="color: #BA36A5;">bd_holder_list</span>;
<span style="color: #808080;">#endif</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">block_device</span> * <span style="color: #BA36A5;">bd_contains</span>;
  <span style="color: #6434A3;">unsigned</span>    <span style="color: #BA36A5;">bd_block_size</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">hd_struct</span> *  <span style="color: #BA36A5;">bd_part</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">number of times partitions within this device have been opened.</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span>    <span style="color: #BA36A5;">bd_part_count</span>;
  <span style="color: #6434A3;">int</span>     <span style="color: #BA36A5;">bd_invalidated</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">gendisk</span> *  <span style="color: #BA36A5;">bd_disk</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span>  <span style="color: #BA36A5;">bd_list</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">backing_dev_info</span> *<span style="color: #BA36A5;">bd_inode_backing_dev_info</span>;
  <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">   * Private data.  You must have bd_claim'ed the block_device</span>
<span style="color: #8D8D84; font-style: italic;">   * to use this.  </span><span style="color: #d0bf8f;">NOTE</span><span style="color: #8D8D84; font-style: italic;">:  bd_claim allows an owner to claim</span>
<span style="color: #8D8D84; font-style: italic;">   * the same device multiple times, the owner must take special</span>
<span style="color: #8D8D84; font-style: italic;">   * care to not mess up bd_private for that case.</span>
<span style="color: #8D8D84;">   */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span>   <span style="color: #BA36A5;">bd_private</span>;
<span style="color: #707183;">}</span>;
</pre>
</div>
</div>
</li>

<li><a id="org30a1e1b"></a>与文件系统的关联<br />
<div class="outline-text-6" id="text-3-9-5-3-5">
<p>
除极少数例外，设备文件都是由标准函数处理，类似于普通文件。它们都通过虚拟文件系统管理。
在打开一个设备文件时，各种文件系统的实现回调用init<sub>special</sub><sub>inode函数</sub>，为块设备或
字符设备文件创建一个inode,inode中设备文件驱动程序有关的成员如下：
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">inode</span> <span style="color: #707183;">{</span>
  ...
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#20027;&#20174;&#35774;&#22791;&#21495;</span><span style="color: #8D8D84;"> */</span>
  dev_t i_rdev;
  ...
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#23384;&#20648;&#20102;&#25991;&#20214;&#31867;&#22411;</span><span style="color: #8D8D84;"> */</span>
  unode_t i_mode;
  ...
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#30001;&#34394;&#25311;&#25991;&#20214;&#31995;&#32479;&#20351;&#29992;&#26469;&#22788;&#29702;&#22359;&#35774;&#22791;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> file_operations *i_fop;
  ...
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#20869;&#26680;&#26681;&#25454;&#25991;&#20214;&#31867;&#22411;&#26469;&#36873;&#25321;&#22359;&#35774;&#22791;&#36824;&#26159;&#23383;&#31526;&#35774;&#22791;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">union</span> <span style="color: #7388D6;">{</span>
    ...
    <span style="color: #0000FF;">struct</span> block_device *i_bdev;
    <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">cdev</span> *<span style="color: #BA36A5;">i_cdev</span>;
  <span style="color: #7388D6;">}</span>;
  ...
<span style="color: #707183;">}</span>;

<span style="color: #6434A3;">void</span> <span style="color: #006699;">init_special_inode</span><span style="color: #707183;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">inode</span> *<span style="color: #BA36A5;">inode</span>, <span style="color: #6434A3;">umode_t</span> <span style="color: #BA36A5;">mode</span>, <span style="color: #6434A3;">dev_t</span> <span style="color: #BA36A5;">rdev</span><span style="color: #707183;">)</span>
<span style="color: #707183;">{</span>
  inode-&gt;i_mode = mode;
  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>S_ISCHR<span style="color: #909183;">(</span>mode<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">{</span>
    inode-&gt;i_fop = &amp;def_chr_fops;
    inode-&gt;i_rdev = rdev;
  <span style="color: #7388D6;">}</span> <span style="color: #0000FF;">else</span> <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>S_ISBLK<span style="color: #909183;">(</span>mode<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">{</span>
    inode-&gt;i_fop = &amp;def_blk_fops;
    inode-&gt;i_rdev = rdev;
  <span style="color: #7388D6;">}</span> <span style="color: #0000FF;">else</span> <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>S_ISFIFO<span style="color: #909183;">(</span>mode<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
    inode-&gt;i_fop = &amp;def_fifo_fops;
  <span style="color: #0000FF;">else</span> <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>S_ISSOCK<span style="color: #909183;">(</span>mode<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
    inode-&gt;i_fop = &amp;bad_sock_fops;
  <span style="color: #0000FF;">else</span>
    printk<span style="color: #7388D6;">(</span>KERN_DEBUG <span style="color: #008000;">"init_special_inode: bogus i_mode (%o)\n"</span>,
           mode<span style="color: #7388D6;">)</span>;
<span style="color: #707183;">}</span>

<span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;"> * Dummy default file-operations: the only thing this does</span>
<span style="color: #8D8D84; font-style: italic;"> * is contain the open that then fills in the correct operations</span>
<span style="color: #8D8D84; font-style: italic;"> * depending on the special file...</span>
<span style="color: #8D8D84;"> */</span>
<span style="color: #0000FF;">const</span> <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">file_operations</span> <span style="color: #BA36A5;">def_chr_fops</span> = <span style="color: #707183;">{</span>
  .open = chrdev_open,
<span style="color: #707183;">}</span>;


<span style="color: #0000FF;">const</span> <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">file_operations</span> <span style="color: #BA36A5;">def_blk_fops</span> = <span style="color: #707183;">{</span>
  .open   = blkdev_open,
  .release  = blkdev_close,
  .llseek   = block_llseek,
  .read   = do_sync_read,
  .write    = do_sync_write,
  .aio_read = generic_file_aio_read,
  .aio_write  = generic_file_aio_write_nolock,
  .mmap   = generic_file_mmap,
  .fsync    = block_fsync,
  .unlocked_ioctl = block_ioctl,
<span style="color: #808080;">#ifdef</span> CONFIG_COMPAT
  .compat_ioctl = compat_blkdev_ioctl,
<span style="color: #808080;">#endif</span>
  .splice_read  = generic_file_splice_read,
  .splice_write = generic_file_splice_write,
<span style="color: #707183;">}</span>;
</pre>
</div>
</div>
</li>

<li><a id="org3d62e68"></a><span class="todo TODO">TODO</span> 设备文件各种操作的流程<br /></li>
</ol>
</li>
</ol>
</div>

<div id="outline-container-orgad331a2" class="outline-4">
<h4 id="orgad331a2"><span class="section-number-4">3.9.6</span> <span class="todo TODO">TODO</span> 模块</h4>
</div>
<div id="outline-container-org6bf6c15" class="outline-4">
<h4 id="org6bf6c15"><span class="section-number-4">3.9.7</span> 虚拟文件系统</h4>
<div class="outline-text-4" id="text-3-9-7">
<p>
为了支持各种文件系统，linux内核在用户进程（C标准库）和文件系统实现之间引入了一个
抽象层 <b>虚拟文件系统</b> 。
</p>

<div id="org063bc2f" class="figure">
<p><img src="reading/2020-11-18_14-02-01_screenshot.png" alt="2020-11-18_14-02-01_screenshot.png" />
</p>
</div>
</div>

<ol class="org-ol">
<li><a id="org96ea4a1"></a>文件系统分类<br />
<div class="outline-text-5" id="text-3-9-7-1">
<ol class="org-ol">
<li>基于磁盘的文件系统</li>
<li>虚拟文件系统
由内核生成，是一种使用户应用程序与用户通信的方法。如proc文件系统.
内核建立了一个层次化的文件结构，其中的项包含了与系统特定部分相关的信息</li>
<li>网络文件系统</li>
</ol>
</div>
</li>
<li><a id="org7aecdc7"></a>通用文件模型<br />
<div class="outline-text-5" id="text-3-9-7-2">
<p>
在处理文件时，内核与用户空间使用的主要对象是不同的。
对用户程序来说，一个文件主要由一个文件描述符标识,它只在每个进程内部有效；
对于内核来说，一个文件则由inode来标识，一个文件（目录）都有且只有一个对应的inode
</p>

<ul class="org-ul">
<li><p>
inode的成员可以分为下面两类：
</p>
<ol class="org-ol">
<li>描述文件状态的元数据</li>
<li>保存实际文件内容的数据段（或指向数据的指针）</li>
</ol>
<p>
要注意的是，inode并不包含文件名
</p></li>
</ul>
</div>
</li>

<li><a id="org2f6cb16"></a>VFS结构<br />
<ol class="org-ol">
<li><a id="org31f42bc"></a>结构概观<br />
<div class="outline-text-6" id="text-3-9-7-3-1">
<p>
<img src="reading/2020-11-18_16-12-04_screenshot.png" alt="2020-11-18_16-12-04_screenshot.png" />
其中，在抽象对底层文件系统访问时，并未使用固定的函数，而是使用了函数指针。他们分为两类：
</p>
<ol class="org-ol">
<li>inode操作：创建链接，文件重命名，在目录中生成新文件，删除文件</li>
<li>文件操作：作用于文件的数据内容</li>
</ol>
</div>
</li>

<li><a id="orgefd6434"></a>inode<br />
<div class="outline-text-6" id="text-3-9-7-3-2">
<p>
VFS的inode结构如下：
我们应该记住这里的inode是用于内存中进行处理的，因而包含了一些实际介质上存储的inode
所没有的成员。这些是由内核自身在从底层文件系统读入信息时生成或动态建立。
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#35813;&#32467;&#26500;&#21253;&#25324;&#20960;&#20010;&#38142;&#34920;&#20803;&#32032;&#65292;&#29992;&#20110;&#20998;&#31867;&#31649;&#29702;&#21508;&#20010;inode&#12290;</span><span style="color: #8D8D84;"> */</span>
<span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">inode</span> <span style="color: #707183;">{</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#29992;&#20110;&#25955;&#21015;&#34920;inode_hashtable&#25903;&#25345;&#65292;&#25955;&#21015;&#34920;&#21017;&#29992;&#26469;&#26681;&#25454;inode&#32534;&#21495;&#21644;&#36229;&#32423;&#22359;&#24555;&#36895;&#35775;&#38382;inode,&#36825;&#20004;&#39033;&#30340;&#32452;&#21512;&#22312;&#31995;&#32479;&#33539;&#22260;&#20869;&#26159;&#21807;&#19968;&#30340;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">hlist_node</span> <span style="color: #BA36A5;">i_hash</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#20869;&#26680;&#23450;&#20041;&#20102;&#20004;&#20010;&#20840;&#23616;&#21464;&#37327;&#29992;&#20316;&#34920;&#22836;&#65292;inode_unused&#29992;&#20110;&#26377;&#25928;&#20294;&#38750;&#27963;&#21160;&#30340;inode;</span>
<span style="color: #8D8D84; font-style: italic;">     inode_in_use&#29992;&#20110;&#25152;&#26377;&#20351;&#29992;&#20294;&#26410;&#25913;&#21464;&#30340;inode&#65307;&#33039;&#30340;inode&#20445;&#23384;&#22312;&#19968;&#20010;&#29305;&#23450;&#20110;</span>
<span style="color: #8D8D84; font-style: italic;">     &#36229;&#32423;&#22359;&#30340;&#38142;&#34920;super_block-&gt;s_dirty&#20013;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span>  <span style="color: #BA36A5;">i_list</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">inode&#20063;&#36890;&#36807;&#19968;&#20010;&#29305;&#23450;&#20110;&#36229;&#32423;&#22359;&#30340;&#38142;&#34920;super_block-&gt;s_inodes&#32500;&#25252;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span>  <span style="color: #BA36A5;">i_sb_list</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span>  <span style="color: #BA36A5;">i_dentry</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#27599;&#20010;VFS inode&#37117;&#30001;&#19968;&#20010;&#21807;&#19968;&#30340;&#32534;&#21495;&#26631;&#35782;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span>   <span style="color: #BA36A5;">i_ino</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#35775;&#38382;&#35813;inode&#32467;&#26500;&#30340;&#36827;&#31243;&#25968;&#30446;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">atomic_t</span>    <span style="color: #BA36A5;">i_count</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span>    <span style="color: #BA36A5;">i_nlink</span>;
  <span style="color: #6434A3;">uid_t</span>     <span style="color: #BA36A5;">i_uid</span>;
  <span style="color: #6434A3;">gid_t</span>     <span style="color: #BA36A5;">i_gid</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#24403;&#34920;&#31034;&#35774;&#22791;&#25991;&#20214;&#26102;&#38656;&#35201;&#65292;&#34920;&#31034;&#19982;&#21738;&#20010;&#35774;&#22791;&#36827;&#34892;&#36890;&#20449;,&#25105;&#20204;&#26368;&#32456;&#20250;&#25214;&#21040;struct block_device&#30340;&#19968;&#20010;&#23454;&#20363;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">dev_t</span>     <span style="color: #BA36A5;">i_rdev</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span>   <span style="color: #BA36A5;">i_version</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#25991;&#20214;&#38271;&#24230;&#65292;&#25353;&#23383;&#33410;&#35745;&#31639;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">loff_t</span>      <span style="color: #BA36A5;">i_size</span>;
<span style="color: #808080;">#ifdef</span> __NEED_I_SIZE_ORDERED
  <span style="color: #6434A3;">seqcount_t</span>    <span style="color: #BA36A5;">i_size_seqcount</span>;
<span style="color: #808080;">#endif</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#26368;&#21518;&#35775;&#38382;&#26102;&#38388;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">timespec</span>   <span style="color: #BA36A5;">i_atime</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#26368;&#21518;&#20462;&#25913;&#26102;&#38388;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">timespec</span>   <span style="color: #BA36A5;">i_mtime</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#26368;&#21518;&#20462;&#25913;inode&#26102;&#38388;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">timespec</span>   <span style="color: #BA36A5;">i_ctime</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span>    <span style="color: #BA36A5;">i_blkbits</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#25991;&#20214;&#25353;&#22359;&#35745;&#31639;&#30340;&#38271;&#24230;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">blkcnt_t</span>    <span style="color: #BA36A5;">i_blocks</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">short</span>          <span style="color: #BA36A5;">i_bytes</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#25991;&#20214;&#35775;&#38382;&#26435;&#38480;&#21644;&#25152;&#26377;&#26435;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">umode_t</span>     <span style="color: #BA36A5;">i_mode</span>;
  <span style="color: #6434A3;">spinlock_t</span>    <span style="color: #BA36A5;">i_lock</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">i_blocks, i_bytes, maybe i_size</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">mutex</span>    <span style="color: #BA36A5;">i_mutex</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">rw_semaphore</span> <span style="color: #BA36A5;">i_alloc_sem</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#36127;&#36131;&#31649;&#29702;&#32467;&#26500;&#24615;&#30340;&#25805;&#20316;&#65288;&#22914;&#21024;&#38500;&#19968;&#20010;&#25991;&#20214;&#65289;&#21644;&#25991;&#20214;&#30456;&#20851;&#30340;&#20803;&#25968;&#25454;&#65288;&#22914;&#23646;&#24615;&#65289;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">const</span> <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">inode_operations</span> *<span style="color: #BA36A5;">i_op</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#29992;&#20110;&#25805;&#20316;&#25991;&#20214;&#20013;&#21253;&#21547;&#30340;&#25968;&#25454;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">const</span> <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">file_operations</span>  *<span style="color: #BA36A5;">i_fop</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">former -&gt;i_op-&gt;default_file_ops</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">super_block</span>  *<span style="color: #BA36A5;">i_sb</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">file_lock</span>  *<span style="color: #BA36A5;">i_flock</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">address_space</span>  *<span style="color: #BA36A5;">i_mapping</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">address_space</span>  <span style="color: #BA36A5;">i_data</span>;
<span style="color: #808080;">#ifdef</span> CONFIG_QUOTA
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">dquot</span>    *<span style="color: #BA36A5;">i_dquot</span><span style="color: #7388D6;">[</span>MAXQUOTAS<span style="color: #7388D6;">]</span>;
<span style="color: #808080;">#endif</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span>  <span style="color: #BA36A5;">i_devices</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#22914;&#26524;&#34920;&#31034;&#35774;&#22791;&#25991;&#20214;&#65292;&#21017;&#21253;&#21547;&#25351;&#21521;&#35774;&#22791;&#19987;&#29992;&#25968;&#25454;&#32467;&#26500;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">union</span> <span style="color: #7388D6;">{</span>
    <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">pipe_inode_info</span>  *<span style="color: #BA36A5;">i_pipe</span>;
    <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">block_device</span> *<span style="color: #BA36A5;">i_bdev</span>;
    <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">cdev</span>   *<span style="color: #BA36A5;">i_cdev</span>;
  <span style="color: #7388D6;">}</span>;
  <span style="color: #6434A3;">int</span>     <span style="color: #BA36A5;">i_cindex</span>;

  <span style="color: #6434A3;">__u32</span>     <span style="color: #BA36A5;">i_generation</span>;

<span style="color: #808080;">#ifdef</span> CONFIG_DNOTIFY
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span>   <span style="color: #BA36A5;">i_dnotify_mask</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Directory notify events</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">dnotify_struct</span> *<span style="color: #BA36A5;">i_dnotify</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">for directory notifications</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#endif</span>

<span style="color: #808080;">#ifdef</span> CONFIG_INOTIFY
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span>  <span style="color: #BA36A5;">inotify_watches</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">watches on this inode</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">mutex</span>    <span style="color: #BA36A5;">inotify_mutex</span>;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">protects the watches list</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#endif</span>

  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span>   <span style="color: #BA36A5;">i_state</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span>   <span style="color: #BA36A5;">dirtied_when</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">jiffies of first dirtying</span><span style="color: #8D8D84;"> */</span>

  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span>    <span style="color: #BA36A5;">i_flags</span>;

  <span style="color: #6434A3;">atomic_t</span>    <span style="color: #BA36A5;">i_writecount</span>;
<span style="color: #808080;">#ifdef</span> CONFIG_SECURITY
  <span style="color: #6434A3;">void</span>      *<span style="color: #BA36A5;">i_security</span>;
<span style="color: #808080;">#endif</span>
  <span style="color: #6434A3;">void</span>      *<span style="color: #BA36A5;">i_private</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">fs or device private pointer</span><span style="color: #8D8D84;"> */</span>
<span style="color: #707183;">}</span>;
</pre>
</div>
</div>
</li>

<li><a id="org1abe9d5"></a>特定于进程的信息<br />
<div class="outline-text-6" id="text-3-9-7-3-3">
<p>
文件描述符用于在一个进程内唯一的标示打开的文件。每个进程的task<sub>struct中包含了</sub>
用于在进程描述符和内核内部使用的结构之间建立联系的数据成员：
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">task_struct</span> <span style="color: #707183;">{</span>
  ...
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#25991;&#20214;&#31995;&#32479;&#20449;&#24687;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#29992;&#20110;&#22312;&#26597;&#25214;&#29615;&#24418;&#38142;&#34920;&#26102;&#38450;&#27490;&#26080;&#38480;&#24490;&#29615;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">int</span> link_cont, total_link_count;
  ...
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#25991;&#20214;&#31995;&#32479;&#20449;&#24687;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> fs_struct *fs;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#25171;&#24320;&#25991;&#20214;&#20449;&#24687;,&#21253;&#21547;&#36827;&#31243;&#30340;&#21508;&#20010;&#25991;&#20214;&#25551;&#36848;&#31526;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">files_struct</span> *<span style="color: #BA36A5;">files</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#21629;&#21517;&#31354;&#38388;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">nsproxy</span> *<span style="color: #BA36A5;">nsproxy</span>;
  ...
<span style="color: #707183;">}</span>

<span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">files_struct</span> <span style="color: #707183;">{</span>
  <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">   * read mostly part</span>
<span style="color: #8D8D84;">   */</span>
  <span style="color: #6434A3;">atomic_t</span> <span style="color: #BA36A5;">count</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#22810;&#21253;&#21547;&#19968;&#20010;fatable&#30340;&#25351;&#38024;&#26159;&#29992;&#20110;RCU</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">fdtable</span> *<span style="color: #BA36A5;">fdt</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">fdtable</span> <span style="color: #BA36A5;">fdtab</span>;
  <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">   * written part on a separate cache line in SMP</span>
<span style="color: #8D8D84;">   */</span>
  spinlock_t <span style="color: #6434A3;">file_lock</span> <span style="color: #BA36A5;">____cacheline_aligned_in_smp</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#19979;&#19968;&#27425;&#25171;&#24320;&#26032;&#25991;&#20214;&#26102;&#20351;&#29992;&#30340;&#25991;&#20214;&#25551;&#36848;&#31526;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">next_fd</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#20301;&#22270;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">embedded_fd_set</span> <span style="color: #BA36A5;">close_on_exec_init</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">embedded_fd_set</span> <span style="color: #BA36A5;">open_fds_init</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#25351;&#21521;&#27599;&#20010;&#25171;&#24320;&#25991;&#20214;&#30340;struct file&#23454;&#20363;(&#19979;&#32473;&#20986;&#20102;&#35814;&#32454;&#32467;&#26500;), &#22914;&#26524;&#36827;&#31243;&#35797;&#22270;&#25171;&#24320;&#27604;NR_OPEN_DEFAULT</span>
<span style="color: #8D8D84; font-style: italic;">     &#26356;&#22810;&#30340;&#25991;&#20214;&#65292;&#20869;&#26680;&#24517;&#39035;&#23545;files_struct&#20013;&#29992;&#20110;&#31649;&#29702;&#19982;&#36827;&#31243;&#30456;&#20851;&#30340;&#25152;&#26377;&#25991;&#20214;&#20449;&#24687;&#30340;&#21508;&#20010;&#25104;&#21592;</span>
<span style="color: #8D8D84; font-style: italic;">     &#20998;&#37197;&#26356;&#22810;&#30340;&#20869;&#23384;&#31354;&#38388;,&#26368;&#37325;&#35201;&#30340;&#26159;fdtable</span>
<span style="color: #8D8D84;">  */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">file</span> * <span style="color: #BA36A5;">fd_array</span><span style="color: #7388D6;">[</span>NR_OPEN_DEFAULT<span style="color: #7388D6;">]</span>;
<span style="color: #707183;">}</span>;

<span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;"> * The embedded_fd_set is a small fd_set,</span>
<span style="color: #8D8D84; font-style: italic;"> * suitable for most tasks (which open &lt;= BITS_PER_LONG files)</span>
<span style="color: #8D8D84;"> */</span>
<span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">embedded_fd_set</span> <span style="color: #707183;">{</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">fds_bits</span><span style="color: #7388D6;">[</span><span style="color: #D0372D;">1</span><span style="color: #7388D6;">]</span>;
<span style="color: #707183;">}</span>;


<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#21021;&#30475;&#36215;&#26469;&#65292;fdtable&#21644;files_struct&#20043;&#38388;&#26576;&#20123;&#20449;&#24687;&#20284;&#20046;&#26159;&#37325;&#22797;&#30340;&#65292;&#20854;&#23454;fdtable&#20013;&#30340;&#25104;&#21592;</span>
<span style="color: #8D8D84; font-style: italic;">   &#37117;&#26159;&#25351;&#38024;&#65292;&#21021;&#22987;&#26102;&#37117;&#25351;&#21521;&#20102;&#21518;&#32773;&#30340;&#23545;&#24212;&#25104;&#21592;, &#24403;&#38656;&#35201;&#25171;&#24320;&#30340;&#25991;&#20214;&#36229;&#36807;&#20102;NR_OPEN_DEFAULT&#26102;</span>
<span style="color: #8D8D84; font-style: italic;">   ,&#20869;&#26680;&#20250;&#20998;&#37197;&#19968;&#20010;fd_set&#30340;&#23454;&#20363;, &#26367;&#25442;&#26368;&#21021;&#30340;embedded_fd_set</span><span style="color: #8D8D84;">*/</span>
<span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">fdtable</span> <span style="color: #707183;">{</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#36827;&#31243;&#24403;&#21069;&#21487;&#20197;&#22788;&#29702;&#30340;&#25991;&#20214;&#23545;&#35937;&#21644;&#25991;&#20214;&#25551;&#36848;&#31526;&#30340;&#26368;&#22823;&#25968;&#30446;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">max_fds</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#25351;&#38024;&#25968;&#32452;&#65292;&#27599;&#20010;&#25968;&#32452;&#39033;&#31649;&#29702;&#19968;&#20010;&#25171;&#24320;&#25991;&#20214;&#30340;&#25152;&#26377;&#20449;&#24687;, &#25991;&#20214;&#25551;&#36848;&#31526;&#20805;&#24403;&#25968;&#32452;&#32034;&#24341;,&#38271;&#24230;&#30001;max_fds&#23450;&#20041;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">file</span> ** <span style="color: #BA36A5;">fd</span>;      <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">current fd array</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">fd_set</span> *<span style="color: #BA36A5;">close_on_exec</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#25351;&#21521;&#31649;&#29702;&#25152;&#26377;&#25171;&#24320;&#25991;&#20214;&#25551;&#36848;&#31526;&#30340;&#20301;&#22495;&#65292;bit&#32622;&#20301;&#26631;&#31034;&#25991;&#20214;&#25551;&#36848;&#31526;&#22312;&#20351;&#29992;&#20013;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">fd_set</span> *<span style="color: #BA36A5;">open_fds</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">rcu_head</span> <span style="color: #BA36A5;">rcu</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">fdtable</span> *<span style="color: #BA36A5;">next</span>;
<span style="color: #707183;">}</span>;


<span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">file</span> <span style="color: #707183;">{</span>
  <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">   * fu_list becomes invalid after file_free is called and queued via</span>
<span style="color: #8D8D84; font-style: italic;">   * fu_rcuhead for RCU freeing</span>
<span style="color: #8D8D84;">   */</span>
  <span style="color: #0000FF;">union</span> <span style="color: #7388D6;">{</span>
    <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span>  <span style="color: #BA36A5;">fu_list</span>;
    <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">rcu_head</span>   <span style="color: #BA36A5;">fu_rcuhead</span>;
  <span style="color: #7388D6;">}</span> <span style="color: #BA36A5;">f_u</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#23553;&#35013;&#20102;&#65306;</span>
<span style="color: #8D8D84; font-style: italic;">     1. &#25991;&#20214;&#21517;&#21644;inode&#20043;&#38388;&#30340;&#20851;&#32852;</span>
<span style="color: #8D8D84; font-style: italic;">     2. &#25991;&#20214;&#25152;&#22312;&#25991;&#20214;&#31995;&#32479;&#30340;&#20449;&#24687;</span>
<span style="color: #8D8D84; font-style: italic;">     &#21518;&#38754;&#20195;&#30721;&#32473;&#20986;&#20102;&#35814;&#32454;&#32467;&#26500;</span><span style="color: #8D8D84;">*/</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">path</span>   <span style="color: #BA36A5;">f_path</span>;
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">f_dentry</span>  f_path.dentry
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">f_vfsmnt</span>  f_path.mnt
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#25991;&#20214;&#25805;&#20316;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">const</span> <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">file_operations</span>  *<span style="color: #BA36A5;">f_op</span>;
  <span style="color: #6434A3;">atomic_t</span>    <span style="color: #BA36A5;">f_count</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">open&#31995;&#32479;&#35843;&#29992;&#20256;&#36882;&#30340;&#39069;&#22806;&#26631;&#24535;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span>    <span style="color: #BA36A5;">f_flags</span>;
  <span style="color: #6434A3;">mode_t</span>      <span style="color: #BA36A5;">f_mode</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#25991;&#20214;&#20301;&#32622;&#24403;&#21069;&#20540;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">loff_t</span>      <span style="color: #BA36A5;">f_pos</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#22788;&#29702;&#35813;&#25991;&#20214;&#30340;&#36827;&#31243;&#26377;&#20851;&#30340;&#20449;&#24687;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">fown_struct</span>  <span style="color: #BA36A5;">f_owner</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span>    <span style="color: #BA36A5;">f_uid</span>, <span style="color: #BA36A5;">f_gid</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#39044;&#35835;&#29305;&#24449;&#65292;&#25351;&#23450;&#26159;&#21542;&#39044;&#35835;&#65292;&#22914;&#20309;&#39044;&#35835;</span><span style="color: #8D8D84;">*/</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">file_ra_state</span>  <span style="color: #BA36A5;">f_ra</span>;

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#29992;&#20110;&#25991;&#20214;&#31995;&#32479;&#26816;&#26597;&#19968;&#20010;file&#23454;&#20363;&#26159;&#21542;&#20173;&#28982;&#19982;&#30456;&#20851;&#30340;inode&#20869;&#23481;&#20860;&#23481;&#65292;</span>
<span style="color: #8D8D84; font-style: italic;">     &#36825;&#23545;&#20110;&#30830;&#20445;&#24050;&#32531;&#23384;&#23545;&#35937;&#30340;&#19968;&#33268;&#24615;&#24456;&#37325;&#35201;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">u64</span>     <span style="color: #BA36A5;">f_version</span>;
<span style="color: #808080;">#ifdef</span> CONFIG_SECURITY
  <span style="color: #6434A3;">void</span>      *<span style="color: #BA36A5;">f_security</span>;
<span style="color: #808080;">#endif</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">needed for tty driver, and maybe others</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">void</span>      *<span style="color: #BA36A5;">private_data</span>;

<span style="color: #808080;">#ifdef</span> CONFIG_EPOLL
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Used by fs/eventpoll.c to link all the hooks to this file</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span>  <span style="color: #BA36A5;">f_ep_links</span>;
  <span style="color: #6434A3;">spinlock_t</span>    <span style="color: #BA36A5;">f_ep_lock</span>;
<span style="color: #808080;">#endif</span> <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">#ifdef CONFIG_EPOLL</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#23646;&#20110;&#25991;&#20214;&#30456;&#20851;&#30340;inode&#23454;&#20363;&#30340;&#22320;&#22336;&#31354;&#38388;&#26144;&#23556;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">address_space</span>  *<span style="color: #BA36A5;">f_mapping</span>;
<span style="color: #707183;">}</span>;

<span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">path</span> <span style="color: #707183;">{</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#25152;&#22312;&#25991;&#20214;&#31995;&#32479;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">vfsmount</span> *<span style="color: #BA36A5;">mnt</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#25552;&#20379;&#25991;&#20214;&#21517;&#19982;inode&#20043;&#38388;&#30340;&#20851;&#32852;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">dentry</span> *<span style="color: #BA36A5;">dentry</span>;
<span style="color: #707183;">}</span>;


<span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">fs_struct</span> <span style="color: #707183;">{</span>
  <span style="color: #6434A3;">atomic_t</span> <span style="color: #BA36A5;">count</span>;
  <span style="color: #6434A3;">rwlock_t</span> <span style="color: #BA36A5;">lock</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#26032;&#25991;&#20214;&#26435;&#38480;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">umask</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#26681;&#30446;&#24405;&#65292;&#24403;&#21069;&#30446;&#24405;&#65292;&#20010;&#24615;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">dentry</span> * <span style="color: #BA36A5;">root</span>, * <span style="color: #BA36A5;">pwd</span>, * <span style="color: #BA36A5;">altroot</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#19978;&#38754;&#30446;&#24405;&#23545;&#24212;&#30340;&#25991;&#20214;&#31995;&#32479;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">vfsmount</span> * <span style="color: #BA36A5;">rootmnt</span>, * <span style="color: #BA36A5;">pwdmnt</span>, * <span style="color: #BA36A5;">altrootmnt</span>;
<span style="color: #707183;">}</span>;
</pre>
</div>
</div>
</li>

<li><a id="org8b01724"></a>VFS命名空间<br />
<div class="outline-text-6" id="text-3-9-7-3-4">
<p>
VFS命名空间是已经装载、构成某个容器目录树的文件系统的集合。其数据结构为
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">mnt_namespace</span> <span style="color: #707183;">{</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#20351;&#29992;&#35813;&#21629;&#21517;&#31354;&#38388;&#30340;&#36827;&#31243;&#25968;&#30446;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">atomic_t</span>    <span style="color: #BA36A5;">count</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#26681;&#30446;&#24405;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">vfsmount</span> * <span style="color: #BA36A5;">root</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">VFS&#21629;&#21517;&#31354;&#38388;&#20013;&#25152;&#26377;&#25991;&#20214;&#31995;&#32479;&#30340;vfsmount&#23454;&#20363;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span>  <span style="color: #BA36A5;">list</span>;
  <span style="color: #6434A3;">wait_queue_head_t</span> <span style="color: #BA36A5;">poll</span>;
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">event</span>;
<span style="color: #707183;">}</span>;
</pre>
</div>
<p>
命令空间操作（mount和umount）并不作用于内核的全局数据结构，而是当前进程的命名空间。
</p>
</div>
</li>
<li><a id="orga099d85"></a>目录项缓存<br />
<div class="outline-text-6" id="text-3-9-7-3-5">
<p>
由于块设备速度很慢，所以找一个文件名相关的inode。而且即使inode指向的数据内容都已经在内存
中了（页缓存），仍然会重复整个查找过程（可能会读块设备）。所以linux使用了页目录缓存（dentry
缓存）来快速访问此前查找的结果。在VFS连同文件系统实现读取的一个目录项（目录或文件）的数据
之后，则创建了一个dentry实例，以缓存找到的数据。
</p>

<p>
dentry数据结构如下：
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">dentry</span> <span style="color: #707183;">{</span>
  <span style="color: #6434A3;">atomic_t</span> <span style="color: #BA36A5;">d_count</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">d_flags</span>;   <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">protected by d_lock</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">spinlock_t</span> <span style="color: #BA36A5;">d_lock</span>;    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">per dentry lock</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#25351;&#21521;&#30456;&#20851;&#30340;inode&#23454;&#20363;&#30340;&#25351;&#38024;,&#22914;&#26524;dentry&#23545;&#35937;&#26159;&#20026;&#19968;&#20010;&#19981;&#23384;&#22312;&#30340;&#25991;&#20214;&#21517;&#24314;&#31435;&#65292;</span>
<span style="color: #8D8D84; font-style: italic;">     &#21017;d_ionde&#20026;null&#12290;&#36825;&#26377;&#21161;&#20110;&#21152;&#36895;&#26597;&#25214;&#19981;&#23384;&#22312;&#30340;&#25991;&#20214;&#21517;&#65292;&#22240;&#20026;&#27809;&#26377;&#32531;&#23384;&#30340;&#35805;&#65292;</span>
<span style="color: #8D8D84; font-style: italic;">     &#26597;&#25214;&#19968;&#20010;&#23454;&#38469;&#19981;&#23384;&#22312;&#30340;&#25991;&#20214;&#21517;&#21644;&#26597;&#25214;&#19968;&#20010;&#23384;&#22312;&#30340;&#25991;&#20214;&#21516;&#26679;&#32791;&#26102;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">inode</span> *<span style="color: #BA36A5;">d_inode</span>;    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Where the name belongs to - NULL is</span>
<span style="color: #8D8D84; font-style: italic;">           * negative</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">   * The next three fields are touched by __d_lookup.  Place them here</span>
<span style="color: #8D8D84; font-style: italic;">   * so they all fit in a cache line.</span>
<span style="color: #8D8D84;">   */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">hlist_node</span> <span style="color: #BA36A5;">d_hash</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">lookup hash list</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#24403;&#21069;&#32467;&#28857;&#29238;&#30446;&#24405;&#30340;dentry&#23454;&#20363;&#65292;&#24403;&#21069;dentry&#20301;&#20110;&#29238;&#30446;&#24405;&#30340;d_subdirs&#20013;,</span>
<span style="color: #8D8D84; font-style: italic;">     &#26681;&#30446;&#24405;&#25351;&#21521;&#20854;&#33258;&#36523;</span><span style="color: #8D8D84;">*/</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">dentry</span> *<span style="color: #BA36A5;">d_parent</span>;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">parent directory</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#25991;&#20214;&#30340;&#21517;&#31216;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">qstr</span> <span style="color: #BA36A5;">d_name</span>;

  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span> <span style="color: #BA36A5;">d_lru</span>;   <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">LRU list</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">   * d_child and d_rcu can share memory</span>
<span style="color: #8D8D84;">   */</span>
  <span style="color: #0000FF;">union</span> <span style="color: #7388D6;">{</span>
    <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span> <span style="color: #BA36A5;">d_child</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">child of parent list</span><span style="color: #8D8D84;"> */</span>
    <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">rcu_head</span> <span style="color: #BA36A5;">d_rcu</span>;
  <span style="color: #7388D6;">}</span> <span style="color: #BA36A5;">d_u</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#23376;&#30446;&#24405;/&#25991;&#20214;&#30340;&#30446;&#24405;&#39033;&#38142;&#34920;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span> <span style="color: #BA36A5;">d_subdirs</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">our children</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#38142;&#34920;&#20803;&#32032;&#65292;&#29992;&#20110;&#23558;dentry&#36830;&#25509;&#21040;inode&#30340;i_dentry&#38142;&#34920;&#20013;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span> <span style="color: #BA36A5;">d_alias</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">inode alias list</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #BA36A5;">d_time</span>;   <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">used by d_revalidate</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#23545;dentry&#23545;&#35937;&#30340;&#21508;&#31181;&#25805;&#20316;,&#35814;&#35265;&#19979;&#38754;&#20195;&#30721;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">dentry_operations</span> *<span style="color: #BA36A5;">d_op</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">dentry&#25152;&#23646;&#25991;&#20214;&#31995;&#32479;&#30340;&#36229;&#32423;&#22359;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">super_block</span> *<span style="color: #BA36A5;">d_sb</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">The root of the dentry tree</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">void</span> *<span style="color: #BA36A5;">d_fsdata</span>;     <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">fs-specific data</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#ifdef</span> CONFIG_PROFILING
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">dcookie_struct</span> *<span style="color: #BA36A5;">d_cookie</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">cookie, if any</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#endif</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">1&#34920;&#31034;&#24403;&#21069;dentry&#23545;&#35937;&#34920;&#31034;&#19968;&#20010;&#35013;&#36733;&#28857;&#65292;&#21542;&#21017;&#20026;0</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">d_mounted</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#21517;&#23383;&#27604;&#36739;&#30701;&#30340;&#35805;&#23384;&#22312;&#36825;&#65292;&#21152;&#36895;&#35775;&#38382;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">char</span> <span style="color: #BA36A5;">d_iname</span><span style="color: #7388D6;">[</span>DNAME_INLINE_LEN_MIN<span style="color: #7388D6;">]</span>;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">small names</span><span style="color: #8D8D84;"> */</span>
<span style="color: #707183;">}</span>;


<span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">dentry_operations</span> <span style="color: #707183;">{</span>
  <span style="color: #6434A3;">int</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">d_revalidate</span><span style="color: #7388D6;">)(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">dentry</span> *, <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">nameidata</span> *<span style="color: #7388D6;">)</span>;
  <span style="color: #6434A3;">int</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">d_hash</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">dentry</span> *, <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">qstr</span> *<span style="color: #7388D6;">)</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#27604;&#36739;&#20004;&#20010;dentry&#23545;&#35937;&#30340;&#25991;&#20214;&#21517;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">int</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">d_compare</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">dentry</span> *, <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">qstr</span> *, <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">qstr</span> *<span style="color: #7388D6;">)</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">d_count&#20026;0&#26102;&#35843;&#29992;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">int</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">d_delete</span><span style="color: #7388D6;">)(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">dentry</span> *<span style="color: #7388D6;">)</span>;
  <span style="color: #6434A3;">void</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">d_release</span><span style="color: #7388D6;">)(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">dentry</span> *<span style="color: #7388D6;">)</span>;
  <span style="color: #8D8D84;">/*  </span><span style="color: #8D8D84; font-style: italic;">&#20174;dentry&#23545;&#35937;&#20013;&#37322;&#25918;inode</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">void</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">d_iput</span><span style="color: #7388D6;">)(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">dentry</span> *, <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">inode</span> *<span style="color: #7388D6;">)</span>;
  <span style="color: #6434A3;">char</span> *<span style="color: #7388D6;">(</span>*<span style="color: #006699;">d_dname</span><span style="color: #7388D6;">)(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">dentry</span> *, <span style="color: #6434A3;">char</span> *, <span style="color: #6434A3;">int</span><span style="color: #7388D6;">)</span>;
<span style="color: #707183;">}</span>;
</pre>
</div>

<p>
内存中所有活动的dentry实例都保存在一个散列表中，该散列表使用全局变量dentry<sub>hashtable实现</sub>。
成为全局 <b>dentry散列表</b> 。
</p>

<p>
每个由VFS发送到底层实现的请求，都会导致创建一个新的dentry对象，以保存请求的结果。dentry对象
在内存中的组织，涉及下面两个部分：
</p>
<ol class="org-ol">
<li>全局dentry散列表 dentry<sub>hashtable</sub></li>
<li>一个LRU链表，用来移除不再使用的对象。该链表的表头是全局变量dentry<sub>unused,使用的链表元素</sub>
是dentry的d<sub>lru成员</sub>。</li>
</ol>
</div>
</li>
</ol>
</li>

<li><a id="org131b4d1"></a>处理VFS对象<br />
<ol class="org-ol">
<li><a id="orgab120b0"></a>文件系统操作<br />
<div class="outline-text-6" id="text-3-9-7-4-1">
<ol class="org-ol">
<li><p>
注册文件系统
内核通过register<sub>filesystem来向内核祖泽文件系统</sub>。该函数非常简单，所有注册的文件系统会
存于一个链表中，注册新文件系统时会扫描链表确认文件系统没有被注册过（否则返回错误），然后
把新文件系统挂在链表尾。每个文件系统的数据结构表示为：
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">file_system_type</span> <span style="color: #707183;">{</span>
  <span style="color: #0000FF;">const</span> <span style="color: #6434A3;">char</span> *<span style="color: #BA36A5;">name</span>;
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">fs_flags</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#20174;&#24213;&#23618;&#23384;&#20648;&#20171;&#36136;&#35835;&#21462;&#36229;&#32423;&#22359;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">int</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">get_sb</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">file_system_type</span> *, <span style="color: #6434A3;">int</span>,
                 <span style="color: #0000FF;">const</span> <span style="color: #6434A3;">char</span> *, <span style="color: #6434A3;">void</span> *, <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">vfsmount</span> *<span style="color: #7388D6;">)</span>;
  <span style="color: #6434A3;">void</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">kill_sb</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">super_block</span> *<span style="color: #7388D6;">)</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">module</span> *<span style="color: #BA36A5;">owner</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">file_system_type</span> * <span style="color: #BA36A5;">next</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#23545;&#20110;&#27599;&#20010;&#24050;&#32463;&#35013;&#36733;&#30340;&#25991;&#20214;&#31995;&#32479;&#65292;&#20869;&#23384;&#20013;&#37117;&#21019;&#24314;&#20102;&#19968;&#20010;&#36229;&#32423;&#32467;&#26500;,&#24182;&#25226;</span>
<span style="color: #8D8D84; font-style: italic;">     &#21516;&#31867;&#22411;&#30340;&#25152;&#26377;&#24050;&#35013;&#36733;&#25991;&#20214;&#31995;&#32479;&#25918;&#22312;&#27492;&#38142;&#34920;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span> <span style="color: #BA36A5;">fs_supers</span>;

  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">lock_class_key</span> <span style="color: #BA36A5;">s_lock_key</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">lock_class_key</span> <span style="color: #BA36A5;">s_umount_key</span>;

  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">lock_class_key</span> <span style="color: #BA36A5;">i_lock_key</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">lock_class_key</span> <span style="color: #BA36A5;">i_mutex_key</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">lock_class_key</span> <span style="color: #BA36A5;">i_mutex_dir_key</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">lock_class_key</span> <span style="color: #BA36A5;">i_alloc_sem_key</span>;
<span style="color: #707183;">}</span>;
</pre>
</div></li>

<li>装载和卸载
目录树的装载和卸载比仅仅注册文件系统复杂的多。
<ul class="org-ul">
<li><p>
vfsmount结构
unix采用了一种单一的文件系统层次结构，新的文件系统可以集成到其中：
</p>
<p>
<img src="reading/2020-11-19_18-35-31_screenshot.png" alt="2020-11-19_18-35-31_screenshot.png" />
图中就有三种文件系统，可以用 <b>mount</b> 命令查询目录树的各种文件系统的
装载情况.
</p>

<p>
每个装载的文件系统都有一个本地目录。在将文件系统装载到一个目录时，装载点
的内容被替换为即将装载的文件系统的相对根目录内容。前一个目录数据会被隐藏。
知道新的文件系统卸载才重新出现。每个装载的文件系统都对应于一个vfsmount
结构的实例：
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">vfsmount</span> <span style="color: #707183;">{</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span> <span style="color: #BA36A5;">mnt_hash</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#29238;&#25991;&#20214;&#31995;&#32479;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">vfsmount</span> *<span style="color: #BA36A5;">mnt_parent</span>;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">fs we are mounted on</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#24403;&#21069;&#25991;&#20214;&#31995;&#32479;&#30340;&#35013;&#36733;&#28857;&#22312;&#20854;&#29238;&#30446;&#24405;&#20013;&#30340;dentry&#32467;&#26500;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">dentry</span> *<span style="color: #BA36A5;">mnt_mountpoint</span>;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">dentry of mountpoint</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#25991;&#20214;&#31995;&#32479;&#26412;&#36523;&#30340;&#30456;&#23545;&#26681;&#30446;&#24405;, &#19982;&#19978;&#19968;&#34892;&#34920;&#31034;&#21516;&#19968;&#20010;&#30446;&#24405;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">dentry</span> *<span style="color: #BA36A5;">mnt_root</span>;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">root of the mounted tree</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#36229;&#32423;&#22359;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">super_block</span> *<span style="color: #BA36A5;">mnt_sb</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">pointer to superblock</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#23376;&#25991;&#20214;&#31995;&#32479;&#30340;&#38142;&#34920;&#34920;&#22836;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span> <span style="color: #BA36A5;">mnt_mounts</span>;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">list of children, anchored here</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#23376;&#25991;&#20214;&#31995;&#32479;&#30340;&#38142;&#34920;&#20803;&#32032;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span> <span style="color: #BA36A5;">mnt_child</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">and going through their mnt_child</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">mnt_flags</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">4 bytes hole on 64bits arches</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">char</span> *<span style="color: #BA36A5;">mnt_devname</span>;    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Name of device e.g. /dev/dsk/hda1</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#19968;&#20010;&#21629;&#21517;&#31354;&#38388;&#30340;&#25152;&#26377;&#35013;&#36733;&#30340;&#25991;&#20214;&#31995;&#32479;&#37117;&#20445;&#23384;&#22312;namespace-&gt;list&#38142;&#34920;&#20013;&#65292;&#36825;&#26159;&#35813;&#38142;&#34920;&#30340;&#20803;&#32032;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span> <span style="color: #BA36A5;">mnt_list</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#36830;&#25509;&#35013;&#36733;&#36807;&#26399;&#30340;&#20803;&#32032;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span> <span style="color: #BA36A5;">mnt_expire</span>;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">link in fs-specific expiry list</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#20849;&#20139;&#35013;&#36733;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span> <span style="color: #BA36A5;">mnt_share</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">circular list of shared mounts</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span> <span style="color: #BA36A5;">mnt_slave_list</span>;<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">list of slave mounts</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span> <span style="color: #BA36A5;">mnt_slave</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">slave list entry</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">vfsmount</span> *<span style="color: #BA36A5;">mnt_master</span>;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">slave is on master-&gt;mnt_slave_list</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">mnt_namespace</span> *<span style="color: #BA36A5;">mnt_ns</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">containing namespace</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">   * We put mnt_count &amp; mnt_expiry_mark at the end of struct vfsmount</span>
<span style="color: #8D8D84; font-style: italic;">   * to let these frequently modified fields in a separate cache line</span>
<span style="color: #8D8D84; font-style: italic;">   * (so that reads of mnt_flags wont ping-pong on SMP machines)</span>
<span style="color: #8D8D84;">   */</span>
  <span style="color: #6434A3;">atomic_t</span> <span style="color: #BA36A5;">mnt_count</span>;
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">mnt_expiry_mark</span>;    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">true if marked for expiry</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">mnt_pinned</span>;
<span style="color: #707183;">}</span>;
</pre>
</div></li>
<li><p>
超级块的管理
装载操作开始于 <b>超级块的读取</b>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">super_block</span> <span style="color: #707183;">{</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#38142;&#25509; *&#21516;&#19968;&#31867;&#22411;* &#30340;&#25152;&#26377;&#36229;&#32423;&#22359;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span>  <span style="color: #BA36A5;">s_list</span>;   <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Keep this first</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#25991;&#20214;&#31995;&#32479;&#25152;&#22312;&#22359;&#35774;&#22791;&#30340;&#20869;&#26680;&#20869;&#37096;&#32534;&#21495;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">dev_t</span>     <span style="color: #BA36A5;">s_dev</span>;    <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">search index; _not_ kdev_t</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#22359;&#38271;&#24230;&#65292;&#21333;&#20301;&#23383;&#33410;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span>   <span style="color: #BA36A5;">s_blocksize</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#21069;&#19968;&#20010;&#25104;&#21592;&#23545;2&#21462;&#23545;&#25968;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">char</span>   <span style="color: #BA36A5;">s_blocksize_bits</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">1&#34920;&#31034;&#36229;&#32423;&#24555;&#34987;&#25913;&#21464;&#65292;&#38656;&#35201;&#22238;&#20889;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">char</span>   <span style="color: #BA36A5;">s_dirt</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#25991;&#20214;&#31995;&#32479;&#21487;&#20197;&#22788;&#29702;&#30340;&#26368;&#22823;&#25991;&#20214;&#38271;&#24230;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span> <span style="color: #6434A3;">long</span>  <span style="color: #BA36A5;">s_maxbytes</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Max file size</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">file_system_type</span> *<span style="color: #BA36A5;">s_type</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#22788;&#29702;&#36229;&#32423;&#22359;&#30456;&#20851;&#25805;&#20316;&#30340;&#20989;&#25968;, &#23454;&#29616;&#30001;&#24213;&#23618;&#25991;&#20214;&#31995;&#32479;&#20195;&#30721;&#25552;&#20379;, &#35814;&#35265;&#21518;&#38754;&#20195;&#30721;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#23427;&#19981;&#20250;&#25913;&#21464;inode&#30340;&#20869;&#23481;&#65292;&#20294;&#20250;&#25511;&#21046;&#20174;&#24213;&#23618;&#25991;&#20214;&#31995;&#32479;&#23454;&#29616;&#33719;&#21462;&#21644;&#36820;&#22238;inode</span>
<span style="color: #8D8D84; font-style: italic;">     &#25968;&#25454;&#30340;&#26041;&#24335;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">const</span> <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">super_operations</span> *<span style="color: #BA36A5;">s_op</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">dquot_operations</span> *<span style="color: #BA36A5;">dq_op</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">quotactl_ops</span> *<span style="color: #BA36A5;">s_qcop</span>;
  <span style="color: #0000FF;">const</span> <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">export_operations</span> *<span style="color: #BA36A5;">s_export_op</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span>   <span style="color: #BA36A5;">s_flags</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">long</span>   <span style="color: #BA36A5;">s_magic</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#25226;&#36229;&#32423;&#22359;&#19982;&#20840;&#23616;&#26681;&#30446;&#24405;&#30340;dentry&#39033;&#32852;&#31995;&#36215;&#26469;. &#21487;&#29992;&#20110;&#26816;&#26597;&#25991;&#20214;&#31995;&#32479;&#26159;&#21542;&#24050;&#32463;</span>
<span style="color: #8D8D84; font-style: italic;">     &#35013;&#36733;&#65292; &#22914;&#26524;&#20026;NULL&#65292;&#21017;&#25991;&#20214;&#31995;&#32479;&#26159;&#19968;&#20010;&#20266;&#25991;&#20214;&#31995;&#32479;&#65292;&#21482;&#22312;&#20869;&#26680;&#20869;&#37096;&#21487;&#35265;&#12290;</span>
<span style="color: #8D8D84; font-style: italic;">     &#21542;&#21017;&#65292;&#35813;&#25991;&#20214;&#31995;&#32479;&#22312;&#29992;&#25143;&#31354;&#38388;&#20013;&#26159;&#21487;&#35265;&#30340;&#12290;</span><span style="color: #8D8D84;">*/</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">dentry</span>   *<span style="color: #BA36A5;">s_root</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">rw_semaphore</span> <span style="color: #BA36A5;">s_umount</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">mutex</span>    <span style="color: #BA36A5;">s_lock</span>;
  <span style="color: #6434A3;">int</span>     <span style="color: #BA36A5;">s_count</span>;
  <span style="color: #6434A3;">int</span>     <span style="color: #BA36A5;">s_syncing</span>;
  <span style="color: #6434A3;">int</span>     <span style="color: #BA36A5;">s_need_sync_fs</span>;
  <span style="color: #6434A3;">atomic_t</span>    <span style="color: #BA36A5;">s_active</span>;
<span style="color: #808080;">#ifdef</span> CONFIG_SECURITY
  <span style="color: #6434A3;">void</span>                    *<span style="color: #BA36A5;">s_security</span>;
<span style="color: #808080;">#endif</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#22788;&#29702;&#25193;&#23637;&#23646;&#24615;&#30340;&#20989;&#25968;&#25351;&#38024;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">xattr_handler</span>  **<span style="color: #BA36A5;">s_xattr</span>;

  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span>  <span style="color: #BA36A5;">s_inodes</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">all inodes</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#33039;inode&#38142;&#34920;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span>  <span style="color: #BA36A5;">s_dirty</span>;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">dirty inodes</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span>  <span style="color: #BA36A5;">s_io</span>;   <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">parked for writeback</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span>  <span style="color: #BA36A5;">s_more_io</span>;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">parked for more writeback</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">hlist_head</span> <span style="color: #BA36A5;">s_anon</span>;   <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">anonymous dentries for (nfs) exporting</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#36229;&#32423;&#22359;&#30340;&#25991;&#20214;&#31995;&#32479;&#19978;&#25152;&#26377;&#25171;&#24320;&#30340;&#25991;&#20214;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span>  <span style="color: #BA36A5;">s_files</span>;

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#25351;&#21521;&#20869;&#23384;&#20013;&#30340;block_device&#32467;&#26500;&#25351;&#38024;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">block_device</span> *<span style="color: #BA36A5;">s_bdev</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">mtd_info</span>   *<span style="color: #BA36A5;">s_mtd</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span>  <span style="color: #BA36A5;">s_instances</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">quota_info</span> <span style="color: #BA36A5;">s_dquot</span>;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Diskquota specific options</span><span style="color: #8D8D84;"> */</span>

  <span style="color: #6434A3;">int</span>     <span style="color: #BA36A5;">s_frozen</span>;
  <span style="color: #6434A3;">wait_queue_head_t</span> <span style="color: #BA36A5;">s_wait_unfrozen</span>;

  <span style="color: #6434A3;">char</span> <span style="color: #BA36A5;">s_id</span><span style="color: #7388D6;">[</span><span style="color: #D0372D;">32</span><span style="color: #7388D6;">]</span>;        <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Informational name</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#25351;&#21521;&#25991;&#20214;&#31995;&#32479;&#23454;&#29616;&#30340; &#31169;&#26377;&#25968;&#25454;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">void</span>      *<span style="color: #BA36A5;">s_fs_info</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Filesystem private info</span><span style="color: #8D8D84;"> */</span>

  <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">   * The next field is for VFS *only*. No filesystems have any business</span>
<span style="color: #8D8D84; font-style: italic;">   * even looking at it. You had been warned.</span>
<span style="color: #8D8D84;">   */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">mutex</span> <span style="color: #BA36A5;">s_vfs_rename_mutex</span>;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Kludge</span><span style="color: #8D8D84;"> */</span>

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Granularity of c/m/atime in ns.</span>
<span style="color: #8D8D84; font-style: italic;">     Cannot be worse than a second</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#25991;&#20214;&#31995;&#32479;&#25903;&#25345;&#30340;&#26102;&#38388;&#30340;&#26368;&#22823;&#21487;&#33021;&#31890;&#24230;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">u32</span>      <span style="color: #BA36A5;">s_time_gran</span>;

  <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">   * Filesystem subtype.  If non-empty the filesystem type field</span>
<span style="color: #8D8D84; font-style: italic;">   * in /proc/mounts will be "type.subtype"</span>
<span style="color: #8D8D84;">   */</span>
  <span style="color: #6434A3;">char</span> *<span style="color: #BA36A5;">s_subtype</span>;
<span style="color: #707183;">}</span>;


<span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;"> * </span><span style="color: #d0bf8f;">NOTE</span><span style="color: #8D8D84; font-style: italic;">: write_inode, delete_inode, clear_inode, put_inode can be called</span>
<span style="color: #8D8D84; font-style: italic;"> * without the big kernel lock held in all filesystems.</span>
<span style="color: #8D8D84;"> */</span>
<span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">super_operations</span> <span style="color: #707183;">{</span>
    <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">inode</span> *<span style="color: #7388D6;">(</span>*<span style="color: #006699;">alloc_inode</span><span style="color: #7388D6;">)(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">super_block</span> *<span style="color: #BA36A5;">sb</span><span style="color: #7388D6;">)</span>;
  <span style="color: #6434A3;">void</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">destroy_inode</span><span style="color: #7388D6;">)(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">inode</span> *<span style="color: #7388D6;">)</span>;

  <span style="color: #6434A3;">void</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">read_inode</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">inode</span> *<span style="color: #7388D6;">)</span>;

    <span style="color: #6434A3;">void</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">dirty_inode</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">inode</span> *<span style="color: #7388D6;">)</span>;
  <span style="color: #6434A3;">int</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">write_inode</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">inode</span> *, <span style="color: #6434A3;">int</span><span style="color: #7388D6;">)</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#36827;&#31243;&#32467;&#26463;&#25968;&#25454;&#30340;&#20351;&#29992;&#26102;&#65292;put_inode&#23558;inode&#20351;&#29992;&#35745;&#25968;&#22120;&#20943;&#19968;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">void</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">put_inode</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">inode</span> *<span style="color: #7388D6;">)</span>;
  <span style="color: #6434A3;">void</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">drop_inode</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">inode</span> *<span style="color: #7388D6;">)</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#23558;inode&#20174;&#20869;&#23384;&#21644;&#24213;&#23618;&#23384;&#20648;&#20171;&#36136;&#21024;&#38500;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">void</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">delete_inode</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">inode</span> *<span style="color: #7388D6;">)</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#23558;&#36229;&#32423;&#22359;&#30340;&#31169;&#26377;&#20449;&#24687;&#20174;&#20869;&#23384;&#31227;&#38500;,&#21457;&#29983;&#22312;&#25991;&#20214;&#31995;&#32479;&#21368;&#36733;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">void</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">put_super</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">super_block</span> *<span style="color: #7388D6;">)</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#23558;&#36229;&#32423;&#22359;&#20889;&#20837;&#23384;&#20648;&#20171;&#36136;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">void</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">write_super</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">super_block</span> *<span style="color: #7388D6;">)</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#23558;&#25991;&#20214;&#31995;&#32479;&#25968;&#25454;&#19982;&#24213;&#23618;&#22359;&#35774;&#22791;&#19978;&#30340;&#25968;&#25454;&#21516;&#27493;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">int</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">sync_fs</span><span style="color: #7388D6;">)(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">super_block</span> *<span style="color: #BA36A5;">sb</span>, <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">wait</span><span style="color: #7388D6;">)</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#23558;&#36229;&#32423;&#22359;&#20889;&#20837;&#23384;&#20648;&#20171;&#36136;,&#19982;write_super&#21306;&#21035;&#22312;&#20110;&#20351;&#29992;&#20869;&#26680;&#38145;&#26426;&#21046;&#30340;&#26041;&#24335;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">void</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">write_super_lockfs</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">super_block</span> *<span style="color: #7388D6;">)</span>;
  <span style="color: #6434A3;">void</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">unlockfs</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">super_block</span> *<span style="color: #7388D6;">)</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#25991;&#20214;&#31995;&#32479;&#30340;&#32479;&#35745;&#20449;&#24687;&#65292;&#22914;&#26410;&#20351;&#29992;&#30340;&#25968;&#25454;&#22359;&#30340;&#25968;&#30446;&#65292;&#25991;&#20214;&#21517;&#30340;&#26368;&#22823;&#38271;&#24230;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">int</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">statfs</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">dentry</span> *, <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">kstatfs</span> *<span style="color: #7388D6;">)</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#20174;&#26032;&#35013;&#36733;&#19968;&#20010;&#24050;&#32463;&#35013;&#36733;&#30340;&#25991;&#20214;&#31995;&#32479;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">int</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">remount_fs</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">super_block</span> *, <span style="color: #6434A3;">int</span> *, <span style="color: #6434A3;">char</span> *<span style="color: #7388D6;">)</span>;
  <span style="color: #6434A3;">void</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">clear_inode</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">inode</span> *<span style="color: #7388D6;">)</span>;
  <span style="color: #6434A3;">void</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">umount_begin</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">vfsmount</span> *, <span style="color: #6434A3;">int</span><span style="color: #7388D6;">)</span>;

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#29992;&#20110;proc&#25991;&#20214;&#31995;&#32479;&#65292;&#26174;&#31034;&#25991;&#20214;&#31995;&#32479;&#35013;&#36733;&#30340;&#36873;&#39033;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">int</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">show_options</span><span style="color: #7388D6;">)(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">seq_file</span> *, <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">vfsmount</span> *<span style="color: #7388D6;">)</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#25552;&#20379;&#20102;&#25991;&#20214;&#31995;&#32479;&#30340;&#32479;&#35745;&#20449;&#24687;&#65292;&#29992;&#20110;proc&#25991;&#20214;&#31995;&#32479;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">int</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">show_stats</span><span style="color: #7388D6;">)(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">seq_file</span> *, <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">vfsmount</span> *<span style="color: #7388D6;">)</span>;
<span style="color: #808080;">#ifdef</span> CONFIG_QUOTA
  <span style="color: #6434A3;">ssize_t</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">quota_read</span><span style="color: #7388D6;">)(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">super_block</span> *, <span style="color: #6434A3;">int</span>, <span style="color: #6434A3;">char</span> *, <span style="color: #6434A3;">size_t</span>, <span style="color: #6434A3;">loff_t</span><span style="color: #7388D6;">)</span>;
  <span style="color: #6434A3;">ssize_t</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">quota_write</span><span style="color: #7388D6;">)(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">super_block</span> *, <span style="color: #6434A3;">int</span>, <span style="color: #0000FF;">const</span> <span style="color: #6434A3;">char</span> *, <span style="color: #6434A3;">size_t</span>, <span style="color: #6434A3;">loff_t</span><span style="color: #7388D6;">)</span>;
<span style="color: #808080;">#endif</span>
<span style="color: #707183;">}</span>;
</pre>
</div></li>
<li><p>
mount系统调用
</p>

<div id="org6ec546b" class="figure">
<p><img src="reading/2020-11-19_19-50-19_screenshot.png" alt="2020-11-19_19-50-19_screenshot.png" />
</p>
</div></li>

<li><p>
umount系统调用
</p>

<div id="org9b3d80e" class="figure">
<p><img src="reading/2020-11-19_19-59-43_screenshot.png" alt="2020-11-19_19-59-43_screenshot.png" />
</p>
</div></li>
</ul></li>
</ol>
</div>
</li>

<li><a id="org63c93f1"></a>文件操作<br />
<div class="outline-text-6" id="text-3-9-7-4-2">
<ol class="org-ol">
<li><p>
查找inode
</p>

<p>
内核使用path<sub>lookup函数查找路径或文件名,nameidata结构用了向查找函数传递参数并保存结果</sub>
</p>
<div class="org-src-container">
<pre class="src src-c">
<span style="color: #6434A3;">int</span> <span style="color: #006699;">fastcall</span> path_lookup<span style="color: #707183;">(</span><span style="color: #0000FF;">const</span> <span style="color: #6434A3;">char</span> *<span style="color: #BA36A5;">name</span>, <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">flags</span>,
                         <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">nameidata</span> *<span style="color: #BA36A5;">nd</span><span style="color: #707183;">)</span>
<span style="color: #707183;">{</span>
  <span style="color: #0000FF;">return</span> do_path_lookup<span style="color: #7388D6;">(</span>AT_FDCWD, name, flags, nd<span style="color: #7388D6;">)</span>;
<span style="color: #707183;">}</span>

<span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">nameidata</span> <span style="color: #707183;">{</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">dentry</span> *<span style="color: #BA36A5;">dentry</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">vfsmount</span> *<span style="color: #BA36A5;">mnt</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#38656;&#35201;&#26597;&#25214;&#30340;&#21517;&#31216;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">qstr</span> <span style="color: #BA36A5;">last</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span>  <span style="color: #BA36A5;">flags</span>;
  <span style="color: #6434A3;">int</span>   <span style="color: #BA36A5;">last_type</span>;
  <span style="color: #6434A3;">unsigned</span>  <span style="color: #BA36A5;">depth</span>;
  <span style="color: #6434A3;">char</span> *<span style="color: #BA36A5;">saved_names</span><span style="color: #7388D6;">[</span>MAX_NESTED_LINKS + <span style="color: #D0372D;">1</span><span style="color: #7388D6;">]</span>;

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Intent data</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">union</span> <span style="color: #7388D6;">{</span>
    <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">open_intent</span> <span style="color: #BA36A5;">open</span>;
  <span style="color: #7388D6;">}</span> <span style="color: #BA36A5;">intent</span>;
<span style="color: #707183;">}</span>;

</pre>
</div>
<p>
查找的核心函数为_<sub>link</sub><sub>path</sub><sub>walk</sub>:
</p>

<div id="org0d709d8" class="figure">
<p><img src="reading/2020-11-19_21-06-11_screenshot.png" alt="2020-11-19_21-06-11_screenshot.png" />
</p>
</div>

<div id="org3d71116" class="figure">
<p><img src="reading/2020-11-19_21-39-06_screenshot.png" alt="2020-11-19_21-39-06_screenshot.png" />
</p>
</div></li>

<li><p>
打开文件
</p>

<div id="orgcf83775" class="figure">
<p><img src="reading/2020-11-19_21-40-24_screenshot.png" alt="2020-11-19_21-40-24_screenshot.png" />
</p>
</div>

<div id="org69d8811" class="figure">
<p><img src="reading/2020-11-19_21-41-40_screenshot.png" alt="2020-11-19_21-41-40_screenshot.png" />
</p>
</div></li>

<li><p>
读取和写入
</p>

<div id="orgd513d08" class="figure">
<p><img src="reading/2020-11-19_21-43-44_screenshot.png" alt="2020-11-19_21-43-44_screenshot.png" />
</p>
</div></li>
</ol>
</div>
</li>
</ol>
</li>

<li><a id="org636b345"></a>标准函数<br />
<div class="outline-text-5" id="text-3-9-7-5">
<p>
VFS层为所有文件系统提供了同一的标准函数。
</p>
<ol class="org-ol">
<li><p>
通用读取例程
</p>
<p>
<img src="reading/2020-11-19_22-23-27_screenshot.png" alt="2020-11-19_22-23-27_screenshot.png" />
其中的aio<sub>read通常指向generic</sub><sub>file</sub><sub>aio</sub><sub>read中</sub>：
</p>

<div id="org249556d" class="figure">
<p><img src="reading/2020-11-19_22-25-22_screenshot.png" alt="2020-11-19_22-25-22_screenshot.png" />
</p>
</div>
<ul class="org-ul">
<li><p>
从映射读取
</p>
<p>
<img src="reading/2020-11-19_22-27-23_screenshot.png" alt="2020-11-19_22-27-23_screenshot.png" />
如果预读机制没能将所需的页读入内存，那么由no<sub>cached</sub><sub>page直接进行读取操作</sub>
</p>

<div id="orga536e68" class="figure">
<p><img src="reading/2020-11-19_22-30-58_screenshot.png" alt="2020-11-19_22-30-58_screenshot.png" />
</p>
</div></li>
</ul></li>
<li>失效机制 TODO</li>
<li>权限检查 TODO</li>
</ol>
</div>
</li>
</ol>
</div>

<div id="outline-container-org21cb0b8" class="outline-4">
<h4 id="org21cb0b8"><span class="section-number-4">3.9.8</span> <span class="todo TODO">TODO</span> Ext文件系统族</h4>
</div>
<div id="outline-container-org2e2aa1a" class="outline-4">
<h4 id="org2e2aa1a"><span class="section-number-4">3.9.9</span> 无持久存储的文件系统</h4>
<div class="outline-text-4" id="text-3-9-9">
</div>
<ol class="org-ol">
<li><a id="orgaa6c864"></a>proc文件系统<br />
<div class="outline-text-5" id="text-3-9-9-1">
<p>
使用proc文件系统，可以获得有关内核各子系统的信息（如内存利用率，附接的外设等），也可以在
不重复编译内核的情况下修改内核的行为。与该文件系统密切相关的是系统控制机制（sysctl）。
</p>
</div>

<ol class="org-ol">
<li><a id="org00ee3e2"></a>/proc的内容<br />
<div class="outline-text-6" id="text-3-9-9-1-1">
<p>
/proc的内容可以分为以下几大类：
</p>
<ul class="org-ul">
<li>内存管理</li>
<li>系统进程的特征数据</li>
<li>文件系统</li>
<li>设备驱动程序</li>
<li>系统总线</li>
<li>电源管理</li>
<li>终端</li>
<li>系统控制参数</li>

<li>特定于进程的数据
每个系统进程，无论当前状态如何，都有一个对应的子目录（与PID同名），包含了该进程
的有关信息。</li>
<li>一般性系统信息
/proc本身也包含了一些信息，与指定的内核子系统无关（或几个子系统共享）的一般性信息，
一般存放在/proc下的文件中</li>
<li>网络信息
/proc/net子目录提供了内核的各种网络选项的有关数据。其中保存了各种协议和设备数据，如：
<ul class="org-ul">
<li>udp和tcp提供了IPv4的UDP和TCP套接字的统计数据</li>
<li>用于反向地址解析的ARP表，可以在arp文件中查看</li>
<li>dev保存了通过系统的网络接口传输的数据量的统计数据。该信息可用于检查网络的传输质量</li>
</ul></li>
<li>系统控制参数
用于动态地检查和修改内核行为的系统控制参数，在proc文件系统的数据项中，属于最多的一部分。
也可以通过sysctl系统调用来修改。sysctl参数由一个独立的子目录/proc/sys管理，它进一步
划分为各种子目录，对应于内核的各个子系统。</li>
</ul>
</div>
</li>

<li><a id="org9fd5090"></a>数据结构<br />
<div class="outline-text-6" id="text-3-9-9-1-2">
<ol class="org-ol">
<li><p>
proc数据项
proc文件系统中的每个数据项都由proc<sub>dir</sub><sub>entry的一个实例描述</sub>：
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">proc_dir_entry</span> <span style="color: #707183;">{</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">inode&#32534;&#21495;</span><span style="color: #8D8D84;">*/</span>
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">low_ino</span>;
  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">short</span> <span style="color: #BA36A5;">namelen</span>;
  <span style="color: #0000FF;">const</span> <span style="color: #6434A3;">char</span> *<span style="color: #BA36A5;">name</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#25968;&#25454;&#39033;&#30340;&#31867;&#22411;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">mode_t</span> <span style="color: #BA36A5;">mode</span>;
  <span style="color: #6434A3;">nlink_t</span> <span style="color: #BA36A5;">nlink</span>;
  <span style="color: #6434A3;">uid_t</span> <span style="color: #BA36A5;">uid</span>;
  <span style="color: #6434A3;">gid_t</span> <span style="color: #BA36A5;">gid</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#25991;&#20214;&#38271;&#24230;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">loff_t</span> <span style="color: #BA36A5;">size</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#19979;&#38754;&#20004;&#20010;&#25805;&#20316;&#26159;&#23545;inode&#21644;&#25991;&#20214;&#30340;&#25805;&#20316;&#65292;&#20805;&#24403;&#19982;&#34394;&#25311;&#25991;&#20214;&#31995;&#32479;&#20043;&#38388;&#30340;&#25509;&#21475;,&#25152;</span>
<span style="color: #8D8D84; font-style: italic;">     &#20351;&#29992;&#30340;&#25805;&#20316;&#20381;&#36182;&#20855;&#20307;&#30340;&#25991;&#20214;&#31867;&#22411;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">const</span> <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">inode_operations</span> *<span style="color: #BA36A5;">proc_iops</span>;
  <span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">   * NULL -&gt;proc_fops means "PDE is going away RSN" or</span>
<span style="color: #8D8D84; font-style: italic;">   * "PDE is just created". In either case, e.g. -&gt;read_proc won't be</span>
<span style="color: #8D8D84; font-style: italic;">   * called because it's too late or too early, respectively.</span>
<span style="color: #8D8D84; font-style: italic;">   *</span>
<span style="color: #8D8D84; font-style: italic;">   * If you're allocating -&gt;proc_fops dynamically, save a pointer</span>
<span style="color: #8D8D84; font-style: italic;">   * somewhere.</span>
<span style="color: #8D8D84;">   */</span>
  <span style="color: #0000FF;">const</span> <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">file_operations</span> *<span style="color: #BA36A5;">proc_fops</span>;


  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#30456;&#20851;&#23376;&#31995;&#32479;&#20013;&#36820;&#22238;&#25152;&#38656;&#25968;&#25454;&#30340;&#20363;&#31243;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">get_info_t</span> *<span style="color: #BA36A5;">get_info</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">module</span> *<span style="color: #BA36A5;">owner</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">proc_dir_entry</span> *<span style="color: #BA36A5;">next</span>, *<span style="color: #BA36A5;">parent</span>, *<span style="color: #BA36A5;">subdir</span>;
  <span style="color: #6434A3;">void</span> *<span style="color: #BA36A5;">data</span>;
  <span style="color: #6434A3;">read_proc_t</span> *<span style="color: #BA36A5;">read_proc</span>;
  <span style="color: #6434A3;">write_proc_t</span> *<span style="color: #BA36A5;">write_proc</span>;
  <span style="color: #6434A3;">atomic_t</span> <span style="color: #BA36A5;">count</span>;   <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">use count</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">pde_users</span>;  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">number of callers into module in progress</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">spinlock_t</span> <span style="color: #BA36A5;">pde_unload_lock</span>; <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">proc_fops checks and pde_users bumps</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">completion</span> *<span style="color: #BA36A5;">pde_unload_completion</span>;
  <span style="color: #6434A3;">shadow_proc_t</span> *<span style="color: #BA36A5;">shadow_proc</span>;
<span style="color: #707183;">}</span>;
</pre>
</div></li>

<li><p>
proc inode
内核提供了一个proc<sub>inode数据结构</sub>，支持以面向inode的方式来查看proc文件系统的数据项：
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">proc_inode</span> <span style="color: #707183;">{</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#25351;&#21521;&#36827;&#31243;&#30340;pid&#23454;&#20363;&#65292;&#29992;&#20110;&#35775;&#38382;&#22823;&#37327;&#29305;&#23450;&#36827;&#31243;&#30340;&#20449;&#24687;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">pid</span> *<span style="color: #BA36A5;">pid</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#23545;&#24212;&#20110;/proc/&lt;pid&gt;/fd/&#20013;&#30340;&#26576;&#20010;&#25991;&#20214;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">fd</span>;
  <span style="color: #0000FF;">union</span> <span style="color: #6434A3;">proc_op</span> <span style="color: #BA36A5;">op</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#20851;&#32852;&#21040;proc&#25968;&#25454;&#39033;&#30340;proc_dir_entry&#23454;&#20363;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">proc_dir_entry</span> *<span style="color: #BA36A5;">pde</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">VFS inode&#23454;&#20363;&#65292;&#27880;&#24847;&#19981;&#26159;&#25351;&#38024;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">inode</span> <span style="color: #BA36A5;">vfs_inode</span>;
<span style="color: #707183;">}</span>;

<span style="color: #0000FF;">union</span> <span style="color: #6434A3;">proc_op</span> <span style="color: #707183;">{</span>
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#29992;&#20110;&#33719;&#24471;&#29305;&#23450;&#20110;&#36827;&#31243;&#30340;&#20449;&#24687;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">int</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">proc_get_link</span><span style="color: #7388D6;">)(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">inode</span> *, <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">dentry</span> **, <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">vfsmount</span> **<span style="color: #7388D6;">)</span>;
  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">&#29992;&#20110;&#22312;&#34394;&#25311;&#25991;&#20214;&#31995;&#32479;&#20013;&#24314;&#31435;&#38142;&#25509;&#65292;&#25351;&#21521;&#29305;&#23450;&#36827;&#31243;&#30340;&#25968;&#25454;</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">int</span> <span style="color: #7388D6;">(</span>*<span style="color: #006699;">proc_read</span><span style="color: #7388D6;">)(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">task_struct</span> *<span style="color: #BA36A5;">task</span>, <span style="color: #6434A3;">char</span> *<span style="color: #BA36A5;">page</span><span style="color: #7388D6;">)</span>;
<span style="color: #707183;">}</span>;
</pre>
</div>
<p>
可以通过辅助函数PROC<sub>I来根据vfs</sub> inode获取proc inode：
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #0000FF;">static</span> <span style="color: #0000FF;">inline</span> <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">proc_inode</span> *<span style="color: #006699;">PROC_I</span><span style="color: #707183;">(</span><span style="color: #0000FF;">const</span> <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">inode</span> *<span style="color: #BA36A5;">inode</span><span style="color: #707183;">)</span>
<span style="color: #707183;">{</span>
  <span style="color: #0000FF;">return</span> container_of<span style="color: #7388D6;">(</span>inode, <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">proc_inode</span>, vfs_inode<span style="color: #7388D6;">)</span>;
<span style="color: #707183;">}</span>
</pre>
</div>

<div id="org132977c" class="figure">
<p><img src="reading/2020-11-20_10-39-52_screenshot.png" alt="2020-11-20_10-39-52_screenshot.png" />
</p>
</div></li>

<li><p>
初始化
</p>

<div id="org2e6374e" class="figure">
<p><img src="reading/2020-11-20_11-08-05_screenshot.png" alt="2020-11-20_11-08-05_screenshot.png" />
</p>
</div></li>

<li>TODO 装载</li>

<li>管理/proc数据项
<ul class="org-ul">
<li>创建和注册 TODO</li>
<li><p>
查找proc数据项
</p></li>
</ul></li>
<li>读取和写入信息
<ul class="org-ul">
<li><p>
proc<sub>file</sub><sub>read</sub>
</p>

<div id="org12c8eaa" class="figure">
<p><img src="reading/2020-11-20_11-53-42_screenshot.png" alt="2020-11-20_11-53-42_screenshot.png" />
</p>
</div></li>

<li><p>
proc<sub>file</sub><sub>write</sub>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #0000FF;">static</span> <span style="color: #6434A3;">ssize_t</span>
<span style="color: #006699;">proc_file_write</span><span style="color: #707183;">(</span><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">file</span> *<span style="color: #BA36A5;">file</span>, <span style="color: #0000FF;">const</span> <span style="color: #6434A3;">char</span> <span style="color: #BA36A5;">__user</span> *buffer,
                <span style="color: #6434A3;">size_t</span> <span style="color: #BA36A5;">count</span>, <span style="color: #6434A3;">loff_t</span> *<span style="color: #BA36A5;">ppos</span><span style="color: #707183;">)</span>
<span style="color: #707183;">{</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">inode</span> *<span style="color: #BA36A5;">inode</span> = file-&gt;f_path.dentry-&gt;d_inode;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">proc_dir_entry</span> * <span style="color: #BA36A5;">dp</span>;

  dp = PDE<span style="color: #7388D6;">(</span>inode<span style="color: #7388D6;">)</span>;

  <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>!dp-&gt;write_proc<span style="color: #7388D6;">)</span>
    <span style="color: #0000FF;">return</span> -EIO;

  <span style="color: #8D8D84;">/* </span><span style="color: #cc9393;">FIXME</span><span style="color: #8D8D84; font-style: italic;">: does this routine need ppos?  probably...</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">return</span> dp-&gt;write_proc<span style="color: #7388D6;">(</span>file, buffer, count, dp-&gt;data<span style="color: #7388D6;">)</span>;
<span style="color: #707183;">}</span>
</pre>
</div>

<div id="orgb74cf9f" class="figure">
<p><img src="reading/2020-11-20_11-55-50_screenshot.png" alt="2020-11-20_11-55-50_screenshot.png" />
</p>
</div></li>
</ul></li>

<li>进程相关信息 TODO</li>
</ol>
</div>
</li>
</ol>
</li>
</ol>
</div>

<div id="outline-container-orgb5436f5" class="outline-4">
<h4 id="orgb5436f5"><span class="section-number-4">3.9.10</span> 内核活动</h4>
<div class="outline-text-4" id="text-3-9-10">
</div>
<ol class="org-ol">
<li><a id="orgc39a55e"></a>等待队列<br />
<div class="outline-text-5" id="text-3-9-10-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">__wait_queue_head</span> <span style="color: #707183;">{</span>
  <span style="color: #6434A3;">spinlock_t</span> <span style="color: #BA36A5;">lock</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">list_head</span> <span style="color: #BA36A5;">task_list</span>;
<span style="color: #707183;">}</span>;
<span style="color: #0000FF;">typedef</span> <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">__wait_queue_head</span> <span style="color: #6434A3;">wait_queue_head_t</span>;
</pre>
</div>
</div>
</li>
<li><a id="org191ead2"></a>互斥量和条件变量等的实现机制<br />
<div class="outline-text-5" id="text-3-9-10-2">
<p>
用到了等待队列
</p>
<div class="org-src-container">
<pre class="src src-c">
<span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;"> * We use this hashed waitqueue instead of a normal wait_queue_t, so</span>
<span style="color: #8D8D84; font-style: italic;"> * we can wake only the relevant ones (hashed queues may be shared).</span>
<span style="color: #8D8D84; font-style: italic;"> *</span>
<span style="color: #8D8D84; font-style: italic;"> * A futex_q has a woken state, just like tasks have TASK_RUNNING.</span>
<span style="color: #8D8D84; font-style: italic;"> * It is considered woken when plist_node_empty(&amp;q-&gt;list) || q-&gt;lock_ptr == 0.</span>
<span style="color: #8D8D84; font-style: italic;"> * The order of wakup is always to make the first condition true, then</span>
<span style="color: #8D8D84; font-style: italic;"> * wake up q-&gt;waiters, then make the second condition true.</span>
<span style="color: #8D8D84;"> */</span>
<span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">futex_q</span> <span style="color: #707183;">{</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">plist_node</span> <span style="color: #BA36A5;">list</span>;
  <span style="color: #6434A3;">wait_queue_head_t</span> <span style="color: #BA36A5;">waiters</span>;

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Which hash list lock to use:</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">spinlock_t</span> *<span style="color: #BA36A5;">lock_ptr</span>;

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Key which the futex is hashed on:</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">union</span> <span style="color: #6434A3;">futex_key</span> <span style="color: #BA36A5;">key</span>;

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">For fd, sigio sent using these:</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">fd</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">file</span> *<span style="color: #BA36A5;">filp</span>;

  <span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Optional priority inheritance state:</span><span style="color: #8D8D84;"> */</span>
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">futex_pi_state</span> *<span style="color: #BA36A5;">pi_state</span>;
  <span style="color: #0000FF;">struct</span> <span style="color: #6434A3;">task_struct</span> *<span style="color: #BA36A5;">task</span>;
<span style="color: #707183;">}</span>;
</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div id="outline-container-org9e80248" class="outline-3">
<h3 id="org9e80248"><span class="section-number-3">3.10</span> unix&amp;Linux大学教程</h3>
<div class="outline-text-3" id="text-3-10">
</div>
<div id="outline-container-org048f78f" class="outline-4">
<h4 id="org048f78f"><span class="section-number-4">3.10.1</span> reference</h4>
<div class="outline-text-4" id="text-3-10-1">
<p>
Go To Statement Considered Harmful - Edsger Dijkstra
</p>
<ul class="org-ul">
<li>在Internet上，有两种非常常见的主机类型，不需要终端：
<ol class="org-ol">
<li>Web服务器</li>
<li>路由器</li>
</ol></li>
<li>pwd
print working directory</li>
<li>封闭eof信号
shell默认会在按下<sup>D时退出</sup>，可以通过给IGNOREEOF设置一个值来表明必须按这么多次<sup>D才能</sup>
退出shell</li>
<li>修改键绑定
stty 信号名称 新的键</li>
<li>系统中查找程序
which, type, whence</li>
<li><p>
显示时间和日历
时间：
</p>
<div class="org-src-container">
<pre class="src src-shell">date
date -u <span style="color: #707183;">&#65288;</span>&#26684;&#26519;&#23041;&#27835;<span style="color: #707183;">&#65289;</span>
</pre>
</div>
<p>
日历：
</p>
<div class="org-src-container">
<pre class="src src-shell">cal
cal -j <span style="color: #707183;">(</span>&#19968;&#24180;&#20013;&#30340;&#31532;&#20960;&#22825;<span style="color: #707183;">)</span>

~/org &#10095;&#10095;&#10095; cal -j                                                        <span style="color: #D0372D;">20:55:08</span>
&#21313;&#19968;&#26376; <span style="color: #D0372D;">2020</span>
&#26085;  &#19968;  &#20108;  &#19977;  &#22235;  &#20116;  &#20845;
<span style="color: #D0372D;">306</span> <span style="color: #D0372D;">307</span> <span style="color: #D0372D;">308</span> <span style="color: #D0372D;">309</span> <span style="color: #D0372D;">310</span> <span style="color: #D0372D;">311</span> <span style="color: #D0372D;">312</span>
<span style="color: #D0372D;">313</span> <span style="color: #D0372D;">314</span> <span style="color: #D0372D;">315</span> <span style="color: #D0372D;">316</span> <span style="color: #D0372D;">317</span> <span style="color: #D0372D;">318</span> <span style="color: #D0372D;">319</span>
<span style="color: #D0372D;">320</span> <span style="color: #D0372D;">321</span> <span style="color: #D0372D;">322</span> <span style="color: #D0372D;">323</span> <span style="color: #D0372D;">324</span> <span style="color: #D0372D;">325</span> <span style="color: #D0372D;">326</span>
<span style="color: #D0372D;">327</span> <span style="color: #D0372D;">328</span> <span style="color: #D0372D;">329</span> <span style="color: #D0372D;">330</span> <span style="color: #D0372D;">331</span> <span style="color: #D0372D;">332</span> <span style="color: #D0372D;">333</span>
<span style="color: #D0372D;">334</span> <span style="color: #D0372D;">335</span>
</pre>
</div></li>
<li><p>
日程提醒
当前目录创建一个calendar文件，calendar命令会在当前文件夹查找calendar文件，并显示所有
拥有今天或明天日期的文本行
</p>
<div class="org-src-container">
<pre class="src src-shell">~/org &#10095;&#10095;&#10095; cat calendar                                                  <span style="color: #D0372D;">21:19:25</span>
Nov <span style="color: #D0372D;">21</span>  snigefjdsinageadsghef
~/org &#10095;&#10095;&#10095; calendar                                                      <span style="color: #D0372D;">21:19:28</span>
<span style="color: #D0372D;">11</span> <span style="color: #D0372D;">21*</span>  snigefjdsinageadsghef
</pre>
</div></li>
<li>查看系统信息
<ol class="org-ol">
<li><p>
uptime(运行时间)
</p>
<div class="org-src-container">
<pre class="src src-shell">~/org &#10095;&#10095;&#10095; uptime                                                        <span style="color: #D0372D;">21:19:37</span>
<span style="color: #D0372D;">21:20</span>  up <span style="color: #D0372D;">11</span> days, <span style="color: #D0372D;">23:31,</span> <span style="color: #D0372D;">3</span> users, load averages: <span style="color: #D0372D;">1.57</span> <span style="color: #D0372D;">1.79</span> <span style="color: #D0372D;">1.91</span>

&#24403;&#21069;&#26102;&#38388;    &#36816;&#34892;&#20102;11&#22825;23&#26102;31&#20998;&#65292; <span style="color: #D0372D;">3&#20010;&#29992;&#25143;&#30331;&#38470;</span>   <span style="color: #D0372D;">1&#65292;5&#65292;15&#20998;&#38047;&#30340;&#24179;&#22343;&#36127;&#36733;</span>
</pre>
</div></li>

<li>查看机器名称 hostname</li>
<li>查看操作系统名称 uname &lt;-a(ll)&gt;</li>
<li>查看用户名 whoami
who am i</li>
</ol></li>
<li><p>
获取其他用户信息users，who，w(ho is doing what)
</p>
<div class="org-src-container">
<pre class="src src-shell">~/org &#10095;&#10095;&#10095; users                                                         <span style="color: #D0372D;">21:36:13</span>
binbinyang
~/org &#10095;&#10095;&#10095; who                                                           <span style="color: #D0372D;">21:37:39</span>
binbinyang console  Nov  <span style="color: #D0372D;">9</span> <span style="color: #D0372D;">21:48</span>
binbinyang ttys000  Nov <span style="color: #D0372D;">21</span> <span style="color: #D0372D;">21:36</span>
binbinyang ttys004  Nov  <span style="color: #D0372D;">9</span> <span style="color: #D0372D;">21:48</span>
~/org &#10095;&#10095;&#10095; w                                                             <span style="color: #D0372D;">21:37:45</span>
<span style="color: #D0372D;">21:37</span>  up <span style="color: #D0372D;">11</span> days, <span style="color: #D0372D;">23:49,</span> <span style="color: #D0372D;">3</span> users, load averages: <span style="color: #D0372D;">2.40</span> <span style="color: #D0372D;">2.18</span> <span style="color: #D0372D;">2.04</span>
USER     TTY      FROM              LOGIN@  IDLE WHAT
binbinyang console  -                <span style="color: #D0372D;">091120</span>  <span style="color: #D0372D;">11days</span> -
binbinyang s004     -                <span style="color: #D0372D;">091120</span>      - w
binbinyang s000     -                <span style="color: #D0372D;">21:36</span>       <span style="color: #D0372D;">1</span> -fish
</pre>
</div></li>
<li>设置临时提醒 leave</li>
<li><p>
计数器bc
sqrt()
s()   sin
c()   cos
a()   arctan
ln()
</p>

<p>
scale=3(设置小数点为3位，默认0位）
ibase = 8  以基8输入数字
obase = 16 以基16显示答案
</p></li>
<li>man手册
<ol class="org-ol">
<li>命令</li>
<li>系统调用</li>
<li>库函数</li>
<li>特殊文件</li>
<li>文件格式</li>
<li>游戏</li>
<li>杂项信息</li>
<li>系统管理</li>
</ol></li>
<li><p>
搜索命令 apropos
当我们知道想做什么，但是想不起来用那条命令时，可以用
</p>
<div class="org-src-container">
<pre class="src src-shell">man -k<span style="color: #707183;">(</span>eyword<span style="color: #707183;">)</span>
apropos
</pre>
</div>
<p>
这两个命令
</p></li>
<li>info
获取GNU项目的信息</li>
</ul>
</div>
</div>
<div id="outline-container-orgddcfd4c" class="outline-4">
<h4 id="orgddcfd4c"><span class="section-number-4">3.10.2</span> 命令语法 命令名称 选项 参数 <b>**</b> 选项 也称开关（switches）或标志（flags。 通常由一个连字符后跟一个字母或者两个连字符跟一个单词组成。 也可以把多个单字符组合在一起。 <b>**</b> 规则 1. 方括号中的项是可选的 2. 不在方括号中的项是必选项，必须作为命令的一部分 3. 黑体字必须原样输入 4. 非黑体字必须用适当的值代替 5. 后面接省略号的参数可以重复任意多次（包括0） 6. <b>如果一个单独选项和一个参数结合在一起，那么该选项和参数必须同时使用</b> #+begin<sub>src</sub> shell man  [-acdfFhkKtwW]  [&#x2013;path]  [-m system] [-p string] [-C config<sub>file</sub>] [-M pathlist] [-P pager] [-B browser] [-H htmlpager] [-S  section<sub>list</sub>] [section] name &#x2026; #+end<sub>src</sub> 7. 由｜字符分开的两个或多个选项，表示可以从这个列表中选择一个项 who [-<b>abdHilmpqrstTu</b> ] [file | arg1 arg2] <b>*</b> 环境变量与shell变量(bash) 在日常的交互式工作中，重要的是环境变量，而不是shell变量 - 显示默认环境变量： env/printenv - 显示shell变量 set - 创建变量 1. shell变量 创建shell变量语法为： NAME=value 如果希望使用一个包含空白符的值，则需要将值放在双引号中: #+begin<sub>src</sub> shell WEEDLY="a cool cat" #+end<sub>src</sub> 2. 环境变量 可以使用export命令将变量导出到环境中： #+begin<sub>src</sub> shell export NAME[=value]&#x2026; # HARLEY WEEDLY同时由shell变量变为"shell+环境"变量 export HARLEY WEEDLY # 同时设置了PAGER变量并导出到环境中 export PAGER=less #+end<sub>src</sub> 可以用unset（复位）删除变量： #+begin<sub>src</sub> shell unset NAME&#x2026; #+end<sub>src</sub> 可以使用下面命令修改命令行提示符： #+begin<sub>src</sub> shell export PS1="我的提示符" #+end<sub>src</sub></h4>
</div>
<div id="outline-container-orgfa0fb49" class="outline-4">
<h4 id="orgfa0fb49"><span class="section-number-4">3.10.3</span> 第13章 使用shell：命令和定制</h4>
<div class="outline-text-4" id="text-3-10-3">
</div>
<ol class="org-ol">
<li><a id="org6a5cc08"></a>元字符<br />
<div class="outline-text-5" id="text-3-10-3-1">
<p>
使用时除了通常意义的 <b>字母数字字符</b>, 还有一些表示特殊含义的字符，我们称
这样的字符为 <b>元字符</b> 。shell中使用的元字符有：
</p>

<div id="org325c15a" class="figure">
<p><img src="reading/2020-11-22_14-13-10_screenshot.png" alt="2020-11-22_14-13-10_screenshot.png" />
</p>
</div>
</div>
</li>
<li><a id="orgc0dc3d1"></a>引用和转义<br />
<div class="outline-text-5" id="text-3-10-3-2">
<p>
shell中有三种方法可以对元字符进行转义:
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">1 &#20351;&#29992;&#21453;&#26012;&#26438;&#24341;&#29992;&#21333;&#20010;&#23383;&#31526;</span>
<span style="color: #006FE0;">echo</span> It is warm and sunny<span style="color: #008000;">\;</span> come over and visit
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">2 &#20351;&#29992;&#21333;&#24341;&#21495;&#24341;&#29992;&#19968;&#20018;&#23383;&#31526;</span>
<span style="color: #006FE0;">echo</span> <span style="color: #008000;">'It is warm (and sunny); come over &amp; visit'</span>
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">3 &#20351;&#29992;&#21452;&#24341;&#21495;&#24341;&#29992;&#19968;&#20018;&#23383;&#31526;&#65288;&#20445;&#30041;$, `(&#29992;&#20110;&#21629;&#20196;&#23884;&#22871;) &#21644; \ &#30340;&#29305;&#27530;&#21547;&#20041;</span>
<span style="color: #006FE0;">echo</span> <span style="color: #008000;">"My userid is &lt;$USER&gt;; my terminal is &lt;$Term&gt;"</span>

</pre>
</div>
</div>
</li>
<li><a id="org5cb093a"></a>命令类型（内部和外部）<br />
<div class="outline-text-5" id="text-3-10-3-3">
<div class="org-src-container">
<pre class="src src-shell">~/org &#10095;&#10095;&#10095; type date time set                                            <span style="color: #D0372D;">13:49:43</span>
date is /bin/date
time is a builtin
<span style="color: #006FE0;">set</span> is a builtin
</pre>
</div>
<p>
内部命令可以使用help命令来获取帮助,shell会根据PATH变量查找外部命令,向PATH加路径的命令为:
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #006FE0;">export</span> <span style="color: #BA36A5;">PATH</span>=<span style="color: #008000;">"$PATH:$HOME/bin"</span>
</pre>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-orgeea8315" class="outline-4">
<h4 id="orgeea8315"><span class="section-number-4">3.10.4</span> 第14章 初始化文件</h4>
<div class="outline-text-4" id="text-3-10-4">
<p>
环境文件(初始化文件)的名称都以rc结尾，如.bashrc,.mailrc. rc表示 <b>run commands</b> ，运行命令，也就是
特定程序每次启动时自动运行的命令。
</p>
</div>
</div>
<div id="outline-container-org35a5315" class="outline-4">
<h4 id="org35a5315"><span class="section-number-4">3.10.5</span> 15章</h4>
<div class="outline-text-4" id="text-3-10-5">
<p>
tee - T型链接器：
</p>
<div class="org-src-container">
<pre class="src src-shell">cat a b c | tee d | greap e
</pre>
</div>
</div>
</div>

<div id="outline-container-org6428c3c" class="outline-4">
<h4 id="org6428c3c"><span class="section-number-4">3.10.6</span> 16章 过滤器</h4>
<div class="outline-text-4" id="text-3-10-6">
<p>
过滤器就是任何能够从标准输入读取文本数据并向标准输出写入文本数据（每次一行）的程序。
管道中的第一个和最后一个程序不必是过滤器。
最有用的过滤器列表：
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">过滤器</th>
<th scope="col" class="org-right">章号</th>
<th scope="col" class="org-left">参阅</th>
<th scope="col" class="org-left">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">awk</td>
<td class="org-right">-</td>
<td class="org-left">perl</td>
<td class="org-left">编程语言：操作文本</td>
</tr>

<tr>
<td class="org-left">cat</td>
<td class="org-right">16</td>
<td class="org-left">split,tac,rev</td>
<td class="org-left">组合文件：复制标准输入到标准输出</td>
</tr>

<tr>
<td class="org-left">colrm</td>
<td class="org-right">16</td>
<td class="org-left">cut,join,paste</td>
<td class="org-left">删除指定的数据列</td>
</tr>

<tr>
<td class="org-left">comm</td>
<td class="org-right">17</td>
<td class="org-left">cmp,diff,sdiff</td>
<td class="org-left">比较两个有序文件，显示区别</td>
</tr>

<tr>
<td class="org-left">cmp</td>
<td class="org-right">17</td>
<td class="org-left">cmmm,diff,sdiff</td>
<td class="org-left">比较两个有序文，</td>
</tr>

<tr>
<td class="org-left">cut</td>
<td class="org-right">17</td>
<td class="org-left">colrm,join,paste</td>
<td class="org-left">从数据中抽取指定的列（字段）</td>
</tr>

<tr>
<td class="org-left">diff</td>
<td class="org-right">17</td>
<td class="org-left">cmp,comm,sdiff</td>
<td class="org-left">比较两个有序文件，显示区别</td>
</tr>

<tr>
<td class="org-left">expand</td>
<td class="org-right">18</td>
<td class="org-left">unexpand</td>
<td class="org-left">将制表符转换为空格</td>
</tr>

<tr>
<td class="org-left">fold</td>
<td class="org-right">18</td>
<td class="org-left">fmt，pr</td>
<td class="org-left">将长行格式化为较短的行</td>
</tr>

<tr>
<td class="org-left">fmt</td>
<td class="org-right">18</td>
<td class="org-left">fold，pr</td>
<td class="org-left">格式化段落，从而使它们看上去更漂亮</td>
</tr>

<tr>
<td class="org-left">grep</td>
<td class="org-right">19</td>
<td class="org-left">look，strings</td>
<td class="org-left">选择包含指定模式的行</td>
</tr>

<tr>
<td class="org-left">head</td>
<td class="org-right">16</td>
<td class="org-left">tail</td>
<td class="org-left">从数据的开头选择行</td>
</tr>

<tr>
<td class="org-left">join</td>
<td class="org-right">19</td>
<td class="org-left">colrm，cut，paste</td>
<td class="org-left">基于公用字段，组合数据列</td>
</tr>

<tr>
<td class="org-left">look</td>
<td class="org-right">19</td>
<td class="org-left">greap</td>
<td class="org-left">选择以指定模式开头的行</td>
</tr>

<tr>
<td class="org-left">nl</td>
<td class="org-right">18</td>
<td class="org-left">wc</td>
<td class="org-left">创建行号</td>
</tr>

<tr>
<td class="org-left">paste</td>
<td class="org-right">17</td>
<td class="org-left">colrm，cut，join</td>
<td class="org-left">组合数据列</td>
</tr>

<tr>
<td class="org-left">perl</td>
<td class="org-right">-</td>
<td class="org-left">awk</td>
<td class="org-left">编程语言：操作文本，文件，进程</td>
</tr>

<tr>
<td class="org-left">pr</td>
<td class="org-right">18</td>
<td class="org-left">fold，fmt</td>
<td class="org-left">将文本格式化为页或者列</td>
</tr>

<tr>
<td class="org-left">rev</td>
<td class="org-right">16</td>
<td class="org-left">cat，tac</td>
<td class="org-left">每行数据中的字符反序排练</td>
</tr>

<tr>
<td class="org-left">sdiff</td>
<td class="org-right">17</td>
<td class="org-left">cmp，comm，diff</td>
<td class="org-left">比较两个文件，显示区别</td>
</tr>

<tr>
<td class="org-left">sed</td>
<td class="org-right">19</td>
<td class="org-left">tr</td>
<td class="org-left">非交互式文本编辑</td>
</tr>

<tr>
<td class="org-left">sort</td>
<td class="org-right">19</td>
<td class="org-left">tsort，uniq</td>
<td class="org-left">排序数据，检查数据是否有序</td>
</tr>

<tr>
<td class="org-left">split</td>
<td class="org-right">16</td>
<td class="org-left">cat</td>
<td class="org-left">将大文件分隔成较小的文件</td>
</tr>

<tr>
<td class="org-left">strings</td>
<td class="org-right">19</td>
<td class="org-left">grep</td>
<td class="org-left">在二进制文件中搜索字符串</td>
</tr>

<tr>
<td class="org-left">tac</td>
<td class="org-right">16</td>
<td class="org-left">cat，rev</td>
<td class="org-left">组合文件，同时将文本行的顺序反转</td>
</tr>

<tr>
<td class="org-left">tail</td>
<td class="org-right">16</td>
<td class="org-left">head</td>
<td class="org-left">从数据的末尾选择行</td>
</tr>

<tr>
<td class="org-left">tr</td>
<td class="org-right">19</td>
<td class="org-left">sed</td>
<td class="org-left">改变或者删除选定的字符</td>
</tr>

<tr>
<td class="org-left">tsort</td>
<td class="org-right">19</td>
<td class="org-left">sort</td>
<td class="org-left">根据偏序创建全序</td>
</tr>

<tr>
<td class="org-left">unexpand</td>
<td class="org-right">18</td>
<td class="org-left">expand</td>
<td class="org-left">将空格转变成制表符</td>
</tr>

<tr>
<td class="org-left">uniq</td>
<td class="org-right">19</td>
<td class="org-left">sort</td>
<td class="org-left">选择重复/唯一行</td>
</tr>

<tr>
<td class="org-left">wc</td>
<td class="org-right">18</td>
<td class="org-left">nl</td>
<td class="org-left">统计行数，单词数和字符数</td>
</tr>
</tbody>
</table>
</div>

<ol class="org-ol">
<li><a id="org549d729"></a>cat(catenate,chain的拉丁单词)<br />
<div class="outline-text-5" id="text-3-10-6-1">
<p>
-n(unmber) , 在每行前面加一个行号
-b(lank), 和-n一起用，不要对空白行算编号
-s(queeze), 将多个连续空白行替换为一个空白行
</p>
</div>
</li>
<li><a id="org441425a"></a>tac<br />
<div class="outline-text-5" id="text-3-10-6-2">
<div class="org-src-container">
<pre class="src src-shell">&#35774;log&#25991;&#20214;&#20026;&#65306;
<span style="color: #D0372D;">01</span>
<span style="color: #D0372D;">02</span>
<span style="color: #D0372D;">03</span>
<span style="color: #D0372D;">04</span>
&#37027;&#20040;tac log&#20026;
<span style="color: #D0372D;">04</span>
<span style="color: #D0372D;">03</span>
<span style="color: #D0372D;">02</span>
<span style="color: #D0372D;">01</span>
</pre>
</div>
<p>
与less配合很好用
</p>
</div>
</li>
<li><a id="orgaac7262"></a>rev<br />
<div class="outline-text-5" id="text-3-10-6-3">
<div class="org-src-container">
<pre class="src src-shell">~ &#10095;&#10095;&#10095; cat log; rev log                                                  <span style="color: #D0372D;">19:56:27</span>
<span style="color: #D0372D;">01</span>
<span style="color: #D0372D;">02</span>
<span style="color: #D0372D;">03</span>
<span style="color: #D0372D;">04</span>

<span style="color: #D0372D;">10</span>
<span style="color: #D0372D;">20</span>
<span style="color: #D0372D;">30</span>
<span style="color: #D0372D;">40</span>
</pre>
</div>
</div>
</li>

<li><a id="orged5c0dd"></a>colrm<br />
<div class="outline-text-5" id="text-3-10-6-4">

<div id="orgf86094c" class="figure">
<p><img src="reading/2020-11-22_20-08-46_screenshot.png" alt="2020-11-22_20-08-46_screenshot.png" />
</p>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-org8c7960f" class="outline-4">
<h4 id="org8c7960f"><span class="section-number-4">3.10.7</span> 17章</h4>
<div class="outline-text-4" id="text-3-10-7">
</div>
<ol class="org-ol">
<li><a id="org19b86a5"></a>cut<br />
<div class="outline-text-5" id="text-3-10-7-1">
<div class="org-src-container">
<pre class="src src-shell">cut -c list <span style="color: #707183;">[</span>file...<span style="color: #707183;">]</span>  &#20197;&#23383;&#31526;&#20998;&#38548;
cut -f list <span style="color: #707183;">[</span>-d deliniter<span style="color: #707183;">]</span> <span style="color: #707183;">[</span>-s<span style="color: #707183;">]</span> <span style="color: #707183;">[</span>file...<span style="color: #707183;">]</span> &#20197;&#23383;&#27573;&#20998;&#38548;
list:&#35201;&#25277;&#21462;&#30340;&#21015;&#30340;&#21015;&#34920;
deliniter:&#20998;&#38548;&#31526;
<span style="color: #D0372D;">1,8,10&#34920;&#31034;&#21462;&#31532;1,8,10&#21015;&#23383;&#31526;</span>
<span style="color: #D0372D;">10-15&#34920;&#31034;&#25277;&#21462;&#31532;10&#21015;&#21040;&#31532;15&#21015;</span>
&#20063;&#21487;&#20197;&#32852;&#21512;&#36215;&#26469;&#20351;&#29992;&#65292;&#22914;1&#65292;8&#65292;10-15
</pre>
</div>
</div>
</li>
<li><a id="org2e1ea5e"></a>paste<br />
<div class="outline-text-5" id="text-3-10-7-2">
<div class="org-src-container">
<pre class="src src-shell">paste <span style="color: #707183;">[</span>-d char...<span style="color: #707183;">]</span> <span style="color: #707183;">[</span>file...<span style="color: #707183;">]</span>
&#32452;&#21512;&#20998;&#31163;&#30340;&#25991;&#20214;
char:&#20998;&#38548;&#31526;
file:&#36755;&#20837;&#25991;&#20214;&#30340;&#21517;&#31216;
</pre>
</div>

<div id="org2653772" class="figure">
<p><img src="reading/2020-11-22_23-12-40_screenshot.png" alt="2020-11-22_23-12-40_screenshot.png" />
</p>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-orgcea1af0" class="outline-4">
<h4 id="orgcea1af0"><span class="section-number-4">3.10.8</span> 18章 统计和格式化</h4>
<div class="outline-text-4" id="text-3-10-8">
</div>
<ol class="org-ol">
<li><a id="org93c1884"></a>nl 创建行号<br />
<div class="outline-text-5" id="text-3-10-8-1">
<div class="org-src-container">
<pre class="src src-shell">nl <span style="color: #707183;">[</span>-v start<span style="color: #707183;">]</span> <span style="color: #707183;">[</span>-i increment<span style="color: #707183;">]</span> <span style="color: #707183;">[</span>-b a<span style="color: #707183;">]</span> <span style="color: #707183;">[</span>-n ln|rn|rz<span style="color: #707183;">]</span> <span style="color: #707183;">[</span>file...<span style="color: #707183;">]</span>
&#20854;&#20013;start&#26159;&#34892;&#21495;&#65292;increment&#26159;&#22686;&#37327;&#65292;file&#26159;&#25991;&#20214;&#30340;&#21517;&#31216;
</pre>
</div>
</div>
</li>
<li><a id="orge9a294b"></a>wc<br />
<div class="outline-text-5" id="text-3-10-8-2">
<p>
wc [-clLw] [file&#x2026;]
-c(har)
-l(ine)
-w(rods)
-L(ongest)
</p>
</div>
</li>

<li><a id="orgb234a19"></a>fold 格式化行<br />
<div class="outline-text-5" id="text-3-10-8-3">
<p>
fold [-s] [-w width] [file&#x2026;]
width 新行的宽度
-s 不分割单词
</p>

<div id="orga18c039" class="figure">
<p><img src="reading/2020-11-23_10-20-43_screenshot.png" alt="2020-11-23_10-20-43_screenshot.png" />
</p>
</div>
</div>
</li>

<li><a id="orga11cadb"></a>fmt 格式化段落<br />
<div class="outline-text-5" id="text-3-10-8-4">
<p>
fmt [-su] [-w width] [file&#x2026;]
-u(niform spacing) 合并多个空格
-s(plit only) 只拆分长行，不连接短行
</p>
</div>
</li>

<li><a id="org469684f"></a>pr 按页格式化文本<br />
<div class="outline-text-5" id="text-3-10-8-5">
<p>
目的是将文本格式化为适合打印的页
</p>
</div>
</li>
</ol>
</div>
<div id="outline-container-org09646a4" class="outline-4">
<h4 id="org09646a4"><span class="section-number-4">3.10.9</span> 19章 选取，排序，组合及变换</h4>
<div class="outline-text-4" id="text-3-10-9">
</div>
<ol class="org-ol">
<li><a id="orgceb94d4"></a>grep grep中的re表示regular expression, g代表global，p代表print<br />
<div class="outline-text-5" id="text-3-10-9-1">
<p>
grep [-cilLnrsvwx] pattern [file&#x2026;]
-c(ount)
-i(gnore) 忽略大小写
-n(umber) 行号
-l(ist filename) 将包含模式的文件名输出
-L               将不包含模式的文件名输出
-v(reverse)      选取不包含指定模式的所有行
-x               完全与搜索模式匹配的行
-w               准确匹配单词(如 grep -w now file,那么know就是不匹配)
-r(ecursive)     搜索整个目录树
-s(uppress，抑制) 不输出错误信息
</p>
</div>
</li>
<li><a id="org812d634"></a>look<br />
<div class="outline-text-5" id="text-3-10-9-2">
<p>
搜索以 <b>字母顺序排列(用的二分查找)</b> 的数据，并查找所有以特定模式开头的行
look 不是一个过滤器，所以不能在管道中间
look与grep的区别：look要求排序，所以速度快(因为现在cpu很快，所以一般用grep)
look [-df] pattern file&#x2026;
-d(ictionary)   只考虑字母和数字的排序
-f(old,同等)     忽略大小写的区别
</p>
</div>
</li>

<li><a id="org7965cd3"></a>sort<br />
<div class="outline-text-5" id="text-3-10-9-3">
<p>
排序数据以及查看数据是否已经有序
sort非常灵活，既可以比较整行，也可以从每行中选取部分进行比较
sort [-dfnru] [-o outfile] [infile&#x2026;]
</p>

<div id="org8731907" class="figure">
<p><img src="reading/2020-11-23_11-25-00_screenshot.png" alt="2020-11-23_11-25-00_screenshot.png" />
</p>
</div>

<p>
-d(ictionary)   同look
-f(old)         同look
-n(umeric)      识别行开头或字段开头的数字，按这些数字排序
-r(everse)      反向排序
-u(nique)       去重
-c(heck)        只查看是否有序(输出为从第几行开始无序)
</p>
</div>
</li>

<li><a id="org905ab33"></a>uniq<br />
<div class="outline-text-5" id="text-3-10-9-4">
<p>
<b>uniq要求输入有序</b>
uniq可以完成四个任务：
</p>
<ol class="org-ol">
<li>消除重复行</li>
<li>选取重复行(-d)</li>
<li>选取唯一行(-u)</li>
<li>统计重复行的数量(-c)</li>
</ol>

<p>
uniq [-cdu] [infile [outfile]]
</p>
</div>
</li>

<li><a id="orgdb47f40"></a>join<br />
<div class="outline-text-5" id="text-3-10-9-5">
<p>
和数据库sql的join有点类似
join [-i] [-a1|v1] [-a2|v2] [-1 field1] [-2 field2] file1 file2
-i(gnore)
-a(ll)
-v(reverse)
-1/2      指定file1/2中的字段(field1/2)连接
</p>
</div>
</li>
<li><a id="org22a025f"></a>sed(stream editor) 非交互式文本编辑<br />
<div class="outline-text-5" id="text-3-10-9-6">
<p>
sed [-i] command | -e command&#x2026; [file&#x2026;]
-i(n-place)      原地修改文件
</p>

<p>
在允许搜索和替换操作的程序中，一般都使用替换为空来达到删除效果
</p>

<div id="orgc0ae7c1" class="figure">
<p><img src="reading/2020-11-23_13-24-26_screenshot.png" alt="2020-11-23_13-24-26_screenshot.png" />
</p>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-orgcb9d5f1" class="outline-4">
<h4 id="orgcb9d5f1"><span class="section-number-4">3.10.10</span> 20章 正则表达式</h4>
<div class="outline-text-4" id="text-3-10-10">
<p>
ref: <a href="https://www.runoob.com/regexp/regexp-syntax.html">https://www.runoob.com/regexp/regexp-syntax.html</a>
</p>
</div>
<ol class="org-ol">
<li><a id="org17ae296"></a>普通字符<br />
<div class="outline-text-5" id="text-3-10-10-1">

<div id="orgf877d1c" class="figure">
<p><img src="reading/2020-11-23_14-08-25_screenshot.png" alt="2020-11-23_14-08-25_screenshot.png" />
</p>
</div>

<div id="org8792e68" class="figure">
<p><img src="reading/2020-11-23_14-09-00_screenshot.png" alt="2020-11-23_14-09-00_screenshot.png" />
</p>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-org6318960" class="outline-4">
<h4 id="org6318960"><span class="section-number-4">3.10.11</span> 23章 文件系统(569页)</h4>
<div class="outline-text-4" id="text-3-10-11">
</div>
<ol class="org-ol">
<li><a id="org9ad6736"></a>文件类型<br />
<div class="outline-text-5" id="text-3-10-11-1">
<ol class="org-ol">
<li>普通文件</li>
<li>目录</li>
<li><p>
伪文件
其中最重要的是特殊文件，也称设备文件, 其他的还有命名管道，proc文件
设备文件：
</p>

<div id="org44aed3d" class="figure">
<p><img src="reading/2020-11-23_14-38-20_screenshot.png" alt="2020-11-23_14-38-20_screenshot.png" />
</p>
</div>

<p>
proc文件：
</p>

<div id="org8c2e454" class="figure">
<p><img src="reading/2020-11-23_14-39-36_screenshot.png" alt="2020-11-23_14-39-36_screenshot.png" />
</p>
</div></li>
</ol>
</div>
</li>

<li><a id="orgd0c4b50"></a>根目录内容<br />
<div class="outline-text-5" id="text-3-10-11-2">

<div id="org1320a15" class="figure">
<p><img src="reading/2020-11-23_15-09-07_screenshot.png" alt="2020-11-23_15-09-07_screenshot.png" />
</p>
</div>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">目录</th>
<th scope="col" class="org-left">内容</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">/dev</td>
<td class="org-left">所有的特殊文件，还包含一个makedev程序来创建新的特殊文件</td>
</tr>

<tr>
<td class="org-left">/etc</td>
<td class="org-left">配置文件。配置文件是某程序启动时处理的文本文件，其中包含影响程序操作的命令或信息,与rc文件类似</td>
</tr>

<tr>
<td class="org-left">/home</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">/lib</td>
<td class="org-left">包含/bin和/sbin目录中的程序所需的基本库和内核模块</td>
</tr>

<tr>
<td class="org-left">/media</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">/mnt</td>
<td class="org-left">不会在其他位置挂载的固定介质的挂载点</td>
</tr>

<tr>
<td class="org-left">/opt</td>
<td class="org-left">optional software 安装第三方应用程序的位置。每个程序都根据自己的需要拥有自己的子目录。</td>
</tr>

<tr>
<td class="org-left">/sbin</td>
<td class="org-left">system binaries，系统二进制文件。存放用于系统管理的程序，通常这些程序必须由超级用户运行</td>
</tr>

<tr>
<td class="org-left">/srv</td>
<td class="org-left">为本地服务保留的（cgi，web，ftp，cvs，rsync）</td>
</tr>

<tr>
<td class="org-left">/tmp</td>
<td class="org-left">临时文件，内容将自动移除</td>
</tr>

<tr>
<td class="org-left">/usr</td>
<td class="org-left">辅助文件系统，用来放静态数据（即没有管理员干涉不会改变的数据）。</td>
</tr>

<tr>
<td class="org-left">/var</td>
<td class="org-left">variable，用来存放可变数据，如日志文件，打印文件，电子邮件等</td>
</tr>
</tbody>
</table>
</div>
</li>

<li><a id="org20e9c3f"></a>/usr 目录<br />
<div class="outline-text-5" id="text-3-10-11-3">

<div id="org4541f97" class="figure">
<p><img src="reading/2020-11-23_15-32-03_screenshot.png" alt="2020-11-23_15-32-03_screenshot.png" />
</p>
</div>

<ul class="org-ul">
<li>/usr/bin : 系统中大多数程序的存放位置，比/bin多很多。</li>
<li>/usr/include： 头文件存储区。</li>
<li>/usr/lib：和/lib功能一样</li>
<li>/usr/local：为系统管理员准备，系统管理员使用它来支持本地用户。存放本地程序和文档资料。
将软件存放在这里可以确保在系统升级时，不会覆盖软件。</li>
<li>/usr/sbin: 同/sbin</li>
<li>/usr/share：存放需要在用户和程序之间共享的文件</li>
<li>/usr/src: 这个目录可以发现一些包含系统源代码的子目录，如linux源代码位于/usr/src/linux中</li>
</ul>
</div>
</li>
<li><a id="org46fc083"></a>使用多个目录存放程序的原因<br />
<div class="outline-text-5" id="text-3-10-11-4">
<p>
可以看到，文件系统存在很多存放同类内容的目录，如/bin和/usr/bin等。
这主要是由于历史原因造成的。以前内存很小，所以把最重要的程序放在根目录下，
等启动引导完成后，再把/usr挂载进来.
</p>

<div id="orgfa2c230" class="figure">
<p><img src="reading/2020-11-24_11-44-44_screenshot.png" alt="2020-11-24_11-44-44_screenshot.png" />
</p>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-orgfeb03b4" class="outline-4">
<h4 id="orgfeb03b4"><span class="section-number-4">3.10.12</span> 24章 目录操作</h4>
<div class="outline-text-4" id="text-3-10-12">
</div>
<ol class="org-ol">
<li><a id="orgfc4dca1"></a>检查文件类型<br />
<ol class="org-ol">
<li><a id="org087c6f1"></a>ls -F(lag)<br />
<div class="outline-text-6" id="text-3-10-12-1-1">

<div id="org63a85b2" class="figure">
<p><img src="reading/2020-11-24_13-06-52_screenshot.png" alt="2020-11-24_13-06-52_screenshot.png" />
</p>
</div>
</div>
</li>
<li><a id="org13f2d33"></a>file<br />
<div class="outline-text-6" id="text-3-10-12-1-2">
<p>
file [name&#x2026;]
</p>
</div>
</li>
</ol>
</li>

<li><a id="orga079d46"></a>掌握磁盘空间的情况<br />
<ol class="org-ol">
<li><a id="orgbf6d8da"></a>ls -s(ize)[h(uman-readable)] 单位KB<br />
<div class="outline-text-6" id="text-3-10-12-2-1">
<p>
查看文件使用磁盘空间的情况
</p>
<div class="org-src-container">
<pre class="src src-shell">~/org &#10095;&#10095;&#10095; ls -s                                                         <span style="color: #D0372D;">13:16:07</span>
total <span style="color: #D0372D;">640</span>
<span style="color: #D0372D;">8</span> calendar       <span style="color: #D0372D;">8</span> macinit.org    <span style="color: #D0372D;">0</span> reading/
<span style="color: #D0372D;">8</span> leetcode.c   <span style="color: #D0372D;">616</span> notes.org
</pre>
</div>
</div>
</li>
<li><a id="org738a853"></a>du(disk usage)<br />
<div class="outline-text-6" id="text-3-10-12-2-2">
<p>
du [-achs] [name&#x2026;]
-h(uman-readable)
-s(um)
-c(ount)
-a(ll)
</p>
<div class="org-src-container">
<pre class="src src-shell">~/org &#10095;&#10095;&#10095; du -s                                                         <span style="color: #D0372D;">13:27:57</span>
<span style="color: #D0372D;">133600</span>  .
~/org &#10095;&#10095;&#10095; du -sh                                                        <span style="color: #D0372D;">13:28:09</span>
<span style="color: #D0372D;">65M</span> .
~/org &#10095;&#10095;&#10095; du -shc                                                       <span style="color: #D0372D;">13:28:19</span>
<span style="color: #D0372D;">65M</span> .
<span style="color: #D0372D;">65M</span> total
</pre>
</div>
</div>
</li>
<li><a id="orge019d7c"></a>df(disk free-space)<br />
<div class="outline-text-6" id="text-3-10-12-2-3">
<p>
-h(uman-readable)
</p>
</div>
</li>
</ol>
</li>
<li><a id="org0ed5cd6"></a>通配符(p.631)<br />
<div class="outline-text-5" id="text-3-10-12-3">
<p>
通配符只用一种用途：在键入一条命令时匹配一组文件名
</p>
<p>
<img src="reading/2020-11-24_13-45-25_screenshot.png" alt="2020-11-24_13-45-25_screenshot.png" />
花括号扩展： <b>{,}</b>
</p>
</div>
</li>
</ol>
</div>
<div id="outline-container-orged07584" class="outline-4">
<h4 id="orged07584"><span class="section-number-4">3.10.13</span> 25章 文件操作</h4>
<div class="outline-text-4" id="text-3-10-13">
</div>
<ol class="org-ol">
<li><a id="org9915bf9"></a>find<br />
<ol class="org-ol">
<li><a id="orgcc8a9a8"></a>语法：<br />
<div class="outline-text-6" id="text-3-10-13-1-1">
<p>
<b>find path&#x2026; test&#x2026; action&#x2026;</b>
一旦输入该命令，find就会遵循一个3个步骤的处理过程：
</p>

<div id="org4d0aaa5" class="figure">
<p><img src="reading/2020-11-24_14-16-46_screenshot.png" alt="2020-11-24_14-16-46_screenshot.png" />
</p>
</div>
</div>
</li>

<li><a id="org368e483"></a>test:<br />
<div class="outline-text-6" id="text-3-10-13-1-2">

<div id="orgcc4bf42" class="figure">
<p><img src="reading/2020-11-24_14-18-28_screenshot.png" alt="2020-11-24_14-18-28_screenshot.png" />
</p>
</div>

<p>
最重要的两个test:
</p>
<ol class="org-ol">
<li><p>
<b>-type</b> 控制查找的文件类型,后面跟一个单字母的标识(也可以多个标识组合)
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">字母标识</td>
<td class="org-left">代表的文件类型</td>
</tr>

<tr>
<td class="org-left">f</td>
<td class="org-left">普通文件</td>
</tr>

<tr>
<td class="org-left">d</td>
<td class="org-left">目录</td>
</tr>

<tr>
<td class="org-left">b</td>
<td class="org-left">块设备</td>
</tr>

<tr>
<td class="org-left">c</td>
<td class="org-left">字符设备</td>
</tr>

<tr>
<td class="org-left">p</td>
<td class="org-left">命名管道</td>
</tr>

<tr>
<td class="org-left">l</td>
<td class="org-left">符号连接</td>
</tr>
</tbody>
</table></li>
<li><p>
<b>-name</b> 查找文件名匹配指定模式的文件
注意事项：不能忘记引用通配符
</p>
<div class="org-src-container">
<pre class="src src-shell">find . -type f -name <span style="color: #008000;">'*.c'</span> -print
find . -type f -name *.c -print
</pre>
</div>
<p>
第一条命令工作正常，第二条会产生语法错误，因为不引用的通配符会直接被
shell解释掉，扩展成一组实际的文件名，而实际这个通配符是给-name测试
用的。
</p></li>
</ol>

<p>
还可以用 <b>!</b> 对测试取反:
</p>
<div class="org-src-container">
<pre class="src src-shell">find ~ <span style="color: #008000;">\!</span> -type f <span style="color: #008000;">\!</span> -type d -print
</pre>
</div>
</div>
</li>
<li><a id="org51614b9"></a>action (默认为-print)<br />
<div class="outline-text-6" id="text-3-10-13-1-3">

<div id="org48e1709" class="figure">
<p><img src="reading/2020-11-24_14-37-40_screenshot.png" alt="2020-11-24_14-37-40_screenshot.png" />
</p>
</div>
</div>
</li>
</ol>
</li>

<li><a id="org76fdd77"></a>xargs<br />
<div class="outline-text-5" id="text-3-10-13-2">
<p>
我们可以把find的输出管道传送给xargs，它可以运行任何使用参数指定的命令
<b>xargs [-prt] [-istirng] [command [argument&#x2026;]]</b>
-i(nsert) string为占位符:
</p>
<div class="org-src-container">
<pre class="src src-shell">find . -type f | xargs -ifk mv fk ~/backups/fk.old
</pre>
</div>
<p>
上面的例子，fk就是占位符，xargs会用管道传过来的结果代替占位符，默认占位符是{}
</p>

<p>
-p(rompt,提示）
就是在每个命令之前询问一下是否确定执行，是的话输入'y',输入其他忽略该命令
</p>

<p>
-t(ell me what you are doing)  显示每一条命令
</p>
</div>
</li>
</ol>
</div>
</div>
<div id="outline-container-org2671f1e" class="outline-3">
<h3 id="org2671f1e"><span class="section-number-3">3.11</span> Effective C++</h3>
<div class="outline-text-3" id="text-3-11">
</div>
<div id="outline-container-orgacc6fec" class="outline-4">
<h4 id="orgacc6fec"><span class="section-number-4">3.11.1</span> 让自己习惯c++</h4>
<div class="outline-text-4" id="text-3-11-1">
</div>
<ol class="org-ol">
<li><a id="org4ffc9ee"></a>01 视c++为一个语言联邦<br />
<div class="outline-text-5" id="text-3-11-1-1">
<p>
c++是一个多重范式的编程语言：过程编程，面向对象编程，函数式，泛型编程，源编程。
c++可以分为4个次语言：
</p>
<ol class="org-ol">
<li>C</li>
<li>C with classes</li>
<li>Template C++</li>
<li>STL</li>
</ol>
</div>
</li>
<li><a id="org4a7320d"></a>02 尽量以const，enum，inline替换#define<br />
<div class="outline-text-5" id="text-3-11-1-2">
<ul class="org-ul">
<li>对于单纯常量，最好以const对象或enums替换#define
#define定义的符号不再符号表中，浪费调试时间。</li>
<li>对于形似函数的宏,最好改用inline函数替换#define</li>
</ul>
</div>
</li>
<li><a id="org76a86c6"></a>03 尽可能使用const<br />
<div class="outline-text-5" id="text-3-11-1-3">
<ul class="org-ul">
<li><p>
const允许你指定一个语义约束，编译器会帮助检查这个约束不被违反.const可以被施加于任何作用域
的对象，函数参数，函数返回类型，成员函数本体。const甚至能检查一些打字错误：
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #0000FF;">class</span> <span style="color: #6434A3;">Rational</span> <span style="color: #707183;">{}</span>;
<span style="color: #0000FF;">const</span> <span style="color: #6434A3;">Rational</span> <span style="color: #0000FF;">operator</span> <span style="color: #006699;">*</span> <span style="color: #707183;">(</span><span style="color: #0000FF;">const</span> <span style="color: #6434A3;">Rational</span> &amp;<span style="color: #BA36A5;">lhs</span>, <span style="color: #0000FF;">const</span> <span style="color: #6434A3;">Rational</span> &amp;<span style="color: #BA36A5;">rhs</span><span style="color: #707183;">)</span>;
<span style="color: #6434A3;">Rational</span> <span style="color: #BA36A5;">a</span>, <span style="color: #BA36A5;">b</span>,<span style="color: #BA36A5;">c</span>;
<span style="color: #0000FF;">if</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">a</span>*<span style="color: #BA36A5;">b</span> = c<span style="color: #707183;">)</span> <span style="color: #707183;">{</span>
  ...
 <span style="color: #707183;">}</span>
</pre>
</div>
<p>
本来想键入“==”却打成“=”, 但是const可以预防这样的错误
</p></li>
<li><p>
编译器强制实施bitwise constness（不改变对象内任何一个bit），但编写程序时应该使用
“概念上的常量性(可以修改对象的某些bits，但必须符合逻辑（logical constness）)”:
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #0000FF;">class</span> <span style="color: #6434A3;">CTextBlock</span> <span style="color: #707183;">{</span>
<span style="color: #0000FF;">public</span>:
  ...
<span style="color: #6434A3;">char</span> &amp;
<span style="color: #0000FF;">operator</span><span style="color: #7388D6;">[](</span><span style="color: #D0372D;">std</span>::<span style="color: #6434A3;">size_t</span> <span style="color: #BA36A5;">position</span><span style="color: #7388D6;">)</span> <span style="color: #0000FF;">const</span> <span style="color: #8D8D84;">//</span><span style="color: #8D8D84; font-style: italic;">bitwise&#22768;&#26126;&#65292;&#20294;&#20854;&#23454;&#19981;&#21512;&#36866;</span>
  <span style="color: #7388D6;">{</span><span style="color: #0000FF;">return</span> pText<span style="color: #909183;">[</span>position<span style="color: #909183;">]</span>;<span style="color: #7388D6;">}</span>
<span style="color: #0000FF;">private</span>:
  <span style="color: #6434A3;">char</span> *<span style="color: #BA36A5;">pText</span>;
<span style="color: #707183;">}</span>;
</pre>
</div></li>
<li><p>
当const和non-const成员函数有着实质等价的实现时，令non-const版本调用const版本可避免代码
重复:
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #0000FF;">class</span> <span style="color: #6434A3;">TextBlock</span> <span style="color: #707183;">{</span>
<span style="color: #0000FF;">public</span>:
  ...
  <span style="color: #0000FF;">const</span> <span style="color: #6434A3;">char</span>&amp; <span style="color: #0000FF;">operator</span><span style="color: #7388D6;">[](</span><span style="color: #D0372D;">std</span>::<span style="color: #6434A3;">size_t</span> <span style="color: #BA36A5;">position</span><span style="color: #7388D6;">)</span> <span style="color: #0000FF;">const</span>
  <span style="color: #7388D6;">{</span>
  ...
    <span style="color: #0000FF;">return</span> text<span style="color: #909183;">[</span>position<span style="color: #909183;">]</span>;
  <span style="color: #7388D6;">}</span>

  <span style="color: #6434A3;">char</span>&amp; <span style="color: #0000FF;">operator</span><span style="color: #7388D6;">[]</span><span style="color: #7388D6;">(</span><span style="color: #D0372D;">std</span>::<span style="color: #6434A3;">size_t</span> <span style="color: #BA36A5;">position</span><span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">{</span>
    <span style="color: #0000FF;">return</span> <span style="color: #0000FF;">const_cast</span><span style="color: #909183;">&lt;</span><span style="color: #6434A3;">char</span>&amp;<span style="color: #909183;">&gt;(</span><span style="color: #0000FF;">static_cast</span><span style="color: #709870;">&lt;</span><span style="color: #0000FF;">const</span> <span style="color: #6434A3;">TextBlock</span>&amp;<span style="color: #709870;">&gt;(</span>*<span style="color: #0000FF;">this</span><span style="color: #709870;">)[</span>position<span style="color: #709870;">]</span><span style="color: #909183;">)</span>;
  <span style="color: #7388D6;">}</span>
<span style="color: #707183;">}</span>;
</pre>
</div></li>
</ul>
</div>
</li>
<li><a id="org0295d63"></a>04 确定对象被使用前已先被初始化<br />
<div class="outline-text-5" id="text-3-11-1-4">
<p>
通常使用Cpart of C++而且初始化可能招致运行期成本时，那么就不保证发生初始化。而non-C parts
of C++，一般就会初始化。前者如array, 后者如vector的对比。
</p>

<p>
所以最好是永远使用对象之前将它初始化。具体来说：
</p>
<ol class="org-ol">
<li>对于无任何成员的内置类型，必须手工初始化</li>
<li>对于内置类型以外的任何东西，确保每个构造函数都将对象的每个成员初始化(别混淆复制和初始化,
也就是说成员初始化列表才是初始化，构造函数体中的是赋值操作)。
也就是说 <b>总是在初始列中列出所有成员变量以免还得记住哪些成员变量可以没有初始值</b></li>
<li>对于不同编译单元定义的non-local static对象，他们的初始化次序编译器是无法决定的，
所以为了消除这个问题，我们需要：将每个non-local static对象搬到自己的专属函数内
（该对象在此函数内被声明static）。这些函数返回一个reference指向它所含的对象。
也即是non-local static对象被local static对象替换了。这也是单例模式的常见实现
手法。</li>
</ol>
</div>
</li>
</ol>
</div>
<div id="outline-container-orgb2f4996" class="outline-4">
<h4 id="orgb2f4996"><span class="section-number-4">3.11.2</span> 构造/析构/赋值运算</h4>
<div class="outline-text-4" id="text-3-11-2">
</div>
<ol class="org-ol">
<li><a id="orgc5c3fc6"></a>05 了解c++默默编写并调用了哪些函数<br />
<div class="outline-text-5" id="text-3-11-2-1">
<p>
编译器可以暗自为class超级default构造函数，copy构造函数，copy assignment操作符，以及析构函数。
但是编译器会拒绝自动生成如下赋值操作, 必须自己定义copy assignment：
</p>
<ol class="org-ol">
<li>内含reference成员</li>
<li>内含const成员</li>
<li>某个base class将copy assignment操作符声明为private</li>
</ol>
</div>
</li>
<li><a id="orgd5c9fe9"></a>06 若不想使用编译器自动生成的函数，就该明确拒绝(private 或 delete)<br /></li>
<li><a id="org9c6af52"></a>07 为多态基类声明virtual析构函数<br />
<div class="outline-text-5" id="text-3-11-2-3">
<ol class="org-ol">
<li>polymorphic（带多态性质的）base classes 应该声明一个virtual析构函数, 因为这种基类的设计
目的是为了用了“通过base class接口处理derived class对象;
如果class带有任何virtual函数，它就应该拥有一个virtual析构函数.</li>
<li>classes的设计目的如果不是作为base classes使用，或者不是为了具备多态性，就不
该声明virtual析构函数</li>
</ol>
</div>
</li>
<li><a id="orgdbfe802"></a>08 别让异常逃离析构函数<br />
<div class="outline-text-5" id="text-3-11-2-4">
<p>
TODO : 汇编层面看异常的实现
</p>
<ol class="org-ol">
<li>析构函数绝对不要吐出异常。如果一个被析构函数调用的函数可能抛出异常，析构函数应该捕捉任何异常，
然后吞下它们（不传播）或结束程序</li>
<li>如果客户需要对某个操作函数运行期间抛出的异常做出反应，那么class应该提供一个普通函数（而
不是在析构函数中）执行该函数</li>
</ol>
</div>
</li>
<li><a id="orgb4a3352"></a>09 绝不在构造和析构过程中调用virtual函数<br />
<div class="outline-text-5" id="text-3-11-2-5">
<p>
在构造和析构期间不要调用virtual函数，因为这类调用从不下降至derived class
（比起当前执行构造函数和析构函数那层）。
</p>

<p>
解决这个问题的一个方法是把原本要调用的虚函数变为非虚函数，通过继承类的构造函数传递
必要信息给基类构造函数:
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #0000FF;">class</span> <span style="color: #6434A3;">Transaction</span> <span style="color: #707183;">{</span>
<span style="color: #0000FF;">public</span>:
  <span style="color: #0000FF;">explicit</span> <span style="color: #006699;">Transaction</span><span style="color: #7388D6;">(</span><span style="color: #0000FF;">const</span> <span style="color: #D0372D;">std</span>::<span style="color: #6434A3;">string</span> &amp;<span style="color: #BA36A5;">logInfo</span><span style="color: #7388D6;">)</span>;
  <span style="color: #6434A3;">void</span> <span style="color: #006699;">logTransaction</span><span style="color: #7388D6;">(</span><span style="color: #0000FF;">const</span> <span style="color: #D0372D;">std</span>::<span style="color: #6434A3;">string</span> &amp;<span style="color: #BA36A5;">logInfo</span><span style="color: #7388D6;">)</span> <span style="color: #0000FF;">const</span>; <span style="color: #8D8D84;">//</span><span style="color: #8D8D84; font-style: italic;">&#25913;&#20026;&#38750;&#34394;&#20989;&#25968;</span>
  ...
<span style="color: #707183;">}</span>;

<span style="color: #D0372D;">Transaction</span>::<span style="color: #006699;">Transaction</span><span style="color: #707183;">(</span><span style="color: #0000FF;">const</span> <span style="color: #D0372D;">std</span>::<span style="color: #6434A3;">string</span> &amp;<span style="color: #BA36A5;">logInfo</span><span style="color: #707183;">)</span>
<span style="color: #707183;">{</span>
  ...
    logTransaction<span style="color: #7388D6;">(</span>logInfo<span style="color: #7388D6;">)</span>;  <span style="color: #8D8D84;">//</span><span style="color: #8D8D84; font-style: italic;">&#29616;&#22312;&#26159;&#38750;&#34394;&#20989;&#25968;&#35843;&#29992;</span>
<span style="color: #707183;">}</span>

<span style="color: #0000FF;">class</span> <span style="color: #6434A3;">BuyTransaction</span>: <span style="color: #0000FF;">public</span> <span style="color: #6434A3;">Transaction</span> <span style="color: #707183;">{</span>
<span style="color: #0000FF;">public</span>:
  <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">&#23558;log&#20449;&#24687;&#20256;&#36882;&#32473;base class &#26500;&#36896;&#20989;&#25968;</span>
  <span style="color: #006699;">BuyTransaction</span><span style="color: #7388D6;">(</span>para<span style="color: #7388D6;">)</span> : Transaction<span style="color: #7388D6;">(</span>createLogString<span style="color: #909183;">(</span>para<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">{}</span>
<span style="color: #0000FF;">private</span>:
  <span style="color: #0000FF;">static</span> <span style="color: #D0372D;">std</span>::<span style="color: #6434A3;">string</span> <span style="color: #006699;">createLogString</span><span style="color: #7388D6;">(</span>para<span style="color: #7388D6;">)</span>;
<span style="color: #707183;">}</span>;
</pre>
</div>
</div>
</li>
<li><a id="orgd7abd1d"></a>10 令operator=返回一个reference to *this<br /></li>
<li><a id="org722f111"></a>11 在operator= 中处理“自我赋值”<br />
<div class="outline-text-5" id="text-3-11-2-7">
<ol class="org-ol">
<li><p>
确保当对象自我赋值时operator=有良好行为。其中技术包括比较“来源对象”和“目标对象”
的地址、精心周到的语句顺序、以及copy-and-swap:
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #6434A3;">Widget</span>&amp; <span style="color: #D0372D;">Widget</span>::<span style="color: #0000FF;">operator</span><span style="color: #006699;">=</span><span style="color: #707183;">(</span><span style="color: #0000FF;">const</span> <span style="color: #6434A3;">Widget</span> &amp;<span style="color: #BA36A5;">rhs</span><span style="color: #707183;">)</span>
<span style="color: #707183;">{</span>
  <span style="color: #6434A3;">Widget</span> <span style="color: #BA36A5;">temp</span><span style="color: #7388D6;">(</span>rhs<span style="color: #7388D6;">)</span>;
  swap<span style="color: #7388D6;">(</span>temp<span style="color: #7388D6;">)</span>;
  <span style="color: #0000FF;">return</span> *<span style="color: #0000FF;">this</span>;
<span style="color: #707183;">}</span>
</pre>
</div></li>
<li>确定任何函数如果操作一个以上的对象，而其中多个对象是同一个对象时，其行为仍然是正确的。</li>
</ol>
</div>
</li>
<li><a id="org077fbfa"></a>12 复制对象时不要忘记任何一个成分<br />
<div class="outline-text-5" id="text-3-11-2-8">
<ol class="org-ol">
<li>copying函数应该确保复制“对象内的所有成员变量”及“所有base class成分”</li>
<li>不要以某个copying函数实现另一个copying函数。而是将它们共同机制放在第三个函数中，并由两个
copying函数共同调用。因为：
<ul class="org-ul">
<li>拷贝复制运算符不能调用拷贝构造函数，因为不能构造一个已经存在的对象</li>
<li>拷贝构造函数也不能调用拷贝复制运算符，因为对象还没构造完</li>
</ul></li>
</ol>
</div>
</li>
</ol>
</div>
<div id="outline-container-org1eac455" class="outline-4">
<h4 id="org1eac455"><span class="section-number-4">3.11.3</span> 资源管理</h4>
<div class="outline-text-4" id="text-3-11-3">
<p>
所谓资源，就是一旦使用了它，将来必须还给系统。c++程序中常见的资源包括：
动态内存，文件描述符，互斥锁，数据库连接，网络sockets。
</p>
</div>
<ol class="org-ol">
<li><a id="org359b671"></a>13 以对象管理资源<br />
<div class="outline-text-5" id="text-3-11-3-1">
<p>
RAII(resource acquisition is initialization)：资源获取时机便是初始化时机
</p>
<ol class="org-ol">
<li>为防止资源泄露，使用RAII()对象，他们在构造函数中获得资源并在析构函数中释放资源。</li>
<li>shared<sub>ptr和auto</sub><sub>ptr很好用</sub></li>
</ol>
</div>
</li>
<li><a id="org14afd43"></a>14 在资源管理类中小心copying行为<br />
<div class="outline-text-5" id="text-3-11-3-2">
<ol class="org-ol">
<li>复制RAII对象必须一并复制它所管理的资源，所以资源copying行为决定RAII对象的copying行为。</li>
<li>常见的RAII class copying行为是：抑制copying，施行引用计数法，不过也可以实现成其他行为.</li>
</ol>
</div>
</li>
<li><a id="org19b5228"></a>15 在资源管理类中提供对原始资源的访问<br />
<div class="outline-text-5" id="text-3-11-3-3">
<ol class="org-ol">
<li>APIs往往要求访问原始资源，所以每个RAII class应该提供一个“取得其所管理的资源”的办法。</li>
<li>对原始资源的访问可能由显示转换或隐式转换。一般来说显示转换比较安全，但隐式转换对比较
方便(不用到处调用get()方法)</li>
</ol>
</div>
</li>
<li><a id="orgfe88149"></a>16 成对使用new和delete时要采取相同形式<br />
<div class="outline-text-5" id="text-3-11-3-4">
<p>
new [] -&gt;  delete []
new    -&gt;  delete
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #D0372D;">std</span>::<span style="color: #6434A3;">string</span> *<span style="color: #BA36A5;">stringArray</span> = <span style="color: #0000FF;">new</span> <span style="color: #D0372D;">std</span>::<span style="color: #6434A3;">string</span><span style="color: #707183;">[</span><span style="color: #D0372D;">100</span><span style="color: #707183;">]</span>;
...
<span style="color: #0000FF;">delete</span> stringArray;
</pre>
</div>
<p>
上面的例子中，100个string对象中的99个的析构函数很可能没被调用.
</p>
</div>
</li>
<li><a id="orgfaca8a3"></a>17 以独立语句将newed对象置入智能指针<br />
<div class="outline-text-5" id="text-3-11-3-5">
<p>
如果不这样做，一旦异常被抛出，有可能导致难以察觉的资源泄露：
</p>
<div class="org-src-container">
<pre class="src src-c++">processWidget<span style="color: #707183;">(</span><span style="color: #D0372D;">std</span>::shared_ptr<span style="color: #7388D6;">&lt;</span>Widget<span style="color: #7388D6;">&gt;(</span><span style="color: #0000FF;">new</span> <span style="color: #6434A3;">Widget</span><span style="color: #7388D6;">)</span>, <span style="color: #6434A3;">priority</span><span style="color: #7388D6;">()</span><span style="color: #707183;">)</span>;
</pre>
</div>
<p>
上面的代码可能会产生资源泄露，因为priority() 和shared<sub>ptr</sub>(new Widget)的执行
顺序是不确定的（为了效率，c++编译器可能产生不同顺序(不像java顺序是固定的))，所以
编译器产生的代码可能如下：
</p>
<ol class="org-ol">
<li>执行 new Widget</li>
<li>调用priority</li>
<li>调用shared<sub>ptr构造函数</sub></li>
</ol>
<p>
如果priority()执行时发生了异常，那么就会发生资源泄露
</p>

<p>
正确的做法是:
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #D0372D;">std</span>::<span style="color: #6434A3;">shared_ptr</span><span style="color: #707183;">&lt;</span>Widget<span style="color: #707183;">&gt;</span> <span style="color: #BA36A5;">pw</span><span style="color: #707183;">(</span><span style="color: #0000FF;">new</span> <span style="color: #6434A3;">Widget</span><span style="color: #707183;">)</span>;

processWidget<span style="color: #707183;">(</span>pw, priority<span style="color: #7388D6;">()</span><span style="color: #707183;">)</span>;
</pre>
</div>
</div>
</li>
</ol>
</div>
<div id="outline-container-orgbebc24d" class="outline-4">
<h4 id="orgbebc24d"><span class="section-number-4">3.11.4</span> 设计与声明</h4>
<div class="outline-text-4" id="text-3-11-4">
</div>
<ol class="org-ol">
<li><a id="org5884721"></a>18 让接口容易被正确使用，不易被误用<br />
<div class="outline-text-5" id="text-3-11-4-1">
<ol class="org-ol">
<li>好的接口不容易被误用</li>
<li>接口一致性和与内置类型行为兼容能“促进正确使用”</li>
<li>“阻止误用“的方法包括建立新类型，限制类型上的操作，束缚对象值，消除客户
的资源管理责任</li>
<li>shared<sub>ptr支持定制删除器</sub>。这可以防止DLL问题，还可以用来自动解除互斥锁等</li>
</ol>
</div>
</li>
<li><a id="org9fb10cf"></a>19 设计class犹如设计types<br />
<div class="outline-text-5" id="text-3-11-4-2">
<p>
Class的设计就是type的设计。在定义一个新type之前，请确定已经考虑过以下主题：
TODO 
</p>
</div>
</li>

<li><a id="orga672c62"></a>20 宁以pass-by-reference-to-const替换pass-by-value<br />
<div class="outline-text-5" id="text-3-11-4-3">
<ol class="org-ol">
<li>因为前者比较高校，并且可以避免切割问题</li>
<li>以上规则不适用于内置类型和STL的迭代器(值传递更符合语义)及函数对象。对它们而言，
pass-by-value往往比较适当</li>
</ol>
</div>
</li>

<li><a id="orgf82df94"></a>21 必须返回对象时，不要返回reference<br />
<div class="outline-text-5" id="text-3-11-4-4">
<p>
<b>绝对不要返回pointer或reference指向一个local stack对象，或返回reference指向一个
heap-allocated对象</b> ，或返回pointer/referece指向一个local static对象而有可能
同时需要多个这样的对象。
</p>
</div>
</li>
<li><a id="org376101a"></a>22 将成员变量声明为private<br />
<div class="outline-text-5" id="text-3-11-4-5">
<ol class="org-ol">
<li>把成员声明为private可赋予客服访问数据的一致性，可细微划分访问控制，允诺约束条件获得保证，并
提供class作者以充分的实现弹性</li>
<li>protected并不比public更具封装性</li>
</ol>
</div>
</li>
<li><a id="org191e3aa"></a>23 宁以non-member、non-friend替换member函数<br />
<div class="outline-text-5" id="text-3-11-4-6">
<p>
这样做可以，减少能够访问class内的private成分的函数数量，增加封装性,弹性和扩展性
</p>
</div>
</li>
<li><a id="orgfba7b2f"></a>24 把 所有参数都需要类型转换的函数 设计为非成员函数<br />
<div class="outline-text-5" id="text-3-11-4-7">
<p>
因为编译器无法为成员函数的this成员类型转换
</p>
</div>
</li>
<li><a id="orgc1ac0bc"></a><span class="todo TODO">TODO</span> 25 把swap函数写成不抛异常的函数<br /></li>
</ol>
</div>
<div id="outline-container-orgcc2ece3" class="outline-4">
<h4 id="orgcc2ece3"><span class="section-number-4">3.11.5</span> 实现</h4>
<div class="outline-text-4" id="text-3-11-5">
</div>
<ol class="org-ol">
<li><a id="orgd56dfc4"></a>26 尽可能延后变量定义式的出现时间<br /></li>
<li><a id="org8f25b19"></a>27 尽量少做转型动作<br />
<div class="outline-text-5" id="text-3-11-5-2">
<ol class="org-ol">
<li>如果可以，尽量避免转型，特别是在注重效率的代码中避免dynamic<sub>casts</sub>.
如果有个设计需要转型动作，试着发展无需转型的替代设计</li>
<li>如果转型是必要的，试着将它隐藏于某个函数背后。客户随后可以调用该函数，
而不是将转型放进他们自己的代码中</li>
<li>使用c++ style转型而不是旧式转型。因为前者很容易识别出来而且也职责分类也比较明确</li>
</ol>

<p>
看下面的例子:
</p>
<div class="org-src-container">
<pre class="src src-C++"><span style="color: #808080;">#include</span> <span style="color: #707183;">&lt;</span><span style="color: #008000;">iostream</span><span style="color: #707183;">&gt;</span>
<span style="color: #0000FF;">using</span> <span style="color: #0000FF;">namespace</span> <span style="color: #D0372D;">std</span>;
<span style="color: #0000FF;">class</span> <span style="color: #6434A3;">B</span> <span style="color: #707183;">{</span>
<span style="color: #0000FF;">public</span>:
  <span style="color: #0000FF;">virtual</span> <span style="color: #6434A3;">void</span> <span style="color: #006699;">fk</span><span style="color: #7388D6;">()</span> <span style="color: #7388D6;">{</span>
    i = <span style="color: #D0372D;">10</span>;
  <span style="color: #7388D6;">}</span>
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">i</span> = <span style="color: #D0372D;">1</span>;
<span style="color: #707183;">}</span>;

<span style="color: #0000FF;">class</span> <span style="color: #6434A3;">A</span> : <span style="color: #0000FF;">public</span> <span style="color: #6434A3;">B</span> <span style="color: #707183;">{</span>
<span style="color: #0000FF;">public</span>:
  <span style="color: #0000FF;">virtual</span> <span style="color: #6434A3;">void</span> <span style="color: #006699;">fk</span><span style="color: #7388D6;">()</span> <span style="color: #7388D6;">{</span>
    <span style="color: #0000FF;">static_cast</span><span style="color: #909183;">&lt;</span><span style="color: #6434A3;">B</span><span style="color: #909183;">&gt;(</span>*<span style="color: #0000FF;">this</span><span style="color: #909183;">)</span>.fk<span style="color: #909183;">()</span>;
  <span style="color: #7388D6;">}</span>
<span style="color: #707183;">}</span>;

<span style="color: #6434A3;">int</span> <span style="color: #006699;">main</span><span style="color: #707183;">()</span>
<span style="color: #707183;">{</span>
  <span style="color: #6434A3;">A</span> <span style="color: #BA36A5;">a</span>;
  a.fk<span style="color: #7388D6;">()</span>;
  cout &lt;&lt; a.i &lt;&lt; endl;
  <span style="color: #0000FF;">return</span> <span style="color: #D0372D;">0</span>;
<span style="color: #707183;">}</span>
</pre>
</div>

<p>
其汇编如下：
</p>
<div class="org-src-container">
<pre class="src src-asm"><span style="color: #006699;">B</span>::fk<span style="color: #707183;">()</span>:
        <span style="color: #0000FF;">pushq</span>   <span style="color: #BA36A5;">%rbp</span>
        <span style="color: #0000FF;">movq</span>    <span style="color: #BA36A5;">%rsp</span>, <span style="color: #BA36A5;">%rbp</span>
        <span style="color: #0000FF;">movq</span>    <span style="color: #BA36A5;">%rdi</span>, -8<span style="color: #707183;">(</span><span style="color: #BA36A5;">%rbp</span><span style="color: #707183;">)</span>
        <span style="color: #0000FF;">movq</span>    -8<span style="color: #707183;">(</span><span style="color: #BA36A5;">%rbp</span><span style="color: #707183;">)</span>, <span style="color: #BA36A5;">%rax</span>
        <span style="color: #0000FF;">movl</span>    $10, 8<span style="color: #707183;">(</span><span style="color: #BA36A5;">%rax</span><span style="color: #707183;">)</span>
        <span style="color: #0000FF;">nop</span>
        <span style="color: #0000FF;">popq</span>    <span style="color: #BA36A5;">%rbp</span>
        <span style="color: #0000FF;">ret</span>
<span style="color: #006699;">B</span>::B<span style="color: #707183;">(</span>B const&amp;<span style="color: #707183;">)</span>:
        <span style="color: #0000FF;">pushq</span>   <span style="color: #BA36A5;">%rbp</span>
        <span style="color: #0000FF;">movq</span>    <span style="color: #BA36A5;">%rsp</span>, <span style="color: #BA36A5;">%rbp</span>
        <span style="color: #0000FF;">movq</span>    <span style="color: #BA36A5;">%rdi</span>, -8<span style="color: #707183;">(</span><span style="color: #BA36A5;">%rbp</span><span style="color: #707183;">)</span>
        <span style="color: #0000FF;">movq</span>    <span style="color: #BA36A5;">%rsi</span>, -16<span style="color: #707183;">(</span><span style="color: #BA36A5;">%rbp</span><span style="color: #707183;">)</span>
        <span style="color: #0000FF;">movl</span>    $vtable for B+16, <span style="color: #BA36A5;">%edx</span>
        <span style="color: #0000FF;">movq</span>    -8<span style="color: #707183;">(</span><span style="color: #BA36A5;">%rbp</span><span style="color: #707183;">)</span>, <span style="color: #BA36A5;">%rax</span>
        <span style="color: #0000FF;">movq</span>    <span style="color: #BA36A5;">%rdx</span>, <span style="color: #707183;">(</span><span style="color: #BA36A5;">%rax</span><span style="color: #707183;">)</span>
        <span style="color: #0000FF;">movq</span>    -16<span style="color: #707183;">(</span><span style="color: #BA36A5;">%rbp</span><span style="color: #707183;">)</span>, <span style="color: #BA36A5;">%rax</span>
        <span style="color: #0000FF;">movl</span>    8<span style="color: #707183;">(</span><span style="color: #BA36A5;">%rax</span><span style="color: #707183;">)</span>, <span style="color: #BA36A5;">%edx</span>
        <span style="color: #0000FF;">movq</span>    -8<span style="color: #707183;">(</span><span style="color: #BA36A5;">%rbp</span><span style="color: #707183;">)</span>, <span style="color: #BA36A5;">%rax</span>
        <span style="color: #0000FF;">movl</span>    <span style="color: #BA36A5;">%edx</span>, 8<span style="color: #707183;">(</span><span style="color: #BA36A5;">%rax</span><span style="color: #707183;">)</span>
        <span style="color: #0000FF;">nop</span>
        <span style="color: #0000FF;">popq</span>    <span style="color: #BA36A5;">%rbp</span>
        <span style="color: #0000FF;">ret</span>
<span style="color: #006699;">A</span>::fk<span style="color: #707183;">()</span>:
        <span style="color: #0000FF;">pushq</span>   <span style="color: #BA36A5;">%rbp</span>
        <span style="color: #0000FF;">movq</span>    <span style="color: #BA36A5;">%rsp</span>, <span style="color: #BA36A5;">%rbp</span>
        <span style="color: #0000FF;">subq</span>    $32, <span style="color: #BA36A5;">%rsp</span>
        <span style="color: #0000FF;">movq</span>    <span style="color: #BA36A5;">%rdi</span>, -24<span style="color: #707183;">(</span><span style="color: #BA36A5;">%rbp</span><span style="color: #707183;">)</span>
        <span style="color: #0000FF;">movq</span>    -24<span style="color: #707183;">(</span><span style="color: #BA36A5;">%rbp</span><span style="color: #707183;">)</span>, <span style="color: #BA36A5;">%rdx</span>
        <span style="color: #0000FF;">leaq</span>    -16<span style="color: #707183;">(</span><span style="color: #BA36A5;">%rbp</span><span style="color: #707183;">)</span>, <span style="color: #BA36A5;">%rax</span>
        <span style="color: #0000FF;">movq</span>    <span style="color: #BA36A5;">%rdx</span>, <span style="color: #BA36A5;">%rsi</span>
        <span style="color: #0000FF;">movq</span>    <span style="color: #BA36A5;">%rax</span>, <span style="color: #BA36A5;">%rdi</span>
        <span style="color: #0000FF;">call</span>    B::B<span style="color: #707183;">(</span>B const&amp;<span style="color: #707183;">)</span>
        <span style="color: #0000FF;">leaq</span>    -16<span style="color: #707183;">(</span><span style="color: #BA36A5;">%rbp</span><span style="color: #707183;">)</span>, <span style="color: #BA36A5;">%rax</span>
        <span style="color: #0000FF;">movq</span>    <span style="color: #BA36A5;">%rax</span>, <span style="color: #BA36A5;">%rdi</span>
        <span style="color: #0000FF;">call</span>    B::fk<span style="color: #707183;">()</span>
        <span style="color: #0000FF;">nop</span>
        <span style="color: #0000FF;">leave</span>
        <span style="color: #0000FF;">ret</span>
<span style="color: #006699;">main</span>:
        <span style="color: #0000FF;">pushq</span>   <span style="color: #BA36A5;">%rbp</span>
        <span style="color: #0000FF;">movq</span>    <span style="color: #BA36A5;">%rsp</span>, <span style="color: #BA36A5;">%rbp</span>
        <span style="color: #0000FF;">subq</span>    $16, <span style="color: #BA36A5;">%rsp</span>
        <span style="color: #0000FF;">movl</span>    $vtable for A+16, <span style="color: #BA36A5;">%eax</span>
        <span style="color: #0000FF;">movq</span>    <span style="color: #BA36A5;">%rax</span>, -16<span style="color: #707183;">(</span><span style="color: #BA36A5;">%rbp</span><span style="color: #707183;">)</span>
        <span style="color: #0000FF;">movl</span>    $1, -8<span style="color: #707183;">(</span><span style="color: #BA36A5;">%rbp</span><span style="color: #707183;">)</span>
        <span style="color: #0000FF;">leaq</span>    -16<span style="color: #707183;">(</span><span style="color: #BA36A5;">%rbp</span><span style="color: #707183;">)</span>, <span style="color: #BA36A5;">%rax</span>
        <span style="color: #0000FF;">movq</span>    <span style="color: #BA36A5;">%rax</span>, <span style="color: #BA36A5;">%rdi</span>
        <span style="color: #0000FF;">call</span>    A::fk<span style="color: #707183;">()</span>
        <span style="color: #0000FF;">movl</span>    -8<span style="color: #707183;">(</span><span style="color: #BA36A5;">%rbp</span><span style="color: #707183;">)</span>, <span style="color: #BA36A5;">%eax</span>
        <span style="color: #0000FF;">leave</span>
        <span style="color: #0000FF;">ret</span>
<span style="color: #006699;">vtable</span> <span style="color: #0000FF;">for</span> A:
        <span style="color: #0000FF;">.quad</span>   0
        <span style="color: #0000FF;">.quad</span>   typeinfo for A
        <span style="color: #0000FF;">.quad</span>   A::fk<span style="color: #707183;">()</span>
<span style="color: #006699;">vtable</span> <span style="color: #0000FF;">for</span> B:
        <span style="color: #0000FF;">.quad</span>   0
        <span style="color: #0000FF;">.quad</span>   typeinfo for B
        <span style="color: #0000FF;">.quad</span>   B::fk<span style="color: #707183;">()</span>
<span style="color: #006699;">typeinfo</span> <span style="color: #0000FF;">for</span> A:
        <span style="color: #0000FF;">.quad</span>   vtable for __cxxabiv1::__si_class_type_info+16
        <span style="color: #0000FF;">.quad</span>   typeinfo name for A
        <span style="color: #0000FF;">.quad</span>   typeinfo for B
<span style="color: #006699;">typeinfo</span> <span style="color: #0000FF;">name</span> for A:
        <span style="color: #0000FF;">.string</span> <span style="color: #008000;">"1A"</span>
<span style="color: #006699;">typeinfo</span> <span style="color: #0000FF;">for</span> B:
        <span style="color: #0000FF;">.quad</span>   vtable for __cxxabiv1::__class_type_info+16
        <span style="color: #0000FF;">.quad</span>   typeinfo name for B
<span style="color: #006699;">typeinfo</span> <span style="color: #0000FF;">name</span> for B:
        <span style="color: #0000FF;">.string</span> <span style="color: #008000;">"1B"</span>
</pre>
</div>
<p>
可以看到，A的fk函数中，static<sub>cast转型会产生一个a的B类型部分的副本</sub>，而
没有直接改a所在内存.
</p>

<p>
所以类型转换要非常小心，尽量不要用
</p>
</div>
</li>

<li><a id="org540f28d"></a>28 避免返回handles指向对象内部成分<br />
<div class="outline-text-5" id="text-3-11-5-3">
<p>
这可以增加封装性，帮助const成员函数的行为像个const，并将发生空悬的可能性降到最低
</p>
</div>
</li>
<li><a id="org252311a"></a>29 为“异常安全”而努力是值得的<br />
<div class="outline-text-5" id="text-3-11-5-4">
<ol class="org-ol">
<li>异常安全函数即使发生异常也不会泄露资源或允许任何数据结构破坏。这样
的函数区分为三种可能的保证：
<ul class="org-ul">
<li>基本保证
如果异常被抛出，程序内的任何事物都仍然保持在有效状态下，没有任何
对象或数据结构出现预料范围以外的值</li>
<li>强烈保证
函数的操作是原子的，要不就完全成功，要不就失败回到调用之前的状态</li>
<li>不抛异常(nothrow)
不抛出异常，作用于内置类型上的所有操作都提供nothrow保证</li>
</ul></li>
<li>强烈保证 往往能够以 copy-and-swap实现出来，但“强烈保证”并非对所有
函数都可以实现或具有意义</li>
<li>函数提供的“异常安全保证”通常最高只等于其所调用的各个函数的“异常安全保证”
中的最弱者</li>
</ol>
</div>
</li>
<li><a id="org66c7822"></a>30 透彻了解inlineing<br />
<div class="outline-text-5" id="text-3-11-5-5">
<p>
inline的成本：
</p>
<ul class="org-ul">
<li>代码膨胀，catch命中率降低</li>
<li>调试困难</li>
<li>一点改动就得重新编译所有引用它的模块</li>

<li>将inline限制在小型(太大的化代码膨胀问题)，被频繁调用(这样inline消除的函数调用过程开销越多，收益越大，
而且因为函数是小型的，也不太会有代码膨胀问题)的函数上，这可使日后的调试过程和二进制升级更容易
，也可使潜在的代码膨胀问题最小化，使程序的速度提升机会最大化。</li>
<li>不要只因为function templates出现在头文件就把他们声明为inline. inline与
function templates没有必然联系。</li>
</ul>
</div>
</li>
<li><a id="org092490e"></a>31 将文件间的编译依存关系降到最低<br />
<div class="outline-text-5" id="text-3-11-5-6">
<ol class="org-ol">
<li>这种原则的一般思想是：相依于声明式而不是定义式，而实现这种思想的手段一般是
handle classes和interface classes配合使用</li>
<li>程序库头文件应该以“完全且仅有声明式”的形式存在，这种做法不论是否涉及templates都适用</li>
</ol>
</div>
</li>
</ol>
</div>
<div id="outline-container-org259dd7c" class="outline-4">
<h4 id="org259dd7c"><span class="section-number-4">3.11.6</span> 继承与面向对象设计</h4>
<div class="outline-text-4" id="text-3-11-6">
</div>
<ol class="org-ol">
<li><a id="org683412e"></a>32 确定你的public继承塑膜出is-a关系<br />
<div class="outline-text-5" id="text-3-11-6-1">
<p>
public继承意味着is-a，适用于base class身上的每一件事
也一定适用于继承类身上的情况。
</p>
</div>
</li>
<li><a id="orgbadef3a"></a>33 避免遮掩继承而来的名称<br />
<div class="outline-text-5" id="text-3-11-6-2">
<ol class="org-ol">
<li>继承类中的名称会遮掩基类中的名称。</li>
<li>为了防止名称被遮掩，可以使用using声明或转交函数</li>
</ol>
</div>
</li>
<li><a id="orgf1997d6"></a>34 区分接口继承和实现继承<br />
<div class="outline-text-5" id="text-3-11-6-3">
<ol class="org-ol">
<li>纯虚函数只指定接口的继承, 要注意的是纯虚函数可以被定义，然后被继承类调用</li>
<li>非纯虚函数会具体指定接口继承以及缺省的实现继承</li>
<li>非虚函数则会具体指定接口继承以及强制性实现继承</li>
</ol>
</div>
</li>
<li><a id="org0acd1f3"></a><span class="todo TODO">TODO</span> 35 考虑virtual函数以外的其他选择<br /></li>
<li><a id="org68a8ca8"></a>36 绝不重新定义继承来的非虚函数<br /></li>
<li><a id="org5b7e7b1"></a>37 绝不重新定义继承来的缺省参数值<br />
<div class="outline-text-5" id="text-3-11-6-6">
<p>
因为缺省的参数值是静态绑定的，而virtual函数却是动态绑定的；
可以用35中的NVI来代替这种设计
</p>
</div>
</li>
<li><a id="org86281a9"></a>38 通过复合塑膜出has-a或“根据某物实现出”<br /></li>
<li><a id="orgc0e2efc"></a>39 明智而谨慎的使用private继承<br />
<ol class="org-ol">
<li><a id="org7d46ac9"></a>EBO(empty base optimization)空白基类优化<br />
<div class="outline-text-6" id="text-3-11-6-8-1">
<p>
通常c++官方规定默默安插一个char到独立空对象中,所以sizeof一个这种空类得1
但是当空类作为基类时则不同
这段代码运行结果为
4
4
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #808080;">#include</span> <span style="color: #707183;">&lt;</span><span style="color: #008000;">iostream</span><span style="color: #707183;">&gt;</span>
<span style="color: #0000FF;">using</span> <span style="color: #0000FF;">namespace</span> <span style="color: #D0372D;">std</span>;

<span style="color: #0000FF;">class</span> <span style="color: #6434A3;">Empty</span> <span style="color: #707183;">{</span>

<span style="color: #707183;">}</span>;
<span style="color: #0000FF;">class</span> <span style="color: #6434A3;">A</span> : <span style="color: #0000FF;">public</span> <span style="color: #6434A3;">Empty</span> <span style="color: #707183;">{</span>
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">x</span>;  
<span style="color: #707183;">}</span>;
<span style="color: #6434A3;">int</span> <span style="color: #006699;">main</span><span style="color: #707183;">()</span> <span style="color: #707183;">{</span>
  cout  &lt;&lt; <span style="color: #0000FF;">sizeof</span><span style="color: #7388D6;">(</span>A<span style="color: #7388D6;">)</span> &lt;&lt; endl;
  cout &lt;&lt; <span style="color: #0000FF;">sizeof</span><span style="color: #7388D6;">(</span><span style="color: #6434A3;">int</span><span style="color: #7388D6;">)</span> &lt;&lt; endl;
  <span style="color: #0000FF;">return</span> <span style="color: #D0372D;">0</span>;
<span style="color: #707183;">}</span>
</pre>
</div>
<p>
而这段代码运行结果为
8
4
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #808080;">#include</span> <span style="color: #707183;">&lt;</span><span style="color: #008000;">iostream</span><span style="color: #707183;">&gt;</span>
<span style="color: #0000FF;">using</span> <span style="color: #0000FF;">namespace</span> <span style="color: #D0372D;">std</span>;

<span style="color: #0000FF;">class</span> <span style="color: #6434A3;">Empty</span> <span style="color: #707183;">{</span>

<span style="color: #707183;">}</span>;
<span style="color: #0000FF;">class</span> <span style="color: #6434A3;">A</span> <span style="color: #707183;">{</span>
  <span style="color: #6434A3;">Empty</span> <span style="color: #BA36A5;">e</span>;
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">x</span>;  
<span style="color: #707183;">}</span>;
<span style="color: #6434A3;">int</span> <span style="color: #006699;">main</span><span style="color: #707183;">()</span> <span style="color: #707183;">{</span>
  cout  &lt;&lt; <span style="color: #0000FF;">sizeof</span><span style="color: #7388D6;">(</span>A<span style="color: #7388D6;">)</span> &lt;&lt; endl;
  cout &lt;&lt; <span style="color: #0000FF;">sizeof</span><span style="color: #7388D6;">(</span><span style="color: #6434A3;">int</span><span style="color: #7388D6;">)</span> &lt;&lt; endl;
  <span style="color: #0000FF;">return</span> <span style="color: #D0372D;">0</span>;
<span style="color: #707183;">}</span>
</pre>
</div>

<ol class="org-ol">
<li>private继承意味着根据某物实现出。通常应该尽量用复合来代替它。
但是当继承类需要访问protected base class的成员，或需要
重新定义继承而来的virtual函数时，这么设计是合理的。</li>
<li>和复合不同，private继承可以造成EBO优化。</li>
</ol>
</div>
</li>
</ol>
</li>
<li><a id="org567a4c5"></a><span class="todo TODO">TODO</span> 40 明智而谨慎的使用多重继承<br />
<div class="outline-text-5" id="text-3-11-6-9">
<ol class="org-ol">
<li>多重继承比单一继承复杂。它可能导致新的歧义，以及对virtual继承的需要</li>
<li>virtual继承会增加大小，速度，初始化(及赋值)复杂度等成本。如果virtual
base classes不带任何数据，将是最具有实用价值的情况</li>
<li>多重继承的确有正当的用途。其中一个情节是：public继承某个接口和
private继承某个协助实现的类 的结合</li>
</ol>
</div>
</li>
</ol>
</div>
<div id="outline-container-org0aa65ca" class="outline-4">
<h4 id="org0aa65ca"><span class="section-number-4">3.11.7</span> 模版与泛型编程</h4>
<div class="outline-text-4" id="text-3-11-7">
</div>
<ol class="org-ol">
<li><a id="org29f048a"></a>41 了解隐式接口和编译期多态<br />
<div class="outline-text-5" id="text-3-11-7-1">
<p>
显示接口就是在类的头文件中显示定义的接口,而隐式接口一般是指模版函数中的
T需要支持的操作接口.
</p>

<ol class="org-ol">
<li>classes和templates都支持接口和多肽</li>
<li>对classes而言接口是显示的，以函数签名(函数名，参数列表，返回类型)为中心。
多态则是通过virtual函数发生于运行期。</li>
<li>对template参数而言，接口是隐式的，多态则是通过template具现化和函数
重载解析发生于编译期</li>
</ol>
</div>
</li>
<li><a id="orged1b769"></a>42 了解typename的双重意义<br />
<div class="outline-text-5" id="text-3-11-7-2">
<ol class="org-ol">
<li>声明template参数时，关键字class和typename可互换</li>
<li>嵌套从属类型需要用typename来标识；但是不能在base class lists
(如class A : public B)或member initialization list内
使用。</li>
</ol>
</div>
</li>
<li><a id="org886320b"></a>43 学习处理模版化基类内的名称<br />
<div class="outline-text-5" id="text-3-11-7-3">
<ol class="org-ol">
<li>在处理模版时，编译器不会进入base class templates的作用域内
查找成员名称，我们可以在derived class templates内通过“this-&gt;"
来指导编译器进入base class的作用域找；或者借助一个明白写出的“base class
资格修饰符" 完成。</li>
</ol>
</div>
</li>
<li><a id="org2b8ce28"></a>44 将与参数无关的代码抽离templates<br />
<div class="outline-text-5" id="text-3-11-7-4">
<ol class="org-ol">
<li>templates生成多个classes和多个函数，所以任何template代码
豆瓣不该与某个造成膨胀的template参数产生相依关系</li>
<li>因非类型模版参数而参数而造成的代码膨胀，往往可以消除，做法是以
函数参数或class成员变量替换template参数</li>
<li>因类型参数而造成的代码膨胀，往往可降低，做法是让带有完全相同二进制
表述的具现类型共享实现代码</li>
</ol>
</div>
</li>
<li><a id="org1f5eb5d"></a>45 运用成员函数模版接受所有兼容类型<br />
<div class="outline-text-5" id="text-3-11-7-5">
<ol class="org-ol">
<li>请使用member function templates生成“可接受所以兼容
类型”的函数。</li>
<li>就算声明member templates用于“泛化copy构造”或泛化assignment操作，
还是需要声明正常的copy构造函数和copy赋值运算符，因为templates不改变
语言的基本规则。</li>
</ol>
</div>
</li>
<li><a id="orgba4fc10"></a>46 函数模版需要类型转换时定义为非成员函数(24的扩充)<br />
<div class="outline-text-5" id="text-3-11-7-6">
<ol class="org-ol">
<li>当编写一个class tempaltes，而它所提供的与此templates相关
的函数 支持”所有参数的隐式类型转换“时，请将那些函数定义为”class
template 内部的friend 函数。因为如果不这样，编译器无法推断
出该为需要类型转换的参数具现化怎样的函数。</li>
</ol>
</div>
</li>
<li><a id="org11d817f"></a>47 使用traits classes表现类型信息<br />
<div class="outline-text-5" id="text-3-11-7-7">
<ol class="org-ol">
<li>Traits classes使得“类型相关信息”在编译期可用。它们以templates和
“templates特化”完成实现. 用templates的原因是trais 必须能够用于
内置类型，这意味着把类型相关信息放在在类型内行不通。</li>
<li>重载技术使得traits classes有可能在编译期对类型执行jif&#x2026;else测试。</li>
</ol>
</div>
</li>
<li><a id="orgf004557"></a>48 template模版元编程<br /></li>
</ol>
</div>
<div id="outline-container-org88891e1" class="outline-4">
<h4 id="org88891e1"><span class="section-number-4">3.11.8</span> 定制new和delete</h4>
<div class="outline-text-4" id="text-3-11-8">
</div>
<ol class="org-ol">
<li><a id="org07d9ca1"></a>49 了解new handler的行为<br /></li>
</ol>
</div>
</div>
<div id="outline-container-orgba88a2e" class="outline-3">
<h3 id="orgba88a2e"><span class="section-number-3">3.12</span> <span class="todo TODO">TODO</span> MYSQL必知必会 <a href="file:///Users/binbinyang/Documents/MySQL必知必会.pdf">pdf</a></h3>
<div class="outline-text-3" id="text-3-12">
</div>
<div id="outline-container-org7e8f172" class="outline-4">
<h4 id="org7e8f172"><span class="section-number-4">3.12.1</span> reference:</h4>
<div class="outline-text-4" id="text-3-12-1">
<p>
1.<a href="https://forta.com/wp-content/uploads/books/0672327120/mysql_scripts.zip">https://forta.com/wp-content/uploads/books/0672327120/mysql_scripts.zip</a>
</p>
</div>
</div>
<div id="outline-container-orgba0b749" class="outline-4">
<h4 id="orgba0b749"><span class="section-number-4">3.12.2</span> 第一章 了解SQL</h4>
<div class="outline-text-4" id="text-3-12-2">
<p>
数据库：保存有组织的数据的容器（通常是一个或一组文件）。
DBMS：数据库管理系统，创建和操纵数据库
表：某种特定类型数据的结构化清单
模式(schema):关于数据库和表的布局及特性的信息
列：表中的一个字段
行：表中的一个记录
主键：一列，其值能够唯一区分表中的行
</p>
</div>
</div>
<div id="outline-container-orgcc910ba" class="outline-4">
<h4 id="orgcc910ba"><span class="section-number-4">3.12.3</span> 第二章 MySQL简介</h4>
<div class="outline-text-4" id="text-3-12-3">
<p>
mac启动mysql:
</p>
<div class="org-src-container">
<pre class="src src-shell">mysql.server start
mysql -uroot
</pre>
</div>
</div>
</div>
<div id="outline-container-orgaef4f08" class="outline-4">
<h4 id="orgaef4f08"><span class="section-number-4">3.12.4</span> 第三章 使用MySQL</h4>
<div class="outline-text-4" id="text-3-12-4">
</div>
<ol class="org-ol">
<li><a id="orga97d188"></a>连接<br />
<div class="outline-text-5" id="text-3-12-4-1">
<p>
为了连接到mysql，需要下面信息：
</p>
<ul class="org-ul">
<li>主机名
本地为localhost</li>
<li>端口
如果使用了端口3306以外的端口</li>
<li>一个合法用户名</li>
<li>用户口令
如果需要</li>
</ul>
</div>
</li>
<li><a id="orgc414be5"></a>选择数据库<br />
<div class="outline-text-5" id="text-3-12-4-2">
<p>
USE 关键字
</p>
<div class="org-src-container">
<pre class="src src-sql">mysql&gt; show databases;
+<span style="color: #8D8D84; font-style: italic;">--------------------+</span>
| Database           |
+<span style="color: #8D8D84; font-style: italic;">--------------------+</span>
| information_schema |
| mysql              |
| performance_schema |
| sys                |
+<span style="color: #8D8D84; font-style: italic;">--------------------+</span>
<span style="color: #D0372D;">4</span> <span style="color: #0000FF;">rows</span> <span style="color: #0000FF;">in</span> <span style="color: #0000FF;">set</span> <span style="color: #707183;">(</span><span style="color: #D0372D;">0</span>.<span style="color: #D0372D;">00</span> sec<span style="color: #707183;">)</span>

mysql&gt; use sys;
Reading <span style="color: #0000FF;">table</span> information <span style="color: #0000FF;">for</span> <span style="color: #0000FF;">completion</span> <span style="color: #0000FF;">of</span> <span style="color: #0000FF;">table</span> <span style="color: #0000FF;">and</span> <span style="color: #0000FF;">column</span> <span style="color: #0000FF;">names</span>
You can turn <span style="color: #0000FF;">off</span> this feature <span style="color: #0000FF;">to</span> <span style="color: #0000FF;">get</span> a quicker startup <span style="color: #0000FF;">with</span> -A

Database changed
</pre>
</div>
</div>
</li>
<li><a id="org0552099"></a>显示可用数据库和表<br />
<ol class="org-ol">
<li><a id="orgbf55239"></a>显示数据库<br />
<div class="outline-text-6" id="text-3-12-4-3-1">
<div class="org-src-container">
<pre class="src src-sql">mysql&gt; show databases;
+<span style="color: #8D8D84; font-style: italic;">--------------------+</span>
| Database           |
+<span style="color: #8D8D84; font-style: italic;">--------------------+</span>
| information_schema |
| mysql              |
| performance_schema |
| sys                |
+<span style="color: #8D8D84; font-style: italic;">--------------------+</span>
<span style="color: #D0372D;">4</span> <span style="color: #0000FF;">rows</span> <span style="color: #0000FF;">in</span> <span style="color: #0000FF;">set</span> <span style="color: #707183;">(</span><span style="color: #D0372D;">0</span>.<span style="color: #D0372D;">01</span> sec<span style="color: #707183;">)</span>
</pre>
</div>
</div>
</li>

<li><a id="org9b64b23"></a>显示表<br />
<div class="outline-text-6" id="text-3-12-4-3-2">
<p>
show tables;
</p>
</div>
</li>
<li><a id="org6e19f8b"></a>显示列<br />
<div class="outline-text-6" id="text-3-12-4-3-3">
<p>
show columns from 表名;
</p>
</div>
</li>
</ol>
</li>
</ol>
</div>
<div id="outline-container-orgc81300e" class="outline-4">
<h4 id="orgc81300e"><span class="section-number-4">3.12.5</span> 第四章 基本SELECT</h4>
<div class="outline-text-4" id="text-3-12-5">
</div>
<ol class="org-ol">
<li><a id="org4f6c606"></a>DISTINCT<br />
<div class="outline-text-5" id="text-3-12-5-1">
<p>
必须直接放在列名前面，并且会应用于所有列而不仅是前置它的列
</p>
<div class="org-src-container">
<pre class="src src-sql">mysql&gt; <span style="color: #0000FF;">select</span> <span style="color: #0000FF;">distinct</span> vend_id <span style="color: #0000FF;">from</span> products;
+<span style="color: #8D8D84; font-style: italic;">---------+</span>
| vend_id |
+<span style="color: #8D8D84; font-style: italic;">---------+</span>
|    <span style="color: #D0372D;">1001</span> |
|    <span style="color: #D0372D;">1002</span> |
|    <span style="color: #D0372D;">1003</span> |
|    <span style="color: #D0372D;">1005</span> |
+<span style="color: #8D8D84; font-style: italic;">---------+</span>
<span style="color: #D0372D;">4</span> <span style="color: #0000FF;">rows</span> <span style="color: #0000FF;">in</span> <span style="color: #0000FF;">set</span> <span style="color: #707183;">(</span><span style="color: #D0372D;">0</span>.<span style="color: #D0372D;">01</span> sec<span style="color: #707183;">)</span>
</pre>
</div>
</div>
</li>
<li><a id="org2564393"></a>LIMIT<br />
<div class="outline-text-5" id="text-3-12-5-2">
<div class="org-src-container">
<pre class="src src-sql">mysql&gt; <span style="color: #0000FF;">select</span> prod_name <span style="color: #0000FF;">from</span> products <span style="color: #0000FF;">limit</span> <span style="color: #D0372D;">5</span>;
+<span style="color: #8D8D84; font-style: italic;">--------------+</span>
| prod_name    |
+<span style="color: #8D8D84; font-style: italic;">--------------+</span>
| .<span style="color: #D0372D;">5</span> ton anvil |
| <span style="color: #D0372D;">1</span> ton anvil  |
| <span style="color: #D0372D;">2</span> ton anvil  |
| Detonator    |
| Bird seed    |
+<span style="color: #8D8D84; font-style: italic;">--------------+</span>
<span style="color: #D0372D;">5</span> <span style="color: #0000FF;">rows</span> <span style="color: #0000FF;">in</span> <span style="color: #0000FF;">set</span> <span style="color: #707183;">(</span><span style="color: #D0372D;">0</span>.<span style="color: #D0372D;">00</span> sec<span style="color: #707183;">)</span>

mysql&gt; <span style="color: #0000FF;">select</span> prod_name <span style="color: #0000FF;">from</span> products <span style="color: #0000FF;">limit</span> <span style="color: #D0372D;">5</span>,<span style="color: #D0372D;">5</span>;
+<span style="color: #8D8D84; font-style: italic;">--------------+</span>
| prod_name    |
+<span style="color: #8D8D84; font-style: italic;">--------------+</span>
| Carrots      |
| Fuses        |
| JetPack <span style="color: #D0372D;">1000</span> |
| JetPack <span style="color: #D0372D;">2000</span> |
| Oil can      |
+<span style="color: #8D8D84; font-style: italic;">--------------+</span>
<span style="color: #D0372D;">5</span> <span style="color: #0000FF;">rows</span> <span style="color: #0000FF;">in</span> <span style="color: #0000FF;">set</span> <span style="color: #707183;">(</span><span style="color: #D0372D;">0</span>.<span style="color: #D0372D;">00</span> sec<span style="color: #707183;">)</span>
</pre>
</div>
</div>
</li>
</ol>
</div>
<div id="outline-container-org2e4149b" class="outline-4">
<h4 id="org2e4149b"><span class="section-number-4">3.12.6</span> 第五章 排序检索数据 ORDER BY</h4>
<div class="outline-text-4" id="text-3-12-6">
</div>
<ol class="org-ol">
<li><a id="orgeeb45dc"></a>子句<br />
<div class="outline-text-5" id="text-3-12-6-1">
<p>
SQL语句由子句组成，有些子句是必须的，有些是可选的。一个子句通常由一个关键字和
所提供的数据组成。子句的例子有FROM子句， ORDER BY子句。
</p>

<p>
子句之间是有顺序的, 次序不对会产生错误信息：FORM &gt; WHERE &gt; GROUP BY &gt; HAVING &gt; ORDER BY &gt; LIMIT
</p>
</div>
</li>
<li><a id="org3e86ff7"></a>ORDER BY<br />
<div class="outline-text-5" id="text-3-12-6-2">
<div class="org-src-container">
<pre class="src src-sql">mysql&gt; <span style="color: #0000FF;">select</span> prod_name <span style="color: #0000FF;">from</span> products <span style="color: #0000FF;">order</span> <span style="color: #0000FF;">by</span> prod_name;
+<span style="color: #8D8D84; font-style: italic;">----------------+</span>
| prod_name      |
+<span style="color: #8D8D84; font-style: italic;">----------------+</span>
| .<span style="color: #D0372D;">5</span> ton anvil   |
| <span style="color: #D0372D;">1</span> ton anvil    |
| <span style="color: #D0372D;">2</span> ton anvil    |
| Bird seed      |
| Carrots        |
| Detonator      |
| Fuses          |
| JetPack <span style="color: #D0372D;">1000</span>   |
| JetPack <span style="color: #D0372D;">2000</span>   |
| Oil can        |
| Safe           |
| Sling          |
| TNT <span style="color: #707183;">(</span><span style="color: #D0372D;">1</span> stick<span style="color: #707183;">)</span>  |
| TNT <span style="color: #707183;">(</span><span style="color: #D0372D;">5</span> sticks<span style="color: #707183;">)</span> |
+<span style="color: #8D8D84; font-style: italic;">----------------+</span>
<span style="color: #D0372D;">14</span> <span style="color: #0000FF;">rows</span> <span style="color: #0000FF;">in</span> <span style="color: #0000FF;">set</span> <span style="color: #707183;">(</span><span style="color: #D0372D;">0</span>.<span style="color: #D0372D;">01</span> sec<span style="color: #707183;">)</span>


&#36890;&#36807;&#38750;&#36873;&#25321;&#21015;&#25490;&#24207;
mysql&gt; <span style="color: #0000FF;">select</span> prod_name <span style="color: #0000FF;">from</span> products <span style="color: #0000FF;">order</span> <span style="color: #0000FF;">by</span> prod_price;
+<span style="color: #8D8D84; font-style: italic;">----------------+</span>
| prod_name      |
+<span style="color: #8D8D84; font-style: italic;">----------------+</span>
| Carrots        |
| TNT <span style="color: #707183;">(</span><span style="color: #D0372D;">1</span> stick<span style="color: #707183;">)</span>  |
| Fuses          |
| Sling          |
| .<span style="color: #D0372D;">5</span> ton anvil   |
| Oil can        |
| <span style="color: #D0372D;">1</span> ton anvil    |
| Bird seed      |
| TNT <span style="color: #707183;">(</span><span style="color: #D0372D;">5</span> sticks<span style="color: #707183;">)</span> |
| Detonator      |
| <span style="color: #D0372D;">2</span> ton anvil    |
| JetPack <span style="color: #D0372D;">1000</span>   |
| Safe           |
| JetPack <span style="color: #D0372D;">2000</span>   |
+<span style="color: #8D8D84; font-style: italic;">----------------+</span>
<span style="color: #D0372D;">14</span> <span style="color: #0000FF;">rows</span> <span style="color: #0000FF;">in</span> <span style="color: #0000FF;">set</span> <span style="color: #707183;">(</span><span style="color: #D0372D;">0</span>.<span style="color: #D0372D;">00</span> sec<span style="color: #707183;">)</span>


&#25353;&#22810;&#21015;&#25490;&#24207;
mysql&gt; <span style="color: #0000FF;">select</span> prod_id,prod_price,prod_name <span style="color: #0000FF;">from</span> products <span style="color: #0000FF;">order</span> <span style="color: #0000FF;">by</span> prod_price,prod_name;
+<span style="color: #8D8D84; font-style: italic;">---------+------------+----------------+</span>
| prod_id | prod_price | prod_name      |
+<span style="color: #8D8D84; font-style: italic;">---------+------------+----------------+</span>
| FC      |       <span style="color: #D0372D;">2</span>.<span style="color: #D0372D;">50</span> | Carrots        |
| TNT1    |       <span style="color: #D0372D;">2</span>.<span style="color: #D0372D;">50</span> | TNT <span style="color: #707183;">(</span><span style="color: #D0372D;">1</span> stick<span style="color: #707183;">)</span>  |
| FU1     |       <span style="color: #D0372D;">3</span>.<span style="color: #D0372D;">42</span> | Fuses          |
| SLING   |       <span style="color: #D0372D;">4</span>.<span style="color: #D0372D;">49</span> | Sling          |
| ANV01   |       <span style="color: #D0372D;">5</span>.<span style="color: #D0372D;">99</span> | .<span style="color: #D0372D;">5</span> ton anvil   |
| OL1     |       <span style="color: #D0372D;">8</span>.<span style="color: #D0372D;">99</span> | Oil can        |
| ANV02   |       <span style="color: #D0372D;">9</span>.<span style="color: #D0372D;">99</span> | <span style="color: #D0372D;">1</span> ton anvil    |
| FB      |      <span style="color: #D0372D;">10</span>.<span style="color: #D0372D;">00</span> | Bird seed      |
| TNT2    |      <span style="color: #D0372D;">10</span>.<span style="color: #D0372D;">00</span> | TNT <span style="color: #707183;">(</span><span style="color: #D0372D;">5</span> sticks<span style="color: #707183;">)</span> |
| DTNTR   |      <span style="color: #D0372D;">13</span>.<span style="color: #D0372D;">00</span> | Detonator      |
| ANV03   |      <span style="color: #D0372D;">14</span>.<span style="color: #D0372D;">99</span> | <span style="color: #D0372D;">2</span> ton anvil    |
| JP1000  |      <span style="color: #D0372D;">35</span>.<span style="color: #D0372D;">00</span> | JetPack <span style="color: #D0372D;">1000</span>   |
| SAFE    |      <span style="color: #D0372D;">50</span>.<span style="color: #D0372D;">00</span> | Safe           |
| JP2000  |      <span style="color: #D0372D;">55</span>.<span style="color: #D0372D;">00</span> | JetPack <span style="color: #D0372D;">2000</span>   |
+<span style="color: #8D8D84; font-style: italic;">---------+------------+----------------+</span>
<span style="color: #D0372D;">14</span> <span style="color: #0000FF;">rows</span> <span style="color: #0000FF;">in</span> <span style="color: #0000FF;">set</span> <span style="color: #707183;">(</span><span style="color: #D0372D;">0</span>.<span style="color: #D0372D;">00</span> sec<span style="color: #707183;">)</span>



&#25351;&#23450;&#25490;&#24207;&#26041;&#21521;<span style="color: #707183;">(</span>&#40664;&#35748;&#21319;&#24207;<span style="color: #707183;">)</span>, <span style="color: #0000FF;">DESC</span>&#21482;&#24212;&#29992;&#21040;&#30452;&#25509;&#20301;&#20110;&#20854;&#21069;&#38754;&#30340;&#21015;&#21517;,&#25152;&#20197;&#23545;&#22810;&#20010;&#21015;&#38477;&#24207;&#25490;&#24207;&#24517;&#39035;&#23545;&#27599;&#20010;&#21015;&#25351;&#23450;<span style="color: #0000FF;">DESC</span>&#20851;&#38190;&#23383; 
mysql&gt; <span style="color: #0000FF;">select</span> prod_id,prod_price,prod_name <span style="color: #0000FF;">from</span> products <span style="color: #0000FF;">order</span> <span style="color: #0000FF;">by</span> prod_price <span style="color: #0000FF;">DESC</span>, prod_name;
+<span style="color: #8D8D84; font-style: italic;">---------+------------+----------------+</span>
| prod_id | prod_price | prod_name      |
+<span style="color: #8D8D84; font-style: italic;">---------+------------+----------------+</span>
| JP2000  |      <span style="color: #D0372D;">55</span>.<span style="color: #D0372D;">00</span> | JetPack <span style="color: #D0372D;">2000</span>   |
| SAFE    |      <span style="color: #D0372D;">50</span>.<span style="color: #D0372D;">00</span> | Safe           |
| JP1000  |      <span style="color: #D0372D;">35</span>.<span style="color: #D0372D;">00</span> | JetPack <span style="color: #D0372D;">1000</span>   |
| ANV03   |      <span style="color: #D0372D;">14</span>.<span style="color: #D0372D;">99</span> | <span style="color: #D0372D;">2</span> ton anvil    |
| DTNTR   |      <span style="color: #D0372D;">13</span>.<span style="color: #D0372D;">00</span> | Detonator      |
| FB      |      <span style="color: #D0372D;">10</span>.<span style="color: #D0372D;">00</span> | Bird seed      |
| TNT2    |      <span style="color: #D0372D;">10</span>.<span style="color: #D0372D;">00</span> | TNT <span style="color: #707183;">(</span><span style="color: #D0372D;">5</span> sticks<span style="color: #707183;">)</span> |
| ANV02   |       <span style="color: #D0372D;">9</span>.<span style="color: #D0372D;">99</span> | <span style="color: #D0372D;">1</span> ton anvil    |
| OL1     |       <span style="color: #D0372D;">8</span>.<span style="color: #D0372D;">99</span> | Oil can        |
| ANV01   |       <span style="color: #D0372D;">5</span>.<span style="color: #D0372D;">99</span> | .<span style="color: #D0372D;">5</span> ton anvil   |
| SLING   |       <span style="color: #D0372D;">4</span>.<span style="color: #D0372D;">49</span> | Sling          |
| FU1     |       <span style="color: #D0372D;">3</span>.<span style="color: #D0372D;">42</span> | Fuses          |
| FC      |       <span style="color: #D0372D;">2</span>.<span style="color: #D0372D;">50</span> | Carrots        |
| TNT1    |       <span style="color: #D0372D;">2</span>.<span style="color: #D0372D;">50</span> | TNT <span style="color: #707183;">(</span><span style="color: #D0372D;">1</span> stick<span style="color: #707183;">)</span>  |
+<span style="color: #8D8D84; font-style: italic;">---------+------------+----------------+</span>
<span style="color: #D0372D;">14</span> <span style="color: #0000FF;">rows</span> <span style="color: #0000FF;">in</span> <span style="color: #0000FF;">set</span> <span style="color: #707183;">(</span><span style="color: #D0372D;">0</span>.<span style="color: #D0372D;">00</span> sec<span style="color: #707183;">)</span>
</pre>
</div>
</div>
</li>
</ol>
</div>
<div id="outline-container-org168abf4" class="outline-4">
<h4 id="org168abf4"><span class="section-number-4">3.12.7</span> 第六章 过滤数据 WHERE</h4>
<div class="outline-text-4" id="text-3-12-7">
</div>
<ol class="org-ol">
<li><a id="orgbeb881b"></a>WHERE子句操作符<br />
<div class="outline-text-5" id="text-3-12-7-1">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">=</td>
</tr>

<tr>
<td class="org-left">&lt;&gt; 不等于, 和!=等价</td>
</tr>

<tr>
<td class="org-left">!=</td>
</tr>

<tr>
<td class="org-left">&lt;</td>
</tr>

<tr>
<td class="org-left">&lt;=</td>
</tr>

<tr>
<td class="org-left">&gt;</td>
</tr>

<tr>
<td class="org-left">&gt;=</td>
</tr>

<tr>
<td class="org-left">BETWEEN &#x2026; AND &#x2026;</td>
</tr>

<tr>
<td class="org-left">IS NULL</td>
</tr>
</tbody>
</table>
</div>
</li>
</ol>
</div>
<div id="outline-container-org1f79874" class="outline-4">
<h4 id="org1f79874"><span class="section-number-4">3.12.8</span> 第七章 高级WHERE AND OR NOT IN</h4>
<div class="outline-text-4" id="text-3-12-8">
</div>
<ol class="org-ol">
<li><a id="org1ed3b49"></a>AND比OR优先级高<br />
<div class="outline-text-5" id="text-3-12-8-1">
<div class="org-src-container">
<pre class="src src-sql">mysql&gt; <span style="color: #0000FF;">select</span> prod_name,prod_price <span style="color: #0000FF;">from</span> products
-&gt; <span style="color: #0000FF;">where</span> vend_id = <span style="color: #D0372D;">1002</span> <span style="color: #0000FF;">OR</span> vend_id = <span style="color: #D0372D;">1003</span> <span style="color: #0000FF;">AND</span> prod_price &gt;= <span style="color: #D0372D;">10</span>;
+<span style="color: #8D8D84; font-style: italic;">----------------+------------+</span>
| prod_name      | prod_price |
+<span style="color: #8D8D84; font-style: italic;">----------------+------------+</span>
| Fuses          |       <span style="color: #D0372D;">3</span>.<span style="color: #D0372D;">42</span> |
| Oil can        |       <span style="color: #D0372D;">8</span>.<span style="color: #D0372D;">99</span> |
| Detonator      |      <span style="color: #D0372D;">13</span>.<span style="color: #D0372D;">00</span> |
| Bird seed      |      <span style="color: #D0372D;">10</span>.<span style="color: #D0372D;">00</span> |
| Safe           |      <span style="color: #D0372D;">50</span>.<span style="color: #D0372D;">00</span> |
| TNT <span style="color: #707183;">(</span><span style="color: #D0372D;">5</span> sticks<span style="color: #707183;">)</span> |      <span style="color: #D0372D;">10</span>.<span style="color: #D0372D;">00</span> |
+<span style="color: #8D8D84; font-style: italic;">----------------+------------+</span>
<span style="color: #D0372D;">6</span> <span style="color: #0000FF;">rows</span> <span style="color: #0000FF;">in</span> <span style="color: #0000FF;">set</span> <span style="color: #707183;">(</span><span style="color: #D0372D;">0</span>.<span style="color: #D0372D;">01</span> sec<span style="color: #707183;">)</span>

&#21487;&#20197;&#30475;&#21040;&#65292;&#36820;&#22238;&#30340;&#34892;&#20013;&#26377;&#20004;&#34892;&#20215;&#26684;&#23567;&#20110;10&#65292;&#35777;&#26126;<span style="color: #0000FF;">AND</span>&#26159;&#20808;&#20110;<span style="color: #0000FF;">OR</span>&#22788;&#29702;&#30340;. &#27491;&#30830;&#30340;&#20889;&#27861;&#26159;
mysql&gt; <span style="color: #0000FF;">select</span> prod_name,prod_price <span style="color: #0000FF;">from</span> products
<span style="color: #0000FF;">where</span> <span style="color: #707183;">(</span>vend_id = <span style="color: #D0372D;">1002</span> <span style="color: #0000FF;">OR</span> vend_id = <span style="color: #D0372D;">1003</span><span style="color: #707183;">)</span> <span style="color: #0000FF;">AND</span> prod_price &gt;= <span style="color: #D0372D;">10</span>;
+<span style="color: #8D8D84; font-style: italic;">----------------+------------+</span>
| prod_name      | prod_price |
+<span style="color: #8D8D84; font-style: italic;">----------------+------------+</span>
| Detonator      |      <span style="color: #D0372D;">13</span>.<span style="color: #D0372D;">00</span> |
| Bird seed      |      <span style="color: #D0372D;">10</span>.<span style="color: #D0372D;">00</span> |
| Safe           |      <span style="color: #D0372D;">50</span>.<span style="color: #D0372D;">00</span> |
| TNT <span style="color: #707183;">(</span><span style="color: #D0372D;">5</span> sticks<span style="color: #707183;">)</span> |      <span style="color: #D0372D;">10</span>.<span style="color: #D0372D;">00</span> |
+<span style="color: #8D8D84; font-style: italic;">----------------+------------+</span>
<span style="color: #D0372D;">4</span> <span style="color: #0000FF;">rows</span> <span style="color: #0000FF;">in</span> <span style="color: #0000FF;">set</span> <span style="color: #707183;">(</span><span style="color: #D0372D;">0</span>.<span style="color: #D0372D;">00</span> sec<span style="color: #707183;">)</span>
</pre>
</div>
</div>
</li>

<li><a id="org4dd9ed0"></a>IN<br />
<div class="outline-text-5" id="text-3-12-8-2">
<p>
检索出供应商1002和1003的所有产品
</p>
<div class="org-src-container">
<pre class="src src-sql">mysql&gt; <span style="color: #0000FF;">select</span> prod_name,prod_price <span style="color: #0000FF;">from</span> products
-&gt; <span style="color: #0000FF;">where</span> vend_id <span style="color: #0000FF;">IN</span> <span style="color: #707183;">(</span><span style="color: #D0372D;">1002</span>,<span style="color: #D0372D;">1003</span><span style="color: #707183;">)</span>
-&gt; <span style="color: #0000FF;">order</span> <span style="color: #0000FF;">by</span> prod_name;
+<span style="color: #8D8D84; font-style: italic;">----------------+------------+</span>
| prod_name      | prod_price |
+<span style="color: #8D8D84; font-style: italic;">----------------+------------+</span>
| Bird seed      |      <span style="color: #D0372D;">10</span>.<span style="color: #D0372D;">00</span> |
| Carrots        |       <span style="color: #D0372D;">2</span>.<span style="color: #D0372D;">50</span> |
| Detonator      |      <span style="color: #D0372D;">13</span>.<span style="color: #D0372D;">00</span> |
| Fuses          |       <span style="color: #D0372D;">3</span>.<span style="color: #D0372D;">42</span> |
| Oil can        |       <span style="color: #D0372D;">8</span>.<span style="color: #D0372D;">99</span> |
| Safe           |      <span style="color: #D0372D;">50</span>.<span style="color: #D0372D;">00</span> |
| Sling          |       <span style="color: #D0372D;">4</span>.<span style="color: #D0372D;">49</span> |
| TNT <span style="color: #707183;">(</span><span style="color: #D0372D;">1</span> stick<span style="color: #707183;">)</span>  |       <span style="color: #D0372D;">2</span>.<span style="color: #D0372D;">50</span> |
| TNT <span style="color: #707183;">(</span><span style="color: #D0372D;">5</span> sticks<span style="color: #707183;">)</span> |      <span style="color: #D0372D;">10</span>.<span style="color: #D0372D;">00</span> |
+<span style="color: #8D8D84; font-style: italic;">----------------+------------+</span>
<span style="color: #D0372D;">9</span> <span style="color: #0000FF;">rows</span> <span style="color: #0000FF;">in</span> <span style="color: #0000FF;">set</span> <span style="color: #707183;">(</span><span style="color: #D0372D;">0</span>.<span style="color: #D0372D;">01</span> sec<span style="color: #707183;">)</span>
</pre>
</div>
<p>
IN 功能与 OR相当，但有以下优点：
</p>
<ol class="org-ol">
<li>IN语法更清楚直观</li>
<li>计算的次序更容易管理</li>
<li>一般执行更快</li>
<li>最大的优点是可以包含其他SELECT语句</li>
</ol>
</div>
</li>
<li><a id="org86abfdd"></a>NOT<br />
<div class="outline-text-5" id="text-3-12-8-3">
<p>
mysql除了允许使用not对各种条件取反，还支持对in，between和exists子句取反
</p>
<div class="org-src-container">
<pre class="src src-sql">mysql&gt; <span style="color: #0000FF;">select</span> prod_name,prod_price <span style="color: #0000FF;">from</span> products <span style="color: #0000FF;">where</span> <span style="color: #0000FF;">not</span> vend_id &gt; <span style="color: #D0372D;">1002</span>;
+<span style="color: #8D8D84; font-style: italic;">--------------+------------+</span>
| prod_name    | prod_price |
+<span style="color: #8D8D84; font-style: italic;">--------------+------------+</span>
| .<span style="color: #D0372D;">5</span> ton anvil |       <span style="color: #D0372D;">5</span>.<span style="color: #D0372D;">99</span> |
| <span style="color: #D0372D;">1</span> ton anvil  |       <span style="color: #D0372D;">9</span>.<span style="color: #D0372D;">99</span> |
| <span style="color: #D0372D;">2</span> ton anvil  |      <span style="color: #D0372D;">14</span>.<span style="color: #D0372D;">99</span> |
| Fuses        |       <span style="color: #D0372D;">3</span>.<span style="color: #D0372D;">42</span> |
| Oil can      |       <span style="color: #D0372D;">8</span>.<span style="color: #D0372D;">99</span> |
+<span style="color: #8D8D84; font-style: italic;">--------------+------------+</span>
<span style="color: #D0372D;">5</span> <span style="color: #0000FF;">rows</span> <span style="color: #0000FF;">in</span> <span style="color: #0000FF;">set</span> <span style="color: #707183;">(</span><span style="color: #D0372D;">0</span>.<span style="color: #D0372D;">00</span> sec<span style="color: #707183;">)</span>


mysql&gt; <span style="color: #0000FF;">select</span> prod_name,prod_price <span style="color: #0000FF;">from</span> products <span style="color: #0000FF;">where</span> vend_id <span style="color: #0000FF;">not</span> <span style="color: #0000FF;">IN</span> <span style="color: #707183;">(</span><span style="color: #D0372D;">1002</span>,<span style="color: #D0372D;">1003</span><span style="color: #707183;">)</span>;
+<span style="color: #8D8D84; font-style: italic;">--------------+------------+</span>
| prod_name    | prod_price |
+<span style="color: #8D8D84; font-style: italic;">--------------+------------+</span>
| .<span style="color: #D0372D;">5</span> ton anvil |       <span style="color: #D0372D;">5</span>.<span style="color: #D0372D;">99</span> |
| <span style="color: #D0372D;">1</span> ton anvil  |       <span style="color: #D0372D;">9</span>.<span style="color: #D0372D;">99</span> |
| <span style="color: #D0372D;">2</span> ton anvil  |      <span style="color: #D0372D;">14</span>.<span style="color: #D0372D;">99</span> |
| JetPack <span style="color: #D0372D;">1000</span> |      <span style="color: #D0372D;">35</span>.<span style="color: #D0372D;">00</span> |
| JetPack <span style="color: #D0372D;">2000</span> |      <span style="color: #D0372D;">55</span>.<span style="color: #D0372D;">00</span> |
+<span style="color: #8D8D84; font-style: italic;">--------------+------------+</span>
<span style="color: #D0372D;">5</span> <span style="color: #0000FF;">rows</span> <span style="color: #0000FF;">in</span> <span style="color: #0000FF;">set</span> <span style="color: #707183;">(</span><span style="color: #D0372D;">0</span>.<span style="color: #D0372D;">01</span> sec<span style="color: #707183;">)</span>
</pre>
</div>
</div>
</li>
</ol>
</div>
<div id="outline-container-orgf170c3a" class="outline-4">
<h4 id="orgf170c3a"><span class="section-number-4">3.12.9</span> 第八章 用通配符进行过滤</h4>
<div class="outline-text-4" id="text-3-12-9">
</div>
<ol class="org-ol">
<li><a id="orgb8f5786"></a>LIKE操作符<br />
<div class="outline-text-5" id="text-3-12-9-1">
<p>
通配符本身实际是SQL的 <b>WHERE子句</b> 中有特殊含义的字符,
通配符前必须接LIKE操作符
</p>
</div>
</li>
<li><a id="org8f013c7"></a>%(相当于shell的*)<br />
<div class="outline-text-5" id="text-3-12-9-2">
<p>
<b>不能匹配NULL</b>
</p>
<div class="org-src-container">
<pre class="src src-sql">mysql&gt; <span style="color: #0000FF;">select</span> prod_id, prod_name <span style="color: #0000FF;">from</span> products <span style="color: #0000FF;">where</span> prod_name <span style="color: #0000FF;">LIKE</span> <span style="color: #008000;">'jet%'</span>
-&gt; ;
+<span style="color: #8D8D84; font-style: italic;">---------+--------------+</span>
| prod_id | prod_name    |
+<span style="color: #8D8D84; font-style: italic;">---------+--------------+</span>
| JP1000  | JetPack <span style="color: #D0372D;">1000</span> |
| JP2000  | JetPack <span style="color: #D0372D;">2000</span> |
+<span style="color: #8D8D84; font-style: italic;">---------+--------------+</span>
<span style="color: #D0372D;">2</span> <span style="color: #0000FF;">rows</span> <span style="color: #0000FF;">in</span> <span style="color: #0000FF;">set</span> <span style="color: #707183;">(</span><span style="color: #D0372D;">0</span>.<span style="color: #D0372D;">00</span> sec<span style="color: #707183;">)</span>
</pre>
</div>
</div>
</li>
<li><a id="org79f5129"></a>_(相当于shell的.)<br />
<div class="outline-text-5" id="text-3-12-9-3">
<div class="org-src-container">
<pre class="src src-sql">mysql&gt; <span style="color: #0000FF;">select</span> prod_id, prod_name <span style="color: #0000FF;">from</span> products <span style="color: #0000FF;">where</span> prod_name <span style="color: #0000FF;">LIKE</span> <span style="color: #008000;">'_ ton anvil'</span>;
+<span style="color: #8D8D84; font-style: italic;">---------+-------------+</span>
| prod_id | prod_name   |
+<span style="color: #8D8D84; font-style: italic;">---------+-------------+</span>
| ANV02   | <span style="color: #D0372D;">1</span> ton anvil |
| ANV03   | <span style="color: #D0372D;">2</span> ton anvil |
+<span style="color: #8D8D84; font-style: italic;">---------+-------------+</span>
<span style="color: #D0372D;">2</span> <span style="color: #0000FF;">rows</span> <span style="color: #0000FF;">in</span> <span style="color: #0000FF;">set</span> <span style="color: #707183;">(</span><span style="color: #D0372D;">0</span>.<span style="color: #D0372D;">00</span> sec<span style="color: #707183;">)</span>
</pre>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-org82daf00" class="outline-4">
<h4 id="org82daf00"><span class="section-number-4">3.12.10</span> 第九章 正则表达式</h4>
<div class="outline-text-4" id="text-3-12-10">
<p>
正则与通配符的区别：通配符合只能匹配整个字符，正则可以部分匹配.
</p>
</div>
</div>
<div id="outline-container-orgb5bc9ca" class="outline-4">
<h4 id="orgb5bc9ca"><span class="section-number-4">3.12.11</span> 第十章 计算字段</h4>
<div class="outline-text-4" id="text-3-12-11">
<div class="org-src-container">
<pre class="src src-sql">&#27491;&#21017;&#65292;&#21305;&#37197;&#19968;&#37096;&#20998;
mysql&gt; <span style="color: #0000FF;">select</span> prod_name <span style="color: #0000FF;">from</span> products <span style="color: #0000FF;">where</span> prod_name regexp <span style="color: #008000;">'1000'</span> <span style="color: #0000FF;">order</span> <span style="color: #0000FF;">by</span> prod_name;
+<span style="color: #8D8D84; font-style: italic;">--------------+</span>
| prod_name    |
+<span style="color: #8D8D84; font-style: italic;">--------------+</span>
| JetPack <span style="color: #D0372D;">1000</span> |
+<span style="color: #8D8D84; font-style: italic;">--------------+</span>
<span style="color: #D0372D;">1</span> <span style="color: #6434A3;">row</span> <span style="color: #0000FF;">in</span> <span style="color: #0000FF;">set</span> <span style="color: #707183;">(</span><span style="color: #D0372D;">0</span>.<span style="color: #D0372D;">05</span> sec<span style="color: #707183;">)</span>


&#36890;&#37197;&#31526;&#65292;&#21482;&#33021;&#21305;&#37197;&#20840;&#37096;&#65292;&#30456;&#24403;&#20110;&#27491;&#21017;&#21152;&#20102; ^$
mysql&gt; <span style="color: #0000FF;">select</span> prod_name <span style="color: #0000FF;">from</span> products <span style="color: #0000FF;">where</span> prod_name <span style="color: #0000FF;">like</span> <span style="color: #008000;">'1000'</span> <span style="color: #0000FF;">order</span> <span style="color: #0000FF;">by</span> prod_name;
Empty <span style="color: #0000FF;">set</span> <span style="color: #707183;">(</span><span style="color: #D0372D;">0</span>.<span style="color: #D0372D;">02</span> sec<span style="color: #707183;">)</span>
</pre>
</div>
</div>
<ol class="org-ol">
<li><a id="org5b8a9d8"></a>concat 拼接字段<br />
<div class="outline-text-5" id="text-3-12-11-1">
<div class="org-src-container">
<pre class="src src-sql">mysql&gt; <span style="color: #0000FF;">select</span> concat<span style="color: #707183;">(</span>vend_name, <span style="color: #008000;">' ('</span>, vend_country, <span style="color: #008000;">')'</span><span style="color: #707183;">)</span>
-&gt; <span style="color: #0000FF;">from</span> vendors
-&gt; <span style="color: #0000FF;">order</span> <span style="color: #0000FF;">by</span> vend_name;
+<span style="color: #8D8D84; font-style: italic;">--------------------------------------------+</span>
| concat<span style="color: #707183;">(</span>vend_name, <span style="color: #008000;">' ('</span>, vend_country, <span style="color: #008000;">')'</span><span style="color: #707183;">)</span> |
+<span style="color: #8D8D84; font-style: italic;">--------------------------------------------+</span>
| ACME <span style="color: #707183;">(</span>USA<span style="color: #707183;">)</span>                                 |
| Anvils R Us <span style="color: #707183;">(</span>USA<span style="color: #707183;">)</span>                          |
| Furball Inc. <span style="color: #707183;">(</span>USA<span style="color: #707183;">)</span>                         |
| Jet <span style="color: #0000FF;">Set</span> <span style="color: #707183;">(</span>England<span style="color: #707183;">)</span>                          |
| Jouets Et Ours <span style="color: #707183;">(</span>France<span style="color: #707183;">)</span>                    |
| LT Supplies <span style="color: #707183;">(</span>USA<span style="color: #707183;">)</span>                          |
+<span style="color: #8D8D84; font-style: italic;">--------------------------------------------+</span>
<span style="color: #D0372D;">6</span> <span style="color: #0000FF;">rows</span> <span style="color: #0000FF;">in</span> <span style="color: #0000FF;">set</span> <span style="color: #707183;">(</span><span style="color: #D0372D;">0</span>.<span style="color: #D0372D;">01</span> sec<span style="color: #707183;">)</span>
</pre>
</div>
</div>
</li>
<li><a id="orgb313768"></a>去掉首尾空格<br />
<div class="outline-text-5" id="text-3-12-11-2">
<p>
去掉左右两边 Trim(), 去掉左边 LTrim(), 去掉右边 RTrim()
</p>
</div>
</li>
<li><a id="orgba2bc4e"></a>别名 AS<br />
<div class="outline-text-5" id="text-3-12-11-3">
<div class="org-src-container">
<pre class="src src-sql">mysql&gt; <span style="color: #0000FF;">select</span> concat<span style="color: #707183;">(</span>vend_name, <span style="color: #008000;">' ('</span>, vend_country, <span style="color: #008000;">')'</span><span style="color: #707183;">)</span> <span style="color: #0000FF;">as</span> vend_title <span style="color: #0000FF;">from</span> vendors <span style="color: #0000FF;">order</span> <span style="color: #0000FF;">by</span> vend_name;
+<span style="color: #8D8D84; font-style: italic;">-------------------------+</span>
| vend_title              |
+<span style="color: #8D8D84; font-style: italic;">-------------------------+</span>
| ACME <span style="color: #707183;">(</span>USA<span style="color: #707183;">)</span>              |
| Anvils R Us <span style="color: #707183;">(</span>USA<span style="color: #707183;">)</span>       |
| Furball Inc. <span style="color: #707183;">(</span>USA<span style="color: #707183;">)</span>      |
| Jet <span style="color: #0000FF;">Set</span> <span style="color: #707183;">(</span>England<span style="color: #707183;">)</span>       |
| Jouets Et Ours <span style="color: #707183;">(</span>France<span style="color: #707183;">)</span> |
| LT Supplies <span style="color: #707183;">(</span>USA<span style="color: #707183;">)</span>       |
+<span style="color: #8D8D84; font-style: italic;">-------------------------+</span>
<span style="color: #D0372D;">6</span> <span style="color: #0000FF;">rows</span> <span style="color: #0000FF;">in</span> <span style="color: #0000FF;">set</span> <span style="color: #707183;">(</span><span style="color: #D0372D;">0</span>.<span style="color: #D0372D;">01</span> sec<span style="color: #707183;">)</span>
</pre>
</div>
</div>
</li>
<li><a id="orgf17e57d"></a>执行算术计算<br />
<div class="outline-text-5" id="text-3-12-11-4">
<div class="org-src-container">
<pre class="src src-sql">mysql&gt; <span style="color: #0000FF;">select</span> prod_id,
-&gt; quantity,
-&gt; item_price,
-&gt; quantity*item_price <span style="color: #0000FF;">as</span> expanded_price
-&gt; <span style="color: #0000FF;">from</span> orderitems
-&gt; <span style="color: #0000FF;">where</span> order_num = <span style="color: #D0372D;">20005</span>;
+<span style="color: #8D8D84; font-style: italic;">---------+----------+------------+----------------+</span>
| prod_id | quantity | item_price | expanded_price |
+<span style="color: #8D8D84; font-style: italic;">---------+----------+------------+----------------+</span>
| ANV01   |       <span style="color: #D0372D;">10</span> |       <span style="color: #D0372D;">5</span>.<span style="color: #D0372D;">99</span> |          <span style="color: #D0372D;">59</span>.<span style="color: #D0372D;">90</span> |
| ANV02   |        <span style="color: #D0372D;">3</span> |       <span style="color: #D0372D;">9</span>.<span style="color: #D0372D;">99</span> |          <span style="color: #D0372D;">29</span>.<span style="color: #D0372D;">97</span> |
| TNT2    |        <span style="color: #D0372D;">5</span> |      <span style="color: #D0372D;">10</span>.<span style="color: #D0372D;">00</span> |          <span style="color: #D0372D;">50</span>.<span style="color: #D0372D;">00</span> |
| FB      |        <span style="color: #D0372D;">1</span> |      <span style="color: #D0372D;">10</span>.<span style="color: #D0372D;">00</span> |          <span style="color: #D0372D;">10</span>.<span style="color: #D0372D;">00</span> |
+<span style="color: #8D8D84; font-style: italic;">---------+----------+------------+----------------+</span>
<span style="color: #D0372D;">4</span> <span style="color: #0000FF;">rows</span> <span style="color: #0000FF;">in</span> <span style="color: #0000FF;">set</span> <span style="color: #707183;">(</span><span style="color: #D0372D;">0</span>.<span style="color: #D0372D;">01</span> sec<span style="color: #707183;">)</span>
</pre>
</div>
<p>
`k`k`
</p>
</div>
</li>
</ol>
</div>
<div id="outline-container-orgea044bb" class="outline-4">
<h4 id="orgea044bb"><span class="section-number-4">3.12.12</span> 第十一章 数据处理函数</h4>
<div class="outline-text-4" id="text-3-12-12">
<p>
大多数SQL实现支持以下类型的函数：
</p>
<ol class="org-ol">
<li><p>
文本函数
用于处理文本串（如删除或填充值，转换大小写）
</p>

<div id="org5cf23a9" class="figure">
<p><img src="reading/2020-11-25_10-10-12_screenshot.png" alt="2020-11-25_10-10-12_screenshot.png" />
</p>
</div></li>
<li><p>
数值函数
用于在数值进行算术操作（如返回绝对值，进行代数运算）
</p>

<div id="org465e501" class="figure">
<p><img src="reading/2020-11-25_10-11-27_screenshot.png" alt="2020-11-25_10-11-27_screenshot.png" />
</p>
</div></li>
<li><p>
日期和时间函数
用于处理日期和时间值并从这些值中提取特定成分（如返回两个日期之差，检查日期有效性）
</p>

<div id="org51867a6" class="figure">
<p><img src="reading/2020-11-25_10-10-52_screenshot.png" alt="2020-11-25_10-10-52_screenshot.png" />
</p>
</div></li>
<li>系统函数
返回DBMS正使用的特殊信息（如用户登录信息，检查版本细节）</li>
</ol>
</div>
</div>
<div id="outline-container-org74353e7" class="outline-4">
<h4 id="org74353e7"><span class="section-number-4">3.12.13</span> 第十二章 汇总数据(聚集函数)</h4>
<div class="outline-text-4" id="text-3-12-13">
</div>
<ol class="org-ol">
<li><a id="orgf3d8668"></a>聚集函数<br />
<div class="outline-text-5" id="text-3-12-13-1">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">AVG()</td>
<td class="org-left">返回某列的平均值</td>
</tr>

<tr>
<td class="org-left">COUNT()</td>
<td class="org-left">返回某列的行数</td>
</tr>

<tr>
<td class="org-left">MAX()</td>
<td class="org-left">返回某列的最大值</td>
</tr>

<tr>
<td class="org-left">MIN()</td>
<td class="org-left">返回某列的最小值</td>
</tr>

<tr>
<td class="org-left">SUM()</td>
<td class="org-left">返回某列值之和</td>
</tr>
</tbody>
</table>
<div class="org-src-container">
<pre class="src src-sql">mysql&gt; <span style="color: #0000FF;">select</span> <span style="color: #006FE0;">avg</span><span style="color: #707183;">(</span>prod_price<span style="color: #707183;">)</span> <span style="color: #0000FF;">as</span> ap
-&gt; <span style="color: #0000FF;">from</span> products;
+<span style="color: #8D8D84; font-style: italic;">-----------+</span>
| ap        |
+<span style="color: #8D8D84; font-style: italic;">-----------+</span>
| <span style="color: #D0372D;">16</span>.<span style="color: #D0372D;">133571</span> |
+<span style="color: #8D8D84; font-style: italic;">-----------+</span>
<span style="color: #D0372D;">1</span> <span style="color: #6434A3;">row</span> <span style="color: #0000FF;">in</span> <span style="color: #0000FF;">set</span> <span style="color: #707183;">(</span><span style="color: #D0372D;">0</span>.<span style="color: #D0372D;">01</span> sec<span style="color: #707183;">)</span>


mysql&gt; <span style="color: #0000FF;">select</span> prod_price <span style="color: #0000FF;">as</span> ap <span style="color: #0000FF;">from</span> products;
+<span style="color: #8D8D84; font-style: italic;">-------+</span>
| ap    |
+<span style="color: #8D8D84; font-style: italic;">-------+</span>
|  <span style="color: #D0372D;">5</span>.<span style="color: #D0372D;">99</span> |
|  <span style="color: #D0372D;">9</span>.<span style="color: #D0372D;">99</span> |
| <span style="color: #D0372D;">14</span>.<span style="color: #D0372D;">99</span> |
| <span style="color: #D0372D;">13</span>.<span style="color: #D0372D;">00</span> |
| <span style="color: #D0372D;">10</span>.<span style="color: #D0372D;">00</span> |
|  <span style="color: #D0372D;">2</span>.<span style="color: #D0372D;">50</span> |
|  <span style="color: #D0372D;">3</span>.<span style="color: #D0372D;">42</span> |
| <span style="color: #D0372D;">35</span>.<span style="color: #D0372D;">00</span> |
| <span style="color: #D0372D;">55</span>.<span style="color: #D0372D;">00</span> |
|  <span style="color: #D0372D;">8</span>.<span style="color: #D0372D;">99</span> |
| <span style="color: #D0372D;">50</span>.<span style="color: #D0372D;">00</span> |
|  <span style="color: #D0372D;">4</span>.<span style="color: #D0372D;">49</span> |
|  <span style="color: #D0372D;">2</span>.<span style="color: #D0372D;">50</span> |
| <span style="color: #D0372D;">10</span>.<span style="color: #D0372D;">00</span> |
+<span style="color: #8D8D84; font-style: italic;">-------+</span>
<span style="color: #D0372D;">14</span> <span style="color: #0000FF;">rows</span> <span style="color: #0000FF;">in</span> <span style="color: #0000FF;">set</span> <span style="color: #707183;">(</span><span style="color: #D0372D;">0</span>.<span style="color: #D0372D;">00</span> sec<span style="color: #707183;">)</span>
</pre>
</div>
<p>
组合聚集函数
</p>
<div class="org-src-container">
<pre class="src src-sql">mysql&gt; <span style="color: #0000FF;">select</span> <span style="color: #006FE0;">count</span><span style="color: #707183;">(</span>*<span style="color: #707183;">)</span> <span style="color: #0000FF;">as</span> num_items,
-&gt; <span style="color: #006FE0;">min</span><span style="color: #707183;">(</span>prod_price<span style="color: #707183;">)</span> <span style="color: #0000FF;">AS</span> price_min,
-&gt; <span style="color: #006FE0;">max</span><span style="color: #707183;">(</span>prod_price<span style="color: #707183;">)</span> <span style="color: #0000FF;">AS</span> price_max,
-&gt; <span style="color: #006FE0;">AVG</span><span style="color: #707183;">(</span>prod_price<span style="color: #707183;">)</span> <span style="color: #0000FF;">AS</span> price_avg
-&gt; <span style="color: #0000FF;">from</span> products;
+<span style="color: #8D8D84; font-style: italic;">-----------+-----------+-----------+-----------+</span>
| num_items | price_min | price_max | price_avg |
+<span style="color: #8D8D84; font-style: italic;">-----------+-----------+-----------+-----------+</span>
|        <span style="color: #D0372D;">14</span> |      <span style="color: #D0372D;">2</span>.<span style="color: #D0372D;">50</span> |     <span style="color: #D0372D;">55</span>.<span style="color: #D0372D;">00</span> | <span style="color: #D0372D;">16</span>.<span style="color: #D0372D;">133571</span> |
+<span style="color: #8D8D84; font-style: italic;">-----------+-----------+-----------+-----------+</span>
<span style="color: #D0372D;">1</span> <span style="color: #6434A3;">row</span> <span style="color: #0000FF;">in</span> <span style="color: #0000FF;">set</span> <span style="color: #707183;">(</span><span style="color: #D0372D;">0</span>.<span style="color: #D0372D;">00</span> sec<span style="color: #707183;">)</span>
</pre>
</div>
</div>
</li>
</ol>
</div>
<div id="outline-container-org5b82188" class="outline-4">
<h4 id="org5b82188"><span class="section-number-4">3.12.14</span> 第十三章 分组数据 GROUP BY, HAVING</h4>
<div class="outline-text-4" id="text-3-12-14">
</div>
<ol class="org-ol">
<li><a id="orge0b0324"></a>GROUP BY<br />
<div class="outline-text-5" id="text-3-12-14-1">
<div class="org-src-container">
<pre class="src src-sql">mysql&gt; <span style="color: #0000FF;">select</span> vend_id, <span style="color: #006FE0;">count</span><span style="color: #707183;">(</span>*<span style="color: #707183;">)</span> <span style="color: #0000FF;">as</span> num_prods
-&gt; <span style="color: #0000FF;">from</span> products
-&gt; <span style="color: #0000FF;">group</span> <span style="color: #0000FF;">by</span> vend_id;
+<span style="color: #8D8D84; font-style: italic;">---------+-----------+</span>
| vend_id | num_prods |
+<span style="color: #8D8D84; font-style: italic;">---------+-----------+</span>
|    <span style="color: #D0372D;">1001</span> |         <span style="color: #D0372D;">3</span> |
|    <span style="color: #D0372D;">1002</span> |         <span style="color: #D0372D;">2</span> |
|    <span style="color: #D0372D;">1003</span> |         <span style="color: #D0372D;">7</span> |
|    <span style="color: #D0372D;">1005</span> |         <span style="color: #D0372D;">2</span> |
+<span style="color: #8D8D84; font-style: italic;">---------+-----------+</span>
<span style="color: #D0372D;">4</span> <span style="color: #0000FF;">rows</span> <span style="color: #0000FF;">in</span> <span style="color: #0000FF;">set</span> <span style="color: #707183;">(</span><span style="color: #D0372D;">0</span>.<span style="color: #D0372D;">00</span> sec<span style="color: #707183;">)</span>
</pre>
</div>

<div id="orge2f5e0a" class="figure">
<p><img src="reading/2020-11-25_10-48-19_screenshot.png" alt="2020-11-25_10-48-19_screenshot.png" />
</p>
</div>
</div>
</li>
<li><a id="org391ba5e"></a>HAVING 过滤分组<br />
<div class="outline-text-5" id="text-3-12-14-2">
<p>
与where的区别
</p>

<div id="orgd807b61" class="figure">
<p><img src="reading/2020-11-25_10-52-11_screenshot.png" alt="2020-11-25_10-52-11_screenshot.png" />
</p>
</div>
<div class="org-src-container">
<pre class="src src-sql">mysql&gt; <span style="color: #0000FF;">select</span> vend_id <span style="color: #0000FF;">from</span> products;
+<span style="color: #8D8D84; font-style: italic;">---------+</span>
| vend_id |
+<span style="color: #8D8D84; font-style: italic;">---------+</span>
|    <span style="color: #D0372D;">1001</span> |
|    <span style="color: #D0372D;">1001</span> |
|    <span style="color: #D0372D;">1001</span> |
|    <span style="color: #D0372D;">1002</span> |
|    <span style="color: #D0372D;">1002</span> |
|    <span style="color: #D0372D;">1003</span> |
|    <span style="color: #D0372D;">1003</span> |
|    <span style="color: #D0372D;">1003</span> |
|    <span style="color: #D0372D;">1003</span> |
|    <span style="color: #D0372D;">1003</span> |
|    <span style="color: #D0372D;">1003</span> |
|    <span style="color: #D0372D;">1003</span> |
|    <span style="color: #D0372D;">1005</span> |
|    <span style="color: #D0372D;">1005</span> |
+<span style="color: #8D8D84; font-style: italic;">---------+</span>
<span style="color: #D0372D;">14</span> <span style="color: #0000FF;">rows</span> <span style="color: #0000FF;">in</span> <span style="color: #0000FF;">set</span> <span style="color: #707183;">(</span><span style="color: #D0372D;">0</span>.<span style="color: #D0372D;">00</span> sec<span style="color: #707183;">)</span>


mysql&gt; <span style="color: #0000FF;">select</span> vend_id, <span style="color: #006FE0;">count</span><span style="color: #707183;">(</span>*<span style="color: #707183;">)</span> <span style="color: #0000FF;">as</span> num_prods
-&gt; <span style="color: #0000FF;">from</span> products
-&gt; <span style="color: #0000FF;">group</span> <span style="color: #0000FF;">by</span> vend_id
-&gt; <span style="color: #0000FF;">having</span> <span style="color: #006FE0;">count</span><span style="color: #707183;">(</span>*<span style="color: #707183;">)</span> &gt;= <span style="color: #D0372D;">2</span>;
+<span style="color: #8D8D84; font-style: italic;">---------+-----------+</span>
| vend_id | num_prods |
+<span style="color: #8D8D84; font-style: italic;">---------+-----------+</span>
|    <span style="color: #D0372D;">1001</span> |         <span style="color: #D0372D;">3</span> |
|    <span style="color: #D0372D;">1002</span> |         <span style="color: #D0372D;">2</span> |
|    <span style="color: #D0372D;">1003</span> |         <span style="color: #D0372D;">7</span> |
|    <span style="color: #D0372D;">1005</span> |         <span style="color: #D0372D;">2</span> |
+<span style="color: #8D8D84; font-style: italic;">---------+-----------+</span>
<span style="color: #D0372D;">4</span> <span style="color: #0000FF;">rows</span> <span style="color: #0000FF;">in</span> <span style="color: #0000FF;">set</span> <span style="color: #707183;">(</span><span style="color: #D0372D;">0</span>.<span style="color: #D0372D;">00</span> sec<span style="color: #707183;">)</span>
</pre>
</div>
</div>
</li>
<li><a id="org034b51d"></a>子句顺序<br />
<div class="outline-text-5" id="text-3-12-14-3">

<div id="orgeb96da0" class="figure">
<p><img src="reading/2020-11-25_11-01-54_screenshot.png" alt="2020-11-25_11-01-54_screenshot.png" />
</p>
</div>
</div>
</li>
</ol>
</div>
<div id="outline-container-orgb92ad46" class="outline-4">
<h4 id="orgb92ad46"><span class="section-number-4">3.12.15</span> 第十四章 子查询</h4>
<div class="outline-text-4" id="text-3-12-15">
<ol class="org-ol">
<li>作为 <b>where&#x2026;in&#x2026;</b> 的过滤条件</li>
</ol>
<div class="org-src-container">
<pre class="src src-sql">mysql&gt; <span style="color: #0000FF;">select</span> cust_name, cust_contact
-&gt; <span style="color: #0000FF;">from</span> customers
-&gt; <span style="color: #0000FF;">where</span> cust_id <span style="color: #0000FF;">in</span> <span style="color: #707183;">(</span><span style="color: #0000FF;">select</span> cust_id
-&gt;                   <span style="color: #0000FF;">from</span> orders
-&gt;                   <span style="color: #0000FF;">where</span> order_num <span style="color: #0000FF;">in</span> <span style="color: #7388D6;">(</span><span style="color: #0000FF;">select</span> order_num
-&gt;                                       <span style="color: #0000FF;">from</span> orderitems
-&gt;                                       <span style="color: #0000FF;">where</span> prod_id = <span style="color: #008000;">'TNT2'</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>;
+<span style="color: #8D8D84; font-style: italic;">----------------+--------------+</span>
| cust_name      | cust_contact |
+<span style="color: #8D8D84; font-style: italic;">----------------+--------------+</span>
| Coyote Inc.    | Y Lee        |
| Yosemite Place | Y Sam        |
+<span style="color: #8D8D84; font-style: italic;">----------------+--------------+</span>
<span style="color: #D0372D;">2</span> <span style="color: #0000FF;">rows</span> <span style="color: #0000FF;">in</span> <span style="color: #0000FF;">set</span> <span style="color: #707183;">(</span><span style="color: #D0372D;">0</span>.<span style="color: #D0372D;">01</span> sec<span style="color: #707183;">)</span>
</pre>
</div>
<p>
可以看到，一般where后的字段与select子句中要查询的字段相同
</p>

<ol class="org-ol">
<li><p>
作为计算字段使用子查询
</p>
<div class="org-src-container">
<pre class="src src-sql">mysql&gt; <span style="color: #0000FF;">select</span> cust_name
-&gt; ,cust_state,
-&gt; <span style="color: #707183;">(</span><span style="color: #0000FF;">select</span> <span style="color: #006FE0;">count</span><span style="color: #7388D6;">(</span>*<span style="color: #7388D6;">)</span>
-&gt; <span style="color: #0000FF;">from</span> orders
-&gt; <span style="color: #0000FF;">where</span> orders.cust_id = customers.cust_id<span style="color: #707183;">)</span> <span style="color: #0000FF;">as</span> orders
-&gt; <span style="color: #0000FF;">from</span> customers
-&gt; <span style="color: #0000FF;">order</span> <span style="color: #0000FF;">by</span> cust_name;
+<span style="color: #8D8D84; font-style: italic;">----------------+------------+--------+</span>
| cust_name      | cust_state | orders |
+<span style="color: #8D8D84; font-style: italic;">----------------+------------+--------+</span>
| Coyote Inc.    | MI         |      <span style="color: #D0372D;">2</span> |
| E Fudd         | IL         |      <span style="color: #D0372D;">1</span> |
| Mouse House    | OH         |      <span style="color: #D0372D;">0</span> |
| Wascals        | <span style="color: #0000FF;">IN</span>         |      <span style="color: #D0372D;">1</span> |
| Yosemite Place | AZ         |      <span style="color: #D0372D;">1</span> |
+<span style="color: #8D8D84; font-style: italic;">----------------+------------+--------+</span>
<span style="color: #D0372D;">5</span> <span style="color: #0000FF;">rows</span> <span style="color: #0000FF;">in</span> <span style="color: #0000FF;">set</span> <span style="color: #707183;">(</span><span style="color: #D0372D;">0</span>.<span style="color: #D0372D;">00</span> sec<span style="color: #707183;">)</span>
</pre>
</div></li>
</ol>
</div>
</div>
<div id="outline-container-org31ca06b" class="outline-4">
<h4 id="org31ca06b"><span class="section-number-4">3.12.16</span> 第十五章 联结表(join)</h4>
<div class="outline-text-4" id="text-3-12-16">
<div class="org-src-container">
<pre class="src src-sql">mysql&gt; <span style="color: #0000FF;">select</span> * <span style="color: #0000FF;">from</span> vendors;
+<span style="color: #8D8D84; font-style: italic;">---------+----------------+-----------------+-------------+------------+----------+--------------+</span>
| vend_id | vend_name      | vend_address    | vend_city   | vend_state | vend_zip | vend_country |
+<span style="color: #8D8D84; font-style: italic;">---------+----------------+-----------------+-------------+------------+----------+--------------+</span>
|    <span style="color: #D0372D;">1001</span> | Anvils R Us    | <span style="color: #D0372D;">123</span> Main Street | Southfield  | MI         | <span style="color: #D0372D;">48075</span>    | USA          |
|    <span style="color: #D0372D;">1002</span> | LT Supplies    | <span style="color: #D0372D;">500</span> Park Street | Anytown     | OH         | <span style="color: #D0372D;">44333</span>    | USA          |
|    <span style="color: #D0372D;">1003</span> | ACME           | <span style="color: #D0372D;">555</span> High Street | Los Angeles | CA         | <span style="color: #D0372D;">90046</span>    | USA          |
|    <span style="color: #D0372D;">1004</span> | Furball Inc.   | <span style="color: #D0372D;">1000</span> <span style="color: #D0372D;">5th</span> Avenue | <span style="color: #0000FF;">New</span> York    | NY         | <span style="color: #D0372D;">11111</span>    | USA          |
|    <span style="color: #D0372D;">1005</span> | Jet <span style="color: #0000FF;">Set</span>        | <span style="color: #D0372D;">42</span> Galaxy Road  | London      | <span style="color: #0000FF;">NULL</span>       | N16 <span style="color: #D0372D;">6PS</span>  | England      |
|    <span style="color: #D0372D;">1006</span> | Jouets Et Ours | <span style="color: #D0372D;">1</span> Rue Amusement | Paris       | <span style="color: #0000FF;">NULL</span>       | <span style="color: #D0372D;">45678</span>    | France       |
+<span style="color: #8D8D84; font-style: italic;">---------+----------------+-----------------+-------------+------------+----------+--------------+</span>
<span style="color: #D0372D;">6</span> <span style="color: #0000FF;">rows</span> <span style="color: #0000FF;">in</span> <span style="color: #0000FF;">set</span> <span style="color: #707183;">(</span><span style="color: #D0372D;">0</span>.<span style="color: #D0372D;">00</span> sec<span style="color: #707183;">)</span>

mysql&gt; <span style="color: #0000FF;">select</span> * <span style="color: #0000FF;">from</span> products;
+<span style="color: #8D8D84; font-style: italic;">---------+---------+----------------+------------+----------------------------------------------------------------+</span>
| prod_id | vend_id | prod_name      | prod_price | prod_desc                                                      |
+<span style="color: #8D8D84; font-style: italic;">---------+---------+----------------+------------+----------------------------------------------------------------+</span>
| ANV01   |    <span style="color: #D0372D;">1001</span> | .<span style="color: #D0372D;">5</span> ton anvil   |       <span style="color: #D0372D;">5</span>.<span style="color: #D0372D;">99</span> | .<span style="color: #D0372D;">5</span> ton anvil, black, complete <span style="color: #0000FF;">with</span> handy hook                  |
| ANV02   |    <span style="color: #D0372D;">1001</span> | <span style="color: #D0372D;">1</span> ton anvil    |       <span style="color: #D0372D;">9</span>.<span style="color: #D0372D;">99</span> | <span style="color: #D0372D;">1</span> ton anvil, black, complete <span style="color: #0000FF;">with</span> handy hook <span style="color: #0000FF;">and</span> carrying <span style="color: #0000FF;">case</span> |
| ANV03   |    <span style="color: #D0372D;">1001</span> | <span style="color: #D0372D;">2</span> ton anvil    |      <span style="color: #D0372D;">14</span>.<span style="color: #D0372D;">99</span> | <span style="color: #D0372D;">2</span> ton anvil, black, complete <span style="color: #0000FF;">with</span> handy hook <span style="color: #0000FF;">and</span> carrying <span style="color: #0000FF;">case</span> |
| DTNTR   |    <span style="color: #D0372D;">1003</span> | Detonator      |      <span style="color: #D0372D;">13</span>.<span style="color: #D0372D;">00</span> | Detonator <span style="color: #707183;">(</span>plunger powered<span style="color: #707183;">)</span>, fuses <span style="color: #0000FF;">not</span> included                |
| FB      |    <span style="color: #D0372D;">1003</span> | Bird seed      |      <span style="color: #D0372D;">10</span>.<span style="color: #D0372D;">00</span> | <span style="color: #6434A3;">Large</span> bag <span style="color: #707183;">(</span>suitable <span style="color: #0000FF;">for</span> road runners<span style="color: #707183;">)</span>                          |
| FC      |    <span style="color: #D0372D;">1003</span> | Carrots        |       <span style="color: #D0372D;">2</span>.<span style="color: #D0372D;">50</span> | Carrots <span style="color: #707183;">(</span>rabbit hunting season <span style="color: #0000FF;">only</span><span style="color: #707183;">)</span>                           |
| FU1     |    <span style="color: #D0372D;">1002</span> | Fuses          |       <span style="color: #D0372D;">3</span>.<span style="color: #D0372D;">42</span> | <span style="color: #D0372D;">1</span> dozen, extra long                                            |
| JP1000  |    <span style="color: #D0372D;">1005</span> | JetPack <span style="color: #D0372D;">1000</span>   |      <span style="color: #D0372D;">35</span>.<span style="color: #D0372D;">00</span> | JetPack <span style="color: #D0372D;">1000</span>, intended <span style="color: #0000FF;">for</span> single use                          |
| JP2000  |    <span style="color: #D0372D;">1005</span> | JetPack <span style="color: #D0372D;">2000</span>   |      <span style="color: #D0372D;">55</span>.<span style="color: #D0372D;">00</span> | JetPack <span style="color: #D0372D;">2000</span>, multi-use                                        |
| OL1     |    <span style="color: #D0372D;">1002</span> | Oil can        |       <span style="color: #D0372D;">8</span>.<span style="color: #D0372D;">99</span> | Oil can, red                                                   |
| SAFE    |    <span style="color: #D0372D;">1003</span> | Safe           |      <span style="color: #D0372D;">50</span>.<span style="color: #D0372D;">00</span> | Safe <span style="color: #0000FF;">with</span> combination lock                                     |
| SLING   |    <span style="color: #D0372D;">1003</span> | Sling          |       <span style="color: #D0372D;">4</span>.<span style="color: #D0372D;">49</span> | Sling, one <span style="color: #0000FF;">size</span> fits <span style="color: #0000FF;">all</span>                                       |
| TNT1    |    <span style="color: #D0372D;">1003</span> | TNT <span style="color: #707183;">(</span><span style="color: #D0372D;">1</span> stick<span style="color: #707183;">)</span>  |       <span style="color: #D0372D;">2</span>.<span style="color: #D0372D;">50</span> | TNT, red, single stick                                         |
| TNT2    |    <span style="color: #D0372D;">1003</span> | TNT <span style="color: #707183;">(</span><span style="color: #D0372D;">5</span> sticks<span style="color: #707183;">)</span> |      <span style="color: #D0372D;">10</span>.<span style="color: #D0372D;">00</span> | TNT, red, pack <span style="color: #0000FF;">of</span> <span style="color: #D0372D;">10</span> sticks                                    |
+<span style="color: #8D8D84; font-style: italic;">---------+---------+----------------+------------+----------------------------------------------------------------+</span>
<span style="color: #D0372D;">14</span> <span style="color: #0000FF;">rows</span> <span style="color: #0000FF;">in</span> <span style="color: #0000FF;">set</span> <span style="color: #707183;">(</span><span style="color: #D0372D;">0</span>.<span style="color: #D0372D;">00</span> sec<span style="color: #707183;">)</span>


mysql&gt; <span style="color: #0000FF;">select</span> vend_name, prod_name, prod_price
    -&gt; <span style="color: #0000FF;">from</span> vendors, products
    -&gt; <span style="color: #0000FF;">where</span> vendors.vend_id = products.vend_id
    -&gt; <span style="color: #0000FF;">order</span> <span style="color: #0000FF;">by</span> vend_name, prod_name;
+<span style="color: #8D8D84; font-style: italic;">-------------+----------------+------------+</span>
| vend_name   | prod_name      | prod_price |
+<span style="color: #8D8D84; font-style: italic;">-------------+----------------+------------+</span>
| ACME        | Bird seed      |      <span style="color: #D0372D;">10</span>.<span style="color: #D0372D;">00</span> |
| ACME        | Carrots        |       <span style="color: #D0372D;">2</span>.<span style="color: #D0372D;">50</span> |
| ACME        | Detonator      |      <span style="color: #D0372D;">13</span>.<span style="color: #D0372D;">00</span> |
| ACME        | Safe           |      <span style="color: #D0372D;">50</span>.<span style="color: #D0372D;">00</span> |
| ACME        | Sling          |       <span style="color: #D0372D;">4</span>.<span style="color: #D0372D;">49</span> |
| ACME        | TNT <span style="color: #707183;">(</span><span style="color: #D0372D;">1</span> stick<span style="color: #707183;">)</span>  |       <span style="color: #D0372D;">2</span>.<span style="color: #D0372D;">50</span> |
| ACME        | TNT <span style="color: #707183;">(</span><span style="color: #D0372D;">5</span> sticks<span style="color: #707183;">)</span> |      <span style="color: #D0372D;">10</span>.<span style="color: #D0372D;">00</span> |
| Anvils R Us | .<span style="color: #D0372D;">5</span> ton anvil   |       <span style="color: #D0372D;">5</span>.<span style="color: #D0372D;">99</span> |
| Anvils R Us | <span style="color: #D0372D;">1</span> ton anvil    |       <span style="color: #D0372D;">9</span>.<span style="color: #D0372D;">99</span> |
| Anvils R Us | <span style="color: #D0372D;">2</span> ton anvil    |      <span style="color: #D0372D;">14</span>.<span style="color: #D0372D;">99</span> |
| Jet <span style="color: #0000FF;">Set</span>     | JetPack <span style="color: #D0372D;">1000</span>   |      <span style="color: #D0372D;">35</span>.<span style="color: #D0372D;">00</span> |
| Jet <span style="color: #0000FF;">Set</span>     | JetPack <span style="color: #D0372D;">2000</span>   |      <span style="color: #D0372D;">55</span>.<span style="color: #D0372D;">00</span> |
| LT Supplies | Fuses          |       <span style="color: #D0372D;">3</span>.<span style="color: #D0372D;">42</span> |
| LT Supplies | Oil can        |       <span style="color: #D0372D;">8</span>.<span style="color: #D0372D;">99</span> |
+<span style="color: #8D8D84; font-style: italic;">-------------+----------------+------------+</span>
<span style="color: #D0372D;">14</span> <span style="color: #0000FF;">rows</span> <span style="color: #0000FF;">in</span> <span style="color: #0000FF;">set</span> <span style="color: #707183;">(</span><span style="color: #D0372D;">0</span>.<span style="color: #D0372D;">00</span> sec  <span style="color: #707183;">)</span>
</pre>
</div>
<p>
那么14章的子查询例子也可以写成联结：
</p>
<div class="org-src-container">
<pre class="src src-shell">mysql&gt; select cust_name, cust_contact
-&gt; from customers, orders, orderitems
-&gt; where customers.cust_id = orders.cust_id
-&gt; and orderitems.order_num = orders.order_num
-&gt; and prod_id = <span style="color: #008000;">'TNT2'</span>;
    +----------------+--------------+
    | cust_name      | cust_contact |
    +----------------+--------------+
    | Coyote Inc.    | Y Lee        |
    | Yosemite Place | Y Sam        |
    +----------------+--------------+
    <span style="color: #D0372D;">2</span> rows<span style="color: #0000FF;"> in</span> set <span style="color: #707183;">(</span><span style="color: #D0372D;">0.00</span> sec<span style="color: #707183;">)</span>
</pre>
</div>

<div id="org4c7a11e" class="figure">
<p><img src="reading/2020-11-25_14-35-22_screenshot.png" alt="2020-11-25_14-35-22_screenshot.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-org4e56212" class="outline-4">
<h4 id="org4e56212"><span class="section-number-4">3.12.17</span> 第十六章 高级联结</h4>
<div class="outline-text-4" id="text-3-12-17">
</div>
<ol class="org-ol">
<li><a id="org0ed92a5"></a>自联结<br />
<div class="outline-text-5" id="text-3-12-17-1">
<p>
下面例子找到prod<sub>id</sub> = 'DINTR'的商品所属生产商的所有商品:
</p>
<div class="org-src-container">
<pre class="src src-sql">mysql&gt; <span style="color: #0000FF;">select</span> p1.prod_id, p1.prod_name
-&gt; <span style="color: #0000FF;">from</span> products <span style="color: #0000FF;">as</span> p1, products <span style="color: #0000FF;">as</span> p2
-&gt; <span style="color: #0000FF;">where</span> p1.vend_id = p2.vend_id
-&gt; <span style="color: #0000FF;">and</span> p2.prod_id = <span style="color: #008000;">'DTNTR'</span>;
+<span style="color: #8D8D84; font-style: italic;">---------+----------------+</span>
| prod_id | prod_name      |
+<span style="color: #8D8D84; font-style: italic;">---------+----------------+</span>
| DTNTR   | Detonator      |
| FB      | Bird seed      |
| FC      | Carrots        |
| SAFE    | Safe           |
| SLING   | Sling          |
| TNT1    | TNT <span style="color: #707183;">(</span><span style="color: #D0372D;">1</span> stick<span style="color: #707183;">)</span>  |
| TNT2    | TNT <span style="color: #707183;">(</span><span style="color: #D0372D;">5</span> sticks<span style="color: #707183;">)</span> |
+<span style="color: #8D8D84; font-style: italic;">---------+----------------+</span>
<span style="color: #D0372D;">7</span> <span style="color: #0000FF;">rows</span> <span style="color: #0000FF;">in</span> <span style="color: #0000FF;">set</span> <span style="color: #707183;">(</span><span style="color: #D0372D;">0</span>.<span style="color: #D0372D;">03</span> sec<span style="color: #707183;">)</span>
</pre>
</div>
<p>
上面的例子还有个点就是表别名p1,p2
</p>
</div>
</li>
<li><a id="orga88f53e"></a>自然联结<br />
<div class="outline-text-5" id="text-3-12-17-2">
<p>
自然联结排除相同列的多次出现，使每个列只返回一次
</p>
</div>
</li>
<li><a id="org7099938"></a>外部联结<br />
<div class="outline-text-5" id="text-3-12-17-3">
<div class="org-src-container">
<pre class="src src-sql">&#20869;&#32852;&#32467;&#65292;&#21482;&#26377;order_num&#20013;&#26377;&#20851;&#32852;&#34892;&#26102;cust_id&#25165;&#20250;&#20445;&#30041;
mysql&gt; <span style="color: #0000FF;">select</span> customers.cust_id, orders.order_num
-&gt; <span style="color: #0000FF;">from</span> customers <span style="color: #0000FF;">inner</span> <span style="color: #0000FF;">join</span> orders
-&gt; <span style="color: #0000FF;">on</span> customers.cust_id = orders.cust_id
-&gt; ;
+<span style="color: #8D8D84; font-style: italic;">---------+-----------+</span>
| cust_id | order_num |
+<span style="color: #8D8D84; font-style: italic;">---------+-----------+</span>
|   <span style="color: #D0372D;">10001</span> |     <span style="color: #D0372D;">20005</span> |
|   <span style="color: #D0372D;">10001</span> |     <span style="color: #D0372D;">20009</span> |
|   <span style="color: #D0372D;">10003</span> |     <span style="color: #D0372D;">20006</span> |
|   <span style="color: #D0372D;">10004</span> |     <span style="color: #D0372D;">20007</span> |
|   <span style="color: #D0372D;">10005</span> |     <span style="color: #D0372D;">20008</span> |
+<span style="color: #8D8D84; font-style: italic;">---------+-----------+</span>
<span style="color: #D0372D;">5</span> <span style="color: #0000FF;">rows</span> <span style="color: #0000FF;">in</span> <span style="color: #0000FF;">set</span> <span style="color: #707183;">(</span><span style="color: #D0372D;">0</span>.<span style="color: #D0372D;">00</span> sec<span style="color: #707183;">)</span>


&#22806;&#32852;&#32467;&#65292;&#19981;&#31649;order_num&#20013;&#26377;&#27809;&#26377;&#20851;&#32852;&#30340;&#25968;&#25454;&#65292;&#25152;&#26377;cust_id&#37117;&#20250;&#20986;&#29616;
mysql&gt; <span style="color: #0000FF;">select</span> customers.cust_id, orders.order_num <span style="color: #0000FF;">from</span> customers <span style="color: #0000FF;">left</span> <span style="color: #0000FF;">outer</span> <span style="color: #0000FF;">join</span> orders <span style="color: #0000FF;">on</span> customers.cust_id = orders.cust_id;
+<span style="color: #8D8D84; font-style: italic;">---------+-----------+</span>
| cust_id | order_num |
+<span style="color: #8D8D84; font-style: italic;">---------+-----------+</span>
|   <span style="color: #D0372D;">10001</span> |     <span style="color: #D0372D;">20005</span> |
|   <span style="color: #D0372D;">10001</span> |     <span style="color: #D0372D;">20009</span> |
|   <span style="color: #D0372D;">10002</span> |      <span style="color: #0000FF;">NULL</span> |
|   <span style="color: #D0372D;">10003</span> |     <span style="color: #D0372D;">20006</span> |
|   <span style="color: #D0372D;">10004</span> |     <span style="color: #D0372D;">20007</span> |
|   <span style="color: #D0372D;">10005</span> |     <span style="color: #D0372D;">20008</span> |
+<span style="color: #8D8D84; font-style: italic;">---------+-----------+</span>
<span style="color: #D0372D;">6</span> <span style="color: #0000FF;">rows</span> <span style="color: #0000FF;">in</span> <span style="color: #0000FF;">set</span> <span style="color: #707183;">(</span><span style="color: #D0372D;">0</span>.<span style="color: #D0372D;">00</span> sec<span style="color: #707183;">)</span>
</pre>
</div>
</div>
</li>
<li><a id="orgca99c28"></a>注意事项<br />
<div class="outline-text-5" id="text-3-12-17-4">

<div id="orgeb7db35" class="figure">
<p><img src="reading/2020-11-25_15-36-24_screenshot.png" alt="2020-11-25_15-36-24_screenshot.png" />
</p>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-orgccbc86c" class="outline-4">
<h4 id="orgccbc86c"><span class="section-number-4">3.12.18</span> 第十七章 组合查询 UNION</h4>
<div class="outline-text-4" id="text-3-12-18">
<div class="org-src-container">
<pre class="src src-sql">mysql&gt; <span style="color: #0000FF;">select</span> vend_id,prod_id,prod_price
-&gt; <span style="color: #0000FF;">from</span> products
-&gt; <span style="color: #0000FF;">where</span> prod_price &lt;= <span style="color: #D0372D;">5</span>
-&gt; <span style="color: #0000FF;">union</span>
-&gt; <span style="color: #0000FF;">select</span> vend_id, prod_id, prod_price
-&gt; <span style="color: #0000FF;">from</span> products
-&gt; <span style="color: #0000FF;">where</span> vend_id <span style="color: #0000FF;">in</span> <span style="color: #707183;">(</span><span style="color: #D0372D;">1001</span>,<span style="color: #D0372D;">1002</span><span style="color: #707183;">)</span>
-&gt; <span style="color: #0000FF;">order</span> <span style="color: #0000FF;">by</span> vend_id, prod_price;
ERROR <span style="color: #D0372D;">2006</span> <span style="color: #707183;">(</span>HY000<span style="color: #707183;">)</span>: MySQL server has gone away
<span style="color: #0000FF;">No</span> <span style="color: #0000FF;">connection</span>. Trying <span style="color: #0000FF;">to</span> reconnect...
<span style="color: #0000FF;">Connection</span> id:    <span style="color: #D0372D;">10</span>
<span style="color: #0000FF;">Current</span> database: mysql&#24517;&#30693;&#24517;&#20250;

+<span style="color: #8D8D84; font-style: italic;">---------+---------+------------+</span>
| vend_id | prod_id | prod_price |
+<span style="color: #8D8D84; font-style: italic;">---------+---------+------------+</span>
|    <span style="color: #D0372D;">1001</span> | ANV01   |       <span style="color: #D0372D;">5</span>.<span style="color: #D0372D;">99</span> |
|    <span style="color: #D0372D;">1001</span> | ANV02   |       <span style="color: #D0372D;">9</span>.<span style="color: #D0372D;">99</span> |
|    <span style="color: #D0372D;">1001</span> | ANV03   |      <span style="color: #D0372D;">14</span>.<span style="color: #D0372D;">99</span> |
|    <span style="color: #D0372D;">1002</span> | FU1     |       <span style="color: #D0372D;">3</span>.<span style="color: #D0372D;">42</span> |
|    <span style="color: #D0372D;">1002</span> | OL1     |       <span style="color: #D0372D;">8</span>.<span style="color: #D0372D;">99</span> |
|    <span style="color: #D0372D;">1003</span> | FC      |       <span style="color: #D0372D;">2</span>.<span style="color: #D0372D;">50</span> |
|    <span style="color: #D0372D;">1003</span> | TNT1    |       <span style="color: #D0372D;">2</span>.<span style="color: #D0372D;">50</span> |
|    <span style="color: #D0372D;">1003</span> | SLING   |       <span style="color: #D0372D;">4</span>.<span style="color: #D0372D;">49</span> |
+<span style="color: #8D8D84; font-style: italic;">---------+---------+------------+</span>
<span style="color: #D0372D;">8</span> <span style="color: #0000FF;">rows</span> <span style="color: #0000FF;">in</span> <span style="color: #0000FF;">set</span> <span style="color: #707183;">(</span><span style="color: #D0372D;">0</span>.<span style="color: #D0372D;">13</span> sec<span style="color: #707183;">)</span>
</pre>
</div>

<p>
union all (保留重复行)
</p>
<div class="org-src-container">
<pre class="src src-sql">mysql&gt; <span style="color: #0000FF;">select</span> vend_id,prod_id,prod_price
<span style="color: #0000FF;">from</span> products
<span style="color: #0000FF;">where</span> prod_price &lt;= <span style="color: #D0372D;">5</span>
<span style="color: #0000FF;">union</span> <span style="color: #0000FF;">all</span>
<span style="color: #0000FF;">select</span> vend_id, prod_id, prod_price
<span style="color: #0000FF;">from</span> products
<span style="color: #0000FF;">where</span> vend_id <span style="color: #0000FF;">in</span> <span style="color: #707183;">(</span><span style="color: #D0372D;">1001</span>,<span style="color: #D0372D;">1002</span><span style="color: #707183;">)</span>
<span style="color: #0000FF;">order</span> <span style="color: #0000FF;">by</span> vend_id, prod_price;

+<span style="color: #8D8D84; font-style: italic;">---------+---------+------------+</span>
| vend_id | prod_id | prod_price |
+<span style="color: #8D8D84; font-style: italic;">---------+---------+------------+</span>
|    <span style="color: #D0372D;">1001</span> | ANV01   |       <span style="color: #D0372D;">5</span>.<span style="color: #D0372D;">99</span> |
|    <span style="color: #D0372D;">1001</span> | ANV02   |       <span style="color: #D0372D;">9</span>.<span style="color: #D0372D;">99</span> |
|    <span style="color: #D0372D;">1001</span> | ANV03   |      <span style="color: #D0372D;">14</span>.<span style="color: #D0372D;">99</span> |
|    <span style="color: #D0372D;">1002</span> | FU1     |       <span style="color: #D0372D;">3</span>.<span style="color: #D0372D;">42</span> |
|    <span style="color: #D0372D;">1002</span> | FU1     |       <span style="color: #D0372D;">3</span>.<span style="color: #D0372D;">42</span> |    &#37325;&#22797;
|    <span style="color: #D0372D;">1002</span> | OL1     |       <span style="color: #D0372D;">8</span>.<span style="color: #D0372D;">99</span> |
|    <span style="color: #D0372D;">1003</span> | FC      |       <span style="color: #D0372D;">2</span>.<span style="color: #D0372D;">50</span> |
|    <span style="color: #D0372D;">1003</span> | TNT1    |       <span style="color: #D0372D;">2</span>.<span style="color: #D0372D;">50</span> |
|    <span style="color: #D0372D;">1003</span> | SLING   |       <span style="color: #D0372D;">4</span>.<span style="color: #D0372D;">49</span> |
+<span style="color: #8D8D84; font-style: italic;">---------+---------+------------+</span>
<span style="color: #D0372D;">9</span> <span style="color: #0000FF;">rows</span> <span style="color: #0000FF;">in</span> <span style="color: #0000FF;">set</span> <span style="color: #707183;">(</span><span style="color: #D0372D;">0</span>.<span style="color: #D0372D;">00</span> sec<span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgb55c13c" class="outline-4">
<h4 id="orgb55c13c"><span class="section-number-4">3.12.19</span> <span class="todo TODO">TODO</span> 第十八章 全文搜索</h4>
</div>
<div id="outline-container-org5ae1622" class="outline-4">
<h4 id="org5ae1622"><span class="section-number-4">3.12.20</span> 第十九章 插入数据 INSERT</h4>
<div class="outline-text-4" id="text-3-12-20">
</div>
<ol class="org-ol">
<li><a id="org452b9f3"></a>1. 插入完整的行<br />
<div class="outline-text-5" id="text-3-12-20-1">
<p>
一般不要使用没有明确给出列的列表的insert语句，降低耦合性
</p>
<div class="org-src-container">
<pre class="src src-sql">mysql&gt; <span style="color: #0000FF;">insert</span> <span style="color: #0000FF;">into</span> customers<span style="color: #707183;">(</span>cust_name,
-&gt; cust_address,
-&gt; cust_city,
-&gt; cust_state,
-&gt; cust_zip,
-&gt; cust_country,
-&gt; cust_contact,
-&gt; cust_email<span style="color: #707183;">)</span>
-&gt; <span style="color: #0000FF;">value</span><span style="color: #707183;">(</span><span style="color: #008000;">'Pep E. LaPew'</span>,
-&gt; <span style="color: #008000;">'100 Main Street'</span>,
-&gt; <span style="color: #008000;">'Los Angeles'</span>,
-&gt; <span style="color: #008000;">'CA'</span>,
-&gt; <span style="color: #008000;">'90046'</span>,
-&gt; <span style="color: #008000;">'USA'</span>,
-&gt; <span style="color: #0000FF;">null</span>,
-&gt; <span style="color: #0000FF;">null</span><span style="color: #707183;">)</span>;
Query OK, <span style="color: #D0372D;">1</span> <span style="color: #6434A3;">row</span> affected <span style="color: #707183;">(</span><span style="color: #D0372D;">0</span>.<span style="color: #D0372D;">06</span> sec<span style="color: #707183;">)</span>
</pre>
</div>

<div id="org916a433" class="figure">
<p><img src="reading/2020-11-26_09-50-46_screenshot.png" alt="2020-11-26_09-50-46_screenshot.png" />
</p>
</div>
</div>
</li>

<li><a id="orgf5a60eb"></a>2. 插入部分行<br />
<div class="outline-text-5" id="text-3-12-20-2">

<div id="org1a35c6a" class="figure">
<p><img src="reading/2020-11-26_09-59-07_screenshot.png" alt="2020-11-26_09-59-07_screenshot.png" />
</p>
</div>
</div>
</li>

<li><a id="org966b6f6"></a>3. 插入多行<br />
<div class="outline-text-5" id="text-3-12-20-3">
<p>
单条insert语句处理多个插入比使用多条insert语句快.
</p>

<div id="orgfcc6a87" class="figure">
<p><img src="reading/2020-11-26_09-53-15_screenshot.png" alt="2020-11-26_09-53-15_screenshot.png" />
</p>
</div>
</div>
</li>

<li><a id="orgb0dc911"></a>4. 插入select检索出的数据<br />
<div class="outline-text-5" id="text-3-12-20-4">

<div id="org55a23a9" class="figure">
<p><img src="reading/2020-11-26_09-55-12_screenshot.png" alt="2020-11-26_09-55-12_screenshot.png" />
</p>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-org19b2d98" class="outline-4">
<h4 id="org19b2d98"><span class="section-number-4">3.12.21</span> 使用数据处理函数</h4>
</div>
<div id="outline-container-org0d562d3" class="outline-4">
<h4 id="org0d562d3"><span class="section-number-4">3.12.22</span> 附录B 例子安装</h4>
<div class="outline-text-4" id="text-3-12-22">
<div class="org-src-container">
<pre class="src src-shell">mysql&gt; create database mysql&#24517;&#30693;&#24517;&#20250;;
mysql&gt; use mysql&#24517;&#30693;&#24517;&#20250;
mysql&gt; source /Users/binbinyang/Downloads/mysql_scripts/create.sql
mysql&gt; source /Users/binbinyang/Downloads/mysql_scripts/populate.sql
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orga35ab6b" class="outline-3">
<h3 id="orga35ab6b"><span class="section-number-3">3.13</span> linux shell 脚本攻略 <a href="file:///Users/binbinyang/Documents/LINUX SHELL脚本攻略(中文版带书签).pdf">pdf</a></h3>
<div class="outline-text-3" id="text-3-13">
</div>
<div id="outline-container-org671255b" class="outline-4">
<h4 id="org671255b"><span class="section-number-4">3.13.1</span> 第一章</h4>
<div class="outline-text-4" id="text-3-13-1">
</div>
<ol class="org-ol">
<li><a id="org487c355"></a>!#<br />
<div class="outline-text-5" id="text-3-13-1-1">
<p>
现在假设当前目录有一个名为script.sh的脚本文件
如果将脚本作为sh的命令行参数来运行，那么脚本中的shebang(#!)行也就没什么用处了:
sh script.sh
</p>

<p>
我们可以给它加上执行权限来去掉sh直接运行它
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">&#21152;&#25191;&#34892;&#26435;&#38480;</span>
chmod a+x script.sh

<span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">&#25191;&#34892;</span>
./script.sh

<span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">&#22914;&#26524;script.sh&#25152;&#22312;&#30446;&#24405;&#22312;&#29615;&#22659;&#21464;&#37327;PATH&#20013;&#65292;&#29978;&#33267;&#21487;&#20197;&#30452;&#25509;&#36816;&#34892;</span>
script.sh
</pre>
</div>
</div>
</li>

<li><a id="org7f9389c"></a>引用 \ '和"<br />
<div class="outline-text-5" id="text-3-13-1-2">
<p>
' " 和什么都不加都各有各的副作用:
</p>
<div class="org-src-container">
<pre class="src src-shell">~/l/l/linux-shell-&#33050;&#26412;&#25915;&#30053; &#10095;&#10095;&#10095; echo hello;hello                         <span style="color: #D0372D;">14:59:02</span>
hello
fish: Unknown command: hello
fish:
<span style="color: #006FE0;">echo</span> hello;hello
^
~/l/l/linux-shell-&#33050;&#26412;&#25915;&#30053; &#10095;&#10095;&#10095; echo <span style="color: #008000;">'$var'</span>                              <span style="color: #D0372D;">15:01:38</span>
$<span style="color: #BA36A5;">var</span>
~/l/l/linux-shell-&#33050;&#26412;&#25915;&#30053; &#10095;&#10095;&#10095; echo $<span style="color: #BA36A5;">var</span>                                <span style="color: #D0372D;">15:02:28</span>

bash-3.2$ echo <span style="color: #008000;">"hello !"</span>
bash: !<span style="color: #008000;">": event not found</span>
</pre>
</div>
<p>
<b>相当于\是细粒度的强引用，'是粗粒度的强(全部)引用， "是粗粒度的弱(部分)引用(不对$ ` \ 三个符号起作用)</b>
</p>
</div>
</li>
<li><a id="org66f412f"></a>变量<br />
<div class="outline-text-5" id="text-3-13-1-3">
<ol class="org-ol">
<li>变量赋值语法：
var=value
=左右不能有空格，有空格的是相等操作</li>
<li><p>
获取字符串变量长度
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #BA36A5;">var</span>=<span style="color: #D0372D;">1234567890</span>
<span style="color: #006FE0;">echo</span> $<span style="color: #707183;">{</span>#<span style="color: #BA36A5;">var</span><span style="color: #707183;">}</span>

&#32467;&#26524;&#20026;10
</pre>
</div></li>
</ol>
</div>
</li>
<li><a id="org0baa8f6"></a>通过shell进行数学运算<br />
<div class="outline-text-5" id="text-3-13-1-4">
<p>
在bash shell环境中，可以利用 <b>let</b> ， <b>(())</b> 和 <b>[]</b> 执行基本的算术操作。
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #BA36A5;">nol</span>=<span style="color: #D0372D;">4</span>
<span style="color: #BA36A5;">no2</span>=<span style="color: #D0372D;">5</span>
let <span style="color: #BA36A5;">result</span>=no1+no2
let no1++
let no1--
let no1+=<span style="color: #D0372D;">6</span>
let no1-=<span style="color: #D0372D;">6</span>

<span style="color: #BA36A5;">result</span>=$<span style="color: #707183;">[</span> no1 + no2 <span style="color: #707183;">]</span>
<span style="color: #BA36A5;">result</span>=$<span style="color: #707183;">[</span> $<span style="color: #BA36A5;">no1</span> + <span style="color: #D0372D;">5</span><span style="color: #707183;">]</span>
<span style="color: #BA36A5;">result</span>=$<span style="color: #707183;">[</span> $<span style="color: #BA36A5;">no1</span> + $<span style="color: #BA36A5;">no2</span><span style="color: #707183;">]</span>

<span style="color: #BA36A5;">result</span>=$<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span> no1 + <span style="color: #D0372D;">5</span> <span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #BA36A5;">result</span>=$<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>no1+5<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #BA36A5;">result</span>=<span style="color: #FF1493;">`expr 3 + 4`</span>
<span style="color: #BA36A5;">result</span>=$<span style="color: #707183;">(</span>expr $<span style="color: #BA36A5;">no1</span> + <span style="color: #D0372D;">5</span><span style="color: #707183;">)</span>

</pre>
</div>
<p>
而在进行高级操作时，可以用 <b>expr</b> 和 <b>bc</b> 。
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #006FE0;">echo</span> <span style="color: #008000;">"4 * 0.56"</span> | bc

<span style="color: #BA36A5;">no</span>=<span style="color: #D0372D;">54</span>
<span style="color: #BA36A5;">result</span>=<span style="color: #FF1493;">`echo "$no * 1.5`</span> | bc

</pre>
</div>
</div>
</li>
<li><a id="orgb1700b0"></a>数组和关联数组(map)<br />
<div class="outline-text-5" id="text-3-13-1-5">
<div class="org-src-container">
<pre class="src src-sh">bash-3.2$ <span style="color: #BA36A5;">arr</span>=<span style="color: #707183;">{</span><span style="color: #D0372D;">1</span> <span style="color: #D0372D;">2</span> <span style="color: #D0372D;">3</span><span style="color: #707183;">}</span>       <span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">&#38169;&#35823;&#65292;&#24517;&#39035;&#29992;()</span>
bash: <span style="color: #D0372D;">2:</span> command not found

bash-3.2$ <span style="color: #BA36A5;">arr</span>=<span style="color: #707183;">(</span><span style="color: #D0372D;">1</span> <span style="color: #D0372D;">2</span> <span style="color: #D0372D;">3</span><span style="color: #707183;">)</span>
bash-3.2$ echo $<span style="color: #BA36A5;">arr</span><span style="color: #707183;">[</span><span style="color: #D0372D;">1</span><span style="color: #707183;">]</span>     <span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">&#38169;&#35823;&#65292;&#24517;&#39035;&#29992;{}&#25324;&#36215;&#26469;,&#19981;&#28982;&#20250;&#30452;&#25509;&#35299;&#26512;&#25104;$arr&#65292;&#32780;&#36825;&#20010;&#20540;&#26159;arr&#30340;&#31532;&#19968;&#20010;&#20803;&#32032;</span>
<span style="color: #D0372D;">1</span><span style="color: #707183;">[</span><span style="color: #D0372D;">1</span><span style="color: #707183;">]</span>
bash-3.2$ echo $<span style="color: #BA36A5;">arr</span><span style="color: #707183;">[</span><span style="color: #D0372D;">2</span><span style="color: #707183;">]</span>
<span style="color: #D0372D;">1</span><span style="color: #707183;">[</span><span style="color: #D0372D;">2</span><span style="color: #707183;">]</span>
bash-3.2$ echo $<span style="color: #BA36A5;">arr</span><span style="color: #707183;">[</span><span style="color: #D0372D;">3</span><span style="color: #707183;">]</span>
<span style="color: #D0372D;">1</span><span style="color: #707183;">[</span><span style="color: #D0372D;">3</span><span style="color: #707183;">]</span>
bash-3.2$ echo $<span style="color: #707183;">{</span><span style="color: #BA36A5;">arr</span><span style="color: #7388D6;">[</span><span style="color: #D0372D;">3</span><span style="color: #7388D6;">]</span><span style="color: #707183;">}</span>

bash-3.2$ echo $<span style="color: #707183;">{</span><span style="color: #BA36A5;">arr</span><span style="color: #7388D6;">[</span><span style="color: #D0372D;">2</span><span style="color: #7388D6;">]</span><span style="color: #707183;">}</span>
<span style="color: #D0372D;">3</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">!/bin/</span><span style="color: #0000FF;">bash</span>
<span style="color: #BA36A5;">arr</span>=<span style="color: #707183;">(</span><span style="color: #D0372D;">1</span> <span style="color: #D0372D;">2</span> <span style="color: #D0372D;">3</span><span style="color: #707183;">)</span>
<span style="color: #BA36A5;">arr</span>=<span style="color: #707183;">[</span><span style="color: #008000;">"fk"</span><span style="color: #707183;">]</span>=<span style="color: #008000;">"keyi"</span>
<span style="color: #006FE0;">echo</span> $<span style="color: #707183;">{</span><span style="color: #BA36A5;">arr</span><span style="color: #7388D6;">[</span>*<span style="color: #7388D6;">]</span><span style="color: #707183;">}</span>
<span style="color: #006FE0;">echo</span> $<span style="color: #707183;">{</span><span style="color: #BA36A5;">arr</span><span style="color: #7388D6;">[</span><span style="color: #008000;">"fk"</span><span style="color: #7388D6;">]</span><span style="color: #707183;">}</span>
<span style="color: #006FE0;">echo</span> $<span style="color: #707183;">{</span><span style="color: #BA36A5;">arr</span><span style="color: #7388D6;">[</span><span style="color: #D0372D;">0</span><span style="color: #7388D6;">]</span><span style="color: #707183;">}</span>

</pre>
</div>
<p>
上面的运行结果为:
</p>

<p>
keyi 2 3
keyi
keyi
</p>

<p>
所以在数组上执行map类似的操作会总是覆盖数组的第一个元素
TODO map怎么声明
</p>
</div>
</li>
<li><a id="orgafda4fe"></a>调试<br />
<div class="outline-text-5" id="text-3-13-1-6">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">!/bin/</span><span style="color: #0000FF;">bash</span>
<span style="color: #0000FF;">function</span> <span style="color: #006699;">DEBUG</span><span style="color: #707183;">(){</span>
    <span style="color: #7388D6;">[</span> <span style="color: #008000;">"$_DEBUG"</span> == <span style="color: #008000;">"on"</span> <span style="color: #7388D6;">]</span> &amp;&amp; $<span style="color: #BA36A5;">@</span> || :
<span style="color: #707183;">}</span>

<span style="color: #0000FF;">for</span> i<span style="color: #0000FF;"> in</span> <span style="color: #707183;">{</span><span style="color: #D0372D;">1..10</span><span style="color: #707183;">}</span>
<span style="color: #0000FF;">do</span>
    DEBUG echo $<span style="color: #BA36A5;">i</span>
<span style="color: #0000FF;">done</span>


~/l/l/linux-shell-&#33050;&#26412;&#25915;&#30053; &#10095;&#10095;&#10095; ./debug.sh                               <span style="color: #D0372D;">17:59:16</span>
~/l/l/linux-shell-&#33050;&#26412;&#25915;&#30053; &#10095;&#10095;&#10095; <span style="color: #BA36A5;">_DEBUG</span>=on ./debug.sh                     <span style="color: #D0372D;">17:59:18</span>
<span style="color: #D0372D;">1</span>
<span style="color: #D0372D;">2</span>
<span style="color: #D0372D;">3</span>
<span style="color: #D0372D;">4</span>
<span style="color: #D0372D;">5</span>
<span style="color: #D0372D;">6</span>
<span style="color: #D0372D;">7</span>
<span style="color: #D0372D;">8</span>
<span style="color: #D0372D;">9</span>
<span style="color: #D0372D;">10</span>
</pre>
</div>
</div>
</li>
<li><a id="orge63601e"></a>函数<br />
<div class="outline-text-5" id="text-3-13-1-7">

<div id="org8475df3" class="figure">
<p><img src="reading/2020-11-26_18-03-18_screenshot.png" alt="2020-11-26_18-03-18_screenshot.png" />
</p>
</div>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">!/bin/</span><span style="color: #0000FF;">bash</span>
<span style="color: #006699;">func</span><span style="color: #707183;">(){</span>
    <span style="color: #006FE0;">echo</span> $<span style="color: #D0372D;">1,</span>$<span style="color: #D0372D;">2</span>
    <span style="color: #006FE0;">echo</span> $<span style="color: #D0372D;">1</span>
    <span style="color: #0000FF;">return</span> <span style="color: #D0372D;">0</span>
<span style="color: #707183;">}</span>

func <span style="color: #D0372D;">1</span> <span style="color: #D0372D;">2</span> <span style="color: #D0372D;">3</span>


&#25191;&#34892;&#32467;&#26524;&#65306;
~/l/l/linux-shell-&#33050;&#26412;&#25915;&#30053; &#10095;&#10095;&#10095; ./func.sh                             <span style="color: #D0372D;">18:05:47</span>
<span style="color: #D0372D;">1,2</span>
<span style="color: #D0372D;">1</span>
</pre>
</div>
</div>
<ol class="org-ol">
<li><a id="org9129ba4"></a>递归<br />
<div class="outline-text-6" id="text-3-13-1-7-1">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">!/bin/</span><span style="color: #0000FF;">bash</span>
<span style="color: #006699;">f</span><span style="color: #707183;">(){</span>
    <span style="color: #006FE0;">echo</span> $<span style="color: #D0372D;">1</span>
    f hello
    sleep <span style="color: #D0372D;">1</span>
    <span style="color: #0000FF;">return</span> <span style="color: #D0372D;">0</span>
<span style="color: #707183;">}</span>
f parent

</pre>
</div>
</div>
</li>
<li><a id="org237c83e"></a>fork炸弹<br />
<div class="outline-text-6" id="text-3-13-1-7-2">
<p>
<a href="http://www.ha97.com/2618.html">http://www.ha97.com/2618.html</a> 
</p>
</div>
</li>
<li><a id="orgb0c7f2d"></a>导出函数<br />
<div class="outline-text-6" id="text-3-13-1-7-3">
<p>
export -f fname
</p>
</div>
</li>
</ol>
</li>
<li><a id="orgbff02df"></a>read命令<br />
<div class="outline-text-5" id="text-3-13-1-8">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">!/bin/</span><span style="color: #0000FF;">bash</span>
<span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">&#35835;&#20837;2&#20010;&#23383;&#31526;&#20316;&#20026;var&#30340;&#20540;</span>
<span style="color: #006FE0;">read</span> -n <span style="color: #D0372D;">2</span> var
<span style="color: #006FE0;">echo</span> $<span style="color: #BA36A5;">var</span>

<span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">&#29992;&#19981;&#22238;&#26174;&#30340;&#26041;&#24335;&#35835;&#21462;&#23494;&#30721;</span>
<span style="color: #006FE0;">read</span> -s var

<span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">&#26174;&#31034;&#25552;&#31034;&#20449;&#24687;</span>
<span style="color: #006FE0;">read</span> -p <span style="color: #008000;">"Enter input:"</span> var

<span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">&#22312;2&#31186;&#20869;&#35835;&#36755;&#20837;</span>
<span style="color: #006FE0;">read</span> -t <span style="color: #D0372D;">2</span> var

<span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">&#29992;:&#20316;&#20026;&#23450;&#30028;&#31526;</span>
<span style="color: #006FE0;">read</span> -d <span style="color: #008000;">":"</span> var

</pre>
</div>
</div>
</li>
<li><a id="orgfadd653"></a>字段分隔符和迭代器<br />
<div class="outline-text-5" id="text-3-13-1-9">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">!/bin/</span><span style="color: #0000FF;">bash</span>
<span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">IFS &#20998;&#38548;&#31526; internal field separator</span>
<span style="color: #BA36A5;">line</span>=<span style="color: #008000;">"root:x:0:0:root:/root:/bin/bash"</span>
<span style="color: #BA36A5;">IFS</span>=<span style="color: #008000;">":"</span>
<span style="color: #BA36A5;">count</span>=<span style="color: #D0372D;">0</span>
<span style="color: #0000FF;">for</span> it<span style="color: #0000FF;"> in</span> $<span style="color: #BA36A5;">line</span>
<span style="color: #0000FF;">do</span>
    <span style="color: #707183;">[</span> $<span style="color: #BA36A5;">count</span> -eq <span style="color: #D0372D;">0</span> <span style="color: #707183;">]</span> &amp;&amp; <span style="color: #BA36A5;">user</span>=$<span style="color: #BA36A5;">it</span>;
    <span style="color: #707183;">[</span> $<span style="color: #BA36A5;">count</span> -eq <span style="color: #D0372D;">6</span> <span style="color: #707183;">]</span> &amp;&amp; <span style="color: #BA36A5;">shell</span>=$<span style="color: #BA36A5;">it</span>;
    let count++
<span style="color: #0000FF;">done</span>
<span style="color: #006FE0;">echo</span> $<span style="color: #BA36A5;">user</span><span style="color: #008000;">\'</span>s shell is $<span style="color: #BA36A5;">shell</span>


<span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">&#36845;&#20195;&#22120;</span>
<span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">&#35821;&#27861;&#65306;for var in list       list &#21487;&#20197;&#26159;string&#25110;&#24207;&#21015;{*..*}</span>
<span style="color: #0000FF;">for</span> var<span style="color: #0000FF;"> in</span> <span style="color: #707183;">{</span><span style="color: #D0372D;">1..100</span><span style="color: #707183;">}</span>    <span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">&#19981;&#33021;&#26377;&#31354;&#26684;&#65292;&#21542;&#21017;&#20250;&#30452;&#25509;&#36755;&#20986;{ 1..100 }</span>
<span style="color: #0000FF;">do</span>
    <span style="color: #006FE0;">echo</span> $<span style="color: #BA36A5;">var</span>
<span style="color: #0000FF;">done</span>
</pre>
</div>
</div>
</li>
<li><a id="org23a0c9b"></a>比较和测试<br />
<div class="outline-text-5" id="text-3-13-1-10">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #707183;">[</span> condition <span style="color: #707183;">]</span> &amp;&amp; action
<span style="color: #707183;">[</span> condition <span style="color: #707183;">]</span> || action

-gt &gt;
-lt &lt;
-ge &gt;=
-le &lt;=
-eq ==
-ne !=

<span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">&#23383;&#31526;&#20018;&#27604;&#36739;</span>
<span style="color: #BA36A5;">str1</span>=<span style="color: #008000;">"a"</span>
<span style="color: #BA36A5;">str2</span>=<span style="color: #008000;">"b"</span>
<span style="color: #707183;">[</span><span style="color: #7388D6;">[</span> $<span style="color: #BA36A5;">str1</span> = $<span style="color: #BA36A5;">str2</span> <span style="color: #7388D6;">]</span><span style="color: #707183;">]</span>
<span style="color: #707183;">[</span><span style="color: #7388D6;">[</span> $<span style="color: #BA36A5;">str1</span> == $<span style="color: #BA36A5;">str2</span> <span style="color: #7388D6;">]</span><span style="color: #707183;">]</span>
<span style="color: #707183;">[</span><span style="color: #7388D6;">[</span> $<span style="color: #BA36A5;">str1</span> != $<span style="color: #BA36A5;">str2</span> <span style="color: #7388D6;">]</span><span style="color: #707183;">]</span>
<span style="color: #707183;">[</span><span style="color: #7388D6;">[</span> $<span style="color: #BA36A5;">str1</span> &gt; $<span style="color: #BA36A5;">str2</span> <span style="color: #7388D6;">]</span><span style="color: #707183;">]</span>
<span style="color: #707183;">[</span><span style="color: #7388D6;">[</span> $<span style="color: #BA36A5;">str1</span> &lt; $<span style="color: #BA36A5;">str2</span> <span style="color: #7388D6;">]</span><span style="color: #707183;">]</span>
<span style="color: #707183;">[</span><span style="color: #7388D6;">[</span> -z $<span style="color: #BA36A5;">str1</span><span style="color: #7388D6;">]</span><span style="color: #707183;">]</span>       <span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">zero &#26159;&#21542;&#20026;&#31354;</span>
<span style="color: #707183;">[</span><span style="color: #7388D6;">[</span> -n $<span style="color: #BA36A5;">str1</span><span style="color: #7388D6;">]</span><span style="color: #707183;">]</span>       <span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">not zero</span>

</pre>
</div>
<p>
文件系统相关测试：
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">[ -f $file ]</td>
<td class="org-left">正常文件</td>
</tr>

<tr>
<td class="org-left">[ -x $file ]</td>
<td class="org-left">可执行文件</td>
</tr>

<tr>
<td class="org-left">[ -d $file ]</td>
<td class="org-left">目录</td>
</tr>

<tr>
<td class="org-left">[ -e $file ]</td>
<td class="org-left">存在文件</td>
</tr>

<tr>
<td class="org-left">[ -c $file ]</td>
<td class="org-left">字符设备文件</td>
</tr>

<tr>
<td class="org-left">[ -b $file ]</td>
<td class="org-left">块设备文件</td>
</tr>

<tr>
<td class="org-left">[ -w $file ]</td>
<td class="org-left">可写文件</td>
</tr>

<tr>
<td class="org-left">[ -r $file ]</td>
<td class="org-left">可读文件</td>
</tr>

<tr>
<td class="org-left">[ -L $file ]</td>
<td class="org-left">符号链接文件</td>
</tr>
</tbody>
</table>
</div>
</li>
</ol>
</div>
<div id="outline-container-orgd4996ac" class="outline-4">
<h4 id="orgd4996ac"><span class="section-number-4">3.13.2</span> 第三章</h4>
<div class="outline-text-4" id="text-3-13-2">
</div>
<ol class="org-ol">
<li><a id="org1fc3d84"></a>dd<br />
<div class="outline-text-5" id="text-3-13-2-1">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">&#27979;&#20869;&#23384;&#36895;&#24230;</span>
~/l/l/linux-shell-&#33050;&#26412;&#25915;&#30053; &#10095;&#10095;&#10095; dd <span style="color: #BA36A5;">if</span>=/dev/zero <span style="color: #BA36A5;">of</span>=/dev/null <span style="color: #BA36A5;">bs</span>=<span style="color: #D0372D;">1m</span> <span style="color: #BA36A5;">count</span>=<span style="color: #D0372D;">100</span>
<span style="color: #D0372D;">100+0</span> records<span style="color: #0000FF;"> in</span>
<span style="color: #D0372D;">100+0</span> records out
<span style="color: #D0372D;">104857600</span> bytes transferred<span style="color: #0000FF;"> in</span> <span style="color: #D0372D;">0.005783</span> secs <span style="color: #707183;">(</span><span style="color: #D0372D;">18132535605</span> bytes/sec<span style="color: #707183;">)</span>

<span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">&#27979;&#30828;&#30424;&#36895;&#24230;</span>
~/l/l/linux-shell-&#33050;&#26412;&#25915;&#30053; &#10095;&#10095;&#10095; dd <span style="color: #BA36A5;">if</span>=/dev/zero <span style="color: #BA36A5;">of</span>=junk.data <span style="color: #BA36A5;">bs</span>=<span style="color: #D0372D;">1m</span> <span style="color: #BA36A5;">count</span>=<span style="color: #D0372D;">100</span>
<span style="color: #D0372D;">100+0</span> records<span style="color: #0000FF;"> in</span>
<span style="color: #D0372D;">100+0</span> records out
<span style="color: #D0372D;">104857600</span> bytes transferred<span style="color: #0000FF;"> in</span> <span style="color: #D0372D;">0.243733</span> secs <span style="color: #707183;">(</span><span style="color: #D0372D;">430214734</span> bytes/sec<span style="color: #707183;">)</span>
</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div id="outline-container-org63ad01e" class="outline-3">
<h3 id="org63ad01e"><span class="section-number-3">3.14</span> 设计模式 <a href="https://www.bilibili.com/video/BV1kW411P7KS?p=2">视频</a></h3>
<div class="outline-text-3" id="text-3-14">
</div>
<div id="outline-container-org96b686c" class="outline-4">
<h4 id="org96b686c"><span class="section-number-4">3.14.1</span> 8个设计原则</h4>
<div class="outline-text-4" id="text-3-14-1">
<ol class="org-ol">
<li><p>
依赖倒置原则
高层模块(较稳定)不应该依赖于底层模式(易变化),二者都应该依赖于抽象(稳定)
抽象不应该依赖于实现细节，实现细节应该依赖于抽象
错误设计：
</p>
<p>
<img src="reading/2020-12-03_20-38-55_screenshot.png" alt="2020-12-03_20-38-55_screenshot.png" />
正确设计:
</p>

<div id="org41ef4fe" class="figure">
<p><img src="reading/2020-12-03_20-38-29_screenshot.png" alt="2020-12-03_20-38-29_screenshot.png" />
</p>
</div></li>
<li>开放封闭原则(OCP)
对扩展开放，对更改封闭
类模块应该是可扩展的，但是不可改变</li>
<li>单一职责原则(SRP)
<ul class="org-ul">
<li>一个类应该只有一个引起他变化的原因</li>
<li>变化的方向隐含着类的责任</li>
</ul></li>
<li>替换原则(LSP)
<ul class="org-ul">
<li>一个类应该能够替换他们的子类(is a)</li>
<li>继承表达类型抽象</li>
</ul></li>
<li>接口隔离原则(ISP)
<ul class="org-ul">
<li>不应该强迫客户程序依赖他们不用的方法</li>
<li>接口应该小而完备</li>
</ul></li>
<li>优先使用对象组合而不是继承</li>
<li>封装变化点</li>
<li>针对接口编程，而不是针对实现编程</li>
</ol>
</div>
</div>
<div id="outline-container-org28a92a5" class="outline-4">
<h4 id="org28a92a5"><span class="section-number-4">3.14.2</span> 组件协作模式</h4>
<div class="outline-text-4" id="text-3-14-2">
</div>
<ol class="org-ol">
<li><a id="org9c312ec"></a>p3 模版方法<br />
<div class="outline-text-5" id="text-3-14-2-1">

<div id="org2919665" class="figure">
<p><img src="reading/2020-12-15_21-01-14_screenshot.png" alt="2020-12-15_21-01-14_screenshot.png" />
</p>
</div>
</div>
</li>

<li><a id="org92a575b"></a>p4 策略模式<br /></li>
<li><a id="orgc304707"></a>p5 观察者模式<br /></li>
</ol>
</div>
<div id="outline-container-orgec2e328" class="outline-4">
<h4 id="orgec2e328"><span class="section-number-4">3.14.3</span> 单一职责模式</h4>
<div class="outline-text-4" id="text-3-14-3">
</div>
<ol class="org-ol">
<li><a id="org0df4376"></a><span class="todo TODO">TODO</span> p6 装饰模式<br /></li>
<li><a id="org574367a"></a>p7 桥模式<br /></li>
<li><a id="org0fa41a0"></a>p8 工厂模式<br /></li>
</ol>
</div>
</div>
<div id="outline-container-orga3b9eb4" class="outline-3">
<h3 id="orga3b9eb4"><span class="section-number-3">3.15</span> <span class="todo TODO">TODO</span> redis设计与实现</h3>
<div class="outline-text-3" id="text-3-15">
</div>
<div id="outline-container-org6a766b5" class="outline-4">
<h4 id="org6a766b5"><span class="section-number-4">3.15.1</span> 第二章 简单动态字符串(SDS)</h4>
<div class="outline-text-4" id="text-3-15-1">
<p>
redis不直接使用c语言的传统字符串，而是建立了一种名为简单动态字符串
(SDS,simple dynamic string)的抽象类型。
除了用来存字符串之外，SDS还被用作缓冲区。
</p>
</div>
<ol class="org-ol">
<li><a id="org68eee65"></a>定义<br /></li>
</ol>
</div>
</div>

<div id="outline-container-orgad88828" class="outline-3">
<h3 id="orgad88828"><span class="section-number-3">3.16</span> 高性能mysql</h3>
</div>
<div id="outline-container-org286b355" class="outline-3">
<h3 id="org286b355"><span class="section-number-3">3.17</span> <span class="todo TODO">TODO</span> 掘金小册子</h3>
</div>
<div id="outline-container-orgfc54bc9" class="outline-3">
<h3 id="orgfc54bc9"><span class="section-number-3">3.18</span> <span class="todo TODO">TODO</span> 15445</h3>
</div>

<div id="outline-container-org2f9f4c9" class="outline-3">
<h3 id="org2f9f4c9"><span class="section-number-3">3.19</span> <span class="todo TODO">TODO</span> tcp/ip详解</h3>
</div>
<div id="outline-container-orgce2fc4b" class="outline-3">
<h3 id="orgce2fc4b"><span class="section-number-3">3.20</span> <span class="todo TODO">TODO</span> 图解http</h3>
</div>
<div id="outline-container-orga792d81" class="outline-3">
<h3 id="orga792d81"><span class="section-number-3">3.21</span> <span class="todo TODO">TODO</span> unp</h3>
</div>
<div id="outline-container-orge5931fc" class="outline-3">
<h3 id="orge5931fc"><span class="section-number-3">3.22</span> <span class="todo TODO">TODO</span> 自我修养</h3>
</div>
<div id="outline-container-orga104e99" class="outline-3">
<h3 id="orga104e99"><span class="section-number-3">3.23</span> b站chenshuo</h3>
<div class="outline-text-3" id="text-3-23">
</div>
<div id="outline-container-orgb99de14" class="outline-4">
<h4 id="orgb99de14"><span class="section-number-4">3.23.1</span> 2 TCP简单实验（测速度）</h4>
<div class="outline-text-4" id="text-3-23-1">
</div>
<ol class="org-ol">
<li><a id="org38eab4d"></a>dd | nc, nc -l &gt; /dev/null (580M/s)<br />
<div class="outline-text-5" id="text-3-23-1-1">
<p>
数据的流动过程：
/dev/zero(kernel)&#x2013;&gt;dd(user)&#x2013;&gt;pipe(k)&#x2013;&gt;nc(u)&#x2013;&gt;tcp(k)
&#x2013;&gt;nc(u)&#x2013;&gt;/dev/null(k)
</p>
</div>
</li>
<li><a id="orgbff6bd3"></a>nc &lt; file, nc -l &gt; /dev/null (1074M/s)<br />
<div class="outline-text-5" id="text-3-23-1-2">
<p>
数据流动过程：
memory(k)&#x2013;&gt;nc(u)&#x2013;&gt;tcp(k)
&#x2013;&gt;nc(u)&#x2013;&gt;/dev/null(k)
</p>
</div>
</li>
</ol>
</div>
<div id="outline-container-org90e14c5" class="outline-4">
<h4 id="org90e14c5"><span class="section-number-4">3.23.2</span> UDP vs TCP</h4>
<div class="outline-text-4" id="text-3-23-2">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">UDP</th>
<th scope="col" class="org-left">TCP</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">无链接</td>
<td class="org-left">有链接</td>
</tr>

<tr>
<td class="org-left">不可靠</td>
<td class="org-left">可靠</td>
</tr>

<tr>
<td class="org-left">数据报</td>
<td class="org-left">字节流</td>
</tr>

<tr>
<td class="org-left">所有客户可以共享一个fd</td>
<td class="org-left">一个客户需要一个fd</td>
</tr>

<tr>
<td class="org-left">线程安全(能同时多线程读一个fd</td>
<td class="org-left">非线程安全</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-org4efbb6a" class="outline-4">
<h4 id="org4efbb6a"><span class="section-number-4">3.23.3</span> 第三个例子 netcat</h4>
<div class="outline-text-4" id="text-3-23-3">
</div>
<ol class="org-ol">
<li><a id="org7304c05"></a>tcp程序的标准动作<br />
<div class="outline-text-5" id="text-3-23-3-1">
<ol class="org-ol">
<li>SO<sub>REUSEADDR</sub></li>
<li>ignore SIGPIPE</li>
<li>TCP<sub>NODELAY</sub></li>
</ol>
</div>
</li>
<li><a id="org2067d67"></a>why non-blocking IO is a must(为什么IO多路复用中必须用非阻塞)<br />
<div class="outline-text-5" id="text-3-23-3-2">
<ol class="org-ol">
<li>如果accept是阻塞的，那么当IO复用通知可以accept，而调用accept的时候，对方刚好关闭
了连接，那么accept将永远阻塞。</li>
<li>linux下，select，poll，epoll可能被假唤醒，比如来了个checksum不对的数据包（被丢弃）</li>
</ol>
</div>
</li>
<li><a id="org3cbf6ec"></a>What if sink is slow?<br />
<div class="outline-text-5" id="text-3-23-3-3">
<p>
如果带宽不匹配，那么待发送的数据会越积越多，最后爆内存。一个简单的办法是写buffer达到一定高水位
后关闭读，然后等写buffer到了一个低水位再打开
</p>
</div>
</li>
<li><a id="orgd35a7e3"></a>Level-trigger and edge trigger<br />
<div class="outline-text-5" id="text-3-23-3-4">
<p>
读数据电平更简单，不会饥饿
写数据边沿简单，不会busy-loop
</p>
</div>
</li>
</ol>
</div>
</div>
</div>


<div id="outline-container-org76ac5d5" class="outline-2">
<h2 id="org76ac5d5"><span class="section-number-2">4</span> tools</h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-orgfbbd626" class="outline-3">
<h3 id="orgfbbd626"><span class="section-number-3">4.1</span> cmake</h3>
<div class="outline-text-3" id="text-4-1">
</div>
<div id="outline-container-org84fbbb7" class="outline-4">
<h4 id="org84fbbb7"><span class="section-number-4">4.1.1</span> cmake入门实战 <a href="https://www.hahack.com/codes/cmake/">https://www.hahack.com/codes/cmake/</a></h4>
</div>
</div>
<div id="outline-container-org9cc7681" class="outline-3">
<h3 id="org9cc7681"><span class="section-number-3">4.2</span> makefile</h3>
<div class="outline-text-3" id="text-4-2">
</div>
<div id="outline-container-org9b1ea51" class="outline-4">
<h4 id="org9b1ea51"><span class="section-number-4">4.2.1</span> <a href="https://wiki.ubuntu.org.cn/%E8%B7%9F%E6%88%91%E4%B8%80%E8%B5%B7%E5%86%99Makefile:MakeFile%E4%BB%8B%E7%BB%8D">https://wiki.ubuntu.org.cn/%E8%B7%9F%E6%88%91%E4%B8%80%E8%B5%B7%E5%86%99Makefile:MakeFile%E4%BB%8B%E7%BB%8D</a></h4>
</div>
<div id="outline-container-orgc455607" class="outline-4">
<h4 id="orgc455607"><span class="section-number-4">4.2.2</span> 自动化变量</h4>
<div class="outline-text-4" id="text-4-2-2">
<p>
\(@
    表示规则中的目标文件集。在模式规则中，如果有多个目标，那么，"\)@"就是匹配于目标中模式定义的集合。
$%
仅当目标是函数库文件中，表示规则中的目标成员名。例如，如果一个目标是"foo.a(bar.o)"，那么，"\(%"就是 "bar.o"，"\)@"就是"foo.a"。如果目标不是函数库文件（Unix下是[.a]，Windows下是[.lib]），那么，其值为空。
\(< 
    依赖目标中的第一个目标名字。如果依赖目标是以模式（即"%"）定义的，那么"\)&lt;"将是符合模式的一系列的文件集。注意，其是一个一个取出来的。
$?
所有比目标新的依赖目标的集合。以空格分隔。
$^
所有的依赖目标的集合。以空格分隔。如果在依赖目标中有多个重复的，那个这个变量会去除重复的依赖目标，只保留一份。
\(+
    这个变量很像"\)^"，也是所有依赖目标的集合。只是它不去除重复的依赖目标。
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-org485c4c7" class="outline-2">
<h2 id="org485c4c7"><span class="section-number-2">5</span> mac软件安装</h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-orge4476e1" class="outline-3">
<h3 id="orge4476e1"><span class="section-number-3">5.1</span> mysql</h3>
<div class="outline-text-3" id="text-5-1">
<div class="org-src-container">
<pre class="src src-shell">We<span style="color: #008000;">'ve installed your MySQL database without a root password. To secure it run:</span>
<span style="color: #008000;">    mysql_secure_installation</span>

<span style="color: #008000;">MySQL is configured to only allow connections from localhost by default</span>

<span style="color: #008000;">To connect run:</span>
<span style="color: #008000;">    mysql -uroot</span>

<span style="color: #008000;">To have launchd start mysql now and restart at login:</span>
<span style="color: #008000;">  brew services start mysql</span>
<span style="color: #008000;">Or, if you don'</span>t want/need a background service you can just run:
mysql.server start
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgc05ce99" class="outline-2">
<h2 id="orgc05ce99"><span class="section-number-2">6</span> todolist</h2>
<div class="outline-text-2" id="text-6">
</div>
<div id="outline-container-orge9b84d2" class="outline-3">
<h3 id="orge9b84d2"><span class="section-number-3">6.1</span> shell</h3>
<div class="outline-text-3" id="text-6-1">
<ol class="org-ol">
<li>批量telnet脚本怎么写</li>
</ol>
</div>
</div>
<div id="outline-container-org69981f4" class="outline-3">
<h3 id="org69981f4"><span class="section-number-3">6.2</span> 操作系统</h3>
<div class="outline-text-3" id="text-6-2">
<p>
进程退出时内核要处理哪些东西(特别内存)
</p>
</div>
</div>
<div id="outline-container-org3218ea4" class="outline-3">
<h3 id="org3218ea4"><span class="section-number-3">6.3</span> 博客</h3>
<div class="outline-text-3" id="text-6-3">
<p>
互斥量 <a href="https://blog.csdn.net/u011244446/article/details/52574369">https://blog.csdn.net/u011244446/article/details/52574369</a>
</p>
</div>
</div>
<div id="outline-container-org91f0cc6" class="outline-3">
<h3 id="org91f0cc6"><span class="section-number-3">6.4</span> lc</h3>
<div class="outline-text-3" id="text-6-4">
<p>
<a href="https://leetcode-cn.com/problems/the-dining-philosophers/">https://leetcode-cn.com/problems/the-dining-philosophers/</a>
</p>
</div>
</div>
</div>
<div id="outline-container-orgf09609f" class="outline-2">
<h2 id="orgf09609f"><span class="section-number-2">7</span> <a href="https://leetcode-cn.com">leetcode</a></h2>
<div class="outline-text-2" id="text-7">
</div>
<div id="outline-container-org1463c4a" class="outline-3">
<h3 id="org1463c4a"><span class="section-number-3">7.1</span> 图</h3>
<div class="outline-text-3" id="text-7-1">
<p>
链接：<a href="https://leetcode-cn.com/problems/find-the-city-with-the-smallest-number-of-neighbors-at-a-threshold-distance/solution/zhong-gui-zhong-ju-biao-zhun-floyd-warshall-mo-ban/">https://leetcode-cn.com/problems/find-the-city-with-the-smallest-number-of-neighbors-at-a-threshold-distance/solution/zhong-gui-zhong-ju-biao-zhun-floyd-warshall-mo-ban/</a>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #0000FF;">for</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">k</span> = <span style="color: #D0372D;">0</span>; k &lt; n; k++<span style="color: #707183;">)</span> <span style="color: #707183;">{</span>
  <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">n&#20010;&#39030;&#28857;&#20381;&#27425;&#20316;&#20026;&#25554;&#20837;&#28857;</span>
  <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">&#27880;&#24847;&#25554;&#28857;k&#26159;&#25918;&#22312;&#31532;&#19968;&#23618;&#24490;&#29615;&#65292;&#22240;&#20026;&#36825;&#26159;&#29366;&#24577;&#21387;&#32553;&#30340;dp</span>
  <span style="color: #0000FF;">for</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">i</span> = <span style="color: #D0372D;">0</span>; i &lt; n; i++<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">{</span>
    <span style="color: #0000FF;">for</span> <span style="color: #909183;">(</span><span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">j</span> = <span style="color: #D0372D;">0</span>; j &lt; n; j++<span style="color: #909183;">)</span> <span style="color: #909183;">{</span>
      <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">&#36941;&#21382;&#21508;&#20010;&#39030;&#28857;&#20043;&#38388;&#30340;&#36317;&#31163;&#65292;&#24182;&#29992;&#25554;&#20837;&#28857;&#36827;&#34892;&#26356;&#26032;</span>
      D<span style="color: #709870;">[</span>i<span style="color: #709870;">][</span>j<span style="color: #709870;">]</span> = min<span style="color: #709870;">(</span>D<span style="color: #907373;">[</span>i<span style="color: #907373;">][</span>k<span style="color: #907373;">]</span>+D<span style="color: #907373;">[</span>k<span style="color: #907373;">][</span>j<span style="color: #907373;">]</span>, D<span style="color: #907373;">[</span>i<span style="color: #907373;">][</span>j<span style="color: #907373;">]</span><span style="color: #709870;">)</span>;
    <span style="color: #909183;">}</span>
  <span style="color: #7388D6;">}</span>
 <span style="color: #707183;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb15b76e" class="outline-3">
<h3 id="orgb15b76e"><span class="section-number-3">7.2</span> 并查集</h3>
<div class="outline-text-3" id="text-7-2">
</div>
<div id="outline-container-orgfa98530" class="outline-4">
<h4 id="orgfa98530"><span class="section-number-4">7.2.1</span> <span class="todo TODO">TODO</span> 1319</h4>
<div class="outline-text-4" id="text-7-2-1">
<p>
提交出错，bug没调，并查集模版总结
</p>
</div>
</div>
<div id="outline-container-org17a02d6" class="outline-4">
<h4 id="org17a02d6"><span class="section-number-4">7.2.2</span> 947</h4>
<div class="outline-text-4" id="text-7-2-2">
<p>
<a href="https://leetcode-cn.com/problems/most-stones-removed-with-same-row-or-column/">https://leetcode-cn.com/problems/most-stones-removed-with-same-row-or-column/</a>
</p>
</div>
</div>
</div>
<div id="outline-container-org454023b" class="outline-3">
<h3 id="org454023b"><span class="section-number-3">7.3</span> 单调栈</h3>
<div class="outline-text-3" id="text-7-3">
<p>
   <a href="https://leetcode-cn.com/problems/find-the-most-competitive-subsequence/">https://leetcode-cn.com/problems/find-the-most-competitive-subsequence/</a>
1234 <a href="https://leetcode-cn.com/problems/longest-well-performing-interval/">https://leetcode-cn.com/problems/longest-well-performing-interval/</a>
1081 <a href="https://leetcode-cn.com/problems/smallest-subsequence-of-distinct-characters/">https://leetcode-cn.com/problems/smallest-subsequence-of-distinct-characters/</a>
</p>
</div>
</div>
<div id="outline-container-org3618c84" class="outline-3">
<h3 id="org3618c84"><span class="section-number-3">7.4</span> 差分数组</h3>
<div class="outline-text-3" id="text-7-4">
<p>
简单来说，差分数组 diff[i]，存储的是 res[i] - res[i - 1]；而差分数组 diff[0&#x2026;i] 的和，就是 res[i] 的值。
大家可以用一个小数据试验一下，很好理解。
如果我们想给 [l, r] 的区间加上一个数字 a, 只需要 diff[l] += a，diff[r + 1] -= a。
这样做，diff[0&#x2026;i] 的和，就是更新后 res[i] 的值。
依然是，大家可以用一个小数据试验一下，其实很好理解。
这里不赘述，更严谨的分析看上面这个文档：<a href="https://oi-wiki.org/basic/prefix-sum/#_6">https://oi-wiki.org/basic/prefix-sum/#_6</a>
<a href="https://leetcode-cn.com/problems/minimum-moves-to-make-array-complementary/solution/jie-zhe-ge-wen-ti-xue-xi-yi-xia-chai-fen-shu-zu-on/">https://leetcode-cn.com/problems/minimum-moves-to-make-array-complementary/solution/jie-zhe-ge-wen-ti-xue-xi-yi-xia-chai-fen-shu-zu-on/</a> 
</p>
</div>
</div>
<div id="outline-container-org52222ab" class="outline-3">
<h3 id="org52222ab"><span class="section-number-3">7.5</span> 排列组合</h3>
<div class="outline-text-3" id="text-7-5">
<p>
1286 <a href="https://leetcode-cn.com/problems/iterator-for-combination/">https://leetcode-cn.com/problems/iterator-for-combination/</a>
</p>
</div>
</div>
<div id="outline-container-org1fa1c4d" class="outline-3">
<h3 id="org1fa1c4d"><span class="section-number-3">7.6</span> 字典树</h3>
<div class="outline-text-3" id="text-7-6">
<p>
TODO 1268 <a href="https://leetcode-cn.com/problems/search-suggestions-system/">https://leetcode-cn.com/problems/search-suggestions-system/</a>
</p>
</div>
</div>
<div id="outline-container-org8a42928" class="outline-3">
<h3 id="org8a42928"><span class="section-number-3">7.7</span> DFS</h3>
<div class="outline-text-3" id="text-7-7">
</div>
<div id="outline-container-org115d0ed" class="outline-4">
<h4 id="org115d0ed"><span class="section-number-4">7.7.1</span> 1254 <a href="https://leetcode-cn.com/problems/number-of-closed-islands/">https://leetcode-cn.com/problems/number-of-closed-islands/</a></h4>
<div class="outline-text-4" id="text-7-7-1">
<p>
grid可以复用为vis
</p>
</div>
</div>
</div>
<div id="outline-container-orgf60d2c5" class="outline-3">
<h3 id="orgf60d2c5"><span class="section-number-3">7.8</span> next</h3>
</div>
<div id="outline-container-orgd28291a" class="outline-3">
<h3 id="orgd28291a"><span class="section-number-3">7.9</span> 括号问题</h3>
<div class="outline-text-3" id="text-7-9">
</div>
<div id="outline-container-orge2513b4" class="outline-4">
<h4 id="orge2513b4"><span class="section-number-4">7.9.1</span> 1249 <a href="https://leetcode-cn.com/problems/minimum-remove-to-make-valid-parentheses/">https://leetcode-cn.com/problems/minimum-remove-to-make-valid-parentheses/</a></h4>
<div class="outline-text-4" id="text-7-9-1">
<p>
可以把要删除的括号置为特殊字符来代表删除h
</p>
</div>
</div>
</div>
<div id="outline-container-org61427a2" class="outline-3">
<h3 id="org61427a2"><span class="section-number-3">7.10</span> 前缀和</h3>
<div class="outline-text-3" id="text-7-10">
<p>
1248  <a href="https://leetcode-cn.com/problems/count-number-of-nice-subarrays/">https://leetcode-cn.com/problems/count-number-of-nice-subarrays/</a>
想到个思路：把所有奇数的坐标先用个数组记录下来
</p>
</div>
</div>
<div id="outline-container-org1488b32" class="outline-3">
<h3 id="org1488b32"><span class="section-number-3">7.11</span> 回溯</h3>
<div class="outline-text-3" id="text-7-11">
<p>
<a href="https://leetcode-cn.com/problems/maximum-length-of-a-concatenated-string-with-unique-characters/comments/">https://leetcode-cn.com/problems/maximum-length-of-a-concatenated-string-with-unique-characters/comments/</a>
1079 回溯+组合问题 <a href="https://leetcode-cn.com/problems/letter-tile-possibilities/">https://leetcode-cn.com/problems/letter-tile-possibilities/</a>
</p>
</div>
</div>
<div id="outline-container-orgb032180" class="outline-3">
<h3 id="orgb032180"><span class="section-number-3">7.12</span> 取或不取的2<sup>n遍历问题</sup></h3>
<div class="outline-text-3" id="text-7-12">
<p>
<a href="https://leetcode-cn.com/problems/maximum-length-of-a-concatenated-string-with-unique-characters/comments/">https://leetcode-cn.com/problems/maximum-length-of-a-concatenated-string-with-unique-characters/comments/</a>
</p>
</div>
</div>
<div id="outline-container-orge6ab03c" class="outline-3">
<h3 id="orge6ab03c"><span class="section-number-3">7.13</span> 验证水平</h3>
<div class="outline-text-3" id="text-7-13">
<p>
<a href="https://leetcode-cn.com/problems/path-with-maximum-gold/">https://leetcode-cn.com/problems/path-with-maximum-gold/</a>
</p>
</div>
</div>
<div id="outline-container-orge956570" class="outline-3">
<h3 id="orge956570"><span class="section-number-3">7.14</span> 曼哈顿距离</h3>
<div class="outline-text-3" id="text-7-14">
<p>
1131 <a href="https://leetcode-cn.com/problems/maximum-of-absolute-value-expression/">https://leetcode-cn.com/problems/maximum-of-absolute-value-expression/</a>
</p>
</div>
</div>
<div id="outline-container-org524f107" class="outline-3">
<h3 id="org524f107"><span class="section-number-3">7.15</span> 双指针</h3>
<div class="outline-text-3" id="text-7-15">
<p>
1004 <a href="https://leetcode-cn.com/problems/max-consecutive-ones-iii/">https://leetcode-cn.com/problems/max-consecutive-ones-iii/</a>
</p>
</div>
</div>
<div id="outline-container-org52f4940" class="outline-3">
<h3 id="org52f4940"><span class="section-number-3">7.16</span> 分治</h3>
<div class="outline-text-3" id="text-7-16">
<p>
TODO 932. 漂亮数组 <a href="https://leetcode-cn.com/problems/beautiful-array/">https://leetcode-cn.com/problems/beautiful-array/</a>
</p>
</div>
</div>
<div id="outline-container-org0b11f55" class="outline-3">
<h3 id="org0b11f55"><span class="section-number-3">7.17</span> 排序各种写法</h3>
<div class="outline-text-3" id="text-7-17">
<p>
<a href="https://leetcode-cn.com/problems/sort-an-array/">https://leetcode-cn.com/problems/sort-an-array/</a>
</p>
</div>
</div>
</div>
<div id="outline-container-org4843df6" class="outline-2">
<h2 id="org4843df6"><span class="section-number-2">8</span> offer</h2>
<div class="outline-text-2" id="text-8">
<p>
TODO  <a href="https://leetcode-cn.com/problems/zhong-jian-er-cha-shu-lcof/">https://leetcode-cn.com/problems/zhong-jian-er-cha-shu-lcof/</a>
TODO  <a href="https://leetcode-cn.com/problems/xuan-zhuan-shu-zu-de-zui-xiao-shu-zi-lcof/comments/">https://leetcode-cn.com/problems/xuan-zhuan-shu-zu-de-zui-xiao-shu-zi-lcof/comments/</a>
TODO  <a href="https://leetcode-cn.com/problems/ji-qi-ren-de-yun-dong-fan-wei-lcof/">https://leetcode-cn.com/problems/ji-qi-ren-de-yun-dong-fan-wei-lcof/</a>
TODO  <a href="https://leetcode-cn.com/problems/jian-sheng-zi-lcof/comments/">https://leetcode-cn.com/problems/jian-sheng-zi-lcof/comments/</a>
TODO  递归解法 <a href="https://leetcode-cn.com/problems/fan-zhuan-lian-biao-lcof/">https://leetcode-cn.com/problems/fan-zhuan-lian-biao-lcof/</a>
TODO  <a href="https://leetcode-cn.com/problems/shu-de-zi-jie-gou-lcof/">https://leetcode-cn.com/problems/shu-de-zi-jie-gou-lcof/</a>
TODO  <a href="https://leetcode-cn.com/problems/dui-cheng-de-er-cha-shu-lcof/comments/">https://leetcode-cn.com/problems/dui-cheng-de-er-cha-shu-lcof/comments/</a>
不会   <a href="https://leetcode-cn.com/problems/shun-shi-zhen-da-yin-ju-zhen-lcof/">https://leetcode-cn.com/problems/shun-shi-zhen-da-yin-ju-zhen-lcof/</a>
不会   <a href="https://leetcode-cn.com/problems/zhan-de-ya-ru-dan-chu-xu-lie-lcof/comments/">https://leetcode-cn.com/problems/zhan-de-ya-ru-dan-chu-xu-lie-lcof/comments/</a>
      <a href="https://leetcode-cn.com/problems/add-two-numbers/">https://leetcode-cn.com/problems/add-two-numbers/</a>
      <a href="https://leetcode-cn.com/problems/longest-palindromic-substring/solution/zui-chang-hui-wen-zi-chuan-by-leetcode-solution/">https://leetcode-cn.com/problems/longest-palindromic-substring/solution/zui-chang-hui-wen-zi-chuan-by-leetcode-solution/</a>
      <a href="https://leetcode-cn.com/problems/er-cha-sou-suo-shu-de-hou-xu-bian-li-xu-lie-lcof/solution/mian-shi-ti-33-er-cha-sou-suo-shu-de-hou-xu-bian-6/">https://leetcode-cn.com/problems/er-cha-sou-suo-shu-de-hou-xu-bian-li-xu-lie-lcof/solution/mian-shi-ti-33-er-cha-sou-suo-shu-de-hou-xu-bian-6/</a>
      <a href="https://leetcode-cn.com/problems/fu-za-lian-biao-de-fu-zhi-lcof/comments/">https://leetcode-cn.com/problems/fu-za-lian-biao-de-fu-zhi-lcof/comments/</a>
      <a href="https://leetcode-cn.com/problems/zi-fu-chuan-de-pai-lie-lcof/">https://leetcode-cn.com/problems/zi-fu-chuan-de-pai-lie-lcof/</a>
      <a href="https://leetcode-cn.com/problems/zi-fu-chuan-de-pai-lie-lcof/solution/mian-shi-ti-38-zi-fu-chuan-de-pai-lie-hui-su-fa-by/">https://leetcode-cn.com/problems/zi-fu-chuan-de-pai-lie-lcof/solution/mian-shi-ti-38-zi-fu-chuan-de-pai-lie-hui-su-fa-by/</a>
      <a href="https://leetcode-cn.com/problems/zui-xiao-de-kge-shu-lcof/solution/zui-xiao-de-kge-shu-by-leetcode-solution/">https://leetcode-cn.com/problems/zui-xiao-de-kge-shu-lcof/solution/zui-xiao-de-kge-shu-by-leetcode-solution/</a>
      <a href="https://leetcode-cn.com/problems/ba-shu-zu-pai-cheng-zui-xiao-de-shu-lcof/comments/">https://leetcode-cn.com/problems/ba-shu-zu-pai-cheng-zui-xiao-de-shu-lcof/comments/</a>
      <a href="https://leetcode-cn.com/problems/ba-shu-zi-fan-yi-cheng-zi-fu-chuan-lcof/comments/">https://leetcode-cn.com/problems/ba-shu-zi-fan-yi-cheng-zi-fu-chuan-lcof/comments/</a>
      <a href="https://leetcode-cn.com/problems/er-cha-sou-suo-shu-de-di-kda-jie-dian-lcof/submissions/">https://leetcode-cn.com/problems/er-cha-sou-suo-shu-de-di-kda-jie-dian-lcof/submissions/</a>
      <a href="https://leetcode-cn.com/problems/dui-lie-de-zui-da-zhi-lcof/submissions/">https://leetcode-cn.com/problems/dui-lie-de-zui-da-zhi-lcof/submissions/</a>
      <a href="https://leetcode-cn.com/problems/nge-tou-zi-de-dian-shu-lcof/solution/java-dong-tai-gui-hua-by-zhi-xiong/">https://leetcode-cn.com/problems/nge-tou-zi-de-dian-shu-lcof/solution/java-dong-tai-gui-hua-by-zhi-xiong/</a>
      <a href="https://leetcode-cn.com/problems/yuan-quan-zhong-zui-hou-sheng-xia-de-shu-zi-lcof/submissions/">https://leetcode-cn.com/problems/yuan-quan-zhong-zui-hou-sheng-xia-de-shu-zi-lcof/submissions/</a>
      <a href="https://leetcode-cn.com/problems/bu-yong-jia-jian-cheng-chu-zuo-jia-fa-lcof/comments/">https://leetcode-cn.com/problems/bu-yong-jia-jian-cheng-chu-zuo-jia-fa-lcof/comments/</a>
      <a href="https://leetcode-cn.com/problems/ba-zi-fu-chuan-zhuan-huan-cheng-zheng-shu-lcof/submissions/">https://leetcode-cn.com/problems/ba-zi-fu-chuan-zhuan-huan-cheng-zheng-shu-lcof/submissions/</a>
      <a href="https://leetcode-cn.com/problems/3sum/">https://leetcode-cn.com/problems/3sum/</a>
      <a href="https://leetcode-cn.com/problems/generate-parentheses/">https://leetcode-cn.com/problems/generate-parentheses/</a>
      <a href="https://leetcode-cn.com/problems/flatten-binary-tree-to-linked-list/">https://leetcode-cn.com/problems/flatten-binary-tree-to-linked-list/</a>
      <a href="https://leetcode-cn.com/problems/course-schedule-ii/comments/">https://leetcode-cn.com/problems/course-schedule-ii/comments/</a>
      map实现的桶排序 <a href="https://leetcode-cn.com/problems/contains-duplicate-iii/solution/cun-zai-zhong-fu-yuan-su-iii-by-leetcode/">https://leetcode-cn.com/problems/contains-duplicate-iii/solution/cun-zai-zhong-fu-yuan-su-iii-by-leetcode/</a>
      二维dp <a href="https://leetcode-cn.com/problems/maximal-square/">https://leetcode-cn.com/problems/maximal-square/</a>  TODO 怎么证明
      完全二叉树结点个数 <a href="https://leetcode-cn.com/problems/count-complete-tree-nodes/">https://leetcode-cn.com/problems/count-complete-tree-nodes/</a>
</p>

<p>
会做，总结一下：<a href="https://leetcode-cn.com/problems/rectangle-area/submissions/">https://leetcode-cn.com/problems/rectangle-area/submissions/</a>
判断两个矩形有没有重叠：
实现一个计算器 <a href="https://leetcode-cn.com/problems/basic-calculator-ii/comments/">https://leetcode-cn.com/problems/basic-calculator-ii/comments/</a>
</p>



<p>
链表排序 <a href="https://leetcode-cn.com/problems/sort-list/comments/">https://leetcode-cn.com/problems/sort-list/comments/</a>
<a href="https://leetcode-cn.com/problems/implement-trie-prefix-tree/">https://leetcode-cn.com/problems/implement-trie-prefix-tree/</a>
</p>
</div>
</div>
<div id="outline-container-org006fd93" class="outline-2">
<h2 id="org006fd93"><span class="section-number-2">9</span> 速查表</h2>
<div class="outline-text-2" id="text-9">
</div>
<div id="outline-container-orgf662670" class="outline-3">
<h3 id="orgf662670"><span class="section-number-3">9.1</span> languages</h3>
<div class="outline-text-3" id="text-9-1">
</div>
<div id="outline-container-org4b1e0e6" class="outline-4">
<h4 id="org4b1e0e6"><span class="section-number-4">9.1.1</span> bash</h4>
<div class="outline-text-4" id="text-9-1-1">
<p>
##############################################################################
</p>

<p>
##############################################################################
</p>


<p>
##############################################################################
</p>

<p>
##############################################################################
</p>

<p>
CTRL+A              # 移动到行首，同 &lt;Home&gt;
CTRL+B              # 向后移动，同 &lt;Left&gt;
CTRL+C              # 结束当前命令
CTRL+D              # 删除光标前的字符，同 &lt;Delete&gt; ，或者没有内容时，退出会话
CTRL+E              # 移动到行末，同 &lt;End&gt;
CTRL+F              # 向前移动，同 &lt;Right&gt;
CTRL+G              # 退出当前编辑（比如正在 CTRL+R 搜索历史时）
CTRL+H              # 删除光标左边的字符，同 &lt;Backspace&gt;
CTRL+K              # 删除光标位置到行末的内容
CTRL+L              # 清屏并重新显示
CTRL+N              # 移动到命令历史的下一行，同 &lt;Down&gt;
CTRL+O              # 类似回车，但是会显示下一行历史
CTRL+P              # 移动到命令历史的上一行，同 &lt;Up&gt;
CTRL+R              # 历史命令反向搜索，使用 CTRL+G 退出搜索
CTRL+S              # 历史命令正向搜索，使用 CTRL+G 退出搜索
CTRL+T              # 交换前后两个字符
CTRL+U              # 删除字符到行首
CTRL+V              # 输入字符字面量，先按 CTRL+V 再按任意键
CTRL+W              # 删除光标左边的一个单词
CTRL+X              # 列出可能的补全
CTRL+Y              # 粘贴前面 CTRL+u/k/w 删除过的内容
CTRL+Z              # 暂停前台进程返回 bash，需要时可用 fg 将其切换回前台
CTRL+_              # 撤销（undo），有的终端将 CTRL+_ 映射为 CTRL+/ 或 CTRL+7
</p>

<p>
ALT+b               # 向后（左边）移动一个单词
ALT+d               # 删除光标后（右边）一个单词
ALT+f               # 向前（右边）移动一个单词
ALT+t               # 交换字符
ALT+BACKSPACE       # 删除光标前面一个单词，类似 CTRL+W，但不影响剪贴板
</p>

<p>
CTRL+X CTRL+X       # 连续按两次 CTRL+X，光标在当前位置和行首来回跳转 
CTRL+X CTRL+E       # 用你指定的编辑器，编辑当前命令
</p>


<p>
##############################################################################
</p>

<p>
##############################################################################
</p>

<p>
exit                # 退出当前登陆
env                 # 显示环境变量
echo $SHELL         # 显示你在使用什么 SHELL
</p>

<p>
bash                # 使用 bash，用 exit 返回
which bash          # 搜索 $PATH，查找哪个程序对应命令 bash
whereis bash        # 搜索可执行，头文件和帮助信息的位置，使用系统内建数据库
whatis bash         # 查看某个命令的解释，一句话告诉你这是干什么的
</p>

<p>
clear               # 清初屏幕内容
reset               # 重置终端（当你不小心 cat 了一个二进制，终端状态乱掉时使用）
</p>


<p>
##############################################################################
</p>

<p>
##############################################################################
</p>

<p>
cd                  # 返回自己 $HOME 目录
cd {dirname}        # 进入目录
pwd                 # 显示当前所在目录
mkdir {dirname}     # 创建目录
mkdir -p {dirname}  # 递归创建目录
pushd {dirname}     # 目录压栈并进入新目录
popd                # 弹出并进入栈顶的目录
dirs -v             # 列出当前目录栈
cd -                # 回到之前的目录
cd -{N}             # 切换到目录栈中的第 N个目录，比如 cd -2 将切换到第二个
</p>


<p>
##############################################################################
</p>

<p>
##############################################################################
</p>

<p>
ls                  # 显示当前目录内容，后面可接目录名：ls {dir} 显示指定目录
ls -l               # 列表方式显示目录内容，包括文件日期，大小，权限等信息
ls -1               # 列表方式显示目录内容，只显示文件名称，减号后面是数字 1
ls -a               # 显示所有文件和目录，包括隐藏文件（.开头的文件/目录名）
ln -s {fn} {link}   # 给指定文件创建一个软链接
cp {src} {dest}     # 拷贝文件，cp -r dir1 dir2 可以递归拷贝（目录）
rm {fn}             # 删除文件，rm -r 递归删除目录，rm -f 强制删除
mv {src} {dest}     # 移动文件，如果 dest 是目录，则移动，是文件名则覆盖
touch {fn}          # 创建或者更新一下制定文件
cat {fn}            # 输出文件原始内容
any<sub>cmd</sub> &gt; {fn}      # 执行任意命令并将标准输出重定向到指定文件
more {fn}           # 逐屏显示某文件内容，空格翻页，q 退出
less {fn}           # 更高级点的 more，更多操作，q 退出
head {fn}           # 显示文件头部数行，可用 head -3 abc.txt 显示头三行
tail {fn}           # 显示文件尾部数行，可用 tail -3 abc.txt 显示尾部三行
tail -f {fn}        # 持续显示文件尾部数据，可用于监控日志
nano {fn}           # 使用 nano 编辑器编辑文件
vim {fn}            # 使用 vim 编辑文件
diff {f1} {f2}      # 比较两个文件的内容
wc {fn}             # 统计文件有多少行，多少个单词
chmod 644 {fn}      # 修改文件权限为 644，可以接 -R 对目录循环改权限
chgrp group {fn}    # 修改文件所属的用户组
chown user1 {fn}    # 修改文件所有人为 user1, chown user1:group1 fn 可以修改组
file {fn}           # 检测文件的类型和编码
basename {fn}       # 查看文件的名字（不包括路径）
dirname {fn}        # 查看文件的路径（不包括名字）
grep {pat} {fn}     # 在文件中查找出现过 pat 的内容
grep -r {pat} .     # 在当前目录下递归查找所有出现过 pat 的文件内容
stat {fn}           # 显示文件的详细信息
</p>


<p>
##############################################################################
</p>

<p>
##############################################################################
</p>

<p>
whoami              # 显示我的用户名
who                 # 显示已登陆用户信息，w / who / users 内容略有不同
w                   # 显示已登陆用户信息，w / who / users 内容略有不同
users               # 显示已登陆用户信息，w / who / users 内容略有不同
passwd              # 修改密码，passwd {user} 可以用于 root 修改别人密码
finger {user}       # 显示某用户信息，包括 id, 名字, 登陆状态等
adduser {user}      # 添加用户
deluser {user}      # 删除用户
w                   # 查看谁在线
su                  # 切换到 root 用户
su -                # 切换到 root 用户并登陆（执行登陆脚本）
su {user}           # 切换到某用户
su -{user}          # 切换到某用户并登陆（执行登陆脚本）
id {user}           # 查看用户的 uid，gid 以及所属其他用户组
id -u {user}        # 打印用户 uid
id -g {user}        # 打印用户 gid
write {user}        # 向某用户发送一句消息
last                # 显示最近用户登陆列表
last {user}         # 显示登陆记录
lastb               # 显示失败登陆记录
lastlog             # 显示所有用户的最近登陆记录
sudo {command}      # 以 root 权限执行某命令
</p>


<p>
##############################################################################
</p>

<p>
##############################################################################
</p>

<p>
ps                        # 查看当前会话进程
ps ax                     # 查看所有进程，类似 ps -e
ps aux                    # 查看所有进程详细信息，类似 ps -ef
ps auxww                  # 查看所有进程，并且显示进程的完整启动命令
ps -u {user}              # 查看某用户进程
ps axjf                   # 列出进程树
ps xjf -u {user}          # 列出某用户的进程树
ps -eo pid,user,command   # 按用户指定的格式查看进程
ps aux | grep httpd       # 查看名为 httpd 的所有进程
ps &#x2013;ppid {pid}           # 查看父进程为 pid 的所有进程
pstree                    # 树形列出所有进程，pstree 默认一般不带，需安装
pstree {user}             # 进程树列出某用户的进程
pstree -u                 # 树形列出所有进程以及所属用户
pgrep {procname}          # 搜索名字匹配的进程的 pid，比如 pgrep apache2
</p>

<p>
kill {pid}                # 结束进程
kill -9 {pid}             # 强制结束进程，9/SIGKILL 是强制不可捕获结束信号
kill -KILL {pid}          # 强制执行进程，kill -9 的另外一种写法
kill -l                   # 查看所有信号
kill -l TERM              # 查看 TERM 信号的编号
killall {procname}        # 按名称结束所有进程
pkill {procname}          # 按名称结束进程，除名称外还可以有其他参数
</p>

<p>
top                       # 查看最活跃的进程
top -u {user}             # 查看某用户最活跃的进程
</p>

<p>
any<sub>command</sub> &amp;             # 在后台运行某命令，也可用 CTRL+Z 将当前进程挂到后台
jobs                      # 查看所有后台进程（jobs）
bg                        # 查看后台进程，并切换过去
fg                        # 切换后台进程到前台
fg {job}                  # 切换特定后台进程到前台
</p>

<p>
trap cmd sig1 sig2        # 在脚本中设置信号处理命令
trap "" sig1 sig2         # 在脚本中屏蔽某信号
trap - sig1 sig2          # 恢复默认信号处理行为
</p>

<p>
nohup {command}           # 长期运行某程序，在你退出登陆都保持它运行
nohup {command} &amp;         # 在后台长期运行某程序
disown {PID|JID}          # 将进程从后台任务列表（jobs）移除
</p>

<p>
wait                      # 等待所有后台进程任务结束
</p>


<p>
##############################################################################
</p>

<p>
##############################################################################
</p>

<p>
ssh user@host             # 以用户 user 登陆到远程主机 host
ssh -p {port} user@host   # 指定端口登陆主机
ssh-copy-id user@host     # 拷贝你的 ssh key 到远程主机，避免重复输入密码
scp {fn} user@host:path   # 拷贝文件到远程主机
scp user@host:path dest   # 从远程主机拷贝文件回来
scp -P {port} &#x2026;         # 指定端口远程拷贝文件
</p>

<p>
uname -a                  # 查看内核版本等信息
man {help}                # 查看帮助
man -k {keyword}          # 查看哪些帮助文档里包含了该关键字
info {help}               # 查看 info pages，比 man 更强的帮助系统
uptime                    # 查看系统启动时间
date                      # 显示日期
cal                       # 显示日历
vmstat                    # 显示内存和 CPU 使用情况
vmstat 10                 # 每 10 秒打印一行内存和 CPU情况，CTRL+C 退出
free                      # 显示内存和交换区使用情况
df                        # 显示磁盘使用情况
du                        # 显示当前目录占用，du . &#x2013;max-depth=2 可以指定深度
uname                     # 显示系统版本号
hostname                  # 显示主机名称
showkey -a                # 查看终端发送的按键编码
</p>

<p>
ping {host}               # ping 远程主机并显示结果，CTRL+C 退出
ping -c N {host}          # ping 远程主机 N 次
traceroute {host}         # 侦测路由连通情况
mtr {host}                # 高级版本 traceroute
host {domain}             # DNS 查询，{domain} 前面可加 -a 查看详细信息
whois {domain}            # 取得域名 whois 信息
dig {domain}              # 取得域名 dns 信息
route -n                  # 查看路由表
netstat -a                # 列出所有端口
netstat -an               # 查看所有连接信息，不解析域名
netstat -anp              # 查看所有连接信息，包含进程信息（需要 sudo）
netstat -l                # 查看所有监听的端口
netstat -t                # 查看所有 TCP 链接
netstat -lntu             # 显示所有正在监听的 TCP 和 UDP 信息
netstat -lntup            # 显示所有正在监听的 socket 及进程信息
netstat -i                # 显示网卡信息
netstat -rn               # 显示当前系统路由表，同 route -n
ss -an                    # 比 netstat -an 更快速更详细
ss -s                     # 统计 TCP 的 established, wait 等
</p>

<p>
wget {url}                # 下载文件，可加 &#x2013;no-check-certificate 忽略 ssl 验证
wget -qO- {url}           # 下载文件并输出到标准输出（不保存）
curl -sL {url}            # 同 wget -qO- {url} 没有 wget 的时候使用
</p>

<p>
sz {file}                 # 发送文件到终端，zmodem 协议
rz                        # 接收终端发送过来的文件
</p>


<p>
##############################################################################
</p>

<p>
##############################################################################
</p>

<p>
varname=value             # 定义变量
varname=value command     # 定义子进程变量并执行子进程
echo $varname             # 查看变量内容
echo $$                   # 查看当前 shell 的进程号
echo $!                   # 查看最近调用的后台任务进程号
echo $?                   # 查看最近一条命令的返回码
export VARNAME=value      # 设置环境变量（将会影响到子进程）
</p>

<p>
array[0]=valA             # 定义数组
array[1]=valB
array[2]=valC
array=([0]=valA [1]=valB [2]=valC)   # 另一种方式
array=(valA valB valC)               # 另一种方式
</p>

<p>
${array[i]}               # 取得数组中的元素
${#array[@]}              # 取得数组的长度
${#array[i]}              # 取得数组中某个变量的长度
</p>

<p>
declare -a                # 查看所有数组
declare -f                # 查看所有函数
declare -F                # 查看所有函数，仅显示函数名
declare -i                # 查看所有整数
declare -r                # 查看所有只读变量
declare -x                # 查看所有被导出成环境变量的东西
declare -p varname        # 输出变量是怎么定义的（类型+值）
</p>

<p>
${varname:-word}          # 如果变量不为空则返回变量，否则返回 word
${varname:=word}          # 如果变量不为空则返回变量，否则赋值成 word 并返回
${varname:?message}       # 如果变量不为空则返回变量，否则打印错误信息并退出
${varname:+word}          # 如果变量不为空则返回 word，否则返回 null
${varname:offset:len}     # 取得字符串的子字符串
</p>

<p>
${variable#pattern}       # 如果变量头部匹配 pattern，则删除最小匹配部分返回剩下的
${variable##pattern}      # 如果变量头部匹配 pattern，则删除最大匹配部分返回剩下的
${variable%pattern}       # 如果变量尾部匹配 pattern，则删除最小匹配部分返回剩下的
${variable%%pattern}      # 如果变量尾部匹配 pattern，则删除最大匹配部分返回剩下的
${variable/pattern/str}   # 将变量中第一个匹配 pattern 的替换成 str，并返回
${variable//pattern/str}  # 将变量中所有匹配 pattern 的地方替换成 str 并返回
</p>

<p>
${#varname}               # 返回字符串长度
</p>

<p>
*(patternlist)            # 零次或者多次匹配
+(patternlist)            # 一次或者多次匹配
?(patternlist)            # 零次或者一次匹配
@(patternlist)            # 单词匹配
!(patternlist)            # 不匹配
</p>

<p>
array=($text)             # 按空格分隔 text 成数组，并赋值给变量
IFS="/" array=(\(text)     # 按斜杆分隔字符串 text 成数组，并赋值给变量
    text="\){array[*]}"        # 用空格链接数组并赋值给变量
text=\((IFS=/; echo "\){array[*]}")  # 用斜杠链接数组并赋值给变量
</p>

<p>
A=( foo bar "a  b c" 42 ) # 数组定义
B=("\({A[@]:1:2}")         # 数组切片：B=( bar "a  b c" )
    C=("\){A[@]:1}")           # 数组切片：C=( bar "a  b c" 42 )
echo "\({B[@]}"            # bar a  b c
    echo "\){B[1]}"            # a  b c
echo "\({C[@]}"            # bar a  b c 42
    echo "\){C[@]: -2:2}"      # a  b c 42  减号前的空格是必须的
</p>

<p>
\((UNIX command)           # 运行命令，并将标准输出内容捕获并返回
    varname=\)(id -u user)     # 将用户名为 user 的 uid 赋值给 varname 变量
</p>

<p>
num=\((expr 1 + 2)         # 兼容 posix sh 的计算，使用 expr 命令计算结果
    num=\)(expr $num + 1)      # 数字自增
expr 2 \* \( 2 + 3 \)     # 兼容 posix sh 的复杂计算，输出 10
</p>

<p>
num=$((1 + 2))            # 计算 1+2 赋值给 num，使用 bash 独有的 \(((..)) 计算
    num=\)((\(num + 1))         # 变量递增
    num=\)((num + 1))          # 变量递增，双括号内的 $ 可以省略
num=$((1 + (2 + 3) * 2))  # 复杂计算
</p>


<p>
##############################################################################
</p>

<p>
##############################################################################
</p>

<p>
!!                  # 上一条命令
!^                  # 上一条命令的第一个单词
!:n                 # 上一条命令的第n个单词
!:n-$               # 上一条命令的第n个单词到最后一个单词
!$                  # 上一条命令的最后一个单词
!-n:$               # 上n条命令的最后一个单词
!string             # 最近一条包含string的命令
!<sup>string1</sup><sup>string2</sup>   # 最近一条包含string1的命令, 快速替换string1为string2
!#                  # 本条命令之前所有的输入内容
!#:n                # 本条命令之前的第n个单词, 快速备份cp /etc/passwd !#:1.bak
</p>


<p>
##############################################################################
</p>

<p>
##############################################################################
</p>

<p>
function myfunc() {
</p>

<p>
{shell commands &#x2026;}
}
</p>

<p>
myfunc                    # 调用函数 myfunc 
myfunc arg1 arg2 arg3     # 带参数的函数调用
myfunc "\(@"               # 将所有参数传递给函数
    myfunc "\){array[@]}"      # 将一个数组当作多个参数传递给函数
shift                     # 参数左移
</p>

<p>
unset -f myfunc           # 删除函数
declare -f                # 列出函数定义
</p>


<p>
##############################################################################
</p>

<p>
##############################################################################
</p>

<p>
statement1 &amp;&amp; statement2  # and 操作符
statement1 || statement2  # or 操作符
</p>

<p>
exp1 -a exp2              # exp1 和 exp2 同时为真时返回真（POSIX XSI扩展）
exp1 -o exp2              # exp1 和 exp2 有一个为真就返回真（POSIX XSI扩展）
( expression )            # 如果 expression 为真时返回真，输入注意括号前反斜杆
! expression              # 如果 expression 为假那返回真
</p>

<p>
str1 = str2               # 判断字符串相等，如 [ "$x" = "$y" ] &amp;&amp; echo yes
str1 != str2              # 判断字符串不等，如 [ "$x" != "$y" ] &amp;&amp; echo yes
str1 &lt; str2               # 字符串小于，如 [ "$x" \&lt; "$y" ] &amp;&amp; echo yes
str2 &gt; str2               # 字符串大于，注意 &lt; 或 &gt; 是字面量，输入时要加反斜杆
-n str1                   # 判断字符串不为空（长度大于零）
-z str1                   # 判断字符串为空（长度等于零）
</p>

<p>
-a file                   # 判断文件存在，如 [ -a /tmp/abc ] &amp;&amp; echo "exists"
-d file                   # 判断文件存在，且该文件是一个目录
-e file                   # 判断文件存在，和 -a 等价
-f file                   # 判断文件存在，且该文件是一个普通文件（非目录等）
-r file                   # 判断文件存在，且可读
-s file                   # 判断文件存在，且尺寸大于0
-w file                   # 判断文件存在，且可写
-x file                   # 判断文件存在，且执行
-N file                   # 文件上次修改过后还没有读取过
-O file                   # 文件存在且属于当前用户
-G file                   # 文件存在且匹配你的用户组
file1 -nt file2           # 文件1 比 文件2 新
file1 -ot file2           # 文件1 比 文件2 旧
</p>

<p>
num1 -eq num2             # 数字判断：num1 <code>= num2
    num1 -ne num2             # 数字判断：num1 !</code> num2
num1 -lt num2             # 数字判断：num1 &lt; num2
num1 -le num2             # 数字判断：num1 &lt;= num2
num1 -gt num2             # 数字判断：num1 &gt; num2
num1 -ge num2             # 数字判断：num1 &gt;= num2
</p>


<p>
##############################################################################
</p>

<p>
##############################################################################
</p>

<p>
test {expression}         # 判断条件为真的话 test 程序返回0 否则非零
[ expression ]            # 判断条件为真的话返回0 否则非零
</p>

<p>
test "abc" = "def"        # 查看返回值 echo $? 显示 1，因为条件为假
test "abc" != "def"       # 查看返回值 echo $? 显示 0，因为条件为真
</p>

<p>
test -a /tmp; echo $?     # 调用 test 判断 /tmp 是否存在，并打印 test 的返回值
[ -a /tmp ]; echo $?      # 和上面完全等价，/tmp 肯定是存在的，所以输出是 0
</p>

<p>
test cond &amp;&amp; cmd1         # 判断条件为真时执行 cmd1
[ cond ] &amp;&amp; cmd1          # 和上面完全等价
[ cond ] &amp;&amp; cmd1 || cmd2  # 条件为真执行 cmd1 否则执行 cmd2
</p>

<p>
if test -e /etc/passwd; then
echo "alright it exists &#x2026; "
else
echo "it doesn't exist &#x2026; "
fi
</p>

<p>
if [ -e /etc/passwd ]; then   
echo "alright it exists &#x2026; "
else
echo "it doesn't exist &#x2026; "
fi
</p>

<p>
[ -e /etc/passwd ] &amp;&amp; echo "alright it exists" || echo "it doesn't exist"
</p>

<p>
if [ "$varname" = "foo" ]; then
echo "this is foo"
elif [ "$varname" = "bar" ]; then
echo "this is bar"
else
echo "neither"
fi
</p>

<p>
if [ $x -gt 10 ] &amp;&amp; [ $x -lt 20 ]; then
echo "yes, between 10 and 20"
fi
</p>

<p>
[ $x -gt 10 ] &amp;&amp; [ $x -lt 20 ] &amp;&amp; echo "yes, between 10 and 20"
</p>

<p>
if [ \( $x -gt 10 \) -a \( $x -lt 20 \) ]; then
echo "yes, between 10 and 20"
fi
</p>

<p>
[ \( $x -gt 10 \) -a \( $x -lt 20 \) ] &amp;&amp; echo "yes, between 10 and 20"
</p>


<p>
[ -x /bin/ls ] &amp;&amp; /bin/ls -l
</p>

<p>
<a href="https://www.ibm.com/developerworks/library/l-bash-test/index.html">https://www.ibm.com/developerworks/library/l-bash-test/index.html</a>
</p>


<p>
##############################################################################
</p>

<p>
##############################################################################
</p>

<p>
while condition; do
statements
done
</p>

<p>
i=1
while [ $i -le 10 ]; do
echo \(i; 
    i=\)(expr $i + 1)
done
</p>

<p>
for i in {1..10}; do
echo $i
done
</p>

<p>
for name [in list]; do
statements
done
</p>

<p>
for f in /home/*; do 
echo $f
done
</p>

<p>
for (( initialisation ; ending condition ; update )); do
statements
done
</p>

<p>
for ((i = 0; i &lt; 10; i++)); do echo $i; done
</p>

<p>
case expression in 
pattern1 )
statements ;;
pattern2 )
statements ;;
</p>
<ul class="org-ul">
<li>)
otherwise ;;</li>
</ul>
<p>
esac
</p>

<p>
until condition; do
statements
done
</p>

<p>
select name [in list]; do
statements that can use $name
done
</p>


<p>
##############################################################################
</p>

<p>
##############################################################################
</p>

<p>
command ls                         # 忽略 alias 直接执行程序或者内建命令 ls
builtin cd                         # 忽略 alias 直接运行内建的 cd 命令
enable                             # 列出所有 bash 内置命令，或禁止某命令
help {builtin<sub>command</sub>}             # 查看内置命令的帮助（仅限 bash 内置命令）
</p>

<p>
eval $script                       # 对 script 变量中的字符串求值（执行）
</p>


<p>
##############################################################################
</p>

<p>
##############################################################################
</p>

<p>
cmd1 | cmd2                        # 管道，cmd1 的标准输出接到 cmd2 的标准输入
&lt; file                             # 将文件内容重定向为命令的标准输入
&gt; file                             # 将命令的标准输出重定向到文件，会覆盖文件
&gt;&gt; file                            # 将命令的标准输出重定向到文件，追加不覆盖
&gt;| file                            # 强制输出到文件，即便设置过：set -o noclobber
n&gt;| file                           # 强制将文件描述符 n的输出重定向到文件
&lt;&gt; file                            # 同时使用该文件作为标准输入和标准输出
n&lt;&gt; file                           # 同时使用文件作为文件描述符 n 的输出和输入
n&gt; file                            # 重定向文件描述符 n 的输出到文件
n&lt; file                            # 重定向文件描述符 n 的输入为文件内容
n&gt;&amp;                                # 将标准输出 dup/合并 到文件描述符 n
n&lt;&amp;                                # 将标准输入 dump/合并 定向为描述符 n
n&gt;&amp;m                               # 文件描述符 n 被作为描述符 m 的副本，输出用
n&lt;&amp;m                               # 文件描述符 n 被作为描述符 m 的副本，输入用
&amp;&gt;file                             # 将标准输出和标准错误重定向到文件
&lt;&amp;-                                # 关闭标准输入
&gt;&amp;-                                # 关闭标准输出
n&gt;&amp;-                               # 关闭作为输出的文件描述符 n
n&lt;&amp;-                               # 关闭作为输入的文件描述符 n
diff &lt;(cmd1) &lt;(cmd2)               # 比较两个命令的输出
</p>


<p>
##############################################################################
</p>

<p>
##############################################################################
</p>

<p>
cut -c 1-16                        # 截取每行头16个字符
cut -c 1-16 file                   # 截取指定文件中每行头 16个字符
cut -c3-                           # 截取每行从第三个字符开始到行末的内容
cut -d':' -f5                      # 截取用冒号分隔的第五列内容
cut -d';' -f2,10                   # 截取用分号分隔的第二和第十列内容
cut -d' ' -f3-7                    # 截取空格分隔的三到七列
echo "hello" | cut -c1-3           # 显示 hel
echo "hello sir" | cut -d' ' -f2   # 显示 sir
ps | tr -s " " | cut -d " " -f 2,3,4  # cut 搭配 tr 压缩字符
</p>


<p>
##############################################################################
</p>

<p>
##############################################################################
</p>

<p>
awk '{print $5}' file              # 打印文件中以空格分隔的第五列
awk -F ',' '{print $5}' file       # 打印文件中以逗号分隔的第五列
awk '<i>str</i> {print $2}' file        # 打印文件中包含 str 的所有行的第二列
awk -F ',' '{print $NF}' file      # 打印逗号分隔的文件中的每行最后一列 
awk '{s+=$1} END {print s}' file   # 计算所有第一列的合
awk 'NR%3==1' file                 # 从第一行开始，每隔三行打印一行
</p>

<p>
sed 's/find/replace/' file         # 替换文件中首次出现的字符串并输出结果 
sed '10s/find/replace/' file       # 替换文件第 10 行内容
sed '10,20s/find/replace/' file    # 替换文件中 10-20 行内容
sed -r 's/regex/replace/g' file    # 替换文件中所有出现的字符串
sed -i 's/find/replace/g' file     # 替换文件中所有出现的字符并且覆盖文件
sed -i '/find/i\newline' file      # 在文件的匹配文本前插入行
sed -i '<i>find/a\newline' file      # 在文件的匹配文本后插入行
sed '/line/s/find/replace</i>' file   # 先搜索行特征再执行替换
sed -e 's/f/r/' -e 's/f/r' file    # 执行多次替换
sed 's#find#replace#' file         # 使用 # 替换 / 来避免 pattern 中有斜杆
sed -i -r 's/^\s+//g' file         # 删除文件每行头部空格
sed '<i>^$/d' file                   # 删除文件空行并打印
sed -i 's</i>\s\+$//' file            # 删除文件每行末尾多余空格
sed -n '2p' file                   # 打印文件第二行
sed -n '2,5p' file                 # 打印文件第二到第五行
</p>


<p>
##############################################################################
</p>

<p>
##############################################################################
</p>

<p>
sort file                          # 排序文件
sort -r file                       # 反向排序（降序）
sort -n file                       # 使用数字而不是字符串进行比较
sort -t: -k 3n /etc/passwd         # 按 passwd 文件的第三列进行排序
sort -u file                       # 去重排序
</p>


<p>
##############################################################################
</p>

<p>
##############################################################################
</p>

<p>
source /path/to/z.sh               # .bashrc 中初始化 z.sh
z                                  # 列出所有历史路径以及他们的权重
z foo                              # 跳到历史路径中匹配 foo 的权重最大的目录
z foo bar                          # 跳到历史路径中匹配 foo 和 bar 权重最大的目录
z -l foo                           # 列出所有历史路径中匹配 foo 的目录及权重
z -r foo                           # 按照最高访问次数优先进行匹配跳转
z -t foo                           # 按照最近访问优先进行匹配跳转
</p>


<p>
##############################################################################
</p>

<p>
##############################################################################
</p>

<p>
bind '"\eh":"\C-b"'                # 绑定 ALT+h 为光标左移，同 CTRL+b / &lt;Left&gt;
bind '"\el":"\C-f"'                # 绑定 ALT+l 为光标右移，同 CTRL+f / &lt;Right&gt;
bind '"\ej":"\C-n"'                # 绑定 ALT+j 为下条历史，同 CTRL+n / &lt;Down&gt;
bind '"\ek":"\C-p"'                # 绑定 ALT+k 为上条历史，同 CTRL+p / &lt;Up&gt;
bind '"\eH":"\eb"'                 # 绑定 ALT+H 为光标左移一个单词，同 ALT-b 
bind '"\eL":"\ef"'                 # 绑定 ALT+L 为光标右移一个单词，同 ALT-f 
bind '"\eJ":"\C-a"'                # 绑定 ALT+J 为移动到行首，同 CTRL+a / &lt;Home&gt;
bind '"\eK":"\C-e"'                # 绑定 ALT+K 为移动到行末，同 CTRL+e / &lt;End&gt;
bind '"\e;":"ls -l\n"'             # 绑定 ALT+; 为执行 ls -l 命令
</p>


<p>
##############################################################################
</p>

<p>
##############################################################################
</p>

<p>
ip a                               # 显示所有网络地址，同 ip address
ip a show eth1                     # 显示网卡 IP 地址
ip a add 172.16.1.23/24 dev eth1   # 添加网卡 IP 地址
ip a del 172.16.1.23/24 dev eth1   # 删除网卡 IP 地址
ip link show dev eth0              # 显示网卡设备属性
ip link set eth1 up                # 激活网卡
ip link set eth1 down              # 关闭网卡
ip link set eth1 address {mac}     # 修改 MAC 地址
ip neighbour                       # 查看 ARP 缓存
ip route                           # 查看路由表
ip route add 10.1.0.0/24 via 10.0.0.253 dev eth0    # 添加静态路由
ip route del 10.1.0.0/24           # 删除静态路由
</p>

<p>
ifconfig                           # 显示所有网卡和接口信息
ifconfig -a                        # 显示所有网卡（包括开机没启动的）信息
ifconfig eth0                      # 指定设备显示信息
ifconfig eth0 up                   # 激活网卡
ifconfig eth0 down                 # 关闭网卡
ifconfig eth0 192.168.120.56       # 给网卡配置 IP 地址
ifconfig eth0 10.0.0.8 netmask 255.255.255.0 up     # 配置 IP 并启动
ifconfig eth0 hw ether 00:aa:bb:cc:dd:ee            # 修改 MAC 地址
</p>

<p>
nmap 10.0.0.12                     # 扫描主机 1-1000 端口
nmap -p 1024-65535 10.0.0.12       # 扫描给定端口
nmap 10.0.0.0/24                   # 给定网段扫描局域网内所有主机
nmap -O -sV 10.0.0.12              # 探测主机服务和操作系统版本
</p>


<p>
##############################################################################
</p>

<p>
##############################################################################
</p>

<p>
man hier                           # 查看文件系统的结构和含义
man test                           # 查看 posix sh 的条件判断帮助
man ascii                          # 显示 ascii 表
getconf LONG<sub>BIT</sub>                   # 查看系统是 32 位还是 64 位
bind -P                            # 列出所有 bash 的快捷键
mount | column -t                  # 漂亮的列出当前加载的文件系统
curl ip.cn                         # 取得外网 ip 地址和服务商信息
disown -a &amp;&amp; exit                  # 关闭所有后台任务并退出
cat /etc/issue                     # 查看 Linux 发行版信息
lsof -i port:80                    # 哪个程序在使用 80 端口？
showkey -a                         # 取得按键的 ASCII 码
svn diff | view -                  # 使用 Vim 来显示带色彩的 diff 输出
mv filename.{old,new}              # 快速文件改名
time read                          # 使用 CTRL-D 停止，最简单的计时功能
cp file.txt{,.bak}                 # 快速备份文件
sudo touch /forcefsck              # 强制在下次重启时扫描磁盘
find ~ -mmin 60 -type f            # 查找 $HOME 目录中，60 分钟内修改过的文件
curl wttr.in/~beijing              # 查看北京的天气预报
echo ${SSH<sub>CLIENT</sub>%% *}             # 取得你是从什么 IP 链接到当前主机上的
echo $[RANDOM%X+1]                 # 取得 1 到 X 之间的随机数
bind -x '"\C-l":ls -l'             # 设置 CTRL+l 为执行 ls -l 命令
find / -type f -size +5M           # 查找大于 5M 的文件
chmod &#x2013;reference f1 f2            # 将 f2 的权限设置成 f1 一模一样的
curl -L cheat.sh                   # 速查表大全
</p>


<p>
##############################################################################
</p>

<p>
##############################################################################
</p>

<p>
history | awk '{a[$2]++}END{for(i in a){print a[i] " " i}}' | sort -rn | head
</p>

<p>
netstat -n | awk '<i>^tcp</i> {++tt[$NF]} END {for (a in tt) print a, tt[a]}'
</p>

<p>
sshfs name@server:/path/to/folder /path/to/mount/point
</p>

<p>
ps aux | sort -nk +4 | tail
</p>

<p>
while sleep 1;do tput sc;tput cup 0 \(((\)(tput cols)-29));date;tput rc;done&amp;
</p>

<p>
wget -qO - "<a href="http://www.tarball.com/tarball.gz">http://www.tarball.com/tarball.gz</a>" | tar zxvf -
</p>

<p>
python -c "import test.pystone;print(test.pystone.pystones())"
</p>

<p>
dd if=/dev/zero of=/dev/null bs=1M count=32768
</p>

<p>
mount /path/to/file.iso /mnt/cdrom -oloop
</p>

<p>
ssh -t hostA ssh hostB
</p>

<p>
wget -r -l1 &#x2013;no-parent -nH -nd -P/tmp -A".gif,.jpg" <a href="http://example.com/images">http://example.com/images</a>
</p>

<p>
mkdir -p work/{project1,project2}/{src,bin,bak}
</p>

<p>
find . -type f -newermt "2010-01-01" ! -newermt "2010-06-01"
</p>

<p>
lsof -P -i -n | cut -f 1 -d " "| uniq | tail -n +2
</p>

<p>
:w !sudo tee &gt; /dev/null %
</p>

<p>
source ~/github/profiles/my<sub>bash</sub><sub>init.sh</sub>
</p>

<p>
ssh -CqTnN -R 0.0.0.0:8443:192.168.1.2:443  user@202.115.8.1
</p>

<p>
ssh -CqTnN -L 0.0.0.0:8443:192.168.1.2:443  user@192.168.1.3
</p>

<p>
ssh -CqTnN -D localhost:1080  user@202.115.8.1
</p>

<p>
<a href="http://www.skywind.me/blog/archives/2021">http://www.skywind.me/blog/archives/2021</a>
</p>


<p>
##############################################################################
</p>

<p>
##############################################################################
</p>

<p>
function q-extract() {
if [ -f $1 ] ; then
case $1 in
*.tar.bz2)   tar -xvjf $1    ;;
*.tar.gz)    tar -xvzf $1    ;;
*.tar.xz)    tar -xvJf $1    ;;
*.bz2)       bunzip2 $1     ;;
*.rar)       rar x $1       ;;
*.gz)        gunzip $1      ;;
*.tar)       tar -xvf $1     ;;
*.tbz2)      tar -xvjf $1    ;;
*.tgz)       tar -xvzf $1    ;;
*.zip)       unzip $1       ;;
*.Z)         uncompress $1  ;;
*.7z)        7z x $1        ;;
*)           echo "don't know how to extract '$1'&#x2026;" ;;
esac
else
echo "'$1' is not a valid file!"
fi
}
</p>

<p>
function q-compress() {
if [ -n "$1" ] ; then
FILE=$1
case $FILE in
<b>.tar) shift &amp;&amp; tar -cf $FILE $</b> ;;
<b>.tar.bz2) shift &amp;&amp; tar -cjf $FILE $</b> ;;
<b>.tar.xz) shift &amp;&amp; tar -cJf $FILE $</b> ;;
<b>.tar.gz) shift &amp;&amp; tar -czf $FILE $</b> ;;
<b>.tgz) shift &amp;&amp; tar -czf $FILE $</b> ;;
<b>.zip) shift &amp;&amp; zip $FILE $</b> ;;
<b>.rar) shift &amp;&amp; rar $FILE $</b> ;;
esac
else
echo "usage: q-compress &lt;foo.tar.gz&gt; ./foo ./bar"
fi
}
</p>

<p>
function ccat() {
local style="monokai"
if [ $# -eq 0 ]; then
pygmentize -P style=$style -P tabsize=4 -f terminal256 -g
else
for NAME in $@; do
pygmentize -P style=$style -P tabsize=4 -f terminal256 -g "$NAME"
done
fi
}
</p>


<p>
##############################################################################
</p>

<p>
##############################################################################
</p>

<p>
export LESS<sub>TERMCAP</sub><sub>mb</sub>=\('\E[1m\E[32m'
    export LESS_TERMCAP_mh=\)'\E[2m'
export LESS<sub>TERMCAP</sub><sub>mr</sub>=\('\E[7m'
    export LESS_TERMCAP_md=\)'\E[1m\E[36m'
export LESS<sub>TERMCAP</sub><sub>ZW</sub>=""
export LESS<sub>TERMCAP</sub><sub>us</sub>=\('\E[4m\E[1m\E[37m'
    export LESS_TERMCAP_me=\)'\E(B\E[m'
export LESS<sub>TERMCAP</sub><sub>ue</sub>=\('\E[24m\E(B\E[m'
    export LESS_TERMCAP_ZO=""
    export LESS_TERMCAP_ZN=""
    export LESS_TERMCAP_se=\)'\E[27m\E(B\E[m'
export LESS<sub>TERMCAP</sub><sub>ZV</sub>=""
export LESS<sub>TERMCAP</sub><sub>so</sub>=$'\E[1m\E[33m\E[44m'
</p>

<p>
"\eh": backward-char
"\el": forward-char
"\ej": next-history
"\ek": previous-history
"\eH": backward-word
"\eL": forward-word
"\eJ": beginning-of-line
"\eK": end-of-line
</p>


<p>
##############################################################################
</p>

<p>
##############################################################################
</p>

<p>
<a href="https://github.com/Idnan/bash-guide">https://github.com/Idnan/bash-guide</a>
<a href="http://www.linuxstall.com/linux-command-line-tips-that-every-linux-user-should-know/">http://www.linuxstall.com/linux-command-line-tips-that-every-linux-user-should-know/</a>
<a href="https://ss64.com/bash/syntax-keyboard.html">https://ss64.com/bash/syntax-keyboard.html</a>
<a href="http://wiki.bash-hackers.org/commands/classictest">http://wiki.bash-hackers.org/commands/classictest</a>
<a href="https://www.ibm.com/developerworks/library/l-bash-test/index.html">https://www.ibm.com/developerworks/library/l-bash-test/index.html</a>
<a href="https://www.cyberciti.biz/faq/bash-loop-over-file/">https://www.cyberciti.biz/faq/bash-loop-over-file/</a>
<a href="https://linuxconfig.org/bash-scripting-tutorial">https://linuxconfig.org/bash-scripting-tutorial</a>
<a href="https://github.com/LeCoupa/awesome-cheatsheets/blob/master/languages/bash.sh">https://github.com/LeCoupa/awesome-cheatsheets/blob/master/languages/bash.sh</a>
<a href="https://devhints.io/bash">https://devhints.io/bash</a>
<a href="https://github.com/jlevy/the-art-of-command-line">https://github.com/jlevy/the-art-of-command-line</a>
<a href="https://yq.aliyun.com/articles/68541">https://yq.aliyun.com/articles/68541</a>
</p>
</div>
</div>
</div>

<div id="outline-container-org730f0a7" class="outline-3">
<h3 id="org730f0a7"><span class="section-number-3">9.2</span> tools</h3>
<div class="outline-text-3" id="text-9-2">
</div>
<div id="outline-container-org43df0cb" class="outline-4">
<h4 id="org43df0cb"><span class="section-number-4">9.2.1</span> git</h4>
<div class="outline-text-4" id="text-9-2-1">
<p>
##############################################################################
</p>

<p>
##############################################################################
</p>


<p>
##############################################################################
</p>

<p>
##############################################################################
git config &#x2013;global "Your Name"
git config &#x2013;global "Email Address"
git config &#x2013;global credential.helper store    保存密码(每次要输密码/重复输密码)
</p>


<p>
##############################################################################
</p>

<p>
##############################################################################
git init
</p>


<p>
##############################################################################
</p>

<p>
##############################################################################
git add &lt;file&gt;
git add -u 提交work directory中所有已track的文件至staging area
git commit -m "descriptions"
git commit &#x2013;amend 对最近一次的提交做内容修改
git commit &#x2013;amend &#x2013;author "user<sub>name</sub> &lt;user<sub>email</sub>&gt;" 修改最近提交用户名和邮箱
</p>


<p>
##############################################################################
</p>

<p>
##############################################################################
git status
git status -s 文件状态缩略信息, 常见 A:新增; M:文件变更; ?:未track; D:删除
git diff &lt;file&gt;
git diff HEAD &#x2013; &lt;file&gt;                 查看工作区和版本库里面最新版本的区别
git diff &#x2013;check &lt;file&gt;                 检查是否有空白错误(regex:' \{1,\}$')
git diff &#x2013;cached &lt;file&gt;                查看已add的内容(绿M)
git diff branch1 branch2 &#x2013;stat         查看两个分支差异
git diff branch1 branch2 &lt;file&#x2026;&gt;      查看分支文件具体差异
</p>

<p>
##############################################################################
</p>

<p>
##############################################################################
git log
git reflog
git log -n                  最近n条的提交历史
git log &lt;branch<sub>name</sub>&gt; -n    分支branch<sub>name最近n条的提交历史</sub>
git log &#x2013;stat              历次commit的文件变化
git log &#x2013;shortstat         对比&#x2013;stat只显示最后的总文件和行数变化统计(n file changed, n insertions(+), n deletion(-))
git log &#x2013;name-status       显示新增、修改、删除的文件清单
git log lhs<sub>hash..rhs</sub><sub>hash</sub>  对比两次commit的变化(增删的主语为lhs, 如git log HEAD~2..HEAD == git log HEAD -3)
git log -p                  历次commit的内容增删
git log -p -W               历次commit的内容增删, 同时显示变更内容的上下文
git log origin/EI-1024 -1 &#x2013;stat -p -W 查看远端分支EI-1024前一次修改的详细内容
git log origin/master..dev &#x2013;stat -p -W 查看本地dev分支比远端master分支变化(修改)的详细内容
</p>

<p>
git log &lt;branch<sub>name</sub>&gt; &#x2013;oneline   对提交历史单行排列
git log &lt;branch<sub>name</sub>&gt; &#x2013;graph     对提交历史图形化排列
git log &lt;branch<sub>name</sub>&gt; &#x2013;decorate  对提交历史关联相关引用, 如tag, 本地远程分支等
git log &lt;branch<sub>name</sub>&gt; &#x2013;oneline &#x2013;graph &#x2013;decorate 拼接一下, 树形化显示历史
git log &#x2013;graph &#x2013;pretty=format:'%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen%ai(%cr) %C(bold blue)&lt;%an&gt;%Creset' &#x2013;abbrev-commit 同上, 建议alais保存
</p>

<p>
git log &#x2013;pretty=format 常用的选项(摘自progit<sub>v2.1.9</sub>)
%H 提交对象（commit）的完整哈希字串
%h 提交对象的简短哈希字串
%T 树对象（tree）的完整哈希字串
%t 树对象的简短哈希字串
%P 父对象（parent）的完整哈希字串
%p 父对象的简短哈希字串
%an 作者（author）的名字
%ae 作者的电子邮件地址
%ad 作者修订日期（可以用 &#x2013;date= 选项定制格式）
%ar 作者修订日期，按多久以前的方式显示
%cn 提交者（committer）的名字
%ce 提交者的电子邮件地址
%cd 提交日期
%cr 提交日期，按多久以前的方式显示
%s 提交说明
</p>

<p>
git log &#x2013;since &#x2013;after     显示时间之后的提交
git log &#x2013;until &#x2013;before    显示时间之前的提交
git &#x2013;author                显示指定作者的提交
git &#x2013;committer             显示指定committer的提交(注:committer不一定是author)
git log -S [keyword]        仅显示添加或移除了某个关键字的提交(某些场景比单独git log -p | grep [keyword] 好用很多)
git log origin/b3.3/master &#x2013;author=yx-ren &#x2013;since="2019-10-01" &#x2013;before="2019-11-01" 查看某作者在某发布版本最近一个月的提交, 常见于线上背锅
git log origin/b3.0/master &#x2013;author=some<sub>leave</sub> &#x2013;since="1 month ago" 查看某刚离职同事过去一个月的提交, 常见于背锅
git log &#x2013;since=1.weeks     过去一周的提交(写周报的时候可以看看我这一周干了啥)
git log &#x2013;since=1.days      过去一天的提交(下班的时候可以看看我这一天干了啥)
git log &#x2013;since="1 weeks 2 days 3 hours 40 minutes 50 seconds ago" 过去1周2天3小时40分50秒之内的提交
</p>


<p>
##############################################################################
</p>

<p>
##############################################################################
git reset &#x2013;hard HEAD^      回退到上1版本
git reset &#x2013;hard HEAD~5     回退到上5个版本
git reset &#x2013;hard id         回退到指定版本
</p>


<p>
##############################################################################
</p>

<p>
##############################################################################
git checkout &#x2013; &lt;file&gt;      撤销修改：误修改工作区文件，未git add/commit
git restore &lt;file&gt;          撤销修改：误修改工作区文件，未git add/commit
git reset HEAD &lt;file&gt;       撤销git add：误将文件加入暂存区（git add），未git commit
git reset &#x2013;hard HEAD^      撤销git commit：误将文件提交（一旦提交，只能通过版本回退进行撤销）
</p>


<p>
##############################################################################
</p>

<p>
##############################################################################
git rm/add &lt;file&gt;
git commit -m "remove &lt;file&gt;"   删除版本库中的&lt;file&gt;：删除工作区文件后，继续删除版本库中相应的文件
git checkout &#x2013; &lt;file&gt;          根据版本库中的&lt;file&gt;恢复工作区&lt;file&gt;
</p>

<p>
##############################################################################
</p>

<p>
##############################################################################
git clean -i    #交互式清理, 不常用
git clean -n    #查看清理文件列表(不包括文件夹), 不执行实际清理动作
git clean -n -d #查看清理文件列表(包括文件夹), 不执行实际清理动作
git clean -f    #清理所有未track文件
git clean -df   #清理所有未track文件和文件夹, 常用, 但使用前确保新增加的文件或文件夹已add, 否则新创建的文件或者文件夹也会被强制删除
</p>

<p>
##############################################################################
</p>

<p>
##############################################################################
git remote add origin &lt;remote address&gt;    在本地工作区目录下按照 GitHub 提示进行关联
git remote rm origin                      解除错误关联
git push -u origin master                 第一次将本地仓库推送至远程仓库（每次在本地提交后进行操作）
git push origin master                    以后每次将本地仓库推送至远程仓库（每次在本地提交后进行操作）
&lt;remote address&gt;:
git@github.com:&lt;username&gt;/&lt;repository&gt;.git
<a href="https://github.com/">https://github.com/</a>&lt;username&gt;/&lt;repository&gt;.git
</p>


<p>
##############################################################################
</p>

<p>
##############################################################################
git clone &lt;remote address&gt;    git协议速度更快但通常公司内网不允许，https协议速度慢
</p>


<p>
##############################################################################
</p>

<p>
##############################################################################
git branch &lt;branch name&gt;            创建&lt;branch name&gt;分支
git checkout &lt;branch name&gt;          切换至&lt;branch name&gt;分支
git switch &lt;branch name&gt;            切换至&lt;branch name&gt;分支
git checkout -b &lt;branch name&gt;       创建并切换至&lt;branch name&gt;分支
git switch -c &lt;branch name&gt;         创建并切换至&lt;branch name&gt;分支
git branch                          查看已有分支（* 表示当前分支）
git merge &lt;branch name&gt;             合并&lt;branch name&gt;到当前分支（通常在master分支下操作）
git branch -d &lt;branch name&gt;         删除分支
git branch -m oldbranchname newname 删除分支
</p>


<p>
##############################################################################
</p>

<p>
##############################################################################
合并时报错“分支发生冲突”，首先vim相应文件，修改冲突位置，然后按照git add/commit重新提交，最后删除多余分支即可。
git log &#x2013;graph &#x2013;pretty=oneline &#x2013;abbrev-commit
git log &#x2013;graph
</p>


<p>
##############################################################################
</p>

<p>
##############################################################################
git merge &#x2013;no-ff -m "descriptions" &lt;branch name&gt;
</p>


<p>
##############################################################################
</p>

<p>
##############################################################################
master分支              发布稳定版本
dev分支                 发布开发版本
&lt;developer name&gt;分支    个人开发分支（个人开发完成将该分支并入dev，同时保留该分支，继续开发）
</p>


<p>
##############################################################################
</p>

<p>
##############################################################################
软件开发中，bug就像家常便饭一样。有了bug就需要修复，在Git中，由于分支是如此的强大，所以，每个bug都可以通过一个新的临时分支来修复，修复后，合并分支，然后将临时分支删除。
git stash                   保存当前工作现场（在dev未完成开发，但master有bug需要修复）
git stash pop               回到dev分支后恢复工作现场（list中的现场会同时被删除）
git stash list              查看当前存储的工作现场
git stash apply stash@{#}   回到指定工作现场（list中的现场不会被删除，需要用git stash drop）
git stash drop stash@{#}    删除指定工作现场
git cherry-pick &lt;id&gt;        在master修复好bug后，在dev复制一遍bug修复流程
</p>


<p>
##############################################################################
</p>

<p>
##############################################################################
软件开发中，总有无穷无尽的新的功能要不断添加进来。添加一个新功能时，你肯定不希望因为一些实验性质的代码，把主分支搞乱了，所以，每添加一个新功能，最好新建一个feature分支，在上面开发，完成后，合并，最后，删除该feature分支。
git branch -D &lt;branch name&gt;    强制删除分支（丢弃未合并分支）
</p>


<p>
##############################################################################
</p>

<p>
##############################################################################
User 1:
git remote [-v]                        查看远程库信息（-v 查看详细信息）
git remote update origin &#x2013;prune       更新分支列表(更新远程分支列表)
git remote update origin -p            更新分支列表(更新远程分支列表)
git push origin [master/dev/&#x2026;]       推送指定分支到远程
User 2:
git clone &lt;remote address&gt;             克隆到本地（只能克隆master）
git checkout -b dev origin/dev         本地新建分支并关联远程
git add/commit/push                    添加、提交、推送更新
User 1:
git add/commit/push                    推送时报错（与user 2推送的更新冲突）
git pull &lt;remote&gt; &lt;branch&gt;
git branch &#x2013;set-upstream-to=origin/&lt;branch&gt; &lt;branch&gt;    本地与远程关联
git pull                               拉取远程文件（并解决冲突）
git commit/push                        重新提交并推送
</p>


<p>
##############################################################################
</p>

<p>
##############################################################################
git tag                                                     查看标签
git show &lt;tag name&gt;                                         查看指定标签
git log &#x2013;pretty=oneline &#x2013;abbrev-commit &#x2013;decorate=full    在log中显示标签
git tag &lt;tag name&gt;                                          为上次commit位置打标签
git tag &lt;tag name&gt; &lt;commit id&gt;                              为指定commit位置打标签
git tag -a &lt;tag name&gt; -m "descriptions" &lt;commit id&gt;         为指定commit打标并添加描述
git tag -d &lt;tag name&gt;                                       删除本地标签
git push origin &lt;tag name&gt;                                  推送指定标签到远程
git push origin &#x2013;tags                                      推送所有本地标签到远程
git push origin :refs/tags/&lt;tag name&gt;                       删除远程标签（先删除本地标签）
</p>

<p>
##############################################################################
</p>

<p>
##############################################################################
</p>

<p>
git rebase master 常见于多人开发, 每个开发人员从master checkout出自己的分支, 开发一段时间后提交至master之前最好rebase一下, 防止冲突,
就算真有冲突在本地解决好过强制提交, 开发流程中尽量保证master的干净整洁
</p>

<p>
举个例子:
master分支上有三个提交C1, C2, C3
某一时刻usr1在C3的master分支上checkout出新的分支, 用于开发服务端支持ipv6新特性, 并提交了C4, C5
git checkout -b ipv6<sub>support</sub>
&#x2026;&#x2026;
git commit -m C4
&#x2026;&#x2026;
git commit -m C5
此时提交状态如下所示
(origin/master branch)
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<tbody>
<tr>
</tr>
</tbody>
</table>
<p>
C1 &lt;- C2 &lt;- C3
\
\
\
C4 &lt;- C5
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<tbody>
<tr>
</tr>
</tbody>
</table>
<p>
(ipv6<sub>support</sub> branch)
</p>

<p>
某同事usr2修改了master上的内存泄漏错误, 并提交了C6, C7, C8三个commit, 然后直接推送origin/master(假设这个期间无其他人推新内容到master)
此时提交状态如下所示
(origin/usr2/fix<sub>mem</sub><sub>leak</sub> branch)
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<tbody>
<tr>
</tr>
</tbody>
</table>
<p>
C1 &lt;- C2 &lt;- C3 &lt;- C6 &lt;- C7 &lt;- C8
\                 |
\         (origin/master branch)
\
C4 &lt;- C5
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<tbody>
<tr>
</tr>
</tbody>
</table>
<p>
(ipv6<sub>support</sub> branch)
</p>

<p>
如果此时usr1希望将ipv6的新特性提交至master, 那么在其直接push origin master时会提示master需要合并分支ipv6<sub>support</sub>
虽然C4, C5的改动内容完全独立于C6, C7, C8的改动
但git仍会抓取C5和C8的提交并产生一个新的C9 commit(因两者分支的base不同), 如下图所示
C1 &lt;- C2 &lt;- C3 &lt;- C6 &lt;- C7 &lt;- C8
\                 \
\                 \
\                 \
C4 &lt;- C5 &lt;-&#x2013;&#x2014; C9
</p>

<p>
如果是为了保证master提交记录的"干净完整"
或者是某分支不着急提交, 仍需要更多的测试与开发, 但又不想分支开发周期结束后"偏离"当初checkout的master分支太久远(容易造成更多的冲突)
可以考虑(定期)利用rebase来进行变基
即上面提到过的多人协同开发, 定期rebase master是个好习惯
git checkout ipv6<sub>support</sub>
git rebase master
结果提交状态如下所示
(origin/master origin/usr2/fix<sub>mem</sub><sub>leak</sub> branch)
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<tbody>
<tr>
</tr>
</tbody>
</table>
<p>
C1 &lt;- C2 &lt;- C3 &lt;- C6 &lt;- C7 &lt;- C8
\
\
\
C4' &lt;- C5'
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<tbody>
<tr>
</tr>
</tbody>
</table>
<p>
(ipv6<sub>support</sub> branch)
这种rebase在功能上类似将某分支所有的改动做成多个patch并依次打在指定的新base上
此时再提交master就不会产生抓取效果, 会将C4'和C5'直接提交至master, 即can be fast-forwarded, 同时也保证了master提交记录的整洁性
(注: 虽然C4'和C5'的内容和C4, C5完全一致, 但两者base不同, commit hash code也完全不同)
</p>

<p>
git rebase &#x2013;noto &lt;branch<sub>lhs</sub>&gt; &lt;branch<sub>rhs</sub>&gt; #重放, 用于变基在分支branch<sub>lhs中而不在branch</sub><sub>rhs中的commit</sub>
#某项目状态分支如下所示, 其中Cn的数字代表提交时间顺
</p>

<p>
(master branch)
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<tbody>
<tr>
</tr>
</tbody>
</table>
<p>
C1 &lt;- C2 &lt;- C5 &lt;- C6
\
\
\
C3 &lt;- C4 &lt;- C10
\         |
\ (server branch)
\
C8 &lt;- C9
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<tbody>
<tr>
</tr>
</tbody>
</table>
<p>
(client branch)
</p>

<p>
git rebase &#x2013;noto client server
</p>

<p>
(master branch)(client branch)
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>
<p>
C1 &lt;- C2 &lt;- C5 &lt;- C6 &lt;- C8' &lt;- C9'
\
\
\
C3 &lt;- C4 &lt;- C10
\         |
\ (server branch)
\
[#####disable######]
[  C8 &lt;- C9        ]
[         |        ]
[  (client branch) ]
</p>

<p>
#can be fast-forwarded
git checkout master
git merge client
</p>

<p>
(client branch)
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<tbody>
<tr>
</tr>
</tbody>
</table>
<p>
C1 &lt;- C2 &lt;- C5 &lt;- C6 &lt;- C3' &lt;- C8' &lt;- C9'
\                             |
\                     (master branch)
\
C3 &lt;- C4 &lt;- C10
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<tbody>
<tr>
</tr>
</tbody>
</table>
<p>
(server branch)
</p>

<p>
git rebase -i HEAD~n 压缩当前分支的n个commit并合并为1个commit, 常见第一行为pick, 剩下的n-1行为squash
</p>

<p>
git rebase &#x2013;abort # rebase过程中发生错误, 可以利用该命令终止整个rebase过程
git rebase &#x2013;continue # rebase过程中发生冲突, 在解决冲突后可以利用该命令进行后续过程
</p>

<p>
##############################################################################
</p>

<p>
##############################################################################
</p>

<p>
git &lt;branch&gt; log -n -p &gt; diff.patch # 生成某分支过去n个commit的文件diff信息至单个diff文件
git diff &lt;&#x2013;cached&gt; diff.patch # 针对当前缓存区的内容生成diff文件
</p>

<p>
git apply &#x2013;check diff.patch    #检查是否可以正常应用, 无回显证明无冲突
git apply &#x2013;stat diff.patch     #查看应用diff文件后的文件变化
git apply diff.patch            #打patch, 仅仅改变文件信息, 无commit信息, 仍然需要add, commit
</p>

<p>
git format-patch &lt;branch&gt; -n 　 #生成分支&lt;branch&gt;最近的n次commit的patch
git format-patch &lt;r1&gt;..&lt;r2&gt;     #生成两个commit间的修改的patch（包含两个commit. &lt;r1&gt;和&lt;r2&gt;都是具体的commit号)
git format-patch -1 &lt;r1&gt;        #生成单个commit的patch
git format-patch &lt;r1&gt;           #生成某commit以来的修改patch（不包含该commit）
git format-patch &#x2013;root &lt;r1&gt;　　#生成从根到r1提交的所有patch
</p>

<p>
git apply &#x2013;check 0001-update-bash.sh.patch #检查patch是否冲突可用
git apply &#x2013;stat 0001-update-bash.sh.patch  #检查patch文件变更情况, 无回显证明无冲突
git am 0001-update-bash.sh.patch            #将该patch打上到当前分支, 带commit信息
git am ./*.patch                            #将当前路径下的所有patch按照先后顺序打上
git am &#x2013;abort                              #终止整个打patch的过程, 类似rebase &#x2013;abort
git am &#x2013;resolved                           #解决冲突后, 可以执行该命令进行后续的patch, 类似rebase &#x2013;continue
</p>

<p>
##############################################################################
</p>

<p>
##############################################################################
</p>

<p>
##############################################################################
</p>

<p>
git bundle create awesome-cheatsheets.bundle HEAD master #打包重建master分支的所有数据
git clone awesome-cheatsheets.bundle # 重建工程
</p>

<p>
git bundle create awesome-cheatsheets.bundle HEAD~10
git bundle create awesome-cheatsheets.bundle HEAD~10..HEAD
git bundle create awesome-cheatsheets.bundle lhs<sub>commit</sub><sub>md5..rhs</sub><sub>commit</sub><sub>md5</sub>
git bundle create awesome-cheatsheets.bundle origin/master..master
git bundle create awesome-cheatsheets.bundle master ^origin/master
</p>


<p>
##############################################################################
</p>

<p>
##############################################################################
fork &#x2013;&gt; clone &#x2013;&gt; add/commit/push &#x2013;&gt; pull request
</p>


<p>
##############################################################################
</p>

<p>
##############################################################################
git config &#x2013;global color.ui true    显示颜色
</p>


<p>
##############################################################################
</p>

<p>
##############################################################################
<i>&lt;dir name&gt;</i>                    忽略文件夹
*.zip                           忽略.zip文件
/&lt;dir name&gt;/&lt;file name&gt;         忽略指定文件
</p>


<p>
##############################################################################
</p>

<p>
##############################################################################
git add -f &lt;file&gt;               强制添加
git check-ignore -v &lt;file&gt;      查看生效规则
</p>


<p>
##############################################################################
</p>

<p>
##############################################################################
git config [&#x2013;global] alias.&lt;alias&gt; '&lt;original command&gt;'    为所有工作区/当前工作区配置别名
.git/config             当前工作区的配置文件
~/.gitconfig            当前用户的配置文件
</p>


<p>
##############################################################################
</p>

<p>
##############################################################################
<a href="https://www.liaoxuefeng.com/wiki/896043488029600">https://www.liaoxuefeng.com/wiki/896043488029600</a>
<a href="https://git-scm.com/book/en/v2">https://git-scm.com/book/en/v2</a>
</p>

<p>
##############################################################################
</p>

<p>
##############################################################################
git submodule foreach git pull    子模块更新
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org8ec78f3" class="outline-2">
<h2 id="org8ec78f3"><span class="section-number-2">10</span> 备份</h2>
<div class="outline-text-2" id="text-10">
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">Type your code here, or load an example.</span>
<span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">#include &lt;memory&gt;</span>
<span style="color: #8D8D84; font-style: italic;">using namespace std;</span>
<span style="color: #8D8D84; font-style: italic;">class B {</span>
<span style="color: #8D8D84; font-style: italic;">    private:</span>
<span style="color: #8D8D84; font-style: italic;">    int pri_mem;</span>
<span style="color: #8D8D84; font-style: italic;">    protected:</span>
<span style="color: #8D8D84; font-style: italic;">    int prot_mem;</span>
<span style="color: #8D8D84; font-style: italic;">};</span>

<span style="color: #8D8D84; font-style: italic;">class S : private B {</span>
<span style="color: #8D8D84; font-style: italic;">    friend void c(S&amp;);</span>
<span style="color: #8D8D84; font-style: italic;">    friend void c(B&amp;);</span>
<span style="color: #8D8D84; font-style: italic;">    int j;</span>

<span style="color: #8D8D84; font-style: italic;">    int f1() const {return prot_mem;} //&#19981;&#25253;&#38169;</span>
<span style="color: #8D8D84; font-style: italic;">};</span>

<span style="color: #8D8D84; font-style: italic;">class G : public S {</span>
<span style="color: #8D8D84; font-style: italic;">    int g() {return prot_mem;}   //&#25253;&#38169;</span>
<span style="color: #8D8D84; font-style: italic;">    int g1() {return pri_mem;}  //&#25253;&#38169;&#65292;</span>
<span style="color: #8D8D84; font-style: italic;">};</span>

<span style="color: #8D8D84; font-style: italic;">void c(S &amp;s) {</span>
<span style="color: #8D8D84; font-style: italic;">    s.j = s.prot_mem = 0;</span>
<span style="color: #8D8D84; font-style: italic;">}</span>
<span style="color: #8D8D84;">*/</span>

<span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">int foo() {</span>
<span style="color: #8D8D84; font-style: italic;">    int bar;</span>
<span style="color: #8D8D84; font-style: italic;">    return bar;</span>
<span style="color: #8D8D84; font-style: italic;">}</span>
<span style="color: #8D8D84;">*/</span>

<span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">class B {</span>
<span style="color: #8D8D84; font-style: italic;">  public:</span>
<span style="color: #8D8D84; font-style: italic;">  virtual void fk() {</span>
<span style="color: #8D8D84; font-style: italic;">    i = 'B';</span>
<span style="color: #8D8D84; font-style: italic;">  }</span>
<span style="color: #8D8D84; font-style: italic;">  char i = 'A';</span>
<span style="color: #8D8D84; font-style: italic;">};</span>

<span style="color: #8D8D84; font-style: italic;">class A : public B {</span>
<span style="color: #8D8D84; font-style: italic;">  public:</span>
<span style="color: #8D8D84; font-style: italic;">  virtual void fk() {</span>
<span style="color: #8D8D84; font-style: italic;">    static_cast&lt;B&gt;(*this).fk();</span>
<span style="color: #8D8D84; font-style: italic;">  }</span>
<span style="color: #8D8D84; font-style: italic;">};</span>
<span style="color: #8D8D84;">*/</span>

<span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">p.39</span>
<span style="color: #036A07;">/**</span>
<span style="color: #036A07;">class Foo {</span>
<span style="color: #036A07;">public:</span>
<span style="color: #036A07;">int val;</span>
<span style="color: #036A07;">Foo *pnext;</span>
<span style="color: #036A07;">};</span>

<span style="color: #036A07;">void </span><span style="color: #D0372D;">foo_bar()</span><span style="color: #036A07;"> {</span>
<span style="color: #036A07;">    Foo *bar = new Foo;</span>
<span style="color: #036A07;">    if (bar-&gt;val || bar-&gt;pnext) {}</span>
<span style="color: #036A07;">}</span>
<span style="color: #036A07;">*/</span>

<span style="color: #8D8D84;">/*</span><span style="color: #8D8D84; font-style: italic;">p.41</span>
<span style="color: #8D8D84; font-style: italic;">class Foo {</span>
<span style="color: #8D8D84; font-style: italic;">    public:</span>
<span style="color: #8D8D84; font-style: italic;">};</span>
<span style="color: #8D8D84; font-style: italic;">class Bar {</span>
<span style="color: #8D8D84; font-style: italic;">    public:</span>
<span style="color: #8D8D84; font-style: italic;">    Foo foo;</span>
<span style="color: #8D8D84; font-style: italic;">    char *str;</span>
<span style="color: #8D8D84; font-style: italic;">};</span>

<span style="color: #8D8D84; font-style: italic;">void foo_bar() {</span>
<span style="color: #8D8D84; font-style: italic;">    Bar bar;</span>
<span style="color: #8D8D84; font-style: italic;">}</span>
<span style="color: #8D8D84;">*/</span>

<span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">class str {</span>
<span style="color: #8D8D84; font-style: italic;">    public:</span>
<span style="color: #8D8D84; font-style: italic;">    str(const str&amp;);</span>
<span style="color: #8D8D84; font-style: italic;">    private:</span>
<span style="color: #8D8D84; font-style: italic;">};</span>

<span style="color: #8D8D84; font-style: italic;">class Word {</span>
<span style="color: #8D8D84; font-style: italic;">    public:</span>
<span style="color: #8D8D84; font-style: italic;">    Word( const str&amp;);</span>
<span style="color: #8D8D84; font-style: italic;">    private:</span>
<span style="color: #8D8D84; font-style: italic;">    int cnt;</span>
<span style="color: #8D8D84; font-style: italic;">    str a;</span>
<span style="color: #8D8D84; font-style: italic;">};</span>

<span style="color: #8D8D84; font-style: italic;">void foo_bar(const Word &amp;wd) {</span>
<span style="color: #8D8D84; font-style: italic;">    Word w = wd;</span>
<span style="color: #8D8D84; font-style: italic;">}</span>
<span style="color: #8D8D84;">*/</span>

<span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">class X {};</span>
<span style="color: #8D8D84; font-style: italic;">class Y : public virtual X {};</span>
<span style="color: #8D8D84; font-style: italic;">class Z : public virtual X {};</span>
<span style="color: #8D8D84; font-style: italic;">class A : public Y, public Z {};</span>
<span style="color: #8D8D84; font-style: italic;">int main()</span>
<span style="color: #8D8D84; font-style: italic;">{</span>
<span style="color: #8D8D84; font-style: italic;">    int a = sizeof(X);</span>
<span style="color: #8D8D84; font-style: italic;">    a = sizeof(Y);</span>
<span style="color: #8D8D84; font-style: italic;">    a = sizeof(Z);</span>
<span style="color: #8D8D84; font-style: italic;">    a = sizeof(A);</span>
<span style="color: #8D8D84; font-style: italic;">}</span>
<span style="color: #8D8D84;">*/</span>
<span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">p. 110</span>
<span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">struct no_virts {</span>
<span style="color: #8D8D84; font-style: italic;">    int d1, d2;</span>
<span style="color: #8D8D84; font-style: italic;">};</span>
<span style="color: #8D8D84; font-style: italic;">class has_virts : public no_virts{</span>
<span style="color: #8D8D84; font-style: italic;">public:</span>
<span style="color: #8D8D84; font-style: italic;">    virtual void foo();</span>
<span style="color: #8D8D84; font-style: italic;">    int d3;</span>
<span style="color: #8D8D84; font-style: italic;">};</span>

<span style="color: #8D8D84; font-style: italic;">int main() {</span>
<span style="color: #8D8D84; font-style: italic;">    has_virts h;</span>
<span style="color: #8D8D84; font-style: italic;">    no_virts n;</span>
<span style="color: #8D8D84; font-style: italic;">    int res = ((void*)&amp;n == (void*)&amp;n.d1);</span>
<span style="color: #8D8D84; font-style: italic;">    res = ((void*)&amp;h == (void*)&amp;h.d1);</span>
<span style="color: #8D8D84; font-style: italic;">}</span>
<span style="color: #8D8D84;">*/</span>

<span style="color: #8D8D84;">/*</span>
<span style="color: #8D8D84; font-style: italic;">class A {</span>
<span style="color: #8D8D84; font-style: italic;">    public:</span>
<span style="color: #8D8D84; font-style: italic;">virtual ~A() = 0;</span>
<span style="color: #8D8D84; font-style: italic;">};</span>

<span style="color: #8D8D84; font-style: italic;">class B : public A {</span>

<span style="color: #8D8D84; font-style: italic;">};</span>

<span style="color: #8D8D84; font-style: italic;">void bar() {</span>
<span style="color: #8D8D84; font-style: italic;">    B b;</span>
<span style="color: #8D8D84; font-style: italic;">}</span>
<span style="color: #8D8D84;">*/</span>

<span style="color: #0000FF;">class</span> <span style="color: #6434A3;">A</span><span style="color: #707183;">{</span>
    <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">x</span> = <span style="color: #D0372D;">7</span>;
<span style="color: #707183;">}</span>;
<span style="color: #6434A3;">void</span> <span style="color: #006699;">foo</span><span style="color: #707183;">(</span><span style="color: #6434A3;">A</span> &amp;&amp;<span style="color: #BA36A5;">a</span><span style="color: #707183;">)</span> <span style="color: #707183;">{</span>
    <span style="color: #6434A3;">A</span> &amp;&amp;<span style="color: #BA36A5;">b</span> = A<span style="color: #7388D6;">()</span>; <span style="color: #8D8D84;">//</span><span style="color: #8D8D84; font-style: italic;">b&#26159;&#24038;&#20540;,&#24847;&#24605;&#26159;&#34429;&#28982;b&#24341;&#29992;&#30340;&#23545;&#35937;&#27809;&#26377;&#21517;&#23383;&#65292;</span>
                 <span style="color: #8D8D84;">//</span><span style="color: #8D8D84; font-style: italic;">&#26159;&#20010;&#21491;&#20540;&#65292;&#20294;&#26159;b&#26159;&#26377;&#21517;&#23383;&#30340;&#65292;&#25152;&#20197;&#20182;&#26159;&#20010;</span>
                 <span style="color: #8D8D84;">//</span><span style="color: #8D8D84; font-style: italic;">&#24038;&#20540;</span>
                 <span style="color: #8D8D84;">//</span><span style="color: #8D8D84; font-style: italic;">&#21516;&#26679;&#30340;&#36947;&#29702;&#65292;a&#20063;&#26159;&#20010;&#24038;&#20540;</span>
    <span style="color: #6434A3;">A</span> <span style="color: #BA36A5;">c</span>;
    b = c;
   <span style="color: #8D8D84;">//</span><span style="color: #8D8D84; font-style: italic;">foo(b);</span>
<span style="color: #707183;">}</span>
<span style="color: #6434A3;">int</span> <span style="color: #006699;">main</span><span style="color: #707183;">()</span> <span style="color: #707183;">{</span>
   foo<span style="color: #7388D6;">(</span>A<span style="color: #909183;">()</span><span style="color: #7388D6;">)</span>; 
<span style="color: #707183;">}</span>
</pre>
</div>



<p>
am
redis 2
unp 1 
pm
c++ 1
linux 2
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: BINBIN YANG</p>
<p class="date">Created: 2021-04-04 日 15:46</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
